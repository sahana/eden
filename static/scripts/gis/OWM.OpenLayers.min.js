OpenLayers.Layer.OWMComposite=OpenLayers.Class(OpenLayers.Layer.WMS,{initialize:function(a,c,d){this.l=a;void 0==d&&(d={isBaseLayer:!1,opacity:.6});d.attribution='Forecast layers from <a href="http://openweathermap.org/wiki/Models/GDPRS">Environment Canada</a>';OpenLayers.Layer.WMS.prototype.initialize.apply(this,[c,"http://tile.openweathermap.org/wms",{layers:"GLBETA_"+this.l,SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",transparent:"true",format:"image/png"},d])},getURL:function(a){var c=this.map.getZoom();
this.params.LAYERS="GLBETA_"+this.l;5<c&&(b=this.map.getExtent(),isREGETA(b)&&(this.params.LAYERS="REGETA_"+this.l,7<c&&(isLAMARCTICETA(b)?this.params.LAYERS="LAMARCTICETA_"+this.l:isLAMWESTETA(b)?this.params.LAYERS="LAMWESTETA_"+this.l:isLAMMARITIMEETA(b)?this.params.LAYERS="LAMMARITIMEETA_"+this.l:isLAMEASTETA(b)&&(this.params.LAYERS="LAMEASTETA_"+this.l))));a=this.adjustBounds(a);c=this.getImageSize();var d={},e=this.reverseAxisOrder();d.BBOX=this.encodeBBOX?a.toBBOX(null,e):a.toArray(e);d.WIDTH=
c.w;d.HEIGHT=c.h;return this.getFullRequestString(d)}});
OpenLayers.Layer.OWMRadar=OpenLayers.Class(OpenLayers.Layer.WMS,{initialize:function(a,c){void 0==c&&(c={isBaseLayer:!1,opacity:.4});c.attribution='Radar layer from <a href="http://openweathermap.org/wiki/Layer/radar">Environment Canada</a>';OpenLayers.Layer.WMS.prototype.initialize.apply(this,[a,"http://tile.openweathermap.org/wms",{layers:"RADAR.12KM",SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",transparent:"true",format:"image/png"},c])},getURL:function(a){var c=this.map.getZoom();this.params.LAYERS=
8<c?"RADAR.2KM":"RADAR.12KM";a=this.adjustBounds(a);c=this.getImageSize();var d={},e=this.reverseAxisOrder();d.BBOX=this.encodeBBOX?a.toBBOX(null,e):a.toArray(e);d.WIDTH=c.w;d.HEIGHT=c.h;return this.getFullRequestString(d)}});
OpenLayers.Layer.OWMwms=OpenLayers.Class(OpenLayers.Layer.WMS,{initialize:function(a,c,d){void 0==d&&(d={isBaseLayer:!1,opacity:.3});a||(a=GLBETA_PR);c||(c=a);OpenLayers.Layer.WMS.prototype.initialize.apply(this,[c,"http://tile.openweathermap.org/wms",{layers:a,SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",transparent:"true",format:"image/png"},d])}});
OpenLayers.Layer.OWMCanada=OpenLayers.Class(OpenLayers.Layer.WMS,{initialize:function(a,c,d){void 0==d&&(d={isBaseLayer:!1,opacity:.3});a||(a=GLBETA_PR);c||(c=a);OpenLayers.Layer.WMS.prototype.initialize.apply(this,[c,"",{layers:a,SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",transparent:"true",format:"image/png"},d])},getURL:function(a){a=this.adjustBounds(a);var c=this.getImageSize(),d={},e=this.reverseAxisOrder();d.BBOX=this.encodeBBOX?a.toBBOX(null,e):a.toArray(e);d.WIDTH=c.w;d.HEIGHT=c.h;a=
this.getFullRequestString(d);return a="http://openweathermap.org/t/t?url="+a.replace(/&/g,"%26")}});
OpenLayers.Format.OWMWeather=OpenLayers.Class(OpenLayers.Format,{read:function(a){if("200"!==a.cod)throw Error(["OWM failure response (",a.cod,"): ",a.message].join(""));if(!a||!a.list||!OpenLayers.Util.isArray(a.list))throw Error("Unexpected OWM response");a=a.list;for(var c,d=[],e=0,f=a.length;e<f;e++)c=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a[e].coord.lon,a[e].coord.lat),{title:a[e].name,station:a[e],temp:Math.round(10*a[e].main.temp)/10}),d.push(c);return d}});
OpenLayers.Layer.Vector.OWMWeather=OpenLayers.Class(OpenLayers.Layer.Vector,{projection:new OpenLayers.Projection("EPSG:4326"),strategies:[new OpenLayers.Strategy.BBOX({resFactor:1})],units:"metric",styleMap:new OpenLayers.StyleMap(new OpenLayers.Style({fontColor:"black",fontSize:"12px",fontFamily:"Arial, Courier New",graphicXOffset:-20,graphicYOffset:-5,labelAlign:"lt",labelXOffset:"-5",labelYOffset:"-35",labelOutlineColor:"white",labelOutlineWidth:3,externalGraphic:"${icon}",graphicWidth:50,label:"${temp}\u00b0"},
{context:{icon:function(a){return a.layer?a.layer.options.getIcon(a.attributes.station):""}}})),initialize:function(a,c){void 0==c&&(c={});this.units=void 0==c.units?"metric":c.units;void 0==c.iconsets&&(c.iconsets="main");c.attribution='Weather from <a href="http://openweathermap.org/" alt="World Map and worldwide Weather Forecast online">OpenWeatherMap</a>';void 0==c.getIcon&&(c.getIcon=this.getIcon);void 0==c.getPopupHtml&&(c.getPopupHtml=this.getPopupHtml,void 0==c.popupX&&(c.popupX=150),void 0==
c.popupY&&(c.popupY=175));var d=[];d.push(a,c);OpenLayers.Layer.Vector.prototype.initialize.apply(this,d);this.protocol=new OpenLayers.Protocol.Script({url:"http://api.openweathermap.org/data/2.5/box/city",params:{cluster:"yes",cnt:200,format:"json",units:this.units,layer:this},filterToParams:function(a,c){a.type===OpenLayers.Filter.Spatial.BBOX&&(c.bbox=a.value.toArray(),c.bbox.push(c.layer.map.getZoom()),a.projection&&c.bbox.push(a.projection.getCode()));return c},format:new OpenLayers.Format.OWMWeather})},
getPopupHtml:function(a){return GetWeatherPopupHtml(a)},getIcon:function(a){if(0<a.weather.length)return"http://openweathermap.org/img/w/"+a.weather[0].icon+".png";var c=new Date,d=SunCalc.getTimes(c,a.coord.lat,a.coord.lon);return"http://openweathermap.org/img/w/"+GetWeatherIconDay(a,c>d.sunrise&&c<d.sunset?"day":"night")},setUnits:function(a){this.units="f"==a?"imperial":"metric"}});
OpenLayers.Format.OWMStations=OpenLayers.Class(OpenLayers.Format,{read:function(a){if("200"!==a.cod)throw Error(["OWM failure response (",a.cod,"): ",a.message].join(""));if(!a||!a.list||!OpenLayers.Util.isArray(a.list))throw Error("Unexpected OWM response");a=a.list;for(var c,d=[],e=0,f=a.length;e<f;e++)a[e].main&&(c=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a[e].coord.lon,a[e].coord.lat),{title:a[e].name,station:a[e],stationType:a[e].type,temp:Math.round(10*a[e].main.temp)/10}),
d.push(c));return d}});
OpenLayers.Layer.Vector.OWMStations=OpenLayers.Class(OpenLayers.Layer.Vector,{projection:new OpenLayers.Projection("EPSG:4326"),strategies:[new OpenLayers.Strategy.BBOX({resFactor:1})],styleMap:new OpenLayers.StyleMap(new OpenLayers.Style({fontColor:"black",fontSize:"12px",fontFamily:"Courier New, monospace",labelAlign:"lt",labelXOffset:"-15",labelYOffset:"-17",labelOutlineColor:"white",labelOutlineWidth:3,externalGraphic:"${icon}",graphicWidth:25,label:"${temp}\u00b0"},{context:{icon:function(a){return a.layer?a.layer.options.getIcon(a.attributes.station):
""}}})),units:"metric",initialize:function(a,c){void 0==c&&(c={});this.units=void 0==c.units?"metric":c.units;c.attribution='Weather from <a href="http://openweathermap.org/" alt="World Map and worldwide Weather Forecast online">OpenWeatherMap</a>';var d=[];void 0==c.getIcon&&(c.getIcon=this.getIcon);void 0==c.getPopupHtml&&(c.getPopupHtml=this.getPopupHtml,void 0==c.popupX&&(c.popupX=150),void 0==c.popupY&&(c.popupY=200));d.push(a,c);OpenLayers.Layer.Vector.prototype.initialize.apply(this,d);this.StationPopupHtml=
GetStationPopupHtml;this.protocol=new OpenLayers.Protocol.Script({url:"http://api.openweathermap.org/data/2.5/box/station",params:{cluster_distance:120,cluster:"yes",format:"json",units:this.units,layer:this},filterToParams:function(a,c){a.type===OpenLayers.Filter.Spatial.BBOX&&(c.bbox=a.value.toArray(),c.bbox.push(c.layer.map.getZoom()),a.projection&&c.bbox.push(a.projection.getCode()));return c},format:new OpenLayers.Format.OWMStations})},getPopupHtml:function(a){return GetStationPopupHtml(a)},
getIcon:function(a){return{1:{externalGraphic:"http://openweathermap.org/img/s/iplane.png"},2:{externalGraphic:"http://openweathermap.org/img/s/istation.png"},5:{externalGraphic:"http://openweathermap.org/img/s/istation.png"}}[a.type].externalGraphic}});
function GetWeatherIconDay(a,c){var d=0;a.clouds&&a.clouds.all&&(d=a.clouds.all);var e="transparent";1>d&&0<=d&&(e="01");5>d&&1<=d&&(e="01");25>d&&5<=d&&(e="01");50>d&&25<=d&&(e="02");75>d&&50<=d&&(e="03");75<=d&&(e="04");a.rain&&a.rain["3h"]&&(e="09",30>d&&(e="10"));return e+(void 0==c||"day"==c?"d":"n")+".png"}
function isboundsinrect(a,c){var d=new OpenLayers.LonLat(a.left,a.bottom);d.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));a=new OpenLayers.LonLat(a.right,a.top);a.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));p1={x:d.lat,y:d.lon};p2={x:a.lat,y:a.lon};return inRectangle(p1,c[0],c[1],c[2],c[3])&&inRectangle(p2,c[0],c[1],c[2],c[3])}
function isLAMEASTETA(a){return isboundsinrect(a,[{x:37.99,y:-92.055},{x:38.718,y:-70.551},{x:51.323,y:-68.764},{x:50.421,y:-95.476}])?!0:!1}function isLAMWESTETA(a){return isboundsinrect(a,[{x:44.167,y:-130.909},{x:45.99,y:-108.855},{x:57.208,y:-108.123},{x:54.903,y:-136.01}])?!0:!1}function isLAMMARITIMEETA(a){return isboundsinrect(a,[{x:40.21,y:-66.554},{x:44.907,y:-50.824},{x:54.596,y:-54.152},{x:49.002,y:-73.506}])?!0:!1}
function isLAMARCTICETA(a){return isboundsinrect(a,[{x:58.252,y:-77.123},{x:59.478,y:-56.694},{x:70.236,y:-55.179},{x:68.439,y:-85.106}])?!0:!1}function isREGETA(a){return isboundsinrect(a,[{x:20,y:-163.696},{x:15,y:-71.801},{x:66,y:-17},{x:80,y:-179.9}])?!0:!1}function areaOfTriangle(a,c,d){return Math.abs(((a.x-d.x)*(c.y-d.y)-(c.x-d.x)*(a.y-d.y))/2)}
function inTriangle(a,c,d,e){var f=areaOfTriangle(c,d,e);a=areaOfTriangle(a,c,d)+areaOfTriangle(a,c,e)+areaOfTriangle(a,d,e);return.001>Math.abs(f-a)?!0:!1}function inRectangle(a,c,d,e,f){return inTriangle(a,c,d,f)||inTriangle(a,e,d,f)}var WeekDayText={days:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),days_small:"Sun Mon Tue Wed Thu Fri Sat".split(" ")};
function GetWeatherText2(a){var c="";a.snow&&a.snow["3h"]&&(c="Snow ( "+a.snow["3h"]+"\u043c\u043c )");a.rain&&a.rain["3h"]&&(c="Rain:("+a.rain["3h"]+"\u043c\u043c)");return c}function GetWeatherIcon2(a,c){var d=new Date;a=SunCalc.getTimes(d,a.lat,a.lng);d=d>a.sunrise&&d<a.sunset?"d":"n";a=c.clouds.all;var e="transparent";1>a&&0<=a&&(e="01");5>a&&1<=a&&(e="01");25>a&&5<=a&&(e="01");50>a&&25<=a&&(e="02");75>a&&50<=a&&(e="03");75<=a&&(e="04");c.rain&&c.rain["3h"]&&(e="09");return e+d+".png"}
function GetWeatherForecastBubleHtml(a,c,d){var e=new Date((new Date).getTime()-168E5),f=Math.round(10*a.main.temp)/10,q=Math.round(100*a.main.temp_min)/100,l=Math.round(100*a.main.temp_max)/100,n=new Date(1E3*a.dt),g=SunCalc.getTimes(n,a.coord.lat,a.coord.lon);g=a.dt>g.sunrise&&a.dt<g.sunset?"d":"n";var t=GetWeatherText2(a);q='<p class="weather_title"><a style="weather_title_link" href="http://openweathermap.org/city/'+a.id+'">'+a.name+'</a></p><div style="float:left" ><div class="weather_block"><div class="cur_weather_block" title="'+
t+'"><img class="weather_image" alt="'+t+'" src="http://openweathermap.org/img/w/'+GetWeatherIconDay(a,g)+'"/><div class="temp_block" ><div class="big_temp" title="Current Temperature '+r+'">'+f+'\u00b0</div><div class="small_temp_block" ><div class="small_temp">'+t+'</div></div></div></div><div class="small_val_grey" title="Min and max temperature">Min t: '+q+" / Max t: "+l+' \u00b0</div><div class="small_val_grey">Humidity: '+a.main.humidity+'%</div><div class="small_val_grey">Wind: '+a.wind.speed+
" m/s</div></div>";h_footer="</div>";h_body="";for(l=0;l<d&&!(e<new Date(1E3*c[l].dt));l++);for(g=l;g<d+l;g++)if(SunCalc.getTimes(n,a.coord.lat,a.coord.lon),f=Math.round(c[g].main.temp),n=new Date(1E3*c[g].dt),!(e>n)){hr=n.getHours();var r=hr+":00";10>hr&&(r="0"+r);h_o='<div style="font-size:small;float:left;text-align:center;"><div title="'+WeekDayText.days[n.getDay()]+'">'+WeekDayText.days_small[n.getDay()]+'</div><div title="'+n.toString()+'">'+r+'</div><img alt="'+GetWeatherText2(c[g])+'" src="http://openweathermap.org/img/w/'+
GetWeatherIcon2(a,c[g])+'"/><div class="small_val" title="Temperature">'+f+'\u00b0</div><div class="small_val" title="\u0412\u0435\u0442\u0435\u0440">'+c[g].wind.speed+' m/s</div><div class="small_val_grey" title="\u0414\u0430\u0432\u043b\u0435\u043d\u0438\u0435">'+c[g].main.pressure+"</div></div>";h_body+=h_o}return q+h_body+h_footer}
function GetWeatherPopupHtml(a){var c=Math.round(10*a.main.temp)/10,d=Math.round(10*a.main.temp_min)/10,e=Math.round(10*a.main.temp_max)/10;if(0<a.weather.length)var f="http://openweathermap.org/img/w/"+a.weather[0].icon+".png",q=a.weather[0].main,l=a.weather[0].description;else f=SunCalc.getTimes(new Date(1E3*a.dt),a.coord.lat,a.coord.lon),f=GetWeatherIconDay(a,a.dt>f.sunrise&&a.dt<f.sunset?"d":"n"),q=GetWeatherText2(a);return'<p class="weather_title"><a class="weather_title_link" href="http://openweathermap.org/city/'+
a.id+'" target="_top">'+a.name+'</a></p><div class="weather_block"><div class="cur_weather_block" title="'+l+'"><img class="weather_image" alt="'+l+'" src="'+f+'"/><div class="temp_block" ><div class="big_temp" title="Current Temperature">'+c+'\u00b0</div><div class="small_temp_block" ><div class="small_temp">'+q+'</div></div></div></div><div class="small_val_grey" title="Min and max temperature">Min t: '+d+" / Max t: "+e+' \u00b0</div><div class="small_val_grey">Humidity: '+a.main.humidity+'%</div><div class="small_val_grey">Wind: '+
a.wind.speed+' m/s</div><div class="small_val_grey">Clouds: '+a.clouds.all+" %</div></div>"}
function GetStationPopupHtml(a){var c=Math.round(10*a.main.temp)/10,d=new Date(1E3*a.dt);c='<p class="weather_title"><a href="http://openweathermap.org/station/'+a.id+'" target="_top">'+a.name+'</a></p><div class="weather_block"><div class="cur_weather_block" ><img class="station_image" alt="'+GetWeatherText2(a)+'" src="'+GetStationIcon(a)+'"/><div class="temp_block"><div class="big_temp" title="Current Temperature">'+c+"\u00b0</div></div></div>";a.main.humidity&&(c+='<div class="small_val_grey">Humidity: '+
a.main.humidity+"%</div>");a.wind&&(c+='<div class="small_val_grey">Wind: '+a.wind.speed+" m/s</div>");a.main.pressure&&(c+='<div class="small_val_grey">Pressure: '+a.main.pressure+" hpa</div>");a.rain&&a.rain["1h"]&&(c+='<div class="small_val_grey">Rain: '+a.rain["1h"]+" mm</div>");c+='<div class="small_val_grey" title="'+d.toString()+'" >Recived at '+d.toTimeString()+"</div></div>";return c+"</div>"}
function GetStationIcon(a){return 1==a.type?"http://openweathermap.org/img/s/iplane.png":"http://openweathermap.org/img/s/istation.png"}
(function(a){a="undefined"!==typeof exports?exports:a.SunCalc={};var c=Math,d=c.PI/180,e=c.sin,f=c.cos,q=357.5291*d,l=.98560028*d,n=1.9148*d,g=.02*d,t=3E-4*d,r=102.9372*d,x=23.45*d,y=280.16*d,z=360.9856235*d,A=[[-.83,"sunrise","sunset"],[-.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]];a.addTime=function(a,c,d){A.push([a,c,d])};a.getTimes=function(a,p,m){m=d*-m;p*=d;a=c.round(a.valueOf()/864E5-.5+2440588-
2451545-9E-4-m/(2*c.PI));var h=2451545.0009+(0+m)/(2*c.PI)+a,k=q+l*(h-2451545),u=n*e(k)+g*e(2*k)+t*e(3*k);u=k+r+u+c.PI;var D=c.asin(e(u)*e(x));h=h+.0053*e(k)+-.0069*e(2*u);var B={solarNoon:new Date(864E5*(h+.5-2440588))},E;var C=0;for(E=A.length;C<E;C+=1){var v=A[C];var w=v[0];var y=v[1];v=v[2];w=2451545.0009+(c.acos((e(w*d)-e(p)*e(D))/(f(p)*f(D)))+m)/(2*c.PI)+a+.0053*e(k)+-.0069*e(2*u);var z=h-(w-h);B[y]=new Date(864E5*(z+.5-2440588));B[v]=new Date(864E5*(w+.5-2440588))}return B};a.getPosition=function(a,
p,m){m=d*-m;p*=d;a=a.valueOf()/864E5-.5+2440588;var h=q+l*(a-2451545),k=n*e(h)+g*e(2*h)+t*e(3*h);k=h+r+k+c.PI;h=c.asin(e(k)*e(x));k=c.atan2(e(k)*f(x),f(k));m=y+z*(a-2451545)-m-k;return{azimuth:c.atan2(e(m),f(m)*e(p)-c.tan(h)*f(p)),altitude:c.asin(e(p)*e(h)+f(p)*f(h)*f(m))}}})(this);
