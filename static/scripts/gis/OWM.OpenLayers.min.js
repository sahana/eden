OpenLayers.Layer.OWMComposite=OpenLayers.Class(OpenLayers.Layer.WMS,{initialize:function(a,c,d){this.l=a;void 0==d&&(d={isBaseLayer:!1,opacity:.6});d.attribution='Forecast layers from <a href="http://openweathermap.org/wiki/Models/GDPRS">Environment Canada</a>';OpenLayers.Layer.WMS.prototype.initialize.apply(this,[c,"http://tile.openweathermap.org/wms",{layers:"GLBETA_"+this.l,SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",transparent:"true",format:"image/png"},d])},getURL:function(a){var c=this.map.getZoom();
this.params.LAYERS="GLBETA_"+this.l;5<c&&(b=this.map.getExtent(),isREGETA(b)&&(this.params.LAYERS="REGETA_"+this.l,7<c&&(isLAMARCTICETA(b)?this.params.LAYERS="LAMARCTICETA_"+this.l:isLAMWESTETA(b)?this.params.LAYERS="LAMWESTETA_"+this.l:isLAMMARITIMEETA(b)?this.params.LAYERS="LAMMARITIMEETA_"+this.l:isLAMEASTETA(b)&&(this.params.LAYERS="LAMEASTETA_"+this.l))));a=this.adjustBounds(a);var c=this.getImageSize(),d={},e=this.reverseAxisOrder();d.BBOX=this.encodeBBOX?a.toBBOX(null,e):a.toArray(e);d.WIDTH=
c.w;d.HEIGHT=c.h;return this.getFullRequestString(d)}});
OpenLayers.Layer.OWMRadar=OpenLayers.Class(OpenLayers.Layer.WMS,{initialize:function(a,c){void 0==c&&(c={isBaseLayer:!1,opacity:.4});c.attribution='Radar layer from <a href="http://openweathermap.org/wiki/Layer/radar">Environment Canada</a>';OpenLayers.Layer.WMS.prototype.initialize.apply(this,[a,"http://tile.openweathermap.org/wms",{layers:"RADAR.12KM",SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",transparent:"true",format:"image/png"},c])},getURL:function(a){var c=this.map.getZoom();this.params.LAYERS=
8<c?"RADAR.2KM":"RADAR.12KM";a=this.adjustBounds(a);var c=this.getImageSize(),d={},e=this.reverseAxisOrder();d.BBOX=this.encodeBBOX?a.toBBOX(null,e):a.toArray(e);d.WIDTH=c.w;d.HEIGHT=c.h;return this.getFullRequestString(d)}});
OpenLayers.Layer.OWMwms=OpenLayers.Class(OpenLayers.Layer.WMS,{initialize:function(a,c,d){void 0==d&&(d={isBaseLayer:!1,opacity:.3});a||(a=GLBETA_PR);c||(c=a);OpenLayers.Layer.WMS.prototype.initialize.apply(this,[c,"http://tile.openweathermap.org/wms",{layers:a,SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",transparent:"true",format:"image/png"},d])}});
OpenLayers.Layer.OWMCanada=OpenLayers.Class(OpenLayers.Layer.WMS,{initialize:function(a,c,d){void 0==d&&(d={isBaseLayer:!1,opacity:.3});a||(a=GLBETA_PR);c||(c=a);OpenLayers.Layer.WMS.prototype.initialize.apply(this,[c,"",{layers:a,SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",transparent:"true",format:"image/png"},d])},getURL:function(a){a=this.adjustBounds(a);var c=this.getImageSize(),d={},e=this.reverseAxisOrder();d.BBOX=this.encodeBBOX?a.toBBOX(null,e):a.toArray(e);d.WIDTH=c.w;d.HEIGHT=c.h;a=
this.getFullRequestString(d);return a="http://openweathermap.org/t/t?url="+a.replace(/&/g,"%26")}});
OpenLayers.Format.OWMWeather=OpenLayers.Class(OpenLayers.Format,{read:function(a){if("200"!==a.cod)throw Error(["OWM failure response (",a.cod,"): ",a.message].join(""));if(!a||!a.list||!OpenLayers.Util.isArray(a.list))throw Error("Unexpected OWM response");a=a.list;for(var c,d=[],e=0,f=a.length;e<f;e++)c=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a[e].coord.lon,a[e].coord.lat),{title:a[e].name,station:a[e],temp:Math.round(10*(a[e].main.temp-273.15))/10}),d.push(c);return d}});
OpenLayers.Layer.Vector.OWMWeather=OpenLayers.Class(OpenLayers.Layer.Vector,{projection:new OpenLayers.Projection("EPSG:4326"),strategies:[new OpenLayers.Strategy.BBOX({resFactor:1})],styleMap:new OpenLayers.StyleMap(new OpenLayers.Style({fontColor:"black",fontSize:"12px",fontFamily:"Arial, Courier New",graphicXOffset:-20,graphicYOffset:-5,labelAlign:"lt",labelXOffset:"-5",labelYOffset:"-35",labelOutlineColor:"white",labelOutlineWidth:3,externalGraphic:"${icon}",graphicWidth:50,label:"${temp}\u00b0C"},
{context:{icon:function(a){return a.layer?a.layer.options.getIcon(a.attributes.station):S3.Ap.concat("/static/img/gis/openlayers/blank.gif")}}})),initialize:function(a,c){void 0==c&&(c={});void 0==c.eventListeners&&(c.eventListeners={featureselected:this.onSelect,featureunselected:this.onUnselect});void 0==c.iconsets&&(c.iconsets="main");c.attribution='Weather from <a href="http://openweathermap.org/" alt="World Map and worldwide Weather Forecast online">OpenWeatherMap</a>';void 0==c.getIcon&&(c.getIcon=
this.getIcon);void 0==c.getPopupHtml&&(c.getPopupHtml=this.getPopupHtml,void 0==c.popupX&&(c.popupX=150),void 0==c.popupY&&(c.popupY=175));var d=[];d.push(a,c);OpenLayers.Layer.Vector.prototype.initialize.apply(this,d);this.protocol=new OpenLayers.Protocol.Script({url:"http://openweathermap.org/data/2.1/find/city",params:{cluster:"yes",cnt:200,format:"json",layer:this},filterToParams:function(a,c){a.type===OpenLayers.Filter.Spatial.BBOX&&(c.bbox=a.value.toArray(),c.bbox.push(c.layer.map.getZoom()),
a.projection&&c.bbox.push(a.projection.getCode()));return c},callbackKey:"callback",format:new OpenLayers.Format.OWMWeather})},onPopupClose:function(a){a=this.feature;a.pois?selectControl.unselect(a):this.destroy()},onSelect:function(a){feature=a.feature;a=this.options.getPopupHtml(feature.attributes.station);popup=new OpenLayers.Popup("FramedCloud",feature.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(this.options.popupX,this.options.popupY),a,"City",!1);feature.popup=popup;popup.feature=
feature;this.map.addPopup(popup,!0)},onUnselect:function(a){feature=a.feature;feature.popup&&(popup.feature=null,this.map.removePopup(feature.popup),feature.popup.destroy(),feature.popup=null)},getPopupHtml:function(a){return GetWeatherPopupHtml(a)},getIcon:function(a){if(0<a.weather.length)return"http://openweathermap.org/img/w/"+a.weather[0].icon+".png";var c=new Date,d=SunCalc.getTimes(c,a.coord.lat,a.coord.lon);return"http://openweathermap.org/img/w/"+GetWeatherIconDay(a,c>d.sunrise&&c<d.sunset?
"day":"night")}});
OpenLayers.Format.OWMStations=OpenLayers.Class(OpenLayers.Format,{read:function(a){if("200"!==a.cod)throw Error(["OWM failure response (",a.cod,"): ",a.message].join(""));if(!a||!a.list||!OpenLayers.Util.isArray(a.list))throw Error("Unexpected OWM response");a=a.list;for(var c,d=[],e=0,f=a.length;e<f;e++)a[e].main&&(c=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a[e].coord.lon,a[e].coord.lat),{title:a[e].name,station:a[e],stationType:a[e].type,temp:Math.round(10*(a[e].main.temp-273.15))/
10}),d.push(c));return d}});
OpenLayers.Layer.Vector.OWMStations=OpenLayers.Class(OpenLayers.Layer.Vector,{projection:new OpenLayers.Projection("EPSG:4326"),strategies:[new OpenLayers.Strategy.BBOX({resFactor:1})],styleMap:new OpenLayers.StyleMap(new OpenLayers.Style({fontColor:"black",fontSize:"12px",fontFamily:"Courier New, monospace",labelAlign:"lt",labelXOffset:"-15",labelYOffset:"-17",labelOutlineColor:"white",labelOutlineWidth:3,externalGraphic:"${icon}",graphicWidth:25,label:"${temp}\u00b0C"},{context:{icon:function(a){return a.layer?
a.layer.options.getIcon(a.attributes.station):S3.Ap.concat("/static/img/gis/openlayers/blank.gif")}}})),initialize:function(a,c){void 0==c&&(c={});void 0==c.eventListeners&&(c.eventListeners={featureselected:this.onSelect,featureunselected:this.onUnselect});c.attribution='Weather from <a href="http://openweathermap.org/" alt="World Map and worldwide Weather Forecast online">OpenWeatherMap</a>';var d=[];void 0==c.getIcon&&(c.getIcon=this.getIcon);void 0==c.getPopupHtml&&(c.getPopupHtml=this.getPopupHtml,
void 0==c.popupX&&(c.popupX=150),void 0==c.popupY&&(c.popupY=200));d.push(a,c);OpenLayers.Layer.Vector.prototype.initialize.apply(this,d);this.StationPopupHtml=GetStationPopupHtml;this.protocol=new OpenLayers.Protocol.Script({url:"http://openweathermap.org/data/2.1/find/station",params:{cluster_distance:120,cluster:"yes",format:"json",layer:this},filterToParams:function(a,c){a.type===OpenLayers.Filter.Spatial.BBOX&&(c.bbox=a.value.toArray(),c.bbox.push(c.layer.map.getZoom()),a.projection&&c.bbox.push(a.projection.getCode()));
return c},callbackKey:"callback",format:new OpenLayers.Format.OWMStations})},onPopupClose:function(a){a=this.feature;a.pois?selectControl.unselect(a):this.destroy()},onSelect:function(a){feature=a.feature;a=this.options.getPopupHtml(feature.attributes.station);popup=new OpenLayers.Popup("Popup",feature.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(this.options.popupX,this.options.popupY),a,"Station",!1);feature.popup=popup;popup.feature=feature;this.map.addPopup(popup,!0)},onUnselect:function(a){feature=
a.feature;feature.popup&&(popup.feature=null,this.map.removePopup(feature.popup),feature.popup.destroy(),feature.popup=null)},getPopupHtml:function(a){return GetStationPopupHtml(a)},getIcon:function(a){return{1:{externalGraphic:"http://openweathermap.org/img/s/iplane.png"},2:{externalGraphic:"http://openweathermap.org/img/s/istation.png"},5:{externalGraphic:"http://openweathermap.org/img/s/istation.png"}}[a.type].externalGraphic}});
function GetWeatherIconDay(a,c){var d=0;a.clouds&&a.clouds.all&&(d=a.clouds.all);var e="transparent";1>d&&0<=d&&(e="01");5>d&&1<=d&&(e="01");25>d&&5<=d&&(e="01");50>d&&25<=d&&(e="02");75>d&&50<=d&&(e="03");75<=d&&(e="04");a.rain&&a.rain["3h"]&&(e="09",30>d&&(e="10"));return e+(void 0==c||"day"==c?"d":"n")+".png"}
function isboundsinrect(a,c){var d=new OpenLayers.LonLat(a.left,a.bottom);d.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));var e=new OpenLayers.LonLat(a.right,a.top);e.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));p1={x:d.lat,y:d.lon};p2={x:e.lat,y:e.lon};return inRectangle(p1,c[0],c[1],c[2],c[3])&&inRectangle(p2,c[0],c[1],c[2],c[3])}
function isLAMEASTETA(a){return isboundsinrect(a,[{x:37.99,y:-92.055},{x:38.718,y:-70.551},{x:51.323,y:-68.764},{x:50.421,y:-95.476}])?!0:!1}function isLAMWESTETA(a){return isboundsinrect(a,[{x:44.167,y:-130.909},{x:45.99,y:-108.855},{x:57.208,y:-108.123},{x:54.903,y:-136.01}])?!0:!1}function isLAMMARITIMEETA(a){return isboundsinrect(a,[{x:40.21,y:-66.554},{x:44.907,y:-50.824},{x:54.596,y:-54.152},{x:49.002,y:-73.506}])?!0:!1}
function isLAMARCTICETA(a){return isboundsinrect(a,[{x:58.252,y:-77.123},{x:59.478,y:-56.694},{x:70.236,y:-55.179},{x:68.439,y:-85.106}])?!0:!1}function isREGETA(a){return isboundsinrect(a,[{x:20,y:-163.696},{x:15,y:-71.801},{x:66,y:-17},{x:80,y:-179.9}])?!0:!1}function areaOfTriangle(a,c,d){return Math.abs(((a.x-d.x)*(c.y-d.y)-(c.x-d.x)*(a.y-d.y))/2)}
function inTriangle(a,c,d,e){var f=areaOfTriangle(c,d,e);a=areaOfTriangle(a,c,d)+areaOfTriangle(a,c,e)+areaOfTriangle(a,d,e);return.001>Math.abs(f-a)?!0:!1}function inRectangle(a,c,d,e,f){return inTriangle(a,c,d,f)||inTriangle(a,e,d,f)}
var WeekDayText={months:"\u044f\u043d\u0432\u0430\u0440\u044f \u0444\u0435\u0432\u0440\u0430\u043b\u044f \u043c\u0430\u0440\u0442\u0430 \u0430\u043f\u0440\u0435\u043b\u044f \u043c\u0430\u044f \u0438\u044e\u043d\u044f \u0438\u044e\u043b\u044f \u0430\u0432\u0433\u0443\u0441\u0442\u0430 \u0441\u0435\u043d\u0442\u044f\u0431\u0440\u044f \u043e\u043a\u0442\u044f\u0431\u0440\u044f \u043d\u043e\u044f\u0431\u0440\u044f \u0434\u0435\u043a\u0430\u0431\u0440\u044f".split(" "),days:"\u0432\u043e\u0441\u043a\u0440\u0435\u0441\u0435\u043d\u044c\u0435 \u043f\u043e\u043d\u0435\u0434\u0435\u043b\u044c\u043d\u0438\u043a \u0432\u0442\u043e\u0440\u043d\u0438\u043a \u0441\u0440\u0435\u0434\u0430 \u0447\u0435\u0442\u0432\u0435\u0440\u0433 \u043f\u044f\u0442\u043d\u0438\u0446\u0430 \u0441\u0443\u0431\u0431\u043e\u0442\u0430".split(" "),
days_small:"Sun Mon Tue Wed Thu Fri Sat".split(" ")};function GetWeatherText2(a){var c="";a.snow&&a.snow["3h"]&&(c="Snow ( "+a.snow["3h"]+"\u043c\u043c )");a.rain&&a.rain["3h"]&&(c="Rain:("+a.rain["3h"]+"\u043c\u043c)");return c}
function GetWeatherIcon2(a,c){var d=new Date,e=SunCalc.getTimes(d,a.lat,a.lng),d=d>e.sunrise&&d<e.sunset?"d":"n",e=c.clouds.all,f="transparent";1>e&&0<=e&&(f="01");5>e&&1<=e&&(f="01");25>e&&5<=e&&(f="01");50>e&&25<=e&&(f="02");75>e&&50<=e&&(f="03");75<=e&&(f="04");c.rain&&c.rain["3h"]&&(f="09");return f+d+".png"}
function GetWeatherForecastBubleHtml(a,c,d){var e=new Date((new Date).getTime()-168E5),f=Math.round(10*(a.main.temp-273))/10,q=Math.round(100*(a.main.temp_min-273))/100,l=Math.round(100*(a.main.temp_max-273))/100,n=new Date(1E3*a.dt),g=SunCalc.getTimes(n,a.coord.lat,a.coord.lon),g=a.dt>g.sunrise&&a.dt<g.sunset?"d":"n",s=GetWeatherText2(a),q='<p class="weather_title"><a style="weather_title_link" href="http://openweathermap.org/city/'+a.id+'">'+a.name+'</a></p> <div style="float: left;" ><div class="weather_block"> <div class="cur_weather_block" title="'+
s+'">  <img class="weather_image" alt="'+s+'" src="http://openweathermap.org/img/w/'+GetWeatherIconDay(a,g)+'"/>  <div class="temp_block" >   <div class="big_temp" title="Current Temperature '+r+'">'+f+'\u00b0</div>   <div class="small_temp_block" >    <div class="small_temp">'+s+'</div>   </div>  </div> </div> <div class="small_val_grey" title="Min and max temperature">Min t: '+q+" / Max t: "+l+' \u00b0C</div> <div class="small_val_grey">Humidity: '+a.main.humidity+'%</div> <div class="small_val_grey">Wind: '+
a.wind.speed+" m/s</div></div>";h_footer="</div>";h_body="";for(l=0;l<d&&!(e<new Date(1E3*c[l].dt));l++);for(g=l;g<d+l;g++){var r=new Date;SunCalc.getTimes(n,a.coord.lat,a.coord.lon);f=Math.round(c[g].main.temp-273);Math.round(100*(c[g].main.temp_min-273));Math.round(100*(c[g].main.temp_max-273));n=new Date(1E3*c[g].dt);e>n||(hr=n.getHours(),r=hr+":00",10>hr&&(r="0"+r),h_o='<div style="font-size: small; float: left; text-align: center;" > <div title="'+WeekDayText.days[n.getDay()]+'">'+WeekDayText.days_small[n.getDay()]+
'</div> <div title="'+n.toString()+'">'+r+'</div> <img alt="'+GetWeatherText2(c[g])+'" src="http://openweathermap.org/img/w/'+GetWeatherIcon2(a,c[g])+'"/> <div class="small_val" title="Temperature">'+f+'\u00b0C</div> <div class="small_val" title="\u0412\u0435\u0442\u0435\u0440">'+c[g].wind.speed+' m/s</div> <div class="small_val_grey" title="\u0414\u0430\u0432\u043b\u0435\u043d\u0438\u0435">'+c[g].main.pressure+"</div></div>",h_body+=h_o)}return q+h_body+h_footer}
function GetWeatherPopupHtml(a){var c=Math.round(10*(a.main.temp-273.15))/10,d=Math.round(10*(a.main.temp_min-273.15))/10,e=Math.round(10*(a.main.temp_max-273.15))/10;if(0<a.weather.length)var f="http://openweathermap.org/img/w/"+a.weather[0].icon+".png",q=a.weather[0].main,l=a.weather[0].description;else f=SunCalc.getTimes(new Date(1E3*a.dt),a.coord.lat,a.coord.lon),f=GetWeatherIconDay(a,a.dt>f.sunrise&&a.dt<f.sunset?"d":"n"),q=GetWeatherText2(a);return'<p class="weather_title"><a class="weather_title_link"  href="http://openweathermap.org/city/'+
a.id+'">'+a.name+'</a></p> <div class="weather_block"> <div class="cur_weather_block" title="'+l+'">  <img class="weather_image" alt="'+l+'" src="'+f+'"/>  <div class="temp_block" >   <div class="big_temp" title="Current Temperature">'+c+'\u00b0</div>   <div class="small_temp_block" >    <div class="small_temp">'+q+'</div>   </div>  </div> </div> <div class="small_val_grey" title="Min and max temperature">Min t: '+d+" / Max t: "+e+' \u00b0C</div> <div class="small_val_grey">Humidity: '+a.main.humidity+
'%</div> <div class="small_val_grey">Wind: '+a.wind.speed+' m/s</div> <div class="small_val_grey">Clouds: '+a.clouds.all+" %</div></div>"}
function GetStationPopupHtml(a){var c=Math.round(10*(a.main.temp-273.15))/10,d=new Date(1E3*a.dt),c='<p class="weather_title"><a href="http://openweathermap.org/station/'+a.id+'">'+a.name+'</a></p> <div class="weather_block">\t<div class="cur_weather_block" >\t\t<img class="station_image" alt="'+GetWeatherText2(a)+'" src="'+GetStationIcon(a)+'"/>\t\t<div class="temp_block">\t\t\t<div class="big_temp" title="Current Temperature">'+c+"\u00b0</div>\t\t</div>\t</div>";a.main.humidity&&(c+='<div class="small_val_grey">Humidity: '+
a.main.humidity+"%</div>");a.wind&&(c+='<div class="small_val_grey">Wind: '+a.wind.speed+" m/s</div>");a.main.pressure&&(c+='<div class="small_val_grey">Pressure: '+a.main.pressure+" hpa</div>");a.rain&&a.rain["1h"]&&(c+='<div class="small_val_grey">Rain: '+a.rain["1h"]+" mm</div>");c+='<div class="small_val_grey" title="'+d.toString()+'" >Recived at '+d.toTimeString()+"</div></div>";return c+"</div>"}
function GetStationIcon(a){return 1==a.type?"http://openweathermap.org/img/s/iplane.png":"http://openweathermap.org/img/s/istation.png"}
(function(a){a="undefined"!==typeof exports?exports:a.SunCalc={};var c=Math,d=c.PI/180,e=c.sin,f=c.cos,q=357.5291*d,l=.98560028*d,n=1.9148*d,g=.02*d,s=3E-4*d,r=102.9372*d,x=23.45*d,E=280.16*d,F=360.9856235*d,y=[[-.83,"sunrise","sunset"],[-.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]];a.addTime=function(a,c,d){y.push([a,c,d])};a.getTimes=function(a,p,m){m=d*-m;p*=d;a=c.round(a.valueOf()/864E5-.5+2440588-
2451545-9E-4-m/(2*c.PI));var h=2451545.0009+(0+m)/(2*c.PI)+a,k=q+l*(h-2451545),u=n*e(k)+g*e(2*k)+s*e(3*k),u=k+r+u+c.PI,A=c.asin(e(u)*e(x)),h=h+.0053*e(k)+-.0069*e(2*u),z={solarNoon:new Date(864E5*(h+.5-2440588))},v,B,t,w,C,D;v=0;for(B=y.length;v<B;v+=1)t=y[v],w=t[0],C=t[1],t=t[2],w=2451545.0009+(c.acos((e(w*d)-e(p)*e(A))/(f(p)*f(A)))+m)/(2*c.PI)+a+.0053*e(k)+-.0069*e(2*u),D=h-(w-h),z[C]=new Date(864E5*(D+.5-2440588)),z[t]=new Date(864E5*(w+.5-2440588));return z};a.getPosition=function(a,p,m){m=d*
-m;p*=d;a=a.valueOf()/864E5-.5+2440588;var h=q+l*(a-2451545),k=n*e(h)+g*e(2*h)+s*e(3*h),k=h+r+k+c.PI,h=c.asin(e(k)*e(x)),k=c.atan2(e(k)*f(x),f(k));m=E+F*(a-2451545)-m-k;return{azimuth:c.atan2(e(m),f(m)*e(p)-c.tan(h)*f(p)),altitude:c.asin(e(p)*e(h)+f(p)*f(h)*f(m))}}})(this);
