function USNG2(){var d="ABCDEFGHJKLMNPQRSTUV".split(""),f="FGHJKLMNPQRSTUVABCDE".split(""),p="ABCDEFGH".split(""),s="JKLMNPQR".split(""),v="STUVWXYZ".split(""),A="CDEFGHJKLMNPQRSTUVWX".split(""),D=[-80,-72,-64,-56,-48,-40,-32,-24,-16,-8,0,8,16,24,32,40,48,58,64,72],B=Array(20);for(i=0;20>i;i++)B[i]=110946.259*D[i];this.llDistance=function(b,q){lat_s=b.lat*Math.PI/180;lat_f=q.lat*Math.PI/180;d_lon=(q.lon-b.lon)*Math.PI/180;return Math.atan2(Math.sqrt(Math.pow(Math.cos(lat_f)*Math.sin(d_lon),2)+Math.pow(Math.cos(lat_s)*
Math.sin(lat_f)-Math.sin(lat_s)*Math.cos(lat_f)*Math.cos(d_lon),2)),Math.sin(lat_s)*Math.sin(lat_f)+Math.cos(lat_s)*Math.cos(lat_f)*Math.cos(d_lon))};this.fromUTM=function(b,q,g,u,r){var l;grid_square_set=b%6;ew_idx=Math.floor(g/1E5)-1;ns_idx=Math.floor(u%2E6/1E5);switch(grid_square_set){case 1:l=p[ew_idx]+d[ns_idx];break;case 2:l=s[ew_idx]+f[ns_idx];break;case 3:l=v[ew_idx]+d[ns_idx];break;case 4:l=p[ew_idx]+f[ns_idx];break;case 5:l=s[ew_idx]+d[ns_idx];break;case 0:l=v[ew_idx]+f[ns_idx];break;default:throw"USNG: can't get here";
}for(var c=Math.floor(g%1E5).toString(),a=Math.floor(u%1E5).toString();5>c.length;)c="0"+c;for(;5>a.length;)a="0"+a;5<r?(digits=r-5,g=c+(g%1).toFixed(digits).substr(2,digits),u=a+(u%1).toFixed(digits).substr(2,digits)):(g=c.substr(0,r),u=a.substr(0,r));return usng_string=String(b)+q+l+g+u};this.toUTMFromFullParsedUSNG=function(b,q,g,u,r,l){var c=0,a=0;switch(b%6){case 1:c=d;a=p;break;case 2:c=f;a=s;break;case 3:c=d;a=v;break;case 4:c=f;a=p;break;case 5:c=d;a=s;break;case 0:c=f;a=v;break;default:throw"Can't get here";
}ew_idx=a.indexOf(g[0]);ns_idx=c.indexOf(g[1]);if(-1==ew_idx||-1==ns_idx)throw"USNG: Invalid USNG 100km grid designator.";c=1E5*(ew_idx+1)+u;a=1E5*(ns_idx+0)+r;min_northing=B[A.indexOf(q)];a+=2E6*Math.ceil((min_northing-a)/2E6);ll=utm_proj.invProj(b,c,a);ll_utm_zone=Math.floor((ll.lon- -180)/6)+1;ll_grid_zone=A[Math.floor((ll.lat- -80)/8)];ll_grid_zone!=q&&(a-=2E6,ll=utm_proj.invProj(b,c,a),ll_utm_zone=Math.floor((ll.lon- -180)/6)+1,ll_grid_zone=A[Math.floor((ll.lat- -80)/8)]);if(ll_utm_zone!=b||
ll_grid_zone!=q)throw"USNG: calculated coordinate not in correct UTM or grid zone! Supplied: "+b+q+" Calculated: "+ll_utm_zone+ll_grid_zone;return{zone:b,easting:c,northing:a,precision:l}};this.toUTM=function(b,q){var g=0,u=0,r=0,l=null,c=null,a=null,e=null;b=b.replace(/ /g,"");re=/([0-9]+)$/;if(fields=re.exec(b))l=fields[0],r=l.length/2,scale_factor=Math.pow(10,5-r),g=Number(l.substr(0,r))*scale_factor,u=Number(l.substr(r,r))*scale_factor;b=b.substr(0,b.length-2*r);re=/([A-Z][A-Z]$)/;(fields=re.exec(b))&&
(c=fields[0]);b=b.substr(0,b.length-2);re=/([0-9]+)([A-Z])/;if(fields=re.exec(b))e=fields[1],a=fields[2];if(!(e&&a&&c))if(c&&q){for(var k=1E3,n=null,h=null,m=Math.floor((q.lon- -180)/6)+1,e=m-1;e<=m+1;e++)for(grid_zone_idx=0;20>grid_zone_idx;grid_zone_idx++){a=A[grid_zone_idx];try{result=this.toLonLat(e%60+a+c+l),arc_distance=this.llDistance(q,result),arc_distance<k&&(k=arc_distance,n=e%60,h=a)}catch(E){}}if(n&&h)e=n,a=h;else throw"USNG: Couldn't find a match";}else if(q){for(var k=1E3,t=h=n=null,
m=Math.floor((q.lon- -180)/6)+1,C=Math.floor((q.lat- -80)/8),e=m-1;e<=m+1;e++)for(grid_zone_idx=C-1;grid_zone_idx<=C+1;grid_zone_idx++){var a=A[grid_zone_idx],w,z;switch(e%6){case 1:w=d;z=p;break;case 2:w=f;z=s;break;case 3:w=d;z=v;break;case 4:w=f;z=p;break;case 5:w=d;z=s;break;case 0:w=f;z=v;break;default:throw"Can't get here";}for(ns_idx=0;20>ns_idx;ns_idx++)for(ew_idx=0;8>ew_idx;ew_idx++)try{c=z[ew_idx]+w[ns_idx],result=this.toLonLat(e%60+a+c+l),arc_distance=this.llDistance(q,result),arc_distance<
k&&(k=arc_distance,n=e%60,h=a,t=c)}catch(F){}}if(n&&h)e=n,a=h,c=t;else throw"USNG: Couldn't find a match";}else throw"USNG: Not enough information to locate point.";return this.toUTMFromFullParsedUSNG(e,a,c,g,u,r)};this.fromLonLat=function(b,q){usng_string=new String;for(var g=b.lon,d=b.lat;-180>g;)g+=180;for(;180<g;)g-=180;utm_zone=Math.floor((g- -180)/6)+1;if(!(-80<d&&80>d))throw"USNG: Latitude must be between -80 and 80. (Zones A and B are not implemented yet.)";var f=A[Math.floor((d- -80)/8)],
g=utm_proj.proj(utm_zone,g,d);return this.fromUTM(utm_zone,f,g.utm_easting,g.utm_northing,q)};this.toLonLat=function(b,d){result=this.toUTM(b,d);ll=utm_proj.invProj(result.zone,result.easting,result.northing);ll.precision=result.precision;return ll};this.UTM=function(){var b=(40680631590769-6356752.3*6356752.3)/40680631590769,d=b/(1-b),g=b*b,f=b*g,r=Math.PI/180;this.proj=function(l,c,a){var e=-(6*(30-l)+3)*r,k=a*r,n=c*r,h=Math.sin(k),m=Math.cos(k);c=h/m;a=c*c;var p=a*a,h=6378137/Math.sqrt(1-b*h*h),
t=d*m*m,e=m*(n-e),n=6378137*(15*g/256+45*f/1024),m=-223234795*f/3072,k=6378137*(1-b/4-3*g/64-5*f/256)*k+-6378137*(3*b/8+3*g/32+45*f/1024)*Math.sin(2*k)+n*Math.sin(4*k)+m*Math.sin(6*k),m=1-a+t,s=5-18*a+p+72*t-58*d,n=Math.pow(e,5);x=0.9996*h*(e+m*Math.pow(e,3)/6+s*n/120)+5E5;m=(5-a+9*t+4*t*t)*Math.pow(e,4)/24;y=0.9996*(k+h*c*(e*e/2+m+(61-58*a+p+600*t-330*d)*(n*e/720)));return{utm_zone:l,utm_easting:x,utm_northing:y}};this.invProj=function(l,c,a){l=-(6*(30-l)+3)*r;var e=Math.sqrt(1-b),e=(1-e)/(1+e),
k=e*e,n=e*k;c-=5E5;a=a/0.9996/(6378137*(1-b/4-3*(g/64)-5*(f/256)));k=1.3125*k-1.71875*k*k;a=a+(1.5*e-0.84375*n)*Math.sin(2*a)+k*Math.sin(4*a)+151*n/96*Math.sin(6*a);var h=Math.sin(a),e=Math.cos(a),n=h/e,k=6378137/Math.sqrt(1-b*h*h),m=n*n,p=d*e*e,h=1-b*h*h,h=6378137*(1-b)/Math.sqrt(h*h*h);c/=0.9996*k;var t=c*c,s=c*t,w=t*t,z=m*m,v=p*p;temp2=5+3*m+10*p-4*v-9*d;temp4=61+90*m+298*p+45*z-252*d-3*v;temp5=(1+2*m+p)*s/6;temp6=5-2*p+28*m-3*v+8*d+24*z;lat=180*(a-k*n/h*(t/2-temp2*(w/24)+temp4*s*s/720))/Math.PI;
lon=180*(l+(c-temp5+temp6*c*w/120)/e)/Math.PI;return{lon:lon,lat:lat}}};utm_proj=new this.UTM}
OpenLayers.Control.MGRSMousePosition=OpenLayers.Class(OpenLayers.Control,{element:null,prefix:"",separator:", ",suffix:"",numDigits:5,granularity:10,lastXy:null,displayProjection:null,initialize:function(d){OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.map&&this.map.events.unregister("mousemove",this,this.redraw);OpenLayers.Control.prototype.destroy.apply(this,arguments)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.element||
(this.div.left="",this.div.top="",this.element=this.div);this.redraw();return this.div},redraw:function(d){var f;if(null==d)f=new OpenLayers.LonLat(0,0);else{if(null==this.lastXy||Math.abs(d.xy.x-this.lastXy.x)>this.granularity||Math.abs(d.xy.y-this.lastXy.y)>this.granularity){this.lastXy=d.xy;return}f=this.map.getLonLatFromPixel(d.xy);if(!f)return;this.displayProjection&&f.transform(this.map.getProjectionObject(),this.displayProjection);this.lastXy=d.xy}d=this.formatOutput(f);d!=this.element.innerHTML&&
(this.element.innerHTML=d)},formatOutput:function(d){var f=OpenLayers.INCHES_PER_UNIT,f=this.map.getResolution()*f[this.map.getUnits()]*(1/f.m),p=parseInt(6-Math.ceil(Math.log(f)/2.302585092994046)),f=parseInt(this.numDigits),s=new USNG2,p=-80<d.lat&&80>d.lat?s.fromLonLat(d,p-1):"undefined";return this.prefix+d.lon.toFixed(f)+this.separator+d.lat.toFixed(f)+" / MGRS: "+p+this.suffix},setMap:function(){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.register("mousemove",this,
this.redraw)},CLASS_NAME:"OpenLayers.Control.MousePosition"});
