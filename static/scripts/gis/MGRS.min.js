function USNG2(){var d=["A","B","C","D","E","F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V"],f=["F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V","A","B","C","D","E"],m=["A","B","C","D","E","F","G","H"],q=["J","K","L","M","N","P","Q","R"],s=["S","T","U","V","W","X","Y","Z"],t=["C","D","E","F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V","W","X"],B=[-80,-72,-64,-56,-48,-40,-32,-24,-16,-8,0,8,16,24,32,40,48,58,64,72],w=Array(20);for(i=0;i<20;i++)w[i]=110946.259*B[i];
this.llDistance=function(c,n){lat_s=c.lat*Math.PI/180;lat_f=n.lat*Math.PI/180;d_lon=(n.lon-c.lon)*Math.PI/180;return Math.atan2(Math.sqrt(Math.pow(Math.cos(lat_f)*Math.sin(d_lon),2)+Math.pow(Math.cos(lat_s)*Math.sin(lat_f)-Math.sin(lat_s)*Math.cos(lat_f)*Math.cos(d_lon),2)),Math.sin(lat_s)*Math.sin(lat_f)+Math.cos(lat_s)*Math.cos(lat_f)*Math.cos(d_lon))};this.fromUTM=function(c,n,g,r,o){var k;grid_square_set=c%6;ew_idx=Math.floor(g/1E5)-1;ns_idx=Math.floor(r%2E6/1E5);switch(grid_square_set){case 1:k=
m[ew_idx]+d[ns_idx];break;case 2:k=q[ew_idx]+f[ns_idx];break;case 3:k=s[ew_idx]+d[ns_idx];break;case 4:k=m[ew_idx]+f[ns_idx];break;case 5:k=q[ew_idx]+d[ns_idx];break;case 0:k=s[ew_idx]+f[ns_idx];break;default:throw"USNG: can't get here";}for(var b=Math.floor(g%1E5).toString(),a=Math.floor(r%1E5).toString();b.length<5;)b="0"+b;for(;a.length<5;)a="0"+a;o>5?(digits=o-5,g=b+(g%1).toFixed(digits).substr(2,digits),r=a+(r%1).toFixed(digits).substr(2,digits)):(g=b.substr(0,o),r=a.substr(0,o));return usng_string=
String(c)+n+k+g+r};this.toUTMFromFullParsedUSNG=function(c,n,g,r,o,k){var b=0,a=0;switch(c%6){case 1:b=d;a=m;break;case 2:b=f;a=q;break;case 3:b=d;a=s;break;case 4:b=f;a=m;break;case 5:b=d;a=q;break;case 0:b=f;a=s;break;default:throw"Can't get here";}ew_idx=a.indexOf(g[0]);ns_idx=b.indexOf(g[1]);if(ew_idx==-1||ns_idx==-1)throw"USNG: Invalid USNG 100km grid designator.";b=(ew_idx+1)*1E5+r;a=(ns_idx+0)*1E5+o;min_northing=w[t.indexOf(n)];a+=2E6*Math.ceil((min_northing-a)/2E6);ll=utm_proj.invProj(c,b,
a);ll_utm_zone=Math.floor((ll.lon- -180)/6)+1;ll_grid_zone=t[Math.floor((ll.lat- -80)/8)];ll_grid_zone!=n&&(a-=2E6,ll=utm_proj.invProj(c,b,a),ll_utm_zone=Math.floor((ll.lon- -180)/6)+1,ll_grid_zone=t[Math.floor((ll.lat- -80)/8)]);if(ll_utm_zone!=c||ll_grid_zone!=n)throw"USNG: calculated coordinate not in correct UTM or grid zone! Supplied: "+c+n+" Calculated: "+ll_utm_zone+ll_grid_zone;return{zone:c,easting:b,northing:a,precision:k}};this.toUTM=function(c,n){var g=0,r=0,o=0,k=null,b=null,a=null,e=
null,c=c.replace(/ /g,"");re=/([0-9]+)$/;if(fields=re.exec(c))k=fields[0],o=k.length/2,scale_factor=Math.pow(10,5-o),g=Number(k.substr(0,o))*scale_factor,r=Number(k.substr(o,o))*scale_factor;c=c.substr(0,c.length-o*2);re=/([A-Z][A-Z]$)/;(fields=re.exec(c))&&(b=fields[0]);c=c.substr(0,c.length-2);re=/([0-9]+)([A-Z])/;if(fields=re.exec(c))e=fields[1],a=fields[2];if(!e||!a||!b)if(b&&n){for(var l=1E3,h=null,j=null,p=Math.floor((n.lon- -180)/6)+1,e=p-1;e<=p+1;e++)for(grid_zone_idx=0;grid_zone_idx<20;grid_zone_idx++){a=
t[grid_zone_idx];try{result=this.toLonLat(e%60+a+b+k),arc_distance=this.llDistance(n,result),arc_distance<l&&(l=arc_distance,h=e%60,j=a)}catch(C){}}if(h&&j)e=h,a=j;else throw"USNG: Couldn't find a match";}else if(n){for(var l=1E3,z=j=h=null,p=Math.floor((n.lon- -180)/6)+1,A=Math.floor((n.lat- -80)/8),e=p-1;e<=p+1;e++)for(grid_zone_idx=A-1;grid_zone_idx<=A+1;grid_zone_idx++){var a=t[grid_zone_idx],u,v;switch(e%6){case 1:u=d;v=m;break;case 2:u=f;v=q;break;case 3:u=d;v=s;break;case 4:u=f;v=m;break;case 5:u=
d;v=q;break;case 0:u=f;v=s;break;default:throw"Can't get here";}for(ns_idx=0;ns_idx<20;ns_idx++)for(ew_idx=0;ew_idx<8;ew_idx++)try{b=v[ew_idx]+u[ns_idx],result=this.toLonLat(e%60+a+b+k),arc_distance=this.llDistance(n,result),arc_distance<l&&(l=arc_distance,h=e%60,j=a,z=b)}catch(D){}}if(h&&j)e=h,a=j,b=z;else throw"USNG: Couldn't find a match";}else throw"USNG: Not enough information to locate point.";return this.toUTMFromFullParsedUSNG(e,a,b,g,r,o)};this.fromLonLat=function(c,n){usng_string=new String;
for(var g=c.lon,d=c.lat;g<-180;)g+=180;for(;g>180;)g-=180;utm_zone=Math.floor((g- -180)/6)+1;if(!(d>-80&&d<80))throw"USNG: Latitude must be between -80 and 80. (Zones A and B are not implemented yet.)";var f=t[Math.floor((d- -80)/8)],g=utm_proj.proj(utm_zone,g,d);return this.fromUTM(utm_zone,f,g.utm_easting,g.utm_northing,n)};this.toLonLat=function(c,d){result=this.toUTM(c,d);ll=utm_proj.invProj(result.zone,result.easting,result.northing);ll.precision=result.precision;return ll};this.UTM=function(){var c=
(40680631590769-6356752.3*6356752.3)/40680631590769,d=c/(1-c),g=c*c,f=c*g,o=Math.PI/180;this.proj=function(k,b,a){var e=a*o,l=Math.sin(e),h=Math.cos(e),a=l/h,j=a*a,p=j*j,l=6378137/Math.sqrt(1-c*l*l),m=d*h*h,b=h*(b*o- -((30-k)*6+3)*o),e=6378137*(1-c/4-3*g/64-5*f/256)*e+-6378137*(3*c/8+3*g/32+45*f/1024)*Math.sin(e*2)+6378137*(15*g/256+45*f/1024)*Math.sin(e*4)+-223234795*f/3072*Math.sin(e*6),h=Math.pow(b,5);x=0.9996*l*(b+(1-j+m)*Math.pow(b,3)/6+(5-18*j+p+72*m-58*d)*h/120)+5E5;y=0.9996*(e+l*a*(b*b/2+
(5-j+9*m+4*m*m)*Math.pow(b,4)/24+(61-58*j+p+600*m-330*d)*(h*b/720)));return{utm_zone:k,utm_easting:x,utm_northing:y}};this.invProj=function(k,b,a){var k=-((30-k)*6+3)*o,e=Math.sqrt(1-c),l=(1-e)/(1+e),h=l*l,j=l*h;b-=5E5;var a=a/0.9996/(6378137*(1-c/4-3*(g/64)-5*(f/256))),a=a+(1.5*l-0.84375*j)*Math.sin(2*a)+(1.3125*h-1.71875*h*h)*Math.sin(4*a)+151*j/96*Math.sin(6*a),p=Math.sin(a),l=Math.cos(a),e=p/l,m=6378137/Math.sqrt(1-c*p*p),h=e*e,j=d*l*l,p=1-c*p*p;b/=m*0.9996;var q=b*b,s=b*q,u=q*q,v=h*h,t=j*j,e=
m*e/(6378137*(1-c)/Math.sqrt(p*p*p));temp2=5+3*h+10*j-4*t-9*d;temp4=61+90*h+298*j+45*v-252*d-3*t;temp5=(1+2*h+j)*s/6;temp6=5-2*j+28*h-3*t+8*d+24*v;lat=(a-e*(q/2-temp2*(u/24)+temp4*s*s/720))*180/Math.PI;lon=(k+(b-temp5+temp6*b*u/120)/l)*180/Math.PI;return{lon:lon,lat:lat}}};utm_proj=new this.UTM}
OpenLayers.Control.MGRSMousePosition=OpenLayers.Class(OpenLayers.Control,{element:null,prefix:"",separator:", ",suffix:"",numDigits:5,granularity:10,lastXy:null,displayProjection:null,initialize:function(){OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.map&&this.map.events.unregister("mousemove",this,this.redraw);OpenLayers.Control.prototype.destroy.apply(this,arguments)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);if(!this.element)this.div.left=
"",this.div.top="",this.element=this.div;this.redraw();return this.div},redraw:function(d){var f;if(d==null)f=new OpenLayers.LonLat(0,0);else{if(this.lastXy==null||Math.abs(d.xy.x-this.lastXy.x)>this.granularity||Math.abs(d.xy.y-this.lastXy.y)>this.granularity){this.lastXy=d.xy;return}f=this.map.getLonLatFromPixel(d.xy);if(!f)return;this.displayProjection&&f.transform(this.map.getProjectionObject(),this.displayProjection);this.lastXy=d.xy}d=this.formatOutput(f);if(d!=this.element.innerHTML)this.element.innerHTML=
d},formatOutput:function(d){var f=OpenLayers.INCHES_PER_UNIT,f=this.map.getResolution()*f[this.map.getUnits()]*(1/f.m),m=parseInt(6-Math.ceil(Math.log(f)/2.302585092994046)),f=parseInt(this.numDigits),q=new USNG2,m=d.lat>-80&&d.lat<80?q.fromLonLat(d,m-1):"undefined";return this.prefix+d.lon.toFixed(f)+this.separator+d.lat.toFixed(f)+" / MGRS: "+m+this.suffix},setMap:function(){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.register("mousemove",this,this.redraw)},CLASS_NAME:"OpenLayers.Control.MousePosition"});
