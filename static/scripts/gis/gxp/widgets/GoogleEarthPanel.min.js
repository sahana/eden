Ext.namespace("gxp");
gxp.GoogleEarthPanel=Ext.extend(Ext.Panel,{HORIZONTAL_FIELD_OF_VIEW:30*Math.PI/180,map:null,mapPanel:null,layers:null,earth:null,projection:null,layerCache:null,initComponent:function(){this.addEvents("beforeadd","pluginfailure","pluginready");gxp.GoogleEarthPanel.superclass.initComponent.call(this);var a=this.mapPanel;!a||a instanceof GeoExt.MapPanel||(a=Ext.getCmp(a));if(!a)throw Error("Could not get map panel from config: "+this.mapPanel);this.map=a.map;this.layers=a.layers;this.projection=new OpenLayers.Projection("EPSG:4326");
this.on("render",this.onRenderEvent,this);this.on("show",this.onShowEvent,this);this.on("hide",function(){null!=this.earth&&this.updateMap();this.body.dom.innerHTML="";this.earth=null},this)},onEarthReady:function(a){this.earth=a;void 0===this.flyToSpeed?this.earth.getOptions().setFlyToSpeed(this.earth.SPEED_TELEPORT):null!==this.flyToSpeed&&this.earth.getOptions().setFlyToSpeed(this.flyToSpeed);this.resetCamera();this.setExtent(this.map.getExtent());this.earth.getNavigationControl().setVisibility(this.earth.VISIBILITY_SHOW);
a=this.earth.getNavigationControl().getScreenXY();a.setXUnits(this.earth.UNITS_PIXELS);a.setYUnits(this.earth.UNITS_INSET_PIXELS);this.earth.getWindow().setVisibility(!0);this.layers.each(function(a){this.addLayer(a)},this);this.layers.on("remove",this.updateLayers,this);this.layers.on("update",this.updateLayers,this);this.layers.on("add",this.updateLayers,this);this.fireEvent("pluginready",this.earth)},onRenderEvent:function(){var a=this.ownerCt&&this.ownerCt.layout instanceof Ext.layout.CardLayout;
if(!this.hidden&&!a)this.onShowEvent()},onShowEvent:function(){if(this.rendered){this.layerCache={};try{google.earth.createInstance(this.body.dom,this.onEarthReady.createDelegate(this),function(a){this.fireEvent("pluginfailure",this,a)}.createDelegate(this))}catch(a){}}},beforeDestroy:function(){this.layers.un("remove",this.updateLayers,this);this.layers.un("update",this.updateLayers,this);this.layers.un("add",this.updateLayers,this);gxp.GoogleEarthPanel.superclass.beforeDestroy.call(this)},updateLayers:function(){if(this.earth){try{var a=
this.earth.getFeatures()}catch(c){return}for(var b=a.getFirstChild();null!=b;)a.removeChild(b),b=a.getFirstChild();this.layers.each(function(a){this.addLayer(a)},this)}},addLayer:function(a,c){var b=a.getLayer(),d=b&&b.url;if(this.earth&&(b instanceof OpenLayers.Layer.WMS&&"string"==typeof d)&&!1!==this.fireEvent("beforeadd",a)){var e=b.id;if(this.layerCache[e])d=this.layerCache[e];else{var f=this.earth.createLink("kl_"+e),d=d.replace(/\?.*/,""),g=b.params;f.setHref(d+("/kml?mode=refresh&layers="+
g.LAYERS+"&styles="+g.STYLES));d=this.earth.createNetworkLink("nl_"+e);d.setName(e);d.set(f,!1,!1);this.layerCache[e]=d}d.setVisibility(b.getVisibility());void 0!==c&&c<this.earth.getFeatures().getChildNodes().getLength()?this.earth.getFeatures().insertBefore(this.earth.getFeatures().getChildNodes().item(c)):this.earth.getFeatures().appendChild(d)}},setExtent:function(a){a=a.transform(this.map.getProjectionObject(),this.projection);var c=a.getCenterLonLat();a=this.getExtentWidth(a)/(2*Math.tan(this.HORIZONTAL_FIELD_OF_VIEW));
var b=this.earth.getView().copyAsLookAt(this.earth.ALTITUDE_RELATIVE_TO_GROUND);b.setLatitude(c.lat);b.setLongitude(c.lon);b.setRange(a);this.earth.getView().setAbstractView(b)},resetCamera:function(){var a=this.earth.getView().copyAsCamera(this.earth.ALTITUDE_RELATIVE_TO_GROUND);a.setRoll(0);a.setHeading(0);a.setTilt(0);this.earth.getView().setAbstractView(a)},getExtent:function(){var a=this.earth.getView().getViewportGlobeBounds();return new OpenLayers.Bounds(a.getWest(),a.getSouth(),a.getEast(),
a.getNorth())},updateMap:function(){var a=this.earth.getView().copyAsLookAt(this.earth.ALTITUDE_RELATIVE_TO_GROUND),c=this.reprojectToMap(new OpenLayers.LonLat(a.getLongitude(),a.getLatitude())),b=this.reprojectToMap(this.getExtent());this.map.zoomToExtent(b,!0);this.map.setCenter(c);var a=2*a.getRange()*Math.tan(this.HORIZONTAL_FIELD_OF_VIEW),d=this.map.getResolutionForZoom(this.map.getZoom()+1),b=this.map.getExtent(),c=new OpenLayers.Bounds(c.lon-this.map.getSize().w/2*d,c.lat+this.map.getSize().h/
2*d,c.lon+this.map.getSize().w/2*d,c.lat-this.map.getSize().h/2*d),b=Math.abs(this.getExtentWidth(b)-a);Math.abs(this.getExtentWidth(c)-a)<b&&this.map.zoomTo(this.map.getZoom()+1)},getExtentWidth:function(a){var c=a.getCenterLonLat(),b=new OpenLayers.LonLat(a.left,c.lat);a=new OpenLayers.LonLat(a.right,c.lat);return 1E3*OpenLayers.Util.distVincenty(b,a)},reprojectToGE:function(a){return a.clone().transform(this.map.getProjectionObject(),this.projection)},reprojectToMap:function(a){return a.clone().transform(this.projection,
this.map.getProjectionObject())}});Ext.reg("gxp_googleearthpanel",gxp.GoogleEarthPanel);
