Ext.namespace("gxp.plugins");
gxp.plugins.WMSGetFeatureInfo=Ext.extend(gxp.plugins.Tool,{ptype:"gxp_wmsgetfeatureinfo",outputTarget:"map",popupCache:null,infoActionTip:"Get Feature Info",popupTitle:"Feature Info",format:"html",addActions:function(){this.popupCache={};var c=gxp.plugins.WMSGetFeatureInfo.superclass.addActions.call(this,[{tooltip:this.infoActionTip,iconCls:"gxp-icon-getfeatureinfo",toggleGroup:this.toggleGroup,enableToggle:!0,allowDepress:!0,toggleHandler:function(e,c){for(var a=0,d=b.controls.length;a<d;a++)c?b.controls[a].activate():
b.controls[a].deactivate()}}]),h=this.actions[0].items[0],b={controls:[]},d=function(){for(var c=this.target.mapPanel.layers.queryBy(function(b){return b.get("queryable")}),d=this.target.mapPanel.map,a,f=0,m=b.controls.length;f<m;f++)a=b.controls[f],a.deactivate(),a.destroy();b.controls=[];c.each(function(c){var a=c.getLayer(),e=Ext.apply({},this.vendorParams),f;if(this.layerParams)for(var l=this.layerParams.length-1;0<=l;--l)f=this.layerParams[l].toUpperCase(),e[f]=a.params[f];var g=c.get("infoFormat");
void 0===g&&(g="html"==this.format?"text/html":"application/vnd.ogc.gml");a=new OpenLayers.Control.WMSGetFeatureInfo(Ext.applyIf({url:a.url,queryVisible:!0,layers:[a],infoFormat:g,vendorParams:e,eventListeners:{getfeatureinfo:function(a){if(a.features&&0<a.features.length){var b=c.get("title")||c.get("name");if("text/html"==g){var d=a.text.match(/<body[^>]*>([\s\S]*)<\/body>/);d&&!d[1].match(/^\s*$/)&&this.displayPopup(a,b,d[1])}else"text/plain"==g?this.displayPopup(a,b,"<pre>"+a.text+"</pre>"):this.displayPopup(a,
b)}},scope:this}},this.controlOptions));d.addControl(a);b.controls.push(a);h.pressed&&a.activate()},this)};this.target.mapPanel.layers.on("update",d,this);this.target.mapPanel.layers.on("add",d,this);this.target.mapPanel.layers.on("remove",d,this);return c},displayPopup:function(c,h,b){var d,e=c.xy.x+"."+c.xy.y;e in this.popupCache?d=this.popupCache[e]:(d=this.addOutput({xtype:"gx_popup",title:this.popupTitle,layout:"accordion",fill:!1,autoScroll:!0,location:c.xy,map:this.target.mapPanel,width:250,
height:300,defaults:{layout:"fit",autoScroll:!0,autoHeight:!0,autoWidth:!0,collapsible:!0},listeners:{close:function(a){return function(b){delete this.popupCache[a]}}(e),scope:this}}),this.popupCache[e]=d);c=c.features;e=[];if(!b&&c)for(var k=0,a=c.length;k<a;++k)b=c[k],e.push(Ext.apply({xtype:"propertygrid",listeners:{beforeedit:function(a){return!1}},title:b.fid?b.fid:h,source:b.attributes},this.itemConfig));else b&&e.push(Ext.apply({title:h,html:b},this.itemConfig));d.add(e);d.doLayout()}});
Ext.preg(gxp.plugins.WMSGetFeatureInfo.prototype.ptype,gxp.plugins.WMSGetFeatureInfo);
