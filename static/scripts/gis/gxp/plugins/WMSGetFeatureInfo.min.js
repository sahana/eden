Ext.namespace("gxp.plugins");
gxp.plugins.WMSGetFeatureInfo=Ext.extend(gxp.plugins.Tool,{ptype:"gxp_wmsgetfeatureinfo",outputTarget:"map",popupCache:null,infoActionTip:"Get Feature Info",popupTitle:"Feature Info",buttonText:"Identify",format:"html",addActions:function(){this.popupCache={};var a=gxp.plugins.WMSGetFeatureInfo.superclass.addActions.call(this,[{tooltip:this.infoActionTip,iconCls:"gxp-icon-getfeatureinfo",buttonText:this.buttonText,toggleGroup:this.toggleGroup,enableToggle:!0,allowDepress:!0,toggleHandler:function(a,
e){for(var d=0,c=b.controls.length;d<c;d++)e?b.controls[d].activate():b.controls[d].deactivate()}}]),k=this.actions[0].items[0],b={controls:[]},c=function(){for(var a=this.target.mapPanel.layers.queryBy(function(b){return b.get("queryable")}),e=this.target.mapPanel.map,d,c=0,g=b.controls.length;c<g;c++)d=b.controls[c],d.deactivate(),d.destroy();b.controls=[];a.each(function(c){var a=c.getLayer(),d=Ext.apply({},this.vendorParams),f;if(this.layerParams)for(var g=this.layerParams.length-1;0<=g;--g)f=
this.layerParams[g].toUpperCase(),d[f]=a.params[f];var h=c.get("infoFormat");void 0===h&&(h="html"==this.format?"text/html":"application/vnd.ogc.gml");a=new OpenLayers.Control.WMSGetFeatureInfo(Ext.applyIf({url:a.url,queryVisible:!0,layers:[a],infoFormat:h,vendorParams:d,eventListeners:{getfeatureinfo:function(a){var b=c.get("title")||c.get("name");if("text/html"==h){var d=a.text.match(/<body[^>]*>([\s\S]*)<\/body>/);d&&!d[1].match(/^\s*$/)&&this.displayPopup(a,b,d[1])}else"text/plain"==h?this.displayPopup(a,
b,"<pre>"+a.text+"</pre>"):a.features&&0<a.features.length&&this.displayPopup(a,b,null,c.get("getFeatureInfo"))},scope:this}},this.controlOptions));e.addControl(a);b.controls.push(a);k.pressed&&a.activate()},this)};this.target.mapPanel.layers.on("update",c,this);this.target.mapPanel.layers.on("add",c,this);this.target.mapPanel.layers.on("remove",c,this);return a},displayPopup:function(a,k,b,c){var f,e=a.xy.x+"."+a.xy.y;c=c||{};e in this.popupCache?f=this.popupCache[e]:(f=this.addOutput({xtype:"gx_popup",
title:this.popupTitle,layout:"accordion",fill:!1,autoScroll:!0,location:a.xy,map:this.target.mapPanel,width:250,height:300,defaults:{layout:"fit",autoScroll:!0,autoHeight:!0,autoWidth:!0,collapsible:!0}}),f.on({close:function(a){return function(b){delete this.popupCache[a]}}(e),scope:this}),this.popupCache[e]=f);a=a.features;e=[];if(!b&&a)for(var d=0,l=a.length;d<l;++d)b=a[d],e.push(Ext.apply({xtype:"gxp_editorgrid",readOnly:!0,listeners:{beforeedit:function(a){return!1}},title:b.fid?b.fid:k,feature:b,
fields:c.fields,propertyNames:c.propertyNames},this.itemConfig));else b&&e.push(Ext.apply({title:k,html:b},this.itemConfig));f.add(e);f.doLayout()}});Ext.preg(gxp.plugins.WMSGetFeatureInfo.prototype.ptype,gxp.plugins.WMSGetFeatureInfo);
