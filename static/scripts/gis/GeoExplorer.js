Ext.USE_NATIVE_JSON=!0;(function(){Ext.preg("gx_wmssource",gxp.plugins.WMSSource);Ext.preg("gx_olsource",gxp.plugins.OLSource);Ext.preg("gx_googlesource",gxp.plugins.GoogleSource);Ext.preg("gx_bingsource",gxp.plugins.BingSource);Ext.preg("gx_osmsource",gxp.plugins.OSMSource)})();
var GeoExplorer=Ext.extend(gxp.Viewer,{zoomSliderText:"<div>Zoom Level: {zoom}</div><div>Scale: 1:{scale}</div>",loadConfigErrorText:"Trouble reading saved configuration: <br />",loadConfigErrorDefaultText:"Server Error.",xhrTroubleText:"Communication Trouble: Status ",layersText:"Layers",titleText:"Title",saveErrorText:"Trouble saving: ",bookmarkText:"Bookmark URL",permakinkText:"Permalink",appInfoText:"GeoExplorer",aboutText:"About GeoExplorer",mapInfoText:"Map Info",descriptionText:"Description",
contactText:"Contact",aboutThisMapText:"About this Map",mapPanel:null,toggleGroup:"toolGroup",constructor:function(a){this.mapItems=[{xtype:"gxp_scaleoverlay"},{xtype:"gx_zoomslider",vertical:!0,height:100,plugins:new GeoExt.ZoomSliderTip({template:this.zoomSliderText})}];a.viewerTools=[{leaf:!0,text:gxp.plugins.Navigation.prototype.tooltip,checked:!0,iconCls:"gxp-icon-pan",ptype:"gxp_navigation",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:2}},{leaf:!0,text:gxp.plugins.WMSGetFeatureInfo.prototype.infoActionTip,
checked:!0,iconCls:"gxp-icon-getfeatureinfo",ptype:"gxp_wmsgetfeatureinfo",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:3}},{leaf:!0,text:gxp.plugins.Measure.prototype.measureTooltip,checked:!0,iconCls:"gxp-icon-measure-length",ptype:"gxp_measure",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:4}},{leaf:!0,text:gxp.plugins.Zoom.prototype.zoomInTooltip+" / "+gxp.plugins.Zoom.prototype.zoomOutTooltip,checked:!0,iconCls:"gxp-icon-zoom-in",ptype:"gxp_zoom",
actionTarget:{target:"paneltbar",index:5}},{leaf:!0,text:gxp.plugins.NavigationHistory.prototype.previousTooltip+" / "+gxp.plugins.NavigationHistory.prototype.nextTooltip,checked:!0,iconCls:"gxp-icon-zoom-previous",ptype:"gxp_navigationhistory",actionTarget:{target:"paneltbar",index:7}},{leaf:!0,text:gxp.plugins.ZoomToExtent.prototype.tooltip,checked:!0,iconCls:gxp.plugins.ZoomToExtent.prototype.iconCls,ptype:"gxp_zoomtoextent",actionTarget:{target:"paneltbar",index:9}},{leaf:!0,text:gxp.plugins.Legend.prototype.tooltip,
checked:!0,iconCls:"gxp-icon-legend",ptype:"gxp_legend",actionTarget:{target:"paneltbar",index:10}},{leaf:!0,text:gxp.plugins.GoogleEarth.prototype.tooltip,checked:!0,iconCls:"gxp-icon-googleearth",ptype:"gxp_googleearth",actionTarget:{target:"paneltbar",index:11}}];GeoExplorer.superclass.constructor.apply(this,arguments)},loadConfig:function(a){var b=window.location.hash.substr(1),c=b.match(/^maps\/(\d+)$/);if(c)this.id=Number(c[1]),OpenLayers.Request.GET({url:b,success:function(d){d=Ext.util.JSON.decode(d.responseText);
this.applyConfig(Ext.applyIf(d,a))},failure:function(d){var b;try{b=Ext.util.JSON.decode(d.responseText)}catch(c){}var e=this.loadConfigErrorText;e+=b&&b.error?b.error:this.loadConfigErrorDefaultText;this.on({ready:function(){this.displayXHRTrouble(e,d.status)},scope:this});delete this.id;window.location.hash="";this.applyConfig(a)},scope:this});else{if((b=Ext.urlDecode(document.location.search.substr(1)))&&b.q)b=Ext.util.JSON.decode(b.q),Ext.apply(a,b);this.applyConfig(a)}},displayXHRTrouble:function(a,
b){Ext.Msg.show({title:this.xhrTroubleText+b,msg:a,icon:Ext.MessageBox.WARNING})},initPortal:function(){var a=new Ext.Panel({border:!1,layout:"border",region:"west",width:250,split:!0,collapsible:!0,collapseMode:"mini",header:!1,items:[{region:"center",autoScroll:!0,tbar:[],border:!1,id:"tree",title:this.layersText},{region:"south",xtype:"container",layout:"fit",border:!1,height:200,id:"legend"}]});this.toolbar=new Ext.Toolbar({disabled:!0,id:"paneltbar",items:this.createTools()});this.on("ready",
function(){var a=this.toolbar.items.filterBy(function(a){return a.initialConfig&&a.initialConfig.disabled});this.toolbar.enable();a.each(function(a){a.disable()})});var b=new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{beforeadd:function(a){return a.get("group")!=="background"}}}),c=[];b.on("show",function(){c.length=0;this.toolbar.items.each(function(a){a.disabled&&c.push(a)});this.toolbar.disable();for(var a in this.tools){var b=this.tools[a];b.outputTarget==="map"&&b.removeOutput()}if(a=
(a=Ext.getCmp("tree"))&&a.getTopToolbar())a.items.each(function(a){a.disabled&&c.push(a)}),a.disable()},this);b.on("hide",function(){this.toolbar.enable();var a=Ext.getCmp("tree");(a=a&&a.getTopToolbar())&&a.enable();for(var a=0,b=c.length;a<b;++a)c[a].disable()},this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:!1},items:[this.mapPanel,b],activeItem:0});this.portalItems=[{region:"center",layout:"border",tbar:this.toolbar,items:[this.mapPanelContainer,a]}];
GeoExplorer.superclass.initPortal.apply(this,arguments)},createTools:function(){return["-"]},save:function(a,b){var c=Ext.util.JSON.encode(this.getState()),d,f;this.id?(d="PUT",f="maps/"+this.id):(d="POST",f="maps");OpenLayers.Request.issue({method:d,url:f,data:c,callback:function(d){this.handleSave(d);a&&a.call(b||this)},scope:this})},handleSave:function(a){if(a.status==200){if(a=Ext.util.JSON.decode(a.responseText).id)this.id=a,window.location.hash="#maps/"+a}else throw this.saveErrorText+a.responseText;
},showUrl:function(){var a=new Ext.Window({title:this.bookmarkText,layout:"form",labelAlign:"top",modal:!0,bodyStyle:"padding: 5px",width:300,items:[{xtype:"textfield",fieldLabel:this.permakinkText,readOnly:!0,anchor:"100%",selectOnFocus:!0,value:window.location.href}]});a.show();a.items.first().selectText()},getBookmark:function(){var a=Ext.apply(OpenLayers.Util.getParameters(),{q:Ext.util.JSON.encode(this.getState())});return document.location.href.split("?").shift()+"?"+Ext.urlEncode(a)},displayAppInfo:function(){var a=
new Ext.Panel({title:this.appInfoText,html:"<iframe style='border: none; height: 100%; width: 100%' src='about.html' frameborder='0' border='0'><a target='_blank' href='about.html'>"+this.aboutText+"</a> </iframe>"}),b=Ext.applyIf(this.about,{title:"","abstract":"",contact:""}),b=new Ext.Panel({title:this.mapInfoText,html:'<div class="gx-info-panel"><h2>'+this.titleText+"</h2><p>"+b.title+"</p><h2>"+this.descriptionText+"</h2><p>"+b["abstract"]+"</p> <h2>"+this.contactText+"</h2><p>"+b.contact+"</p></div>",
height:"auto",width:"auto"}),a=new Ext.TabPanel({activeTab:0,items:[b,a]});(new Ext.Window({title:this.aboutThisMapText,modal:!0,layout:"fit",width:300,height:300,items:[a]})).show()}});
GeoExplorer.Composer=Ext.extend(GeoExplorer,{saveMapText:"Save Map",exportMapText:"Export Map",toolsTitle:"Choose tools to include in the toolbar:",previewText:"Preview",backText:"Back",nextText:"Next",loginText:"Login",loginErrorText:"Invalid username or password.",userFieldText:"User",passwordFieldText:"Password",constructor:function(a){this.authorizedRoles=a.authStatus===401?[]:["ROLE_ADMINISTRATOR"];delete a.authStatus;a.tools=[{ptype:"gxp_layertree",outputConfig:{id:"layertree"},outputTarget:"tree"},
{ptype:"gxp_legend",outputTarget:"legend",outputConfig:{autoScroll:!0}},{ptype:"gxp_addlayers",actionTarget:"tree.tbar",upload:!0},{ptype:"gxp_removelayer",actionTarget:["tree.tbar","layertree.contextMenu"]},{ptype:"gxp_layerproperties",actionTarget:["tree.tbar","layertree.contextMenu"]},{ptype:"gxp_styler",actionTarget:["tree.tbar","layertree.contextMenu"]},{ptype:"gxp_zoomtolayerextent",actionTarget:{target:"layertree.contextMenu",index:0}},{ptype:"gxp_navigation",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",
index:6}},{ptype:"gxp_wmsgetfeatureinfo",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:7}},{ptype:"gxp_featuremanager",id:"featuremanager",maxFeatures:20,paging:!1},{ptype:"gxp_featureeditor",featureManager:"featuremanager",autoLoadFeatures:!0,toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:8}},{ptype:"gxp_measure",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:10}},{ptype:"gxp_zoom",actionTarget:{target:"paneltbar",index:11}},{ptype:"gxp_navigationhistory",
actionTarget:{target:"paneltbar",index:13}},{ptype:"gxp_zoomtoextent",actionTarget:{target:"paneltbar",index:15}},{ptype:"gxp_print",customParams:{outputFilename:"GeoExplorer-print"},printService:a.printService,actionTarget:{target:"paneltbar",index:5}},{ptype:"gxp_googleearth",actionTarget:{target:"paneltbar",index:17},apiKeys:{localhost:"ABQIAAAAeDjUod8ItM9dBg5_lz0esxTnme5EwnLVtEDGnh-lFVzRJhbdQhQBX5VH8Rb3adNACjSR5kaCLQuBmw","localhost:8080":"ABQIAAAAeDjUod8ItM9dBg5_lz0esxTnme5EwnLVtEDGnh-lFVzRJhbdQhQBX5VH8Rb3adNACjSR5kaCLQuBmw",
"example.com":"-your-api-key-here-"}}];GeoExplorer.Composer.superclass.constructor.apply(this,arguments)},destroy:function(){this.loginButton=null;GeoExplorer.Composer.superclass.destroy.apply(this,arguments)},showLoginDialog:function(){function a(){b.buttons[0].disable();b.getForm().submit({success:function(){this.authorizedRoles=["ROLE_ADMINISTRATOR"];Ext.getCmp("paneltbar").items.each(function(a){a.needsAuthorization===!0&&a.enable()});this.loginButton.hide();c.close()},failure:function(a){this.authorizedRoles=
[];b.buttons[0].enable();a.markInvalid({username:this.loginErrorText,password:this.loginErrorText})},scope:this})}var b=new Ext.FormPanel({url:"login",frame:!0,labelWidth:60,defaultType:"textfield",errorReader:{read:function(a){var b=!1,c=[];a.status===200?b=!0:c=[{data:{id:"username",msg:this.loginErrorText}},{data:{id:"password",msg:this.loginErrorText}}];return{success:b,records:c}}},items:[{fieldLabel:this.userFieldText,name:"username",allowBlank:!1},{fieldLabel:this.passwordFieldText,name:"password",
inputType:"password",allowBlank:!1}],buttons:[{text:this.loginText,formBind:!0,handler:a,scope:this}],keys:[{key:[Ext.EventObject.ENTER],handler:a,scope:this}]}),c=new Ext.Window({title:this.loginText,layout:"fit",width:235,height:130,plain:!0,border:!1,modal:!0,items:[b]});c.show()},createTools:function(){var a=GeoExplorer.Composer.superclass.createTools.apply(this,arguments);if(this.authorizedRoles.length===0)this.loginButton=new Ext.Button({iconCls:"login",text:this.loginText,handler:this.showLoginDialog,
scope:this}),a.push(["->",this.loginButton]);var b=new Ext.Button({text:this.appInfoText,iconCls:"icon-geoexplorer",handler:this.displayAppInfo,scope:this});a.unshift("-");a.unshift(new Ext.Button({tooltip:this.exportMapText,needsAuthorization:!0,disabled:!this.isAuthorized(),handler:function(){this.save(this.showEmbedWindow)},scope:this,iconCls:"icon-export"}));a.unshift(new Ext.Button({tooltip:this.saveMapText,needsAuthorization:!0,disabled:!this.isAuthorized(),handler:function(){this.save(this.showUrl)},
scope:this,iconCls:"icon-save"}));a.unshift("-");a.unshift(b);return a},openPreview:function(a){a=new Ext.Window({title:this.previewText,layout:"fit",items:[{border:!1,html:a.getIframeHTML()}]});a.show();var a=a.items.get(0).body,b=a.dom.firstChild,c=new Ext.LoadMask(a);c.show();Ext.get(b).on("load",function(){c.hide()})},showEmbedWindow:function(){var a=new Ext.tree.TreePanel({title:this.toolsTitle,autoScroll:!0,root:{nodeType:"async",expanded:!0,children:this.viewerTools},rootVisible:!1,id:"geobuilder-0"}),
b=function(a){var b=Ext.getCmp("geobuilder-wizard-panel").getLayout(),c=b.activeItem.id.split("geobuilder-")[1],c=parseInt(c,10)+a;b.setActiveItem(c);Ext.getCmp("wizard-prev").setDisabled(c==0);Ext.getCmp("wizard-next").setDisabled(c==1);a==1&&this.save()},c=new gxp.EmbedMapDialog({id:"geobuilder-1",url:"viewer#maps/"+this.id}),a={id:"geobuilder-wizard-panel",border:!1,layout:"card",activeItem:0,defaults:{border:!1,hideMode:"offsets"},bbar:[{id:"preview",text:this.previewText,handler:function(){this.save(this.openPreview.createDelegate(this,
[c]))},scope:this},"->",{id:"wizard-prev",text:this.backText,handler:b.createDelegate(this,[-1]),scope:this,disabled:!0},{id:"wizard-next",text:this.nextText,handler:b.createDelegate(this,[1]),scope:this}],items:[a,c]};(new Ext.Window({layout:"fit",width:500,height:300,title:this.exportMapText,items:[a]})).show()}});Ext.namespace("GeoExplorer");
GeoExplorer.Viewer=Ext.extend(GeoExplorer,{applyConfig:function(a){for(var b=a.viewerTools||this.viewerTools,c=[],d,f=0,i=b.length;f<i;f++){var e=b[f];if(e.checked===!0){d={ptype:e.ptype,toggleGroup:e.toggleGroup,actionTarget:e.actionTarget};if(e.ptype==="gxp_googleearth")for(var j=a.tools?a.tools.length:0,g,h=0;h<j;++h)if(g=a.tools[h],g.ptype===e.ptype){d.apiKey=g.apiKey;d.apiKeys=g.apiKeys;break}c.push(d)}}a.tools=c;GeoExplorer.Viewer.superclass.applyConfig.call(this,a)},initPortal:function(){this.toolbar=
new Ext.Toolbar({disabled:!0,id:"paneltbar",items:this.createTools()});this.on("ready",function(){this.toolbar.enable()},this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:!1},items:[this.mapPanel,new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{beforeadd:function(a){return a.get("group")!=="background"}}})],activeItem:0});this.portalItems=[{region:"center",layout:"border",tbar:this.toolbar,items:[this.mapPanelContainer]}];GeoExplorer.superclass.initPortal.apply(this,
arguments)},createTools:function(){var a=GeoExplorer.Viewer.superclass.createTools.apply(this,arguments),b=new Ext.Button({tooltip:"Layer Switcher",iconCls:"icon-layer-switcher",menu:new gxp.menu.LayerMenu({layers:this.mapPanel.layers})});a.unshift("-");a.unshift(b);b=new Ext.Button({tooltip:this.aboutText,iconCls:"icon-about",handler:this.displayAppInfo,scope:this});a.push("->");a.push(b);return a}});
