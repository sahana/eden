var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(p){var t=0;return function(){return t<p.length?{done:!1,value:p[t++]}:{done:!0}}};$jscomp.arrayIterator=function(p){return{next:$jscomp.arrayIteratorImpl(p)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(p,t,q){if(p==Array.prototype||p==Object.prototype)return p;p[t]=q.value;return p};$jscomp.getGlobal=function(p){p=["object"==typeof globalThis&&globalThis,p,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var t=0;t<p.length;++t){var q=p[t];if(q&&q.Math==Math)return q}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(p,t){var q=$jscomp.propertyToPolyfillSymbol[t];if(null==q)return p[t];q=p[q];return void 0!==q?q:p[t]};
$jscomp.polyfill=function(p,t,q,y){t&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(p,t,q,y):$jscomp.polyfillUnisolated(p,t,q,y))};$jscomp.polyfillUnisolated=function(p,t,q,y){q=$jscomp.global;p=p.split(".");for(y=0;y<p.length-1;y++){var z=p[y];if(!(z in q))return;q=q[z]}p=p[p.length-1];y=q[p];t=t(y);t!=y&&null!=t&&$jscomp.defineProperty(q,p,{configurable:!0,writable:!0,value:t})};
$jscomp.polyfillIsolated=function(p,t,q,y){var z=p.split(".");p=1===z.length;y=z[0];y=!p&&y in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var F=0;F<z.length-1;F++){var N=z[F];if(!(N in y))return;y=y[N]}z=z[z.length-1];q=$jscomp.IS_SYMBOL_NATIVE&&"es6"===q?y[z]:null;t=t(q);null!=t&&(p?$jscomp.defineProperty($jscomp.polyfills,z,{configurable:!0,writable:!0,value:t}):t!==q&&(void 0===$jscomp.propertyToPolyfillSymbol[z]&&(q=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[z]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(z):$jscomp.POLYFILL_PREFIX+q+"$"+z),$jscomp.defineProperty(y,$jscomp.propertyToPolyfillSymbol[z],{configurable:!0,writable:!0,value:t})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(p){if(p)return p;var t=function(F,N){this.$jscomp$symbol$id_=F;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:N})};t.prototype.toString=function(){return this.$jscomp$symbol$id_};var q="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",y=0,z=function(F){if(this instanceof z)throw new TypeError("Symbol is not a constructor");return new t(q+(F||"")+"_"+y++,F)};return z},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(p){if(p)return p;p=Symbol("Symbol.iterator");for(var t="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),q=0;q<t.length;q++){var y=$jscomp.global[t[q]];"function"===typeof y&&"function"!=typeof y.prototype[p]&&$jscomp.defineProperty(y.prototype,p,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return p},"es6",
"es3");$jscomp.iteratorPrototype=function(p){p={next:p};p[Symbol.iterator]=function(){return this};return p};$jscomp.iteratorFromArray=function(p,t){p instanceof String&&(p+="");var q=0,y=!1,z={next:function(){if(!y&&q<p.length){var F=q++;return{value:t(F,p[F]),done:!1}}y=!0;return{done:!0,value:void 0}}};z[Symbol.iterator]=function(){return z};return z};$jscomp.polyfill("Array.prototype.keys",function(p){return p?p:function(){return $jscomp.iteratorFromArray(this,function(t){return t})}},"es6","es3");
$jscomp.polyfill("Object.is",function(p){return p?p:function(t,q){return t===q?0!==t||1/t===1/q:t!==t&&q!==q}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(p){return p?p:function(t,q){var y=this;y instanceof String&&(y=String(y));var z=y.length;q=q||0;for(0>q&&(q=Math.max(q+z,0));q<z;q++){var F=y[q];if(F===t||Object.is(F,t))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(p,t,q){if(null==p)throw new TypeError("The 'this' value for String.prototype."+q+" must not be null or undefined");if(t instanceof RegExp)throw new TypeError("First argument to String.prototype."+q+" must not be a regular expression");return p+""};$jscomp.polyfill("String.prototype.includes",function(p){return p?p:function(t,q){return-1!==$jscomp.checkStringArgs(this,t,"includes").indexOf(t,q||0)}},"es6","es3");
$jscomp.findInternal=function(p,t,q){p instanceof String&&(p=String(p));for(var y=p.length,z=0;z<y;z++){var F=p[z];if(t.call(q,F,z,p))return{i:z,v:F}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(p){return p?p:function(t,q){return $jscomp.findInternal(this,t,q).v}},"es6","es3");
$jscomp.polyfill("Array.prototype.fill",function(p){return p?p:function(t,q,y){var z=this.length||0;0>q&&(q=Math.max(0,z+q));if(null==y||y>z)y=z;y=Number(y);0>y&&(y=Math.max(0,z+y));for(q=Number(q||0);q<y;q++)this[q]=t;return this}},"es6","es3");$jscomp.typedArrayFill=function(p){return p?p:Array.prototype.fill};$jscomp.polyfill("Int8Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Uint8Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");
$jscomp.polyfill("Uint8ClampedArray.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Int16Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Uint16Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Int32Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Uint32Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Float32Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");
$jscomp.polyfill("Float64Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");S3.gis.maps={};S3.gis.timeouts={};S3.gis.proj4326=new OpenLayers.Projection("EPSG:4326");OpenLayers.ImgPath=S3.Ap.concat("/static/img/gis/openlayers/");OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;OpenLayers.Util.onImageLoadErrorColor="transparent";OpenLayers.ProxyHost=S3.Ap.concat("/gis/proxy?url=");
S3.gis.yx=[4326,4258,31466,31467,31468,31469,2166,2167,2168,2036,2044,2045,2065,2081,2082,2083,2085,2086,2091,2092,2093,2096,2097,2098,2105,2106,2107,2108,2109,2110,2111,2112,2113,2114,2115,2116,2117,2118,2119,2120,2121,2122,2123,2124,2125,2126,2127,2128,2129,2130,2131,2132,2169,2170,2171,2172,2173,2174,2175,2176,2177,2178,2179,2180,2193,2199,2200,2206,2207,2208,2209,2210,2211,2212,2319,2320,2321,2322,2323,2324,2325,2326,2327,2328,2329,2330,2331,2332,2333,2334,2335,2336,2337,2338,2339,2340,2341,2342,
2343,2344,2345,2346,2347,2348,2349,2350,2351,2352,2353,2354,2355,2356,2357,2358,2359,2360,2361,2362,2363,2364,2365,2366,2367,2368,2369,2370,2371,2372,2373,2374,2375,2376,2377,2378,2379,2380,2381,2382,2383,2384,2385,2386,2387,2388,2389,2390,2391,2392,2393,2394,2395,2396,2397,2398,2399,2400,2401,2402,2403,2404,2405,2406,2407,2408,2409,2410,2411,2412,2413,2414,2415,2416,2417,2418,2419,2420,2421,2422,2423,2424,2425,2426,2427,2428,2429,2430,2431,2432,2433,2434,2435,2436,2437,2438,2439,2440,2441,2442,2443,
2444,2445,2446,2447,2448,2449,2450,2451,2452,2453,2454,2455,2456,2457,2458,2459,2460,2461,2462,2463,2464,2465,2466,2467,2468,2469,2470,2471,2472,2473,2474,2475,2476,2477,2478,2479,2480,2481,2482,2483,2484,2485,2486,2487,2488,2489,2490,2491,2492,2493,2494,2495,2496,2497,2498,2499,2500,2501,2502,2503,2504,2505,2506,2507,2508,2509,2510,2511,2512,2513,2514,2515,2516,2517,2518,2519,2520,2521,2522,2523,2524,2525,2526,2527,2528,2529,2530,2531,2532,2533,2534,2535,2536,2537,2538,2539,2540,2541,2542,2543,2544,
2545,2546,2547,2548,2549,2551,2552,2553,2554,2555,2556,2557,2558,2559,2560,2561,2562,2563,2564,2565,2566,2567,2568,2569,2570,2571,2572,2573,2574,2575,2576,2577,2578,2579,2580,2581,2582,2583,2584,2585,2586,2587,2588,2589,2590,2591,2592,2593,2594,2595,2596,2597,2598,2599,2600,2601,2602,2603,2604,2605,2606,2607,2608,2609,2610,2611,2612,2613,2614,2615,2616,2617,2618,2619,2620,2621,2622,2623,2624,2625,2626,2627,2628,2629,2630,2631,2632,2633,2634,2635,2636,2637,2638,2639,2640,2641,2642,2643,2644,2645,2646,
2647,2648,2649,2650,2651,2652,2653,2654,2655,2656,2657,2658,2659,2660,2661,2662,2663,2664,2665,2666,2667,2668,2669,2670,2671,2672,2673,2674,2675,2676,2677,2678,2679,2680,2681,2682,2683,2684,2685,2686,2687,2688,2689,2690,2691,2692,2693,2694,2695,2696,2697,2698,2699,2700,2701,2702,2703,2704,2705,2706,2707,2708,2709,2710,2711,2712,2713,2714,2715,2716,2717,2718,2719,2720,2721,2722,2723,2724,2725,2726,2727,2728,2729,2730,2731,2732,2733,2734,2735,2738,2739,2740,2741,2742,2743,2744,2745,2746,2747,2748,2749,
2750,2751,2752,2753,2754,2755,2756,2757,2758,2935,2936,2937,2938,2939,2940,2941,2953,2963,3006,3007,3008,3009,3010,3011,3012,3013,3014,3015,3016,3017,3018,3019,3020,3021,3022,3023,3024,3025,3026,3027,3028,3029,3030,3034,3035,3038,3039,3040,3041,3042,3043,3044,3045,3046,3047,3048,3049,3050,3051,3058,3059,3068,3114,3115,3116,3117,3118,3120,3126,3127,3128,3129,3130,3131,3132,3133,3134,3135,3136,3137,3138,3139,3140,3146,3147,3150,3151,3152,3300,3301,3328,3329,3330,3331,3332,3333,3334,3335,3346,3350,3351,
3352,3366,3386,3387,3388,3389,3390,3396,3397,3398,3399,3407,3414,3416,3764,3788,3789,3790,3791,3793,3795,3796,3819,3821,3823,3824,3833,3834,3835,3836,3837,3838,3839,3840,3841,3842,3843,3844,3845,3846,3847,3848,3849,3850,3851,3852,3854,3873,3874,3875,3876,3877,3878,3879,3880,3881,3882,3883,3884,3885,3888,3889,3906,3907,3908,3909,3910,3911,4001,4002,4003,4004,4005,4006,4007,4008,4009,4010,4011,4012,4013,4014,4015,4016,4017,4018,4019,4020,4021,4022,4023,4024,4025,4026,4027,4028,4029,4030,4031,4032,4033,
4034,4035,4036,4037,4038,4040,4041,4042,4043,4044,4045,4046,4047,4052,4053,4054,4055,4074,4075,4080,4081,4120,4121,4122,4123,4124,4125,4126,4127,4128,4129,4130,4131,4132,4133,4134,4135,4136,4137,4138,4139,4140,4141,4142,4143,4144,4145,4146,4147,4148,4149,4150,4151,4152,4153,4154,4155,4156,4157,4158,4159,4160,4161,4162,4163,4164,4165,4166,4167,4168,4169,4170,4171,4172,4173,4174,4175,4176,4178,4179,4180,4181,4182,4183,4184,4185,4188,4189,4190,4191,4192,4193,4194,4195,4196,4197,4198,4199,4200,4201,4202,
4203,4204,4205,4206,4207,4208,4209,4210,4211,4212,4213,4214,4215,4216,4218,4219,4220,4221,4222,4223,4224,4225,4226,4227,4228,4229,4230,4231,4232,4233,4234,4235,4236,4237,4238,4239,4240,4241,4242,4243,4244,4245,4246,4247,4248,4249,4250,4251,4252,4253,4254,4255,4256,4257,4259,4260,4261,4262,4263,4264,4265,4266,4267,4268,4269,4270,4271,4272,4273,4274,4275,4276,4277,4278,4279,4280,4281,4282,4283,4284,4285,4286,4287,4288,4289,4291,4292,4293,4294,4295,4296,4297,4298,4299,4300,4301,4302,4303,4304,4306,4307,
4308,4309,4310,4311,4312,4313,4314,4315,4316,4317,4318,4319,4322,4324,4327,4329,4339,4341,4343,4345,4347,4349,4351,4353,4355,4357,4359,4361,4363,4365,4367,4369,4371,4373,4375,4377,4379,4381,4383,4386,4388,4417,4434,4463,4466,4469,4470,4472,4475,4480,4482,4483,4490,4491,4492,4493,4494,4495,4496,4497,4498,4499,4500,4501,4502,4503,4504,4505,4506,4507,4508,4509,4510,4511,4512,4513,4514,4515,4516,4517,4518,4519,4520,4521,4522,4523,4524,4525,4526,4527,4528,4529,4530,4531,4532,4533,4534,4535,4536,4537,4538,
4539,4540,4541,4542,4543,4544,4545,4546,4547,4548,4549,4550,4551,4552,4553,4554,4555,4557,4558,4568,4569,4570,4571,4572,4573,4574,4575,4576,4577,4578,4579,4580,4581,4582,4583,4584,4585,4586,4587,4588,4589,4600,4601,4602,4603,4604,4605,4606,4607,4608,4609,4610,4611,4612,4613,4614,4615,4616,4617,4618,4619,4620,4621,4622,4623,4624,4625,4626,4627,4628,4629,4630,4631,4632,4633,4634,4635,4636,4637,4638,4639,4640,4641,4642,4643,4644,4645,4646,4652,4653,4654,4655,4656,4657,4658,4659,4660,4661,4662,4663,4664,
4665,4666,4667,4668,4669,4670,4671,4672,4673,4674,4675,4676,4677,4678,4679,4680,4681,4682,4683,4684,4685,4686,4687,4688,4689,4690,4691,4692,4693,4694,4695,4696,4697,4698,4699,4700,4701,4702,4703,4704,4705,4706,4707,4708,4709,4710,4711,4712,4713,4714,4715,4716,4717,4718,4719,4720,4721,4722,4723,4724,4725,4726,4727,4728,4729,4730,4731,4732,4733,4734,4735,4736,4737,4738,4739,4740,4741,4742,4743,4744,4745,4746,4747,4748,4749,4750,4751,4752,4753,4754,4755,4756,4757,4758,4759,4760,4761,4762,4763,4764,4765,
4766,4767,4768,4769,4770,4771,4772,4773,4774,4775,4776,4777,4778,4779,4780,4781,4782,4783,4784,4785,4786,4787,4788,4789,4790,4791,4792,4793,4794,4795,4796,4797,4798,4799,4800,4801,4802,4803,4804,4805,4806,4807,4808,4809,4810,4811,4812,4813,4814,4815,4816,4817,4818,4819,4820,4821,4822,4823,4824,4839,4855,4856,4857,4858,4859,4860,4861,4862,4863,4864,4865,4866,4867,4868,4869,4870,4871,4872,4873,4874,4875,4876,4877,4878,4879,4880,4883,4885,4887,4889,4891,4893,4895,4898,4900,4901,4902,4903,4904,4907,4909,
4921,4923,4925,4927,4929,4931,4933,4935,4937,4939,4941,4943,4945,4947,4949,4951,4953,4955,4957,4959,4961,4963,4965,4967,4969,4971,4973,4975,4977,4979,4981,4983,4985,4987,4989,4991,4993,4995,4997,4999,5012,5013,5017,5048,5105,5106,5107,5108,5109,5110,5111,5112,5113,5114,5115,5116,5117,5118,5119,5120,5121,5122,5123,5124,5125,5126,5127,5128,5129,5130,5132,5167,5168,5169,5170,5171,5172,5173,5174,5175,5176,5177,5178,5179,5180,5181,5182,5183,5184,5185,5186,5187,5188,5224,5228,5229,5233,5245,5246,5251,5252,
5253,5254,5255,5256,5257,5258,5259,5263,5264,5269,5270,5271,5272,5273,5274,5275,5801,5802,5803,5804,5808,5809,5810,5811,5812,5813,5814,5815,5816,20004,20005,20006,20007,20008,20009,20010,20011,20012,20013,20014,20015,20016,20017,20018,20019,20020,20021,20022,20023,20024,20025,20026,20027,20028,20029,20030,20031,20032,20064,20065,20066,20067,20068,20069,20070,20071,20072,20073,20074,20075,20076,20077,20078,20079,20080,20081,20082,20083,20084,20085,20086,20087,20088,20089,20090,20091,20092,21413,21414,
21415,21416,21417,21418,21419,21420,21421,21422,21423,21453,21454,21455,21456,21457,21458,21459,21460,21461,21462,21463,21473,21474,21475,21476,21477,21478,21479,21480,21481,21482,21483,21896,21897,21898,21899,22171,22172,22173,22174,22175,22176,22177,22181,22182,22183,22184,22185,22186,22187,22191,22192,22193,22194,22195,22196,22197,25884,27205,27206,27207,27208,27209,27210,27211,27212,27213,27214,27215,27216,27217,27218,27219,27220,27221,27222,27223,27224,27225,27226,27227,27228,27229,27230,27231,
27232,27391,27392,27393,27394,27395,27396,27397,27398,27492,28402,28403,28404,28405,28406,28407,28408,28409,28410,28411,28412,28413,28414,28415,28416,28417,28418,28419,28420,28421,28422,28423,28424,28425,28426,28427,28428,28429,28430,28431,28432,28462,28463,28464,28465,28466,28467,28468,28469,28470,28471,28472,28473,28474,28475,28476,28477,28478,28479,28480,28481,28482,28483,28484,28485,28486,28487,28488,28489,28490,28491,28492,29701,29702,30161,30162,30163,30164,30165,30166,30167,30168,30169,30170,
30171,30172,30173,30174,30175,30176,30177,30178,30179,30800,31251,31252,31253,31254,31255,31256,31257,31258,31259,31275,31276,31277,31278,31279,31281,31282,31283,31284,31285,31286,31287,31288,31289,31290,31700];
(function(){var p=new OpenLayers.Format.GeoJSON;p.ignoreExtraDims=!0;var t=S3.Ap.concat("/static/img/markers/"),q=S3.gis.proj4326;S3.gis.show_map=function(b,a){b||(b="default_map");void 0==a&&(a=S3.gis.options[b]);var c=a.projection,d=new OpenLayers.Projection("EPSG:"+c);a.projection_current=d;900913==c?(a.maxExtent=new OpenLayers.Bounds(-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7),a.maxResolution=156543.0339,a.units="m"):4326==c?(a.maxExtent=new OpenLayers.Bounds(-180,-90,180,90),a.maxResolution=
1.40625,a.units="degrees"):(c=a.maxExtent.split(","),a.maxExtent=new OpenLayers.Bounds(c[0],c[1],c[2],c[3]),a.maxResolution="auto");c=a.lat;var e=a.lon;if(void 0!=c&&void 0!=e)c=new OpenLayers.LonLat(e,c),c.transform(q,d);else{var g=OpenLayers.Bounds.fromArray(a.bbox);c=g.getCenterLonLat()}a.center=c;void 0===a.cluster_label&&(a.cluster_label=!0);var f=pa(b,a);f.Z_INDEX_BASE.Popup=900;var k=$("#"+b+"_panel");k.css("width","100%");$(window).resize(function(){var l=k.width();f.s3.mapWin.setWidth(l)});
a.renderTo=b+"_panel";qa(f);g&&(g.transform(q,d),f.zoomToExtent(g));f.events.on({movestart:function(){S3.hideAlerts("warning")}});$.when(y(b)).then(function(l){s3_debug(l);$.when(z(S3.gis.maps[b].baseLayer)).then(function(n){s3_debug(n);P(null,f);setTimeout(function m(){try{f.tileManager.tileQueue[f.id].length?setTimeout(m,250):f.s3.loaded=!0}catch(w){setTimeout(function(){f.s3.loaded=!0},5E4)}},1)},function(n){s3_debug(n)},function(n){T(b);s3_debug(n)})},function(l){s3_debug(l)},function(l){s3_debug(l)});
return f};var y=function(b){var a=new jQuery.Deferred;setTimeout(function d(){0==S3.gis.maps[b].s3.layers_loading.length?a.resolve("Layers loaded"):"pending"===a.state()&&(a.notify("waiting for Layers to load..."),setTimeout(d,250))},1);return a.promise()},z=function(b){if(void 0==b.numLoadingTiles)return!0;var a=new jQuery.Deferred;b.events.register("loadend","",function(){0==b.numLoadingTiles?a.resolve("Tiles loaded"):"pending"===a.state()&&a.reject("Tile loading failed")});return a.promise()},
F=function(b,a,c){var d=a.toArray();a=d[0];var e=d[1],g=d[2];d=d[3];c=c||.05;var f=(c-Math.abs(g-a))/2;0<f&&(a-=f,g+=f);f=(c-Math.abs(d-e))/2;0<f&&(e-=f,d+=f);c/=7;e=Math.max(e-c,-90);d=Math.min(d+c,90);a=new OpenLayers.Bounds(a-c,e,g+c,d);a.transform(q,b.getProjectionObject());b.zoomToExtent(a)};S3.gis.zoomBounds=F;var N=function(b){b=b.object;var a=b.getDataExtent();if(a){var c=b.map;a.transform(c.getProjectionObject(),q);F(c,a)}c=b.strategies;for(var d=0,e=c.length;d<e;d++)if(a=c[d],"OpenLayers.Strategy.AttributeCluster"==
a.CLASS_NAME){a.activate();a.features=b.features;a.recluster();break}b.visibility||b.setVisibility(!0);b.events.un({loadend:N})};S3.gis.search_layer_loadend=N;S3.gis.refreshLayer=function(b,a){var c=function(f){if(f&&f.s3_layer_id==b){var k=f.protocol.url,l=f.protocol.options;a&&a.length&&(k=S3.search.filterURL(k,a),k={data:[],type:"GET",url:k},S3.search.searchRewriteAjaxOptions(k,"form"),l.params=k.data,l.readWithPOST=!0,l.url=k.url);g=this.map;g.s3.mapWin.isVisible()&&(f.visibility||f.setVisibility(!0),
$.when(y(this.map_id)).then(function(){var n=f.strategies,h=n.length,m;for(m=0;m<h;m++){var w=n[m];if("OpenLayers.Strategy.AttributeCluster"==w.CLASS_NAME){w.deactivate();break}}for(var r=function(){f.events.on({loadend:N});f.events.un({loadstart:r})};f.map.popups.length;)f.map.removePopup(f.map.popups[0]);for(m=0;m<h;m++)if(w=n[m],"OpenLayers.Strategy.BBOX"==w.CLASS_NAME||"OpenLayers.Strategy.ZoomBBOX"==w.CLASS_NAME){w.bounds=null;f.events.on({loadstart:r});w.triggerRead();break}void 0!=g.s3.layerRefreshed&&
g.s3.layerRefreshed(f)},function(n){s3_debug(n)},function(n){s3_debug(n)}))}},d=S3.gis.maps,e;for(e in d){var g=d[e];g.layers.forEach(c,{map_id:e,map:g})}};var pa=function(b,a){var c=i18n.gis_name_map?!0:!1;var d=new OpenLayers.TileManager;c=new OpenLayers.Map("center",{controls:[],displayProjection:q,projection:a.projection_current,fallThrough:c,maxResolution:a.maxResolution,maxExtent:a.maxExtent,numZoomLevels:a.numZoomLevels,theme:null,tileManager:d,units:a.units});S3.gis.maps[b]=c;c.s3={};c.s3.id=
b;c.s3.options=a;c.s3.plugins=[];c.registerPlugin=function(e){e.map=this;this.s3.plugins.push(e)};ra(c);sa(c);return c},qa=function(b){var a=b.s3,c=a.options,d=new GeoExt.MapPanel({xtype:"gx_mappanel",map:b,center:c.center,zoom:c.zoom,plugins:[]});a.mapPanel=d;var e={};e.map=d;a.portal=e;if(c.legend||c.layers_wms){e=b.layers;for(var g=d.layers.data.items,f=0;f<e.length;f++)e[f].legendURL&&(g[f].data.legendURL=e[f].legendURL),e[f].legendTitle&&(g[f].data.title=e[f].legendTitle),e[f].queryable&&(g[f].data.queryable=
1)}e=ta(b);g=[e];c.wms_browser_url&&(f=ua(b))&&g.push(f);c.legend&&("float"==c.legend?f=va(b):(f=new GeoExt.LegendPanel({title:i18n.gis_legend,defaults:{},autoScroll:!0,collapsible:!0,collapseMode:"mini"}),g.push(f)),d.legendPanel=f);d=a.plugins;f=0;for(var k=d.length;f<k;++f)d[f].setup(b),d[f].addToMapWindow(g);a.west_panel_items=g;c.window?aa(b):ba(b);var l=a.westPanelContainer;l.fireEvent("collapse");window.setTimeout(function(){l.fireEvent("expand")},300);e.root.eachChild(function(){this.eachChild(function(){if(this.isLeaf())this.on("checkchange",
function(n,h){h||P(this.layer)});else this.eachChild(function(){if(this.isLeaf())this.on("checkchange",function(n,h){h||P(this.layer)})})})});Ext.QuickTips.init()},ba=function(b){var a=b.s3,c=a.options,d=ca(b);b=da(b);c=new Ext.Panel({renderTo:c.renderTo,autoWidth:!0,titleCollapse:!0,height:c.map_height,layout:"border",items:[d,b]});a.mapWin=c};S3.gis.addMapPanel=ba;var aa=function(b){var a=b.s3,c=a.options,d=ca(b),e=da(b);d=new Ext.Window({cls:"gis-map-window",collapsible:!1,constrain:!0,closable:!c.windowNotClosable,
closeAction:"hide",autoScroll:!0,maximizable:c.maximizable,titleCollapse:!1,height:c.map_height,width:c.map_width,layout:"border",items:[d,e]});d.on("beforehide",function(g){g.maximized&&g.restore()});d.on("move",function(){b.events.clearMouseCache()});d.on("resize",function(g,f,k){842>k?$("#"+a.id).removeClass("a0 a1 a2 a3").addClass("a4"):1191>k?$("#"+a.id).removeClass("a0 a1 a2 a4").addClass("a3"):1684>k?$("#"+a.id).removeClass("a0 a1 a3 a4").addClass("a2"):2384>k?$("#"+a.id).removeClass("a0 a2 a3 a4").addClass("a1"):
$("#"+a.id).removeClass("a1 a2 a3 a4").addClass("a0")});c.windowHide||(d.show(),d.maximize());a.mapWin=d};S3.gis.addMapWindow=aa;var ca=function(b){b=b.s3;var a=b.options.west_collapsed||!1,c=new Ext.Panel({header:!1,border:!1,split:!0,items:b.west_panel_items});a=new Ext.Panel({cls:"gis_west",region:"west",header:!1,border:!0,autoWidth:Ext.isChrome?!1:!0,width:250,collapsible:!0,collapseMode:"mini",collapsed:a,items:[c]});return b.westPanelContainer=a},da=function(b){var a=b.s3,c=a.options;if(c.toolbar)var d=
wa(b);else{if(c.draw_feature){var e="active"==c.draw_feature;U(b,null,e)}c.draw_line&&(e="active"==c.draw_line,V(b,null,e));c.draw_polygon&&(e="active"==c.draw_polygon,W(b,null,e,!0));c.draw_circle&&(e="active"==c.draw_circle,X(b,null,e));e=b.s3;var g=e.id;if(!$("#"+g+" .layer_throbber").length){var f='<div class="layer_throbber float hide';e.options.save&&(f+=" save");f+='"></div>';$("#"+g).append(f)}}"float"==c.save&&xa(b);b=new Ext.Panel({layout:"card",region:"center",cls:"mappnlcntr",defaults:{border:!1},
items:[a.mapPanel],activeItem:0,tbar:d,scope:this});return a.mapPanelContainer=b},ta=function(b){GeoExt.tree.LayerNodeUIS3=Ext.extend(GeoExt.tree.LayerNodeUI,{onClick:function(x){if(x.getTarget(".x-tree-node-cb",1)){var E=this.node,G=this.node.attributes,J=G.checkedGroup;J&&"baselayer"!==J?(J=!G.checked,G.checked=J,E.ui.checkbox.checked=J,E.layer.setVisibility(J),this.enforceOneVisible()):this.toggleCheck(this.isChecked())}else GeoExt.tree.LayerNodeUI.superclass.onClick.apply(this,arguments)},enforceOneVisible:function(){var x=
this.node.attributes,E=x.checkedGroup;if(E&&"baselayer"!==E){var G=this.node.layer,J=this.node.getOwnerTree().getChecked();Ext.each(J,function(K){var R=K.layer;K.hidden||K.attributes.checkedGroup!==E||R!=G&&x.checked&&R.setVisibility(!1)})}}});GeoExt.tree.LayerNodeS3=Ext.extend(GeoExt.tree.LayerNode,{constructor:function(){this.defaultUI=GeoExt.tree.LayerNodeUIS3;GeoExt.tree.LayerNodeS3.superclass.constructor.apply(this,arguments)}});Ext.tree.TreePanel.nodeTypes.gx_layer=GeoExt.tree.LayerNodeS3;var a=
b.s3,c=a.options;var d=c.hide_base?!1:!0;var e=c.hide_overlays?!1:!0;var g=c.folders_closed?!1:!0;var f=c.folders_radio?!0:!1;var k=c.wms_browser_url||c.legend&&"float"!=c.legend?!0:!1;var l=a.mapPanel.layers,n=[],h={click:function(x){var E=x.attributes;if("baselayer"==E.checkedGroup)x.ui.toggleCheck(!x.ui.isChecked());else{var G=!E.checked;E.checked=G;x.ui.checkbox.checked=G;x.layer.setVisibility(G)}}},m=function(){var x=a.westPanelContainer;x.fireEvent("collapse");window.setTimeout(function(){x.fireEvent("expand")},
300)},w={collapse:function(){m()},expand:function(){m()}};d&&n.push({text:i18n.gis_base_layers,nodeType:"gx_baselayercontainer",layerStore:l,loader:{baseAttrs:{listeners:h},filter:function(x){x=x.getLayer();return!0===x.displayInLayerSwitcher&&!0===x.isBaseLayer&&(void 0===x.dir||""===x.dir)}},leaf:!1,listeners:w,singleClickExpand:!0,expanded:g});e&&n.push({text:i18n.gis_overlays,nodeType:"gx_overlaylayercontainer",layerStore:l,loader:{baseAttrs:{listeners:h},filter:function(x){x=x.getLayer();return!0===
x.displayInLayerSwitcher&&!1===x.isBaseLayer&&(void 0===x.dir||""===x.dir)}},leaf:!1,listeners:w,singleClickExpand:!0,expanded:g});e=b.s3.dirs;var r=e.length;if(r){GeoExt.tree.LayerLoaderS3=function(x){Ext.apply(this,x);GeoExt.tree.LayerLoaderS3.superclass.constructor.call(this)};Ext.extend(GeoExt.tree.LayerLoaderS3,GeoExt.tree.LayerLoader,{load:function(x,E){if(this.fireEvent("beforeload",this,x)){for(this.removeStoreHandlers();x.firstChild;)x.removeChild(x.firstChild);this.uiProviders||(this.uiProviders=
x.getOwnerTree().getLoader().uiProviders);this.store||(this.store=GeoExt.MapPanel.guess().layers);this.store.each(function(ya){this.addLayerNode(x,ya)},this);this.addStoreHandlers(x);var G=x.attributes.children,J=G.length;if(J)for(var K,R,Y=0;Y<J;Y++)K=G[Y],K=new Ext.tree.TreePanel.nodeTypes[K.nodeType](K),(R=x.item(0))?x.insertBefore(K,R):x.appendChild(K);"function"==typeof E&&E();this.fireEvent("load",this,x)}}});d={};var v,A,C;for(v=0;v<r;v++){var u=e[v];var I=u.split("/");var H=I.length;for(A=
0;A<H;A++){var B=0==A?d:B[D];var D=I[A];B.hasOwnProperty(D)||(B[D]={})}}for(u in d){D=d[u];B=[];for(C in D)D={listeners:h},f&&(D.checkedGroup=C),D=new GeoExt.tree.LayerLoaderS3({baseAttrs:D,filter:function(x,E){return function(G){if("undefined"!==G.data.layer.dir)return G.data.layer.dir===x+"/"+E}}(u,C)}),D={text:C,nodeType:"gx_layercontainer",layerStore:l,children:[],loader:D,leaf:!1,listeners:w,singleClickExpand:!0,expanded:g},B.push(D);D={listeners:h};f&&(D.checkedGroup=u);D=new GeoExt.tree.LayerLoaderS3({baseAttrs:D,
filter:function(x){return function(E){if("undefined"!==E.data.layer.dir)return E.data.layer.dir===x}}(u)});D={text:u,nodeType:"gx_layercontainer",layerStore:l,children:B,loader:D,leaf:!1,listeners:w,singleClickExpand:!0,expanded:g};n.push(D)}}g=new Ext.tree.AsyncTreeNode({expanded:!0,children:n});f=(c=c.clearlayers&"toolbar"!=c.clearlayers)||i18n.gis_properties||i18n.gis_uploadlayer?new Ext.Toolbar:null;k=new Ext.tree.TreePanel({title:i18n.gis_layers,loaderloader:new Ext.tree.TreeLoader({applyLoader:!1}),
root:g,rootVisible:!1,split:!0,collapsible:k,collapseMode:"mini",lines:!1,tbar:f,enableDD:!1});new Ext.tree.TreeSorter(k,{sortType:function(x,E){return"gx_baselayercontainer"==E.attributes.nodeType?" ":"gx_overlaylayercontainer"==E.attributes.nodeType?"!":E.text}});i18n.gis_uploadlayer&&za(b,k);i18n.gis_properties&&Aa(b,k);c&&ea(b,k.getTopToolbar());return k},ua=function(b){var a=b.s3.options,c=new Ext.tree.AsyncTreeNode({expanded:!0,loader:new GeoExt.tree.WMSCapabilitiesLoader({url:OpenLayers.ProxyHost+
a.wms_browser_url,layerOptions:{buffer:1,singleTile:!1,ratio:1,wrapDateLine:!0},layerParams:{TRANSPARENT:"TRUE"},createNode:function(d){d.checked=d.leaf?!1:void 0;return GeoExt.tree.WMSCapabilitiesLoader.prototype.createNode.apply(this,[d])}})});return new Ext.tree.TreePanel({title:a.wms_browser_name,root:c,rootVisible:!1,split:!0,autoScroll:!0,collapsible:!0,collapseMode:"mini",lines:!1,listeners:{checkchange:function(d,e){!0===e?b.addLayer(d.attributes.layer):b.removeLayer(d.attributes.layer)}}})},
T=function(b){$("#"+b+" .layer_throbber").show().removeClass("hide")},P=function(b,a){if(b){var c=b.map.s3;a=c.layers_loading;a.pop(b.s3_layer_id)}else c=a.s3,a=a.s3.layers_loading;0===a.length&&$("#"+c.id+" .layer_throbber").hide().addClass("hide")},L=function(b){var a=b.object;b=a.map.s3;T(b.id);a=a.s3_layer_id;b=b.layers_loading;-1==b.indexOf(a)&&b.push(a)},M=function(b){var a=b.object;b=b.response;if(b&&b.priv){var c=b.priv;try{var d=JSON.parse(c.responseText).s3}catch(v){}if(void 0!=d){var e=
a.strategies,g=e.length;if(void 0!=d.level)for(b=0;b<g;b++){var f=e[b];if("OpenLayers.Strategy.ZoomBBOX"==f.CLASS_NAME){f.level=d.level;break}}if(void 0!=d.style){var k=!0;d=d.style;b=Q(a.map,d);var l=b[1];a.legendURL=l;a.styleMap=b[0];a.s3_popup_format=d.popup_format;a.s3_style=d.style;a.s3_url_format=d.url_format;for(b=0;b<g;b++)if(f=e[b],"OpenLayers.Strategy.AttributeCluster"==f.CLASS_NAME){b=2;void 0!==d.cluster_threshold&&(b=d.cluster_threshold);if(b)d=d.cluster_distance||20,f.active&&d==f.distance&&
b==f.threshold||(f.distance=d,f.threshold=b,f.activate(),f.features=a.features,f.recluster());else if(f.active){f.deactivate();f=a.features;d=f.length;var n=[],h=[];for(b=0;b<d;b++)if(f[b].cluster){g=f[b];var m=g.cluster;var w=m.length;for(e=0;e<w;e++)h.push(m[e]);n.push(g)}a.removeFeatures(n);a.addFeatures(h)}break}}}P(a);if(509==c.status)S3.showAlert(i18n.gis_too_many_features,"warning");else if((b=a.s3_style)&&"[object Array]"===Object.prototype.toString.call(b)&&1==b.length){var r=Ba(a);k=!0}if(void 0!=
k){f=a.features;d=f.length;for(b=0;b<d;b++)a.drawFeature(f[b]);if(k=a.map.s3.mapPanel.legendPanel)for(c=k.items.items,f=a.s3_layer_id,d=c.length,b=0;b<d;b++)if(a=c[b],a.layer&&a.layer.s3_layer_id==f){void 0!=r?"gx_vectorlegend"==a.xtype?(a.rules=r,a.update()):(r=a.layerRecord,k.removeLegend(r),k.addLegend(r,b)):void 0!=l&&("gx_urllegend"==a.xtype?(a.layerRecord.data.legendURL=l,a.update()):(r=a.layerRecord,r.data.legendURL=l,k.removeLegend(r),k.addLegend(r,b)));break}}}else P(a)},Ba=function(b){var a=
b.s3_style[0],c=a.prop,d=b.features,e,g=d.length,f=[];for(e=0;e<g;e++)f.push(d[e].attributes[c]);f.sort(function(m,w){return m-w});var k={};$.each(f,function(){k[this]=1});c=Object.keys(k).length;if(5<=c){c=5;var l=["ffffb2","fecc5c","fd8d3c","f03b20","bd0026"]}else 4==c?l=["ffffb2","fecc5c","fd8d3c","e31a1c"]:3==c?l=["ffeda0","feb24c","f03b20"]:2==c?l=["ffeda0","f03b20"]:1==c&&(l=["feb24c"]);var n=Math.round(g/c),h=n;d=[f[0]];for(e=1;e<c;e++)d[e]=f[h]||f[g-1],h+=n;d.push(f[g-1]);h=[];for(e=0;e<c;e++)g=
d[e],f=d[e+1],n=$.extend({},a),n.fill=l[e],n.low=g,n.high=f,n.label=g==f?g.toString():g+" - "+f,h.push(n);a=fa({style:h,cluster_threshold:0,opacity:.9});return b.styleMap.styles["default"].rules=a},S=function(b){ha(b.object.map)},ra=function(b){var a=b.s3,c=a.options;a.dirs=[];a.layers_loading=[];a.layers_nopopups=[];if(c.layers_osm){var d=c.layers_osm;for(a=d.length;0<a;a--)Ca(b,d[a-1])}try{c.Google&&Da(b)}catch(g){}c.Bing&&Ea(b);if(c.layers_tms)for(d=c.layers_tms,a=d.length;0<a;a--)Fa(b,d[a-1]);
if(c.layers_wms)for(d=c.layers_wms,a=d.length;0<a;a--)Ga(b,d[a-1]);if(c.layers_xyz)for(d=c.layers_xyz,a=d.length;0<a;a--)Ha(b,d[a-1]);c.EmptyLayer&&(a=new OpenLayers.Layer(c.EmptyLayer.name,{isBaseLayer:!0,displayInLayerSwitcher:!0,s3_layer_id:c.EmptyLayer.id,s3_layer_type:"empty"}),b.addLayer(a),c.EmptyLayer.base&&b.setBaseLayer(a));if(c.layers_js)for(d=c.layers_js,a=d.length;0<a;a--)eval(b,d[a-1]);if(c.layers_theme)for(d=c.layers_theme,a=d.length;0<a;a--)O(b,d[a-1]);if(c.layers_geojson)for(d=c.layers_geojson,
a=d.length;0<a;a--)O(b,d[a-1]);if(c.layers_gpx)for(d=c.layers_gpx,a=d.length;0<a;a--)Ia(b,d[a-1]);if(c.layers_arcrest)for(d=c.layers_arcrest,a=d.length;0<a;a--)Ja(b,d[a-1]);c.CoordinateGrid&&Ka(b);if(c.layers_georss)for(d=c.layers_georss,a=d.length;0<a;a--)O(b,d[a-1]);if(c.layers_kml)for(d=c.layers_kml,a=d.length;0<a;a--)La(b,d[a-1]);c.layers_openweathermap&&Ma(b);if(c.layers_shapefile)for(d=c.layers_shapefile,a=d.length;0<a;a--)O(b,d[a-1]);if(c.layers_wfs)for(d=c.layers_wfs,a=d.length;0<a;a--)Na(b,
d[a-1]);if(c.feature_queries)for(d=c.feature_queries,a=d.length;0<a;a--)O(b,d[a-1]);if(c.feature_resources)for(d=c.feature_resources,a=d.length;0<a;a--)O(b,d[a-1]);if(c.layers_feature)for(d=c.layers_feature,a=d.length;0<a;a--)O(b,d[a-1]);if(c.features||c.draw_feature||c.draw_polygon||c.draw_circle||navigator.geolocation)var e=Oa(b);if(c.features)for(c=c.features,b=b.getProjectionObject(),a=0;a<c.length;a++)d=p.parseFeature(c[a]),d.geometry.transform(q,b),e.addFeatures([d])},Ja=function(b,a){var c=
a.name,d=[a.url];var e=void 0!=a.layers?a.layers.join():0;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,b.s3.dirs)&&b.s3.dirs.push(g)}else g="";var f=void 0!=a.base?a.base:!1;var k=void 0!=a.format?a.format:"png";var l=void 0!=a.transparent?a.transparent:!0;var n=void 0!=a.visibility?a.visibility:!0;c=new OpenLayers.Layer.ArcGIS93Rest(c,d,{layers:"show:"+e,isBaseLayer:f,transparent:l,format:k,dir:g,s3_layer_id:a.id,s3_layer_type:"arcrest"});c.setVisibility(n);b.addLayer(c);a._base&&b.setBaseLayer(c)},
Ea=function(b){var a=b.s3.options.Bing,c=a.ApiKey;if(a.Aerial){var d=new OpenLayers.Layer.Bing({key:c,type:"Aerial",name:a.Aerial.name,s3_layer_id:a.Aerial.id,s3_layer_type:"bing"});b.addLayer(d);"aerial"==a.Base&&b.setBaseLayer(d)}a.Road&&(d=new OpenLayers.Layer.Bing({key:c,type:"Road",name:a.Road.name,s3_layer_id:a.Road.id,s3_layer_type:"bing"}),b.addLayer(d),"road"==a.Base&&b.setBaseLayer(d));a.Hybrid&&(d=new OpenLayers.Layer.Bing({key:c,type:"AerialWithLabels",name:a.Hybrid.name,s3_layer_id:a.Hybrid.id,
s3_layer_type:"bing"}),b.addLayer(d),"hybrid"==a.Base&&b.setBaseLayer(d))},Ka=function(b){var a=b.s3.options.CoordinateGrid;a=new OpenLayers.Control.Graticule({layerName:a.name,visible:a.visibility});b.addControl(a)},Oa=function(b){var a=b.s3.options;if(a.draw_feature)var c=a.marker_default;if(a.draft_style)var d=a.draft_style;c=Q(b,{marker:c,style:d,opacity:.9});c=new OpenLayers.Layer.Vector(i18n.gis_draft_layer,{displayInLayerSwitcher:!1,legendURL:c[1],styleMap:c[0]});c.setVisibility(!0);b.addLayer(c);
return b.s3.draftLayer=c},O=function(b,a){var c=b.s3,d=a.name;a.no_popups&&c.layers_nopopups.push(d);var e=a.url;var g=-1!==e.indexOf("$search")?!0:!1;var f=void 0!=a.refresh?a.refresh:900;if(void 0!=a.dir){var k=a.dir;-1==$.inArray(k,c.dirs)&&c.dirs.push(k)}else k="";c=void 0!=a.visibility?a.visibility:!0;var l=void 0!=a.cluster_attribute?a.cluster_attribute:"colour";var n=void 0!=a.cluster_distance?a.cluster_distance:20;var h=void 0!=a.cluster_threshold?a.cluster_threshold:2;var m=void 0!=a.projection?
a.projection:4326;m=4326==m?q:new OpenLayers.Projection("EPSG:"+m);var w=void 0!=a.type?a.type:"feature";var r='<div class="gis_layer_legend"><div class="gis_legend_title">'+d+"</div>";void 0!=a.desc&&(r+='<div class="gis_legend_desc">'+a.desc+"</div>");if(void 0!=a.src||void 0!=a.src_url){var v='<div class="gis_legend_src">';void 0!=a.src_url?(v+='<a href="'+a.src_url+'" target="_blank">',v=void 0!=a.src?v+a.src:v+a.src_url,v+="</a>"):v+=a.src;r+=v+"</div>"}r+="</div>";var A=Q(b,a);v=A[0];A=A[1];
var C=[new OpenLayers.Strategy.ZoomBBOX({ratio:1.5})];f&&C.push(new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*f}));(h||a.cluster)&&C.push(new OpenLayers.Strategy.AttributeCluster({attribute:l,distance:n,threshold:h}));d=new OpenLayers.Layer.Vector(d,{dir:k,projection:m,protocol:new OpenLayers.Protocol.HTTP({url:e,format:p,readWithPOST:g}),legendURL:A,strategies:C,styleMap:v,s3_layer_id:a.id,s3_layer_type:w,s3_style:a.style,s3_url_format:a.url_format});d.legendTitle=r;void 0!=a.popup_format&&
(d.s3_popup_format=a.popup_format);d.setVisibility(c);d.events.on({loadstart:L,loadend:M,visibilitychanged:S});b.addLayer(d)},Da=function(b){var a=b.s3.options.Google;if(a.MapMaker||a.MapMakerHybrid){if(a.Satellite){var c=new OpenLayers.Layer.Google(a.Satellite.name,{type:G_SATELLITE_MAP,sphericalMercator:!0,s3_layer_id:a.Satellite.id,s3_layer_type:"google"});b.addLayer(c);"satellite"==a.Base&&b.setBaseLayer(c)}a.Maps&&(c=new OpenLayers.Layer.Google(a.Maps.name,{type:G_NORMAL_MAP,sphericalMercator:!0,
s3_layer_id:a.Maps.id,s3_layer_type:"google"}),b.addLayer(c),"maps"==a.Base&&b.setBaseLayer(c));a.Hybrid&&(c=new OpenLayers.Layer.Google(a.Hybrid.name,{type:G_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),b.addLayer(c),"maps"==a.Base&&b.setBaseLayer(c));a.Terrain&&(c=new OpenLayers.Layer.Google(a.Terrain.name,{type:G_PHYSICAL_MAP,sphericalMercator:!0,s3_layer_id:a.Terrain.id,s3_layer_type:"google"}),b.addLayer(c),"terrain"==a.Base&&b.setBaseLayer(c));a.MapMaker&&
(c=new OpenLayers.Layer.Google(a.MapMaker.name,{type:G_MAPMAKER_NORMAL_MAP,sphericalMercator:!0,s3_layer_id:c.id,s3_layer_type:"google"}),b.addLayer(c),"mapmaker"==a.Base&&b.setBaseLayer(c));a.MapMakerHybrid&&(c=new OpenLayers.Layer.Google(a.MapMakerHybrid.name,{type:G_MAPMAKER_HYBRID_MAP,sphericalMercator:!0,s3_layer_id:c.id,s3_layer_type:"google"}),b.addLayer(c),"mapmakerhybrid"==a.Base&&b.setBaseLayer(c))}else a.Satellite&&(c=new OpenLayers.Layer.Google(a.Satellite.name,{type:"satellite",numZoomLevels:22,
s3_layer_id:a.Satellite.id,s3_layer_type:"google"}),b.addLayer(c),"satellite"==a.Base&&b.setBaseLayer(c)),a.Maps&&(c=new OpenLayers.Layer.Google(a.Maps.name,{numZoomLevels:20,s3_layer_id:a.Maps.id,s3_layer_type:"google"}),b.addLayer(c),"maps"==a.Base&&b.setBaseLayer(c)),a.Hybrid&&(c=new OpenLayers.Layer.Google(a.Hybrid.name,{type:"hybrid",numZoomLevels:20,s3_layer_id:a.Hybrid.id,s3_layer_type:"google"}),b.addLayer(c),"hybrid"==a.Base&&b.setBaseLayer(c)),a.Terrain&&(c=new OpenLayers.Layer.Google(a.Terrain.name,
{type:"terrain",s3_layer_id:a.Terrain.id,s3_layer_type:"google"}),b.addLayer(c),"terrain"==a.Base&&b.setBaseLayer(c))},Ia=function(b,a){var c=a.marker,d=a.name,e=a.url,g=c.h,f=t+c.i,k=c.w;var l=void 0!=a.waypoints?a.waypoints:!0;var n=void 0!=a.tracks?a.tracks:!0;var h=void 0!=a.routes?a.routes:!0;c=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var m=a.dir;-1==$.inArray(m,b.s3.dirs)&&b.s3.dirs.push(m)}else m="";var w=void 0!=a.opacity?a.opacity:1;var r=void 0!=a.cluster_distance?a.cluster_distance:
20;var v=void 0!=a.cluster_threshold?a.cluster_threshold:2;var A=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);l?(A.graphicOpacity=w,A.graphicWidth=k,A.graphicHeight=g,A.graphicXOffset=-(k/2),A.graphicYOffset=-g,A.externalGraphic=f):A.externalGraphic="";A.strokeColor="blue";A.strokeWidth=6;A.strokeOpacity=w;a=new OpenLayers.Layer.Vector(d,{dir:m,projection:q,strategies:[new OpenLayers.Strategy.Fixed,new OpenLayers.Strategy.Cluster({distance:r,threshold:v})],legendURL:f,s3_layer_id:a.id,
s3_layer_type:"gpx",style:A,protocol:new OpenLayers.Protocol.HTTP({url:e,format:new OpenLayers.Format.GPX({extractAttributes:!0,extractWaypoints:l,extractTracks:n,extractRoutes:h})})});a.setVisibility(c);a.events.on({loadstart:L,loadend:M,visibilitychanged:S});b.addLayer(a)},La=function(b,a){var c=a.name;var d=b.s3;var e=a.url;var g=void 0!=a.title?a.title:"name";var f=void 0!=a.body?a.body:"description";var k=void 0!=a.refresh?a.refresh:900;var l=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var n=
a.dir;-1==$.inArray(n,d.dirs)&&d.dirs.push(n)}else n="";d=void 0!=a.cluster_distance?a.cluster_distance:20;var h=void 0!=a.cluster_threshold?a.cluster_threshold:2;var m=Q(b,a)[0],w=new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2}),r=[new OpenLayers.Strategy.Fixed];k&&r.push(new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*k}));h&&r.push(new OpenLayers.Strategy.Cluster({distance:d,threshold:h}));a=new OpenLayers.Layer.Vector(c,{dir:n,projection:q,protocol:new OpenLayers.Protocol.HTTP({url:e,
format:w}),strategies:r,styleMap:m,s3_layer_id:a.id,s3_layer_type:"kml",s3_style:a.style});a.title=g;a.body=f;a.setVisibility(l);a.events.on({loadstart:L,loadend:M,visibilitychanged:S});b.addLayer(a)},Ca=function(b,a){var c=a.name,d=[a.url1];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var g=a.dir;-1==$.inArray(g,b.s3.dirs)&&b.s3.dirs.push(g)}else g="";g=new OpenLayers.Layer.TMS(c,d,{dir:g,type:"png",getURL:Pa,displayOutsideMaxExtent:!0,
numZoomLevels:void 0!=a.zoomLevels?a.zoomLevels:19,isBaseLayer:void 0!=a.base?a.base:!0,s3_layer_id:a.id,s3_layer_type:"openstreetmap"});void 0!=a.attribution&&(g.attribution=a.attribution);g.setVisibility(e);g.events.on({loadstart:L,loadend:M});b.addLayer(g);a._base&&b.setBaseLayer(g)},Pa=function(b){var a=this.map.getResolution(),c=Math.round((b.left-this.maxExtent.left)/(a*this.tileSize.w));b=Math.round((this.maxExtent.top-b.top)/(a*this.tileSize.h));a=this.map.getZoom();var d=Math.pow(2,a);if(0>
b||b>=d)return OpenLayers.Util.getImagesLocation()+"404.png";c=a+"/"+(c%d+d)%d+"/"+b+"."+this.type;b=this.url;b instanceof Array&&(b=this.selectUrl(c,b));return b+c},Ma=function(b){var a=S3.gis.openweathermap,c=b.s3.options.layers_openweathermap,d;for(d in c){var e=new OpenLayers.Layer.XYZ(c[d].name,"https://tile.openweathermap.org/map/"+d+"/${z}/${x}/${y}.png?appid="+a,{dir:c[d].dir,isBaseLayer:!1,s3_layer_id:c[d].id,s3_layer_type:"openweathermap",type:"png"});e.setVisibility(c[d].visibility);e.events.on({loadstart:L,
loadend:M});b.addLayer(e)}},Fa=function(b,a){var c=a.name,d=[a.url];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=a.layername;var g=void 0!=a.zoomLevels?a.zoomLevels:19;if(void 0!=a.dir){var f=a.dir;-1==$.inArray(f,b.s3.dirs)&&b.s3.dirs.push(f)}else f="";f=new OpenLayers.Layer.TMS(c,d,{dir:f,s3_layer_id:a.id,s3_layer_type:"tms",layername:e,type:void 0!=a.format?a.format:"png",numZoomLevels:g});void 0!=a.attribution&&(f.attribution=a.attribution);f.events.on({loadstart:L,loadend:M});
b.addLayer(f);a._base&&b.setBaseLayer(f)},Na=function(b,a){var c=a.featureType,d,e=a.name,g=a.title,f=a.url;void 0!=a.username&&void 0!=a.password&&(f=f.replace("://","://"+a.username+":"+a.password+"@"));var k=void 0!=a.featureNS?a.featureNS:null;if(void 0!=a.schema)var l=a.schema;var n=void 0!=a.version?a.version:"1.1.0";var h=void 0!=a.geometryName?a.geometryName:"the_geom";var m=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var w=a.dir;-1==$.inArray(w,b.s3.dirs)&&b.s3.dirs.push(w)}else w=
"";var r=void 0!=a.cluster_attribute?a.cluster_attribute:"colour";var v=void 0!=a.cluster_distance?a.cluster_distance:20;var A=void 0!=a.cluster_threshold?a.cluster_threshold:2;var C=void 0!=a.refresh?a.refresh:!1;var u=[new OpenLayers.Strategy.BBOX({ratio:1.5})];C&&u.push(new OpenLayers.Strategy.Refresh({force:!0,interval:1E3*C}));A&&u.push(new OpenLayers.Strategy.AttributeCluster({attribute:r,distance:v,threshold:A}));r=void 0!=a.projection?a.projection:4326;"1.0.0"==n?v="EPSG:"+r:(v="urn:ogc:def:crs:EPSG::"+
r,S3.gis.yx.includes(r)&&(d=new OpenLayers.Format.WFST({version:n,featureType:c,featureNS:k,featurePrefix:"feature",geometryName:h,srsName:v,schema:l,xy:!1})));c=new OpenLayers.Protocol.WFS({url:f,version:n,featureType:c,featureNS:k,format:d,geometryName:h,srsName:v,schema:l});k='<div class="gis_layer_legend"><div class="gis_legend_title">'+e+"</div>";void 0!=a.desc&&(k+='<div class="gis_legend_desc">'+a.desc+"</div>");if(void 0!=a.src||void 0!=a.src_url)d='<div class="gis_legend_src">',void 0!=a.src_url?
(d+='<a href="'+a.src_url+'" target="_blank">',d=void 0!=a.src?d+a.src:d+a.src_url,d+="</a>"):d+=a.src,k+=d+"</div>";k+="</div>";h=Q(b,a);d=h[0];h=h[1];r=4326==r?q:new OpenLayers.Projection("EPSG:"+r);a=new OpenLayers.Layer.Vector(e,{maxFeatures:1E3,strategies:u,dir:w,legendURL:h,projection:r,protocol:c,styleMap:d,s3_layer_id:a.id,s3_layer_type:"wfs",s3_style:a.style});a.legendTitle=k;a.title=g;a.setVisibility(m);a.events.on({loadstart:L,loadend:M,visibilitychanged:S});b.addLayer(a)},Ga=function(b,
a){var c=a.name,d=a.url;a.username&&a.password&&(d=d.replace("://","://"+a.username+":"+a.password+"@"));var e=a.layers;var g=void 0!=a.visibility?a.visibility:!0;if(void 0!=a.dir){var f=a.dir;-1==$.inArray(f,b.s3.dirs)&&b.s3.dirs.push(f)}else f="";var k=void 0!=a.base?a.base:!1;var l=void 0!=a.transparent?a.transparent:!0;var n=void 0!=a.format?a.format:"image/png";var h=void 0!=a.version?a.version:"1.1.1";var m=a.map?a.map:"";var w=a.style?a.style:"";var r=void 0!=a.bgcolor?"0x"+a.bgcolor:"";var v=
void 0!=a.buffer?a.buffer:0;var A=void 0!=a.tiled?a.tiled:!1;var C=void 0!=a.singleTile?a.singleTile:!1;var u=void 0!=a.opacity?a.opacity:1;var I=void 0!=a.queryable?a.queryable:1;var H='<div class="gis_layer_legend"><div class="gis_legend_title">'+c+"</div>";void 0!=a.desc&&(H+='<div class="gis_legend_desc">'+a.desc+"</div>");if(b.s3.options.metadata){if(void 0!=a.post_id)if(i18n.gis_metadata){var B=i18n.gis_metadata;var D=S3.Ap.concat("/cms/page/"+a.post_id)}else B=i18n.gis_metadata_edit,D=S3.Ap.concat("/cms/post/"+
a.post_id+"/update?layer_id="+a.id);else i18n.gis_metadata_create&&(B=i18n.gis_metadata_create,D=S3.Ap.concat("/cms/post/create?layer_id="+a.id));B&&(H+='<div class="gis_legend_src"><a href="'+D+'" target="_blank">'+B+"</a></div>")}else if(void 0!=a.src||void 0!=a.src_url)B='<div class="gis_legend_src">',void 0!=a.src_url?(B+='<a href="'+a.src_url+'" target="_blank">',B=void 0!=a.src?B+a.src:B+a.src_url,B+="</a>"):B+=a.src,H+=B+"</div>";H+="</div>";if(void 0!=a.legendURL)var x=a.legendURL;f=new OpenLayers.Layer.WMS(c,
d,{layers:e,transparent:l},{dir:f,isBaseLayer:k,singleTile:C,wrapDateLine:!0,s3_layer_id:a.id,s3_layer_type:"wms",queryable:I,visibility:g});m&&(f.params.MAP=m);n&&(f.params.FORMAT=n);h&&(f.params.VERSION=h);w&&(f.params.STYLES=w);r&&(f.params.BGCOLOR=r);A&&(f.params.TILESORIGIN=[b.maxExtent.left,b.maxExtent.bottom]);k||(f.opacity=u,f.buffer=v?v:0);f.legendTitle=H;x&&(f.legendURL=x);f.events.on({loadstart:L,loadend:M,visibilitychanged:S});b.addLayer(f);a._base&&b.setBaseLayer(f)},Ha=function(b,a){var c=
a.name,d=[a.url];void 0!=a.url2&&d.push(a.url2);void 0!=a.url3&&d.push(a.url3);var e=a.layername;var g=void 0!=a.zoomLevels?a.zoomLevels:19;if(void 0!=a.dir){var f=a.dir;-1==$.inArray(f,b.s3.dirs)&&b.s3.dirs.push(f)}else f="";f=new OpenLayers.Layer.XYZ(c,d,{dir:f,s3_layer_id:a.id,s3_layer_type:"xyz",layername:e,type:void 0!=a.format?a.format:"png",numZoomLevels:g});void 0!=a.attribution&&(f.attribution=a.attribution);f.events.on({loadstart:L,loadend:M});b.addLayer(f);a._base&&b.setBaseLayer(f)},sa=
function(b){var a=b.s3.options,c=new OpenLayers.Control.Navigation;a.no_zoom_wheel&&(c.zoomWheelEnabled=!1);b.addControl(c);void 0==a.zoomcontrol&&b.addControl(new OpenLayers.Control.Zoom);b.addControl(new OpenLayers.Control.ArgParser);b.addControl(new OpenLayers.Control.Attribution);void 0==a.scaleline&&b.addControl(new OpenLayers.Control.ScaleLine);"mgrs"==a.mouse_position?b.addControl(new OpenLayers.Control.MGRSMousePosition):a.mouse_position&&b.addControl(new OpenLayers.Control.MousePosition);
void 0==a.permalink&&b.addControl(new OpenLayers.Control.Permalink);if(void 0==a.overview){a={};c=b.options;for(var d in c)"controls"!=d&&(a[d]=c[d]);b.addControl(new OpenLayers.Control.OverviewMap({mapOptions:a}))}Qa(b)},Qa=function(b){b.events.register("featureover",this,Ra);b.events.register("featureout",this,ia);b.events.register("featureclick",this,Sa)},Ra=function(b){var a=b.feature,c=a.layer,d;a.renderIntent="select";c.drawFeature(a);if(-1==["OpenLayers.Handler.PointS3","OpenLayers.Handler.Path",
"OpenLayers.Handler.Polygon","OpenLayers.Handler.RegularPolygon"].indexOf(c.name)){var e=c.map;-1==e.s3.layers_nopopups.indexOf(c.name)&&(S3.gis.timeouts[a.id]=setTimeout(function(){if(!a.cluster&&a.geometry){var g=a.attributes,f=a.geometry.getBounds().getCenterLonLat();if(void 0!=c.s3_popup_format){_.templateSettings={interpolate:/\{(.+?)\}/g};var k=c.s3_popup_format;var l=_.template(k);var n={},h=k.split("{");for(d=0;d<h.length;d++)k=h[d].split("}")[0],n[k]="";_.defaults(g,n);l=l(g)}else void 0!=
g.popup?l=g.popup:void 0!=g.name?l=g.name:void 0!=c.title&&(g=g[c.title],l="object"==typeof g?g.value:g);l&&(OpenLayers.Popup.Tooltip=OpenLayers.Class(OpenLayers.Popup,{displayClass:"gis_tooltip",contentDisplayClass:"gis_tooltip_content",CLASS_NAME:"OpenLayers.Popup.Tooltip"}),f=new OpenLayers.Popup.Tooltip(a.id+"_tooltip",f,new OpenLayers.Size(80,12),l),f.autoSize=!0,a.popup=f,e.addPopup(f))}},500))}},ia=function(b){b=b.feature;var a=b.layer,c=a.map;b&&(b.renderIntent="default",a.drawFeature(b));
-1==["OpenLayers.Handler.PointS3","OpenLayers.Handler.Path","OpenLayers.Handler.Polygon","OpenLayers.Handler.RegularPolygon"].indexOf(a.name)&&-1==c.s3.layers_nopopups.indexOf(a.name)&&b&&(clearTimeout(S3.gis.timeouts[b.id]),b.popup&&"OpenLayers.Popup.Tooltip"==b.popup.CLASS_NAME&&(b.popup&&(c.removePopup(b.popup),b.popup.destroy()),delete b.popup),$("#"+b.id+"_tooltip").remove())},ka=function(b,a,c,d){var e=b.id+"_popup";d&&a?(0===a.indexOf("http://")&&(a=OpenLayers.ProxyHost+encodeURIComponent(a)),
c='<iframe src="'+a+'" onload="S3.gis.popupLoaded(\''+e+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>'):void 0==c&&(c=i18n.gis_loading+'...<div class="throbber"></div>');var g=b.geometry.getBounds().getCenterLonLat();c=new OpenLayers.Popup.FramedCloud(e,g,new OpenLayers.Size(400,400),c,null,!0,Ta);b.popup=c;c.feature=b;c.maxSize=new OpenLayers.Size(750,660);g=b.layer.map;b.map=g;g.addPopup(c);d||void 0==a||ja(a,e+"_contentDiv",c);return c};S3.gis.addPopup=ka;S3.gis.popupLoaded=
function(b){$("#"+b+"_contentDiv iframe").contents().find("#popup").show();var a=S3.gis.maps,c,d;for(c in a){var e=a[c];var g=e.popups;var f=0;for(d=g.length;f<d;f++)e=g[f],e.id==b&&e.updateSize(!0)}};var ja=function(b,a,c){0===b.indexOf("http://")&&(b=OpenLayers.ProxyHost+encodeURIComponent(b));$.ajaxS3({url:b,dataType:"html",success:function(d){try{$("#"+a).html(d),c.updateSize(),$("#"+a+" a.btn.iframe").click(function(){var e=$(this).attr("href");0===e.indexOf("http://")&&(e=OpenLayers.ProxyHost+
encodeURIComponent(e));var g=a.slice(0,-11);e='<iframe src="'+e+'" onload="S3.gis.popupLoaded(\''+g+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>';$("#"+a).html(e);return!1})}catch(e){}},error:function(d,e,g){d="UNAUTHORIZED"==g?i18n.gis_requires_login:d.responseText;$("#"+a+"_contentDiv").html(d);c.updateSize()}})},Sa=function(b){var a=b.feature,c=a.layer,d=c.map,e=d.s3;if(-1==["OpenLayers.Handler.PointS3","OpenLayers.Handler.Path","OpenLayers.Handler.Polygon",
"OpenLayers.Handler.RegularPolygon"].indexOf(c.name)&&-1==e.layers_nopopups.indexOf(c.name))if("openweathermap"==c.s3_layer_type){var g=c.options.getPopupHtml(a.attributes.station);var f=new OpenLayers.Popup("Popup",a.geometry.getBounds().getCenterLonLat(),new OpenLayers.Size(c.options.popupX,c.options.popupY),g,"Station",!1);a.popup=f;f.feature=a;d.addPopup(f,!0)}else{var k=a.geometry,l;if("OpenLayers.Geometry.Point"!=k.CLASS_NAME)for(d=0,l=e.clicking.length;d<l;++d)if("OpenLayers.Geometry.Point"==
e.clicking[d].geometry.CLASS_NAME)return;ia(b);a.renderIntent="select";c.drawFeature(a);k=k.getBounds().getCenterLonLat();l=a.id+"_popup";b=void 0!=c.title?c.title:"name";if(a.cluster){var n=a.cluster;var h=i18n.gis_cluster_multiple+":<ul>";var m=n.length,w=e.id;for(d=0;d<m;d++){var r=n[d].attributes;if(void 0!=c.s3_popup_format){_.templateSettings={interpolate:/\{(.+?)\}/g};e=c.s3_popup_format;f=_.template(e);var v={},A=e.split("{");for(e=0;e<A.length;e++){var C=A[e].split("}")[0];v[C]=""}_.defaults(r,
v);e=f(r).split("<br/>",1)[0]}else e=void 0!=r.popup?r.popup.split("<br/>",1)[0]:r[b];void 0!=r.url?h+="<li><a href='javascript:S3.gis.loadClusterPopup(\""+w+'", "'+r.url+'", "'+l+"\")'>"+e+"</a></li>":void 0!=c.s3_url_format?(_.templateSettings={interpolate:/\{(.+?)\}/g},f=_.template(c.s3_url_format),r.id.constructor===Array&&(r.id=r.id[0]),f=f(r),h+="<li><a href='javascript:S3.gis.loadClusterPopup(\""+w+'", "'+f+'", "'+l+"\")'>"+e+"</a></li>"):h+="<li>"+e+"</li>"}f=null;h+="</ul>";h+="<div align='center'><a href='javascript:S3.gis.zoomToSelectedFeature(\""+
w+'", '+k.lon+","+k.lat+", 3)'>"+i18n.gis_zoomin+"</a></div>"}else if(d=c.s3_layer_type,"kml"==d){r=a.attributes;if(void 0!=a.style.balloonStyle)h=a.style.balloonStyle.replace(/{([^{}]*)}/g,function(H,B){B=r[B];return"string"===typeof B||"number"===typeof B?B:H});else for(d=typeof r[b],d="object"==d?r[b].value:r[b],h="<h3>"+d+"</h3>",c=c.body.split(" "),e=0;e<c.length;e++){d=typeof r[c[e]];if("object"==d){b=r[c[e]].displayName;""===b&&(b=c[e]);d=r[c[e]].value;var u='<div class="gis_popup_row"><div class="gis_popup_label">'+
b+':</div><div class="gis_popup_cell">'+d+"</div></div>"}else u=void 0!=r[c[e]]?'<div class="gis_popup_row">'+r[c[e]]+"</div>":"";h+=u}-1!=h.search("<script")&&(h="Content contained Javascript! Escaped content below.<br />"+h.replace(/</g,"<"))}else if("gpx"!=d)if("shapefile"==d||"geojson"==d)r=a.attributes,h="<div>",$.each(r,function(H,B){"id_orig"==H&&(H="id");u='<div class="gis_popup_row"><div class="gis_popup_label">'+H+':</div><div class="gis_popup_cell">'+B+"</div></div>";h+=u}),h+="</div>";
else if("wfs"==d)r=a.attributes,d=r[b],h="<h3>"+d+"</h3>",$.each(r,function(H,B){u='<div class="gis_popup_row"><div class="gis_popup_label">'+H+':</div><div class="gis_popup_val">'+B+"</div></div>";h+=u});else if(void 0!=a.attributes.url)f=a.attributes.url;else if(void 0!=c.s3_url_format)_.templateSettings={interpolate:/\{(.+?)\}/g},f=_.template(c.s3_url_format),a.attributes.id.constructor===Array&&(a.attributes.id=a.attributes.id[0]),f=f(a.attributes);else{r=a.attributes;e=void 0==r.name?"":"<h3>"+
r.name+"</h3>";c=void 0==r.description?"":"<p>"+r.description+"</p>";d=void 0==r.link?"":'<a href="'+r.link+'" target="_blank">'+r.link+"</a>";if(void 0==r.data)b="";else if(0===r.data.indexOf("http://")){g=!0;var I=S3.uid();b='<div id="'+I+'">'+i18n.gis_loading+"...<div class='throbber'></div></div>"}else b="<p>"+r.data+"</p>";k=void 0==r.image?"":0===r.image.indexOf("http://")?'<img src="'+r.image+'" height=300 width=300>':"";h=e+c+d+b+k}f=ka(a,f,h);g&&ja(a.attributes.data,I,f)}},Ta=function(){var b=
this.feature;if(b){var a=b.layer;b.renderIntent="default";a&&a.drawFeature(b);b.popup&&(a&&a.map.removePopup(b.popup),b.popup.destroy(),delete b.popup);if(b.id)$("#"+b.id+"_popup").remove();else{var c=b.map;if(c)for(var d=c.popups,e=d.length-1;-1<e;e--)c.removePopup(d[e])}a&&a.name==i18n.gis_draft_layer&&b.destroy()}};S3.gis.loadClusterPopup=function(b,a,c){var d="#"+c+"_contentDiv",e=$(d);e.html(i18n.gis_loading+"...<div class='throbber'></div>");var g=S3.gis.maps[b];$.getS3(a,function(f){e.html(f);
g.popups[0].updateSize();f=$(d+" .dropdown-toggle");f.length&&(e.parent().css("overflow","visible").parent().css("overflow","visible"),f.dropdown())},"html")};S3.gis.zoomToSelectedFeature=function(b,a,c,d){b=S3.gis.maps[b];a=new OpenLayers.LonLat(a,c);c=b.getZoom();b.setCenter(a,c+d);for(d=0;d<b.popups.length;d++)b.removePopup(b.popups[d])};var wa=function(b){var a=b.s3,c=a.options,d=new Ext.Toolbar({height:34});d.map=b;a.portal.toolbar=d;OpenLayers.Control.ZoomToMaxExtentS3=OpenLayers.Class(OpenLayers.Control.Button,
{trigger:function(){var m=new OpenLayers.Bounds.fromArray(c.restrictedExtent);m.transform(q,b.getProjectionObject());b.zoomToExtent(m)},CLASS_NAME:"OpenLayers.Control.ZoomToMaxExtentS3"});var e=new GeoExt.Action({control:new OpenLayers.Control.ZoomToMaxExtentS3,map:b,iconCls:"zoomfull",tooltip:i18n.gis_zoomfull}),g,f;if("active"==c.draw_polygon){var k=!0;var l=f=g=a=!1}else"active"==c.draw_line?(a=!0,l=k=g=f=!1):"active"==c.draw_feature?(f=!0,l=k=g=a=!1):"active"==c.draw_circle?(k=g=a=f=!1,l=!0):
(g=!0,l=k=f=a=!1);d.add(e);i18n.gis_geoLocate&&navigator.geolocation&&Ua(d);if(void 0===c.nav){e=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox({out:!0}),map:b,iconCls:"zoomout",tooltip:i18n.gis_zoomout,toggleGroup:"controls"});var n=new GeoExt.Action({control:new OpenLayers.Control.ZoomBox,map:b,iconCls:"zoomin",tooltip:i18n.gis_zoominbutton,toggleGroup:"controls"});g=new GeoExt.Action({control:new OpenLayers.Control.Navigation,map:b,iconCls:"pan-off",tooltip:i18n.gis_pan,allowDepress:!0,
toggleGroup:"controls",pressed:g});d.add(e);d.add(n);d.add(g);d.addSeparator();Va(d)}c.print&&(d.addSeparator(),Wa(d));c.save&&"float"!=c.save&&(d.addSeparator(),Xa(d));d.addSeparator();Ya(d);"toolbar"==c.clear_layers&&ea(b,d);c.mgrs_url&&Za(d);if(c.draw_feature||c.draw_line||c.draw_polygon||c.draw_circle){d.addSeparator();g=S3.gis.poi_resources;if(g)var h=g.length;if(c.draw_feature)if(g)for(e=0;e<h;e++)n=g[e],"point"==n.t&&U(b,d,f,n);else U(b,d,f);if(c.draw_line)if(g)for(e=0;e<h;e++)n=g[e],"line"==
n.t&&V(b,d,a,n);else V(b,d,a);if(c.draw_polygon)if(g)for(e=0;e<h;e++)n=g[e],"line"==n.t&&W(b,d,k,!0,n);else W(b,d,k,!0);if(c.draw_circle)if(g)for(e=0;e<h;e++)n=g[e],"circle"==n.t&&X(b,d,l,n);else X(b,d,l);c.color_picker&&$a(b,d)}i18n.gis_get_feature_info&&ab(b);i18n.gis_potlatch&&bb(d);c.Google&&c.Google.StreetviewButton&&cb(d);c.geonames&&(h=Math.min(350,!1===c.nav?c.map_width-500:c.map_width-680),h=new GeoExt.ux.GeoNamesSearchCombo({map:b,width:h,listWidth:h,minChars:2,emptyText:i18n.gis_search,
username:c.geonames}),d.addSeparator(),d.add(h));h=new Ext.BoxComponent({cls:"layer_throbber hide"});d.add(h);return d},Ua=function(b){var a=b.map,c=a.s3.draftLayer,d={fillColor:"#000",fillOpacity:.1,strokeWidth:0},e=new OpenLayers.Control.Geolocate({geolocationOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:7E3}});a.addControl(e);e.events.register("locationupdated",this,function(f){c.removeAllFeatures();var k=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(f.point.x,
f.point.y),f.position.coords.accuracy/2,40,0),{},d);c.addFeatures([new OpenLayers.Feature.Vector(f.point,{},{graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,pointRadius:10}),k]);a.zoomToExtent(c.getDataExtent());db(a,k)});e.events.register("locationfailed",this,function(){OpenLayers.Console.log("Location detection failed")});var g=new Ext.Button({iconCls:"geolocation",tooltip:i18n.gis_geoLocate,handler:function(){c.removeAllFeatures();e.activate()}});b.addButton(g)},db=function(b,
a){var c=a.geometry.getCentroid(),d=a.geometry.getBounds(),e=Math.abs((d.right-d.left)/2),g=0,f="up";window.resizeInterval=window.setInterval(function(){16<g&&clearInterval(window.resizeInterval);var k=.03*e/e;switch(g){case 4:case 12:f="down";break;case 8:f="up"}"up"!==f&&(k=-Math.abs(k));a.geometry.resize(1+k,c);b.s3.draftLayer.drawFeature(a);g++},50,c,e)},cb=function(b){var a=b.map,c=new (OpenLayers.Class(OpenLayers.Control,{defaults:{pixelTolerance:1,stopSingle:!0},initialize:function(){this.handlerOptions=
OpenLayers.Util.extend({},this.defaults);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(e){(e=a.getLonLatFromViewPortPx(e.xy))||(e=a.getCenter());a.s3.sv_popup&&a.s3.sv_popup.anc&&a.s3.sv_popup.close();a.s3.sv_popup=new GeoExt.Popup({title:a.s3.options.Google.StreetviewTitle,location:e,width:300,height:300,collapsible:!0,map:a.s3.mapPanel,items:[new gxp.GoogleStreetViewPanel]});
a.s3.sv_popup.show()}}))({autoactivate:!1});a.addControl(c);var d=new Ext.Button({iconCls:"streetview",tooltip:a.s3.options.Google.StreetviewButton,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",toggleHandler:function(e,g){!0===g?c.activate():c.deactivate()}});b.addSeparator();b.addButton(d)},Ya=function(b){var a=b.map,c=new OpenLayers.Style;c.addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:5,graphicName:"circle",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,
strokeColor:"#f5902e"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#f5902e",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#f5902e",fillColor:"white",fillOpacity:.5}}})]);c=new OpenLayers.StyleMap({"default":c});var d=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:c}}});d.events.on({measure:function(e){alert(i18n.gis_length_message+" "+e.measure.toFixed(2)+" "+e.units)}});d=new GeoExt.Action({control:d,
map:a,iconCls:"measure-off",tooltip:i18n.gis_length_tooltip,allowDepress:!0,enableToggle:!0,toggleGroup:"controls"});b.add(d);!1===a.s3.options.area&&(c=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{geodesic:!0,persist:!0,handlerOptions:{layerOptions:{styleMap:c}}}),c.events.on({measure:function(e){alert(i18n.gis_area_message+" "+e.measure.toFixed(2)+" "+e.units+"2")}}),a=new GeoExt.Action({control:c,map:a,iconCls:"measure-area",tooltip:i18n.gis_area_tooltip,allowDepress:!0,enableToggle:!0,
toggleGroup:"controls"}),b.add(a))},va=function(b){var a=b.s3.id;$("#"+a).append('<div class="map_legend_div"><div class="map_legend_tab right"></div><div class="map_legend_panel"></div></div>');var c=new GeoExt.LegendPanel({title:i18n.gis_legend,autoScroll:!0,border:!1}),d=$("#"+a+" .map_legend_panel");d=Ext.get(d[0]);c.render(d);$("#"+a+" .map_legend_tab").click(function(){if($(this).hasClass("right")){var e=b.s3.id,g=$("#"+e+" .map_legend_panel").outerWidth();$("#"+e+" .map_legend_div").animate({marginRight:"-"+
g+"px"});$("#"+e+" .map_legend_tab").removeClass("right").addClass("left")}else ha(b)});return c},ha=function(b){b=b.s3.id;$("#"+b+" .map_legend_div").animate({marginRight:0});$("#"+b+" .map_legend_tab").removeClass("left").addClass("right")},Va=function(b){var a=new OpenLayers.Control.NavigationHistory;b.map.addControl(a);a.activate();var c=new Ext.Button({iconCls:"back",tooltip:i18n.gis_navPrevious,handler:a.previous.trigger});a=new Ext.Button({iconCls:"next",tooltip:i18n.gis_navNext,handler:a.next.trigger});
b.addButton(c);b.addButton(a)},U=function(b,a,c,d){OpenLayers.Handler.PointS3=OpenLayers.Class(OpenLayers.Handler.Point,{dblclick:function(){return!0},CLASS_NAME:"OpenLayers.Handler.PointS3"});var e=b.s3.draftLayer,g=new OpenLayers.Control.DrawFeature(e,OpenLayers.Handler.PointS3,{featureAdded:function(l){for(b.s3.lastDraftFeature?b.s3.lastDraftFeature.destroy():1<e.features.length&&e.features[0].destroy();0<b.popups.length;)b.removePopup(b.popups[0]);void 0!=b.s3.pointPlaced&&b.s3.pointPlaced(l,
d);b.s3.lastDraftFeature=l}});if(a){var f=b.s3.id,k=new GeoExt.Action({control:g,handler:function(){if(k.items[0].pressed){$("#"+f+"_panel .olMapViewport").addClass("crosshair");var l=$("#"+f+"_panel .gis_colorpicker");l.length&&l.spectrum("disable")}else $("#"+f+"_panel .olMapViewport").removeClass("crosshair")},map:b,iconCls:"drawpoint-off",tooltip:d&&d.l?d.l:i18n.gis_draw_feature,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:c});a.add(k);c&&($("#"+f+"_panel .olMapViewport").addClass("crosshair"),
a=$("#"+f+"_panel .gis_colorpicker"),a.length&&a.spectrum("disable"));b.s3.pointButton=k}else b.addControl(g),c&&(g.activate(),$("#"+b.s3.id+"_panel .olMapViewport").addClass("crosshair"))},V=function(b,a,c,d){var e=b.s3.draftLayer,g=new OpenLayers.Control.DrawFeature(e,OpenLayers.Handler.Path,{featureAdded:function(n){for(b.s3.lastDraftFeature?b.s3.lastDraftFeature.destroy():1<e.features.length&&e.features[0].destroy();0<b.popups.length;)b.removePopup(b.popups[0]);void 0!=b.s3.pointPlaced&&b.s3.pointPlaced(n,
d);b.s3.lastDraftFeature=n}});if(a){var f=b.s3.id,k,l=new GeoExt.Action({control:g,handler:function(){l.items[0].pressed?($("#"+f+"_panel .olMapViewport").addClass("crosshair"),k=$("#"+f+"_panel .gis_colorpicker"),k.length&&k.spectrum("enable")):($("#"+f+"_panel .olMapViewport").removeClass("crosshair"),k=$("#"+f+"_panel .gis_colorpicker"),k.length&&k.spectrum("disable"))},map:b,iconCls:"drawline-off",tooltip:d&&d.l?d.l:i18n.gis_draw_line,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",pressed:c,
activateOnEnable:!0,deactivateOnDisable:!0});a.add(l);b.s3.lineButton=l}else b.addControl(g),c&&(g.activate(),$("#"+b.s3.id+"_panel .olMapViewport").addClass("crosshair"))},W=function(b,a,c,d,e){var g=b.s3,f=g.draftLayer;d=new OpenLayers.Control.DrawFeature(f,d?OpenLayers.Handler.Polygon:OpenLayers.Handler.RegularPolygon,{handlerOptions:d?{sides:4,snapAngle:90}:{},featureAdded:function(h){g.lastDraftFeature?g.lastDraftFeature.destroy():1<f.features.length&&f.features[0].destroy();var m=$("#gis_location_wkt");
if(m.length){var w=h.geometry.transform(b.getProjectionObject(),q).toString();m.val(w);$("#gis_location_lat").val("");$("#gis_location_lon").val("")}for(;0<b.popups.length;)b.removePopup(b.popups[0]);void 0!=g.pointPlaced&&g.pointPlaced(h,e);g.lastDraftFeature=h}});var k=g.id;if(a){var l=e&&e.l?e.l:i18n.gis_draw_polygon;var n=new GeoExt.Action({control:d,handler:function(){var h=n.items[0];h.pressed?(n.setIconClass("drawpolygonclear-off"),h.tooltip=i18n.gis_draw_polygon_clear,h.setTooltip(i18n.gis_draw_polygon_clear),
$("#"+k+"_panel .olMapViewport").addClass("crosshair"),h=$("#"+k+"_panel .gis_colorpicker"),h.length&&h.spectrum("enable")):(n.setIconClass("drawpolygon-off"),h.tooltip=l,h.setTooltip(l),$("#"+k+"_panel .olMapViewport").removeClass("crosshair"),h=$("#"+k+"_panel .gis_colorpicker"),h.length&&h.spectrum("disable"),g.lastDraftFeature?g.lastDraftFeature.destroy():1<f.features.length&&f.features[0].destroy(),void 0!=g.polygonButtonOff&&g.polygonButtonOff())},map:b,iconCls:"drawpolygon-off",tooltip:l,allowDepress:!0,
enableToggle:!0,toggleGroup:"controls",pressed:c,activateOnEnable:!0,deactivateOnDisable:!0});a.add(n);g.polygonButton=n}else b.addControl(d),c&&(d.activate(),$("#"+k+"_panel .olMapViewport").addClass("crosshair"),la(k,d))},la=function(b,a){if(void 0===a){var c,d=S3.gis.maps[b].controls;var e=0;for(c=d.length;e<c&&(a=d[e],"OpenLayers.Control.DrawFeature"!=a.CLASS_NAME);e++);}$("#"+b).append('<div class="map_polygon_panel">Click anywhere on the map to begin drawing. Double click to complete the area or click the Finish button below.<div class="map_polygon_buttons"><a class="button small map_polygon_finish">Finish</a><a class="button small map_polygon_clear">Clear</a></div></div>');
var g=S3.gis.maps[b].s3;$("#"+b+" .map_polygon_finish").click(function(){a.finishSketch();void 0!=g.polygonPanelFinish?g.polygonPanelFinish():(g.lastDraftFeature?g.lastDraftFeature.destroy():1<g.draftLayer.features.length&&g.draftLayer.features[0].destroy(),a.deactivate(),$("#"+b+"_panel .olMapViewport").removeClass("crosshair"))});$("#"+b+" .map_polygon_clear").click(function(){g.lastDraftFeature?g.lastDraftFeature.destroy():1<g.draftLayer.features.length&&g.draftLayer.features[0].destroy();a.deactivate();
$("#"+b+"_panel .olMapViewport").removeClass("crosshair");void 0!=g.polygonPanelClear&&g.polygonPanelClear()});return a};S3.gis.addPolygonPanel=la;var X=function(b,a,c,d){var e=b.s3.draftLayer,g=new OpenLayers.Control.DrawFeature(e,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:1E3},featureAdded:function(n){for(b.s3.lastDraftFeature?b.s3.lastDraftFeature.destroy():1<e.features.length&&e.features[0].destroy();0<b.popups.length;)b.removePopup(b.popups[0]);void 0!=b.s3.pointPlaced&&b.s3.pointPlaced(n,
d);b.s3.lastDraftFeature=n}});if(a){var f=b.s3.id,k,l=new GeoExt.Action({control:g,handler:function(){l.items[0].pressed?($("#"+f+"_panel .olMapViewport").addClass("crosshair"),k=$("#"+f+"_panel .gis_colorpicker"),k.length&&k.spectrum("enable")):($("#"+f+"_panel .olMapViewport").removeClass("crosshair"),k=$("#"+f+"_panel .gis_colorpicker"),k.length&&k.spectrum("disable"))},map:b,iconCls:"drawcircle-on",tooltip:d&&d.l?d.l:i18n.gis_draw_circle,allowDepress:!0,enableToggle:!0,toggleGroup:"controls",
pressed:c,activateOnEnable:!0,deactivateOnDisable:!0});a.add(l);b.s3.circleButton=l}else b.addControl(g),c&&(g.activate(),$("#"+b.s3.id+"_panel .olMapViewport").addClass("crosshair"))},eb=function(b){var a=new jQuery.Deferred,c=S3.gis.maps[b].s3;setTimeout(function e(){void 0!=c.mapWin?a.resolve("loaded"):"pending"===a.state()&&(a.notify("waiting for JS to load..."),setTimeout(e,500))},1);return a.promise()},ma=function(b){b=parseInt(b,16);return[b>>16&255,b>>8&255,b&255].join()},$a=function(b,a){var c=
b.s3,d=c.id,e=c.options.draft_style;e=e?e.fillOpacity?"rgba("+ma(e.fill)+","+e.fillOpacity+")":"rgb("+ma(e.fill)+")":"";e=new Ext.Toolbar.Item({html:'<input class="gis_colorpicker" name="colour" value="'+e+'"/>'});a.add(e);$.when(eb(d)).then(function(){$("#"+d+"_panel .gis_colorpicker").spectrum({showInput:!0,showInitial:!0,preferredFormat:"rgb",showPaletteOnly:!0,togglePaletteOnly:!0,palette:"rgba(255, 0, 0, .5);rgba(255, 165, 0, .5);rgba(255, 255, 0, .5);rgba(0, 255, 0, .5);rgba(0, 0, 255, .5);rgba(255, 255, 255, .5);rgba(0, 0, 0, .5)".split(";"),
showAlpha:!0,cancelText:i18n.gis_cancelText,chooseText:i18n.gis_chooseText,togglePaletteMoreText:i18n.gis_togglePaletteMoreText,togglePaletteLessText:i18n.gis_togglePaletteLessText,clearText:i18n.gis_clearText,noColorSelectedText:i18n.gis_noColorSelectedText,change:function(g){var f={fill:Number(16777216+65536*Math.round(g._r)+256*Math.round(g._g)+Math.round(g._b)).toString(16).substring(1)};1!=g._a&&(f.fillOpacity=g._a);g=Q(b,{style:f,opacity:.9})[0];f=c.draftLayer;f.styleMap=g;f.redraw()}})},function(g){s3_debug(g)},
function(g){s3_debug(g)})},bb=function(b){var a=b.map,c=new Ext.Button({iconCls:"potlatch",tooltip:i18n.gis_potlatch,handler:function(){var d=a.getZoom();if(14>d)alert(i18n.gis_osm_zoom_closer);else{var e=a.getCenter();e.transform(a.getProjectionObject(),q);d=S3.Ap.concat("/gis/potlatch2/potlatch2.html")+"?lat="+e.lat+"&lon="+e.lon+"&zoom="+d;window.open(d)}}});b.addSeparator();b.addButton(c)},Wa=function(b){var a=b.map,c=a.s3.id,d=new Ext.Button({iconCls:"print",tooltip:i18n.gis_print_tip,menu:{xtype:"menu",
plain:!0,items:[{xtype:"form",bodyPadding:5,items:[{xtype:"combo",allowBlank:!1,displayField:"label",fieldLabel:i18n.gis_paper_size,getListParent:function(){return this.el.up(".x-menu")},hiddenName:"size",id:c+"_paper_size",lazyInit:!1,mode:"local",selectOnFocus:!0,store:new Ext.data.ArrayStore({id:0,fields:["size","label"],data:[["Letter","Letter (2550 x 3300)"],["A4","A4 (2480 x 3508)"],["A3","A3 (3508 x 4962)"],["A2","A2 (4962 x 7017)"],["A1","A1 (7017 x 9933)"],["A0","A0 (9933 x 14061)"]]}),triggerAction:"all",
typeAhead:!0,value:"Letter",valueField:"size"},{xtype:"button",text:i18n.gis_print,handler:function(){var e=$("#x-form-el-"+c+'_paper_size input[name="size"]').val();if("Letter"==e){var g=2550;var f=3300}else"A4"==e?(g=2480,f=3508):"A3"==e?(g=3508,f=4962):"A2"==e?(g=4962,f=7017):"A1"==e?(g=7017,f=9933):"A0"==e&&(g=9933,f=14061);var k=a.getExtent();g=new OpenLayers.Size(f,g);k=Math.max(k.getWidth()/g.w,k.getHeight()/g.h);k=a.baseLayer.getZoomForResolution(k);k=Z(a,!0,k);e=S3.Ap.concat("/gis/screenshot/"+
k+"?size="+e);window.open(e)}}]}]}});b.addButton(d)},Xa=function(b){var a=new Ext.Button({iconCls:"save",tooltip:i18n.gis_save,handler:function(){Z(b.map)}});b.addButton(a)},xa=function(b){var a=b.s3,c=a.id;if(!$("#"+c+" .map_save_panel").length){var d='<div class="fleft"><div class="map_save_name">';(a=a.options.config_name)&&(d+=a);d='<div class="map_save_panel off">'+(d+'</div></div><div class="btn map_save_button"><div class="map_save_label">')+i18n.gis_save_map+"</div></div></div>";$("#"+c).append(d);
a&&$("#"+c+" .map_save_panel").removeClass("off");$("#"+c+" .map_save_button").click(function(){na(b)})}},na=function(b){var a=b.s3.id;$("#"+a+" .map_save_panel").removeClass("off");$("#"+a+" .map_save_panel .saved").remove();$("#"+a+" .map_save_panel .fleft").show();$("#"+a+" .map_save_label").html(i18n.save);oa(b)},oa=function(b){var a=b.s3,c=a.id,d=a.options,e=d.config_id,g=$("#"+c+" .map_save_button"),f=c+"_save";a=$("#"+f);a.length||(a='<div class="hint"><label for="'+(f+'">'+i18n.gis_name_map+
"</label>")+a+"</div>",e='<div class="new_map"><input type="checkbox" class="checkbox"'+(e?"":' disabled="disabled" checked="checked"')+">"+i18n.gis_new_map+"</div>",$("#"+c+" .map_save_panel .fleft").html(a+e),$("#"+c+" .map_save_panel label").labelOver("over"));g.unbind("click").click(function(){Z(b);var l=$("#"+c+"_save").val();$("#"+c+" .map_save_name").html(l);d.config_name=l;l=d.pe_id?"?~.pe_id__belongs="+d.pe_id:"";l='<div class="saved"><p><i>'+i18n.saved+'</i></p><p><a href="'+S3.Ap.concat("/gis/config")+
l+'">'+i18n.gis_my_maps+"</a></p></div>";$("#"+c+" .map_save_panel .fleft").hide().before(l);$("#"+c+" .map_save_panel .checkbox").prop("checked",!1).prop("disabled",!1);g.unbind("click").click(function(){na(b)})});var k=$("#"+c+" .map_save_panel");$("html").unbind("click.cancelSave").bind("click.cancelSave",function(){k.addClass("off");g.unbind("click").click(function(){k.removeClass("off").unbind("click");oa(b)})});k.click(function(l){l.stopPropagation()})},Z=function(b,a,c){var d=b.s3,e=d.id;T(e);
var g=fb(b),f=JSON.stringify,k=f(g.layers);f=f(g.plugins);c={lat:g.lat,lon:g.lon,zoom:c||g.zoom,layers:k,plugins:f};var l=d.options;l.pe_id&&(c.pe_id=l.pe_id);if(a)e=!1,c.temp=1;else{d=$("#"+e+"_save");var n=l.config_id;d.length?(c.hide=1,c.name=d.val(),e=n?!$("#"+e+' .map_save_panel input[type="checkbox"]').prop("checked"):!1):e=n?!0:!1}e=e?S3.Ap.concat("/gis/config/"+n+".url/update"):S3.Ap.concat("/gis/config.url/create");$.ajaxS3({async:!1,url:e,type:"POST",data:c,dataType:"json",success:function(h){n=
h.id;if(!a&&n){l.config_id=n;if(history.pushState)if(document.location.search){h=document.location.search.split("?")[1].split("&");for(var m,w=0;w<h.length;w++)if(m=h[w].split("="),"config"==decodeURIComponent(m[0])&&decodeURIComponent(m[1])!=n){h[w]="config="+n;h=document.location.pathname+"?"+h.join("&");window.history.pushState({},document.title,h);break}}else if(document.location.pathname==S3.Ap.concat("/gis/index")||document.location.pathname==S3.Ap.concat("/gis/map_viewing_client"))h=document.location.pathname+
"?config="+n,window.history.pushState({},document.title,h);h=S3.Ap.concat("/gis/config/",n,"/layer_entity");$("#gis_menu_config").attr("href",h)}P(null,b)}});return n},fb=function(b){var a={},c=b.getCenter();c.transform(b.getProjectionObject(),q);a.lon=c.lon;a.lat=c.lat;a.zoom=b.getZoom();var d=[],e,g,f=b.baseLayer.s3_layer_id;Ext.iterate(b.layers,function(l){e=l.s3_layer_id;g={id:e};l.visibility&&(g.visible=l.visibility);e==f&&(g.base=!0);l.s3_style&&(g.style=l.s3_style);l.dir&&(g.dir=l.dir);d.push(g)});
a.layers=d;var k=[];Ext.iterate(b.s3.plugins,function(l){l.getState&&k.push(l.getState())});a.plugins=k;return a},Za=function(b){var a=b.map,c=a.s3.options,d=new OpenLayers.Control;OpenLayers.Util.extend(d,{draw:function(){this.box=new OpenLayers.Handler.Box(this,{done:this.getPdf});this.box.activate()},response:function(g){this.w.destroy();g=(new OpenLayers.Format.GML).read(g.responseText);var f=g.length+" pdfs. <br /><ul>";if(g.length)for(var k=0;k<g.length;k++){var l=g[k];f+="<li><a href='"+g[k].attributes.url+
"'>"+(l.attributes.utm_zone+l.attributes.grid_zone+l.attributes.grid_square+l.attributes.easting+l.attributes.northing)+"</a></li>"}this.w=new Ext.Window({html:f+"</ul>",width:300,title:"Results",height:200});this.w.show()},getPdf:function(g){var f=a.getProjectionObject(),k=a.getLonLatFromPixel(new OpenLayers.Pixel(g.left,g.bottom)).transform(f,q);g=a.getLonLatFromPixel(new OpenLayers.Pixel(g.right,g.top)).transform(f,q);k=(new OpenLayers.Bounds(k.lon,k.lat,g.lon,g.lat)).toBBOX();OpenLayers.Request.GET({url:c.mgrs_url+
"&bbox="+k,callback:OpenLayers.Function.bind(this.response,this)});this.w=new Ext.Window({html:"Searching "+c.mgrs_name+", please wait.",width:200,title:"Please Wait."});this.w.show()}});var e="Select "+c.mgrs_name;d=new GeoExt.Action({text:e,control:d,map:a,allowDepress:!1,toggleGroup:"controls",tooltip:e});b.addSeparator();b.add(d)},ab=function(b){var a=new gxp.plugins.WMSGetFeatureInfo({actionTarget:"toolbar",outputTarget:"map",outputConfig:{width:400,height:200},toggleGroup:"controls",infoActionTip:i18n.gis_get_feature_info,
popupTitle:i18n.gis_feature_info});a.target=b.s3;a.addActions()},za=function(b,a){var c=new gxp.plugins.AddLayers({actionTarget:"treepanel.tbar",addActionTip:"Add layers",addActionMenuText:"Add layers",addServerText:"Add a New Server",doneText:"Done",upload:{url:null},uploadText:i18n.gis_uploadlayer,relativeUploadOnly:!1}),d=new GeoExt.data.LayerStore;c.target=a;a.proxy=OpenLayers.ProxyHost;a.layerSources={};a.layerSources.local=new gxp.plugins.LayerSource({title:"local",store:d});c.addActions()[0].enable();
c=new gxp.plugins.RemoveLayer({actionTarget:"treepanel.tbar",removeActionTip:"Remove layer"});c.target=a;a.mapPanel=b.s3.mapPanel;c.addActions()},Aa=function(b,a){var c=b.s3.propertiesWindow,d=new Ext.Button({iconCls:"gxp-icon-layerproperties",tooltip:i18n.gis_properties,handler:function(){var e=a.root.findChildBy(function(k){return k.isSelected()?k.leaf?!0:!1:!1},null,!0);if(e){var g=e.layer.s3_layer_type,f=S3.Ap.concat("/gis/layer_"+g+".plain?layer_"+g+".layer_id="+e.layer.s3_layer_id+"&update=1");
Ext.Ajax.request({url:f,method:"GET",success:function(k){c&&c.close();"feature"==g?(k=new Ext.TabPanel({activeTab:0,items:[{title:"Layer Properties",html:k.responseText},{title:"Filter",id:"s3_gis_layer_filter_tab",html:""}]}),k.items.items[1].on("activate",function(){var l;Ext.iterate(b.s3.layers_feature,function(n){n.id==e.layer.s3_layer_id&&(l=n.url.replace(/.geojson.+/,"/search.plain"))});Ext.get("s3_gis_layer_filter_tab").load({url:l,discardUrl:!1,callback:function(){S3.redraw()},text:"Loading...",
timeout:30,scripts:!1})})):k=new Ext.Panel({title:"Layer Properties",html:k.responseText});c=new Ext.Window({width:400,layout:"fit",items:[k]});c.show();$("#plain form").submit(function(){var l=$('#plain input[name="id"]').val();l=S3.Ap.concat("/gis/layer_"+g+"/"+l+".plain/update");var n=$("#plain input"),h=[];Ext.iterate(n,function(r,v){v.id&&-1!=v.id.indexOf("gis_layer_")&&h.push(v.id)});n=[];for(var m,w=0;w<h.length;w++)(m=$("#"+h[w]).serialize())&&n.push(m);(m=$('#plain input[name="id"]').serialize())&&
n.push(m);(m=$('#plain input[name="_formkey"]').serialize())&&n.push(m);(m=$('#plain input[name="_formname"]').serialize())&&n.push(m);0<n.length&&(n=n.join("&"),$.ajaxS3({type:"POST",url:l,data:n,success:function(r){$("#plain").html(r)}}));return!1});S3.addTooltips();S3.autocomplete.normal("role","admin","group","gis_layer_"+g+"_role_required")}})}}});a.getTopToolbar().add(d)},ea=function(b,a){var c=new Ext.Button({iconCls:"icon-clearlayers",tooltip:i18n.gis_clearlayers,handler:function(){for(var d=
b.layers,e=0,g=d.length;e<g;e++){var f=d[e];f.isBaseLayer||f.setVisibility(!1)}}});a.add(c)},Q=function(b,a){if(void 0!=a.marker){var c=a.marker;var d=t+c.i;var e=c.h,g=c.w}else d="";var f=a.opacity||1,k=a.style;var l="[object Array]"===Object.prototype.toString.call(k)?!0:!1;var n=b.s3.options;b=new OpenLayers.Style({label:"${label}",labelAlign:"cm",pointRadius:"${radius}",fillColor:"${fill}",fillOpacity:"${fillOpacity}",strokeColor:"${stroke}",strokeDashstyle:"${strokeDashstyle}",strokeWidth:"${strokeWidth}",
strokeOpacity:"${strokeOpacity}",graphicHeight:"${graphicHeight}",graphicWidth:"${graphicWidth}",graphicName:"${graphicName}",graphicOpacity:f,graphicXOffset:"${graphicXOffset}",graphicYOffset:"${graphicYOffset}",graphicZIndex:"${graphicZIndex}",externalGraphic:"${externalGraphic}",zIndex:"${zIndex}"},{context:{graphicWidth:function(h){var m=1;h.cluster||(h.attributes.marker_width?m=h.attributes.marker_width:k&&!l&&void 0==k.externalGraphic&&void 0==g&&"OpenLayers.Geometry.Point"==h.geometry.CLASS_NAME?
m=n.marker_default.w:void 0!=g&&(m=g));return m},graphicHeight:function(h){var m=1;h.cluster||(h.attributes.marker_height?m=h.attributes.marker_height:k&&!l&&void 0==k.externalGraphic&&void 0==e&&"OpenLayers.Geometry.Point"==h.geometry.CLASS_NAME?m=n.marker_default.h:void 0!=e&&(m=e));return m},graphicXOffset:function(h){var m=-1;h.cluster||(h.attributes.marker_width?m=-(h.attributes.marker_width/2):k&&!l&&void 0==k.externalGraphic&&void 0==g&&"OpenLayers.Geometry.Point"==h.geometry.CLASS_NAME?m=
-(n.marker_default.w/2):void 0!=g&&(m=-(g/2)));return m},graphicYOffset:function(h){var m=-1;h.cluster||(h.attributes.marker_height?m=-h.attributes.marker_height:k&&!l&&void 0==k.externalGraphic&&void 0==e&&"OpenLayers.Geometry.Point"==h.geometry.CLASS_NAME?m=-n.marker_default.h:void 0!=e&&(m=-e));return m},graphicName:function(h){var m="circle";h.cluster||(h.attributes.shape?m=h.attributes.shape:k&&!l&&void 0!=k.graphic&&(m=k.graphic));return m},externalGraphic:function(h){var m="";if(!h.cluster)if(h.attributes.marker_url)m=
h.attributes.marker_url;else if(k){if(!l)if(void 0!=k.externalGraphic)m=S3.Ap.concat("/static/"+k.externalGraphic);else if("OpenLayers.Geometry.Point"==h.geometry.CLASS_NAME){if(d)return d;m=t+n.marker_default.i}}else if("OpenLayers.Geometry.Point"==h.geometry.CLASS_NAME)return d;return m},radius:function(h){var m=10;h.cluster?m=Math.min(h.attributes.count/2,8)+10:h.attributes.size?m=h.attributes.size:k&&!l&&(m=k.size);return m},fill:function(h){if(h.cluster)var m=h.cluster[0].attributes.colour?h.cluster[0].attributes.colour:
"#"+(n.cluster_fill||"8087ff");else h.attributes.colour?m=h.attributes.colour:h.attributes.style?(m=h.attributes.style.fill,m=void 0!=m?"#"+m:"#000000"):k?(l||(m=k.fill),m=void 0!=m?"#"+m:"#000000"):m="#f5902e";return m},fillOpacity:function(h){if(h.cluster)var m=h.cluster[0].attributes.opacity?h.cluster[0].attributes.opacity:f;else h.attributes.opacity?m=h.attributes.opacity:h.attributes.style?m=h.attributes.style.fillOpacity:k&&!l&&(m=k.fillOpacity);return m||f},stroke:function(h){if(h.cluster)var m=
h.cluster[0].attributes.colour?h.cluster[0].attributes.colour:"#"+(n.cluster_stroke||"2b2f76");else h.attributes.colour?m=h.attributes.colour:h.attributes.style?(h=h.attributes.style,m=h.stroke||h.fill,m=void 0!=m?"#"+m:"#000000"):k?(l||(m=k.stroke||k.fill),m=void 0!=m?"#"+m:"#000000"):m="#f5902e";return m},strokeOpacity:function(h){if(h.cluster)var m=h.cluster[0].attributes.opacity?h.cluster[0].attributes.opacity:f;else h.attributes.opacity?m=h.attributes.opacity:k&&!l&&(m=k.strokeOpacity);return m||
f},strokeDashstyle:function(){if(k&&!l)var h=k.strokeDashstyle;return h||"solid"},strokeWidth:function(h){var m=2;h.cluster?h.cluster[0].attributes.strokeWidth&&(m=h.cluster[0].attributes.strokeWidth):k&&!l&&(m=k.strokeWidth);return m||2},label:function(h){if(h.cluster){if(n.cluster_label&&1<h.attributes.count)var m=h.attributes.count}else h.layer&&void 0!=h.layer.s3_style&&(h=h.layer.s3_style,!l&&h.show_label&&(m=h.label));return m||""},zIndex:function(h){return"OpenLayers.Geometry.Point"==h.geometry.CLASS_NAME?
10:"OpenLayers.Geometry.Line"==h.geometry.CLASS_NAME?5:0},graphicZIndex:function(h){return"OpenLayers.Geometry.Point"==h.geometry.CLASS_NAME?10:"OpenLayers.Geometry.Line"==h.geometry.CLASS_NAME?5:0}}});l&&(a=fa(a),b.addRules(a));1!=f?(a=Math.min(2*f,.8),a={fillOpacity:a,graphicOpacity:a}):a={fillColor:"#"+(n.select_fill||"ffdc33"),strokeColor:"#"+(n.select_stroke||"ff9933")};return[new OpenLayers.StyleMap({"default":b,select:a}),d]},fa=function(b){var a=[],c,d,e,g,f,k,l,n,h,m,w,r,v;$.each(b.style,
function(C,u){C={};void 0!=u.fallback?(C.title=u.fallback,e=C.elseFilter=!0):(c=void 0!=u.prop?u.prop:"value",void 0!=u.cat?(d=u.cat,C.title=u.label||d,C.filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:c,value:d})):(C.title=u.label||u.low+"-"+u.high,C.filter=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.BETWEEN,property:c,lowerBoundary:u.low,upperBoundary:u.high})));void 0!=u.externalGraphic?(k=!0,m=!1):void 0!=u.size?(k=!0,m=!1):
k=!1;void 0!=u.fill?(m=!1,g="#"+u.fill):void 0!=u.stroke&&(m=!0,g="#"+u.stroke);f=void 0!=u.fillOpacity?u.fillOpacity:b.opacity||1;w=void 0!=u.strokeOpacity?u.strokeOpacity:1;var I=void 0!=u.graphic?u.graphic:"square";r=void 0!=u.strokeWidth?u.strokeWidth:2;v={fillColor:g,fillOpacity:f,strokeColor:g,strokeOpacity:w,strokeWidth:r,graphicName:I};k?(void 0!=u.externalGraphic&&(l=S3.Ap.concat("/static/"+u.externalGraphic),I=new Image,I.src=l,n=I.height,h=I.width,v.externalGraphic=l,v.graphicHeight=n,
v.graphicWidth=h,v.graphicXOffset=-(h/2),v.graphicYOffset=-n),v.pointRadius=u.size||10,v.graphicZIndex=10,v.zIndex=10,v.Point=v):m&&(v.graphicZIndex=5,v.zIndex=5,v.Line=v,void 0!=u.strokeDashstyle&&(v.strokeDashstyle=u.strokeDashstyle));C.symbolizer=v;A=new OpenLayers.Rule(C);a.push(A)});if(!e&&0!=b.cluster_threshold){var A=new OpenLayers.Rule({elseFilter:!0,title:" "});a.push(A)}return a}})();
