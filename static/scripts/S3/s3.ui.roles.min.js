/*
 2018-2021 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
(function(c,n){var m={rm_Add:"Add",rm_Cancel:"Cancel",rm_ConfirmDeleteAssignment:"Do you want to remove this assignment?",rm_Delete:"Delete",rm_DeletionFailed:"Deletion Failed",rm_ForEntity:"For Entity",rm_Role:"Role",rm_SubmissionFailed:"Submission Failed",rm_User:"User"},p=0;c.widget("s3.roleManager",{options:{mode:"roles",items:{},useRealms:!1,realmTypes:null,realms:null,ajaxURL:null},_create:function(){this.id=p;p+=1;this.eventNamespace=".roleManager"},_init:function(){for(var a in m)m[a]=i18n[a]||
m[a];this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){var a=c(this.element);this._unbindEvents();c(".rm-assign",a).remove();this.itemSelector=this.realmSelector=this.addButton=this.addRow=null;this._deserialize();a.append(this._assignmentTable());this._bindEvents()},_deserialize:function(){var a=c(this.element).attr("id"),b=c("#"+a+"-data").val();try{this.assignments=JSON.parse(b)}catch(d){this.assignments=[]}this.recordID=c("#"+a+"-id").val()},_serialize:function(){var a=
c(this.element).attr("id");c("#"+a+"-data").val(JSON.stringify(this.assignments))},_assignmentTable:function(){var a=this.options,b=c('<table class="rm-assign">');b.append(this._assignmentTableHead()).append(this._assignmentTableBody());if(a.ajaxURL){a=a.items;var d=!1,e;for(e in a)if(!1!==a[e].a){d=!0;break}d&&b.append(this._assignmentTableFooter())}return b},_assignmentTableHead:function(){var a=this.options,b=c("<thead>"),d=c("<tr>").appendTo(b);var e="users"==a.mode?m.rm_User:m.rm_Role;c("<th>").text(e).appendTo(d);
a.useRealms&&c("<th>").text(m.rm_ForEntity).appendTo(d);c("<th>").appendTo(d);return b},_assignmentTableBody:function(){var a=c("<tbody>"),b=this.assignments,d=this;b.length||a.append("<tr>");b.sort(function(e,g){return d._compareAssignments(e,g)}).forEach(function(e){a.append(d._assignmentTableRow(e))});return a},_assignmentTableRow:function(a){var b=c('<tr class="rm-assignment">').data("assignment",a),d=this.options,e=d.items[a[0]],g=c("<td>").appendTo(b);c('<span class="rm-item-name">').text(e.l).appendTo(g);
e.t&&c('<span class="rm-item-title">').text(e.t).appendTo(g);d.useRealms&&(a=!e.u&&d.realms[a[1]].l||"",c("<td>").text(a).appendTo(b));a=c("<td>");!1!==e.r&&d.ajaxURL&&(d=c('<span class="rm-delete-assignment delete-btn-ajax">'),a.append(d.text(m.rm_Delete)));return b.append(a)},_assignmentTableFooter:function(){var a=c("<tfoot>"),b=c("<tr>").appendTo(a);c("<td>").append(this._itemSelector()).appendTo(b);this.options.useRealms&&c("<td>").append(this._realmSelector()).appendTo(b);var d=c('<a class="rm-submit-add action-btn">').text(m.rm_Add),
e=c('<span class="rm-cancel-add action-lnk">').text(m.rm_Cancel);d.prop("disabled",!0).attr("disabled","disabled");c('<td class="rm-row-actions">').append(d).append(e).appendTo(b);this.addRow=b;return a},_itemSelector:function(){var a=c('<select class="rm-item-select">'),b=this.options.items,d=[];c('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(a);var e;for(e in b){var g=b[e];if(!1!==g.a){var h=g.l;g.t&&(h+=" ("+g.t+")");d.push([e,h])}}d.sort(function(f,k){return f[1]!==
k[1]&&(f[1]>k[1]&&1||-1)||0}).forEach(function(f){c("<option>").attr("value",f[0]).text(f[1]).appendTo(a)});return this.itemSelector=a},_realmSelector:function(){var a=c('<select class="rm-realm-select">'),b=this.options,d=b.realms,e=this,g={};Object.keys(d).sort(function(h,f){return e._compareRealms(h,f)}).forEach(function(h){var f=d[h],k=f.t;h=[h,f.l];f=g[k];f===n?g[k]=[h]:f.push(h)});c('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(a);b.realmTypes.forEach(function(h){var f=
g[h[0]];if(f){var k=c("<optgroup>").attr("label",h[1]).appendTo(a);f.forEach(function(l){c("<option>").attr("value",l[0]).text(l[1]).appendTo(k)})}});this.realmSelector=a;this._resetRealmSelector();return a.prop("disabled",!0).css({visibility:"hidden"})},_toggleAdd:function(a){var b=c(".rm-submit-add",this.addRow);b.length&&(a?b.prop("disabled",!1):b.prop("disabled",!0))},_resetAddRow:function(){var a=c(".rm-item-select",this.addRow);a.length&&a.val("").change();this._checkNewAssignment()},_resetRealmSelector:function(){var a=
this.realmSelector;a&&(c('option[value="null"]',a).length?a.val("null"):a.val(""))},_optionSelected:function(){var a=this.options,b=this.itemSelector,d=this.realmSelector;if(b!==n)if(b=b.val()){if(a=a.items[b])d&&(a.u?(this._resetRealmSelector(),d.prop("disabled",!0).css({visibility:"hidden"})):d.prop("disabled",!1).css({visibility:"visible"})),!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)}else d&&(this._resetRealmSelector(),d.prop("disabled",!0).css({visibility:"hidden"})),
this._toggleAdd(!1)},_realmSelected:function(){!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)},_getNewAssignment:function(){var a=this.itemSelector;if(a){var b=null;if((a=a.val())&&!isNaN(a-0))return this.options.useRealms&&(b=this.realmSelector.val(),null!==b&&(b-=0,isNaN(b)&&(b=null))),[a-0,b]}},_checkNewAssignment:function(){var a=this._getNewAssignment(),b=c(".rm-assignment",c(this.element)).removeClass("rm-duplicate");if(a){for(var d=b.length;d--;){var e=c(b[d]),g=e.data("assignment");
if(a[0]===g[0]&&a[1]===g[1])return e.addClass("rm-duplicate"),!1}return a}},_addAssignment:function(){var a=this.options.ajaxURL,b=this._checkNewAssignment();if(a&&b){var d=this.addRow,e=c(".rm-submit-add",d).hide(),g=c(".rm-cancel-add",d).hide(),h=c('<div class="inline-throbber">').insertBefore(e),f=this;c.ajaxS3({type:"POST",url:a.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({add:[b]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){f.assignments.push(b);
f._serialize();for(var k=c(".rm-assignment",c(f.element)),l=f._assignmentTableRow(b).hide(),q=k.length;q--;){var r=c(k[q]),t=r.data("assignment");if(-1==f._compareAssignments(t,b)){l.insertAfter(r).fadeIn();l=null;break}}l&&(c("tbody",d.closest(".rm-assign")).prepend(l),l.fadeIn());h.remove();e.show();g.show();f._resetAddRow()},error:function(){var k=c('<span class="rm-error">').insertBefore(h.hide());k.text(m.rm_SubmissionFailed);h.remove();window.setTimeout(function(){k.fadeOut(function(){e.show();
g.show()})},1E3)}})}},_deleteAssignment:function(a){var b=this.options,d=b.ajaxURL,e=a.data("assignment");if(d&&e){var g=m.rm_ConfirmDeleteAssignment;g=g.replace(/%\((role|user)\)s/g,'"'+b.items[e[0]].l+'"');if(confirm(g)){var h=c(".rm-delete-assignment",a).hide(),f=c('<div class="inline-throbber">').insertBefore(h),k=this;c.ajaxS3({type:"POST",url:d.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({remove:[e]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){k.assignments=
k.assignments.filter(function(l){return l[0]!==e[0]||l[1]!==e[1]});k._serialize();c(".rm-assignment",c(k.element)).each(function(){var l=c(this).data("assignment");l[0]===e[0]&&l[1]===e[1]&&c(this).fadeOut(function(){f.remove();c(this).remove();k._checkNewAssignment()&&k._toggleAdd(!0)})})},error:function(){var l=c('<span class="rm-error">').insertBefore(f.hide());l.text(m.rm_DeletionFailed);f.remove();window.setTimeout(function(){l.fadeOut(function(){h.show()})},1E3)}})}}},_compareAssignments:function(a,
b){var d=this.options.items,e=d[a[0]].l;d=d[b[0]].l;return e==d?this._compareRealms(a[1],b[1]):e>d&&1||-1},_compareRealms:function(a,b){if(a===b)return 0;var d=this.options.realms,e=this._compareRealmTypes(d[a].t,d[b].t);return e?e:a?b?d[a].l>d[b].l&&1||-1:-1:null===a&&1||null===b&&-1||1},_compareRealmTypes:function(a,b){if(a===b)return 0;var d=this.options.realmTypes.map(function(e){return e[0]});a=d.indexOf(a);b=d.indexOf(b);return a-b},_bindEvents:function(){var a=this.eventNamespace,b=this;if(this.addRow!==
n)this.addRow.on("change"+a,".rm-item-select",function(){b._optionSelected()}).on("change"+a,".rm-realm-select",function(){b._realmSelected()}).on("click"+a,".rm-cancel-add",function(){b._resetAddRow()}).on("click"+a,".rm-submit-add",function(){b._addAssignment()});c(this.element).on("click"+a,".rm-delete-assignment",function(){b._deleteAssignment(c(this).closest(".rm-assignment"))});return!0},_unbindEvents:function(){var a=c(this.element),b=this.eventNamespace;this.addRow!==n&&this.addRow.off(b);
a.off(b);return!0}})})(jQuery);
