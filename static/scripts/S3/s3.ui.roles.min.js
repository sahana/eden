/*
 2018-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var g=0;return function(){return g<a.length?{done:!1,value:a[g++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,g,e){if(a==Array.prototype||a==Object.prototype)return a;a[g]=e.value;return a};$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var g=0;g<a.length;++g){var e=a[g];if(e&&e.Math==Math)return e}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,g){var e=$jscomp.propertyToPolyfillSymbol[g];if(null==e)return a[g];e=a[e];return void 0!==e?e:a[g]};
$jscomp.polyfill=function(a,g,e,h){g&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,g,e,h):$jscomp.polyfillUnisolated(a,g,e,h))};$jscomp.polyfillUnisolated=function(a,g,e,h){e=$jscomp.global;a=a.split(".");for(h=0;h<a.length-1;h++){var b=a[h];if(!(b in e))return;e=e[b]}a=a[a.length-1];h=e[a];g=g(h);g!=h&&null!=g&&$jscomp.defineProperty(e,a,{configurable:!0,writable:!0,value:g})};
$jscomp.polyfillIsolated=function(a,g,e,h){var b=a.split(".");a=1===b.length;h=b[0];h=!a&&h in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var c=0;c<b.length-1;c++){var d=b[c];if(!(d in h))return;h=h[d]}b=b[b.length-1];e=$jscomp.IS_SYMBOL_NATIVE&&"es6"===e?h[b]:null;g=g(e);null!=g&&(a?$jscomp.defineProperty($jscomp.polyfills,b,{configurable:!0,writable:!0,value:g}):g!==e&&($jscomp.propertyToPolyfillSymbol[b]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(b):$jscomp.POLYFILL_PREFIX+b,b=
$jscomp.propertyToPolyfillSymbol[b],$jscomp.defineProperty(h,b,{configurable:!0,writable:!0,value:g})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(a){if(a)return a;var g=function(b,c){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:c})};g.prototype.toString=function(){return this.$jscomp$symbol$id_};var e=0,h=function(b){if(this instanceof h)throw new TypeError("Symbol is not a constructor");return new g("jscomp_symbol_"+(b||"")+"_"+e++,b)};return h},"es6","es3");$jscomp.initSymbolIterator=function(){};
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var g="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),e=0;e<g.length;e++){var h=$jscomp.global[g[e]];"function"===typeof h&&"function"!=typeof h.prototype[a]&&$jscomp.defineProperty(h.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.initSymbolAsyncIterator=function(){};$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,g){a instanceof String&&(a+="");var e=0,h={next:function(){if(e<a.length){var b=e++;return{value:g(b,a[b]),done:!1}}h.next=function(){return{done:!0,value:void 0}};return h.next()}};h[Symbol.iterator]=function(){return h};return h};
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(g){return g})}},"es6","es3");
(function(a,g){var e={rm_Add:"Add",rm_Cancel:"Cancel",rm_ConfirmDeleteAssignment:"Do you want to remove this assignment?",rm_Delete:"Delete",rm_DeletionFailed:"Deletion Failed",rm_ForEntity:"For Entity",rm_Role:"Role",rm_SubmissionFailed:"Submission Failed",rm_User:"User"},h=0;a.widget("s3.roleManager",{options:{mode:"roles",items:{},useRealms:!1,realmTypes:null,realms:null,ajaxURL:null},_create:function(){this.id=h;h+=1;this.eventNamespace=".roleManager"},_init:function(){for(var b in e)e[b]=i18n[b]||
e[b];this.refresh()},_destroy:function(){a.Widget.prototype.destroy.call(this)},refresh:function(){var b=a(this.element);this._unbindEvents();a(".rm-assign",b).remove();this.itemSelector=this.realmSelector=this.addButton=this.addRow=null;this._deserialize();b.append(this._assignmentTable());this._bindEvents()},_deserialize:function(){var b=a(this.element).attr("id"),c=a("#"+b+"-data").val();try{this.assignments=JSON.parse(c)}catch(d){this.assignments=[]}this.recordID=a("#"+b+"-id").val()},_serialize:function(){var b=
a(this.element).attr("id");a("#"+b+"-data").val(JSON.stringify(this.assignments))},_assignmentTable:function(){var b=this.options,c=a('<table class="rm-assign">');c.append(this._assignmentTableHead()).append(this._assignmentTableBody());if(b.ajaxURL){b=b.items;var d=!1,f;for(f in b)if(!1!==b[f].a){d=!0;break}d&&c.append(this._assignmentTableFooter())}return c},_assignmentTableHead:function(){var b=this.options,c=a("<thead>"),d=a("<tr>").appendTo(c);var f="users"==b.mode?e.rm_User:e.rm_Role;a("<th>").text(f).appendTo(d);
b.useRealms&&a("<th>").text(e.rm_ForEntity).appendTo(d);a("<th>").appendTo(d);return c},_assignmentTableBody:function(){var b=a("<tbody>"),c=this.assignments,d=this;c.length||b.append("<tr>");c.sort(function(f,l){return d._compareAssignments(f,l)}).forEach(function(f){b.append(d._assignmentTableRow(f))});return b},_assignmentTableRow:function(b){var c=a('<tr class="rm-assignment">').data("assignment",b),d=this.options,f=d.items[b[0]],l=a("<td>").appendTo(c);a('<span class="rm-item-name">').text(f.l).appendTo(l);
f.t&&a('<span class="rm-item-title">').text(f.t).appendTo(l);d.useRealms&&(b=!f.u&&d.realms[b[1]].l||"",a("<td>").text(b).appendTo(c));b=a("<td>");!1!==f.r&&d.ajaxURL&&(d=a('<span class="rm-delete-assignment delete-btn-ajax">'),b.append(d.text(e.rm_Delete)));return c.append(b)},_assignmentTableFooter:function(){var b=a("<tfoot>"),c=a("<tr>").appendTo(b);a("<td>").append(this._itemSelector()).appendTo(c);this.options.useRealms&&a("<td>").append(this._realmSelector()).appendTo(c);var d=a('<a class="rm-submit-add action-btn">').text(e.rm_Add),
f=a('<span class="rm-cancel-add action-lnk">').text(e.rm_Cancel);d.prop("disabled",!0).attr("disabled","disabled");a('<td class="rm-row-actions">').append(d).append(f).appendTo(c);this.addRow=c;return b},_itemSelector:function(){var b=a('<select class="rm-item-select">'),c=this.options.items,d=[];a('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(b);var f;for(f in c){var l=c[f];if(!1!==l.a){var m=l.l;l.t&&(m+=" ("+l.t+")");d.push([f,m])}}d.sort(function(k,n){return k[1]!==
n[1]&&(k[1]>n[1]&&1||-1)||0}).forEach(function(k){a("<option>").attr("value",k[0]).text(k[1]).appendTo(b)});return this.itemSelector=b},_realmSelector:function(){var b=a('<select class="rm-realm-select">'),c=this.options,d=c.realms,f=this,l={};Object.keys(d).sort(function(m,k){return f._compareRealms(m,k)}).forEach(function(m){var k=d[m],n=k.t;m=[m,k.l];k=l[n];k===g?l[n]=[m]:k.push(m)});a('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(b);c.realmTypes.forEach(function(m){var k=
l[m[0]];if(k){var n=a("<optgroup>").attr("label",m[1]).appendTo(b);k.forEach(function(p){a("<option>").attr("value",p[0]).text(p[1]).appendTo(n)})}});this.realmSelector=b;this._resetRealmSelector();return b.prop("disabled",!0).css({visibility:"hidden"})},_toggleAdd:function(b){var c=a(".rm-submit-add",this.addRow);c.length&&(b?c.prop("disabled",!1).removeAttr("disabled"):c.prop("disabled",!0).attr("disabled","disabled"))},_resetAddRow:function(){var b=a(".rm-item-select",this.addRow);b.length&&b.val("").change();
this._checkNewAssignment()},_resetRealmSelector:function(){var b=this.realmSelector;b&&(a('option[value="null"]',b).length?b.val("null"):b.val(""))},_optionSelected:function(){var b=this.options,c=this.itemSelector,d=this.realmSelector;if(c!==g)if(c=c.val()){if(b=b.items[c])d&&(b.u?(this._resetRealmSelector(),d.prop("disabled",!0).css({visibility:"hidden"})):d.prop("disabled",!1).css({visibility:"visible"})),!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)}else d&&(this._resetRealmSelector(),
d.prop("disabled",!0).css({visibility:"hidden"})),this._toggleAdd(!1)},_realmSelected:function(){!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)},_getNewAssignment:function(){var b=this.itemSelector;if(b){var c=null;if((b=b.val())&&!isNaN(b-0))return this.options.useRealms&&(c=this.realmSelector.val(),null!==c&&(c-=0,isNaN(c)&&(c=null))),[b-0,c]}},_checkNewAssignment:function(){var b=this._getNewAssignment(),c=a(".rm-assignment",a(this.element)).removeClass("rm-duplicate");
if(b){for(var d=c.length;d--;){var f=a(c[d]),l=f.data("assignment");if(b[0]===l[0]&&b[1]===l[1])return f.addClass("rm-duplicate"),!1}return b}},_addAssignment:function(){var b=this.options.ajaxURL,c=this._checkNewAssignment();if(b&&c){var d=this.addRow,f=a(".rm-submit-add",d).hide(),l=a(".rm-cancel-add",d).hide(),m=a('<div class="inline-throbber">').insertBefore(f),k=this;a.ajaxS3({type:"POST",url:b.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({add:[c]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",
success:function(){k.assignments.push(c);k._serialize();for(var n=a(".rm-assignment",a(k.element)),p=k._assignmentTableRow(c).hide(),q=n.length;q--;){var r=a(n[q]),t=r.data("assignment");if(-1==k._compareAssignments(t,c)){p.insertAfter(r).fadeIn();p=null;break}}p&&(a("tbody",d.closest(".rm-assign")).prepend(p),p.fadeIn());m.remove();f.show();l.show();k._resetAddRow()},error:function(){var n=a('<span class="rm-error">').insertBefore(m.hide());n.text(e.rm_SubmissionFailed);m.remove();window.setTimeout(function(){n.fadeOut(function(){f.show();
l.show()})},1E3)}})}},_deleteAssignment:function(b){var c=this.options,d=c.ajaxURL,f=b.data("assignment");if(d&&f){var l=e.rm_ConfirmDeleteAssignment;l=l.replace(/%\((role|user)\)s/g,'"'+c.items[f[0]].l+'"');if(confirm(l)){var m=a(".rm-delete-assignment",b).hide(),k=a('<div class="inline-throbber">').insertBefore(m),n=this;a.ajaxS3({type:"POST",url:d.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({remove:[f]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){n.assignments=
n.assignments.filter(function(p){return p[0]!==f[0]||p[1]!==f[1]});n._serialize();a(".rm-assignment",a(n.element)).each(function(){var p=a(this).data("assignment");p[0]===f[0]&&p[1]===f[1]&&a(this).fadeOut(function(){k.remove();a(this).remove();n._checkNewAssignment()&&n._toggleAdd(!0)})})},error:function(){var p=a('<span class="rm-error">').insertBefore(k.hide());p.text(e.rm_DeletionFailed);k.remove();window.setTimeout(function(){p.fadeOut(function(){m.show()})},1E3)}})}}},_compareAssignments:function(b,
c){var d=this.options.items,f=d[b[0]].l;d=d[c[0]].l;return f==d?this._compareRealms(b[1],c[1]):f>d&&1||-1},_compareRealms:function(b,c){if(b===c)return 0;var d=this.options.realms,f=this._compareRealmTypes(d[b].t,d[c].t);return f?f:b?c?d[b].l>d[c].l&&1||-1:-1:null===b&&1||null===c&&-1||1},_compareRealmTypes:function(b,c){if(b===c)return 0;var d=this.options.realmTypes.map(function(f){return f[0]});b=d.indexOf(b);c=d.indexOf(c);return b-c},_bindEvents:function(){var b=this.eventNamespace,c=this;if(this.addRow!==
g)this.addRow.on("change"+b,".rm-item-select",function(){c._optionSelected()}).on("change"+b,".rm-realm-select",function(){c._realmSelected()}).on("click"+b,".rm-cancel-add",function(){c._resetAddRow()}).on("click"+b,".rm-submit-add",function(){c._addAssignment()});a(this.element).on("click"+b,".rm-delete-assignment",function(){c._deleteAssignment(a(this).closest(".rm-assignment"))});return!0},_unbindEvents:function(){var b=a(this.element),c=this.eventNamespace;this.addRow!==g&&this.addRow.off(c);
b.off(c);return!0}})})(jQuery);
