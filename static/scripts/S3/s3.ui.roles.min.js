/*
 2018-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var f=0;return function(){return f<a.length?{done:!1,value:a[f++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,f,d){a!=Array.prototype&&a!=Object.prototype&&(a[f]=d.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.SymbolClass=function(a,f){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:f})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function a(d){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(d||"")+"_"+f++,d)}var f=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,f){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var d=0,h={next:function(){if(d<a.length){var b=d++;return{value:f(b,a[b]),done:!1}}h.next=function(){return{done:!0,value:void 0}};return h.next()}};h[Symbol.iterator]=function(){return h};return h};
$jscomp.polyfill=function(a,f,d,h){if(f){d=$jscomp.global;a=a.split(".");for(h=0;h<a.length-1;h++){var b=a[h];b in d||(d[b]={});d=d[b]}a=a[a.length-1];h=d[a];f=f(h);f!=h&&null!=f&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:f})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
(function(a,f){var d={rm_Add:"Add",rm_Cancel:"Cancel",rm_ConfirmDeleteAssignment:"Do you want to remove this assignment?",rm_Delete:"Delete",rm_DeletionFailed:"Deletion Failed",rm_ForEntity:"For Entity",rm_Role:"Role",rm_SubmissionFailed:"Submission Failed",rm_User:"User"},h=0;a.widget("s3.roleManager",{options:{mode:"roles",items:{},useRealms:!1,realmTypes:null,realms:null,ajaxURL:null},_create:function(){this.id=h;h+=1;this.eventNamespace=".roleManager"},_init:function(){for(var a in d)d[a]=i18n[a]||
d[a];this.refresh()},_destroy:function(){a.Widget.prototype.destroy.call(this)},refresh:function(){var b=a(this.element);this._unbindEvents();a(".rm-assign",b).remove();this.itemSelector=this.realmSelector=this.addButton=this.addRow=null;this._deserialize();b.append(this._assignmentTable());this._bindEvents()},_deserialize:function(){var b=a(this.element).attr("id"),c=a("#"+b+"-data").val();try{this.assignments=JSON.parse(c)}catch(e){this.assignments=[]}this.recordID=a("#"+b+"-id").val()},_serialize:function(){var b=
a(this.element).attr("id");a("#"+b+"-data").val(JSON.stringify(this.assignments))},_assignmentTable:function(){var b=this.options,c=a('<table class="rm-assign">');c.append(this._assignmentTableHead()).append(this._assignmentTableBody());if(b.ajaxURL){b=b.items;var e=!1,g;for(g in b)if(!1!==b[g].a){e=!0;break}e&&c.append(this._assignmentTableFooter())}return c},_assignmentTableHead:function(){var b=this.options,c=a("<thead>"),e=a("<tr>").appendTo(c);var g="users"==b.mode?d.rm_User:d.rm_Role;a("<th>").text(g).appendTo(e);
b.useRealms&&a("<th>").text(d.rm_ForEntity).appendTo(e);a("<th>").appendTo(e);return c},_assignmentTableBody:function(){var b=a("<tbody>"),c=this.assignments,e=this;c.length||b.append("<tr>");c.sort(function(a,b){return e._compareAssignments(a,b)}).forEach(function(a){b.append(e._assignmentTableRow(a))});return b},_assignmentTableRow:function(b){var c=a('<tr class="rm-assignment">').data("assignment",b),e=this.options,g=e.items[b[0]],f=a("<td>").appendTo(c);a('<span class="rm-item-name">').text(g.l).appendTo(f);
g.t&&a('<span class="rm-item-title">').text(g.t).appendTo(f);e.useRealms&&(b=!g.u&&e.realms[b[1]].l||"",a("<td>").text(b).appendTo(c));b=a("<td>");!1!==g.r&&e.ajaxURL&&(e=a('<span class="rm-delete-assignment delete-btn-ajax">'),b.append(e.text(d.rm_Delete)));return c.append(b)},_assignmentTableFooter:function(){var b=a("<tfoot>"),c=a("<tr>").appendTo(b);a("<td>").append(this._itemSelector()).appendTo(c);this.options.useRealms&&a("<td>").append(this._realmSelector()).appendTo(c);var e=a('<a class="rm-submit-add action-btn">').text(d.rm_Add),
g=a('<span class="rm-cancel-add action-lnk">').text(d.rm_Cancel);e.prop("disabled",!0).attr("disabled","disabled");a('<td class="rm-row-actions">').append(e).append(g).appendTo(c);this.addRow=c;return b},_itemSelector:function(){var b=a('<select class="rm-item-select">'),c=this.options.items,e=[];a('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(b);var g;for(g in c){var d=c[g];if(!1!==d.a){var f=d.l;d.t&&(f+=" ("+d.t+")");e.push([g,f])}}e.sort(function(a,b){return a[1]>
b[1]&&1||-1}).forEach(function(c){a("<option>").attr("value",c[0]).text(c[1]).appendTo(b)});return this.itemSelector=b},_realmSelector:function(){var b=a('<select class="rm-realm-select">'),c=this.options,e=c.realms,g=this,d={};Object.keys(e).sort(function(a,b){return g._compareRealms(a,b)}).forEach(function(a){var b=e[a],c=b.t;a=[a,b.l];b=d[c];b===f?d[c]=[a]:b.push(a)});a('<option value="">').prop("selected",!0).prop("disabled",!0).hide().appendTo(b);c.realmTypes.forEach(function(c){var e=d[c[0]];
if(e){var g=a("<optgroup>").attr("label",c[1]).appendTo(b);e.forEach(function(b){a("<option>").attr("value",b[0]).text(b[1]).appendTo(g)})}});this.realmSelector=b;this._resetRealmSelector();return b.prop("disabled",!0).css({visibility:"hidden"})},_toggleAdd:function(b){var c=a(".rm-submit-add",this.addRow);c.length&&(b?c.prop("disabled",!1).removeAttr("disabled"):c.prop("disabled",!0).attr("disabled","disabled"))},_resetAddRow:function(){var b=a(".rm-item-select",this.addRow);b.length&&b.val("").change();
this._checkNewAssignment()},_resetRealmSelector:function(){var b=this.realmSelector;b&&(a('option[value="null"]',b).length?b.val("null"):b.val(""))},_optionSelected:function(){var a=this.options,c=this.itemSelector,e=this.realmSelector;if(c!==f)if(c=c.val()){if(a=a.items[c])e&&(a.u?(this._resetRealmSelector(),e.prop("disabled",!0).css({visibility:"hidden"})):e.prop("disabled",!1).css({visibility:"visible"})),!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)}else e&&(this._resetRealmSelector(),
e.prop("disabled",!0).css({visibility:"hidden"})),this._toggleAdd(!1)},_realmSelected:function(){!1===this._checkNewAssignment()?this._toggleAdd(!1):this._toggleAdd(!0)},_getNewAssignment:function(){var a=this.itemSelector;if(a){var c=null;if((a=a.val())&&!isNaN(a-0))return this.options.useRealms&&(c=this.realmSelector.val(),null!==c&&(c-=0,isNaN(c)&&(c=null))),[a-0,c]}},_checkNewAssignment:function(){var b=this._getNewAssignment(),c=a(".rm-assignment",a(this.element)).removeClass("rm-duplicate");
if(b){for(var e=c.length;e--;){var g=a(c[e]),d=g.data("assignment");if(b[0]===d[0]&&b[1]===d[1])return g.addClass("rm-duplicate"),!1}return b}},_addAssignment:function(){var b=this.options.ajaxURL,c=this._checkNewAssignment();if(b&&c){var e=this.addRow,g=a(".rm-submit-add",e).hide(),f=a(".rm-cancel-add",e).hide(),h=a('<div class="inline-throbber">').insertBefore(g),k=this;a.ajaxS3({type:"POST",url:b.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({add:[c]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",
success:function(){k.assignments.push(c);k._serialize();for(var b=a(".rm-assignment",a(k.element)),d=k._assignmentTableRow(c).hide(),m=b.length;m--;){var n=a(b[m]),p=n.data("assignment");if(-1==k._compareAssignments(p,c)){d.insertAfter(n).fadeIn();d=null;break}}d&&(a("tbody",e.closest(".rm-assign")).prepend(d),d.fadeIn());h.remove();g.show();f.show();k._resetAddRow()},error:function(){var b=a('<span class="rm-error">').insertBefore(h.hide());b.text(d.rm_SubmissionFailed);h.remove();window.setTimeout(function(){b.fadeOut(function(){g.show();
f.show()})},1E3)}})}},_deleteAssignment:function(b){var c=this.options,e=c.ajaxURL,g=b.data("assignment");if(e&&g){var f=d.rm_ConfirmDeleteAssignment;f=f.replace(/%\((role|user)\)s/g,'"'+c.items[g[0]].l+'"');if(confirm(f)){var h=a(".rm-delete-assignment",b).hide(),k=a('<div class="inline-throbber">').insertBefore(h),l=this;a.ajaxS3({type:"POST",url:e.replace(/%5Bid%5D/g,this.recordID),data:JSON.stringify({remove:[g]}),dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){l.assignments=
l.assignments.filter(function(a){return a[0]!==g[0]||a[1]!==g[1]});l._serialize();a(".rm-assignment",a(l.element)).each(function(){var b=a(this).data("assignment");b[0]===g[0]&&b[1]===g[1]&&a(this).fadeOut(function(){k.remove();a(this).remove();l._checkNewAssignment()&&l._toggleAdd(!0)})})},error:function(){var b=a('<span class="rm-error">').insertBefore(k.hide());b.text(d.rm_DeletionFailed);k.remove();window.setTimeout(function(){b.fadeOut(function(){h.show()})},1E3)}})}}},_compareAssignments:function(a,
c){var b=this.options.items,d=b[a[0]].l;b=b[c[0]].l;return d==b?this._compareRealms(a[1],c[1]):d>b&&1||-1},_compareRealms:function(a,c){if(a===c)return 0;var b=this.options.realms,d=this._compareRealmTypes(b[a].t,b[c].t);return d?d:a?c?b[a].l>b[c].l&&1||-1:-1:null===a&&1||null===c&&-1||1},_compareRealmTypes:function(a,c){if(a===c)return 0;var b=this.options.realmTypes.map(function(a){return a[0]});a=b.indexOf(a);c=b.indexOf(c);return a-c},_bindEvents:function(){var b=this.eventNamespace,c=this;if(this.addRow!==
f)this.addRow.on("change"+b,".rm-item-select",function(){c._optionSelected()}).on("change"+b,".rm-realm-select",function(){c._realmSelected()}).on("click"+b,".rm-cancel-add",function(){c._resetAddRow()}).on("click"+b,".rm-submit-add",function(){c._addAssignment()});a(this.element).on("click"+b,".rm-delete-assignment",function(){c._deleteAssignment(a(this).closest(".rm-assignment"))});return!0},_unbindEvents:function(){var b=a(this.element),c=this.eventNamespace;this.addRow!==f&&this.addRow.off(c);
b.off(c);return!0}})})(jQuery);
