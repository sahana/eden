/*
 2013-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js 1.8.5 (patched)

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,u,p){b instanceof String&&(b=String(b));for(var a=b.length,d=0;d<a;d++){var c=b[d];if(u.call(p,c,d,b))return{i:d,v:c}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,u,p){b!=Array.prototype&&b!=Object.prototype&&(b[u]=p.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,u,p,a){if(u){p=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var d=b[a];d in p||(p[d]={});p=p[d]}b=b[b.length-1];a=p[b];u=u(a);u!=a&&null!=u&&$jscomp.defineProperty(p,b,{configurable:!0,writable:!0,value:u})}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,p){return $jscomp.findInternal(this,b,p).v}},"es6","es3");
(function(b,u){var p=0;b.widget("s3.pivottable",{options:{showTotals:!0,ajaxURL:null,defaultChart:{type:"breakdown",axis:"rows"},renderFilter:!0,renderOptions:!0,renderChart:!0,renderTable:!0,collapseFilter:!1,collapseOptions:!0,collapseChart:!0,collapseTable:!1,exploreChart:!1,filterURL:null,filterForm:null,filterTab:null,autoSubmit:1E3,timeout:1E4,thousandSeparator:" ",thousandGrouping:"3",minTickSize:null,precision:null,textAll:"All",labelRecords:"Records"},_create:function(){this.id=p;p+=1;this.openRequest=
this.chart=this.table=null;this.eventNamespace=".pt"},_init:function(){var a=b(this.element),d=this.options;this.table=this.data=null;this.chartOptions={currentChart:null,currentDataIndex:null,currentSeriesIndex:null,currentSpectrumIndex:null};this.table_options={hidden:!1};var c=a.find(".pt-chart");this.chart=c.length?c.first():null;d.renderFilter||d.renderOptions?(c="#"+a.attr("id"),d.renderOptions?(b(c+"-options").show(),d.collapseOptions&&(b(c+"-options legend").siblings().toggle(),b(c+"-options legend").children().toggle())):
b(c+"-options").hide(),d.renderFilter?(b(c+"-filters").show(),d.collapseFilter&&(b(c+"-filters legend").siblings().toggle(),b(c+"-filters legend").children().toggle())):b(c+"-options").hide()):a.find(".pt-form-container").hide();d.collapseTable&&(this.table_options.hidden=!0,a.find(".pt-table").hide(),a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide());d.numberFormatter=function(a){var b=d.precision;if(null===a||"undefined"==typeof a)return"-";b=b||0==b?a.toFixed(b):a.toString();b=b.split(".");
a=b[0];b=1<b.length?"."+b[1]:"";a=a.replace(new RegExp("\\B(?=(\\d{"+d.thousandGrouping+"})+(?!\\d))","g"),d.thousandSeparator);return a+b};this.refresh()},_destroy:function(){this.table&&this.table.remove();this.chart&&this.chart.empty()},refresh:function(){var a=b(this.element),d=null;this._unbindEvents();var c=a.find('input[type="hidden"][name="pivotdata"]');c.length&&(d=JSON.parse(b(c).first().val()));d?"count"==d.method&&(this.options.precision=0,this.options.minTickSize=1):(d={empty:!0},a.find(".pt-hide-table").hide(),
a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide());this.data=d;this.lookups={};d.nodata?(a.find(".pt-table").first().empty().append(b('<div class="pt-no-data">'+d.nodata+"</div>")),a.find(".pt-hide-table").hide(),a.find(".pt-show-table").hide(),a.find(".pt-export-opt").hide()):(this._renderTable(),this._renderChartOptions());this._renderChart();d.empty?a.find(".pt-empty").show():a.find(".pt-empty").hide();this.options.autoSubmit?a.find(".pt-submit").hide():a.find(".pt-submit").show();
this._bindEvents();a.find(".pt-throbber").hide()},_renderTable:function(){var a=b(this.element),d=a.find(".pt-table").first().empty();this.table=null;var c=this.data;if(!c.empty)if(this.options.renderTable){var e=c.cells.slice(0),f=c.cols,h=c.rows,k=c.total,g=c.labels,l=!1,n=!1;c=c.facts;1==c.length&&"list"!=c[0][1]&&(1==h.length&&null===h[0][4]&&(l=!0),1==f.length&&null===f[0][4]&&(n=!0));c=this.options;var r=c.showTotals,q;if(n&&r)for(f=[],q=0;q<h.length;q++)e[q]=[];else{var t=function(a,b){return"__other__"!=
f[b][0]};for(q=0;q<h.length;q++)e[q]=e[q].filter(t);f=f.filter(function(a){return"__other__"!=a[0]})}l&&r?(h=[],e=[]):(e=e.filter(function(a,b){return"__other__"!=h[b][0]}),h=h.filter(function(a){return"__other__"!=a[0]}));d=d3.select(d.get(0)).append("table").attr("class","dataTable display report");d.append("thead").call(this._renderHeader,f,g,c).call(this._renderColumns,f,g,n);l&&r||d.append("tbody").call(this._renderRows,this,h,f,g,e,c);r&&d.append("tfoot").call(this._renderFooter,h,f,g,k);this.table=
b(d.node());this.table_options.hidden?(a.find(".pt-show-table").show(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()):(a.find(".pt-show-table").hide(),a.find(".pt-hide-table").show(),a.find(".pt-export-opt").show())}else a.find(".pt-show-table").hide(),a.find(".pt-hide-table").hide(),a.find(".pt-export-opt").hide()},_renderHeader:function(a,b,c,e){a=a.append("tr");a.append("th").attr("scope","col").text(c.layer);b.length&&a.append("th").attr({scope:"col",colspan:b.length}).text(c.cols);
e.showTotals&&a.append("th").attr({scope:"col","class":"pt-totals-header pt-row-total",rowspan:2}).text(c.total);return a},_renderColumns:function(a,b,c,e){a=a.append("tr");a.append("th").attr({scope:"col","class":"pt-rows-header"}).text(c.rows);a.selectAll("th.pt-data").data(b).enter().append("th").attr({scope:"col","class":"pt-col-label"}).text(function(a){return e?"":a[4]});return a},_renderRows:function(a,b,c,e,f,h,k){c=a.selectAll("tr.pt-row").data(c).enter().append("tr").attr("class",function(a,
b){return b%2?"odd":"even"});c.append("td").text(function(a){return a[4]});c.selectAll("td.pt-cell").data(function(a,b){return h[b]}).enter().append("td").attr("class","pt-cell").each(b._renderCell,f);k.showTotals&&c.append("td").attr("class","pt-row-total").text(function(a){return a[2][0]});return c},_renderCell:function(a,d,c){d=d3.select(this);for(var e=a.i,f,h=0,k=e.length;h<k;h++){f=e[h];var g=d.append("div").attr("class","pt-cell-value");null===f?g.text(c.none):b.isArray(f)?g.append("ul").selectAll("li").data(f).enter().append("li").html(function(a){return a}):
g.text(f);1<k-h&&g.append("span").text(" / ")}(a=a.k)&&a.length&&(b(d.node()).data("recordIDs",a),d.append("div").attr("class","pt-cell-zoom"))},_renderCellRecords:function(a,d){var c=b(".pt-cell-zoom",a).removeClass("opened");a=b(".pt-cell-records",a).remove();if(d){var e=this.lookups,f=[],h,k=[];d.forEach(function(a){if(h=e[a]){if(h.constructor===Array){a=h[1];if(-1!=k.indexOf(a))return;k.push(a);h=h[0]}h&&f.push(h)}});a=b('<div class="pt-cell-records">');var g=b("<ul>").appendTo(a);f.length?(f.sort(function(a,
b){return a.localeCompare(b)}),f.forEach(function(a){b("<li>").html(a).appendTo(g)})):b("<li>").text(d.length+" "+this.options.textRecords).appendTo(g);c.addClass("opened").after(a)}},_renderFooter:function(a,b,c,e,f){b=b.length%2?"odd":"even";a=a.append("tr").attr("class",b+" pt-totals-row");a.append("th").attr({"class":"pt-totals-header",scope:"row"}).text(e.total);a.selectAll("td.pt-col-total").data(c).enter().append("td").attr("class","pt-col-total").text(function(a){return a[2][0]});a.append("td").attr("class",
"pt-total").text(f);return a},_renderChartOptions:function(){var a=b(this.element),d=a.find(".pt-chart-controls").first().empty(),c=this.data;if(!c.empty&&this.options.renderChart){c=c.labels;var e=a.attr("id");a=c.layer;var f=c.rows,h=c.cols,k=c.per,g=b('<div class="pt-chart-opts">'),l=e+"-pchart-rows",n=e+"-vchart-rows",r=e+"-hchart-rows",q=e+"-schart-rows",t=e+"-pchart-cols",m=e+"-vchart-cols",p=e+"-hchart-cols";e+="-schart-cols";a&&b(g).append(b('<span class="pt-chart-label">'+a+": </span>"));
f&&b(g).append(b('<div id="'+l+'" class="pt-chart-icon pt-pchart"/><div id="'+n+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+k+" "+f+"</span>"));h&&b(g).append(b('<div id="'+t+'" class="pt-chart-icon pt-pchart"/><div id="'+m+'" class="pt-chart-icon pt-vchart"/><span class="pt-chart-label">'+k+" "+h+"</span>"));f&&h&&b(g).append(b('<span class="pt-chart-label">| '+c.breakdown+': </span><div id="'+q+'" class="pt-chart-icon pt-schart"/><div id="'+r+'" class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+
k+" "+f+'</span><div id="'+e+'"  class="pt-chart-icon pt-schart"/><div id="'+p+'"  class="pt-chart-icon pt-hchart"/><span class="pt-chart-label">'+k+" "+h+"</span>"));b(d).append(g)}},_truncateLabel:function(a,b){return a&&a.length>b?a.substring(0,b-3).replace(/\s+$/g,"")+"...":a},_renderChart:function(a){var d=b(this.element),c=this.data;b(".pt-chart-contents",d).hide();if(d=this.chart)if(b(d).off("plothover").off("plotclick").empty(),!c.empty&&this.options.renderChart)if(!1===a)this.options.collapseChart=
!0;else{d=this.options.collapseChart;if("undefined"==typeof a||!a){if(d)return;a=this.chartOptions.currentChart}if("undefined"==typeof a||!a){if(d)return;a=this.options.defaultChart}if("undefined"!=typeof a&&a){this.options.collapseChart=!1;this.chartOptions.currentChart=a;d=a.type;a=a.axis;var e=c.labels,f=e.per,h=e.layer+" "+f+" "+e.rows;e=e.layer+" "+f+" "+e.cols;f=c.filter;var k=f[0],g=f[1];"piechart"==d?"rows"==a?this._renderPieChart(c.rows,h,k):this._renderPieChart(c.cols,e,g):"barchart"==d?
"rows"==a?this._renderBarChart(c.rows,c.facts,h,k):this._renderBarChart(c.cols,c.facts,e,g):"breakdown"==d?"rows"==a?this._renderBreakDown(c,0,h,f):this._renderBreakDown(c,1,e,f):"spectrum"==d&&this._renderSpectrum(c,a,f)}}},_renderPieChart:function(a,d,c){var e=this.chart;if(e){b(e).css({height:"360px"}).closest(".pt-chart-contents").show().css({width:"98%"});d?b(e).siblings(".pt-chart-title").html("<h4>"+d+"</h4>"):b(e).siblings(".pt-chart-title").empty();var f=[],h=0;for(d=0;d<a.length;d++){var k=
a[d];!k[1]&&0<=k[2][0]&&(f.push({index:k[0],label:k[4],value:k[2][0],key:k[3]}),h+=k[2][0])}var g=this;g.chartOptions.currentDataIndex=null;var l=function(a){var c=a.index;if(g.chartOptions.currentDataIndex!=c){g._removeChartTooltip();g.chartOptions.currentDataIndex=c;a=a.data;var d=a.value,e=d3.event;g._renderChartTooltip(e.pageX,e.pageY,'<div class="pt-tooltip-label">'+a.label+'</div><div class="pt-tooltip-text">'+(d+" ("+Math.round(d/h*100)+"%)</div>"));b(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},
c)})}};nv.addGraph(function(){var a=nv.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).labelsOutside(!1).labelType("percent").labelThreshold(.03).showLegend(!0);a.tooltip.enabled(!1);a.legend.align(!0).rightAlign(!1);a.pie.dispatch.on("elementMouseover",l).on("elementMouseout",function(){b(".pt-tooltip").remove();g.chartOptions.currentDataIndex=null;g.chartOptions.currentSeriesIndex=null});if(g.options.exploreChart&&c)a.pie.dispatch.on("elementClick",function(a){a=
a.data;g._chartExplore([["__other__"==a.index?c+"__belongs":c,a.key]])});d3.select(b(e).get(0)).append("svg").attr("class","nv").datum(f).transition().duration(1200).call(a);nv.utils.windowResize(a.update);return a})}},_renderBarChart:function(a,d,c,e){var f=this.chart;if(f){b(f).closest(".pt-chart-contents").show().css({width:"96%"});for(var h=[],k=this._truncateLabel,g,l,n,r=0;r<d.length;r++){g={key:d[r][2]};l=[];for(var q=0;q<a.length;q++)n=a[q],l.push({label:n[4],value:n[2][r],filterIndex:n[0],
filterKey:n[3]});g.values=l;h.push(g)}b(f).css({height:"360px"});c?b(f).siblings(".pt-chart-title").html("<h4>"+c+"</h4>"):b(f).siblings(".pt-chart-title").empty();var t=function(a){a=a.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},a.index)+'">'+a.label+'</div><div class="pt-tooltip-text">'+a.value+"</div></div>"},m=this,p=this.options.numberFormatter;nv.addGraph(function(){if(1<h.length){var a=nv.models.multiBarChart().x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!0).showControls(!1);
var c=a.multibar}else a=nv.models.discreteBarChart().x(function(a){return a.label}).y(function(a){return a.value}).staggerLabels(!0).showValues(!0),a.valueFormat(p),c=a.discretebar;a.tooltip.contentGenerator(t);a.yAxis.tickFormat(p);a.xAxis.tickFormat(function(a){return k(a,18)});d3.select(b(f).get(0)).append("svg").attr("class","nv").datum(h).transition().duration(500).call(a);if(m.options.exploreChart&&e)c.dispatch.on("elementClick",function(a){var b=a.data.filterKey;null===b&&(b="None");var c=
e;"__other__"==a.data.filterIndex&&(c+="__belongs");m._chartExplore([[c,b]])});nv.utils.windowResize(a.update);return a})}},_renderBreakDown:function(a,d,c,e){var f=this.chart;if(f){b(f).closest(".pt-chart-contents").show().css({width:"96%"});var h=a.cells,k=[],g=[];if(0===d){var l=a.rows;var n=a.cols;a=function(a,b){return h[k[a]][g[b]].v[0]};var r=e[0];var q=e[1]}else l=a.cols,n=a.rows,a=function(a,b){return h[g[b]][k[a]].v[0]},r=e[1],q=e[0];var t;e=[];d=[];var m=0;for(t=l.length;m<t;m++)l[m][1]||
(e.push(l[m]),k.push(m));m=0;for(t=n.length;m<t;m++)n[m][1]||(d.push(n[m]),g.push(m));var p=[];for(l=0;l<d.length;l++){n={key:d[l][4],filterIndex:d[l][0],filterKey:d[l][3]};m=[];for(t=0;t<e.length;t++)m.push({label:e[t][4],filterIndex:e[t][0],filterKey:e[t][3],value:a(t,l)});n.values=m;p.push(n)}a=Math.max(e.length*Math.max(16*(d.length+1),50)+70,360);b(f).css({height:a+"px"});c?b(f).siblings(".pt-chart-title").html("<h4>"+c+"</h4>"):b(f).siblings(".pt-chart-title").empty();var u=function(a){var b=
a.series[0];a=a.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+nv.utils.defaultColor()({},a.index)+'">'+b.key+'</div><div class="pt-tooltip-text">'+a.label+': <span class="pt-tooltip-value">'+a.value+"</span></div></div>"},z=this,v=this.options.numberFormatter,A=this._truncateLabel;nv.addGraph(function(){var a=nv.models.multiBarHorizontalChart().x(function(a){return a.label}).y(function(a){return a.value}).margin({top:20,right:20,bottom:20,left:175}).showValues(!0).duration(350).showControls(!0);
a.tooltip.contentGenerator(u);a.valueFormat(v);a.yAxis.tickFormat(v);a.xAxis.tickFormat(function(a){return A(a,24)});d3.select(b(f).get(0)).append("svg").attr("class","nv").datum(p).call(a);if(z.options.exploreChart&&r&&q)a.multibar.dispatch.on("elementClick",function(a){a=a.data;var b=d3.event.currentTarget.parentElement.__data__,c=b.filterKey;null===c&&(c="None");b="__other__"==b.filterIndex?q+"__belongs":q;var d=a.filterKey;null===d&&(d="None");z._chartExplore([["__other__"==a.filterIndex?r+"__belongs":
r,d],[b,c]])});nv.utils.windowResize(a.update);return a})}},_renderSpectrum:function(a,d,c){var e=this.chart;if(e){var f=this,h=a.cells,k=a.labels;if("rows"==d){var g=a.rows;var l=a.cols;d=k.rows;var n=k.cols;var r=c[0];var q=c[1];var p=function(a,b){return h[a][b]}}else g=a.cols,l=a.rows,d=k.cols,n=k.rows,r=c[1],q=c[0],p=function(a,b){return h[b][a]};var m=function(a,b){return null===a?l[b]:null===b?g[a]:p(a,b)},C=function(a,b){b===u&&(b="silver");for(var c=[],d,e,f=0;f<l.length;f++)d=m(null,f),
e=null===a?d[2][0]:m(a,f).v[0],!d[1]&&0<=d[2][0]&&c.push({filterIndex:d[0],filterKey:d[3],label:d[4],value:e,color:b});return c},y=[],z=0;for(c=0;c<g.length;c++){var v=m(c,null);!v[1]&&0<=v[2][0]&&(y.push({position:c,filterIndex:v[0],filterKey:v[3],label:v[4],value:v[2][0]}),z+=v[2][0])}f.chartOptions.currentDataIndex=null;b(e).removeAttr("style").closest(".pt-chart-contents").css({width:"98%",height:"auto"}).show();b(e).siblings(".pt-chart-title").empty();c=b('<div class="pt-spectrum-pie">').appendTo(e);
e=b('<div class="pt-spectrum-bar">').appendTo(e);var A=this.options.numberFormatter,H=this._truncateLabel,w=nv.models.discreteBarChart().x(function(a){return a.label}).y(function(a){return a.value}).color(["silver"]).staggerLabels(!0).showValues(!0);w.tooltip.contentGenerator(function(a){a=a.data;return'<div class="pt-tooltip"><div class="pt-tooltip-label" style="color:'+(a.color||["silver"])+'">'+a.label+'</div><div class="pt-tooltip-text">'+A(a.value)+"</div></div>"});w.valueFormat(A);w.yAxis.tickFormat(A);
w.xAxis.tickFormat(function(a){return H(a,18)});var D=d3.select(b(e).get(0)).append("svg").attr("class","nv");e=Math.floor(c.width()/2)-30;var x=nv.models.pieChart().x(function(a){return a.label}).y(function(a){return a.value}).height(280).width(e).margin({top:-20,left:20}).labelType("percent").labelThreshold(.1).showLegend(!1).donut(!0).donutRatio(.35);x.tooltip.enabled(!1);x.legend.align(!0).rightAlign(!1);x.pie.startAngle(function(a){return a.startAngle/2-Math.PI/2}).endAngle(function(a){return a.endAngle/
2-Math.PI/2});x.pie.dispatch.on("elementMouseover",function(a){var c=a.index;if(f.chartOptions.currentDataIndex!=c){f._removeChartTooltip();f.chartOptions.currentDataIndex=c;a=a.data;var d=a.value,e=d3.event;f._renderChartTooltip(e.pageX,e.pageY,'<div class="pt-tooltip-label">'+a.label+'</div><div class="pt-tooltip-text">'+(d+" ("+Math.round(d/z*100)+"%)</div>"));b(".pt-tooltip-label").css({color:nv.utils.defaultColor()({},c)})}}).on("elementMouseout",function(){b(".pt-tooltip").remove();f.chartOptions.currentDataIndex=
null;f.chartOptions.currentSeriesIndex=null});var E=d3.select(b(c).get(0)).append("svg").attr("class","nv").style({"min-width":e-30+"px"});e=d3.select(b(c).get(0)).append("div").attr("class","pt-spectrum-form");e.append("h4").html(k.layer+" "+k.per+" "+n);e.append("label").html(d+":");var B=e.append("select");B.append("option").attr("value","null").style("font-weight","bold").html(f.options.textAll);B.selectAll(".pt-series-item").data(y).enter().append("option").attr("class","pt-series-item").attr("value",
function(a,b){return b}).html(function(a){return a.label});e.append("label").html(k.total+":");var G=e.append("span").text(a.total),F=function(b){if(null===b||f.chartOptions.currentSpectrumIndex==b){var c=function(a,b){return nv.utils.defaultColor()({},b)};E.selectAll(".nv-slice").style("fill",c).style("stroke",c);c=C(null);D.datum([{key:null,filterIndex:null,filterKey:null,values:c}]);w.update();f.chartOptions.currentSpectrumIndex=null;B.property("value","null");G.text(a.total)}else{var d=y[b],e=
nv.utils.defaultColor()({},b);c=function(a,c){return c==b?e:"silver"};E.selectAll(".nv-slice").style("fill",c).style("stroke",c);c=C(d.position,e);D.datum([{key:d.position,filterIndex:d.filterIndex,filterKey:d.filterKey,values:c}]);w.update();f.chartOptions.currentSpectrumIndex=b;B.property("value",b);G.text(y[b].value)}};x.pie.dispatch.on("elementClick",function(a){F(a.index)});B.on("change.pt",function(){var a=d3.select(this).property("value");"null"==a?F(null):F(a)});nv.addGraph(function(){E.datum(y).transition().duration(1200).call(x);
nv.utils.windowResize(x.update);return x});nv.addGraph(function(){D.datum([{key:null,filterIndex:null,filterKey:null,values:C(null)}]).transition().duration(500).call(w);if(f.options.exploreChart&&r&&q)w.discretebar.dispatch.on("elementClick",function(a){var b=a.data,c=d3.event.currentTarget.parentElement.__data__;a=c.filterIndex;c=c.filterKey;var d=b.filterIndex;b=b.filterKey;var e=[];null!==a&&e.push(["__other__"==a?r+"__belongs":r,c||"None"]);null!==d&&e.push(["__other__"==d?q+"__belongs":q,b||
"None"]);f._chartExplore(e)});nv.utils.windowResize(w.update);return w})}},_chartExplore:function(a){var d=this.options,c=b(this.element).closest(".ui-tabs"),e=d.filterTab;if(c.length&&!1!==e)d=(d=d.filterForm)?b("#"+d):u,S3.search.setCurrentFilters(d,a),a=e?b("#"+e).index():0,c.tabs("option","active",a);else if(c=d.filterURL)a=this._updateURL(c,a),window.open(a,"_blank")},_cellExplore:function(a){if(b(".pt-cell-records",a).length)this._renderCellRecords(a,!1);else{var d=a.data("recordIDs");if(d.length){var c=
b.Deferred(),e=this;c.promise().then(function(){e._renderCellRecords(a,d)});var f=this._updateAjaxURL({explore:"1"},null,!0),h=this.lookups,k=d.filter(function(a){return!h.hasOwnProperty(a)});if(k.length){var g=b(".pt-cell-zoom",a).hide(),l=b('<div class="inline-throbber">');l.css({display:"inline-block"}).insertAfter(g);b.ajaxS3({type:"POST",url:f,data:JSON.stringify(k),dataType:"json",contentType:"application/json; charset=utf-8",success:function(a){b.extend(e.lookups,a);c.resolve();l.remove();
g.show()},error:function(){c.reject();l.remove();g.show()}})}else c.resolve()}}},_renderChartTooltip:function(a,d,c){b('<div class="pt-tooltip">'+c+"</div>").css({position:"absolute",display:"none",top:d-50,left:a+10,border:"1px solid #999",padding:"10px","min-height":"50px","max-width":"240px","z-index":"501","background-color":"white",color:"#000",opacity:.95}).appendTo("body").fadeIn(200)},_removeChartTooltip:function(){b(".pt-tooltip").remove();this.chartOptions.currentDataIndex=null;this.chartOptions.currentSeriesIndex=
null},_getOptions:function(){var a="#"+b(this.element).attr("id");return{rows:b(a+"-rows").val(),cols:b(a+"-cols").val(),fact:b(a+"-fact").val(),totals:b(a+"-totals").is(":checked")?1:0}},_getFilters:function(){var a="#"+b(this.element).attr("id"),d=null;a=b(a+"-filters");if(a.length)try{d=S3.search.getCurrentFilters(a.first())}catch(c){}return d},_updateURL:function(a,b){var c=[],d={},f;if(b){var h=0;for(f=b.length;h<f;h++){var k=b[h];var g=k[0];d[g]=!0;c.push(g+"="+k[1])}}b=this.options.ajaxURL.split("?");
if(1<b.length){k=b[1].split("&");b={};h=0;for(f=k.length;h<f;h++){var l=k[h].split("=");1<l.length&&(g=decodeURIComponent(l[0]),d[g]||(c.push(g+"="+decodeURIComponent(l[1])),b[g]=!0))}for(g in b)d[g]=!0}b=a.split("?");if(1<b.length)for(k=b[1].split("&"),h=0,f=k.length;h<f;h++)l=k[h].split("="),1<l.length&&(g=decodeURIComponent(l[0]),d[g]||c.push(g+"="+decodeURIComponent(l[1])));a=c.join("&");c=b[0];a&&(c=c+"?"+a);return c},_updateAjaxURL:function(a,d,c){var e=this.options.ajaxURL.split("?"),f=[],
h=!1;if(1<e.length){var k=e[1];k=k.split("&")}else k="",k=[];if(a)for(n in a){var g=a[n];var l=n+"="+g;"totals"==n?this.options.showTotals=g?!0:!1:h||-1!=b.inArray(l,k)||(h=!0);f.push(l)}var n={};var p={},q;if(d){var t=function(a){var b,c,d=[];["contains","anyof","belongs","eq"].forEach(function(e){b=new RegExp("__"+e+"$","g");a.match(b)?c=b:d.push(e)});c&&d.forEach(function(b){p[a.replace(c,"__"+b)]=!0})};g=0;for(q=d.length;g<q;g++){l=d[g];var m=l[0];l=l[1];t(m);null===l?n[m]||(p[m]=!0):(p[m]&&(p[m]=
!1),l=m+"="+encodeURIComponent(l),n[m]?n[m].push(l):n[m]=[l])}}g=0;for(q=k.length;g<q;g++)l=k[g].split("="),1<l.length&&(m=decodeURIComponent(l[0]),l=decodeURIComponent(l[1]),p[m]?h=!0:n[m]?h||-1!=b.inArray(m+"="+l,n[m])||(h=!0):"aggregate"!=m&&(a&&a.hasOwnProperty(m)||f.push(k[g])));for(m in n)for(g=0,q=n[m].length;g<q;g++)h||-1!=b.inArray(n[m][g],k)||(h=!0),f.push(n[m][g]);a=f.join("&");e=e[0];a&&(e=e+"?"+a);if(c)return e;this.options.ajaxURL=e;return h},_setExtension:function(a,b){var c=document.createElement("a");
c.href=a;a=c.pathname.split("/");var d=[];a.length&&(a.forEach(function(a){var b=a.lastIndexOf(".");-1!=b?d.push(a.slice(0,b)):d.push(a)}),d[d.length-1]+="."+b,c.pathname=d.join("/"));var f=c.search;f&&(d=f.slice(1).split().filter(function(a){return"format"!=a.split("=")[0]}),a.length||d.push("format="+b),c.search="?"+d.join("&"));return c.href},reload:function(a,d,c){c="undefined"!=typeof c?c:!0;"undefined"==typeof d&&(d=this._getFilters());var e=this,f=this.element,h=f.find('input[type="hidden"][name="pivotdata"]');
if(h.length){f.find(".pt-throbber").show();if(a||d)var k=this._updateAjaxURL(a,d);k||c?(a=this.options.ajaxURL,d=this.options.timeout,c=b.ajaxS3,b.searchS3!==u&&(c=b.searchS3),f.find(".pt-empty").hide(),e.openRequest&&(e.openRequest.onreadystatechange=null,e.openRequest.abort()),e.openRequest=c({timeout:d,url:a,dataType:"json",type:"GET",success:function(a){e.openRequest=null;h.first().val(JSON.stringify(a));e.refresh()},error:function(a,b,c){console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:
a.responseText)}})):e.refresh()}},_downloadXLS:function(){if(this.element.find('input[type="hidden"][name="pivotdata"]').length){var a=this._getOptions(),d=this._getFilters();a=this._updateAjaxURL(a,d,!0);a=this._setExtension(a,"xls");b.searchDownloadS3!==u?b.searchDownloadS3(a,"_blank"):window.open(a)}},_bindEvents:function(){var a=this,d=b(this.element),c=this.eventNamespace,e="#"+d.attr("id");b(e+"-options legend").on("click"+c,function(){b(this).siblings().toggle();b(this).children().toggle()});
b(e+"-filters legend").on("click"+c,function(){b(this).siblings().toggle();b(this).children().toggle()});b(".pt-hide-table",d).on("click"+c,function(){a.table_options.hidden=!0;b(".pt-table",d).hide();b(".pt-export-opt",d).hide();b(this).hide().siblings(".pt-show-table").show()});b(".pt-show-table",d).on("click"+c,function(){a.table_options.hidden=!1;b(".pt-table",d).show();b(".pt-export-opt",d).show();b(this).hide().siblings(".pt-hide-table").show()});b(".pt-export-xls",d).on("click"+c,function(){a._downloadXLS()});
b(e+"-totals").on("click"+c,function(){var c=b(this).is(":checked");a.options.showTotals!=c&&a.reload({totals:c},null,!1)});b(e+"-rows,"+e+"-cols,"+e+"-fact").on("change.autosubmit",function(){b(e+"-pt-form").trigger("optionChanged")});if(this.options.autoSubmit){var f=this.options.autoSubmit;b(e+"-pt-form").on("optionChanged",function(){var c=b(this);if(!c.data("noAutoSubmit")){var d=c.data("autoSubmitTimeout");d&&clearTimeout(d);d=setTimeout(function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,
c,!1)},f);c.data("autoSubmitTimeout",d)}})}else b(e+"-pt-form input.pt-submit").on("click"+c,function(){var b=a._getOptions(),c=a._getFilters();a.reload(b,c,!1)});b(e+" .pt-table .pt-cell-zoom").on("click"+c,function(c){c=b(c.currentTarget).closest(".pt-cell");c.length&&a._cellExplore(c)});b(e+"-pchart-rows").on("click"+c,function(){a._renderChart({type:"piechart",axis:"rows"})});b(e+"-vchart-rows").on("click"+c,function(){a._renderChart({type:"barchart",axis:"rows"})});b(e+"-schart-rows").on("click"+
c,function(){a._renderChart({type:"spectrum",axis:"rows"})});b(e+"-hchart-rows").on("click"+c,function(){a._renderChart({type:"breakdown",axis:"rows"})});b(e+"-pchart-cols").on("click"+c,function(){a._renderChart({type:"piechart",axis:"cols"})});b(e+"-vchart-cols").on("click"+c,function(){a._renderChart({type:"barchart",axis:"cols"})});b(e+"-schart-cols").on("click"+c,function(){a._renderChart({type:"spectrum",axis:"cols"})});b(e+"-hchart-cols").on("click"+c,function(){a._renderChart({type:"breakdown",
axis:"cols"})});b(".pt-hide-chart",d).on("click"+c,function(){a._renderChart(!1)})},_unbindEvents:function(){var a=b(this.element),d="#"+a.attr("id"),c=this.eventNamespace;b(d+" .pt-table .pt-cell-zoom").off(c);b(d+"-options legend").off(c);b(d+"-filters legend").off(c);b(d+"-totals").off(c);b(d+"-rows,"+d+"-cols,"+d+"-fact").off("change.autosubmit");b(d+"-pt-form").off("optionChanged");b("input.pt-submit, .pt-export-xls",a).off(c);b(d+"-pchart-rows,"+d+"-vchart-rows,"+d+"-schart-rows,"+d+"-hchart-rows,"+
d+"-pchart-cols,"+d+"-vchart-cols,"+d+"-schart-cols,"+d+"-hchart-cols").off(c);b(".pt-hide-table, .pt-show-table, .pt-hide-chart",a).off(c)}})})(jQuery);
