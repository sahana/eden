/*
 2018-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires moment.js
 requires jQuery fullCalendar plugin
 requires qTip2
 requires jQuery UI datepicker
*/
(function(d,r){function q(){this.items={};this.slices=[]}var t=0;q.prototype.store=function(a,c,b){var e={};b.forEach(function(a){this.items[a.id]=e[a.id]=a},this);b=this.slices;a=[moment(a),moment(c),e];b.push(a);b.sort(function(a,b){return a[0].isBefore(b[0])?-1:b[0].isBefore(a[0])?1:a[1].isBefore(b[1])?-1:b[1].isBefore(a[1])?1:0});if(1<b.length){var f=[];a=b.reduce(function(a,b){return a[1].isBefore(b[0])||a[0].isAfter(b[1])?(f.push(a),b):[moment.min(a[0],b[0]),moment.max(a[1],b[1]),d.extend({},
a[2],b[2])]});f.push(a);this.slices=f}};q.prototype.retrieve=function(a,c){a=moment(a);c=moment(c);for(var b=this.slices,e=b.length,f,d,k=[],g=0;g<e;g++)if(f=b[g],f[0].isSameOrBefore(a)&&f[1].isSameOrAfter(c)){b=f[2];for(d in b)if(e=b[d],f=moment(e.start),!f.isAfter(c)){if(e.end){if(moment(e.end).isBefore(a))continue}else if(f.isSameOrBefore(moment(a).subtract(1,"days")))continue;k.push(e)}return k}return null};q.prototype.updateItem=function(a,c){(a=this.items[a])&&c&&d.extend(a,c)};q.prototype.deleteItem=
function(a){this.slices.forEach(function(c){delete c[2][a]});delete this.items[a]};q.prototype.clear=function(){this.slices=[];this.items={}};d.widget("s3.organizer",{options:{locale:"en",timeout:1E4,resources:null,aspectRatio:1.8,nowIndicator:!0,slotDuration:"00:30:00",snapDuration:"00:15:00",defaultTimedEventDuration:"00:30:00",businessHours:!1,timeFormat:null,labelEdit:"Edit",labelDelete:"Delete",deleteConfirmation:"Do you want to delete this entry?",firstDay:1},_create:function(){this.id=t;t+=
1;this.eventNamespace=".organizer"},_init:function(){this.openRequest=null;this.loadCount=-1;this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.options,c=a.resources,b=d(this.element),e=b.attr("id");this._unbindEvents();var f=!1,h=!1;c.forEach(function(a){a.insertable&&(f=!0);a.useTime||(h=!0)});if(a.useTime){var k="month,agendaWeek,agendaDay reload";var g="agendaWeek"}else k="month,basicWeek reload",g="month";var l=this,p=d("#"+e+"-date-picker");
d(this.element).fullCalendar({aspectRatio:a.aspectRatio,nowIndicator:a.nowIndicator,slotDuration:a.slotDuration,snapDuration:a.snapDuration,displayEventEnd:!1,defaultTimedEventDuration:a.defaultTimedEventDuration,allDaySlot:h,firstDay:a.firstDay,timeFormat:a.timeFormat,slotLabelFormat:a.timeFormat,businessHours:a.businessHours,selectable:f,editable:!0,eventDrop:function(a,b,c){l._updateItem(a,c)},eventResize:function(a,b,c){l._updateItem(a,c)},customButtons:{reload:{text:"",click:function(){l.reload()}},
calendar:{text:"",click:function(){p.datepicker("show")}}},header:{left:k,center:"title",right:"calendar today prev,next"},defaultView:g,eventRender:function(a,b){l._eventRender(a,b)},eventDestroy:function(a,b){l._eventDestroy(a,b)},select:function(a,b,c){l._selectDate(a,b,c)},unselect:function(){d(l.element).qtip("destroy",!0)},unselectCancel:".s3-organizer-create",locale:a.locale,timezone:"local"});this.reloadButton=d(".fc-reload-button").html('<i class="fa fa-refresh">');e=d(".fc-calendar-button").html('<i class="fa fa-calendar">');
p.datepicker("option",{showOn:"focus",showButtonPanel:!0,firstDay:a.firstDay}).insertBefore(e).on("change",function(){var a=p.datepicker("getDate");a&&b.fullCalendar("gotoDate",a)});a=d('<div class="inline-throbber">').css({visibility:"hidden"});d(".fc-header-toolbar .fc-left",this.element).append(a);this.throbber=a;this.resources=[];c&&c.forEach(function(a,b){this._addResource(a,b)},this);this._bindEvents()},_addResource:function(a,c){var b=d.extend({},a,{_cache:new q});this.resources.push(b);a=
b.timeout;a===r&&(a=this.options.timeout);var e=this;d(this.element).fullCalendar("addEventSource",{id:""+c,allDayDefault:!b.useTime,editable:!!b.editable,startEditable:!!b.startEditable,durationEditable:!!b.end&&!!b.durationEditable,events:function(a,c,d,g){e._fetchItems(b,a,c,d,g)}})},_eventRender:function(a,c){var b=this;d(c).qtip({content:{title:function(c,d){return b._itemTitle(a,d)},text:function(c,d){return b._itemDisplay(a,d)},button:!0},position:{at:"center right",my:"left center",effect:!1,
viewport:d(window),adjust:{method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"click mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}})},_eventDestroy:function(a,c){d(c).qtip("destroy",!0)},_itemTitle:function(a){var c=[a.start.format(a.allDay&&"L"||"L LT")];a.end&&(a=moment(a.end).endOf("minute"),c.push(a.format("LT")));return c.join(" - ")},_itemDisplay:function(a,c){var b=d('<div class="s3-organizer-popup">'),e=this.options,f=e.resources[a.source.id];d("<h6>").html(a.popupTitle).appendTo(b);
var h=f.columns,k=a.description;h&&k&&h.forEach(function(a){var c=a[0];a=a[1];k[c]!==r&&(a&&d("<label>").text(a).appendTo(b),d("<p>").html(k[c]).appendTo(b))});var g=d(this.element).attr("id");h=this.eventNamespace;var l=this,p=[],m=f.baseURL;if(m){if(f.editable&&!1!==a.editable){var n=document.createElement("a");n.href=m;n.pathname+="/"+a.id+"/update.popup";n.search=n.search?n.search+("&refresh="+g):"?refresh="+g;g=d('<a class="action-btn s3_modal">').text(e.labelEdit).attr("href",n.href);g.on("click"+
h,function(){c.hide()});p.push(g)}f.deletable&&!1!==a.deletable&&(g=d('<a class="action-btn delete-btn-ajax">').text(e.labelDelete),g.on("click"+h,function(){confirm(e.deleteConfirmation)&&(c.hide(),l._deleteItem(a,function(){c.destroy()}));return!1}),p.push(g))}p.length&&d("<div>").append(p).appendTo(b);return b},_selectDate:function(a,c,b){var e=this;d(this.element).qtip({content:{text:function(b,d){return e._selectResource(a,c,b,d)}},position:{target:"mouse",at:"center right",my:"left center",
effect:!1,viewport:d(window),adjust:{mouse:!1,method:"flip shift"}},show:{event:"click",solo:!0},hide:{event:"mouseleave",delay:800,fixed:!0},events:{visible:function(){S3.addModals()}}});d(this.element).qtip("show",b)},_selectResource:function(a,c,b,e){e.set("style.classes","s3-organizer-create");b=this.options.resources;var f=this.eventNamespace,h=d(this.element).attr("id"),k=d("<div>");b.forEach(function(b){if(b.insertable){var g=d('<a class="action-btn s3_modal">'),p=b.labelCreate,m=b.baseURL;
if(m&&p){b=g.get(0);var n=[];b.href=m;b.pathname+="/create.popup";h&&n.push("refresh="+encodeURIComponent(h));m=a.toISOString()+"--"+moment(c).subtract(1,"seconds").toISOString();n.push("organizer="+encodeURIComponent(m));b.search=b.search?b.search+("&"+n.join("&")):"?"+n.join("&");g.text(p).appendTo(k).on("click"+f,function(){e.hide()})}}});return k},_fetchItems:function(a,c,b,e,f){if(e=a._cache.retrieve(c,b))f(e);else{e=this.options;this._showThrobber();var h;a.filterForm?h=d("#"+a.filterForm):
e.filterForm&&(h=d("#"+e.filterForm));var k=S3.search.getCurrentFilters(h).filter(function(b){b=b[0].split("__")[0];return b!==a.start&&b!==a.end});if(h=a.ajaxURL){h=S3.search.filterURL(h,k);k=encodeURIComponent(c.toISOString()+"--"+b.toISOString());h=-1!=h.indexOf("?")?h+("&$interval="+k):h+("?$interval="+k);k=a.timeout;var g=d.ajaxS3;k===r&&(k=e.timeout);d.searchS3!==r&&(g=d.searchS3);if(e=a.openRequest)e.onreadystatechange=null,e.abort();var l=this;a.openRequest=g({timeout:k,url:h,dataType:"json",
type:"GET",success:function(d){d=l._decodeServerData(a,d);l._hideThrobber();a._cache.store(c,b,d);f(d)},error:function(a,b,c){l._hideThrobber();console.log("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}}},_decodeServerData:function(a,c){var b=c.c;c=c.r;var e=[],f=0,h=a.colors;b&&b.constructor===Array&&(f=b.length);c.forEach(function(c){var g={},l=c.d;if(f&&l&&l.constructor===Array){var k=l.length;if(k<=f)for(var m=0;m<k;m++)g[b[m]]=l[m]}(l=c.e)&&(l=a.useTime?moment(l).add(1,"seconds").toISOString():
moment(l).add(1,"days").startOf("day").toISOString());k=c.t;g={id:c.id,title:d("<div>").html(k).text(),popupTitle:k,start:c.s,end:l,description:g};c.pe||(g.editable=!1);c.pd||(g.deletable=!1);h&&c.c&&(c=h[c.c],c!==r&&(g.color=c));e.push(g)});return e},_updateItem:function(a,c){var b=this.resources[a.source.id],d=this,f={id:a.id,s:a.start.toISOString()};b.end&&(f.e=b.useTime?moment(a.end).subtract(1,"seconds").toISOString():moment(a.end).subtract(1,"days").endOf("day").toISOString());this._sendItems(b,
{u:[f]},function(){b.reloadOnUpdate?d.reload():b._cache.updateItem(a.id,{start:a.start,end:a.end})},c)},_deleteItem:function(a,c){var b=this.resources[a.source.id],e={id:a.id},f=d(this.element);this._sendItems(b,{d:[e]},function(){f.fullCalendar("removeEvents",function(b){return b.source.id==a.source.id&&b.id==a.id});b._cache.deleteItem(a.id);"function"===typeof c&&c()})},_sendItems:function(a,c,b,e){var f=d('input[name="_formkey"]',this.element).val();c=JSON.stringify(d.extend({k:f},c));this._showThrobber();
var h=this;d.ajaxS3({type:"POST",url:a.ajaxURL,data:c,dataType:"json",retryLimit:0,contentType:"application/json; charset=utf-8",success:function(){"function"===typeof b&&b();h._hideThrobber()},error:function(){"function"===typeof e&&e();h._hideThrobber()}})},reload:function(){this.resources.forEach(function(a){a._cache.clear()});d(this.element).fullCalendar("refetchEvents")},_showThrobber:function(){this.reloadButton.prop("disabled",!0);this.throbber.css({visibility:"visible"})},_hideThrobber:function(){this.throbber.css({visibility:"hidden"});
this.reloadButton.prop("disabled",!1)},_bindEvents:function(){return!0},_unbindEvents:function(){return!0}})})(jQuery);
