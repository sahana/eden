(function(a,y){function r(b){b=b.find("[name=_formname]").val();if("undefined"!=typeof b){if("cap_alert"==b.substring(0,9))return"cap_alert";if("cap_info"==b.substring(0,8))return"cap_info"}return""}function w(){return 0<a(".cap_info_template_form").length}function u(b){return"cap_alert"==b?["codes","note","incidents"]:"cap_info"==b?"category event response_type urgency severity certainty audience event_code effective onset expires sender_name headline description instruction contact web parameter".split(" "):
[]}function z(b){function q(c,g){var f=r(b),h=u(f),n={};"undefined"==typeof g&&(g=!1);if(c)"cap_alert"==f?(p=c.$_cap_alert&&c.$_cap_alert[0]||{},n=a.parseJSON(p.template_settings)||{},a(".cap_alert_form").addClass("template_loaded")):"cap_info"==f&&(p=c.$_cap_info&&c.$_cap_info[0]||{},n={});else{var p={};n={}}a.each(h,function(t,k){try{var l=b.find("[name="+k+"]"),v=n.locked&&n.locked[k];switch(typeof p[k]){case "string":"restriction"==k?(l.val(p[k]||""),""!=l.val()&&d.show()):(e.show(),d.hide());
case "undefined":if(l.is(":text")||l.is("textarea")||l.is("select"))(g||v)&&l.val(p[k]||""),v?l.prop("disabled",!0).attr("title","This field is locked by the template"):l.prop("disabled",!1).attr("title","");break;case "object":var x=["scope","addresses","codes"];for(t=0;t<x.length;t++)k==x[t]&&l.val(p[k]["@value"]||"");"incidents"==k&&(g||v)&&(l.val(p[k]["@value"]||""),a("select#cap_alert_incidents").multiselect("refresh"))}}catch(A){s3_debug("ERROR",A)}})}function m(c,g,f){if(c){"undefined"==typeof f&&
(f="template");var h=new RegExp(".*\\"+S3.Ap+"\\/");h=(new String(self.location)).replace(h,"").split("?")[0].split("/")[0];c=[S3.Ap,h,f,c].join("/")+".s3json";a.ajax({url:c,type:"GET",dataType:"json",success:function(n){q(n,g)},error:function(n){alert("There was an unexpected error loading template data")}})}}var d=a("#cap_alert_restriction__row, #cap_alert_restriction__row1"),e=a("#cap_alert_addresses__row, #cap_alert_addresses__row1");"Restricted"==a("#cap_alert_scope").val()?(d.show(),e.hide()):
("Public"==a("#cap_alert_scope").val()||"Private"==a("#cap_alert_scope").val()?e.show():e.hide(),d.hide());a("#cap_alert_scope").change(function(){switch(a(this).val()){case "Public":d.hide();a("#cap_alert_restriction").val()&&a("#cap_alert_restriction").val("");e.show();break;case "Restricted":e.hide();a("#cap_alert_addresses").val()&&a("#cap_alert_addresses").val("");d.show();break;case "Private":d.hide();a("#cap_alert_restriction").val()&&a("#cap_alert_restriction").val("");e.show();break;case "":e.hide(),
d.hide()}});a("#cap_info_priority").change(function(){if(a(this).val()){var c=S3.cap_priorities,g=c.length;"Undefined"==a(this).find("option:selected").text()&&(a(this).css("border","2px solid gray"),b.find("[name=urgency]").val(""),b.find("[name=severity]").val(""),b.find("[name=certainty]").val(""));for(var f=0;f<g;f++)c[f][0]==a(this).find("option:selected").text()&&(b.find("[name=urgency]").val(c[f][1]),b.find("[name=severity]").val(c[f][2]),b.find("[name=certainty]").val(c[f][3]),a(this).css("border",
"2px solid #"+c[f][4]))}else a(this).css("border","1px solid gray")});b.find("[name=template_id]").change(function(){m(a(this).val(),!0)});"cap_alert"!=r(b)||0<a(".cap_template_form").length||m(b.find("[name=template_id]").val());"cap_info"!=r(b)||w()||m(b.find("[name=template_info_id]").val(),!1,"info");window.apply_temp=m}function B(b){function q(){try{return a.parseJSON(b.find("[name=template_settings]").val())||{}}catch(d){return s3_debug("Error occured parsing: ",b.find("[name=template_settings]").val()),
{}}}function m(d,e){var c="can_edit-"+d,g=a('<label for="'+c+'">'+(i18n.cap_locked||"Locked")+"</label>");c=a('<input type="checkbox" name="'+c+'"/>');c.change(function(){var h=q();h.locked=h.locked||{};h.locked[d]=a(this).is(":checked");b.find("[name=template_settings]").val(y.stringify(h))});var f=q();f.locked&&f.locked[d]&&c.prop("checked","checked");e.append(g);e.append(c)}b.find("[name=is_template]").prop("checked","checked");tablename=r(b);fields=u(tablename);b.find("tr").each(function(){var d=
a(this),e=d.attr("id");e&&e.match("__row$")&&(e=e.replace(tablename+"_","").replace("__row",""),d=d.find("td.w2p_fc")||d.find("td").eq(1),0<=fields.indexOf(e)&&m(e,d))})}var D=function(){a(".cap-clone-update").unbind(".cap").bind("click.cap",function(){C(a(this).attr("data"))})},C=function(b){var q=b.split("/")[0];(b=b.split("/").pop())&&a.ajax({url:S3.Ap.concat("/cap/alert/")+b+"/clone?msg_type="+q,success:function(m){window.location.href=S3.Ap.concat("/cap/alert/")+m.message},error:function(m,d,
e){console.log("UNAUTHORIZED"==e?i18n.gis_requires_login:m.responseText)},type:"POST",dataType:"json"})};window.fields=u;a(document).ready(function(){a("form").each(function(){""!==r(a(this))&&(z(a(this)),(0<a(".cap_template_form").length||w())&&B(a(this)))});D()})})(jQuery,JSON,void 0);
