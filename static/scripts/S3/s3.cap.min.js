(function(a,q){function l(a){a=a.find("[name=_formname]").val();if("undefined"!=typeof a){if("cap_alert"==a.substring(0,9))return"cap_alert";if("cap_info"==a.substring(0,8))return"cap_info"}return""}function p(){return 0<a(".cap_info_template_form").length}function n(a){return"cap_alert"==a?"sent status msg_type source scope restriction addresses codes note reference incidents".split(" "):"cap_info"==a?"category event response_type urgency severity certainty audience event_code effective onset expires sender_name headline description instruction contact web parameter".split(" "):
[]}function r(b){function k(c,h){var d=l(b),f=n(d),m,k={};"undefined"==typeof h&&(h=!1);c?"cap_alert"==d?(m=c.$_cap_alert&&c.$_cap_alert[0]||{},k=a.parseJSON(m.template_settings)||{},a(".cap_alert_form").addClass("template_loaded")):"cap_info"==d&&(m=c.$_cap_info&&c.$_cap_info[0]||{},k={}):(m={},k={});a.each(f,function(c,d){try{var f=b.find("[name="+d+"]"),l=k.locked&&k.locked[d];switch(typeof m[d]){case "string":"restriction"==d?(f.val(m[d]||""),""!=f.val()&&g.show()):(e.show(),g.hide());case "undefined":if(f.is(":text")||
f.is("textarea")||f.is("select"))(h||l)&&f.val(m[d]||""),l?f.prop("disabled",!0).attr("title","This field is locked by the template"):f.prop("disabled",!1).attr("title","");break;case "object":var n=["scope","addresses","codes"];for(c=0;c<n.length;c++)d==n[c]&&f.val(m[d]["@value"]||"");"incidents"==d&&(h||l)&&(f.val(m[d]["@value"]||""),a("select#cap_alert_incidents").multiselect("refresh"))}}catch(p){s3_debug("ERROR",p)}})}function h(c,b,d){if(c){"undefined"==typeof d&&(d="template");var f=new RegExp(".*\\"+
S3.Ap+"\\/"),f=(new String(self.location)).replace(f,"").split("?")[0].split("/")[0];c=[S3.Ap,f,d,c].join("/")+".s3json";a.ajax({url:c,type:"GET",dataType:"json",success:function(a){k(a,b)},error:function(a){alert("There was an unexpected error loading template data")}})}}var g=a("#cap_alert_restriction__row, #cap_alert_restriction__row1"),e=a("#cap_alert_addresses__row, #cap_alert_addresses__row1");"Restricted"==a("#cap_alert_scope").val()?(g.show(),e.hide()):(e.hide(),g.hide());a("#cap_alert_scope").change(function(){switch(a(this).val()){case "Public":g.hide();
a("#cap_alert_restriction").val()&&a("#cap_alert_restriction").val("");e.show();break;case "Restricted":e.hide();g.show();break;case "Private":g.hide();a("#cap_alert_restriction").val()&&a("#cap_alert_restriction").val("");e.show();break;case "":e.hide(),g.hide()}});a("#cap_info_priority").change(function(){if(a(this).val()){var c=S3.cap_priorities,g=c.length;"Undefined"==a(this).find("option:selected").text()&&(a(this).css("border","2px solid gray"),b.find("[name=urgency]").val(""),b.find("[name=severity]").val(""),
b.find("[name=certainty]").val(""));for(var d=0;d<g;d++)c[d][0]==a(this).find("option:selected").text()&&(b.find("[name=urgency]").val(c[d][1]),b.find("[name=severity]").val(c[d][2]),b.find("[name=certainty]").val(c[d][3]),a(this).css("border","2px solid #"+c[d][4]))}else a(this).css("border","1px solid gray")});b.find("[name=template_id]").change(function(){h(a(this).val(),!0)});"cap_alert"!=l(b)||0<a(".cap_template_form").length||h(b.find("[name=template_id]").val());"cap_info"!=l(b)||p()||h(b.find("[name=template_info_id]").val(),
!1,"info");window.apply_temp=h}function t(b){function k(){try{return a.parseJSON(b.find("[name=template_settings]").val())||{}}catch(g){return s3_debug("Error occured parsing: ",b.find("[name=template_settings]").val()),{}}}function h(g,e){var c="can_edit-"+g,h=a('<label for="'+c+'">'+(i18n.cap_locked||"Locked")+"</label>"),c=a('<input type="checkbox" name="'+c+'"/>');c.change(function(){var c=k();c.locked=c.locked||{};c.locked[g]=a(this).is(":checked");b.find("[name=template_settings]").val(q.stringify(c))});
var d=k();d.locked&&d.locked[g]&&c.prop("checked","checked");e.append(h);e.append(c)}b.find("[name=is_template]").prop("checked","checked");tablename=l(b);fields=n(tablename);b.find("tr").each(function(){var b=a(this),e=b.attr("id");e&&e.match("__row$")&&(e=e.replace(tablename+"_","").replace("__row",""),b=b.find("td.w2p_fc")||b.find("td").eq(1),0<=fields.indexOf(e)&&h(e,b))})}var v=function(){a(".cap-clone-update").unbind(".cap").bind("click.cap",function(){u(a(this).attr("data"))})},u=function(b){var k=
b.split("/")[0];(b=b.split("/").pop())&&a.ajax({url:S3.Ap.concat("/cap/alert/")+b+"/clone?msg_type="+k,success:function(a){window.location.href=S3.Ap.concat("/cap/alert/")+a.message},error:function(a,b,e){console.log("UNAUTHORIZED"==e?i18n.gis_requires_login:a.responseText)},type:"POST",dataType:"json"})};window.fields=n;a(document).ready(function(){a("form").each(function(){""!==l(a(this))&&(r(a(this)),(0<a(".cap_template_form").length||p())&&t(a(this)))});v()})})(jQuery,JSON,void 0);
