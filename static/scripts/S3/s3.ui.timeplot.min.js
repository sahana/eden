/*
 2013-2020 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires D3.js 3.4.9+
 requires NVD3.js

*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,h,g){b instanceof String&&(b=String(b));for(var a=b.length,c=0;c<a;c++){var d=b[c];if(h.call(g,d,c,b))return{i:c,v:d}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,h,g){if(b==Array.prototype||b==Object.prototype)return b;b[h]=g.value;return b};$jscomp.getGlobal=function(b){b=["object"==typeof globalThis&&globalThis,b,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var h=0;h<b.length;++h){var g=b[h];if(g&&g.Math==Math)return g}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(b,h){var g=$jscomp.propertyToPolyfillSymbol[h];if(null==g)return b[h];g=b[g];return void 0!==g?g:b[h]};
$jscomp.polyfill=function(b,h,g,a){h&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(b,h,g,a):$jscomp.polyfillUnisolated(b,h,g,a))};$jscomp.polyfillUnisolated=function(b,h,g,a){g=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var c=b[a];if(!(c in g))return;g=g[c]}b=b[b.length-1];a=g[b];h=h(a);h!=a&&null!=h&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:h})};
$jscomp.polyfillIsolated=function(b,h,g,a){var c=b.split(".");b=1===c.length;a=c[0];a=!b&&a in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var d=0;d<c.length-1;d++){var e=c[d];if(!(e in a))return;a=a[e]}c=c[c.length-1];g=$jscomp.IS_SYMBOL_NATIVE&&"es6"===g?a[c]:null;h=h(g);null!=h&&(b?$jscomp.defineProperty($jscomp.polyfills,c,{configurable:!0,writable:!0,value:h}):h!==g&&(void 0===$jscomp.propertyToPolyfillSymbol[c]&&($jscomp.propertyToPolyfillSymbol[c]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(c):
$jscomp.POLYFILL_PREFIX+c),c=$jscomp.propertyToPolyfillSymbol[c],$jscomp.defineProperty(a,c,{configurable:!0,writable:!0,value:h})))};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(h,g){return $jscomp.findInternal(this,h,g).v}},"es6","es3");
(function(b,h){var g=0;b.widget("s3.timeplot",{options:{ajaxURL:null,autoSubmit:1E3,burnDown:!1,emptyMessage:"No data available",thousandSeparator:" ",thousandGrouping:"3",precision:null,defaultChartType:"linechart",defaultChartAxis:"totals"},_create:function(){this.id=g;g+=1},_init:function(){var a=b(this.element),c=this.options;this.widget_id=a.attr("id");this.input=a.find('input[type="hidden"][name="tp-data"]').first();this.svg=this.data=null;a=a.find(".tp-chart");this.chart=a.length?a.first():
null;this.currentChart={type:null,chart:null,container:null};c.numberFormatter=function(d){var e=c.precision;if(null===d||"undefined"==typeof d)return"-";e=e||0==e?d.toFixed(e):d.toString();e=e.split(".");d=e[0];e=1<e.length?"."+e[1]:"";d=d.replace(new RegExp("\\B(?=(\\d{"+c.thousandGrouping+"})+(?!\\d))","g"),c.thousandSeparator);return d+e};this.refresh()},_destroy:function(){var a=this.element;this._unbindEvents();this.svg&&(this.svg.remove(),this.svg=null,a.find(".tp-chart").empty());this.data=
null;b.Widget.prototype.destroy.call(this)},refresh:function(){var a=this.element;this._unbindEvents();this._renderChart();this._renderChartOptions();this.options.autoSubmit?a.find(".tp-submit").hide():a.find(".tp-submit").show();this._bindEvents();a.find(".tp-throbber").hide()},_renderChartOptions:function(){var a=b(this.element),c=a.find(".tp-chart-controls").first().empty();if(!this.data.e){var d=a.attr("id");a=b('<div class="pt-chart-opts">');var e=d+"-bchart-totals";d+="-lchart-totals";b(a).append(b('<span id="'+
d+'" class="tp-chart-icon tp-lchart"/><span class="tp-chart-label">Line Chart</span>'));b(a).append(b('<span id="'+e+'" class="tp-chart-icon tp-bchart"/><span class="tp-chart-label">Bar Chart</span>'));b(c).append(a)}},_renderChart:function(a){var c=this.chart;if(c){var d=this.options,e=this.currentChart,f=null,l=null;a?(f=a.type,l=a.axis):(e&&(f=e.type,l=e.axis),f&&l||(f=d.defaultChartType,l=d.defaultChartAxis));e.type==f&&e.axis==l||this._removeChart();a=this.element;d=a.find(".tp-empty");e=this.data;
null===e&&(e=JSON.parse(this.input.val()));e||(e={e:!0});this.data=e;if(e.e)this._removeChart(),a.find(".tp-empty").show();else switch(d.hide(),c.show(),l){case "totals":switch(f){case "barchart":this._renderBarChart(c,e.f,e.p);break;default:this._renderLineChart(c,e.f,e.p)}}}},_removeChart:function(){var a=this.chart;a&&(a.empty().hide(),a=this.currentChart,a.container=null,a.chart=null,a.type=null,a.axis=null,b(window).off("resize.tp"))},_renderBarChart:function(a,c,d){var e=[];for(c=0;c<d.length;c++){var f=
d[c];e.push({start:(new Date(f.t[0])).getTime(),value:f.v[0]})}d=this.currentChart;if(d.chart){var l=d.container;var n=d.chart;l.datum([{key:"reportChart",values:e}]).transition().duration(500).call(n)}else b(a).closest(".tp-chart-contents").show().css({width:"96%"}),b(a).css({height:"360px"}),l=d3.select(b(a).get(0)).append("svg").attr("class","nv"),n=nv.models.discreteBarChart().x(function(k){return k.start}).y(function(k){return k.value}).color(["silver"]).staggerLabels(!0).showValues(!0).forceY([0,
1]),n.tooltip.enabled(!1),a=this.options.numberFormatter,n.valueFormat(a),n.yAxis.tickFormat(a),n.xAxis.tickFormat(function(k){return(new Date(k)).toLocaleDateString()}),nv.addGraph(function(){l.datum([{key:"reportChart",values:e}]).transition().duration(500).call(n);b(window).off("resize.tp").on("resize.tp",function(k){n.update(k)});return n}),d.container=l,d.chart=n,d.type="barchart",d.axis="totals"},_renderLineChart:function(a,c,d){var e=[],f={},l=0,n=1==c.length,k;for(k=0;k<c.length;k++){var q=
c[k][0];f.hasOwnProperty(q)&&(l=f[q]+1);(f[q]=l)&&(q+=" ["+(l+1)+"]");var u={key:q,label:c[k][0],area:n},v=[];for(q=0;q<d.length;q++){var p=d[q];v.push({start:(new Date(p.t[0])).getTime(),value:p.v[k]})}u.values=v;e.push(u)}c=this.currentChart;if(c.chart){var m=c.container;var r=c.chart;m.datum(e).transition().duration(250).call(r)}else b(a).closest(".tp-chart-contents").show().css({width:"96%"}),b(a).css({height:"360px"}),m=d3.select(b(a).get(0)).append("svg").attr("class","nv"),r=nv.models.lineChart().x(function(t){return t.start}).y(function(t){return t.value}).margin({right:50}).duration(250).showLegend(!0).useInteractiveGuideline(!0).forceY([0,
1]),r.yAxis.tickFormat(this.options.numberFormatter),r.xAxis.tickFormat(function(t){return(new Date(t)).toLocaleDateString()}),nv.addGraph(function(){m.datum(e).transition().duration(500).call(r);b(window).off("resize.tp").on("resize.tp",function(t){r.update(t)});return r}),c.container=m,c.chart=r,c.type="linechart",c.axis="totals"},reload:function(a,c,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof c&&(c=this._getFilters());var e=this,f=!1;b(this.element).find(".tp-throbber").show();if(a||c)f=
this._updateAjaxURL(a,c);f||d?(a=this.options.ajaxURL,c=b.ajaxS3,b.searchS3!==h&&(c=b.searchS3),c({url:a,type:"GET",dataType:"json",success:function(l){e.input.val(JSON.stringify(l));e.data=l;e.refresh()},error:function(l,n,k){console.log("UNAUTHORIZED"==k?i18n.gis_requires_login:l.responseText)}})):e.refresh()},_getOptions:function(){var a="#"+b(this.element).attr("id"),c=b(a+"-time").val(),d=a=null,e=null;"custom"!=c&&(c=c.split("|"),3==c.length&&(a=c[0],d=c[1],e=c[2]));return{start:a,end:d,slots:e}},
_getFilters:function(){var a=b("#"+this.widget_id+"-filters");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(c){return null}},_updateAjaxURL:function(a,c){var d=this.options.ajaxURL;if(!d)return!1;var e=d.split("?");if(1<e.length){var f=e[1];var l=f.split("&")}else f="",l=[];var n=[];d=!1;if(a)for(var k in a)f=a[k],f=k+"="+f,d||-1!=b.inArray(f,l)||(d=!0),n.push(f);k={};var q={},u;if(c){var v=function(r){var t,x,y=[];["contains","anyof","belongs","eq"].forEach(function(w){t=
new RegExp("__"+w+"$","g");r.match(t)?x=t:y.push(w)});x&&y.forEach(function(w){q[r.replace(x,"__"+w)]=!0})};f=0;for(u=c.length;f<u;f++){var p=c[f];var m=p[0];p=p[1];v(m);null===p?k[m]||(q[m]=!0):(q[m]&&(q[m]=!1),p=m+"="+encodeURIComponent(p),k[m]?k[m].push(p):k[m]=[p])}}f=0;for(u=l.length;f<u;f++)p=l[f].split("="),1<p.length&&(m=decodeURIComponent(p[0]),p=decodeURIComponent(p[1]),q[m]?d=!0:k[m]?d||-1!=b.inArray(m+"="+p,k[m])||(d=!0):a&&a.hasOwnProperty(m)||n.push(l[f]));for(m in k)for(f=0,u=k[m].length;f<
u;f++)d||-1!=b.inArray(k[m][f],l)||(d=!0),n.push(k[m][f]);a=n.join("&");c=e[0];a&&(c=c+"?"+a);this.options.ajaxURL=c;return d},_parseDate:function(a){return d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse(a)},_bindEvents:function(){var a=this,c="#"+this.widget_id;b(c+"-options legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(c+"-filters legend").click(function(){b(this).siblings().toggle();b(this).children().toggle()});b(c+"-time").on("change.autosubmit",function(){b(c+
"-tp-form").trigger("optionChanged")});if(this.options.autoSubmit){var d=this.options.autoSubmit;b(c+"-tp-form").on("optionChanged",function(){var e=b(this);if(!e.data("noAutoSubmit")){var f=e.data("autoSubmitTimeout");f&&clearTimeout(f);f=setTimeout(function(){var l=a._getOptions(),n=a._getFilters();a.reload(l,n,!1)},d);e.data("autoSubmitTimeout",f)}})}else b(c+"-tp-form input.tp-submit").on("click.timeplot",function(){var e=a._getOptions(),f=a._getFilters();a.reload(e,f,!1)});b(c+"-lchart-totals").click(function(){a._renderChart({type:"linechart",
axis:"totals"})});b(c+"-bchart-totals").click(function(){a._renderChart({type:"barchart",axis:"totals"})})},_unbindEvents:function(){var a="#"+this.widget_id;b(window).off("resize.timeplot");b(a+"-tp-form").off("optionChanged");b(a+"-tp-form input.tp-submit").off("click.timeplot");b(a+"-time").unbind("change.autosubmit");b(a+"-options legend").unbind("click");b(a+"-filters legend").unbind("click");b(a+"-lchart-totals,"+a+"-bchart-totals").unbind("click")}})})(jQuery);
