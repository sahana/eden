/*
    Static JS for Vulnerability module

    Demo code: https://github.com/roraback/Vulnerability-Mapping/blob/master/js/controls.js
*/

var drawerOpen = false;

var map, parser, proj4326;

// Load the Map asynchronously
yepnope({
    load: [S3.Ap.concat('/static/scripts/gis/OpenLayers.js')],
    complete: function(){
        v_show_map()
    }
})

$(document).ready(function(){

    // Provide the options for the Hierarchical Dropdown
    var res, selected;
    for (var prop in l0) {
        switch(l0[prop]['r']) {
            case 1:
                res = 'one';
                break;
            case 2:
                res = 'two';
                break;
            case 3:
                res = 'three';
                break;
            case 4:
                res = 'four';
                break;
            case 5:
                res = 'five';
                break;
            default:
                res = 'none';
                break;
        }
        if (prop == start) {
            selected = ' selected="selected"';
        } else {
            selected = '';
        }
        $('#l0_select').append('<option value="' + prop + '" class="' + res + '"' + selected + '>' + l0[prop]['n'] + '</option>');
    };

    // Add CSS classes for font smoothing
    TypeHelpers.insertClasses();

    // SelectMenu
    $('#dataTopBar').hover(function(){
        $('#dataTopBar img').css('background-color', '#f7941d');
        $('#dataTopBar img').attr('src', S3.Ap.concat('/static/themes/Vulnerability/img/dropdownArrowOverPng8.png'));
        $('#dataOptions').fadeIn(150);
        $('#defaultDataLink').css('color', '#c47a21');
    },
    function(){
        $('#dataTopBar img').css('background-color', 'transparent');
        $('#dataTopBar img').attr('src', S3.Ap.concat('/static/themes/Vulnerability/img/dropdownArrowPng8.png'));
        $('#dataOptions').fadeOut(150);
        $('#defaultDataLink').css('color', '#f7941d');
    });
    $('#reportsTopBar').hover(function(){
        $('#reportsTopBar img').css('background-color', '#f7941d');
        $('#reportsTopBar img').attr('src', S3.Ap.concat('/static/themes/Vulnerability/img/dropdownArrowOverPng8.png'));
        $('#reportsOptions').fadeIn(150);
        $('#defaultReportsLink').css('color', '#c47a21');
    },
    function(){
        $('#reportsTopBar img').css('background-color', 'transparent');
        $('#reportsTopBar img').attr('src', S3.Ap.concat('/static/themes/Vulnerability/img/dropdownArrowPng8.png'));
        $('#reportsOptions').fadeOut(150);
        $('#defaultReportsLink').css('color', '#f7941d');
    });

    // Click events
    // Chrome frame
    $('.closechromeframe').click(function(){ $('.chromeframe').hide(); });
    // Drawer
    $('#show-hide').click(function(){ drawerSlide(); });
    $('#risingTab').click(function(){ drawerSlide(); });
    // Calculations info box
    $('.calculationLink').click(function(){
        $('#lightbox, #calculationView').fadeIn(300);
    });
    $('#calculationView .closePanel').click(function(){
        $('#lightbox, #calculationView').fadeOut(300);
    });
});

function v_show_map() {

    OpenLayers.ImgPath = S3.Ap.concat('/static/img/gis/openlayers/');
    parser = new OpenLayers.Format.GeoJSON();
    proj4326 = new OpenLayers.Projection('EPSG:4326');

    /* Basic Map */
    map = new OpenLayers.Map('map', {
                                    // Use Manual stylesheet download (means can be done in HEAD to not delay pageload)
                                    theme: null
                                });
    var layer = new OpenLayers.Layer.OSM('OpenStreetMap',
            ['http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png',
             'http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png',
             'http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png'],
             {attribution: 'Tiles Courtesy of <a href="http://open.mapquest.co.uk/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" border="0">'}
            );
    map.addLayer(layer);

    // Open at the correct level
    if (start == '') {
        globalView();
    } else {
        v_select_l0(start);
    }

    /* Resilience layer */
    var style = {
        fillColor: '${fill}',
        fillOpacity: 0.5,
        strokeColor: '#ffffff',
        strokeWidth: 1,
        strokeOpacity: 1
    };
    var style_options = {
        context: {
            fill: function(feature) {
                var resilience = feature.attributes.resilience;
                if ( resilience == null ) {
                    var color = '#999999';
                } else if ( resilience == 5 ) {
                    var color = '#059346';
                } else if ( resilience == 4 ) {
                    var color = '#77b826';
                } else if ( resilience == 3 ) {
                    var color = '#d6b317';
                } else if ( resilience == 2 ) {
                    var color = '#f4961c';
                } else {
                    var color = '#ff5121';
                }
                return color;
            }
        }
    };
    var resilience_style = new OpenLayers.Style(
        style,
        style_options
    );
    var resilienceStyleMap = new OpenLayers.StyleMap({
        'default': resilience_style,
        'select': {
            fillOpacity: 1
        }
    });
    var features = [];
    var feature, f, geometry;
    for (var prop in l0) {
        f = l0[prop];
        geometry = parser.read(f.p, 'Geometry');
        geometry.transform(proj4326,
                           map.getProjectionObject());
        feature = new OpenLayers.Feature.Vector(geometry, {resilience: f.r,
                                                           id: prop
                                                           });
        features.push(feature);
    }
    var resilienceLayer = new OpenLayers.Layer.Vector(
        'Resilience', {
            styleMap: resilienceStyleMap
        }
    );
    resilienceLayer.addFeatures(features);
    map.addLayer(resilienceLayer);

    // @ToDo: Listen for Disable/Enable events
    //$('#resilienceCheck').change();

    /* @ToDo: Volunteers layer */

    /* @ToDo: Population Density layer */

}

// function to open/close the drawer
var drawerSlide = function(){
    switch(drawerOpen){
        case true:
            $('.hidden').hide('slow');
            $('#show-hide').html('<span class="arrow">&uarr;</span> SHOW MORE');
            var image = S3.Ap.concat('/static/themes/Vulnerability/img/openTabPng8.png');
            $('#risingTab').css('background-image', 'url(' + image + ')');
            // $('#drawer').css('height', '50px', 'slow');
            $(".activeWindow").fadeIn(300);
            drawerOpen = false;
            //if(subGeoShowing){ showSubGeo(); }
            break;
        case false:
            $('#drawerInside').show('slow');
            $('#drawerInside').data('fade', setTimeout(function(){ 
                $('#resilienceSummary, #drawerQuickActions, #indicatorRatingChart, #browseOtherRegions, #dataBreakdown').fadeIn(500);
                $('.communeOnly').hide();
            }, 500));
            $('#show-hide').html('<span class="arrow">&darr;</span> SHOW LESS');
            var image = S3.Ap.concat('/static/themes/Vulnerability/img/closeTabPng8.png');
            $('#risingTab').css('background-image', 'url(' + image + ')');
            // $('#drawer').css('height', '330px', 'slow');
            $('.activeWindow').fadeOut(300);
            drawerOpen = true;
            break;
    }
};

var markersOn = function(){
    var image = S3.Ap.concat('/static/themes/Vulnerability/img/mapIconOnPng8.png');
    $('#mapSection').css('background', 'url(' + image + ') no-repeat center top transparent');
    image = S3.Ap.concat('/static/themes/Vulnerability/img/volunteerIconOnPng8.png');
    $('#volunteerSection').css('background', 'url(' + image + ') no-repeat center top transparent');
    $('.iconSection').css('color', '#565656');
}
var markersOff = function(){
    var image = S3.Ap.concat('/static/themes/Vulnerability/img/mapIconOffPng8.png');
    $('#mapSection').css('background', 'url(' + image + ') no-repeat center top transparent');
    image = S3.Ap.concat('/static/themes/Vulnerability/img/volunteerIconOffPng8.png');
    $('#volunteerSection').css('background', 'url(' + image + ') no-repeat center top transparent');
    $('.iconSection').css('color', '#ccc');
};

var globalView = function(){
    markersOff();
    $('#l0_breadcrumb, #l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb, #show-hide, #divider, #analysisLink, #indicator, #risingTab').hide();
    $('.hidden').hide('slow');
    $('.geoName').html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a country');
    $('.geoType').html('');
    $('.year').html('');
    $('.activeWindow').fadeOut(300);
    $('.activeWindow').removeClass('activeWindow');
    //$('.countryWindow').addClass('activeWindow');
    //$('.activeWindow').fadeIn(300);
    //refreshDropdowns('kitten');
    var bottom_left = new OpenLayers.LonLat(80, -50).transform(
            proj4326,
            map.getProjectionObject()
        )
    var top_right = new OpenLayers.LonLat(180, 50).transform(
            proj4326,
            map.getProjectionObject()
        )
    var bounds = [bottom_left.lon, bottom_left.lat, top_right.lon, top_right.lat];
    map.zoomToExtent(bounds);
};

var v_select_l0 = function(id) {
    // L0 has been selected
    var country = l0[id];
    var geometry = parser.read(country.p, 'Geometry');
    var bounds = geometry.getBounds();
    var bottom_left = new OpenLayers.LonLat(bounds.left, bounds.bottom).transform(
            proj4326,
            map.getProjectionObject()
        )
    var top_right = new OpenLayers.LonLat(bounds.right, bounds.top).transform(
            proj4326,
            map.getProjectionObject()
        )
    var bounds_900913 = [bottom_left.lon, bottom_left.lat, top_right.lon, top_right.lat];
    map.zoomToExtent(bounds_900913);
    var l0_name = country.n;
    $('#l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb').hide()
    $('#l0_breadcrumb').html(' &raquo; ' + l0_name).show();
    $('#indicator').html(country.r);
    $('#geoName').html(l0_name);
    $('.geoType').html('Country in');
    $('.year').html('2012');
    $('#l0').val(id);
    $('#l1, #l2, #l3, #l4, #l5').val('');
    markersOff();
    // etc, etc
}

var v_select_l1 = function(id) {
    // L1 has been selected
    $('#l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb').hide()
    $('#l0_breadcrumb').html(' &raquo; ' + l0_name).show();
    $('#l1_breadcrumb').html(' &raquo; ' + l1_name).show();
    $('#geoName').html(l1_name);
    $('.geoType').html('Province in'); // @ToDo: Hierarchy Names
    $('.year').html('2012');
    $('#l0').val();
    $('#l1').val(id);
    $('#l2, #l3, #l4, #l5').val('');
    markersOff();
    // etc, etc
}

var v_select_l2 = function(id) {
    // L2 has been selected
    $('#l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb').hide()
    $('#l0_breadcrumb').html(' &raquo; ' + l0_name).show();
    $('#l1_breadcrumb').html(' &raquo; ' + l1_name).show();
    $('#l2_breadcrumb').html(' &raquo; ' + l2_name).show();
    $('#geoName').html(l2_name);
    $('.geoType').html('District in'); // @ToDo: Hierarchy Names
    $('.year').html('2012');
    $('#l0').val();
    $('#l1').val();
    $('#l2').val(id);
    $('#l3, #l4, #l5').val('');
    markersOn();
    // etc, etc
}
