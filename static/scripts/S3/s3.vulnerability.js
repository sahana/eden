var drawerOpen=false;
var subGeoShowing = false;
var subGeoHover = true;
var reassignRatings;
var activeWindow;
var markersOn=false;
var median;
var highest_level = 3;
var updateChart;
var setLevel;
var ratingsObject; // JSON object with fake ratings
var reportsHeight = window.innerHeight-111;
var submitDataHeight = window.innerHeight-186;
var activeContentHeight = 0;
var resizeReports, resizeSubmitData;
var timelineMin = 1989;
var timelineMax = 2012;
var activeYear;

$(document).ready(function(){
        
    TypeHelpers.insertClasses();
    
    $("#dataTopBar").hover(function(){
        $("#dataTopBar img").css("background-color", "#f7941d");
        $("#dataTopBar img").attr("src", S3.Ap + "/static/themes/Vulnerability/img/dropdownArrowOverPng8.png");
        $("#dataOptions").fadeIn(150);
        $("#defaultDataLink").css("color", "#c47a21");
    },
    function(){
        $("#dataTopBar img").css("background-color", "transparent");
        $("#dataOptions").fadeOut(150);
        $("#defaultDataLink").css("color", "#f7941d");
    });
    $("#reportsTopBar").hover(function(){
        $("#reportsTopBar img").css("background-color", "#f7941d");
        $("#reportsTopBar img").attr("src", S3.Ap + "/static/themes/Vulnerability/img/dropdownArrowOverPng8.png");
        $("#reportsOptions").fadeIn(150);
        $("#defaultReportsLink").css("color", "#c47a21");
    },
    function(){
        $("#reportsTopBar img").css("background-color", "transparent");
        $("#reportsTopBar img").attr("src", S3.Ap + "/static/themes/Vulnerability/img/dropdownArrowPng8.png");
        $("#reportsOptions").fadeOut(150);
        $("#defaultReportsLink").css("color", "#f7941d");
    });
    $(".closechromeframe").click(function(){ $(".chromeframe").hide(); });
    
    $('#timelineSlider').slider({
		value: 2010,
		min: 1990,
		max: 2012,
		step: 1,
		slide: function( event, ui ) {
			$( "#amount" ).val( ui.value );
		}
	});
	$( "#amount" ).val( 2012 );

	// set up selectmenu for chart
	$("#chartSwitcher").selectmenu({
	    style: "popup",
	    maxHeight:280,
	    width:125,
	    menuWidth:125
	});
		
	$("#reportFilters select, #submitDataFilters select, .subGeoSelect, #browseOtherRegions select").selectmenu({
	    style: "popup",
		maxHeight:280,
		width:160,
		menuWidth:160,
		icons: [
			{find: '.one'},
			{find: '.two'},
			{find: '.three'},
			{find: '.four'},
			{find: '.five'}
		]	    
	});
	
	$("#analysis select, #analysisToggle select").selectmenu({
	    style: "popup",
	    maxHeight:280,
	    width:160,
	    menuWidth:160
	});
	
    // $("#amount").change( function(){ console.log($("#amount").val()) });

    //click events for opening/closing drawer
    $("#show-hide").click(function(){ drawerSlide(); });
    $("#risingTab").click(function(){ drawerSlide(); });

    $("#subGeo, .currentQuality").hover(
        function(){ //show popup with sub-geography if user hovers for .2 second
            var tempPopupDivVar = $(this).find(".popup");
            $(tempPopupDivVar).data('timeout', setTimeout(function(){ showSubGeo(tempPopupDivVar, 200); }, 200)) },
        function(){ 
            var tempPopupDivVar = $(this).find(".popup");
            hideSubGeo(tempPopupDivVar, 200);
            clearTimeout($(tempPopupDivVar).data('timeout'));
        }); // cancel popup if user moves mouse before .2 second passes

    $(".listText").hover(
        function(){
            showSubGeo($(this).siblings(".popup"), 0);
        },
        function(){
            hideSubGeo($(this).siblings(".popup"), 0);
    });
        
    $("#subGeoPopup").hover(
        function(){ 
            if(!subGeoHover){  // on mouseover, if the mouseout counter is still going, cancel it
                clearTimeout($(this).data('timeout'));
                subGeoHover=true;
            }
        },
        function () { //if the user moves mouse away from the div, start a .3s timer before hiding the sub-geography popup
            var tempPopupDivVar = $(this);
            subGeoHover = false;
            $(this).data('timeout', setTimeout( function () {
                hideSubGeo(tempPopupDivVar);
            }, 300));
    });

    // $("#closeSubGeo").click(function(){ showSubGeo(); });

    // grab search value when search is clicked AND when enter/return is pressed (while the search is in focus)
    $("#searchSubmit").click(function(){ alert( $("#search input").val()); });  
    $("#search input").keyup(function(keyEvent){
        if(keyEvent.which==13){
            alert( $("#search input").val() );
        }
    });


    // open the reports section/lightbox background when reports links are clicked
    $(".reports").click(function(){ 
        showReports("pending");
    });
    
    $(".infoWindow img").click(function(){
        $("#lightbox, #photoPanel").fadeIn(300);
    });
    
    $(".calculationLink").click(function(){
        $("#lightbox, #calculationView").fadeIn(300);
    });
    
    //close sections when lightbox surrounding area OR x in UR corner is clicked
    $("#lightbox").click(function(){ 
        $("#lightbox, #reportsSection, #calculationView, #photoPanel, #submitDataSection").fadeOut(300);
    });
    $("#reportsSection .closePanel").click(function(){
        $("#lightbox, #reportsSection").fadeOut(300);
    });
    $("#submitDataSection .closePanel").click(function(){
        $("#lightbox, #submitDataSection").fadeOut(300);
    });
    $("#calculationView .closePanel").click(function(){
        $("#lightbox, #calculationView").fadeOut(300);
    });
    $("#photoPanel .closePanel").click(function(){
        $("#lightbox, #photoPanel").fadeOut(300);
    });
    $(".subGeoReportsButton").click(function(){
        showReports('pending');
    });
    $(".subGeoAnalysisButton").click(function(){
        showAnalysis();
    });
    $(".subGeoSubmitDataButton").click(function(){
        showSubmitData("indicators");
    });
    
    $(".reviewButton").click(function(){
        $(".rowForApproval").hide();
        $(".rowForApproval").prev().find(".closeReviewButton").hide();
        $(".rowForApproval").prev().find(".reviewButton").fadeIn(200);
        $(this).parent().parent().next(".hiddenRow").addClass("rowForApproval").show("slow");
        $(this).hide();
        $(this).siblings(".closeReviewButton").fadeIn(200);
        resizeReports();
    });
    $(".closeReviewButton").click(function(){
        $(this).parent().parent().next(".hiddenRow").hide();
        $(this).hide();
        $(this).siblings(".reviewButton").fadeIn(200);
        resizeReports();
    });
    
    $(".approveButton, .declineButton").click(function(){
        console.log($(this).parent().parent().parent());
        console.log($(this).parent().parent().parent().prev());
        $(this).parent().parent().parent().hide();
        $(this).parent().parent().parent().prev().hide();
        if($(this).hasClass("approveButton")){
            $(".approvalScreen .thanks").html("Thank you for your approval.");
        }else{
            $(".approvalScreen .thanks").html("Thank you, the submission<br />has been declined.")
        }
        $(".approvalScreen").fadeIn(300);
        $(".approvalScreen").data('approvalTimeout', setTimeout(function(){ $(".approvalScreen").fadeOut(300); }, 5000));
        resizeReports();
    });
    
    $(".headerRow").click(function(){
        $(".rowForApproval").hide();
        $(".rowForApproval").prev().find(".closeReviewButton").hide();
        $(".rowForApproval").prev().find(".reviewButton").show();
        $(".headerRow.activeSection td.arrowCell .arrow").html("&rarr;");
        $(".headerRow.activeSection").removeClass("activeSection");
        $(this).addClass("activeSection");
        $(".headerRow.activeSection .arrow").html("&darr;");
        $(".activeContent").hide("slow");
        $(".activeContent").removeClass("activeContent");
        $(this).next().addClass("activeContent");
        $(this).parent().next().addClass("activeContent");
        $(".activeContent").fadeIn(200);
        resizeReports();
    });
    
    $(".return2reports").click(function(){
        $(".approvalScreen").fadeOut(300);
        clearTimeout($(".approvalScreen").data('approvalTimeout'));
    });
    
    //fake country selection when user is in global view.
    $("#vulnerability").click(function(){
        if(!$("#l0_breadcrumb").is(":visible")){
            $("#show-hide, #divider, #analysisLink, #risingTab").fadeIn(200);
            $("#l0_select option[value='vietnam']").attr("selected",true);
            $("#l0_select").selectmenu("destroy").selectmenu({
        	    style: "popup",
        		maxHeight:280,
        		width:160,
        		menuWidth:160,
        		icons: [
        			{find: '.one'},
        			{find: '.two'},
        			{find: '.three'},
        			{find: '.four'},
        			{find: '.five'}
        		]
        	});
            reassignRatings(0);
            $(".activeWindow").fadeIn(300);
        }
    });
    $(window).resize(function(){ 
        if($("#reportsSection").is(":visible")){
            resizeReports();
        }else if($("#submitDataSection").is(":visible")){
            resizeSubmitData();
        }
    });
    
    resizeReports = function(){
        reportsHeight = window.innerHeight-111;
        activeContentHeight = 0;
        $(".activeContent.contentTable .content").children("tr:visible").each(function(){
            activeContentHeight += $(this).innerHeight();
        });
        // activeContentHeight-=8;
        
        if(reportsHeight<507){
            reportsHeight=507;
        }
        if(activeContentHeight > reportsHeight-180){
            activeContentHeight = reportsHeight-180;
        }
        $("#reportsContent, #reportFilters").css("height", reportsHeight + "px");
        $(".activeContent.contentTable").css("height", activeContentHeight + "px").css("display","block");
    }
    resizeReports();
    
    resizeSubmitData = function(){
        submitDataHeight = window.innerHeight-186;
        if(submitDataHeight<432){
            submitDataHeight=432;
        }
        $("#submitDataContent").css("height", submitDataHeight + "px");
        $("#submitDataFilters").css("height", submitDataHeight + 75 + "px");
        $("#submitDataSection").css("height", submitDataHeight + 136 + "px");
//        $("#submitDataFooter").css("top", submitDataHeight + 61 + "px");
    }
    resizeSubmitData();
    
    refreshDropdowns = function(select_id){
        switch(select_id){
            case "l0_select":
                $("#l1, #l2, #l3, #l4, #l5").fadeOut(200);
                $("#l1_select option.none, #l2_select option.none, #l3_select option.none, #l4_select option.none, #l5_select option.none").attr("selected", true);
                if( $("#l0_select").val() != "na"){
                    $("#l1").fadeIn(200);
                }
                $("#l1_select, #l2_select, #l3_select, #l4_select, #l5_select").selectmenu("destroy").selectmenu({
            	    style: "popup",
            		maxHeight:280,
            		width:160,
            		menuWidth:160,
            		icons: [
            			{find: '.one'},
            			{find: '.two'},
            			{find: '.three'},
            			{find: '.four'},
            			{find: '.five'}
            		]
            	});
                break;
            case "l1_select":
                $("#l2, #l3, #l4, #l5").fadeOut(200);
                $("#l2_select option.none, #l3_select option.none, #l4_select option.none, #l5_select option.none").attr("selected", "selected");
                if( $("#l1_select").val() != "na"){
                    $("#l2").fadeIn(200);
                }
                $("#l2_select, #l3_select, #l4_select, #l5_select").selectmenu("destroy").selectmenu({
            	    style: "popup",
            		maxHeight:280,
            		width:160,
            		menuWidth:160,
            		icons: [
            			{find: '.one'},
            			{find: '.two'},
            			{find: '.three'},
            			{find: '.four'},
            			{find: '.five'}
            		]
            	});
                break;
            case "l2_select":
                $("#l3, #l4, #l5").fadeOut(200);
                $("#l3_select option.none, #l4_select option.none, #l5_select option.none").attr("selected", true);
                if( $("#l2_select").val() != "na"){
                    $("#l3").fadeIn(200);
                }
                $("#l3_select, #l4_select, #l5_select").selectmenu("destroy").selectmenu({
            	    style: "popup",
            		maxHeight:280,
            		width:160,
            		menuWidth:160,
            		icons: [
            			{find: '.one'},
            			{find: '.two'},
            			{find: '.three'},
            			{find: '.four'},
            			{find: '.five'}
            		]
            	});
                break;
            case "l3_select":
                if(highest_level>3){
                    $("#l5").fadeOut(200);
                    $("#l4_select option.none, #l5_select option.none").attr("selected", true);
                    if( $("#l3_select").val() != "na"){
                        $("#l4").fadeIn(200);
                    }
                }
                break;
            case "l4_select":
                if(highest_level>4){
                    $("#l5").fadeOut(200);
                    $("#l4_select option.none, #l5_select option.none").attr("selected", true);
                    if( $("#l3_select").val() != "na"){
                        $("#l4").fadeIn(200);
                    }
                }
                break;
            case "l5_select":
                break;
            default:
                $("#l1, #l2, #l3, #l4, #l5").fadeOut(200);
                $("#l0_select option.none, #l1_select option.none, #l2_select option.none, #l3_select option.none, #l4_select option.none, #l5_select option.none").attr("selected", true);
                $("#l0_select, #l1_select, #l2_select, #l3_select, #l4_select, #l5_select").selectmenu("destroy").selectmenu({
            	    style: "popup",
            		maxHeight:280,
            		width:160,
            		menuWidth:160,
            		icons: [
            			{find: '.one'},
            			{find: '.two'},
            			{find: '.three'},
            			{find: '.four'},
            			{find: '.five'}
            		]
            	});
                
        }
    }
    
    setLevel = function(){
        var l_level=0;
        if($("#l5_select-button").is(":visible")){
            switch($("#l5_select option:selected").val()){
                case "na":
                    l_level=4;
                    break;
                default:
                    l_level=5;
            }
        } else if ($("#l4_select-button").is(":visible")){
            switch($("#l4_select option:selected").val()){
                case "na":
                    l_level=3;
                    break;
                default:
                    l_level=4;
            }
        } else if ($("#l3_select-button").is(":visible")){
            switch($("#l3_select option:selected").val()){
                case "na":
                    l_level=2;
                    break;
                default:
                    l_level=3;
            }
        } else if ($("#l2_select-button").is(":visible")){
            switch($("#l2_select option:selected").val()){
                case "na":
                    l_level=1;
                    break;
                default:
                    l_level=2;
            }
        } else if ($("#l1_select-button").is(":visible")){
            switch($("#l1_select option:selected").val()){
                case "na":
                    l_level=0;
                    break;
                default:
                    l_level=1
            }
        }
        reassignRatings(l_level);
    }
    reassignRatings = function(l_level){
        switch(l_level){
            case 0:
                $(".geoName").html($("#l0_select").val());
                $(".geoType").html("Country <span>In</span>");
                $(".year").html("2010");
                $("#subGeoReported").html("8 Provinces Reported");
                $("#qualityCommunes").html("36 out of 397 Communes Reported");
                $(".noCommune").show();
                $("#l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb").hide();
                $("#l0_breadcrumb").html(" &raquo; " + $("#l0_select").val()).show();
                $(".communeOnly").fadeOut(200);
                $("#iconsKey input").hide();
                $(".indicatorRange").show();
                $(".infoWindow").removeClass("activeWindow").fadeOut(300);
                $(".provinceWindow").addClass("activeWindow");
                if(!drawerOpen){
                    $(".activeWindow").fadeIn(300);
                }
                break;
            case 1:
                $(".geoName").html($("#l1_select").val());
                $(".geoType").html("Province <span>In</span>");
                $(".year").html("2010");
                $("#l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb").hide();
                $("#l0_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(0); refreshDropdowns(\"l0_select\");'>" + $("#l0_select").val() + "</a>").show();
                $("#l1_breadcrumb").html(" &raquo; " + $("#l1_select").val()).show();
                $("#subGeoReported").html("3 Districts Reported");
                $("#qualityCommunes").html("36 out of 397 Communes Reported");
                $(".noCommune").show();
                $(".communeOnly").fadeOut(200);
                $("#iconsKey input").hide();
                $(".indicatorRange").show();
                $(".infoWindow").removeClass("activeWindow").fadeOut(300);
                $(".districtWindow").addClass("activeWindow");
                if(!drawerOpen){
                    $(".activeWindow").fadeIn(300);
                }
                break;
            case 2:
                $(".geoName").html($("#l2_select").val());
                $(".geoType").html("District <span>In</span>");
                $(".year").html("2010");
                $("#l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb").hide();
                $("#l0_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(0); refreshDropdowns(\"l0_select\");'>" + $("#l0_select").val() + "</a>").show();
                $("#l1_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(1); refreshDropdowns(\"l1_select\");'>" + $("#l1_select").val() + "</a>").show();
                $("#l2_breadcrumb").html(" &raquo; " + $("#l2_select").val()).show();
                $("#subGeoReported").html("8 Communes Reported");
                $("#qualityCommunes").html("36 out of 397 Communes Reported");
                $(".noCommune").show();
                $(".communeOnly").fadeOut(200);
                $("#iconsBlocker").hide();
                $("#iconsKey input").show();
                $("#mapKey #iconsKey label").css("color", "#565656");
                $(".indicatorRange").show();
                $(".infoWindow").removeClass("activeWindow").fadeOut(300);
                $(".communeWindow").addClass("activeWindow");
                if(!drawerOpen){
                    $(".activeWindow").fadeIn(300);
                }
                break;
            case 3:
                $(".geoName").html($("#l3_select").val());
                $(".geoType").html("Commune <span>In</span>");
                $(".year").html("2010");
                $(".communeOnly").show();
                $(".noCommune").hide();
                $("#qualityCommunes").html("Last Data Collected on 7/3/2011 by Tina Pham");                
                $("#l4_breadcrumb, #l5_breadcrumb").hide();
                $("#l0_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(0); refreshDropdowns(\"l0_select\");'>" + $("#l0_select").val() + "</a>").show();
                $("#l1_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(1); refreshDropdowns(\"l1_select\");'>" + $("#l1_select").val() + "</a>").show();
                $("#l2_breadcrumb").html(" &raquo; <a href='javascript:reassignRatings(2); refreshDropdowns(\"l2_select\");'>" + $("#l2_select").val() + "</a>").show();
                $("#l3_breadcrumb").html(" &raquo; " + $("#l3_select").val()).show();
                $("#iconsBlocker").hide();
                $("#iconsKey input").show();
                $("#mapKey #iconsKey label").css("color", "#565656");
                $(".indicatorRange").show();
                $(".infoWindow").removeClass("activeWindow");
                break;
            case 4:
                break;
            case 5:
                break;
        }
        updateChart(l_level, true);
        updateChartDropdown(l_level);
    }
    
    updateChart = function(l_level, ratingBlocksBoolean){        
        var medianTotal=0;
        ratingsObject = [
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)],
            [Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5), Math.ceil(Math.random()*5)]
        ];
        // for loop to add css properties to chart in drawer
        for(var i=0; i<ratingsObject.length; i++){
            $("#visRange" + i + " .rightBox, #visRange" + i + " .leftBox").show();

            ratingsObject[i].sort();
            //set left margin
            $("#visRange" + i).css("left", (58*(ratingsObject[i][0]-1)) + "px");
            //set width of the range
            $("#visRange" + i).css("width", (58*(ratingsObject[i][ratingsObject[i].length-1] - ratingsObject[i][0])) + "px")
        
            //set median values
            var medianIndex = ratingsObject[i].length/2.0;
            switch(medianIndex%1){
                case 0:
                    median = ((ratingsObject[i][medianIndex] + ratingsObject[i][medianIndex-1])/2.0);
                    break;
                default:
                    median = (ratingsObject[i][Math.floor(medianIndex)]);
                    break;
            }
        
            // set difference variable so that we'll be able to specify the dot's position
            var medianDifference = median - ratingsObject[i][0];
        
            // position the median dot/circle
            $("#visRange" + i + " .medianDot").css("left", (medianDifference*58) + "px");
            if(median == ratingsObject[i][0]){
                $("#visRange" + i + " .leftBox").hide();
            }
            if(median == ratingsObject[i][ratingsObject[i].length - 1]){
                $("#visRange" + i + " .rightBox").hide();
            }
            medianTotal+=median;
        }
        var bgcolor;
        var ddThumb;
        // median = Math.round(medianTotal/ratingsObject.length); // We will ultimately be doing something like this, but since rounding a bunch of randomly generated numbers almost always ends up with a median value of 3, I'm using the following:
        median = Math.ceil(median);
        if(ratingBlocksBoolean){
            updateRatingBlocks(l_level, median);
        }
    }
    var updateRatingBlocks = function(l_level, median){
        switch(median){
            case 1:
                bgcolor = "#ff5121";
                ddThumb = "one";
                break;
            case 2:
                bgcolor = "#f4961c";
                ddThumb = "two";
                break;
            case 3:
                bgcolor = "#d6b317";
                ddThumb = "three";
                break;
            case 4:
                bgcolor = "#77b82e";
                ddThumb = "four";
                break;
            case 5:
                bgcolor = "#059346";
                ddThumb = "five";
                break;
            default:
                bgcolor = "#999";
        }
        $("#mainRating, #indicator").css("background-color", bgcolor);
        $("#mainRating, #indicator").text(median);
        $("#mainRating, #indicator").show();
        $("#l" + l_level + "_level option:selected").each(function(){ $(this).removeClass("one two three four five"); });
        $("#l" + l_level + "_level option:selected").addClass(ddThumb);        
    }
    var updateChartDropdown = function(l_level){
        var optionsText;
        
        for(var i=l_level; i>=0; i--){
            switch(i){
                case l_level:
                    optionsText += '<option value="' + i + '" selected="selected">Current Location</option>';
                    break;
                default:
                    optionsText += '<option value="' + i + '">' + $("#l" + i + "_select option:selected").html() + '</option>';
            }
        }
        
		$("#chartSwitcher").html(optionsText);
		$("#chartSwitcher").selectmenu("destroy").selectmenu({
    	    style: "popup",
    	    maxHeight:280,
    	    width:125,
    	    menuWidth:125
    	});
    }
    
    
    //function to open/close the drawer
    var drawerSlide = function(){
        switch(drawerOpen){
            case true:
                $(".hidden").hide('slow');
                $("#show-hide").html("<span class='arrow'>&uarr;</span> SHOW MORE");
                $("#risingTab").css("background-image",'url("' + S3.Ap + '"/openTabPng8.png")');
                // $("#drawer").css("height", "50px", "slow");
                $(".activeWindow").fadeIn(300);
                drawerOpen = false;
                if(subGeoShowing){ showSubGeo(); }
                break;
            case false:
                $("#drawerInside").show('slow');
                $("#drawerInside").data("fade", setTimeout(function(){ 
                    $("#resilienceSummary, #drawerQuickActions, #indicatorRatingChart, #browseOtherRegions, #dataBreakdown").fadeIn(500);
                    $(".communeOnly").hide(); 
                }, 500));
                $("#show-hide").html("<span class='arrow'>&darr;</span> SHOW LESS");
                $("#risingTab").css("background-image",'url("' + S3.Ap + '"/static/themes/Vulnerability/img/closeTabPng8.png")');
                // $("#drawer").css("height", "330px", "slow");
                $(".activeWindow").fadeOut(300);
                drawerOpen = true;
                break;
        }
    };    
    reassignRatings();
    
    //analysis section code for the timeline slider
    var percentageIncrement = 100/(timelineMax - timelineMin);
    var startingPoint;
    for(var i=timelineMin; i<=timelineMax; i++){
        if(i%5==0){
            startingPoint=i;
            break;
        }
    }
    for(var i=startingPoint; i<=timelineMax; i+=5){
        $("#analysisTimelineLabels").append("<div style='left:" + (i-timelineMin)*percentageIncrement + "%;'><span>&#124;</span></br />" + i + "</div>")
    }    
    
    $("#analysisTimeline").slider({
		range: true,
		min: timelineMin,
		max: timelineMax,
        values: [ 1990, parseInt($("#drawerTop .year").text()) ],
        slide: function( event, ui ) {
            $("#analysisDrawerTop .year").html(ui.values[0] + "&ndash;" + ui.values[1]);
            $(".analysisLowerYearHidden").html(ui.values[0]);
            $(".analysisUpperYearHidden").html(ui.values[1]);
        }
    });
    
    $("#submitIndicators, #submitReports").click(function(){
        if(!$(this).hasClass("active")){
            $("#submissionToggle .active").removeClass("active");
            $(this).addClass("active");
            if($("#submitDataFilters").css("background-color")=="#f7941d"){
                $("#submitDataFilters").animate({ "background-color": "#c6c6c6" }, 500);
            }
            switch(this.id){
                case "submitIndicators":
                    $("#indicatorsSubmissionViews").fadeIn(300);
                    $("#dataAndReportsSubmissionViews").fadeOut(300);
                    break;
                case "submitReports":
                    $("#indicatorsSubmissionViews").fadeOut(300);
                    $("#dataAndReportsSubmissionViews").fadeIn(300);
                    setTimeout(function(){
                        $("#indicatorsSubmissionViews").children("div").hide();
                        $("#submitDataContent .indicatorsStart").show();
                    },300);
                    break;
            }
        }else{
            switch(this.id){
                case "submitIndicators":
                    $("#indicatorsSubmissionViews").children("div").fadeOut(300);
                    $("#submitDataContent .indicatorsStart").fadeIn(300);
                    break;
                case "submitReports":
                    break;
            }
        }
    });
    var sillyProgressBarLoadScript = function(selector){
        setTimeout(function(){
            $(selector).progressbar("value", $(selector).progressbar("value")+1.5);
            $("#submitDataContent .ui-progressbar-value").css("background-position", parseInt($("#submitDataContent .ui-progressbar-value").css("background-position")) -1 + "px");
        },25);
    };
    $("#uploadIndicatorsButton").click(function(){
        $(".loadingView").fadeIn(300);
        $(".indicatorsStart").fadeOut(300);
        $(".loadingView .progressBar").progressbar({
        	value: 0,
        	change: function(event, ui){
        	    sillyProgressBarLoadScript(".loadingView .progressBar");
        	},
        	complete: function(event, ui){
            	if($(".loadingView").is(":visible")){
            	    $(".loadingView").fadeOut(300);
            	    $(".loadingErrorView").fadeIn(300);
            	}
        	}
        });
        sillyProgressBarLoadScript(".loadingView .progressBar");
        
    });
    $(".loadingErrorView .indicatorsButton").click(function(){
        $(".loadingView").fadeIn(300);
        $(".loadingErrorView").fadeOut(300);
        $(".loadingView .progressBar").progressbar({
            value:0,
        	change: function(event, ui){
        	    sillyProgressBarLoadScript(".loadingView .progressBar");
        	},
            complete:function(event, ui){
            	if($(".loadingView").is(":visible")){
                    $(".loadingView").fadeOut(300);
                    $("#submitDataContent .reviewIndicatorsView h3").html("Review <span class='currentPage'>1</span> of <span class='totalPages'>3<span>");
                    $(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){
                        var randomRating = Math.ceil(Math.random()*5);
                        $(this).find("input[value='" + randomRating + "']").attr("checked", true);
                    });
                    $(".reviewIndicatorsView.firstPage").fadeIn(300);
                    $("#submitDataFilters").animate({ "background-color": "#f7941d" }, 500);
                    $("#submitDataFilters h3").hide(300);
                    $("#submissionToggle").hide(300);
                    $("#submitDataFooter mark, #submitDataFooter .reviewNextButton").fadeIn(300);
                }
            }
        })
    });
    $("#submitDataFooter .reviewNextButton").click(function(){
        if(!$(".backButton").is(":visible")){
            $(".backButton").fadeIn(300);
            $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Yen Hoa Commune.</mark>");
        }else{
            $(".reviewNextButton").hide();
            $(".submitAllButton").show();
            $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Phu Tam Commune</mark>");
        }
        $(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){
            var randomRating = Math.ceil(Math.random()*5);
            $(this).find("input[value='" + randomRating + "']").attr("checked", true);
        });
        $(".reviewIndicatorsView h3 .currentPage").text(parseInt($(".reviewIndicatorsView h3 .currentPage").text()) + 1);
    });
    $("#submitDataFooter .backButton").click(function(){
        if($("#submitDataFooter .reviewNextButton").is(":visible")){
            $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Hoa Tam Commune.</mark>");
            $(this).hide();
        }else{
            $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Yen Hoa Commune</mark>");
            $("#submitDataFooter .submitAllButton").fadeOut();
            setTimeout(function(){
                $("#submitDataFooter .reviewNextButton").fadeIn();
            },300);
        }
        $(".reviewIndicatorsView h3 .currentPage").text(parseInt($(".reviewIndicatorsView h3 .currentPage").text()) - 1);
        $(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){
            var randomRating = Math.ceil(Math.random()*5);
            $(this).find("input[value='" + randomRating + "']").attr("checked", true);
        });
    });
    $("#submitDataFooter .submitAllButton").click(function(){
        $(".reviewIndicatorsView").fadeOut(300);
        $("#submitDataContent .thankyou").fadeIn(300);
        $("#submitDataFooter div, #submitDataFooter mark").fadeOut(300)
        setTimeout(function(){
            $("#submitDataFooter .submitMoreButton").fadeIn(300);
        },300);
    });
    $("#submitDataFooter .submitMoreButton").click(function(){
        $("#submitDataContent .indicatorsStart").fadeIn(300);
        $("#submitDataContent .thankyou, #submitDataFooter .submitMoreButton").fadeOut(300);
        $("#submitDataFilters").animate({ "background-color": "#c6c6c6" }, 500);
        $("#submitDataFilters h3").fadeIn(300);
        $("#submissionToggle").fadeIn(300);
        $("#submitDataContent .indicatorsStart p").filter(":first").show();
    });
    $("#submitOnlineButton").click(function(){
        if(!$(this).hasClass("disabled")){ //if not disabled, then load the indicator form
            $("#submitDataContent .submitIndicatorsForm input").attr("checked", false);
            $("#submitDataContent .submitIndicatorsForm, #submitDataFooter mark").fadeIn(300);
            $("#submitDataContent .indicatorsStart").fadeOut(300);
            $("#submitDataFooter .reviewSubmissionButton").addClass("disabled").fadeIn(300);
        }
    });
    $("#submitDataFooter .reviewSubmissionButton").click(function(){
        if($("#submitDataContent .submitIndicatorsForm").is(":visible")){
            $("#submitDataContent .submitIndicatorsForm h3").html("Review");
            $("#submitDataContent .submitIndicatorsForm h4").filter(":first").html("You are about to submit indicator ratings for <mark>" + $("#l3_data option:selected").html() + " Commune.</mark>");
            $(".submitIndicatorsForm h3, .submitIndicatorsForm h4").fadeIn(300);
            $("#submitDataFooter .reviewSubmissionButton, .submitIndicatorsForm .indicatorLabels div").fadeOut(300);
            $("#submitDataFilters").animate({ "background-color": "#f7941d" }, 500);
            $("#submitDataFilters h3").hide(300);
            $("#submissionToggle").fadeOut(200);
            setTimeout(function(){
                $("#submitDataFooter .submitButton").fadeIn(300);
            },300);
            
        }
    });
    $(".submitIndicatorsForm input").change(function(){
        if($(".submitIndicatorsForm input:radio:checked").length==10){
            $("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");
        }
    });
    $("#submitDataFooter .submitButton").click(function(){
        console.log("working!");
        $("#submitDataContent .submitIndicatorsForm").fadeOut(300);
        $("#submitDataContent .thankyou").fadeIn(300);
        $("#submitDataFooter div, #submitDataFooter mark").fadeOut(300)
        setTimeout(function(){
            $("#submitDataFooter .submitMoreButton").fadeIn(300);
            $("#submitDataFooter .reviewSubmissionButton").addClass("disabled");
            $(".submitIndicatorsForm h3, .submitIndicatorsForm h4").hide();
            $(".submitIndicatorsForm .indicatorLabels div").show();            
        },300);
    });
    $(".dataSubmissionRegion input").change(function(){
        
        switch($(this).val()){
            case "map":
                var dataSubmission = "";
                var regionHeight = "";
                break;
            case "image":
                var dataSubmission = "";
                var regionHeight = "";
                break;
            case "other":
                var dataSubmission = "";
                var regionHeight = "";
                break;
            case "demographics":
                var dataSubmission = "";
                var regionHeight = "";
                break;
            case "vca":
                var dataSubmission = "";
                var regionHeight = "";
                break;
        }
        $(".dataSubmissionRegion .progressBar").progressbar({
        	value: 0,
        	change: function(event, ui){
        	    sillyProgressBarLoadScript(".dataSubmissionRegion .progressBar");
        	},
        	complete: function(event, ui){
        	    $(".dataSubmissionRegion .progressBar").fadeOut(300);
            	$(this).siblings(".submissionContent").children(".submittedItem").html(dataSubmission);
            	$(this).siblings(".submissionContent").children(".submittedItem").fadeIn(300);
        	}
        });
    });
});

// function to open/close sub-geography popup
var showSubGeo = function(popup,fadeSpeed){
    if(typeof activeWindow !== 'undefined'){
        clearTimeout(activeWindow.data('timeout'));
        activeWindow.fadeOut(fadeSpeed);
    }
    popup.fadeIn(fadeSpeed);
    activeWindow = popup;
    subGeoShowing = true;
};

var hideSubGeo = function(popup, fadeSpeed){
    popup.fadeOut(fadeSpeed);
    subGeoShowing = false;
};
var toggleIconLayer = function(){
    if($("#l2_breadcrumb").is(":visible")){
        switch(markersOn){
            case false:
                $("#mapSection").css("background", 'url("' + S3.Ap + '"/static/themes/Vulnerability/img/mapIconOnPng8.png") no-repeat center top transparent');
                $("#volunteerSection").css("background", 'url("' + S3.Ap + '"/static/themes/Vulnerability/img/volunteerIconOnPng8.png") no-repeat center top transparent');
                $(".iconSection").css("color", "#565656");
                markersOn=true;
                break;
            case true:
                $("#mapSection").css("background", 'url("' + S3.Ap + '"/static/themes/Vulnerability/img/mapIconOffPng8.png") no-repeat center top transparent');
                $("#volunteerSection").css("background", 'url("' + S3.Ap + '"/static/themes/Vulnerability/img/volunteerIconOffPng8.png") no-repeat center top transparent');
                $(".iconSection").css("color", "#ccc")
                markersOn=false;
                break;
        }
    }
};
var globalView = function(){
    $("#l0_breadcrumb, #l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb, #l4_breadcrumb, #l5_breadcrumb, #show-hide, #divider, #analysisLink, #indicator, #risingTab").hide();
    $(".hidden").hide("slow");
    $(".geoType").html("");
    $(".geoName").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a country");
    $(".activeWindow").fadeOut(300);
    $(".activeWindow").removeClass("activeWindow");
    $(".countryWindow").addClass("activeWindow");
    $(".activeWindow").fadeIn(300);
    $(".year").html("");
    refreshDropdowns("kitten");
};
var showReports = function(section){
    $(".rowForApproval").hide();
    $(".rowForApproval").prev().find(".closeReviewButton").hide();
    $(".rowForApproval").prev().find(".reviewButton").show();
    $(".headerRow.activeSection td.arrowCell .arrow").html("&rarr;");
    $(".headerRow.activeSection").removeClass("activeSection");
    $("." + section + "Header").addClass("activeSection");
    $(".headerRow.activeSection .arrow").html("&darr;");
    $(".activeContent").hide();
    $(".activeContent").removeClass("activeContent");
    $(".activeSection").next().addClass("activeContent");
    $(".activeSection").parent().next().addClass("activeContent");
    $(".activeContent").css("display", "block");
    $(".approvalScreen").hide();
    $("#lightbox, #reportsSection").fadeIn(300);
    resizeReports();
}
var toggleReports = function(filter){
    switch(filter){
        case "myReports":
            $(".allReports").removeClass("active").html("<a href=\"javascript:toggleReports('allReports')\" title='All Reports'>ALL REPORTS</a>");
            $(".myReports").addClass("active").html("MY REPORTS");
            break;
        case "allReports":
            $(".myReports").removeClass("active").html("<a href=\"javascript:toggleReports('myReports')\" title='My Reports'>MY REPORTS</a>")
            $(".allReports").addClass("active").html("ALL REPORTS");
            break;
    }
};
var showAnalysis = function(){
    $("#analysis").fadeIn(300);
    // $("#analysisToggle").css("left", 145 + $("#drawerTop .geoType").parent().innerWidth() + "px");
    // $("#backToMap").css("left", 347 + $("#drawerTop .geoType").parent().innerWidth() + "px");
    $("#reportsTopBar, #dataTopBar").fadeOut(300);
    $(".hidden").hide('slow');
    $("#show-hide").html("<span class='arrow'>&uarr;</span> SHOW MORE");
    if(drawerOpen){
        drawerOpen=false;
        setTimeout(function(){ $("#drawer").fadeOut(500); $("#analysisDrawerTop").fadeIn(500); }, 400)
    }else{ 
        $("#drawer").fadeOut(300);
        $("#analysisDrawerTop").fadeIn(300);
    }
    $(".eventMarkers").empty();
    for(var i=0; i< Math.ceil(Math.random()*20); i++){
        var left = Math.ceil(Math.random()*695);
        $(".eventMarkers").append("<div class='eventTriangle' style='left:" + left + "px;'></div>");
    }
};
var hideAnalysis = function(){
    $("#analysis, #analysisDrawerTop").fadeOut(300);
    $("#risingTab, #drawer, #reportsTopBar, #dataTopBar").fadeIn(300); 
}
var toggleAnalysis = function(){
    switch($("#analysisToggle select").val()){
        case "indicators":
            $("#analysisControl1, #analysisControl2, #analysisControl3, .lineGraphContainer, .eventMarkers, #analysisTimelineContainer, .regionIndicators").fadeOut(300);
            $("#analysisIndicatorsChart").css("height", $("#analysis").innerHeight()-141 + "px").fadeIn(300);
            setTimeout(function(){
                $(".regionIndicators h3, .regionIndicators .indicatorRating").hide();
                $(".regionIndicators input, .regionIndicators .popup h3").show();
                $("#analysis .regionIndicators").css("top", "210px");
                $(".regionIndicators").fadeIn(300);
            },500);
            $(".analysisDescription h2").html("Click to dive in to regions or rollover to see more.");
            $(".geoType span").html("in");
            $("#analysisDrawerTop .year").html($(".analysisUpperYearHidden").html());
            $(".analysisKey").css("width", "240px");
            $(".noDataBlock").fadeIn(300);
            break;
        case "overall":
            $("#analysisControl1, #analysisControl2, #analysisControl3, .lineGraphContainer, .eventMarkers, #analysisTimelineContainer").fadeIn(300);
            $(".regionIndicators, #analysisIndicatorsChart").fadeOut(300);
            setTimeout(function(){
                $(".regionIndicators h3, .regionIndicators .indicatorRating").show();
                $(".regionIndicators input").hide();
                $("#analysis .regionIndicators").css("top", "41%");
                $(".regionIndicators").fadeIn(300);
            },500);
            $(".geoType span").html("from");
            $("#analysisDrawerTop .year").html($(".analysisLowerYearHidden").html() + "&ndash;" + $(".analysisUpperYearHidden").html());
            $(".analysisDescription h2").html("Select <strong>up to 3 locations</strong> to compare overall resilience");
            $(".analysisKey").css("width", "190px");
            $(".noDataBlock").hide();
            break;
    }
}
var showSubmitData = function(toggle){
    $("#submitIndicators, #submitReports").removeClass("active");
    $("#submitDataFilters").css("background-color", "#c6c6c6")
    switch(toggle){
        case "indicators":
            $("#submitIndicators").addClass("active");
            $("#indicatorsSubmissionViews").show();
            $("dataAndReportsSubmissionViews").hide();
            $("#indicatorsSubmissionViews").children("div").hide();
            $("#submitDataFooter div, #submitDataFooter mark").hide();
            $("#submitDataContent .indicatorsStart").show();
            break;
        case "reports":
            $("#submitReports").addClass("active");
            $("#dataAndReportsSubmissionViews").show();
            $("#indicatorsSubmissionViews").hide();
            break;
    }
    $("#lightbox, #submitDataSection").fadeIn(300);
}
var indicatorsCheckCommune = function(){
    switch($("#l3_data").val()){
        case "na":
            $("#submitOnlineButton").addClass("disabled");
            $("#submitDataContent .indicatorsStart p").filter(":first").show(200);
            break;
        default:
            $("#submitOnlineButton").removeClass("disabled");
            $("#submitDataContent .indicatorsStart p").filter(":first").hide(200);
    }
}