/*
    Static JS for Vulnerability module

    Demo code: https://github.com/roraback/Vulnerability-Mapping/blob/master/js/controls.js
*/

var drawerOpen = false;
var colors = {
    0: '#999999',
    1: '#ff5121',
    2: '#f4961c',
    3: '#d6b317',
    4: '#77b826',
    5: '#059346'
}
var map, parser, proj4326, resilienceLayer;
var current_l0, current_l1, current_l2, current_l3;
//var current_l4;
S3.i18n.gis_requires_login = 'Requires Login';

// Load the Map asynchronously
yepnope({
    load: [S3.Ap.concat('/static/scripts/gis/OpenLayers.js'),
           S3.Ap.concat('/static/themes/Vulnerability/js/PanZoomBar.min.js')
           //S3.Ap.concat('/static/scripts/gis/openlayers/lib/OpenLayers/Strategy/Grid.js')
           ],
    complete: function(){
        showMap()
    }
})

$(document).ready(function(){
    // Top SelectMenu
    $('#dataTopBar').hover(function(){
        $('#dataTopBar img').css('background-color', '#f7941d');
        $('#dataTopBar img').attr('src', S3.Ap.concat('/static/themes/Vulnerability/img/dropdownArrowOverPng8.png'));
        $('#dataOptions').fadeIn(150);
        $('#defaultDataLink').css('color', '#c47a21');
    },
    function(){
        $('#dataTopBar img').css('background-color', 'transparent');
        $('#dataTopBar img').attr('src', S3.Ap.concat('/static/themes/Vulnerability/img/dropdownArrowPng8.png'));
        $('#dataOptions').fadeOut(150);
        $('#defaultDataLink').css('color', '#f7941d');
    });
    $('#reportsTopBar').hover(function(){
        $('#reportsTopBar img').css('background-color', '#f7941d');
        $('#reportsTopBar img').attr('src', S3.Ap.concat('/static/themes/Vulnerability/img/dropdownArrowOverPng8.png'));
        $('#reportsOptions').fadeIn(150);
        $('#defaultReportsLink').css('color', '#c47a21');
    },
    function(){
        $('#reportsTopBar img').css('background-color', 'transparent');
        $('#reportsTopBar img').attr('src', S3.Ap.concat('/static/themes/Vulnerability/img/dropdownArrowPng8.png'));
        $('#reportsOptions').fadeOut(150);
        $('#defaultReportsLink').css('color', '#f7941d');
    });

    // Search Autocomplete
    var data = {
        val: $('#dummy_location_search').val(),
        accept: false
    };
    var locationRepresent = function(item) {
        switch(item['level']) {
            case 'L0':
                return item['name'];
                break;
            case 'L1':
                return item['name'] + ',' + item['L0'];
                break;
            case 'L2':
                return item['name'] + ',' + item['L1'] + ',' + item['L0'];
                break;
            case 'L3':
                return item['name'] + ',' + item['L2'] + ',' + item['L1'] + ',' + item['L0'];
                break;
            //case 'L4':
            //    return item['name'] + ',' + item['L3'] + ',' + item['L2'] + ',' + item['L1'] + ',' + item['L0'];
            //    break;
            //case 'L5':
            //    return item['name'] + ',' + item['L4'] + ',' + item['L3'] + ',' + item['L2'] + ',' + item['L1'] + ',' + item['L0'];
            //    break;
            case 'None':
                // No Match
                return item['label'];
                break;
        }
    }
    var __response = $.ui.autocomplete.prototype._response;
    $.ui.autocomplete.prototype._response = function(content) {
        __response.apply(this, [content]);
        this.element.trigger('autocompletesearchcomplete', [content]);
    };
    $('#dummy_location_search').autocomplete({
        source: S3.Ap.concat('/gis/location/search.json?location.level__ne=None&filter=~&field=name&simple=1'),
        delay: 450,
        minLength: 2,
        position: {
            my: 'left bottom',
            at: 'left top'
        },
        search: function(event, ui) {
            $( '#dummy_location_search_throbber' ).removeClass('hidden').show();
            return true;
        },
        response: function(event, ui, content) {
            $( '#dummy_location_search_throbber' ).hide();
            if (ui.content.length == 0) {
                var widget = $().autocomplete('widget');
                var source = $('#dummy_location_search').autocomplete('option', 'source');
                // @ToDo: i18n
                $('#dummy_location_search').autocomplete('option', 'source', [{
                        'label': 'No matching result',
                        'value': 0,
                        'id': 0,
                        'name': 'No matching result',
                        'level': 'None'
                    }]);
                $('#dummy_location_search').autocomplete('search', 'No');
                content = [{'label': 'No matching result',
                            'value': 0,
                            'level': 'None',
                            'id': 0,
                            'name': 'No matching result'
                            }];
                // Restore source
                $('#dummy_location_search').autocomplete('option', 'source', source);
            }
            return content;
        },
        focus: function( event, ui ) {
            $( '#dummy_location_search' ).val( ui.item['name'] );
            return false;
        },
        select: function( event, ui ) {
            var id = ui.item.id;
            $( '#dummy_location_search' ).val( ui.item['name'] );
            $( '#location_search' ).val( id );
            $( '#location_search' ).change();
            data.accept = true;
            // Read extra data for location
            $.ajax({
                'url': S3.Ap.concat('/vulnerability/vdata/' + id),
                'success': function(data) {
                    // Copy the vdata elements across
                    for (var prop in n) {
                        vdata[prop] = n[prop];
                    }
                    // Clear the memory
                    n = null;
                    // Zoom to location
                    v_select_region(parseInt(ui.item.level[1]), id);
                },
                'error': function(request, status, error) {
                    if (error == 'UNAUTHORIZED') {
                        msg = S3.i18n.gis_requires_login;
                    } else {
                        msg = request.responseText;
                    }
                    console.log(msg);
                },
                'dataType': 'script'
            });
            return false;
        }
    })
    .data( 'autocomplete' )._renderItem = function( ul, item ) {
        return $( '<li></li>' )
            .data( 'item.autocomplete', item )
            .append( '<a>' + locationRepresent(item) + '</a>' )
            .appendTo( ul );
    };
    $('#dummy_location_search').blur(function() {
        if (!$('#dummy_location_search').val()) {
            $('#location_search').val('');
            data.accept = true;
        }
        if (!data.accept) {
            $('#dummy_location_search').val(data.val);
        } else {
            data.val = $('#dummy_location_search').val();
        }
        data.accept = false;
    });
    $('#dummy_location_search').bind('autocompletesearchcomplete', function(event, contents) {
        if (contents.length == 0) {
            $('#dummy_location_search').autocomplete('widget').show();
            //$('#ui-menu-0').show();
        }
    });

    // Indicator Names/Descriptions
    var ratings = [];
    var li;
    for (var i in idata) {
        li = "\
        <li>\
            <div class='indicatorRatingLabel'>\
                <div class='listText'>" + idata[i].n + "</div>\
                <div class='popup'>\
                    <div class='popupContent'>\
                        <h3>" + idata[i].n + "</h3>\
                        <p>" + idata[i].d + "</p>\
                    </div>\
                    <div class='popupBottom'></div>\
                </div>\
            </div>\
            <div class='visRange'>\
                <div class='indicatorRange' id='visRange" + i + "'>\
                    <div class='leftBox'></div>\
                    <div class='medianDot'></div>\
                    <div class='rightBox'></div>\
                </div>\
            </div>\
        </li>";
        ratings.push(li);
    }
    $('#indicatorRatingChart ul').html(ratings.join(''));

    // Hierarchical Dropdowns
    // Provide the initial options
    var res, selected;
    for (var prop in vdata) {
        switch(vdata[prop]['r']) {
            case 1:
                res = 'one';
                break;
            case 2:
                res = 'two';
                break;
            case 3:
                res = 'three';
                break;
            case 4:
                res = 'four';
                break;
            case 5:
                res = 'five';
                break;
            default:
                res = 'none';
                break;
        }
        if (prop == start) {
            selected = ' selected="selected"';
        } else {
            selected = '';
        }
        if (vdata[prop]['l'] == 0) {
            $('#l0_select').append('<option value="' + prop + '" class="' + res + '"' + selected + '>' + vdata[prop]['n'] + '</option>');
            $('#l0_reports').append('<option value="' + prop + '" class="' + res + '"' + selected + '>' + vdata[prop]['n'] + '</option>');
        } else if (vdata[prop]['l'] == 1) {
            $('#l1_select').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
            $('#l1_reports').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
        }
    };
    // Selection
    $('#l0_select, #l0_reports').change( function() {
        var id = this.value;
        var h = hdata[id];
        // Clear the old L1 values
        $('#l1_select').html('<option value="" selected="selected" class="none">Choose ' + h.l1 + '</option>');
        $('#l1_reports').html('<option value="" selected="selected" class="none">Choose ' + h.l1 + '</option>');
        // Populate the L1
        try {
            var test = vdata[id].i[2];
            lx_select(id, 0);
        } catch(err) {
            // We don't have this vdata, so read it
            readHierarchy(id, 0);
        }
    });
    $('#l1_select, #l1_reports').change( function() {
        var id = this.value;
        var h = hdata[$('#l0_select').val()];
        // Clear the old L2 values
        $('#l2_select').html('<option value="" selected="selected" class="none">Choose ' + h.l2 + '</option>');
        $('#l2_reports').html('<option value="" selected="selected" class="none">Choose ' + h.l2 + '</option>');
        // Populate the L2s
        try {
            var test = vdata[id].i[2];
            lx_select(id, 1);
        } catch(err) {
            // We don't have this vdata, so read it
            readHierarchy(id, 1);
        }
    });
    $('#l2_select, #l2_reports').change( function() {
        var id = this.value;
        var h = hdata[$('#l0_select').val()];
        // Clear the old L3 values
        $('#l3_select').html('<option value="" selected="selected" class="none">Choose ' + h.l3 + '</option>');
        $('#l3_reports').html('<option value="" selected="selected" class="none">Choose ' + h.l3 + '</option>');
        // Populate the L3s
        try {
            var test = vdata[id].i[2];
            lx_select(id, 2);
        } catch(err) {
            // We don't have this vdata, so read it
            readHierarchy(id, 2);
        }
    });
    //$('#l3_select, #l3_reports').change( function() {
    //    var id = this.value;
    //    var h = hdata[$('#l0_select').val()];
        // Clear the old L4 values
    //    $('#l4_select').html('<option value="" selected="selected" class="none">Choose ' + h.l4 + '</option>');
    //    $('#l4_reports').html('<option value="" selected="selected" class="none">Choose ' + h.l4 + '</option>');
        // Populate the L4s
    //    try {
    //        var test = vdata[id].i[2];
    //        lx_select(id, 3);
    //    } catch(err) {
            // We don't have this vdata, so read it
    //        readHierarchy(id, 3);
    //    }
    //});
    //$('#l4_select, #l4_reports').change( function() {
    //    var id = this.value;
    //    var h = hdata[$('#l0_select').val()];
        // Clear the old L5 values
    //    $('#l5_select').html('<option value="" selected="selected" class="none">Choose ' + h.l5 + '</option>');
    //    $('#l5_reports').html('<option value="" selected="selected" class="none">Choose ' + h.l5 + '</option>');
        // Populate the L4s
    //    try {
    //        var test = vdata[id].i[2];
    //        lx_select(id, 4);
    //    } catch(err) {
            // We don't have this vdata, so read it
    //        readHierarchy(id, 4);
    //    }
    //});

    // Add CSS classes for font smoothing
    // @ToDo: Are these useful without the fancy font?
    TypeHelpers.insertClasses();

    // Click events
    // Chrome frame
    $('.closechromeframe').click(function() { $('.chromeframe').hide(); });
    // Drawer
    $('#show-hide').click(function() { drawerSlide(); });
    $('#risingTab').click(function() { drawerSlide(); });
    // Calculations info box
    $('.calculationLink').click(function() {
        $('#lightbox, #calculationView').fadeIn(300);
    });
    $('#calculationView .closePanel').click(function() {
        $('#lightbox, #calculationView').fadeOut(300);
    });

    // Close sections when lightbox surrounding area or X in upper-right corner is clicked
    $('#lightbox').click(function() {
        $('#lightbox, #reportsSection, #calculationView, #photoPanel, #submitDataSection').fadeOut(300);
    });
    $('#reportsSection .closePanel').click(function() {
        $('#lightbox, #reportsSection').fadeOut(300);
    });
    $("#submitDataSection .closePanel").click(function(){
        $("#submitDataContent").animate({"scrollTop":0},100);
        $("#lightbox, #submitDataSection").fadeOut(300);
    });

    // Hover Events
    $('.listText').hover(
        function() {
            $(this).siblings('.popup').show();
        },
        function() {
            $(this).siblings('.popup').hide();
        }
    );

    $('.headerRow').click(function() {
        $('.rowForApproval').hide();
        $('.rowForApproval').prev().find('.closeReviewButton').hide();
        $('.rowForApproval').prev().find('.reviewButton').show();
        $('.headerRow.activeSection td.arrowCell .arrow').html('&rarr;');
        $('.headerRow.activeSection').removeClass('activeSection');
        $(this).addClass('activeSection');
        $('.headerRow.activeSection .arrow').html('&darr;');
        $('.activeContent').hide('slow');
        $('.activeContent').removeClass('activeContent');
        $(this).next().addClass('activeContent');
        $(this).parent().next().addClass('activeContent');
        $('.activeContent').fadeIn(200);
        resizeReports();
    });

    $('#filterSubmit').click(function() {
        // @ToDo: i18n
        displayThanks('Loading report details.', null);
        $('#table-container').empty();
        hideReportDetails(id);
        var data = getFilteredReport();
        $.ajax({
            type: 'POST',
            url: 'report/filter',
            data: data
        }).done(function(data) {
            $('.approvalScreen').hide();
            displayReport(data);
        }).fail(function() {
            // @ToDo: Something meaningful
            alert('error');
            $('.approvalScreen').hide();
        });
    });

    $("#submitIndicators, #submitReports").click(selectSubmitDataType);
    $("#uploadIndicatorsButton").click(uploadSubmitDataIndicators);
    $(".loadingErrorView .indicatorsButton").click(reloadSubmitDataFromError);
    $("#submitDataFooter .reviewNextButton").click(nextSubmitDataReview);
    $("#submitDataFooter .backButton").click(backSubmitDataReview);
    $("#submitDataFooter .submitAllButton").click(submitSubmitData);
    $("#submitDataFooter .submitMoreButton").click(moreSubmitData);



});

function readHierarchy(id, level) {
    $.ajax({
        'url': S3.Ap.concat('/vulnerability/vdata/' + id),
        'success': function(data) {
            // Copy the vdata elements across
            for (var prop in n) {
                vdata[prop] = n[prop];
            }
            // Clear the memory
            n = null;
            lx_select(id, level);
        },
        'error': function(request, status, error) {
            if (error == 'UNAUTHORIZED') {
                msg = S3.i18n.gis_requires_login;
            } else {
                msg = request.responseText;
            }
        },
        'dataType': 'script'
    });
}

function lx_select(id, level) {
    // Hierarchical dropdown has been selected
    if (level == 0) {
        // Set Labels
        var h = hdata[id];
        $('#l1 label').html(capitalize(h.l1) + ":");
        $('#l2 label').html(capitalize(h.l2) + ":");
        $('#l3 label').html(capitalize(h.l3) + ":");
        //$('#l4 label').html(capitalize(h.l4) + ":");
        $('#l1_report label').html(capitalize(h.l1) + ":");
        $('#l2_report label').html(capitalize(h.l2) + ":");
        $('#l3_report label').html(capitalize(h.l3) + ":");
        //$('#l4_report label').html(capitalize(h.l4) + ":");
    }
    level = level + 1;
    $('#l' + level).show();
    $('#l' + level + '_report').show();
    var v, res;
    for (var prop in vdata) {
        v = vdata[prop];
        if (v['f'] == null) {
            // pass
        } else if (v['f'] == id) {
            switch(v['r']) {
                case 1:
                    res = 'one';
                    break;
                case 2:
                    res = 'two';
                    break;
                case 3:
                    res = 'three';
                    break;
                case 4:
                    res = 'four';
                    break;
                case 5:
                    res = 'five';
                    break;
                default:
                    res = 'none';
                    break;
            }
            $('#l' + level + '_select').append('<option value="' + prop + '" class="' + res + '">' + v['n'] + '</option>');
            $('#l' + level + '_reports').append('<option value="' + prop + '" class="' + res + '">' + v['n'] + '</option>');
        }
    };

    // Update Select Menus
    updateSelectMenus();
}

function updateSelectMenus() {
    // Drawer SelectMenu
    $('#browseOtherRegions select').selectmenu({
        style: 'popup',
        maxHeight: 280,
        width: 160,
        menuWidth: 160,
        icons: [
            {find: '.one'},
            {find: '.two'},
            {find: '.three'},
            {find: '.four'},
            {find: '.five'}
        ]
    });

    // Reports SelectMenu
    $('.locationFilters select').selectmenu('destroy').selectmenu({
        style: 'popup',
        maxHeight: 280,
        width: 160,
        menuWidth: 160,
        icons: [
            {find: '.one'},
            {find: '.two'},
            {find: '.three'},
            {find: '.four'},
            {find: '.five'}
        ]
    });

    // Chart Switcher SelectMenu
    $('#chartSwitcher').selectmenu('destroy').selectmenu({
        style: 'popup',
        maxHeight: 280,
        width: 125,
        menuWidth: 125
    });
}

function showMap() {
    OpenLayers.ImgPath = S3.Ap.concat('/static/img/gis/openlayers/');
    proj4326 = new OpenLayers.Projection('EPSG:4326');

    /* Basic Map */
    map = new OpenLayers.Map('map', {
                                    // Use Manual stylesheet download (means can be done in HEAD to not delay pageload)
                                    theme: null
                                });
    //var layer = new OpenLayers.Layer.OSM('OpenStreetMap',
    //        ['http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png',
    //         'http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png',
    //         'http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png'],
    //         {attribution: 'Tiles Courtesy of <a href="http://open.mapquest.co.uk/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" border="0">'}
    //        );
    var layer = new OpenLayers.Layer.WMS(
        'VMap0',
        'http://vmap0.tiles.osgeo.org/wms/vmap0',
        {layers: 'basic'},
        {wrapDateLine: true}
    );
    map.addLayer(layer);

    // Draw below the mapKey
    OpenLayers.Control.PanZoom.Y = 50;
    var panZoomBar = new OpenLayers.Control.PanZoomBar();
    map.addControl(panZoomBar);

    parser = new OpenLayers.Format.GeoJSON({
            //'internalProjection': map.getProjectionObject(),
            //'externalProjection': proj4326
        });

    /* Resilience layer */
    var style = {
        fillColor: '${fill}',
        fillOpacity: '${fillOpacity}',
        strokeColor: '#ffffff',
        strokeWidth: '${strokeWidth}',
        strokeOpacity: 1,
        graphicWidth: 14,
        graphicHeight: 14,
        graphicXOffset: -7,
        graphicYOffset: -14,
        graphicOpacity: 1,
        externalGraphic: '${externalGraphic}'
    };
    var style_options = {
        context: {
            fill: function(feature) {
                var color = colors[feature.attributes.r];
                return color;
            },
            fillOpacity: function(feature) {
                if (feature.attributes.outline) {
                    return 0.1;
                } else {
                    return 0.5;
                }
            },
            strokeWidth: function(feature) {
                if (feature.attributes.outline) {
                    return 3;
                } else {
                    return 1;
                }
            },
            externalGraphic: function(feature) {
                var resilience = feature.attributes.r;
                if ( resilience == 5 ) {
                    var icon = '/static/themes/Vulnerability/img/rating5.png';
                } else if ( resilience == 4 ) {
                    var icon = '/static/themes/Vulnerability/img/rating4.png';
                } else if ( resilience == 3 ) {
                    var icon = '/static/themes/Vulnerability/img/rating3.png';
                } else if ( resilience == 2 ) {
                    var icon = '/static/themes/Vulnerability/img/rating2.png';
                } else if ( resilience == 1 ) {
                    var icon = '/static/themes/Vulnerability/img/rating1.png';
                } else {
                    return '';
                }
                return S3.Ap.concat(icon);
            }
        }
    };
    var resilienceStyle = new OpenLayers.Style(
        style,
        style_options
    );
    var resilienceStyleMap = new OpenLayers.StyleMap({
        'default': resilienceStyle,
        'select': {
            fillOpacity: 1
        }
    });
    strategy = new OpenLayers.Strategy.Fixed();
    //strategy = new OpenLayers.Strategy.Grid();
    protocol = new OpenLayers.Protocol.HTTP({
                    //url: "http://127.0.0.1:8080/countries/${z}/${x}/${y}.geojson",
                    url: S3.Ap.concat("/static/cache/countries.geojson"),
                    format: parser
                });
    resilienceLayer = new OpenLayers.Layer.Vector(
        'Resilience', {
            strategies: [strategy],
            protocol: protocol,
            styleMap: resilienceStyleMap
        }
    );
    map.addLayer(resilienceLayer);
    resilienceLayer.events.on({
        'beforefeatureadded': addAttributes,
        'featureselected': onResilienceFeatureSelect,
        'featureunselected': onFeatureUnselect
    });

    // Open at the correct level
    if (start == '') {
        globalView();
    } else {
        v_select_region(0, start);
    }

    // @ToDo: Listen for Disable/Enable events
    //$('#resilienceCheck').change();

    // @ToDo: Volunteers layer

    // @ToDo: Population Density layer

    // Popup control
    var popupControl = new OpenLayers.Control.SelectFeature(
        resilienceLayer, {
            toggle: true//,
            //onBeforeSelect: function(feature) {
            //    v_select_region(feature.attributes.l, feature.attributes.id);
            //}
        }
    );
    popupControl.handlers.feature.callbacks.dblclick = function(event) {
        closePopups();
        v_select_region(event.attributes.l, event.attributes.id);
        //return false;
    };
    map.addControl(popupControl);
    popupControl.activate();
}

/* Map support functions */
function addAttributes(event) {
    var f = event.feature;
    var id = f.attributes.id;
    var l;
    try {
        l = vdata[id].l;
    } catch(err) {
        // We don't have this vdata, so read it
        $.ajax({
            'url': S3.Ap.concat('/vulnerability/vdata/' + id),
            'async': false,
            'success': function(data) {
                // Copy the vdata elements across
                for (var prop in n) {
                    vdata[prop] = n[prop];
                }
                // Clear the memory
                n = null;
                l = vdata[id].l;
            },
            'error': function(request, status, error) {
                if (error == 'UNAUTHORIZED') {
                    msg = S3.i18n.gis_requires_login;
                } else {
                    msg = request.responseText;
                }
                console.log(msg);
            },
            'dataType': 'script'
        });
    }
    var r = vdata[id].r;
    f.attributes.l = l;
    f.attributes.r = r;
    // Add a Point at the Centroid
    var g = f.geometry;
    if (g.getArea() != 0.0) {
        // Not the Point we just added
        var p = new OpenLayers.Feature.Vector(g.getCentroid(), {
                                                  id: parseInt(id),
                                                  l: l,
                                                  r: r
                                                });
        resilienceLayer.addFeatures([p]);
    }
}

function onFeatureUnselect(event) {
    var feature = event.feature;
    if (feature.popup) {
        $('.ui-selectmenu-open').hide();
        map.removePopup(feature.popup);
        feature.popup.destroy();
        delete feature.popup;
    }
}

function onResilienceFeatureSelect(event) {
    if (drawerOpen) {
        // Close it
        drawerSlide();
    }
    var feature = event.feature;
    // Center the feature
    var centerPoint = feature.geometry.getBounds().getCenterLonLat();
    map.setCenter(centerPoint);

    var id = feature.attributes.id;
    var level = feature.attributes.l;
    var windowQualityRatings = "\
    <h3>DATA QUALITY:</h3>\
     <div class='windowQualityRatings'>\
        <div class='poor'>POOR\
            <div class='popup'>\
                <div class='popupContent'>\
                    <h3>POOR</h3>\
                    <p>0&ndash;25% of total data reported.</p>\
                </div>\
                <div class='popupBottom'></div>\
            </div>\
        </div> | \
        <div class='fair'>FAIR\
            <div class='popup'>\
                <div class='popupContent'>\
                    <h3>FAIR</h3>\
                    <p>25&ndash;50% of total data reported.</p>\
                </div>\
                <div class='popupBottom'></div>\
            </div>\
        </div> | \
        <div class='moderate'>MODERATE\
            <div class='popup'>\
                <div class='popupContent'>\
                    <h3>MODERATE</h3>\
                    <p>50&ndash;75% of total data reported.</p>\
                </div>\
                <div class='popupBottom'></div>\
            </div>\
        </div> | \
        <div class='strong'>STRONG\
            <div class='popup'>\
                <div class='popupContent'>\
                    <h3>STRONG</h3>\
                    <p>75&ndash;100% of total data reported.</p>\
                </div>\
                <div class='popupBottom'></div>\
            </div>\
        </div>\
    </div>";
    var iclass = '';
    var v = vdata[id];
    switch(level){
        case 0:
            var h = hdata[id];
            var type = 'Country';
            var typec = 'COUNTRY';
            var subtype = capitalize(h.l1);
            var commune = h.l3;
            var subGeoSelect = "\
            <h3>" + subtype + "S IN THIS " + typec + ":</h3>\
            <select class='subGeoSelect'></select>\
			<a id='goToSubRegion' class='goToSubRegion'>GO TO THE " + subtype + " <span class='arrow'>&rarr;</span></a>";
			break;
        case 1:
            var h = hdata[current_l0];
            var type = h.l1;
            var typec = capitalize(type);
            var subtype = capitalize(h.l2);
            var commune = h.l3;
            var subGeoSelect = "\
            <h3>" + subtype + "S IN THIS " + typec + ":</h3>\
            <select class='subGeoSelect'></select>\
			<a id='goToSubRegion' class='goToSubRegion'>GO TO THE " + subtype + " <span class='arrow'>&rarr;</span></a>";
			break;
        case 2:
            var h = hdata[current_l0];
            var type = h.l2;
            var typec = capitalize(type);
            var subtype = capitalize(h.l3);
            var commune = h.l3;
            var subGeoSelect = "\
            <h3>" + subtype + "S IN THIS " + typec + ":</h3>\
            <select class='subGeoSelect'></select>\
			<a id='goToSubRegion' class='goToSubRegion'>GO TO THE " + subtype + " <span class='arrow'>&rarr;</span></a>";
			break;
        case 3:
            var h = hdata[current_l0];
            var iclass = ' communeWindow';
            var type = h.l3;
            var typec = capitalize(type);
            var subtype = capitalize(h.l4);
            var commune;
            var subGeoSelect = '';
            var windowQualityRatings = "<div class='lastCollected'></div>";
			break;
        //case 4:
        //    var h = hdata[current_l0];
        //    var type = h.l4;
        //    var typec = capitalize(type);
        //    var commune;
        //    var subGeoSelect = '';
        //    var windowQualityRatings = "<div class='lastCollected'></div>";
		//	break;
    }
    var name = v.n;
    var resilience = v.r;
    if (resilience == 0) {
        resilience = '';
    }
    if (commune) {
        windowQualityRatings += "<div class='subGeoCommunesReported'></div>";
    }

    var contents = "\
    <section class='infoWindow'>\
		<div class='infoWindowMain unselectable'>\
			<div id='subGeoIndicator'>" + resilience + "</div>\
			<h2 class='subGeoName'>" + name + "</h2>\
			<h2 class='subGeoType'>" + type + "</h2>\
			<a id='goToRegion' class='goToSubRegion'>GO TO THE " + typec + " <span class='arrow'>&rarr;</span></a>\
			" + windowQualityRatings + "\
			<h3 id='population'>POPULATION: </h3>\
			" + subGeoSelect + "\
			<div class='infoWindowButtons'>\
				<div class='subGeoSubmitDataButton'>Submit Data</div>\
				<div class='subGeoAnalysisButton'>Analysis</div>\
				<div class='subGeoReportsButton'>Reports</div>\
			</div>\
		</div>\
	</section>";

    var popup = new OpenLayers.Popup.FramedCloud(
        id,
        centerPoint,
        new OpenLayers.Size(200, 200),
        contents,
        null,
        true,
        closePopups
    );
    feature.popup = popup;
    map.addPopup(popup);

    // Read extra data for location
    // Load the Popup Details asynchronously
    $.ajax({
        'url': S3.Ap.concat('/vulnerability/vdata/' + id),
        'success': function(data) {
            // Click Handler for Region Select
            $('#goToRegion').click(function(){
                v_select_region(level, id);
            });

            // Copy the vdata elements across
            for (var prop in n) {
                vdata[prop] = n[prop];
            }
            // Clear the memory
            n = null;
            v = vdata[id];
            if (commune) {
                // Add Communes info
                // @ToDo: i18n
                $('.subGeoCommunesReported').html(v['c'] + ' out of ' + v['t'] + ' ' + commune + 's Reported');
            } else {
                // Add Last collected info
                // @ToDo: i18n
                $('.windowQualityRatings').html('Last Data Collected on ' + v['t'] + ' by ' + v['c']);
            }
            // Add Population info
            var pop = v['p'];
            if (pop == null) {
            } else {
                $('#population').html('POPULATION: ' + pop);
            }
            // @ToDo: Add Images

            // Select Quality
            switch(v['q']) {
                 case 'p':
                    $('.poor').addClass('currentQuality');
                    break;
                 case 'f':
                    $('.fair').addClass('currentQuality');
                    break;
                 case 'm':
                    $('.moderate').addClass('currentQuality');
                    break;
                 case 's':
                    $('.strong').addClass('currentQuality');
                    break;
            }
            var res;
            for (var prop in vdata) {
                if ((vdata[prop]['l'] == level + 1) && (vdata[prop]['f'] == id)) {
                    switch(vdata[prop]['r']) {
                        case 1:
                            res = 'one';
                            break;
                        case 2:
                            res = 'two';
                            break;
                        case 3:
                            res = 'three';
                            break;
                        case 4:
                            res = 'four';
                            break;
                        case 5:
                            res = 'five';
                            break;
                        default:
                            res = 'none';
                            break;
                    }
                    $('.subGeoSelect').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
                }
            };
            // Add style to select
            $('.subGeoSelect').selectmenu({
                style: 'popup',
                maxHeight: 280,
                width: 160,
                menuWidth: 160,
                icons: [
                    {find: '.one'},
                    {find: '.two'},
                    {find: '.three'},
                    {find: '.four'},
                    {find: '.five'}
                ]
            });
            // Click Handler for SubRegion Select
            $('#goToSubRegion').click(function(){
                var id = $('.subGeoSelect').val();
                v_select_region(level + 1, id);
            });
            popup.updateSize();
            // Resize when images are loaded
            //popup.registerImageListeners();
        },
        'error': function(request, status, error) {
            if (error == 'UNAUTHORIZED') {
                msg = S3.i18n.gis_requires_login;
            } else {
                msg = request.responseText;
            }
            $('#' + id + '_contentDiv').html(msg);
            popup.updateSize();
        },
        'dataType': 'script'
    });
    // Set the CSS for the Indicator box
    if ( resilience == '' ) {
        $('#subGeoIndicator').css('background-color', colors[0]);
    } else {
        $('#subGeoIndicator').css('background-color', colors[resilience]);
    }
}

function closePopups(event) {
    // Close all Popups
    // Close popups associated with features
    //S3.gis.popupControl.unselectAll();
    // Close orphaned Popups (e.g. from Refresh)
    while (map.popups.length) {
        map.removePopup(map.popups[0]);
    }
}

function hideFeature(id) {
    var features = resilienceLayer.getFeaturesByAttribute("id", parseInt(id));
    for (var prop in features) {
        // 'remove' is a prop
        try {
            var feature = features[prop];
            if (feature.geometry.getArea() == 0.0) {
                // Remove the Point
                feature.destroy();
            } else {
                // Restyle the Polygon to just thicker border with no fill
                feature.attributes.outline = 1;
                resilienceLayer.drawFeature(feature);
            }
        } catch(err) {};
    }
}

function showFeature(id) {
    if (id == null) {
        return;
    }
    var features = resilienceLayer.getFeaturesByAttribute("id", parseInt(id));
    for (var prop in features) {
        // 'remove' is a prop
        try {
            var feature = features[prop];
            // Restyle the Polygon
            feature.attributes.outline = 0;
            resilienceLayer.drawFeature(feature);
            // Add a Point at the Centroid
            var g = feature.geometry;
            var p = new OpenLayers.Feature.Vector(g.getCentroid(), {
                                                      id: parseInt(id),
                                                      l: feature.attributes.l,
                                                      r: feature.attributes.r
                                                    });
            resilienceLayer.addFeatures([p]);
        } catch(err) {};
    }
}

function removeFeatures(level) {
    var feature;
    var features = [];
    for (var prop in resilienceLayer.features) {
        feature = resilienceLayer.features[prop];
        // 'remove' is a prop
        try {
            if (feature.attributes.l >= level) {
                // Don't destroy here or indices get altered!
                features.push(feature);
            }
        } catch(err) {};
    }
    resilienceLayer.destroyFeatures(features);
}

var globalView = function(){
    // Close Popups
    closePopups();

    // Remove all Features > L0
    removeFeatures(1);

    // Zoom to full AP region
    var bottom_left = new OpenLayers.LonLat(80, -50).transform(
            proj4326,
            map.getProjectionObject()
        )
    var top_right = new OpenLayers.LonLat(180, 50).transform(
            proj4326,
            map.getProjectionObject()
        )
    var bounds = [bottom_left.lon, bottom_left.lat, top_right.lon, top_right.lat];
    map.zoomToExtent(bounds);

    // Display the old Lx normally again
    showFeature(current_l0);
    showFeature(current_l1);
    showFeature(current_l2);
    showFeature(current_l3);
    //showFeature(current_l4);

    // Tweak menu bars
    $('#l0_breadcrumb, #l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb, #show-hide, #divider, #analysisLink, #indicator, #risingTab').hide();
    //$('#l4_breadcrumb, #l5_breadcrumb').hide();
    $('.geoName').html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select a country');
    $('.geoType').html('');
    $('.year').html('');
    markersOff();
    
    current_l0 = null;
    current_l1 = null;
    current_l2 = null;
    current_l3 = null;
    //current_l4 = null;
};

var v_select_region = function(level, id) {

    closePopups();
    var v = vdata[id];

    switch(level){
        case 0:
            if (current_l0 != id) {
                showFeature(current_l0);
            }
            current_l0 = id;
            current_l1 = '';
            current_l2 = '';
            current_l3 = '';
            //current_l4 = '';
            //current_l5 = '';
            var h = hdata[id];
            var l0_name = v.n;
            $('#l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb').hide()
            //$('#l4_breadcrumb, #l5_breadcrumb').hide()
            $('#l0_breadcrumb').show().attr('href', 'javascript:v_select_region(0,' + id + ');');
            $('#l0_breadcrumb span').html(' &raquo; ' + l0_name);
            $('#geoName').html(l0_name);
            // @ToDo: i18n
            $('.geoType').html('Country in');
            $('#l0_select').val(id);
            $('#l0_reports').val(id);
            $('#l1_select, #l2_select, #l3_select').val('');
            $('#l1_report, #l2_report, #l3_report').val('');
            $('#l2, #l3').hide();
            $('#l2_report, #l3_report').hide();
            //$('#l4_select, #l5_select').val('');
            //$('#l4_report, #l5_report').val('');
            //$('#l4, #l5').hide();
            //$('#l4_report, #l5_report').hide();
            markersOff();
            // Remove all Features > L0
            removeFeatures(1);
            // Hide this L0 feature
            hideFeature(id);
            // Add the child L1 features to the map
            $.ajax({
                'url': S3.Ap.concat('/static/cache/1_' + id + '.geojson'),
                'success': function(data) {
                    var features = parser.read(data);
                    for (var prop in features) {
                        // 'remove' is a prop
                        try {
                            if (features[prop].geometry) {
                                features[prop].geometry.transform(proj4326,
                                                                  map.getProjectionObject());
                            }
                        } catch(err) {};
                    }
                    resilienceLayer.addFeatures(features);
                },
                'error': function(request, status, error) {
                    if (error == 'UNAUTHORIZED') {
                        msg = S3.i18n.gis_requires_login;
                    } else {
                        msg = request.responseText;
                    }
                    console.log(msg);
                },
                'dataType': 'json'
            });
            break;
        case 1:
            if (current_l1 != id) {
                // Restyle the old L1 again
                showFeature(current_l1);
            }
            current_l1 = id;
            if (current_l0 != v.f) {
                // Restyle the old L0 again
                showFeature(current_l0);
            }
            current_l0 = v.f;
            current_l2 = '';
            current_l3 = '';
            //current_l4 = '';
            //current_l5 = '';
            var h = hdata[current_l0];
            var l0_name = vdata[current_l0].n;
            var l1_name = v.n;
            $('#l2_breadcrumb, #l3_breadcrumb').hide()
            //$('#l4_breadcrumb, #l5_breadcrumb').hide()
            $('#l0_breadcrumb').show().attr('href', 'javascript:v_select_region(0,' + current_l0 + ');');
            $('#l0_breadcrumb span').html(' &raquo; ' + l0_name);
            $('#l1_breadcrumb').show().attr('href', 'javascript:v_select_region(1,' + id + ');');
            $('#l1_breadcrumb span').html(' &raquo; ' + l1_name);
            $('#geoName').html(l1_name);
            var type = h.l1;
            $('.geoType').html(type + ' in');
            $('#l0_select').val(current_l0);
            $('#l0_reports').val(current_l0);
            $('#l1_select').val(id);
            $('#l1_reports').val(id);
            $('#l2_select, #l3_select').val('');
            $('#l2_reports, #l3_reports').val('');
            $('#l2').show();
            $('#l2_report').show();
            $('#l3').hide();
            $('#l3_report').hide();
            //$('#l4_select, #l5_select').val('');
            //$('#l4_reports, #l5_reports').val('');
            //$('#l4, #l5').hide();
            //$('#l4_report, #l5_report').hide();
            markersOff();
            // Remove all Features > L1
            removeFeatures(2);
            // Check if this feature exists
            var features = resilienceLayer.getFeaturesByAttribute("id", parseInt(id));
            if (features = []) {
                // Load this feature
                $.ajax({
                    'url': S3.Ap.concat('/static/cache/1_' + current_l0 + '.geojson'),
                    'async': false,
                    'success': function(data) {
                        var features = parser.read(data);
                        var newfeatures = [];
                        for (var prop in features) {
                            // 'remove' is a prop
                            try {
                                if (features[prop].attributes.id == id) {
                                    features[prop].geometry.transform(proj4326,
                                                                      map.getProjectionObject());
                                    newfeatures.push(features[prop]);
                                }
                            } catch(err) {};
                        }
                        resilienceLayer.addFeatures(newfeatures);
                    },
                    'error': function(request, status, error) {
                        if (error == 'UNAUTHORIZED') {
                            msg = S3.i18n.gis_requires_login;
                        } else {
                            msg = request.responseText;
                        }
                        console.log(msg);
                    },
                    'dataType': 'json'
                });
            }
            // Hide this L1 feature
            hideFeature(id);
            // Add the child L2 features to the map
            $.ajax({
                'url': S3.Ap.concat('/static/cache/2_' + id + '.geojson'),
                'success': function(data) {
                    var features = parser.read(data);
                    for (var prop in features) {
                        // 'remove' is a prop
                        try {
                            if (features[prop].geometry) {
                                features[prop].geometry.transform(proj4326,
                                                                  map.getProjectionObject());
                            }
                        } catch(err) {};
                    }
                    resilienceLayer.addFeatures(features);
                },
                'error': function(request, status, error) {
                    if (error == 'UNAUTHORIZED') {
                        msg = S3.i18n.gis_requires_login;
                    } else {
                        msg = request.responseText;
                    }
                    console.log(msg);
                },
                'dataType': 'json'
            });
            break;
        case 2:
            if (current_l2 != id) {
                // Restyle the old L2 again
                showFeature(current_l2);
            }
            current_l2 = id;
            if (current_l1 != v.f) {
                // Restyle the old L1 again
                showFeature(current_l1);
            }
            current_l1 = v.f;
            if (current_l0 != vdata[current_l1].f) {
                // Restyle the old L0 again
                showFeature(current_l0);
            }
            current_l0 = vdata[current_l1].f;
            current_l3 = '';
            //current_l4 = '';
            //current_l5 = '';
            var h = hdata[current_l0];
            var l0_name = vdata[current_l0].n;
            var l1_name = vdata[current_l1].n;
            var l2_name = v.n;
            $('#l3_breadcrumb').hide()
            //$('#l4_breadcrumb, #l5_breadcrumb').hide()
            $('#l0_breadcrumb').show().attr('href', 'javascript:v_select_region(0,' + current_l0 + ');');
            $('#l0_breadcrumb span').html(' &raquo; ' + l0_name);
            $('#l1_breadcrumb').show().attr('href', 'javascript:v_select_region(1,' + current_l1 + ');');
            $('#l1_breadcrumb span').html(' &raquo; ' + l1_name);
            $('#l2_breadcrumb').show().attr('href', 'javascript:v_select_region(2,' + id + ');');
            $('#l2_breadcrumb span').html(' &raquo; ' + l2_name);
            $('#geoName').html(l2_name);
            var type = h.l2;
            $('.geoType').html(type + ' in');
            $('#l0_select').val(current_l0);
            $('#l0_reports').val(current_l0);
            $('#l1_select').val(current_l1);
            $('#l1_reports').val(current_l1);
            $('#l2_select').val(id);
            $('#l2_reports').val(id);
            $('#l3_report').val('');
            //$('#l4_report, #l5_report').val('');
            $('#l2, #l3').show();
            $('#l2_reports, #l3_reports').show();
            //$('#l4, #l5').hide();
            //$('#l4_report, #l5_report').hide();
            markersOn();
            // Remove all Features > L2
            removeFeatures(3);
            // Check if this feature exists
            var features = resilienceLayer.getFeaturesByAttribute("id", parseInt(id));
            if (features = []) {
                // Load this feature
                $.ajax({
                    'url': S3.Ap.concat('/static/cache/2_' + current_l1 + '.geojson'),
                    'async': false,
                    'success': function(data) {
                        var features = parser.read(data);
                        var newfeatures = [];
                        for (var prop in features) {
                            // 'remove' is a prop
                            try {
                                if (features[prop].id == id) {
                                    features[prop].geometry.transform(proj4326,
                                                                      map.getProjectionObject());
                                    newfeatures.push(features[prop]);
                                }
                            } catch(err) {};
                        }
                        resilienceLayer.addFeatures(newfeatures);
                    },
                    'error': function(request, status, error) {
                        if (error == 'UNAUTHORIZED') {
                            msg = S3.i18n.gis_requires_login;
                        } else {
                            msg = request.responseText;
                        }
                        console.log(msg);
                    },
                    'dataType': 'json'
                });
            }
            // Hide this L2 feature
            hideFeature(id);
            // Add the child L3 features to the map
            $.ajax({
                'url': S3.Ap.concat('/static/cache/3_' + id + '.geojson'),
                'success': function(data) {
                    var features = parser.read(data);
                    for (var prop in features) {
                        // 'remove' is a prop
                        try {
                            if (features[prop].geometry) {
                                features[prop].geometry.transform(proj4326,
                                                                  map.getProjectionObject());
                            }
                        } catch(err) {};
                    }
                    resilienceLayer.addFeatures(features);
                },
                'error': function(request, status, error) {
                    if (error == 'UNAUTHORIZED') {
                        msg = S3.i18n.gis_requires_login;
                    } else {
                        msg = request.responseText;
                    }
                    console.log(msg);
                },
                'dataType': 'json'
            });
            break;
        case 3:
            if (current_l3 != id) {
                // Restyle the old L3 again
                showFeature(current_l3);
            }
            current_l3 = id;
            if (current_l2 != v.f) {
                // Restyle the old L2 again
                showFeature(current_l2);
            }
            current_l2 = v.f;
            if (current_l1 != vdata[current_l2].f) {
                // Restyle the old L1 again
                showFeature(current_l1);
            }
            current_l1 = vdata[current_l2].f;
            if (current_l0 != vdata[current_l1].f) {
                // Restyle the old L0 again
                showFeature(current_l0);
            }
            current_l0 = vdata[current_l1].f;
            //current_l4 = '';
            //current_l5 = '';
            var h = hdata[current_l0];
            var l0_name = vdata[current_l0].n;
            var l1_name = vdata[current_l1].n;
            var l2_name = vdata[current_l2].n;
            var l3_name = v.n;
            //$('#l4_breadcrumb, #l5_breadcrumb').hide()
            $('#l0_breadcrumb').show().attr('href', 'javascript:v_select_region(0,' + current_l0 + ');');
            $('#l0_breadcrumb span').html(' &raquo; ' + l0_name);
            $('#l1_breadcrumb').show().attr('href', 'javascript:v_select_region(1,' + current_l1 + ');');
            $('#l1_breadcrumb span').html(' &raquo; ' + l1_name);
            $('#l2_breadcrumb').show().attr('href', 'javascript:v_select_region(2,' + current_l2 + ');');
            $('#l2_breadcrumb span').html(' &raquo; ' + l2_name);
            $('#l3_breadcrumb').show().attr('href', 'javascript:v_select_region(3,' + id + ');');
            $('#l3_breadcrumb span').html(' &raquo; ' + l3_name);
            $('#geoName').html(l3_name);
            var type = h.l3;
            $('.geoType').html(type + ' in');
            $('#l0_select').val(current_l0);
            $('#l0_reports').val(current_l0);
            $('#l1_select').val(current_l1);
            $('#l1_reports').val(current_l1);
            $('#l2_select').val(current_l2);
            $('#l2_reports').val(current_l2);
            $('#l3_select').val(id);
            $('#l3_reports').val(id);
            //$('#l4, #l5').val('');
            $('#l2, #l3').show();
            //$('#l4').show();
            $('#l2_report, #l3_report').show();
            //$('#l4_report').show();
            //$('#l5').hide();
            //$('#l5_report').hide();
            markersOn();
            // Remove all Features > L3
            //removeFeatures(4);
            // Check if this feature exists
            var features = resilienceLayer.getFeaturesByAttribute("id", parseInt(id));
            if (features = []) {
                // Load this feature
                $.ajax({
                    'url': S3.Ap.concat('/static/cache/3_' + current_l2 + '.geojson'),
                    'async': false,
                    'success': function(data) {
                        var features = parser.read(data);
                        var newfeatures = [];
                        for (var prop in features) {
                            // 'remove' is a prop
                            try {
                                if (features[prop].id == id) {
                                    features[prop].geometry.transform(proj4326,
                                                                      map.getProjectionObject());
                                    newfeatures.push(features[prop]);
                                }
                            } catch(err) {};
                        }
                        resilienceLayer.addFeatures(newfeatures);
                    },
                    'error': function(request, status, error) {
                        if (error == 'UNAUTHORIZED') {
                            msg = S3.i18n.gis_requires_login;
                        } else {
                            msg = request.responseText;
                        }
                        console.log(msg);
                    },
                    'dataType': 'json'
                });
            }
            // Hide this L3 feature
            //hideFeature(id);
            // Add the child L4 features to the map
            //$.ajax({
            //    'url': S3.Ap.concat('/static/cache/4_' + id + '.geojson'),
            //    'success': function(data) {
            //        var features = parser.read(data);
            //        for (var prop in features) {
                        // 'remove' is a prop
            //            try {
            //                if (features[prop].geometry) {
            //                    features[prop].geometry.transform(proj4326,
            //                                                      map.getProjectionObject());
            //                }
            //            } catch(err) {};
            //        }
            //        resilienceLayer.addFeatures(features);
            //    },
            //    'error': function(request, status, error) {
            //        if (error == 'UNAUTHORIZED') {
            //            msg = S3.i18n.gis_requires_login;
            //        } else {
            //            msg = request.responseText;
            //        }
            //        console.log(msg);
            //    },
            //    'dataType': 'json'
            //});
            break;
        //case 4:
        //    current_l4 = id;
        //    if (current_l3 != v.f) {
                // Restyle the old L3 again
        //        showFeature(current_l3);
        //    }
        //    current_l3 = v.f;
        //    if (current_l2 != vdata[current_l3].f) {
                // Restyle the old L2 again
        //        showFeature(current_l2);
        //    }
        //    current_l2 = vdata[current_l3].f;
        //    if (current_l1 != vdata[current_l2].f) {
                // Restyle the old L1 again
        //      showFeature(current_l1);
        //    }
        //    current_l1 = vdata[current_l2].f;
        //    if (current_l0 != vdata[current_l1].f) {
                // Restyle the old L0 again
        //        showFeature(current_l0);
        //    }
        //    current_l0 = vdata[current_l1].f;
        //    current_l4 = id;
            //current_l5 = '';
        //    var l0_name = vdata[current_l0].n;
        //    var l1_name = vdata[current_l1].n;
        //    var l2_name = vdata[current_l2].n;
        //    var l3_name = vdata[current_l3].n;
        //    var l4_name = v.n;
        //    $('#l5_breadcrumb').hide()
        //    $('#l0_breadcrumb').show().attr('href', 'javascript:v_select_region(0,' + current_l0 + ');');
        //    $('#l0_breadcrumb span').html(' &raquo; ' + l0_name);
        //    $('#l1_breadcrumb').show().attr('href', 'javascript:v_select_region(1,' + current_l1 + ');');
        //    $('#l1_breadcrumb span').html(' &raquo; ' + l1_name);
        //    $('#l2_breadcrumb').show().attr('href', 'javascript:v_select_region(2,' + current_l2 + ');');
        //    $('#l2_breadcrumb span').html(' &raquo; ' + l2_name);
        //    $('#l3_breadcrumb').show().attr('href', 'javascript:v_select_region(3,' + current_l3 + ');');
        //    $('#l3_breadcrumb span').html(' &raquo; ' + l3_name);
        //    $('#l4_breadcrumb').show().attr('href', 'javascript:v_select_region(4,' + id + ');');
        //    $('#l4_breadcrumb span').html(' &raquo; ' + l4_name);
        //    $('#geoName').html(l4_name);
        //    var type = h.l4;
        //    $('.geoType').html(type + ' in');
        //    $('#l0_select').val(current_l0);
        //    $('#l0_reports').val(current_l0);
        //    $('#l1_select').val(current_l1);
        //    $('#l1_reports').val(current_l1);
        //    $('#l2_select').val(current_l2);
        //    $('#l2_reports').val(current_l2);
        //    $('#l3_select').val(current_l3);
        //    $('#l3_reports').val(current_l3);
        //    $('#l4_select').val(id);
        //    $('#l4_reports').val(id);
        //    $('#l5_select').val('');
        //    $('#l5_reports').val('');
        //    $('#l2, #l3, #l4, #l5').show();
        //    $('#l2_report, #l3_report, #l4_report, #l5_report').show();
        //    markersOn();
        //    break;
    }
    var features = resilienceLayer.getFeaturesByAttribute("id", parseInt(id));
    for (var prop in features) {
        // 'remove' is a prop
        try {
            var feature = features[prop];
            if (feature.geometry.getArea() != 0.0) {
                var bounds = feature.geometry.getBounds();
                map.zoomToExtent(bounds);
            }
        } catch(err) {};
    }

    // @ToDo: something dynamic
    $('.year').html('2012');

    // Set the CSS for the Indicator boxes
    var resilience = v.r;
    if ( resilience == null ) {
        $('#indicator').css('background-color', colors[0]);
        $('#mainRating').css('background-color', colors[0]);
    } else {
        $('#indicator').html(resilience);
        $('#mainRating').html(resilience);
        $('#indicator').css('background-color', colors[resilience]);
        $('#mainRating').css('background-color', colors[resilience]);
    }

    // Display the ability to open the Drawer
    $('#show-hide').html('<span class="arrow">&uarr;</span> SHOW MORE').show();
    $('#divider').show();
    $('#analysisLink').show();
    var image = S3.Ap.concat('/static/themes/Vulnerability/img/openTabPng8.png');
    $('#risingTab').css('background-image', 'url(' + image + ')').show();

    // Update the Indicator Ratings
    var i = v.i;
    var found = false;
    for (var prop in i) {
        var found = true;
        var id = prop;
        var p = i[prop];
        var min = p.min;
        var max = p.max;
        var med = p.med;
        var selector = '#visRange' + id;
        // Set left margin
        $(selector).css('left', (58 * min) + 'px');
        // Set width of the range
        $(selector).css('width', (58 * (max - min)) + 'px');
        // Position the median
        $(selector + ' .medianDot').css('left', (58 * (med - min)) + 'px');
        if (med == min) {
            // Hide the min bar
            $(selector + ' .leftBox').hide();
        } else {
            $(selector + ' .leftBox').show();
        }
        if (med == max) {
            // Hide the max bar
            $(selector + ' .rightBox').hide();
        } else {
            $(selector + ' .rightBox').show();
        }
    }
    if (found) {
        $('.visRange').show();
    } else {
        // No Indicators found, so clear screen
        $('.visRange').hide();
    }

    // Add the Data Quality elements
    // @ToDo: i18n
    $('#qualityCommunes').html(v.c + ' out of ' + v.t + ' ' + h.l4 + 's Reported');
    switch(v.q) {
        case 'p':
            $('#poor').addClass('currentQuality');
            $('#fair').removeClass('currentQuality');
            $('#moderate').removeClass('currentQuality');
            $('#strong').removeClass('currentQuality');
            break;
        case 'f':
            $('#poor').removeClass('currentQuality');
            $('#fair').addClass('currentQuality');
            $('#moderate').removeClass('currentQuality');
            $('#strong').removeClass('currentQuality');
            break;
        case 'm':
            $('#poor').removeClass('currentQuality');
            $('#fair').removeClass('currentQuality');
            $('#moderate').addClass('currentQuality');
            $('#strong').removeClass('currentQuality');
            break;
        case 's':
            $('#poor').removeClass('currentQuality');
            $('#fair').removeClass('currentQuality');
            $('#moderate').removeClass('currentQuality');
            $('#strong').addClass('currentQuality');
            break;
    }
    $('#populationCount .listText').html(v.p);
    $('#populationCount .popupContent p').html(v.s);
    if (level == 4) {
        for (var prop in v.b) {
            var b = v.b[prop];
            $('#dataBreakdown ul').append("\
            <li>\
                <p>" + b.n + ":</p>\
                <div class='statistic'>\
                    <div class='listText'>" + b.v + "</div>\
                    <div class='popup'>\
                        <div class='popupContent'>\
                            <p>Source: " + b.s + "</p>\
                        </div>\
                        <div class='popupBottom'></div>\
                    </div>\
                </div>\
            </li>\
            ");
        }
    }

    // Update the options for the Hierarchical Dropdowns
    // Reset
    if (current_l1) {
        $('#l1_select').html('<option value="" class="none">Choose ' + h.l1 + '</option>');
        $('#l1_reports').html('<option value="" class="none">Choose ' + h.l1 + '</option>');
    } else {
        $('#l1_select').html('<option value="" selected="selected" class="none">Choose ' + h.l1 + '</option>');
        $('#l1_reports').html('<option value="" selected="selected" class="none">Choose ' + h.l1 + '</option>');
    }
    if (current_l2) {
        $('#l2_select').html('<option value="" class="none">Choose ' + h.l2 + '</option>');
        $('#l2_reports').html('<option value="" class="none">Choose ' + h.l2 + '</option>');
    } else {
        $('#l2_select').html('<option value="" selected="selected" class="none">Choose ' + h.l2 + '</option>');
        $('#l2_reports').html('<option value="" selected="selected" class="none">Choose ' + h.l2 + '</option>');
    }
    if (current_l3) {
        $('#l3_select').html('<option value="" class="none">Choose ' + h.l3 + '</option>');
        $('#l3_reports').html('<option value="" class="none">Choose ' + h.l3 + '</option>');
    } else {
        $('#l3_select').html('<option value="" selected="selected" class="none">Choose ' + h.l3 + '</option>');
        $('#l3_reports').html('<option value="" selected="selected" class="none">Choose ' + h.l3 + '</option>');
    }
    //if (current_l4) {
    //    $('#l4_select').html('<option value="" class="none">Choose ' + h.l4 + '</option>');
    //    $('#l4_reports').html('<option value="" class="none">Choose ' + h.l4 + '</option>');
    //} else {
    //    $('#l4_select').html('<option value="" selected="selected" class="none">Choose ' + h.l4 + '</option>');
    //    $('#l4_reports').html('<option value="" selected="selected" class="none">Choose ' + h.l4 + '</option>');
    //}
    // Add entries
    for (var prop in vdata) {
        switch(vdata[prop]['r']) {
            case 1:
                res = 'one';
                break;
            case 2:
                res = 'two';
                break;
            case 3:
                res = 'three';
                break;
            case 4:
                res = 'four';
                break;
            case 5:
                res = 'five';
                break;
            default:
                res = 'none';
                break;
        }
        if (vdata[prop]['f'] == null) {
            // pass
        } else if (vdata[prop]['f'] == current_l0) {
            $('#l1_select').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
            $('#l1_reports').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
        } else if (vdata[prop]['f'] == current_l1) {
            $('#l2_select').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
            $('#l2_reports').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
        } else if (vdata[prop]['f'] == current_l2) {
            $('#l3_select').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
            $('#l3_reports').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
        //} else if (vdata[prop]['f'] == current_l3) {
        //    $('#l4_select').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
        //    $('#l4_reports').append('<option value="' + prop + '" class="' + res + '">' + vdata[prop]['n'] + '</option>');
        }
    };
    // Set Labels
    $('#l1 label').html(capitalize(h.l1) + ":");
    $('#l2 label').html(capitalize(h.l2) + ":");
    $('#l3 label').html(capitalize(h.l3) + ":");
    //$('#l4 label').html(capitalize(h.l4) + ":");
    $('#l1_report label').html(capitalize(h.l1) + ":");
    $('#l2_report label').html(capitalize(h.l2) + ":");
    $('#l3_report label').html(capitalize(h.l3) + ":");
    //$('#l4_report label').html(capitalize(h.l4) + ":");

    // Update Select Menus
    updateSelectMenus();
}

// function to open/close the drawer
var drawerSlide = function() {
    switch(drawerOpen){
        case true:
            // Close
            $('.hidden').hide('slow');
            $('#show-hide').html('<span class="arrow">&uarr;</span> SHOW MORE');
            var image = S3.Ap.concat('/static/themes/Vulnerability/img/openTabPng8.png');
            $('#risingTab').css('background-image', 'url(' + image + ')');
            $('.olPopup').fadeIn(300);
            $('#dummy_location_search').autocomplete('option', 'position', { my: 'left bottom', at: 'left top' } );
            drawerOpen = false;
            break;
        case false:
            // Open
            $('#drawerInside').show('slow');
            $('#drawerInside').data('fade', setTimeout(function(){ 
                $('#resilienceSummary, #drawerQuickActions, #indicatorRatingChart, #browseOtherRegions, #dataBreakdown').fadeIn(500);
                $('.communeOnly').hide();
            }, 500));
            $('#show-hide').html('<span class="arrow">&darr;</span> SHOW LESS');
            var image = S3.Ap.concat('/static/themes/Vulnerability/img/closeTabPng8.png');
            $('#risingTab').css('background-image', 'url(' + image + ')');
            $('.olPopup').fadeOut(300);
            $('#dummy_location_search').autocomplete('option', 'position', { my: 'left top', at: 'left bottom' } );
            drawerOpen = true;
            break;
    }
};

var setLevel = function() {
    // 'Go To Region' has been selected on the Hierarchical Location Selector
    var id;
    //id = $('#l5_select').val();
    //if (id) {
    //    v_select_region(5, id);
    //    return;
    //}
    //id = $('#l4_select').val();
    //if (id) {
    //    v_select_region(4, id);
    //    return;
    //}
    id = $('#l3_select').val();
    if (id) {
        v_select_region(3, id);
        return;
    }
    id = $('#l2_select').val();
    if (id) {
        v_select_region(2, id);
        return;
    }
    id = $('#l1_select').val();
    if (id) {
        v_select_region(1, id);
        return;
    }
    id = $('#l0_select').val();
    if (id) {
        v_select_region(0, id);
        return;
    }
}

var markersOn = function() {
    var image = S3.Ap.concat('/static/themes/Vulnerability/img/mapIconOnPng8.png');
    $('#mapSection').css('background', 'url(' + image + ') no-repeat center top transparent');
    image = S3.Ap.concat('/static/themes/Vulnerability/img/volunteerIconOnPng8.png');
    $('#volunteerSection').css('background', 'url(' + image + ') no-repeat center top transparent');
    $('.iconSection').css('color', '#565656');
}
var markersOff = function() {
    var image = S3.Ap.concat('/static/themes/Vulnerability/img/mapIconOffPng8.png');
    $('#mapSection').css('background', 'url(' + image + ') no-repeat center top transparent');
    image = S3.Ap.concat('/static/themes/Vulnerability/img/volunteerIconOffPng8.png');
    $('#volunteerSection').css('background', 'url(' + image + ') no-repeat center top transparent');
    $('.iconSection').css('color', '#ccc');
};

function capitalize(string) {
    var output = [];
    for (var i = 0; i < string.length; i++) {
        output.push(string[i].toUpperCase());
    }
    return output.join('');
};

// Reports
S3.dataTables = new Array();
S3.dataTables.id = ['report'];
resizeReports = function() {
    reportsHeight = window.innerHeight - 111;
    activeContentHeight = 0;
    $('.activeContent.contentTable .content').children('tr:visible').each(function() {
        activeContentHeight += $(this).innerHeight();
    });
    // activeContentHeight -= 8;

    if (reportsHeight < 507) {
        reportsHeight = 507;
    }
    if(activeContentHeight > reportsHeight - 180){
        activeContentHeight = reportsHeight - 180;
    }
    $('#lightbox').css('height', $('#vulnerability').innerHeight() + 'px');
    $('#reportsContent, #reportFilters').css('height', reportsHeight + 'px');
    $('.activeContent.contentTable').css('height', activeContentHeight + 'px').css('display', 'block');
}

var rep_section = 'pending';
var showReports = function(pSection) {
    $('#table-container').empty();
    // @ToDo: i18n
    displayThanks('Loading report details.', null);
    rep_section = pSection;
    $.ajax({
        type: 'GET',
        url: 'report/'
    }).done(function(data) {
        prepareReport(data);
    }).fail(function() {
        alert('error');
    });
}

var getFilteredReport = function() {
    // Collect all the data from the filter panel and store it in data
    // Pass data back to the server in a simple ajax call.
    var data = new Object();
    //if ($('#l4_reports').val()) {
    //    data['location_id'] = $('#l4_reports').val();
    //} else if ($('#l3_reports').val()) {
    if ($('#l3_reports').val()) {
        data['location_id'] = $('#l3_reports').val();
    } else if ($('#l2_reports').val()) {
        data['location_id'] = $('#l2_reports').val();
    } else if ($('#l1_reports').val()) {
        data['location_id'] = $('#l1_reports').val();
    } else if ($('#l0_reports').val()) {
        data['location_id'] = $('#l0_reports').val();
    } else {
        data['location_id'] = -1;
    }
    data['from_date'] = $('#dateFromReports').val();
    data['to_date'] = $('#dateToReports').val();
    if ($('#indicatorsCheckbox').is(':checked')) {
        data['indicator'] = true;
    }
    if ($('#mapCheckbox').is(':checked')) {
        data['map'] = true;
    }
    if ($('#imagesCheckbox').is(':checked')) {
        data['images'] = true;
    }
    if ($('#reportsCheckbox').is(':checked')) {
        data['reports'] = true;
    }
    if ($('#demographicsCheckbox').is(':checked')) {
        data['demographics'] = true;
    }
    return data;
}

var prepareReport = function(data) {
    //console.log(data);
    $('#dateFromReports').datepicker({
        dateFormat: 'yy-mm-dd',
        changeYear: true,
        changeMonth: true,
        maxDate: '+0d',
        minDate: '-20y'
     });
    $('#dateToReports').datepicker({
        dateFormat: 'yy-mm-dd',
        changeYear: true,
        changeMonth: true,
        maxDate: '+0d',
        minDate: '-20y'
     });

    var filter = data['filter'];
    var from_date = filter['from_date'];
    var to_date = filter['to_date'];
    $('.rowForApproval').hide();
    $('.rowForApproval').prev().find('.closeReviewButton').hide();
    $('.rowForApproval').prev().find('.reviewButton').show();
    $('.headerRow.activeSection td.arrowCell .arrow').html('&rarr;');
    $('.headerRow.activeSection').removeClass('activeSection');
    $('.' + rep_section + 'Header').addClass('activeSection');
    $('.headerRow.activeSection .arrow').html('&darr;');
    $('.activeContent').hide();
    $('.activeContent').removeClass('activeContent');
    $('.activeSection').next().addClass('activeContent');
    $('.activeSection').parent().next().addClass('activeContent');
    $('.activeContent').css('display', 'block');
    $('.approvalScreen').hide();
    $('#lightbox, #reportsSection').fadeIn(300);
    $('#table-container').empty();
    if (data) {
        $('#table-container').append(data.report);
        fnInitDataTable($('#report'), 0, true);
        formatTable(data);
        openReportRow('group_011');
    } else {
        // @ToDo: i18n
        $('#numberReports').html('No Entries Found');
    }
    resizeReports();
}
var displayReport = function(data) {
    $('#table-container').empty();
    if (data) {
        $('#table-container').append(data);
        fnInitDataTable($('#report'), 0, true);
        formatTable(data);
        openReportRow('group_011'); 
    } else {
        // @ToDo: i18n
        $('#numberReports').html('No Entries Found');
    }
    resizeReports();
}
function openReportRow(className) {
    if (shownReport != -1) {
        hideReportDetails(shownReport);
    }
    if ($('.' + className).html().indexOf('(0)') == -1) {
        accordionRow(0, 'level_1', className);
    } else if ($('.group_011').html().indexOf('(0)') == -1) {
        accordionRow(0, 'level_1', 'group_011');
    } else if ($('.group_012').html().indexOf('(0)') == -1) {
        accordionRow(0, 'level_1', 'group_012');
    } else {
        accordionRow(0, 'level_1', 'group_013');
    }
}
var formatTable = function() {
    $('#report').addClass('reportsTable');
    $('#report').addClass('headerTable');
    $('.group').each(function(){
        $(this).addClass('headerLabel');
    });
    var thead = $('#report th')
    $('#report tr').each(function() {
        if ($(this).hasClass('even')){
            $(this).addClass('gray');
        }
        var td = $(this).find('td:first');
        if (td.length == 0){
            td = $(this).find('th:first');
        }
        td.addClass('date');
        td = td.next();
        td.addClass('communeName');
        td = td.next();
        td.addClass('type');
        td = td.next();
        td.addClass('submittedBy');
        td = td.next();
        td.addClass('status');
        td = td.next();
        td.addClass('action');
    });
    $('#numberReports').html($('#reportCount').val());
    $('.expandable').click(function() {
        if (shownReport != -1) {
            hideReportDetails(shownReport);
        }
        thisAccordionRow(0, this);
    });
}

var shownReport = -1;
function showReportDetails(id) {
    $.getJSON(
        'report/review',
        {id: id}
    ).done(function(data) {
        displayReportDetails(id, data);
    }).fail(function() {
        alert('error');
    });
}
function viewReportDetails(id){
    $.getJSON(
        'report/view',
        {id: id}
    ).done(function(data){
        displayReportDetails(id, data);
    }).fail(function() {
        // @ToDo: Something meaningful
        alert('error');
    });
}
function hideReportDetails(id) {
    var parent = $('#' + id).parent().parent();
    $('#show' + id).remove();
    $(parent).find('.reviewButton').show();
    $(parent).find('.viewButton').show();
    $(parent).find('.closeReviewButton').hide();
}
function displayReportDetails(id, data) {
    var parent = $('#' + id).parent().parent();
    var nRow = document.createElement('tr');
    var nData = document.createElement('td');
    if (shownReport != -1) {
        hideReportDetails(shownReport);
    }
    shownReport = id;
    nData.colSpan = 6;
    nData.innerHTML = data;
    nRow.appendChild(nData);
    $(nRow).addClass('showReport');
    $(nRow).attr('id', 'show' + id);
    $(nRow).insertAfter( parent );
    $(parent).find('.reviewButton').hide();
    $(parent).find('.viewButton').hide();
    $(parent).find('.closeReviewButton').show();
    $('.approveButton, .declineButton').click(processReportDetails);
}

function displayThanks(msg, timeout) {
    $('.approvalScreen .thanks').html(msg);
    $('.approvalScreen').fadeIn(300);
    $('.approvalScreen .return2reports').hide();
    if (timeout) {
        $('.approvalScreen').data('approvalTimeout', setTimeout(function() {
            $('.approvalScreen').fadeOut(300);
        }, timeout));
        $('.approvalScreen .return2reports').show();
    }
    resizeReports();
}

function processReportDetails() {
    id = this.name.substr(7);
    $('#table-container').empty();
    hideReportDetails(id);
    var form = $('#form' + id);
    var report = form.serialize();
    var filter = getFilteredReport();
    filter['id'] = id;
    filter['report'] = report;
    var row = $('#' + id).parent().parent();
    if ($(this).hasClass('approveButton')) {
        // @ToDo: i18n
        displayThanks('Approval request submitted.', null);
        $.ajax({
            type: 'POST',
            url: 'report/approve',
            data: filter
        }).done(function(data) {
            $('.approvalScreen').hide();
            // @ToDo: i18n
            displayThanks('Thank you for your approval.', 5000);
            displayReport(data);
        }).fail(function() {
            // @ToDo: Something meaningful
            alert('error');
            $('.approvalScreen').hide();
        });
    } else {
        // @ToDo: i18n
        displayThanks('Reject request submitted.', null);
        $.ajax({
            type: 'POST',
            url: 'report/decline',
            data: filter
        }).done(function(data) {
            $('.approvalScreen').hide();
            // @ToDo: i18n
            displayThanks('Thank you, the submission<br />has been declined.', 5000);
            displayReport(data);
        }).fail(function() {
            // @ToDo: Something meaningful
            alert('error');
            $('.approvalScreen').hide();
        });
    }
}

var toggleReports = function(filter) {
    switch(filter){
        case 'myReports':
            // @ToDo: i18n
            $('.allReports').removeClass('active').html("<a href=\"javascript:toggleReports('allReports')\" title='All Reports'>ALL REPORTS</a>");
            // @ToDo: i18n
            $('.myReports').addClass('active').html('MY REPORTS');
            break;
        case 'allReports':
            // @ToDo: i18n
            $('.myReports').removeClass('active').html("<a href=\"javascript:toggleReports('myReports')\" title='My Reports'>MY REPORTS</a>")
            // @ToDo: i18n
            $('.allReports').addClass('active').html('ALL REPORTS');
            break;
    }
}
// Submit data
function selectSubmitDataType(){
    if(!$(this).hasClass("active")){
        $("#submissionToggle .active").removeClass("active");
        $(this).addClass("active");
        if($("#submitDataFilters").css("background-color")=="#f7941d"){
            $("#submitDataFilters").animate({ "background-color": "#c6c6c6" }, 500);
        }
        if($("#submitDataFooter .reviewSubmissionButton").is(":visible")){
            $("#submitDataFooter .reviewSubmissionButton, mark").fadeOut(300);
        }
        switch(this.id){
            case "submitIndicators":
                $("#indicatorsSubmissionViews").fadeIn(300);
                $("#dataAndReportsSubmissionViews").fadeOut(300);
                setTimeout(function(){
                    $("#newSubmissionRegions, #dataSubmissionRegion1 .submissionContent").empty();
                    $("#dataSubmissionRegion1").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");
                    $("#dataSubmissionRegion1 input").attr("disabled", false).attr("checked", false);
                    numberSubmissions = 2;
                    numberSubmissionsDeleted = 0;
                    $("#dataAndReportsSubmissionViews .dataUploadContainer").show(300);
                    $(".fileType").show(300);
                    $(".loadingErrorView").hide();
                    $(".dataSubmissionRegion input:radio").each(function(){
                            $(this).parent().removeAttr("style");
                    });
                },300);
                break;
            case "submitReports":
                
                $("#indicatorsSubmissionViews").fadeOut(300);
                $("#dataAndReportsSubmissionViews").fadeIn(300);
                setTimeout(function(){
                    $("#indicatorsSubmissionViews").children("div").hide();
                    $("#submitDataContent .indicatorsStart").show();
                },300);
                break;
        }
    }else{
        switch(this.id){
            case "submitIndicators":
                $("#indicatorsSubmissionViews").children("div").fadeOut(300);
                $("#submitDataContent .indicatorsStart").fadeIn(300);
                break;
            case "submitReports":
                break;
        }
    }
}
var sillyProgressBarLoadScript = function(selector){
    setTimeout(function(){
        $(selector).progressbar("value", $(selector).progressbar("value")+1.5);
    },25);
};

function uploadSubmitDataIndicators(){
    var formData = new FormData($('#uploadIndicatorsForm')[0]);
    $.ajax({
        url: 'submitData/import.aadata',
        type: 'POST',
        xhr: function() {  // custom xhr
            myXhr = $.ajaxSettings.xhr();
            if(myXhr.upload){ // check if upload property exists
                myXhr.upload.addEventListener('progress',progressHandlingFunction, false); // for handling the progress of the upload
            }
            return myXhr;
        },
        //Ajax events
//        beforeSend: beforeSendHandler,
//        success: completeHandler,
//        error: errorHandler,
        // Form data
        data: formData,
        //Options to tell JQuery not to process data or worry about content-type
        cache: false,
        contentType: false,
        processData: false
    });
    /*
    $(".loadingView").fadeIn(300);
    $(".indicatorsStart").fadeOut(300);
    $(".loadingView .progressBar").progressbar({
    	value: 0,
    	change: function(event, ui){
    	    sillyProgressBarLoadScript(".loadingView .progressBar");
    	},
    	complete: function(event, ui){
        	if($(".loadingView").is(":visible")){
        	    $(".loadingView").fadeOut(300);
        	    $("#indicatorsSubmissionViews .loadingErrorView").fadeIn(300);
        	}
    	}
    });
    sillyProgressBarLoadScript(".loadingView .progressBar");
    */
}
function progressHandlingFunction(e){
    if(e.lengthComputable){
        $('progress').attr({value:e.loaded,max:e.total});
    }
}

function reloadSubmitDataFromError(){
    $(".loadingView").fadeIn(300);
    $("#indicatorsSubmissionViews .loadingErrorView").fadeOut(300);
    $(".loadingView .progressBar").progressbar({
        value:0,
    	change: function(event, ui){
    	    sillyProgressBarLoadScript(".loadingView .progressBar");
    	},
        complete:function(event, ui){
        	if($(".loadingView").is(":visible")){
                $(".loadingView").fadeOut(300);
                $("#submitDataContent .reviewIndicatorsView h3").html("Review <span class='currentPage'>1</span> of <span class='totalPages'>3<span>");
                $(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){
                    var randomRating = Math.ceil(Math.random()*5);
                    $(this).find("input[value='" + randomRating + "']").attr("checked", true);
                });
                $(".reviewIndicatorsView.firstPage").fadeIn(300);
                $("#submitDataFilters").animate({ "background-color": "#f7941d" }, 500);
                $("#submitDataFilters h3").hide(300);
                $("#submissionToggle").hide(300);
                $("#submitDataFooter mark, #submitDataFooter .reviewNextButton").fadeIn(300);
            }
        }
    })
}

function nextSubmitDataReview(){
    if(!$(".backButton").is(":visible")){
        $(".backButton").fadeIn(300);
        $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Yen Hoa Commune.</mark>");
    }else{
        $(".reviewNextButton").hide();
        $(".submitAllButton").show();
        $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Phu Tam Commune</mark>");
    }
    $(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){
        var randomRating = Math.ceil(Math.random()*5);
        $(this).find("input[value='" + randomRating + "']").attr("checked", true);
    });
    $(".reviewIndicatorsView h3 .currentPage").text(parseInt($(".reviewIndicatorsView h3 .currentPage").text()) + 1);
}
function backSubmitDataReview(){
    if($("#submitDataFooter .reviewNextButton").is(":visible")){
        $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Hoa Tam Commune.</mark>");
        $(this).hide();
    }else if($("#submitDataContent .dataUploadContainer").is(":visible")){
        numberSubmissionsHidden = 0;
        $("#submitDataContent .dataUploadContainer h4").html("Select data type");
        $("#submitDataContent .dataUploadContainer h3").hide();
        $("#submitDataFilters").animate({ "background-color": "#c6c6c6" }, 500);
        $("#submitDataFilters h3").show(300);
        $("#submissionToggle").fadeIn(200);
        $("#submitDataFooter .backButton, #submitDataFooter .submitButton, .delete").fadeOut(300);
        setTimeout(function(){
            $("#submitDataFooter .reviewSubmissionButton, #submitDataFooter mark").fadeIn(300);
        },300);
        $(".dataSubmissionRegion input:radio").each(function(){
            if($(this).is(":checked")){
                $(this).parent().css("left", "");
            }else{
                $(this).parent().fadeIn(300);
            }
        });
        $(".dataSubmissionRegion").each(function(){
            if($(this).hasClass("mapSubmission") || $(this).hasClass("imageSubmission")){
                $(this).children(".reviewTitling").fadeOut(300);
                $(this).animate({"height": "181"},500).css("margin-top","12px");
                $(this).find(".submitDataThumb").animate({"margin": "49px 0 0 16px"},500);
            }else if($(this).hasClass("otherSubmission") || $(this).hasClass("vcaSubmission")){
                $(this).children(".reviewTitling").fadeOut(300);
                $(this).animate({"height": "138"},500).css("margin-top","12px");
            }else if($(this).hasClass("demographicsSubmission")){
                if($(this).children(".loadingErrorView").css("display") != "none"){
                    $(this).animate({"height": "178"},500).css("margin-top","12px");
                }else{
                    $(this).animate({"height": "358"},500).css("margin-top","12px");
                    console.log($(this).children(".loadingErrorView").css("display"));
                }
                $(this).find(".demoInput, .demographicsLinks").fadeIn(300);
                $(this).find(".demographicsTable").remove();
            }else if($(this).hasClass("removed")){
                //do nothing
            }else{
                $(this).animate({"height":"46px"},500).css("margin-top","12px");
                $(this).children("submissionContent").empty();
                $(this).find("input:radio").removeAttr("disabled").parent().removeAttr("style");
            }
            $(".fileType, .labelFile, .remove, .imgDesc, .labelHangRight, .checkHangRight").fadeIn(300);
        });
        setTimeout(function(){ renumberSubmissionRegions("restore"); }, 500);
    }else{
        $(".reviewIndicatorsView h4").html("Please review indicator ratings for <mark>Yen Hoa Commune</mark>");
        $("#submitDataFooter .submitAllButton").fadeOut();
        setTimeout(function(){
            $("#submitDataFooter .reviewNextButton").fadeIn();
        },300);
    }
    $(".reviewIndicatorsView h3 .currentPage").text(parseInt($(".reviewIndicatorsView h3 .currentPage").text()) - 1);
    $(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){
        var randomRating = Math.ceil(Math.random()*5);
        $(this).find("input[value='" + randomRating + "']").attr("checked", true);
    });
}
function submitSubmitData(){
    $(".reviewIndicatorsView").fadeOut(300);
    $("#indicatorsSubmissionViews .thankyou").fadeIn(300);
    $("#submitDataFooter div, #submitDataFooter mark").fadeOut(300)
    setTimeout(function(){
        $("#submitDataFooter .submitMoreButton").fadeIn(300);
    },300);
}
function moreSubmitData(){
    $(".thankyou, #submitDataFooter .submitMoreButton").fadeOut(300);
    $("#submitDataFilters").animate({ "background-color": "#c6c6c6" }, 500);
    $("#submitDataFilters h3").fadeIn(300);
    $("#submissionToggle").fadeIn(300);
    $("#submitDataContent .dataUploadContainer h4").html("Select data type");
    $("#submitDataContent .dataUploadContainer h3, .delete, .reviewTitling").hide();
    if($("#indicatorsSubmissionViews").is(":visible")){
        $("#submitDataContent .indicatorsStart").fadeIn(300);
        $("#submitDataContent .indicatorsStart p").filter(":first").show();
    }else{
        $("#newSubmissionRegions, #dataSubmissionRegion1 .submissionContent").empty();
        $("#dataSubmissionRegion1").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");
        $("#dataSubmissionRegion1 input").attr("disabled", false).attr("checked", false);
        numberSubmissions = 2;
        numberSubmissionsDeleted = 0;
        // $(".dataSubmissionRegion.generic").removeAttr("style")
        $("#dataAndReportsSubmissionViews .dataUploadContainer").fadeIn(300);
        $(".fileType, .labelFile, .remove, .imgDesc, .fakePlaceholder, .labelHangRight, .checkHangRight").fadeIn(300);
        $(".dataSubmissionRegion input:radio").each(function(){
                $(this).parent().removeAttr("style");
        });
    }
}



resizeSubmitData = function(){
    submitDataHeight = $(window).innerHeight()-186;
    if(submitDataHeight<432){
        submitDataHeight=432;
    }
    $("#submitDataContent").css("height", submitDataHeight + "px");
    $("#submitDataFilters").css("height", submitDataHeight + 75 + "px");
    $("#submitDataSection").css("height", submitDataHeight + 136 + "px");
}
resizeSubmitData();
var showSubmitData = function(toggle){
    $("#submitDataContent .dataUploadContainer h3, .delete, .reviewTitling, #submitDataContent .thankyou, .loadingErrorView").hide();
    $("#submitDataFooter div, #submitDataFooter mark").hide();
    $("#submitDataFilters #submissionToggle, #submitDataFilters h3").show();
    $("#dataAndReportsSubmissionViews .dataUploadContainer").show();
    $(".fileType, .labelFile, .remove, .imgDesc, .fakePlaceholder, .labelHangRight, .checkHangRight").show();
    $("#submitIndicators, #submitReports").removeClass("active");
    $("#submitDataFilters").css("background-color", "#c6c6c6");
    $("#dataSubmissionRegion1").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");
    $("#dataSubmissionRegion1").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");
    $("#dataSubmissionRegion1 input").attr("checked", false);
    $(".dataSubmissionRegion input:radio").each(function(){
            $(this).parent().removeAttr("style");
            $(this).removeAttr("disabled");
    });
    $("#newSubmissionRegions, #dataSubmissionRegion1 .submissionContent").empty();
    $("#newSubmissionRegions, #dataSubmissionRegion1 .submissionContent").empty();
    $("#submitDataContent .dataUploadContainer h4").html("Select data type");
    numberSubmissions = 2;
    numberSubmissionsDeleted = 0;
    switch(toggle){
        case "indicators":
            $("#submitIndicators").addClass("active");
            $("#indicatorsSubmissionViews").show();
            $("#dataAndReportsSubmissionViews").hide();
            $("#indicatorsSubmissionViews").children("div").hide();
            $("#submitDataFooter div, #submitDataFooter mark").removeAttr("style");
            $("#submitDataFooter .reviewSubmissionButton").removeClass('disabled');
            $("#submitDataContent .indicatorsStart").show();
            break;
        case "reports":
            $("#submitReports").addClass("active");
            $("#dataAndReportsSubmissionViews").show();
            $("#indicatorsSubmissionViews").hide();
            break;
    }
    $("#lightbox, #submitDataSection").fadeIn(300);
}
