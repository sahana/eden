/*
 2015-2018 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,q,g){b instanceof String&&(b=String(b));for(var a=b.length,c=0;c<a;c++){var d=b[c];if(q.call(g,d,c,b))return{i:c,v:d}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,q,g){b!=Array.prototype&&b!=Object.prototype&&(b[q]=g.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,q,g,a){if(q){g=$jscomp.global;b=b.split(".");for(a=0;a<b.length-1;a++){var c=b[a];c in g||(g[c]={});g=g[c]}b=b[b.length-1];a=g[b];q=q(a);q!=a&&null!=q&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:q})}};$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,g){return $jscomp.findInternal(this,b,g).v}},"es6","es3");
(function(b,q){var g=0;b.widget("s3.groupedItems",{options:{ajaxURL:null,renderGroupHeaders:!1,totalsLabel:"TOTAL"},_create:function(){b(this.element);this.id=g;g+=1;this.eventNamespace=".groupeditems"},_init:function(){var a=b(this.element);this.widget_id=a.attr("id");this.items=a.find(".gi-data").first();this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=b(this.element);a.find(".gi-throbber").show();this._unbindEvents();this.data||this._deserialize();
var c=this.data,d=a.find(".gi-table");c.e?(d.hide(),d.empty(),a.find(".gi-empty").show()):(a.find(".gi-empty").hide(),d.empty(),c=this._renderTable(c),d.append(c).show());this._bindEvents();a.find(".gi-throbber").css("visibility","hidden")},_renderTable:function(a){var c=b('<table class="groupeditems">');this._renderTableHeader(a).appendTo(c);this._renderGroup(c,a);this._renderTableFooter(a).appendTo(c);return c},_renderTableHeader:function(a){var c=b("<thead>"),d=b('<tr class="gi-column-headers">').appendTo(c),
e=a.c;a=a.l;for(var h,l=0,k=e.length;l<k;l++)h=a[e[l]],b("<th>").html(h).appendTo(d);return c},_renderTableFooter:function(a){var c=this.options,d=b("<tfoot>"),e=b('<tr class="gi-column-totals">'),h=a.t,l=!1;for(m in h){l=!0;break}if(l){a=a.c;for(var k=null,f=0,g=0,p=a.length;g<p;g++){if(!k){if(!h.hasOwnProperty(a[g])){f++;continue}1<f&&(k=b('<td class="gi-column-totals-label" colspan="'+f+'">'),b("<span> "+c.totalsLabel+"</span>").appendTo(k),k.appendTo(e))}var m=b("<td>").appendTo(e);(l=h[a[g]])&&
m.html(l)}e.appendTo(d)}return d},_renderGroup:function(a,c,b,e){"undefined"==typeof b&&(b=c);"undefined"==typeof e&&(e=0);this.options.renderGroupHeaders&&0<e&&this._renderGroupHeader(a,c,b,e);var d=b.d,l=b.i,k;if(d){var f=0;for(k=d.length;f<k;f++)this._renderGroup(a,c,d[f],e+1)}else if(l)for(f=0,k=l.length;f<k;f++)this._renderItem(a,c,l[f],e);0<e&&this._renderGroupFooter(a,c,b,e)},_renderGroupHeader:function(a,c,d,e){c=c.c;d=d.v;e=b('<tr class="gi-group-header gi-level-'+e+'">');b('<td colspan="'+
c.length+'">').html(d).appendTo(e);e.appendTo(a)},_renderGroupFooter:function(a,c,d,e){var h=this.options,l=d.t,k=!1;for(f in l){k=!0;break}c=c.c;d=d.v;e=b('<tr class="gi-group-footer gi-level-'+e+'">');if(!k&&!h.renderGroupHeaders)b('<td colspan="'+c.length+'">').html(d).appendTo(e),e.appendTo(a);else if(k){k=0;var f=null;for(var g,p,m=0,n=c.length;m<n;m++){if(!f){if(!l.hasOwnProperty(c[m])){k++;continue}1<k&&(f=b('<td class="gi-group-footer-label" colspan="'+k+'">'),h.renderGroupHeaders||f.html(d),
b('<span class="gi-group-footer-inline-label"> '+h.totalsLabel+"</span>").appendTo(f),f.appendTo(e))}p=b("<td>").appendTo(e);(g=l[c[m]])&&p.html(g)}e.appendTo(a)}},_renderItem:function(a,c,d,e){e=b('<tr class="gi-item gi-level-'+e+'">');c=c.c;for(var h,l,k=0,f=c.length;k<f;k++)l=b("<td>"),(h=d[c[k]])&&l.html(h),l.appendTo(e);e.appendTo(a)},reload:function(a,c,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof c&&(c=this._getFilters());var e=this,h=!1;b(this.element).find(".gi-throbber").css("visibility",
"visible");if(a||c)h=this._updateAjaxURL(a,c);h||d?b.ajax({url:this.options.ajaxURL,dataType:"json"}).done(function(a){e.items.val(JSON.stringify(a));e.data=null;e.refresh()}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)}):e.refresh()},_getFilters:function(){var a=b("#"+this.widget_id+"-filter-form");try{return a.length?S3.search.getCurrentFilters(a.first()):null}catch(c){return null}},_updateAjaxURL:function(a,c){var d=this.options.ajaxURL;if(!d)return!1;
var e=d.split("?");if(1<e.length){var h=e[1];var l=h.split("&")}else l=[];var k=[];d=!1;if(a)for(var f in a)h=a[f],h=f+"="+h,d||-1!=b.inArray(h,l)||(d=!0),k.push(h);f={};h={};var g;if(c){var p=0;for(g=c.length;p<g;p++){var m=c[p];var n=m[0];m=m[1];null===m?f[n]||(h[n]=!0):(h[n]&&(h[n]=!1),m=n+"="+encodeURIComponent(m),f[n]?f[n].push(m):f[n]=[m])}}p=0;for(g=l.length;p<g;p++)m=l[p].split("="),1<m.length&&(n=decodeURIComponent(m[0]),m=decodeURIComponent(m[1]),h[n]?d=!0:f[n]?d||-1!=b.inArray(n+"="+m,
f[n])||(d=!0):a&&a.hasOwnProperty(n)||k.push(l[p]));for(n in f)for(p=0,g=f[n].length;p<g;p++)d||-1!=b.inArray(f[n][p],l)||(d=!0),k.push(f[n][p]);a=k.join("&");c=e[0];a&&(c=c+"?"+a);this.options.ajaxURL=c;return d},_serialize:function(){var a=this.items;if(a){var b="";this.data&&(b=JSON.stringify(this.data));a.val(b)}return b},_deserialize:function(){this.data={};var a=this.items;a&&(a=a.val())&&(this.data=JSON.parse(a));return this.data},_bindEvents:function(){var a=this;b(this.element).delegate(".gi-export",
"click"+this.eventNamespace,function(){var c=b(this).data("url"),d=a._getFilters();d&&(c=S3.search.filterURL(c,d));window.open(c)})},_unbindEvents:function(){b(this.element).undelegate(this.eventNamespace)}})})(jQuery);
