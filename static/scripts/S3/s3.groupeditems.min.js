/*
 2015-2016 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp={scope:{},findInternal:function(a,p,f){a instanceof String&&(a=String(a));for(var c=a.length,b=0;b<c;b++){var e=a[b];if(p.call(f,e,b,a))return{i:b,v:e}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,p,f){if(f.get||f.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[p]=f.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,p,f,c){if(p){f=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var b=a[c];b in f||(f[b]={});f=f[b]}a=a[a.length-1];c=f[a];p=p(c);p!=c&&null!=p&&$jscomp.defineProperty(f,a,{configurable:!0,writable:!0,value:p})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,f){return $jscomp.findInternal(this,a,f).v}},"es6-impl","es3");
(function(a,p){var f=0;a.widget("s3.groupedItems",{options:{ajaxURL:null,renderGroupHeaders:!1,totalsLabel:"TOTAL"},_create:function(){a(this.element);this.id=f;f+=1;this.eventNamespace=".groupeditems"},_init:function(){var c=a(this.element);this.widget_id=c.attr("id");this.items=c.find(".gi-data").first();this.refresh()},_destroy:function(){a.Widget.prototype.destroy.call(this)},refresh:function(){var c=a(this.element);c.find(".gi-throbber").show();this._unbindEvents();this.data||this._deserialize();
var b=this.data,e=c.find(".gi-table");b.e?(e.hide(),e.empty(),c.find(".gi-empty").show()):(c.find(".gi-empty").hide(),e.empty(),b=this._renderTable(b),e.append(b).show());this._bindEvents();c.find(".gi-throbber").css("visibility","hidden")},_renderTable:function(c){var b=a('<table class="groupeditems">');this._renderTableHeader(c).appendTo(b);this._renderGroup(b,c);this._renderTableFooter(c).appendTo(b);return b},_renderTableHeader:function(c){var b=a("<thead>"),e=a('<tr class="gi-column-headers">').appendTo(b),
d=c.c;c=c.l;for(var q,k=0,h=d.length;k<h;k++)q=c[d[k]],a("<th>").html(q).appendTo(e);return b},_renderTableFooter:function(c){var b=this.options,e=a("<tfoot>"),d=a('<tr class="gi-column-totals">'),q=c.t,k=!1,h;for(h in q){k=!0;break}if(k){c=c.c;for(var g=null,m=0,n=0,f=c.length;n<f;n++){if(!g){if(!q.hasOwnProperty(c[n])){m++;continue}1<m&&(g=a('<td class="gi-column-totals-label" colspan="'+m+'">'),a("<span> "+b.totalsLabel+"</span>").appendTo(g),g.appendTo(d))}h=a("<td>").appendTo(d);(k=q[c[n]])&&
h.html(k)}d.appendTo(e)}return e},_renderGroup:function(c,b,a,d){"undefined"==typeof a&&(a=b);"undefined"==typeof d&&(d=0);this.options.renderGroupHeaders&&0<d&&this._renderGroupHeader(c,b,a,d);var e=a.d,k=a.i,h,g;if(e)for(h=0,g=e.length;h<g;h++)this._renderGroup(c,b,e[h],d+1);else if(k)for(h=0,g=k.length;h<g;h++)this._renderItem(c,b,k[h],d);0<d&&this._renderGroupFooter(c,b,a,d)},_renderGroupHeader:function(c,b,e,d){b=b.c;e=e.v;d=a('<tr class="gi-group-header gi-level-'+d+'">');a('<td colspan="'+
b.length+'">').html(e).appendTo(d);d.appendTo(c)},_renderGroupFooter:function(c,b,e,d){var q=this.options,k=e.t,h=!1,g;for(g in k){h=!0;break}b=b.c;e=e.v;d=a('<tr class="gi-group-footer gi-level-'+d+'">');if(!h&&!q.renderGroupHeaders)a('<td colspan="'+b.length+'">').html(e).appendTo(d),d.appendTo(c);else if(h){h=0;g=null;for(var m,n,f=0,l=b.length;f<l;f++){if(!g){if(!k.hasOwnProperty(b[f])){h++;continue}1<h&&(g=a('<td class="gi-group-footer-label" colspan="'+h+'">'),q.renderGroupHeaders||g.html(e),
a('<span class="gi-group-footer-inline-label"> '+q.totalsLabel+"</span>").appendTo(g),g.appendTo(d))}n=a("<td>").appendTo(d);(m=k[b[f]])&&n.html(m)}d.appendTo(c)}},_renderItem:function(c,b,e,d){d=a('<tr class="gi-item gi-level-'+d+'">');b=b.c;for(var f,k,h=0,g=b.length;h<g;h++)k=a("<td>"),(f=e[b[h]])&&k.html(f),k.appendTo(d);d.appendTo(c)},reload:function(c,b,e){e="undefined"!=typeof e?e:!0;"undefined"==typeof b&&(b=this._getFilters());var d=this,f=!1;a(this.element).find(".gi-throbber").css("visibility",
"visible");if(c||b)f=this._updateAjaxURL(c,b);f||e?a.ajax({url:this.options.ajaxURL,dataType:"json"}).done(function(a){d.items.val(JSON.stringify(a));d.data=null;d.refresh()}).fail(function(a,c,b){msg="UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText;console.log(msg)}):d.refresh()},_getFilters:function(){var c=a("#"+this.widget_id+"-filter-form");try{return c.length?S3.search.getCurrentFilters(c.first()):null}catch(b){return null}},_updateAjaxURL:function(c,b){var e=this.options.ajaxURL;if(!e)return!1;
var d,f=e.split("?"),k;1<f.length?(d=f[1],k=d.split("&")):k=[];var h=[],e=!1;if(c)for(var g in c)d=c[g],d=g+"="+d,e||-1!=a.inArray(d,k)||(e=!0),h.push(d);g={};d={};var m,n,p,l;if(b)for(n=0,p=b.length;n<p;n++)m=b[n],l=m[0],m=m[1],null===m?g[l]||(d[l]=!0):(d[l]&&(d[l]=!1),m=l+"="+encodeURIComponent(m),g[l]?g[l].push(m):g[l]=[m]);n=0;for(p=k.length;n<p;n++)m=k[n].split("="),1<m.length&&(l=decodeURIComponent(m[0]),m=decodeURIComponent(m[1]),d[l]?e=!0:g[l]?e||-1!=a.inArray(l+"="+m,g[l])||(e=!0):c&&c.hasOwnProperty(l)||
h.push(k[n]));for(l in g)for(n=0,p=g[l].length;n<p;n++)e||-1!=a.inArray(g[l][n],k)||(e=!0),h.push(g[l][n]);l=h.join("&");f=f[0];l&&(f=f+"?"+l);this.options.ajaxURL=f;return e},_serialize:function(){var a=this.items;if(a){var b="";this.data&&(b=JSON.stringify(this.data));a.val(b)}return b},_deserialize:function(){this.data={};var a=this.items;a&&(a=a.val())&&(this.data=JSON.parse(a));return this.data},_bindEvents:function(){var c=this;a(this.element).delegate(".gi-export","click"+this.eventNamespace,
function(){var b=a(this).data("url"),e=c._getFilters();e&&(b=S3.search.filterURL(b,e));window.open(b)})},_unbindEvents:function(){a(this.element).undelegate(this.eventNamespace)}})})(jQuery);
