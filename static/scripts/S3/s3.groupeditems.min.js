/*
 2015-2017 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,q,g){a instanceof String&&(a=String(a));for(var c=a.length,b=0;b<c;b++){var d=a[b];if(q.call(g,d,b,a))return{i:b,v:d}}return{i:-1,v:void 0}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,q,g){a!=Array.prototype&&a!=Object.prototype&&(a[q]=g.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};
$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,q,g,c){if(q){g=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var b=a[c];b in g||(g[b]={});g=g[b]}a=a[a.length-1];c=g[a];q=q(c);q!=c&&null!=q&&$jscomp.defineProperty(g,a,{configurable:!0,writable:!0,value:q})}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,g){return $jscomp.findInternal(this,a,g).v}},"es6-impl","es3");
(function(a,q){var g=0;a.widget("s3.groupedItems",{options:{ajaxURL:null,renderGroupHeaders:!1,totalsLabel:"TOTAL"},_create:function(){a(this.element);this.id=g;g+=1;this.eventNamespace=".groupeditems"},_init:function(){var c=a(this.element);this.widget_id=c.attr("id");this.items=c.find(".gi-data").first();this.refresh()},_destroy:function(){a.Widget.prototype.destroy.call(this)},refresh:function(){var c=a(this.element);c.find(".gi-throbber").show();this._unbindEvents();this.data||this._deserialize();
var b=this.data,d=c.find(".gi-table");b.e?(d.hide(),d.empty(),c.find(".gi-empty").show()):(c.find(".gi-empty").hide(),d.empty(),b=this._renderTable(b),d.append(b).show());this._bindEvents();c.find(".gi-throbber").css("visibility","hidden")},_renderTable:function(c){var b=a('<table class="groupeditems">');this._renderTableHeader(c).appendTo(b);this._renderGroup(b,c);this._renderTableFooter(c).appendTo(b);return b},_renderTableHeader:function(c){var b=a("<thead>"),d=a('<tr class="gi-column-headers">').appendTo(b),
e=c.c;c=c.l;for(var h,l=0,k=e.length;l<k;l++)h=c[e[l]],a("<th>").html(h).appendTo(d);return b},_renderTableFooter:function(c){var b=this.options,d=a("<tfoot>"),e=a('<tr class="gi-column-totals">'),h=c.t,l=!1;for(n in h){l=!0;break}if(l){c=c.c;for(var k=null,f=0,g=0,p=c.length;g<p;g++){if(!k){if(!h.hasOwnProperty(c[g])){f++;continue}1<f&&(k=a('<td class="gi-column-totals-label" colspan="'+f+'">'),a("<span> "+b.totalsLabel+"</span>").appendTo(k),k.appendTo(e))}var n=a("<td>").appendTo(e);(l=h[c[g]])&&
n.html(l)}e.appendTo(d)}return d},_renderGroup:function(c,b,a,e){"undefined"==typeof a&&(a=b);"undefined"==typeof e&&(e=0);this.options.renderGroupHeaders&&0<e&&this._renderGroupHeader(c,b,a,e);var d=a.d,l=a.i,k;if(d){var f=0;for(k=d.length;f<k;f++)this._renderGroup(c,b,d[f],e+1)}else if(l)for(f=0,k=l.length;f<k;f++)this._renderItem(c,b,l[f],e);0<e&&this._renderGroupFooter(c,b,a,e)},_renderGroupHeader:function(c,b,d,e){b=b.c;d=d.v;e=a('<tr class="gi-group-header gi-level-'+e+'">');a('<td colspan="'+
b.length+'">').html(d).appendTo(e);e.appendTo(c)},_renderGroupFooter:function(c,b,d,e){var h=this.options,l=d.t,k=!1;for(f in l){k=!0;break}b=b.c;d=d.v;e=a('<tr class="gi-group-footer gi-level-'+e+'">');if(!k&&!h.renderGroupHeaders)a('<td colspan="'+b.length+'">').html(d).appendTo(e),e.appendTo(c);else if(k){k=0;var f=null;for(var g,p,n=0,m=b.length;n<m;n++){if(!f){if(!l.hasOwnProperty(b[n])){k++;continue}1<k&&(f=a('<td class="gi-group-footer-label" colspan="'+k+'">'),h.renderGroupHeaders||f.html(d),
a('<span class="gi-group-footer-inline-label"> '+h.totalsLabel+"</span>").appendTo(f),f.appendTo(e))}p=a("<td>").appendTo(e);(g=l[b[n]])&&p.html(g)}e.appendTo(c)}},_renderItem:function(c,b,d,e){e=a('<tr class="gi-item gi-level-'+e+'">');b=b.c;for(var h,l,k=0,f=b.length;k<f;k++)l=a("<td>"),(h=d[b[k]])&&l.html(h),l.appendTo(e);e.appendTo(c)},reload:function(c,b,d){d="undefined"!=typeof d?d:!0;"undefined"==typeof b&&(b=this._getFilters());var e=this,h=!1;a(this.element).find(".gi-throbber").css("visibility",
"visible");if(c||b)h=this._updateAjaxURL(c,b);h||d?a.ajax({url:this.options.ajaxURL,dataType:"json"}).done(function(a){e.items.val(JSON.stringify(a));e.data=null;e.refresh()}).fail(function(a,c,b){msg="UNAUTHORIZED"==b?i18n.gis_requires_login:a.responseText;console.log(msg)}):e.refresh()},_getFilters:function(){var c=a("#"+this.widget_id+"-filter-form");try{return c.length?S3.search.getCurrentFilters(c.first()):null}catch(b){return null}},_updateAjaxURL:function(c,b){var d=this.options.ajaxURL;if(!d)return!1;
var e=d.split("?");if(1<e.length){var h=e[1];var l=h.split("&")}else l=[];var k=[],d=!1;if(c)for(var f in c)h=c[f],h=f+"="+h,d||-1!=a.inArray(h,l)||(d=!0),k.push(h);f={};h={};var g;if(b){var p=0;for(g=b.length;p<g;p++){var n=b[p];var m=n[0];n=n[1];null===n?f[m]||(h[m]=!0):(h[m]&&(h[m]=!1),n=m+"="+encodeURIComponent(n),f[m]?f[m].push(n):f[m]=[n])}}p=0;for(g=l.length;p<g;p++)n=l[p].split("="),1<n.length&&(m=decodeURIComponent(n[0]),n=decodeURIComponent(n[1]),h[m]?d=!0:f[m]?d||-1!=a.inArray(m+"="+n,
f[m])||(d=!0):c&&c.hasOwnProperty(m)||k.push(l[p]));for(m in f)for(p=0,g=f[m].length;p<g;p++)d||-1!=a.inArray(f[m][p],l)||(d=!0),k.push(f[m][p]);m=k.join("&");e=e[0];m&&(e=e+"?"+m);this.options.ajaxURL=e;return d},_serialize:function(){var a=this.items;if(a){var b="";this.data&&(b=JSON.stringify(this.data));a.val(b)}return b},_deserialize:function(){this.data={};var a=this.items;a&&(a=a.val())&&(this.data=JSON.parse(a));return this.data},_bindEvents:function(){var c=this;a(this.element).delegate(".gi-export",
"click"+this.eventNamespace,function(){var b=a(this).data("url"),d=c._getFilters();d&&(b=S3.search.filterURL(b,d));window.open(b)})},_unbindEvents:function(){a(this.element).undelegate(this.eventNamespace)}})})(jQuery);
