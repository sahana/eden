/*
 2015 (c) Sahana Software Foundation
 @license MIT
*/
(function(b,m){var g=0;b.widget("s3.embeddedComponent",{options:{ajaxURL:null,fieldname:null,component:null,recordID:null,autocomplete:!1},_create:function(){this.id=g;g+=1;this.namespace=".embeddedComponent";this.namespaceID=this.namespace+this.id},_init:function(){var a=this.options.fieldname;this.input=b(this.element);this.fieldname=a;this.selectBtn=b("#"+a+"-select");this.editBtn=b("#"+a+"-edit");this.clearBtn=b("#"+a+"-clear");this.loadThrobber=this.selectBtn.siblings(".throbber");this.selectRow=
b("#"+a+"-select-row");this.dummyInput=b("#dummy_"+a);this.autocompleteRow=b("#"+a+"-autocomplete-row");this.autocompleteLabel=b("#"+a+"-autocomplete-label");this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();this.dummyInput.hide();var a=this.options.recordID;"None"!=a&&(this.input.val(a),this.select(a));0<this.input.val()&&(this.clearBtn.removeClass("hide").show(),this.editBtn.removeClass("hide").show(),this._disableEmbedded());this._bindEvents()},
select:function(a){"undefined"==typeof a?a=this.input.val():this.input.val(a);this.selectBtn.hide();this.clearBtn.hide();this.loadThrobber.removeClass("hide").show();this._clear();var d=this.options.component,c=this;b.getJSONS3(this.options.ajaxURL+a+".s3json?show_ids=true",function(a){try{var h=a["$_"+d][0];c._disableEmbedded();c.input.val(h["@id"]);a=/^[$|@].*/;var g=/^[$]k_.*/,e,k;for(e in h){if(e.match(a))if(e.match(g))k="#"+d+"_"+e.slice(3);else continue;else k="#"+d+"_"+e;try{var f=h[e];if(f.hasOwnProperty("@id"))b(k).val(eval(f["@id"]));
else if(f.hasOwnProperty("@value")){var l;try{l=JSON.parse(f["@value"])}catch(m){l=f["@value"]}b(k).val(l)}else b(k).val(f)}catch(n){}}}catch(p){c.input.val("")}c.loadThrobber.hide();c.selectBtn.removeClass("hide").show();c.editBtn.removeClass("hide").show();c.clearBtn.removeClass("hide").show();(h=c.options.postprocess)&&eval(h)});c.autocompleteRow.hide();c.selectRow.removeClass("hide").show()},_clear:function(){var a=b(this.input);a.closest("form").find(".embedded-"+this.fieldname).each(function(){b(this).find("input, select, textarea").prop("disabled",
!1).val("")});a.val("");this.clearBtn.hide();this.editBtn.hide();(a=this.options.postprocess)&&eval(a)},_edit:function(){this._enableEmbedded();this.editBtn.hide()},_enableEmbedded:function(){b(this.element).closest("form").find(".embedded-"+this.fieldname).each(function(){b(this).find("input, select, textarea").prop("disabled",!1)})},_disableEmbedded:function(){b(this.element).closest("form").find(".embedded-"+this.fieldname).each(function(){b(this).find("input, select, textarea").prop("disabled",
!0)})},_onFormSubmission:function(){S3ClearNavigateAwayConfirm();this._enableEmbedded()},_bindEvents:function(){var a=this,d=this.namespace;this.input.closest("form").bind("submit"+this.namespaceID,function(){a._onFormSubmission();return!0});this.selectBtn.bind("click"+d,function(){a.selectRow.hide();a.autocompleteRow.removeClass("hide").show();a.autocompleteLabel.removeClass("hide").show();a.dummyInput.removeClass("hide").show().focus()});this.editBtn.bind("click"+d,function(){a._edit()});this.clearBtn.bind("click"+
d,function(){a._clear()});this.dummyInput.bind("focusout"+d,function(){a.input.val();b(this).hide();a.autocompleteLabel.hide();a.selectRow.removeClass("hide").show();0<a.input.val()&&a.clearBtn.removeClass("hide").show()});this.options.autocomplete||this.dummyInput.bind("change"+d,function(){var c=b(this).val();c&&a.input.val(c).change()});this.input.bind("change"+d,function(){var c=b(this).val();c&&a.select(c)});return!0},_unbindEvents:function(){var a=this.namespace;this.input.closest("form").unbind(this.namespaceID);
this.selectBtn.unbind(a);this.editBtn.unbind(a);this.clearBtn.unbind(a);this.dummyInput.unbind(a);return!0}})})(jQuery);
