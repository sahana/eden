/*
 2016 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp={scope:{},findInternal:function(a,k,f){a instanceof String&&(a=String(a));for(var b=a.length,c=0;c<b;c++){var d=a[c];if(k.call(f,d,c,a))return{i:c,v:d}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,k,f){if(f.get||f.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[k]=f.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,k,f,b){if(k){f=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var c=a[b];c in f||(f[c]={});f=f[c]}a=a[a.length-1];b=f[a];k=k(b);k!=b&&null!=k&&$jscomp.defineProperty(f,a,{configurable:!0,writable:!0,value:k})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,f){return $jscomp.findInternal(this,a,f).v}},"es6-impl","es3");
(function(a,k){var f=0;a.widget("dvr.eventRegistration",{options:{tablename:"case_event",ajax:null,ajaxURL:"",showPicture:!0,showPictureText:"Show Picture",hidePictureText:"Hide Picture"},_create:function(){this.id=f;f+=1;this.eventNamespace=".eventRegistration"},_init:function(){this.idPrefix="#"+this.options.tablename;var b=a(this.element);this.flagInfo=b.find("input[type=hidden][name=flags]");this.permissionInfo=b.find("input[type=hidden][name=permitted]");this.actionableInfo=b.find("input[type=hidden][name=actionable]");
this.eventType=b.find('input[type="hidden"][name="event"]');this.blockingInfo=b.find('input[type="hidden"][name="intervals"]');this.actionDetails=b.find('input[type="hidden"][name="actions"]');this.imageURL=b.find('input[type="hidden"][name="image"]');this.blockedEvents=(b=this.blockingInfo.val())?JSON.parse(b):{};this.blockingMessage=null;this.refresh()},_destroy:function(){a.Widget.prototype.destroy.call(this)},refresh:function(){var b=this.options,c=this.idPrefix;this._unbindEvents();b.ajaxURL&&
null===b.ajax&&(b.ajax=!0);this._showFlagInfo();this._showProfilePicture();a(this.element).find(c+"_details__row .controls").addClass("has-details");this.actionDetails.length?JSON.parse(this.actionDetails.val()).length?this._showDetails(!0):this._hideDetails():this._hideDetails();this._checkBlockedEvents()||this._toggleSubmit(!1);b=a(c+"_label");b.focus().val(b.val());this._bindEvents()},_checkID:function(){this._clearAlert();a(this.element);var b=this.idPrefix,c=a(b+"_label"),d=c.val().trim();c.val(d);
if(d){var c={l:d,c:!0},d=this.options.ajaxURL,e=a(b+"_person__row .controls").empty(),h=a('<div class="inline-throbber">').insertAfter(e),g=this;this._removeProfilePicture();this._clearDetails();a.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(c),success:function(c){h.remove();if(c.e)a('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+c.e+"</div></div>").hide().insertAfter(a(b+"_label")).slideDown();
else{e.html(c.p).removeClass("hide").show();var d=g.flagInfo;c.f?d.val(JSON.stringify(c.f)):d.val("[]");d=g.permissionInfo;c.s!==k?d.val(JSON.stringify(c.s)):d.val("false");var d=g.actionableInfo,f=c.u;d.length&&(f!==k?d.val(JSON.stringify(c.u)):(f=!0,d.val("true")));c.d&&g._updateDetails(c.d,f);c.b&&(g.imageURL.val(c.b),g._showProfilePicture());g.blockedEvents=c.i||{};g.blockingInfo.val(JSON.stringify(g.blockedEvents));g.eventType.val()&&g._toggleSubmit(!0);g._showFlagInfo()}c.a?S3.showAlert(c.a,
"error"):c.m&&S3.showAlert(c.m,"success")},error:function(){h.remove();g._clearForm(!0)}})}},_registerEvent:function(){this._clearAlert();var b=this.idPrefix,c=a(b+"_label").val(),d=this.eventType.val();if(c&&d){var c={l:c,t:d},d=this.options.ajaxURL,e=a(b+"_person__row .controls"),h=a('<div class="inline-throbber">').insertAfter(e),g=this,e=this.actionDetails;e.length&&(e=e.val(),c.d=e?JSON.parse(e):[]);c.c=a(b+"comments").val();a.ajaxS3({url:d,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",
data:JSON.stringify(c),success:function(c){h.remove();c.e?a('<div class="error_wrapper"><div id="label__error" class="error" style="display: block;">'+c.e+"</div></div>").hide().insertAfter(a(b+"_label")).slideDown():g._clearForm();c.a?S3.showAlert(c.a,"error",!1):c.m&&S3.showAlert(c.m,"success",!1)},error:function(){h.remove();this._clearForm(!0)}})}},_checkBlockedEvents:function(){var b=this.eventType.val(),b=this.blockedEvents[b];this.blockingMessage&&this.blockingMessage.remove();if(b){var c=
a("<h6>").addClass("event-registration-blocked").html(b[0]);if(new Date(b[1])>new Date)return this.blockingMessage=a("<div>").addClass("small-12-columns").append(c).prependTo(a("#submit_record__row")),!1}return!0},_showFlagInfo:function(){var b=this.flagInfo,c=a(this.idPrefix+"_flaginfo__row .controls").empty(),b=b.length?JSON.parse(b.val()):[],d=b.length;if(d){c.addClass("has-flaginfo");for(var c=a('<div class="checkpoint-advise">').hide().appendTo(c),e,h,g=0;g<d;g++)e=b[g],h=a('<div class="checkpoint-instructions">').appendTo(c),
a("<h4>"+e.n+"</h4>").appendTo(h),e.i&&a("<p>"+e.i+"</p>").appendTo(h);c.slideDown()}},_showProfilePicture:function(){var b=a(this.element),c=this.options,d=this.imageURL.val();this._removeProfilePicture();if(d){var e=a('<button class="tiny secondary button toggle-picture" type="button">'),h=a('<div class="button-row">').append(e);e.text(c.showPictureText);a('<div class="panel profile-picture">').append(h).data("url",d).appendTo(b);c.showPicture&&this._togglePicture()}},_removeProfilePicture:function(){this.imageURL.val("");
a(this.element).find(".panel.profile-picture").remove()},_togglePicture:function(){var b=a(this.element),c=this.options,b=b.find(".panel.profile-picture");if(b.length){var d=b.find(".image-row"),e=b.data("url"),h=b.find("button.toggle-picture");d.length?(d.remove(),h.text(c.showPictureText)):e&&(d=a("<img>").attr("src",e),d=a('<div class="image-row">').append(d),b.prepend(d),h.text(c.hidePictureText))}},_hideDetails:function(){var b=this.idPrefix;a(b+"_person__row .controls").text()?a(b+"_details__row").show():
a(b+"_details__row").hide();a(b+"_date__row").hide();a(b+"_comments__row").hide()},_showDetails:function(b){var c=this.idPrefix;a(c+"_details__row").show();b&&(a(c+"_date__row").show(),a(c+"_comments__row").show())},_updateDetails:function(b,c){var d=this.idPrefix;a(d+"_details__row .controls");a(d+"_date__row .controls");var e=this.actionDetails;e.length&&(""!==b.h?e.val(JSON.stringify(b.h)):e.val("[]"));a(d+"_details__row .controls").html(b.d);a(d+"_date__row .controls").html(b.t);this._showDetails(c)},
_clearDetails:function(){var b=this.idPrefix;this._hideDetails();this.flagInfo.val("[]");this.permissionInfo.val("false");a(b+"_flaginfo__row .controls").empty();a(b+"_details__row .controls").empty();a(b+"_date__row .controls").empty();a(b+"_comments").val("");this.blockedEvents={};this.blockingMessage&&this.blockingMessage.remove();this.blockingInfo.val(JSON.stringify(this.blockedEvents))},_toggleSubmit:function(b){var c=a(this.element),d=[".check-btn",".submit-btn"],e=this.permissionInfo,h=this.actionableInfo;
if(b){var g=b=!1;e.length&&(e=e.val())&&(b=JSON.parse(e));b&&(g=!0,h.length&&(h=h.val())&&(g=JSON.parse(h)));b&&g&&(g=this._checkBlockedEvents());b&&g&&d.reverse()}e=c.find(d[0]);c.find(d[1]).prop("disabled",!0).hide().insertAfter(e);e.prop("disabled",!1).hide().removeClass("hide").show()},_clearAlert:function(){a(".alert-error, .alert-warning, .alert-info, .alert-success").fadeOut("fast");a(".error_wrapper").fadeOut("fast").remove()},_clearForm:function(b,c){var d=this.idPrefix;a(".inline-throbber").remove();
b||this._clearAlert();c||a(d+"_label").val("");a(d+"_person__row .controls").hide().empty();this._removeProfilePicture();this._clearDetails();this._toggleSubmit(!1)},_bindEvents:function(){var b=a(this.element),c=this.idPrefix,d=this.eventNamespace,e=this,h=a(".zxing-button"),g=a("#event-type-toggle"),f=a("#event-type-selector");-1==navigator.userAgent.toLowerCase().indexOf("android")?h.addClass("disabled").click(function(a){a.preventDefault();a.stopPropagation();return!1}):h.bind("click"+d,function(){e._clearAlert()});
g.bind("click"+d,function(){e._clearAlert();f.hasClass("hide")?f.hide().removeClass("hide").slideDown():f.slideToggle()});f.find("a.event-type-selector").bind("click"+d,function(){var b=a(this),d=b.data("code"),b=b.data("name");a('input[type="hidden"][name="event"]').val(d);a(".event-type-name").text(b);a(c+"_person__row .controls").text()&&e._toggleSubmit(!0);h.each(function(){var b=a(this),c=b.data("tmp");c&&b.attr("href",c.replace("%7BEVENT%7D",d))});f.slideUp()});b.delegate(".toggle-picture",
"click"+d,function(a){a.preventDefault();e._togglePicture()});b.find("a.cancel-action").bind("click"+d,function(a){a.preventDefault();e._clearForm()});this.options.ajax&&(b.find(".check-btn").bind("click"+d,function(a){a.preventDefault();e._checkID()}),b.find(".submit-btn").unbind(d).bind("click"+d,function(a){a.preventDefault();e._registerEvent()}));b=a(c+"_label");b.bind("input"+d,function(a){e._clearForm(!1,!0)});b.bind("keyup"+d,function(a){switch(a.which){case 27:e._clearForm()}});return!0},
_unbindEvents:function(){var b=a(this.element),c=this.eventNamespace,d=this.idPrefix;a(".zxing-button").unbind(c).unbind("click");a("#event-type-toggle").unbind(c);a("#event-type-selector").find("a.event-type-selector").unbind(c);a(d+"_label").unbind(c);b.find("a.cancel-action").unbind(c);b.find(".check-btn").unbind(c);b.find(".submit-btn").unbind(c);b.undelegate(c);return!0}})})(jQuery);
