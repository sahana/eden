/*
 2015-2021 (c) Sahana Software Foundation
 @license MIT
*/
(function(d,q){var p=0;d.widget("s3.personcontacts",{options:{access:1,controller:"pr",personID:null,cancelButtonText:"Cancel",placeholderText:"Click to edit"},_create:function(){this.id=p;p+=1;this.eventNamespace=".personcontacts"},_init:function(){this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();this._bindEvents()},_addContact:function(a){var e=d(a);d(".iframe-container").remove();this._showAll();e.hide().siblings(".throbber").removeClass("hide").show();
var f=this.options,b=f.access,c=f.personID,l=f.controller;e=S3.Ap.concat("/pr/contact/create.iframe?person="+c);b&&(e+="&access="+b);d.get(e,function(h){var k=d('<div class="iframe-container">').hide().html(h);h=S3.Ap.concat("/pr/contact/create?person="+c+"&controller="+l);b&&(h+="&access="+b);var g=k.find("form").attr("action",h);h=d('<a class="cancel action-lnk">'+f.cancelButtonText+"</a>").on("click",function(){g.slideUp("mediun",function(){k.remove()});d(a).show()});g.find('input[type="submit"]').after(h);
k.find("#popup").show();g.show();k.insertAfter(a).slideDown("medium",function(){d(a).siblings(".throbber").hide()})})},_addEmergencyContact:function(a){var e=d(a);d(".iframe-container").remove();this._showAll();e.hide().siblings(".throbber").removeClass("hide").show();var f=this.options,b=f.access,c=f.personID,l=f.controller;e=S3.Ap.concat("/pr/contact_emergency/create.iframe?person_id="+c);b&&(e+="&access="+b);d.get(e,function(h){var k=d('<div class="iframe-container">').hide().html(h);h=S3.Ap.concat("/pr/contact_emergency/create?person="+
c+"&controller="+l);b&&(h+="&access="+b);var g=k.find("form").attr("action",h);h=d('<a class="cancel action-lnk">'+f.cancelButtonText+"</a>").on("click",function(){g.slideUp("mediun",function(){k.remove()});d(a).show()});g.find('input[type="submit"]').after(h);k.find("#popup").show();g.show();k.insertAfter(a).slideDown("medium",function(){d(a).siblings(".throbber").hide()})})},_editContact:function(a){var e=d(a),f=this.options,b=this;d(".iframe-container").remove();this._showAll();e.find(".pr-contact-actions").children().toggle();
var c=f.personID,l=f.controller,h=e.data("id"),k=f.access;a=S3.Ap.concat("/pr/contact/"+h+".iframe/update?person="+c);d.get(a,function(g){var m=d('<div class="iframe-container">').hide().html(g);g=S3.Ap.concat("/pr/contact/"+h+"/update?person="+c+"&controller="+l);k&&(g+="&access="+k);var n=m.find("form").attr("action",g);g=d('<a class="cancel action-lnk">'+f.cancelButtonText+"</a>").on("click",function(){n.slideUp("mediun",function(){m.remove()});b._showAll()});n.find('input[type="submit"]').after(g);
e.after(m).hide();m.find("#popup").show();n.show();m.slideDown("medium")})},_editEmergencyContact:function(a){var e=d(a),f=this.options,b=this;d(".iframe-container").remove();this._showAll();e.find(".pr-contact-actions").children().toggle();var c=f.personID,l=f.controller,h=e.data("id"),k=f.access;a=S3.Ap.concat("/pr/contact_emergency/"+h+".iframe/update?person="+c);d.get(a,function(g){var m=d('<div class="iframe-container">').hide().html(g);g=S3.Ap.concat("/pr/contact_emergency/"+h+"/update?person="+
c+"&controller="+l);k&&(g+="&access="+k);var n=m.find("form").attr("action",g);g=d('<a class="cancel action-lnk">'+f.cancelButtonText+"</a>").on("click",function(){n.slideUp("mediun",function(){m.remove()});b._showAll()});n.find('input[type="submit"]').after(g);e.after(m).hide();m.find("#popup").show();n.show();m.slideDown("medium")})},_deleteContact:function(a){if(confirm(i18n.delete_confirmation)){var e=a.data("id");d.post(S3.Ap.concat("/pr/contact/"+e+"/delete.json"));a.hide()}},_deleteEmergencyContact:function(a){if(confirm(i18n.delete_confirmation)){var e=
a.data("id");d.post(S3.Ap.concat("/pr/contact_emergency/"+e+"/delete.json"));a.remove()}},_inlineUpdateContact:function(a,e){a=d(a);var f=a.data("id");e.value||(e.value=a.data("value"));a=S3.Ap.concat("/pr/contact/"+f+".s3json");var b=!1;d.ajaxS3({type:"POST",url:a,data:JSON.stringify({$_pr_contact:e}),dataType:"JSON",async:!1,success:function(c){"success"==c.status&&(b=!0)}});return b},_inlineUpdateEmergencyContact:function(a,e){a=d(a).data("id");a=S3.Ap.concat("/pr/contact_emergency/"+a+".s3json");
var f=!1;d.ajaxS3({type:"POST",url:a,data:JSON.stringify({$_pr_contact_emergency:e}),dataType:"JSON",async:!1,success:function(b){"success"==b.status&&(f=!0)}});return f},_showAll:function(){var a=d(this.element);a.find(".pr-contact, .pr-emergency-contact").each(function(){var e=d(this);e.find(".pr-contact-actions a").show();e.find(".throbber, .inline-throbber").hide();e.show()});a.find(".contact-add-btn").show()},_bindEvents:function(){var a=this,e=d(this.element),f=this.eventNamespace;e.find(".pr-contacts .contact-add-btn").on("click"+
f,function(){a._addContact(this);return!1});e.find(".pr-emergency-contacts .contact-add-btn").on("click"+f,function(){a._addEmergencyContact(this);return!1});e.on("click"+f,".pr-contacts .edit-btn",function(){a._editContact(d(this).closest(".pr-contact"));return!1}).on("click"+f,".pr-emergency-contacts .edit-btn",function(){a._editEmergencyContact(d(this).closest(".pr-emergency-contact"));return!1}).on("click"+f,".pr-contacts .delete-btn-ajax",function(){a._deleteContact(d(this).closest(".pr-contact"));
return!1}).on("click"+f,".pr-emergency-contacts .delete-btn-ajax",function(){a._deleteEmergencyContact(d(this).closest(".pr-emergency-contact"));return!1});f={style:"display: inline",cssclass:"pr-contacts-editable",indicator:'<div class="throbber">',placeholder:this.options.placeholderText};e.find(".pr-contact-value").editable(function(b){var c=d(this).closest(".pr-contact");return a._inlineUpdateContact(c,{value:b})?(c.data("value",b),b):c.data("value")},f);e.find(".pr-contact-description").editable(function(b){var c=
d(this).closest(".pr-contact");return a._inlineUpdateContact(c,{contact_description:b})?(c.data("description",b),b):c.data("description")},f);e.find(".pr-contact-comments").editable(function(b){var c=d(this).closest(".pr-contact");return a._inlineUpdateContact(c,{comments:b})?(c.data("comments",b),b):c.data("comments")},f);e.find(".pr-emergency-name").editable(function(b){var c=d(this).closest(".pr-emergency-contact");return a._inlineUpdateEmergencyContact(c,{name:b})?(c.data("name",b),b):c.data("name")},
f);e.find(".pr-emergency-relationship").editable(function(b){var c=d(this).closest(".pr-emergency-contact");return a._inlineUpdateEmergencyContact(c,{relationship:b})?(c.data("relationship",b),b):c.data("relationship")},f);e.find(".pr-emergency-phone").editable(function(b){var c=d(this).closest(".pr-emergency-contact");return a._inlineUpdateEmergencyContact(c,{phone:b})?(c.data("phone",b),b):c.data("phone")},f);e.find(".pr-emergency-address").editable(function(b){var c=d(this).closest(".pr-emergency-contact");
return a._inlineUpdateEmergencyContact(c,{address:b})?(c.data("address",b),b):c.data("address")},f);e.find(".pr-emergency-comments").editable(function(b){var c=d(this).closest(".pr-emergency-contact");return a._inlineUpdateEmergencyContact(c,{comments:b})?(c.data("comments",b),b):c.data("comments")},f);e.find(".pr-contact-priority").editable(function(b){var c=d(this).closest(".pr-contact");return a._inlineUpdateContact(c,{priority:b})?(c.data("priority",b),b):c.data("priority")},{style:"display: inline-block;",
cssclass:"pr-contacts-editable",data:function(b){for(var c="{",l=1;10>l;l++)c+='"'+l+'":"'+l+'",';return c+('"selected":"'+b+'"}')},type:"select",submit:"ok"});return!0},_unbindEvents:function(){var a=d(this.element),e=this.eventNamespace;a.off(e);a.find(".pr-contact-add, .pr-emergency-add, .pr-contact-form").of(e);return!0}})})(jQuery);
