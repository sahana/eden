/*
 2015 (c) Sahana Software Foundation
 @license MIT
*/
(function(c,p){var k=0;c.widget("s3.personcontacts",{options:{access:1,controller:"pr",personID:null,cancelButtonText:"Cancel"},_create:function(){this.id=k;k+=1;this.namespace=".personcontacts"},_init:function(){this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();this._bindEvents()},_addContact:function(a){c(a).hide().siblings(".throbber").removeClass("hide").show();c(".iframe-container").remove();this._showAll();var b=this.options,e=
b.access,h=b.personID,f=b.controller,d=S3.Ap.concat("/pr/contact/create.iframe?person="+h);e&&(d+="&access="+e);c.get(d,function(d){var l=c('<div class="iframe-container">').hide().html(d);d=S3.Ap.concat("/pr/contact/create?person="+h+"&controller="+f);e&&(d+="&access="+e);var g=l.find("form").attr("action",d);d=c('<a class="cancel action-lnk">'+b.cancelButtonText+"</a>").bind("click",function(){g.slideUp("mediun",function(){l.remove()});c(a).show()});g.find('input[type="submit"]').after(d);g.show();
l.insertAfter(a).slideDown("medium",function(){c(a).siblings(".throbber").hide()})})},_addEmergencyContact:function(a){c(a).hide().siblings(".throbber").removeClass("hide").show();c(".iframe-container").remove();this._showAll();var b=this.options,e=b.access,h=b.personID,f=b.controller,d=S3.Ap.concat("/pr/contact_emergency/create.iframe?person_id="+h);e&&(d+="&access="+e);c.get(d,function(d){var l=c('<div class="iframe-container">').hide().html(d);d=S3.Ap.concat("/pr/contact_emergency/create?person="+
h+"&controller="+f);e&&(d+="&access="+e);var g=l.find("form").attr("action",d);d=c('<a class="cancel action-lnk">'+b.cancelButtonText+"</a>").bind("click",function(){g.slideUp("mediun",function(){l.remove()});c(a).show()});g.find('input[type="submit"]').after(d);g.show();l.insertAfter(a).slideDown("medium",function(){c(a).siblings(".throbber").hide()})})},_editContact:function(a){var b=c(a),e=this.options,h=this;c(".iframe-container").remove();this._showAll();b.find(".pr-contact-actions").children().toggle();
var f=e.personID,d=e.controller,n=b.data("id"),l=e.access;a=S3.Ap.concat("/pr/contact/"+n+".iframe/update?person="+f);c.get(a,function(a){var m=c('<div class="iframe-container">').hide().html(a);a=S3.Ap.concat("/pr/contact/"+n+"/update?person="+f+"&controller="+d);l&&(a+="&access="+l);var k=m.find("form").attr("action",a);a=c('<a class="cancel action-lnk">'+e.cancelButtonText+"</a>").bind("click",function(){k.slideUp("mediun",function(){m.remove()});h._showAll()});k.find('input[type="submit"]').after(a);
b.after(m).hide();k.show();m.slideDown("medium")})},_editEmergencyContact:function(a){var b=c(a),e=this.options,h=this;c(".iframe-container").remove();this._showAll();b.find(".pr-contact-actions").children().toggle();var f=e.personID,d=e.controller,k=b.data("id");access=e.access;a=S3.Ap.concat("/pr/contact_emergency/"+k+".iframe/update?person="+f);c.get(a,function(a){var g=c('<div class="iframe-container">').hide().html(a);a=S3.Ap.concat("/pr/contact_emergency/"+k+"/update?person="+f+"&controller="+
d);access&&(a+="&access="+access);var m=g.find("form").attr("action",a);a=c('<a class="cancel action-lnk">'+e.cancelButtonText+"</a>").bind("click",function(){m.slideUp("mediun",function(){g.remove()});h._showAll()});m.find('input[type="submit"]').after(a);b.after(g).hide();m.show();g.slideDown("medium")})},_deleteContact:function(a){if(confirm(i18n.delete_confirmation)){var b=a.data("id");c.post(S3.Ap.concat("/pr/contact/"+b+"/delete.json"));a.hide()}},_deleteEmergencyContact:function(a){if(confirm(i18n.delete_confirmation)){var b=
a.data("id");c.post(S3.Ap.concat("/pr/contact_emergency/"+b+"/delete.json"));a.remove()}},_inlineUpdateContact:function(a,b){var e=c(a),h=e.data("id");b.value||(b.value=e.data("value"));var e=S3.Ap.concat("/pr/contact/"+h+".s3json"),f=!1;c.ajaxS3({type:"POST",url:e,data:JSON.stringify({$_pr_contact:b}),dataType:"JSON",async:!1,success:function(a){"success"==a.status&&(f=!0)}});return f},_showAll:function(){c(this.element).find(".pr-contact, .pr-emergency-contact").each(function(){var a=c(this);a.find(".pr-contact-actions a").show();
a.find(".throbber, .inline-throbber").hide();a.show()})},_bindEvents:function(){var a=this,b=c(this.element),e=this.namespace;b.find(".pr-contacts .contact-add-btn").bind("click"+e,function(){a._addContact(this);return!1});b.find(".pr-emergency-contacts .contact-add-btn").bind("click"+e,function(){a._addEmergencyContact(this);return!1});b.delegate(".pr-contacts .edit-btn","click"+e,function(){a._editContact(c(this).closest(".pr-contact"));return!1}).delegate(".pr-emergency-contacts .edit-btn","click"+
e,function(){a._editEmergencyContact(c(this).closest(".pr-emergency-contact"));return!1}).delegate(".pr-contacts .delete-btn-ajax","click"+e,function(){a._deleteContact(c(this).closest(".pr-contact"));return!1}).delegate(".pr-emergency-contacts .delete-btn-ajax","click"+e,function(){a._deleteEmergencyContact(c(this).closest(".pr-emergency-contact"));return!1});e={style:"display: inline"};b.find(".pr-contact-value").editable(function(b,e){var d=c(this).closest(".pr-contact");return a._inlineUpdateContact(d,
{value:b})?(d.data("value",b),b):d.data("value")},e);b.find(".pr-contact-description").editable(function(b,e){var d=c(this).closest(".pr-contact");return a._inlineUpdateContact(d,{contact_description:b})?(d.data("description",b),b):d.data("description")},e);b.find(".pr-contact-comments").editable(function(b,e){var d=c(this).closest(".pr-contact");return a._inlineUpdateContact(d,{comments:b})?(d.data("comments",b),b):d.data("comments")},e);return!0},_unbindEvents:function(){var a=c(this.element),b=
this.namespace;a.undelegate(b);a.find(".pr-contact-add, .pr-emergency-add, .pr-contact-form").unbind(b);return!0}})})(jQuery);
