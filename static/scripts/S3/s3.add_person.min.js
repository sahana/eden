(function(){S3.addPersonWidget=function(b,d){var a="#"+b,e=$(a),c=$(a+"__row"),f=$(a+"_title__row"),g=e.next(".error_wrapper"),k=c.hasClass("control-group")||c.hasClass("form-row");if(k){var t=$(a+"_organisation_id__row"),h=$(a+"_full_name__row"),l=$(a+"_first_name__row"),n=$(a+"_middle_name__row"),p=$(a+"_last_name__row"),q=$(a+"_father_name__row"),r=$(a+"_grandfather_name__row"),u=$(a+"_date_of_birth__row"),v=$(a+"_year_of_birth__row"),w=$(a+"_gender__row"),x=$(a+"_occupation__row"),y=$(a+"_mobile_phone__row"),
z=$(a+"_home_phone__row"),A=$(a+"_email__row"),B=$(a+"_box_bottom");l.length?void 0==$(a+"_first_name").attr("data-c")?c.hide().after(B).after(A).after(z).after(y).after(x).after(w).after(u).after(v).after(r).after(q).after(l).after(n).after(p).after(t).after(g).after(f):c.hide().after(B).after(A).after(z).after(y).after(x).after(w).after(u).after(v).after(r).after(q).after(p).after(n).after(l).after(t).after(g).after(f):c.hide().after(B).after(A).after(z).after(y).after(x).after(w).after(u).after(v).after(r).after(q).after(p).after(n).after(l).after(h).after(t).after(g).after(f);
f.removeClass("hide").show();t.removeClass("hide").show();h.removeClass("hide").show();l.removeClass("hide").show();n.removeClass("hide").show();p.removeClass("hide").show();q.removeClass("hide").show();r.removeClass("hide").show();u.removeClass("hide").show();v.removeClass("hide").show();w.removeClass("hide").show();x.removeClass("hide").show();y.removeClass("hide").show();z.removeClass("hide").show();A.removeClass("hide").show();B.removeClass("hide").show()}else $(a+"__row1").hide(),c.hide().after(g).after(f);
e.val()?(E(b),$(a+"_edit_bar .icon-remove").hide()):(F(b),$(a+"_edit_bar .icon-edit").hide());e.data("lookup_contact",J);$(a+"_edit_bar").removeClass("hide").show();$(a+"_edit_bar .icon-edit").click(function(){var a="#"+b;F(b);$(a+"_full_name").prop("disabled",!1).val("");$(a+"_first_name").prop("disabled",!1).val("");$(a+"_middle_name").prop("disabled",!1).val("");$(a+"_last_name").prop("disabled",!1).val("");m(b);$(a+"_edit_bar .icon-edit").hide();$(a+"_edit_bar .icon-remove").removeClass("hide").show()});
$(a+"_edit_bar .icon-remove").click(function(){var a="#"+b,c=$(a).data("existing");c?($(a).val(c.value),$(a+"_organisation_id").prop("disabled",!0).val(c.organisation_id),$(a+"_full_name").prop("disabled",!0).val(c.full_name),$(a+"_first_name").prop("disabled",!0).val(c.first_name),$(a+"_middle_name").prop("disabled",!0).val(c.middle_name),$(a+"_last_name").prop("disabled",!0).val(c.last_name),$(a+"_gender").prop("disabled",!0).val(c.gender),$(a+"_date_of_birth").prop("disabled",!0).val(c.date_of_birth),
$(a+"_date_of_birth__row .ui-datepicker-trigger").show(),$(a+"_year_of_birth").prop("disabled",!0).val(c.year_of_birth),$(a+"_father_name").prop("disabled",!0).val(c.father_name),$(a+"_grandfather_name").prop("disabled",!0).val(c.grandfather_name),$(a+"_occupation").prop("disabled",!0).val(c.occupation),$(a+"_mobile_phone").prop("disabled",!0).val(c.mobile_phone),$(a+"_home_phone").prop("disabled",!0).val(c.home_phone),$(a+"_email").prop("disabled",!0).val(c.email),$(a+"_edit_bar .icon-edit").removeClass("hide").show(),
$(a+"_edit_bar .icon-remove").hide()):($(a+"_full_name").prop("disabled",!1).val(""),$(a+"_first_name").prop("disabled",!1).val(""),$(a+"_middle_name").prop("disabled",!1).val(""),$(a+"_last_name").prop("disabled",!1).val(""),m(b))});if(d){c='<div id="'+b+'_duplicates" class="req"></div>';k?$(a+"_box_bottom").before(c):$(a+"_box_bottom1").before(c);var C=$(a+"_duplicates");C.data("results",[]).click(function(){G(b)});$(a+"_full_name,"+a+"_first_name,"+a+"_middle_name,"+a+"_last_name,"+a+"_date_of_birth,"+
a+"_gender,"+a+"_father_name,"+a+"_grandfather_name,"+a+"_year_of_birth,"+a+"_occupation,"+a+"_mobile_phone,"+a+"_home_phone,"+a+"_email").change(function(){K(b)});e.change(function(){e.val()&&D(b)})}$(a+"_organisation_id").change(function(){var a=$(this).val(),b=e.data("url");a?(b=b.split("?")[0],b+="?~.organisation_id="+a):b=b.split("?")[0];e.data("url",b)});e.closest("form").submit(function(){if(d&&C.data("results").length)return C.data("submit",!0),G(b),!1;S3ClearNavigateAwayConfirm();if(!e.val()){var a=
"#"+b;$(a+"_organisation_id").prop("disabled",!1);$(a+"_full_name").prop("disabled",!1);$(a+"_first_name").prop("disabled",!1);$(a+"_middle_name").prop("disabled",!1);$(a+"_last_name").prop("disabled",!1);$(a+"_gender").prop("disabled",!1);$(a+"_date_of_birth").prop("disabled",!1);$(a+"_year_of_birth").prop("disabled",!1);$(a+"_father_name").prop("disabled",!1);$(a+"_grandfather_name").prop("disabled",!1);$(a+"_occupation").prop("disabled",!1);$(a+"_mobile_phone").prop("disabled",!1);$(a+"_home_phone").prop("disabled",
!1);$(a+"_email").prop("disabled",!1)}return!0})};S3.addPersonWidgetReady=function(b){var d=new jQuery.Deferred,a=$("#"+b);setTimeout(function c(){void 0!=a.data("lookup_contact")?d.resolve("loaded"):"pending"===d.state()&&(d.notify("waiting for Widget to setup..."),setTimeout(c,500))},1);return d.promise()};var E=function(b){b="#"+b;$(b+"_organisation_id").prop("disabled",!0);$(b+"_full_name").prop("disabled",!0);$(b+"_first_name").prop("disabled",!0);$(b+"_middle_name").prop("disabled",!0);$(b+
"_last_name").prop("disabled",!0);$(b+"_gender").prop("disabled",!0);$(b+"_date_of_birth").prop("disabled",!0);$(b+"_date_of_birth__row .ui-datepicker-trigger").hide();$(b+"_year_of_birth").prop("disabled",!0);$(b+"_father_name").prop("disabled",!0);$(b+"_grandfather_name").prop("disabled",!0);$(b+"_occupation").prop("disabled",!0);$(b+"_mobile_phone").prop("disabled",!0);$(b+"_home_phone").prop("disabled",!0);$(b+"_email").prop("disabled",!0);$(b+"_edit_bar .icon-edit").removeClass("hide").show();
$(b+"_edit_bar .icon-remove").hide()},m=function(b){b="#"+b;$(b).val("");$(b+"_organisation_id").prop("disabled",!1).val("");$(b+"_gender").prop("disabled",!1).val("");$(b+"_date_of_birth").prop("disabled",!1).val("");$(b+"_date_of_birth__row .ui-datepicker-trigger").show();$(b+"_year_of_birth").prop("disabled",!1).val("");$(b+"_father_name").prop("disabled",!1).val("");$(b+"_grandfather_name").prop("disabled",!1).val("");$(b+"_occupation").prop("disabled",!1).val("");$(b+"_mobile_phone").prop("disabled",
!1).val("");$(b+"_home_phone").prop("disabled",!1).val("");$(b+"_email").prop("disabled",!1).val("")},F=function(b){var d="#"+b,a=$(d+"_full_name");if(0==a.length){fullname=!1;var a=$(d+"_first_name"),e=a.attr("data-c");void 0==e?(firstname=!1,a=$(d+"_last_name"),e=a.attr("data-c")):firstname=!0}else fullname=!0,e=a.attr("data-c");if(!a.attr("autocomplete")){var c=$(d),f=c.val();if(f){var g={value:f,organisation_id:$(d+"_organisation_id").val(),gender:$(d+"_gender").val(),date_of_birth:$(d+"_date_of_birth").val(),
year_of_birth:$(d+"_year_of_birth").val(),father_name:$(d+"_father_name").val(),grandfather_name:$(d+"_grandfather_name").val(),occupation:$(d+"_occupation").val(),mobile_phone:$(d+"_mobile_phone").val(),home_phone:$(d+"_home_phone").val(),email:$(d+"_email").val()};fullname?g.full_name=a.val():(g.first_name=$(d+"_first_name").val(),g.middle_name=$(d+"_middle_name").val(),g.last_name=$(d+"_last_name").val())}else g={};c.data("existing",g);a.after('<div id="'+b+'_throbber" class="throbber input_throbber hide"></div>');
var k=$(d+"_throbber"),d=a.attr("data-f"),e=S3.Ap.concat("/"+e+"/"+d+"/search_ac");c.data("url",e);a.autocomplete({delay:$(this).data("delay")||800,minLength:$(this).data("chars")||2,source:function(a,b){$.ajax({url:c.data("url"),data:{term:a.term}}).done(function(a){0==a.length?c.val(""):a.push({id:0,value:"",label:i18n.none_of_the_above});b(a)})},search:function(a,b){k.removeClass("hide").show();return!0},response:function(a,b,c){k.hide();return c},focus:function(a,b){return!1},select:function(d,
e){var f=e.item;if(f.id){var g;void 0!=f.label?g=f.label:fullname&&(g=f.name);a.val(g);c.val(f.id).change();H(b,f.id)}else c.val("").change();return!1}}).data("ui-autocomplete")._renderItem=function(a,b){var c;if(void 0!=b.label)c=b.label;else{c=b.name;var d=b.org,e=b.job;if(d||e)e?(c+=" ("+e,d&&(c+=", "+d),c+=")"):c+=" ("+d+")"}return $("<li>").data("item.autocomplete",b).append("<a>"+c+"</a>").appendTo(a)};a.blur(function(){fullname?g.hasOwnProperty("full_name")&&g.full_name!=a.val()&&c.val("").change():
firstname?g.hasOwnProperty("first_name")&&g.first_name!=a.val()&&c.val("").change():g.hasOwnProperty("last_name")&&g.last_name!=a.val()&&c.val("").change()})}},H=function(b,d){var a="#"+b,e=$(a+"_full_name");if(0==e.length){fullname=!1;e=$(a+"_first_name");e.prop("disabled",!1);var c=e.attr("data-c");void 0==c?(e=$(a+"_last_name"),e.prop("disabled",!1),c=e.attr("data-c")):$(a+"_last_name").prop("disabled",!1).val("");$(a+"_middle_name").prop("disabled",!1)}else fullname=!0,c=e.attr("data-c"),e.prop("disabled",
!1);m(b);var f=$(a),a=e.attr("data-f"),c=S3.Ap.concat("/"+c+"/"+a+"/"+d+"/lookup");$.getJSONS3(c,function(a){try{f.val(d);var c={value:d};if(fullname){var g=e.val();c.full_name=g}f.data("existing",c);I(a,b)}catch(h){f.val(""),m(b)}})},J=function(b,d){var a="#"+b,e=$(a+"_full_name");0==e.length?(fullname=!1,e=$(a+"_first_name"),e.prop("disabled",!1).val(""),void 0==e.attr("data-c")?(e=$(a+"_last_name"),e.prop("disabled",!1).val("")):$(a+"_last_name").prop("disabled",!1).val(""),$(a+"_middle_name").prop("disabled",
!1).val("")):(fullname=!0,e.prop("disabled",!1).val(""));m(b);var c=$(a),f=S3.Ap.concat("/org/site/"+d+"/site_contact_person");$.getJSONS3(f,function(d){try{var f=d.id;c.val(f);var g={value:f};if(fullname){var h=d.name;e.val(h);g.full_name=h}else{var l=d.first_name;$(a+"_first_name").val(l);g.first_name=l;var n=d.last_name;$(a+"_last_name").val(n);g.last_name=n;var p=$(a+"_middle_name");if(p.length){var q=d.middle_name;p.val(q);g.middle_name=q}}c.data("existing",g);I(d,b,f)}catch(r){c.val(""),fullname?
e.prop("disabled",!1).val(""):($(a+"_first_name").prop("disabled",!1).val(""),$(a+"_middle_name").prop("disabled",!1).val(""),$(a+"_last_name").prop("disabled",!1).val("")),m(b)}})},I=function(b,d){var a="#"+d,e=$(a).data("existing");if(b.hasOwnProperty("email")){var c=b.email;$(a+"_email").val(c);e.email=c}b.hasOwnProperty("mphone")&&(c=b.mphone,$(a+"_mobile_phone").val(c),e.mobile_phone=c);b.hasOwnProperty("hphone")&&(c=b.hphone,$(a+"_home_phone").val(c),e.home_phone=c);b.hasOwnProperty("sex")&&
(c=b.sex,$(a+"_gender").val(c),e.gender=c);b.hasOwnProperty("dob")&&(c=b.dob,$(a+"_date_of_birth").val(c),e.date_of_birth=c);b.hasOwnProperty("year_of_birth")&&(c=b.year_of_birth,$(a+"_year_of_birth").val(c),e.year_of_birth=c);b.hasOwnProperty("father_name")&&(c=b.father_name,$(a+"_father_name").val(c),e.father_name=c);b.hasOwnProperty("grandfather_name")&&(c=b.grandfather_name,$(a+"_grandfather_name").val(c),e.grandfather_name=c);b.hasOwnProperty("occupation")&&(c=b.occupation,$(a+"_occupation").val(c),
e.occupation=c);b.hasOwnProperty("org_id")&&(c=b.org_id,$(a+"_organisation_id").val(c),e.organisation_id=c);b.hasOwnProperty("first_name")&&(c=b.first_name,$(a+"_first_name").val(c),e.first_name=c,c=b.last_name,$(a+"_last_name").val(c),e.last_name=c,b.hasOwnProperty("middle_name")&&(c=b.middle_name,$(a+"_middle_name").val(c),e.middle_name=c));E(d)},K=function(b){var d="#"+b;if(!$(d).val()){b=$(d+"_full_name");if(0==b.length){b=$(d+"_first_name").val();if(!b)return;b={first_name:b};var a=$(d+"_last_name").val();
a&&(b.last_name=a);$(d+"_middle_name").length&&(a=$(d+"_middle_name").val())&&(b.middle_name=a)}else{b=b.val();if(!b)return;b={name:b}}(a=$(d+"_date_of_birth").val())&&(b.dob=a);(a=$(d+"_gender").val())&&(b.sex=a);(a=$(d+"_father_name").val())&&(b.father_name=a);(a=$(d+"_grandfather_name").val())&&(b.grandfather_name=a);(a=$(d+"_occupation").val())&&(b.occupation=a);(a=$(d+"_mobile_phone").val())&&(b.mphone=a);(a=$(d+"_home_phone").val())&&(b.hphone=a);(a=$(d+"_email").val())&&(b.email=a);a=S3.Ap.concat("/pr/person/check_duplicates");
$.ajaxS3({url:a,data:b,type:"POST",dataType:"json",success:function(a){$(d+"_results").remove();if(a.length){var b=i18n.dupes_found.replace("_NUM_",a.length);$(d+"_duplicates").html(b+' <i class="icon-caret-down"> </i>').show().data("results",a)}else $(d+"_duplicates").data("results",[]).hide()}})}},G=function(b){var d="#"+b;if(!$(d+"_results").length){for(var a=$(d+"_duplicates"),e=a.data("results"),c,f,g,k='<div id="'+b+'_results">',m=e.length,h=0;h<m;h++)f=e[h],g=f.name,c='<div class="dl-item" data-id='+
f.id+' data-name="'+g+'">',c+='<a class="fleft"><img width=50 height=50 src="',f.image?S3.Ap.concat("/default/download/"+f.image):c+=S3.Ap.concat("/static/img/blank-user.gif"),c+='" class="media-object"></a><div>',f.org&&(c+='<div class="card_1_line">'+f.org+"</div>"),c+='<div class="card_1_line">'+g+"</div>",f.father_name&&i18n.father_name_label&&(c+='<div class="card_1_line"><label>'+i18n.father_name_label+"</label>"+f.father_name+"</div>"),f.grandfather_name&&i18n.grandfather_name_label&&(c+='<div class="card_1_line"><label>'+
i18n.grandfather_name_label+"</label>"+f.grandfather_name+"</div>"),f.year_of_birth&&(c+='<div class="card_1_line">'+f.year_of_birth+"</div>"),f.dob&&(c+='<div class="card_1_line">'+f.dob+"</div>"),f.email&&(c+='<div class="card_1_line">'+f.email+"</div>"),f.phone&&(c+='<div class="card_1_line">'+f.phone+"</div>"),c+='<button type="button" class="fright"><i class="icon icon-ok"> </i> '+i18n.Yes+"</button></div></div>",k+=c;k+='<div class="dl-item"><button type="button" class="fright"><i class="icon icon-remove"> </i> '+
i18n.No+"</button></div></div>";a.after(k);$("html,body").animate({scrollTop:a.offset().top},250);$(d+"_results .dl-item").click(function(){$this=$(this);if(g=$this.attr("data-name")){$(d+"_full_name").val(g);var c=$this.attr("data-id");D(b);a.data("submit")?($(d).val(c),a.closest("form").submit()):H(b,c)}else D(b),a.data("submit")&&a.closest("form").submit()})}},D=function(b){b="#"+b;$(b+"_duplicates").data("results",[]).empty();$(b+"_results").remove()}})();
