(function(){S3.addPersonWidget=function(b){var a="#"+b,e=$(a);if($(a+"__row").hasClass("control-group")){var f=e.next(".error_wrapper"),d=$(a+"_title__row"),g=$(a+"_organisation_id__row"),h=$(a+"_full_name__row"),p=$(a+"_date_of_birth__row"),k=$(a+"_gender__row"),c=$(a+"_occupation__row"),n=$(a+"_mobile_phone__row"),q=$(a+"_home_phone__row"),m=$(a+"_email__row"),r=$(a+"_box_bottom");$(a+"__row").hide().after(r).after(m).after(q).after(n).after(c).after(k).after(p).after(h).after(g).after(d).after(f);
d.removeClass("hide").show();g.removeClass("hide").show();h.removeClass("hide").show();p.removeClass("hide").show();k.removeClass("hide").show();c.removeClass("hide").show();n.removeClass("hide").show();q.removeClass("hide").show();m.removeClass("hide").show();r.removeClass("hide").show()}e.val()?(s(b),$(a+"_edit_bar .icon-remove").hide()):(t(b),$(a+"_edit_bar .icon-edit").hide());e.data("lookup_contact",u);$(a+"_edit_bar").removeClass("hide").show();$(a+"_edit_bar .icon-edit").click(function(){var a=
"#"+b;t(b);$(a+"_full_name").prop("disabled",!1).val("");l(b);$(a+"_edit_bar .icon-edit").hide();$(a+"_edit_bar .icon-remove").removeClass("hide").show()});$(a+"_edit_bar .icon-remove").click(function(){var a="#"+b,c=$(a).data("existing");c?($(a).val(c.value),$(a+"_organisation_id").prop("disabled",!0).val(c.organisation_id),$(a+"_full_name").prop("disabled",!0).val(c.full_name),$(a+"_gender").prop("disabled",!0).val(c.gender),$(a+"_date_of_birth").prop("disabled",!0).val(c.date_of_birth),$(a+"_occupation").prop("disabled",
!0).val(c.occupation),$(a+"_mobile_phone").prop("disabled",!0).val(c.mobile_phone),$(a+"_home_phone").prop("disabled",!0).val(c.home_phone),$(a+"_email").prop("disabled",!0).val(c.email),$(a+"_edit_bar .icon-edit").removeClass("hide").show(),$(a+"_edit_bar .icon-remove").hide()):($(a+"_full_name").prop("disabled",!1).val(""),l(b))});$(a+"_organisation_id").change(function(){var a=$(this).val(),b=e.data("url");a?(b=b.split("?")[0],b+="?~.organisation_id="+a):b=b.split("?")[0];e.data("url",b)});$("form").submit(function(){S3ClearNavigateAwayConfirm();
var a="#"+b;$(a+"_organisation_id").prop("disabled",!1);$(a+"_full_name").prop("disabled",!1);$(a+"_gender").prop("disabled",!1);$(a+"_date_of_birth").prop("disabled",!1);$(a+"_occupation").prop("disabled",!1);$(a+"_mobile_phone").prop("disabled",!1);$(a+"_home_phone").prop("disabled",!1);$(a+"_email").prop("disabled",!1);return!0})};S3.addPersonWidgetReady=function(b){var a=new jQuery.Deferred,e=$("#"+b);setTimeout(function d(){void 0!=e.data("lookup_contact")?a.resolve("loaded"):"pending"===a.state()&&
(a.notify("waiting for Widget to setup..."),setTimeout(d,500))},1);return a.promise()};var s=function(b){b="#"+b;$(b+"_organisation_id").prop("disabled",!0);$(b+"_full_name").prop("disabled",!0);$(b+"_gender").prop("disabled",!0);$(b+"_date_of_birth").prop("disabled",!0);$(b+"_occupation").prop("disabled",!0);$(b+"_mobile_phone").prop("disabled",!0);$(b+"_home_phone").prop("disabled",!0);$(b+"_email").prop("disabled",!0);$(b+"_edit_bar .icon-edit").removeClass("hide").show();$(b+"_edit_bar .icon-remove").hide()},
l=function(b){b="#"+b;$(b).val("");$(b+"_organisation_id").prop("disabled",!1).val("");$(b+"_gender").prop("disabled",!1).val("");$(b+"_date_of_birth").prop("disabled",!1).val("");$(b+"_occupation").prop("disabled",!1).val("");$(b+"_mobile_phone").prop("disabled",!1).val("");$(b+"_home_phone").prop("disabled",!1).val("");$(b+"_email").prop("disabled",!1).val("")},t=function(b){var a="#"+b,e=$(a+"_full_name");if(!e.attr("autocomplete")){var f=$(a),d=f.val(),g=d?{value:d,full_name:e.val(),organisation_id:$(a+
"_organisation_id").val(),gender:$(a+"_gender").val(),date_of_birth:$(a+"_date_of_birth").val(),occupation:$(a+"_occupation").val(),mobile_phone:$(a+"_mobile_phone").val(),home_phone:$(a+"_home_phone").val(),email:$(a+"_email").val()}:{};f.data("existing",g);$(a+"_full_name").after('<div id="'+b+'_throbber" class="throbber input_throbber hide"></div>');var h=$(a+"_throbber"),a=e.attr("data-c"),d=e.attr("data-f"),a=S3.Ap.concat("/"+a+"/"+d+"/search_ac");f.data("url",a);e.autocomplete({delay:450,minLength:2,
source:function(a,b){$.ajax({url:f.data("url"),data:{term:a.term}}).done(function(a){0==a.length?f.val(""):a.push({id:0,value:"",label:i18n.none_of_the_above});b(a)})},search:function(a,b){h.removeClass("hide").show();return!0},response:function(a,b,c){h.hide();return c},focus:function(a,b){return!1},select:function(a,d){var c=d.item;if(c.id){var h;void 0!=c.label?h=c.label:(h=c.first,c.middle&&(h+=" "+c.middle),c.last&&(h+=" "+c.last));e.val(h);f.val(c.id).change();v(b,c.id)}else f.val("").change();
return!1}}).data("ui-autocomplete")._renderItem=function(a,b){var c;if(void 0!=b.label)c=b.label;else{c=b.first;b.middle&&(c+=" "+b.middle);b.last&&(c+=" "+b.last);var d=b.org,e=b.job;if(d||e)e?(c+=" ("+e,d&&(c+=", "+d),c+=")"):c+=" ("+d+")"}return $("<li>").data("item.autocomplete",b).append("<a>"+c+"</a>").appendTo(a)};e.blur(function(){g&&g.full_name!=e.val()&&f.val("").change()})}},v=function(b,a){var e="#"+b,f=$(e+"_full_name");f.prop("disabled",!1);l(b);var d=$(e),e=f.attr("data-c"),g=f.attr("data-f"),
e=S3.Ap.concat("/"+e+"/"+g+"/"+a+"/lookup");$.getJSONS3(e,function(e){try{d.val(a);var g=f.val();d.data("existing",{value:a,full_name:g});m(e,b)}catch(k){d.val(""),l(b)}})},u=function(b,a){var e="#"+b,f=$(e+"_full_name");f.prop("disabled",!1).val("");l(b);var d=$(e),g=S3.Ap.concat("/org/site/"+a+"/site_contact_person");$.getJSONS3(g,function(a){try{var g=[];a.hasOwnProperty("first_name")&&g.push(a.first_name);a.hasOwnProperty("middle_name")&&g.push(a.middle_name);a.hasOwnProperty("last_name")&&g.push(a.last_name);
var k=g.join(" ");f.val(k);var c=a.id;d.val(c);d.data("existing",{value:c,full_name:k});m(a,b,c)}catch(n){d.val(""),$(e+"_full_name").prop("disabled",!1).val(""),l(b)}})},m=function(b,a){var e="#"+a,f=$(e).data("existing");if(b.hasOwnProperty("email")){var d=b.email;$(e+"_email").val(d);f.email=d}b.hasOwnProperty("mobile_phone")&&(d=b.mobile_phone,$(e+"_mobile_phone").val(d),f.mobile_phone=d);b.hasOwnProperty("home_phone")&&(d=b.home_phone,$(e+"_home_phone").val(d),f.home_phone=d);b.hasOwnProperty("gender")&&
(d=b.gender,$(e+"_gender").val(d),f.gender=d);b.hasOwnProperty("date_of_birth")&&(d=b.date_of_birth,$(e+"_date_of_birth").val(d),f.date_of_birth=d);b.hasOwnProperty("occupation")&&(d=b.occupation,$(e+"_occupation").val(d),f.occupation=d);b.hasOwnProperty("organisation_id")&&(d=b.organisation_id,$(e+"_organisation_id").val(d),f.organisation_id=d);s(a)}})();
