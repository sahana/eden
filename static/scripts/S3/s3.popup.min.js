function s3_popup_refresh_caller(d){var p,l;var c=getQueryParams(document.location.search);var e=c.refresh;if("undefined"!=typeof e){var g=self.parent.$("#"+e);if(g.hasClass("dl")){var b=c.record;void 0!==b?g.datalist("ajaxReloadItem",b):g.datalist("ajaxReload")}else try{g.dataTable().fnReloadAjax()}catch(F){}var h=self.parent.S3.gis.maps;if("undefined"!=typeof h)for(a in h){var q=h[a];b=e.replace(/-/g,"_");var u=q.layers;d=0;for(c=u.length;d<c;d++){var f=u[d];if(f.s3_layer_id==b){var v=f.strategies;
f=0;for(l=v.length;f<l;f++){var m=v[f];if("OpenLayers.Strategy.Refresh"==m.CLASS_NAME){m.refresh();break}}break}}}var a=self.parent.$("#"+e+"-filter-form");a.length&&self.parent.S3.search.ajaxUpdateOptions(a);self.parent.S3.popup_remove()}else if(b=c.refresh_layer,"undefined"!=typeof b){if(h=self.parent.S3.gis.maps,"undefined"!=typeof h)for(a in"undefined"!=b&&(b=parseInt(b)),e=self.parent.i18n.gis_draft_layer,h)for(q=h[a],u=q.layers,d=0,c=u.length;d<c;d++)if(f=u[d],f.s3_layer_id==b)for(v=f.strategies,
f=0,l=v.length;f<l;f++){if(m=v[f],"OpenLayers.Strategy.Refresh"==m.CLASS_NAME){m.refresh();break}}else if(f.name==e){for(;q.popups.length;)q.removePopup(q.popups[0]);m=f.features;for(f=m.length-1;0<=f;f--)m[f].destroy()}}else if(a=c.node)b=self.parent.$("#"+c.hierarchy),a=self.parent.$("#"+a),b&&a&&b.hierarchicalcrud("refreshNode",a),self.parent.S3.popup_remove();else if(a=c.agent,"undefined"!=typeof a)b="undefined"!=typeof d?[d]:[],self.parent.$("#"+a).trigger("configSaved",b);else if("undefined"!=
typeof c.level)self.parent.S3.popup_remove();else{var k=c.caller;if(void 0===k)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),self.parent.S3.popup_remove();else if(s3_debug("Caller: ",k),a=c.person_id,"undefined"!=typeof a)self.parent.$("#"+k).val(a).change(),self.parent.S3.popup_remove();else{b=new RegExp(".*\\"+S3.Ap+"\\/");a=c.child;if("undefined"===typeof a){e=(new String(self.location)).replace(b,"");e=e.split("?")[0].split("/");var r=e[1].split(".")[0]+"_id"}else r=
a;s3_debug("child_resource",r);var w=c.parent;d=new String(self.parent.location);a=c.prefix;e=d.replace(b,"");"undefined"===typeof w?(b=k.replace("_"+r,""),s3_debug("parent_field",b),c=b.replace(/_.*/,""),c=b.replace(c+"_",""),e=e.split("?")[0].split("/"),b=null,a||(a=e[0]),d=e[1],2<e.length&&(null!==e[2].match(/\d*/)?3<e.length&&(b=e[3]):b=e[2]),null!==b&&c!=d&&c==b&&(c=d+"/"+b)):(c=w,a||(e=d.replace(b,""),e=e.split("?")[0].split("/"),a=e[0]));s3_debug("parent_resource",c);s3_debug("lookup_prefix",
a);a=S3.Ap.concat("/"+a+"/"+c+"/options.s3json?field="+r);g=self.parent.$("#"+k);s3_debug("selector",g);var C="sub_"==k.substring(0,4),y=self.parent.$("#dummy_"+k),z=void 0!=y.val();s3_debug("has_dummy",z);var x=g.hasClass("checkboxes-widget-s3"),A=g.hasClass("s3-hierarchy-input");if(x){var D=self.parent.$("#"+k+" tbody tr:first").children().length;var n=[]}else{var E=self.parent.$("#"+k+" >option");(p="select"==g.prop("tagName").toLowerCase())?n=[]:a=A?a+"&hierarchy=1&only_last=1":a+"&only_last=1"}var t=
1,B="";$.getJSONS3(a,function(a){var c,b,e,d=0;$.each(a.option,function(){c=this["@value"];b=this.$;"undefined"===typeof b&&(b="");p?n.push(["<option value='",c,"'>",b,"</option>"].join("")):x?(e="id_"+r+"-"+d,n.push(["<td><input id='",e,"' name='",r,"' value='",c,"' type='checkbox'><label for='",e,"'>",b,"</label></td>"].join("")),d++):A&&(w=this["@parent"],g.parent().hierarchicalopts("addNode",w,c,b,!0));numeric_value=+c;numeric_value>t&&(t=numeric_value,B=b)});z&&(y.val(B),g.val(t).change());if(p){if(C){var f=
["_0","_none","_default"],l=k.split("_").slice(0,-1).join("_");for(a=0;a<f.length;a++){var m=f[a];self.parent.$("#"+l+m).empty().append(n.join(""))}}else E.remove(),g.append(n.join("")).val(t).change();g.val(t).change();g.prop("disabled",!1);if(g.hasClass("multiselect-widget")&&g.multiselect("instance"))try{g.multiselect("refresh")}catch(G){}}else if(x){var h=[];self.parent.$("#"+k+" input").each(function(a){$(this).prop("checked")&&h.push($(this).val())});f=[];for(a=d=0;a<n.length;a++)0===d?(f.push("<tr>"),
f.push(n[a]),d++):d==D-1?(f.push(n[a]),f.push("</tr>"),d=0):(f.push(n[a]),d++);g.html(f.join(""));h.push(t);for(a=0;a<h.length;a++)self.parent.$("#"+k+' input[value="'+h[a]+'"]').prop("checked",!0)}self.parent.S3.popup_remove()})}}}function getQueryParams(d){d=d.substring(1);var p={};if(d){d=d.split("&");for(var l,c=0,e=d.length;c<e;c++)l=d[c].split("="),p[decodeURIComponent(l[0])]=decodeURIComponent(l[1])}return p};
