function s3_popup_refresh_main_form(){var a=getQueryParams(document.location.search),d=a.refresh;if("undefined"!=typeof d){var g=self.parent.$("#"+d);if(g.hasClass("dl")){var c=a.record;void 0!==c?g.datalist("ajaxReloadItem",c):g.datalist("ajaxReload")}else try{g.dataTable().reloadAjax()}catch(E){}a=self.parent.S3.gis.maps;if("undefined"!=typeof a){var b,f,p,m,s,e,h,t,l;for(b in a)for(f=a[b],c=d.replace(/-/g,"_"),p=f.layers,m=0,s=p.length;m<s;m++)if(e=p[m],e.s3_layer_id==c){h=e.strategies;e=0;for(t=
h.length;e<t;e++)if(l=h[e],"OpenLayers.Strategy.Refresh"==l.CLASS_NAME){l.refresh();break}break}}b=self.parent.$("#"+d+"-filter-form");b.length&&self.parent.S3.search.ajaxUpdateOptions(b);self.parent.S3.popup_remove()}else if(c=a.refresh_layer,"undefined"!=typeof c){if(a=self.parent.S3.gis.maps,"undefined"!=typeof a)for(b in"undefined"!=c&&(c=parseInt(c)),d=self.parent.i18n.gis_draft_layer,a)for(f=a[b],p=f.layers,m=0,s=p.length;m<s;m++)if(e=p[m],e.s3_layer_id==c)for(h=e.strategies,e=0,t=h.length;e<
t;e++){if(l=h[e],"OpenLayers.Strategy.Refresh"==l.CLASS_NAME){l.refresh();break}}else if(e.name==d){for(;f.popups.length;)f.removePopup(f.popups[0]);h=e.features;for(e=h.length-1;0<=e;e--)h[e].destroy()}}else if(b=a.node)c=self.parent.$("#"+a.hierarchy),b=self.parent.$("#"+b),c&&b&&c.hierarchicalcrud("refreshNode",b),self.parent.S3.popup_remove();else if("undefined"!=typeof a.level)self.parent.S3.popup_remove();else{var k=a.caller;if(void 0===k)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),
self.parent.S3.popup_remove();else if(s3_debug("Caller: ",k),b=a.person_id,"undefined"!=typeof b)self.parent.$("#"+k).val(b).change(),self.parent.S3.popup_remove();else{c=new RegExp(".*\\"+S3.Ap+"\\/");b=a.child;var q;"undefined"===typeof b?(d=(new String(self.location)).replace(c,""),d=d.split("?")[0].split("/"),q=d[1].split(".")[0]+"_id"):q=b;s3_debug("child_resource",q);var u=a.parent;f=new String(self.parent.location);b=a.prefix;d=f.replace(c,"");"undefined"===typeof u?(c=k.replace("_"+q,""),
s3_debug("parent_field",c),a=c.replace(/_.*/,""),a=c.replace(a+"_",""),d=d.split("?")[0].split("/"),c=null,b||(b=d[0]),f=d[1],2<d.length&&(null!==d[2].match(/\d*/)?3<d.length&&(c=d[3]):c=d[2]),null!==c&&a!=f&&a==c&&(a=f+"/"+c)):(a=u,b||(d=f.replace(c,""),d=d.split("?")[0].split("/"),b=d[0]));s3_debug("parent_resource",a);s3_debug("lookup_prefix",b);b=S3.Ap.concat("/"+b+"/"+a+"/options.s3json?field="+q);g=self.parent.$("#"+k);s3_debug("selector",g);var B="sub_"==k.substring(0,4),x=self.parent.$("#dummy_"+
k),y=void 0!=x.val();s3_debug("has_dummy",y);var v=g.hasClass("checkboxes-widget-s3"),z=g.hasClass("s3-hierarchy-input"),n;if(v){var C=self.parent.$("#"+k+" tbody tr:first").children().length;n=[]}else{var D=self.parent.$("#"+k+" >option"),w="select"==g.prop("tagName").toLowerCase();w?n=[]:b=z?b+"&hierarchy=1&only_last=1":b+"&only_last=1"}var r=1,A="";$.getJSONS3(b,function(a){var c,b,d,e=0;$.each(a.option,function(){c=this["@value"];b=this.$;"undefined"===typeof b&&(b="");w?n.push(["<option value='",
c,"'>",b,"</option>"].join("")):v?(d="id_"+q+"-"+e,n.push(["<td><input id='",d,"' name='",q,"' value='",c,"' type='checkbox'><label for='",d,"'>",b,"</label></td>"].join("")),e++):z&&(u=this["@parent"],g.parent().hierarchicalopts("addNode",u,c,b,!0));numeric_value=+c;numeric_value>r&&(r=numeric_value,A=b)});y&&(x.val(A),g.val(r).change());if(w){if(B){var f=["_0","_none","_default"],h,m=k.split("_").slice(0,-1).join("_");for(a=0;a<f.length;a++)h=f[a],self.parent.$("#"+m+h).empty().append(n.join(""))}else D.remove(),
g.append(n.join("")).val(r).change();g.val(r).change();g.prop("disabled",!1);if(g.hasClass("multiselect-widget")&&g.multiselect("instance"))try{g.multiselect("refresh")}catch(p){}}else if(v){var l=[];self.parent.$("#"+k+" input").each(function(a){$(this).prop("checked")&&l.push($(this).val())});f=[];for(a=e=0;a<n.length;a++)0===e?(f.push("<tr>"),f.push(n[a]),e++):e==C-1?(f.push(n[a]),f.push("</tr>"),e=0):(f.push(n[a]),e++);g.html(f.join(""));l.push(r);for(a=0;a<l.length;a++)self.parent.$("#"+k+' input[value="'+
l[a]+'"]').prop("checked",!0)}self.parent.S3.popup_remove()})}}}function getQueryParams(a){var d={};if(a=a.substring(1)){a=a.split("&");for(var g=[],c=0;c<a.length;c++)g=a[c].split("="),d[decodeURIComponent(g[0])]=decodeURIComponent(g[1])}return d};
