function s3_tb_call_cleanup(b){self.parent.s3_tb_cleanup&&self.parent.s3_tb_cleanup(b);self.parent.s3_tb_remove()}
function s3_tb_refresh(){var b=getQueryParams(document.location.search),c=b.level;if("undefined"!==typeof c)s3_tb_call_cleanup(c);else{var d=b.caller;s3_debug("caller",d);c=b.person_id;if("undefined"!==typeof c)"undefined"!==typeof d&&self.parent.$("#"+d).val(c).change(),s3_tb_call_cleanup(c);else{var c=RegExp(".*\\"+S3.Ap+"\\/"),a=b.child;if("undefined"===typeof a)var a=new String(self.location),a=a.replace(c,""),a=a.split("?")[0].split("/"),i=a[1]+"_id";else i=a;s3_debug("child_resource",i);b=b.parent;
if("undefined"===typeof b){b=d.replace("_"+i,"");s3_debug("parent_field",b);var a=b.replace(/_.*/,""),b=b.replace(a+"_",""),a=new String(self.parent.location),a=a.replace(c,""),a=a.split("?")[0].split("/"),c=null,h=a[0],o=a[1];2<a.length&&(null!=a[2].match(/\d*/)?3<a.length&&(c=a[3]):c=a[2]);null!=c&&b!=o&&b==c&&(b=o+"/"+c)}else a=new String(self.parent.location),a=a.replace(c,""),a=a.split("?")[0].split("/"),h=a[0];s3_debug("parent_resource",b);s3_debug("caller_prefix",h);var a=S3.Ap.concat("/"+
h+"/"+b+"/options.s3json?field="+i),j=self.parent.$("#"+d);s3_debug("selector",j);var p=self.parent.$("#dummy_"+d),q=void 0!=p.val();s3_debug("has_dummy",q);var m=j.hasClass("checkboxes-widget-s3");if(m)var t=self.parent.$("#"+d+" tbody tr:first").children().length,f=[];else{var r=self.parent.$("#"+d+" >option"),n=r.length;n?f=[]:a+="&only_last=1"}var k=1,s="";$.getJSONS3(a,function(a){var b,c,h,g=0;$.each(a.option,function(){b=this["@value"];c=this.$;"undefined"===typeof c&&(c="");n?f.push(["<option value='",
b,"'>",c,"</option>"].join("")):m&&(h="id_"+i+"-"+g,f.push(["<td><input id='",h,"' name='",i,"' value='",b,"' type='checkbox'><label for='",h,"'>",c,"</label></td>"].join("")),g++);numeric_value=+b;numeric_value>k&&(k=numeric_value,s=c)});q&&(p.val(s),j.val(k).change());if(n)r.remove(),j.append(f.join("")).change(),j.val(k).change();else if(m){var l=[];self.parent.$("#"+d+" input").each(function(){$(this).prop("checked")&&l.push($(this).val())});for(var a=[],e=g=0;e<f.length;e++)0==g?(a.push("<tr>"),
a.push(f[e]),g++):g==t-1?(a.push(f[e]),a.push("</tr>"),g=0):(a.push(f[e]),g++);j.html(a.join(""));l.push(k);for(e=0;e<l.length;e++)self.parent.$("#"+d+' input[value="'+l[e]+'"]').prop("checked",!0)}s3_tb_call_cleanup(d)})}}}function getQueryParams(b){for(var b=b.split("?")[1],b=b.split("&"),c={},d=[],a=0;a<b.length;a++)d=b[a].split("="),c[decodeURIComponent(d[0])]=decodeURIComponent(d[1]);return c};
