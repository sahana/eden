function s3_popup_refresh_main_form(){var a=getQueryParams(document.location.search),l=a.refresh;if("undefined"!=typeof l){var g=self.parent.$("#"+l);if(g.hasClass("dl")){var b=a.record;void 0!==b?g.datalist("ajaxReloadItem",b):g.datalist("ajaxReload")}else try{g.dataTable().fnReloadAjax()}catch(B){}a=self.parent.S3.gis.maps;if("undefined"!=typeof a){var d,h,m,e,f,k,r;for(d in a)for(h=a[d],b=l.replace(/-/g,"_"),m=h.layers,e=0,f=m.length;e<f;e++)if(k=m[e],k.s3_layer_id==b){f=k.strategies;e=0;for(k=
f.length;e<k;e++)if(r=f[e],"OpenLayers.Strategy.Refresh"==r.CLASS_NAME){r.refresh();break}break}}d=self.parent.$("#"+l+"-filter-form");d.length&&self.parent.S3.search.ajaxUpdateOptions(d);self.parent.S3.popup_remove()}else if(b=a.refresh_layer,"undefined"!=typeof b){if(a=self.parent.S3.gis.maps,"undefined"!=typeof a){var b=parseInt(b),c;for(d in a){h=a[d];m=h.layers;e=0;for(f=m.length;e<f;e++)if(k=m[e],k.s3_layer_id==b){c=!0;f=k.strategies;e=0;for(k=f.length;e<k;e++)if(r=f[e],"OpenLayers.Strategy.Refresh"==
r.CLASS_NAME){r.refresh();break}break}if(c)if(-1!=document.location.pathname.indexOf("/create"))for(l=self.parent.i18n.gis_draft_layer,e=0,f=m.length;e<f;e++){if(k=m[e],k.name==l){l=k.features;for(e=l.length-1;0<=e;e--)m=l[e],f=m.popup,h.removePopup(f),f.destroy(),delete m.popup,m.destroy();break}}else for(;h.popups.length;)h.removePopup(h.popups[0])}}}else if("undefined"!=typeof a.level)self.parent.S3.popup_remove();else{var n=a.caller;if(void 0===n)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),
self.parent.S3.popup_remove();else if(s3_debug("Caller: ",n),d=a.person_id,"undefined"!=typeof d)self.parent.$("#"+n).val(d).change(),self.parent.S3.popup_remove();else{d=RegExp(".*\\"+S3.Ap+"\\/");var b=a.child,q;"undefined"===typeof b?(c=(new String(self.location)).replace(d,""),c=c.split("?")[0].split("/"),q=c[1]+"_id"):q=b;s3_debug("child_resource",q);b=a.parent;"undefined"===typeof b?(b=n.replace("_"+q,""),s3_debug("parent_field",b),c=b.replace(/_.*/,""),b=b.replace(c+"_",""),c=new String(self.parent.location),
c=c.replace(d,""),c=c.split("?")[0].split("/"),a=null,d=c[0],h=c[1],2<c.length&&(null!==c[2].match(/\d*/)?3<c.length&&(a=c[3]):a=c[2]),null!==a&&(b!=h&&b==a)&&(b=h+"/"+a)):(c=new String(self.parent.location),c=c.replace(d,""),c=c.split("?")[0].split("/"),d=c[0]);s3_debug("parent_resource",b);s3_debug("caller_prefix",d);d=S3.Ap.concat("/"+d+"/"+b+"/options.s3json?field="+q);g=self.parent.$("#"+n);s3_debug("selector",g);var y="sub_"==n.substring(0,4),v=self.parent.$("#dummy_"+n),w=void 0!=v.val();s3_debug("has_dummy",
w);var t=g.hasClass("checkboxes-widget-s3"),p;if(t){var z=self.parent.$("#"+n+" tbody tr:first").children().length;p=[]}else{var A=self.parent.$("#"+n+" >option"),u="select"==g.prop("tagName").toLowerCase();u?p=[]:d+="&only_last=1"}var s=1,x="";$.getJSONS3(d,function(a){var b,c,e,d=0;$.each(a.option,function(){b=this["@value"];c=this.$;"undefined"===typeof c&&(c="");u?p.push(["<option value='",b,"'>",c,"</option>"].join("")):t&&(e="id_"+q+"-"+d,p.push(["<td><input id='",e,"' name='",q,"' value='",
b,"' type='checkbox'><label for='",e,"'>",c,"</label></td>"].join("")),d++);numeric_value=+b;numeric_value>s&&(s=numeric_value,x=c)});w&&(v.val(x),g.val(s).change());if(u){if(y){var f=["_0","_none","_default"],k,l=n.split("_").slice(0,-1).join("_");for(a=0;a<f.length;a++)k=f[a],self.parent.$("#"+l+k).empty().append(p.join(""))}else A.remove(),g.append(p.join("")).val(s).change();g.val(s).change();if(g.hasClass("multiselect-widget"))try{g.multiselect("refresh")}catch(m){}}else if(t){var h=[];self.parent.$("#"+
n+" input").each(function(a){$(this).prop("checked")&&h.push($(this).val())});f=[];for(a=d=0;a<p.length;a++)0===d?(f.push("<tr>"),f.push(p[a]),d++):d==z-1?(f.push(p[a]),f.push("</tr>"),d=0):(f.push(p[a]),d++);g.html(f.join(""));h.push(s);for(a=0;a<h.length;a++)self.parent.$("#"+n+' input[value="'+h[a]+'"]').prop("checked",!0)}self.parent.S3.popup_remove()})}}}
function getQueryParams(a){var l={};if(a=a.substring(1)){a=a.split("&");for(var g=[],b=0;b<a.length;b++)g=a[b].split("="),l[decodeURIComponent(g[0])]=decodeURIComponent(g[1])}return l};
