function s3_popup_refresh_caller(d){var c=getQueryParams(document.location.search),e=c.refresh;if("undefined"!=typeof e){var g=self.parent.$("#"+e);if(g.hasClass("dl")){var b=c.record;void 0!==b?g.datalist("ajaxReloadItem",b):g.datalist("ajaxReload")}else try{g.dataTable().fnReloadAjax()}catch(F){}c=self.parent.S3.gis.maps;if("undefined"!=typeof c){var a,l,m,t,f,h,u,q;for(a in c)for(d=c[a],b=e.replace(/-/g,"_"),l=d.layers,m=0,t=l.length;m<t;m++)if(f=l[m],f.s3_layer_id==b){h=f.strategies;f=0;for(u=
h.length;f<u;f++)if(q=h[f],"OpenLayers.Strategy.Refresh"==q.CLASS_NAME){q.refresh();break}break}}a=self.parent.$("#"+e+"-filter-form");a.length&&self.parent.S3.search.ajaxUpdateOptions(a);self.parent.S3.popup_remove()}else if(b=c.refresh_layer,"undefined"!=typeof b){if(c=self.parent.S3.gis.maps,"undefined"!=typeof c)for(a in"undefined"!=b&&(b=parseInt(b)),e=self.parent.i18n.gis_draft_layer,c)for(d=c[a],l=d.layers,m=0,t=l.length;m<t;m++)if(f=l[m],f.s3_layer_id==b)for(h=f.strategies,f=0,u=h.length;f<
u;f++){if(q=h[f],"OpenLayers.Strategy.Refresh"==q.CLASS_NAME){q.refresh();break}}else if(f.name==e){for(;d.popups.length;)d.removePopup(d.popups[0]);h=f.features;for(f=h.length-1;0<=f;f--)h[f].destroy()}}else if(a=c.node)b=self.parent.$("#"+c.hierarchy),a=self.parent.$("#"+a),b&&a&&b.hierarchicalcrud("refreshNode",a),self.parent.S3.popup_remove();else if(a=c.agent,"undefined"!=typeof a)b="undefined"!=typeof d?[d]:[],self.parent.$("#"+a).trigger("configSaved",b);else if("undefined"!=typeof c.level)self.parent.S3.popup_remove();
else{var k=c.caller;if(void 0===k)s3_debug("Neither calling element nor refresh-target specified in popup URL!"),self.parent.S3.popup_remove();else if(s3_debug("Caller: ",k),a=c.person_id,"undefined"!=typeof a)self.parent.$("#"+k).val(a).change(),self.parent.S3.popup_remove();else{b=new RegExp(".*\\"+S3.Ap+"\\/");a=c.child;var p;"undefined"===typeof a?(e=(new String(self.location)).replace(b,""),e=e.split("?")[0].split("/"),p=e[1].split(".")[0]+"_id"):p=a;s3_debug("child_resource",p);var v=c.parent;
d=new String(self.parent.location);a=c.prefix;e=d.replace(b,"");"undefined"===typeof v?(b=k.replace("_"+p,""),s3_debug("parent_field",b),c=b.replace(/_.*/,""),c=b.replace(c+"_",""),e=e.split("?")[0].split("/"),b=null,a||(a=e[0]),d=e[1],2<e.length&&(null!==e[2].match(/\d*/)?3<e.length&&(b=e[3]):b=e[2]),null!==b&&c!=d&&c==b&&(c=d+"/"+b)):(c=v,a||(e=d.replace(b,""),e=e.split("?")[0].split("/"),a=e[0]));s3_debug("parent_resource",c);s3_debug("lookup_prefix",a);a=S3.Ap.concat("/"+a+"/"+c+"/options.s3json?field="+
p);g=self.parent.$("#"+k);s3_debug("selector",g);var C="sub_"==k.substring(0,4),y=self.parent.$("#dummy_"+k),z=void 0!=y.val();s3_debug("has_dummy",z);var w=g.hasClass("checkboxes-widget-s3"),A=g.hasClass("s3-hierarchy-input"),n;if(w){var D=self.parent.$("#"+k+" tbody tr:first").children().length;n=[]}else{var E=self.parent.$("#"+k+" >option"),x="select"==g.prop("tagName").toLowerCase();x?n=[]:a=A?a+"&hierarchy=1&only_last=1":a+"&only_last=1"}var r=1,B="";$.getJSONS3(a,function(a){var c,b,e,d=0;$.each(a.option,
function(){c=this["@value"];b=this.$;"undefined"===typeof b&&(b="");x?n.push(["<option value='",c,"'>",b,"</option>"].join("")):w?(e="id_"+p+"-"+d,n.push(["<td><input id='",e,"' name='",p,"' value='",c,"' type='checkbox'><label for='",e,"'>",b,"</label></td>"].join("")),d++):A&&(v=this["@parent"],g.parent().hierarchicalopts("addNode",v,c,b,!0));numeric_value=+c;numeric_value>r&&(r=numeric_value,B=b)});z&&(y.val(B),g.val(r).change());if(x){if(C){var f=["_0","_none","_default"],h,m=k.split("_").slice(0,
-1).join("_");for(a=0;a<f.length;a++)h=f[a],self.parent.$("#"+m+h).empty().append(n.join(""))}else E.remove(),g.append(n.join("")).val(r).change();g.val(r).change();g.prop("disabled",!1);if(g.hasClass("multiselect-widget")&&g.multiselect("instance"))try{g.multiselect("refresh")}catch(G){}}else if(w){var l=[];self.parent.$("#"+k+" input").each(function(a){$(this).prop("checked")&&l.push($(this).val())});f=[];for(a=d=0;a<n.length;a++)0===d?(f.push("<tr>"),f.push(n[a]),d++):d==D-1?(f.push(n[a]),f.push("</tr>"),
d=0):(f.push(n[a]),d++);g.html(f.join(""));l.push(r);for(a=0;a<l.length;a++)self.parent.$("#"+k+' input[value="'+l[a]+'"]').prop("checked",!0)}self.parent.S3.popup_remove()})}}}function getQueryParams(d){d=d.substring(1);var c={};if(d){d=d.split("&");for(var e,g=0,b=d.length;g<b;g++)e=d[g].split("="),c[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return c};
