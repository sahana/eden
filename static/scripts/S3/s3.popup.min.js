function s3_tb_call_cleanup(b){self.parent.s3_tb_cleanup&&self.parent.s3_tb_cleanup(b);self.parent.s3_tb_remove()}
function s3_tb_refresh(){var b=getQueryParams(document.location.search),c=b.level;if("undefined"===typeof c){var d=b.caller;s3_debug("caller",d);c=b.person_id;if("undefined"===typeof c){var c=RegExp(".*\\"+S3.Ap+"\\/"),a=b.child;if("undefined"===typeof a)var a=new String(self.location),a=a.replace(c,""),a=a.split("?")[0].split("/"),j=a[1]+"_id";else j=a;s3_debug("child_resource",j);b=b.parent;if("undefined"===typeof b){b=d.replace("_"+j,"");s3_debug("parent_field",b);var a=b.replace(/_.*/,""),b=b.replace(a+
"_",""),a=new String(self.parent.location),a=a.replace(c,""),a=a.split("?")[0].split("/"),c=null,h=a[0],m=a[1];2<a.length&&(null!=a[2].match(/\d*/)?3<a.length&&(c=a[3]):c=a[2]);null!=c&&(b!=m&&b==c)&&(b=m+"/"+c)}else a=new String(self.parent.location),a=a.replace(c,""),a=a.split("?")[0].split("/"),h=a[0];s3_debug("parent_resource",b);s3_debug("caller_prefix",h);var a=S3.Ap.concat("/"+h+"/"+b+"/options.s3json?field="+j),k=self.parent.$("#"+d);s3_debug("selector",k);var v="sub_"==d.substring(0,4),r=
self.parent.$("#dummy_"+d),s=void 0!=r.val();s3_debug("has_dummy",s);var p=k.hasClass("checkboxes-widget-s3");if(p)var w=self.parent.$("#"+d+" tbody tr:first").children().length,e=[];else{var t=self.parent.$("#"+d+" >option"),q=t.length;q?e=[]:a+="&only_last=1"}var l=1,u="";$.getJSONS3(a,function(a){var b,c,h,g=0;$.each(a.option,function(){b=this["@value"];c=this.$;"undefined"===typeof c&&(c="");q?e.push(["<option value='",b,"'>",c,"</option>"].join("")):p&&(h="id_"+j+"-"+g,e.push(["<td><input id='",
h,"' name='",j,"' value='",b,"' type='checkbox'><label for='",h,"'>",c,"</label></td>"].join("")),g++);numeric_value=+b;numeric_value>l&&(l=numeric_value,u=c)});s&&(r.val(u),k.val(l).change());if(q){if(v){var f=["_0","_none","_default"],m,x=d.split("_").slice(0,-1).join("_");for(a=0;a<f.length;a++)m=f[a],self.parent.$("#"+x+m).empty().append(e.join(""))}else t.remove(),k.append(e.join("")).val(l).change();k.val(l).change()}else if(p){var n=[];self.parent.$("#"+d+" input").each(function(){$(this).prop("checked")&&
n.push($(this).val())});f=[];for(a=g=0;a<e.length;a++)0==g?(f.push("<tr>"),f.push(e[a]),g++):g==w-1?(f.push(e[a]),f.push("</tr>"),g=0):(f.push(e[a]),g++);k.html(f.join(""));n.push(l);for(a=0;a<n.length;a++)self.parent.$("#"+d+' input[value="'+n[a]+'"]').prop("checked",!0)}s3_tb_call_cleanup(d)})}else"undefined"!==typeof d&&self.parent.$("#"+d).val(c).change(),s3_tb_call_cleanup(c)}else s3_tb_call_cleanup(c)}
function getQueryParams(b){b=b.split("?")[1];b=b.split("&");for(var c={},d=[],a=0;a<b.length;a++)d=b[a].split("="),c[decodeURIComponent(d[0])]=decodeURIComponent(d[1]);return c};
