$(function(){function k(a){$("#add-row-"+a+" > td > input").removeAttr("disabled");$("#add-row-"+a+" > td > select").removeAttr("disabled");$("#add-row-"+a+" > td > textarea").removeAttr("disabled");$("#add-row-"+a+" > td > .inline-add").removeClass("hide")}function m(a,b,c){var d=b.data[c],e={};"undefined"!=typeof d&&(d=d._id,"undefined"!=typeof d&&(e.id=d));for(var d=b.fields,f,h,g=0;g<d.length;g++)f=d[g].name,h="#sub_"+a+"_"+a+"_"+f+"_edit_"+c,h=$(h).val(),e[f]=h;a=b.defaults;for(f in a)e.hasOwnProperty(f)||
(h=a[f].value,e[f]=h);return e}function n(a,b,c,d){var e=S3.Ap.concat("/"+c.controller+"/"+c["function"]+"/validate.json"),c=c.component;null!=c&&(e+="?component="+c);var d=JSON.stringify(d),f=null;$.ajaxS3({type:"POST",url:e,data:d,dataType:"json",success:function(a){f=a},async:!1});e=!1;f.hasOwnProperty("_error")&&(e=!0,inline_append_error(a,b,null,f._error));for(field in f)d=f[field],d.hasOwnProperty("_error")&&(inline_append_error(a,b,field,d._error),e=!0);return e?(inline_display_errors(a),null):
f}var g="none",j="none";inline_get_field=function(a){return $("#sub-"+a).attr("field")};inline_deserialize=function(a){a="#"+inline_get_field(a);data_json=$(a).val();data=JSON.parse(data_json);$(a).data("data",data);return data};inline_serialize=function(a){a="#"+inline_get_field(a);data=$(a).data("data");data_json=JSON.stringify(data);$(a).val(data_json);return data_json};inline_append_error=function(a,b,c,d){null==c?(field_id="none"==b?"#add-row-"+a:"#edit-row-"+a,l=$(field_id+"> td").length,msg=
'<tr class="'+a+'_error"><td colspan="'+l+'"><div class="error">'+d+"</div></td></tr>"):(field_id="#sub_"+a+"_"+a+"_"+c+"_edit_"+b,msg='<div class="'+a+'_error error">'+d+"</div>");$(field_id).after(msg);$("."+a+"_error").hide();$(".error").click(function(){$(this).fadeOut("slow");return false})};inline_display_errors=function(a){$("."+a+"_error").slideDown()};inline_remove_errors=function(a){$("."+a+"_error").remove()};inline_edit=function(a,b){var c=a+"-"+b;inline_remove_errors(a);$(".read-row").removeClass("hide");
$("#read-row-"+c).addClass("hide");data=inline_deserialize(a);fields=data.fields;row=data.data[b];for(i=0;i<fields.length;i++)fieldname=fields[i].name,value=row[fieldname].value,element="#sub_"+a+"_"+a+"_"+fieldname+"_edit_0",$(element).val(value);$("#edit-row-"+a).insertAfter("#read-row-"+c);$("#edit-row-"+a).data("rowindex",b);$("#edit-row-"+a).removeClass("hide");$("#add-row-"+a+" > td > input").attr("disabled",!0);$("#add-row-"+a+" > td > select").attr("disabled",!0);$("#add-row-"+a+" > td > textarea").attr("disabled",
!0);$("#add-row-"+a+" > td > .inline-add").addClass("hide")};inline_cancel=function(a,b){var c=a+"-"+b;inline_remove_errors(a);$("#edit-row-"+a).addClass("hide");$("#edit-row-"+a).data("rowindex",null);$("#read-row-"+c).removeClass("hide");k(a)};inline_add=function(a){$("#add-"+a+"-none").addClass("hide");$("#throbber-"+a+"-none").removeClass("hide");inline_remove_errors(a);var b=inline_deserialize(a),c=m(a,b,"none"),c=n(a,"none",b,c);if(null!=c){newindex=b.data.push(c)-1;inline_serialize(a,b);read_row=
'<tr id="read-row-'+a+"-"+newindex+'" class="read-row">';fields=b.fields;for(i=0;i<fields.length;i++)field=fields[i].name,read_row+="<td>"+c[field].text+"</td>",default_value=$("#sub_"+a+"_"+a+"_"+field+"_edit_default").val(),$("#sub_"+a+"_"+a+"_"+field+"_edit_none").val(default_value);edit="#edt-"+a+"-none";read_row=0!=$(edit).length?read_row+('<td><a id="edt-'+a+"-"+newindex+'" class="inline-edt" href="#">'+$(edit).html()+"</a></td>"):read_row+"<td></td>";remove="#rmv-"+a+"-none";read_row=0!=$(remove).length?
read_row+('<td><a id="rmv-'+a+"-"+newindex+'" class="inline-rmv" href="#">'+$(remove).html()+"</a></td>"):read_row+"<td></td>";read_row+="</tr>";$("#sub-"+a+" > table.embeddedComponent > tbody").append(read_row);inline_form_events()}$("#throbber-"+a+"-none").addClass("hide");$("#add-"+a+"-none").removeClass("hide")};inline_update=function(a,b){var c=a+"-"+b;$("#rdy-"+a+"-0").addClass("hide");$("#throbber-"+a+"-0").removeClass("hide");inline_remove_errors(a);var d=inline_deserialize(a),e=m(a,d,"0"),
e=n(a,"0",d,e);if(null!=e){e._id=d.data[b]._id;d.data[b]=e;inline_serialize(a,d);read_row="";fields=d.fields;for(i=0;i<fields.length;i++)field=fields[i].name,read_row+="<td>"+e[field].text+"</td>",default_value=$("#sub_"+a+"_"+a+"_"+field+"_edit_default").val(),$("#sub_"+a+"_"+a+"_"+field+"_edit_0").val(default_value);edit="#edt-"+a+"-none";read_row=0!=$(edit).length?read_row+('<td><a id="edt-'+a+"-"+b+'" class="inline-edt" href="#">'+$(edit).html()+"</a></td>"):read_row+"<td></td>";remove="#rmv-"+
a+"-none";read_row=0!=$(remove).length?read_row+('<td><a id="rmv-'+a+"-"+b+'" class="inline-rmv" href="#">'+$(remove).html()+"</a></td>"):read_row+"<td></td>";$("#read-row-"+a+"-"+b+" > td").remove();$("#read-row-"+a+"-"+b).html(read_row);inline_form_events();$("#edit-row-"+a).addClass("hide");$("#edit-row-"+a).data("rowindex",null);$("#read-row-"+c).removeClass("hide");k(a)}$("#rdy-"+a+"-0").removeClass("hide");$("#throbber-"+a+"-0").addClass("hide")};inline_remove=function(a,b){var c=a+"-"+b;if(!confirm(S3.i18n.delete_confirmation))return!1;
data=inline_deserialize(a);data.data[b]._delete=!0;inline_serialize(a,data);$("#read-row-"+c).remove()};inline_row_submit=function(){if("none"!=g)"none"==j?inline_add(g):inline_update(g,j);else return!0;return!1};inline_catch_submit=function(a){a?($("form").unbind("submit",inline_row_submit),$("form").bind("submit",inline_row_submit)):$("form").unbind("submit",inline_row_submit)};inline_form_events=function(){$(".edit-row").unbind("focusin");$(".edit-row").focusin(function(){names=$(this).attr("id").split("-");
g=names.pop();j=$(this).data("rowindex");inline_catch_submit(!0)});$(".edit-row").unbind("focusout");$(".edit-row").focusout(function(){j=g="none";inline_catch_submit(!1)});$(".add-row").unbind("focusin");$(".add-row").focusin(function(){names=$(this).attr("id").split("-");g=names.pop();j="none";inline_catch_submit(!0)});$(".add-row").unbind("focusout");$(".add-row").focusout(function(){j=g="none";inline_catch_submit(!1)});$(".inline-add").unbind("click");$(".inline-add").click(function(){names=$(this).attr("id").split("-");
rowindex=names.pop();formname=names.pop();inline_add(formname)});$(".inline-cnc").unbind("click");$(".inline-cnc").click(function(){names=$(this).attr("id").split("-");zero=names.pop();formname=names.pop();rowindex=$("#edit-row-"+formname).data("rowindex");inline_cancel(formname,rowindex)});$(".inline-rdy").unbind("click");$(".inline-rdy").click(function(){names=$(this).attr("id").split("-");zero=names.pop();formname=names.pop();rowindex=$("#edit-row-"+formname).data("rowindex");inline_update(formname,
rowindex)});$(".inline-edt").unbind("click");$(".inline-edt").click(function(){names=$(this).attr("id").split("-");rowindex=names.pop();formname=names.pop();inline_edit(formname,rowindex)});$(".inline-rmv").unbind("click");$(".inline-rmv").click(function(){names=$(this).attr("id").split("-");rowindex=names.pop();formname=names.pop();inline_remove(formname,rowindex)})};inline_form_events()});
