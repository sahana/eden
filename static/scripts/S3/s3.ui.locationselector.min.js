/*
 2015-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,p,n){c instanceof String&&(c=String(c));for(var g=c.length,e=0;e<g;e++){var f=c[e];if(p.call(n,f,e,c))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,p,n){c!=Array.prototype&&c!=Object.prototype&&(c[p]=n.value)};$jscomp.getGlobal=function(c){c=["object"==typeof globalThis&&globalThis,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,c];for(var p=0;p<c.length;++p){var n=c[p];if(n&&n.Math==Math)return n}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(c,p,n,g){if(p){n=$jscomp.global;c=c.split(".");for(g=0;g<c.length-1;g++){var e=c[g];e in n||(n[e]={});n=n[e]}c=c[c.length-1];g=n[c];p=p(g);p!=g&&null!=p&&$jscomp.defineProperty(n,c,{configurable:!0,writable:!0,value:p})}};$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(c,n){return $jscomp.findInternal(this,c,n).v}},"es6","es3");
(function(c,p){var n=0,g={},e={},f={};c.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){this.id=n;n+=1;this.eventNamespace=".locationselector"},_init:function(){var b=c(this.element),a=this.options,d=b.attr("id");if(!d)throw"Location selector widget: real input field without id";this.fieldname=d;this.input=b;this.data=null;this._storeHierarchyData(a.labels,
a.locations);this.refresh()},_destroy:function(){c.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var b=this._deserialize();this._renderWidget();var a="#"+this.fieldname,d=this.options;c(a+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var h=c(a+"_L0__row");if(h.length){var m=[];for(q in g){var l=g[q];0===l.l&&(l.i=q,m.push(l))}m.sort(function(a,b){return a.n.localeCompare(b.n)});for(var k=c(a+"_L0"),e=0,f=m.length;e<f;e++){l=m[e];var q=l.i;l='<option value="'+
q+'">'+l.n+"</option>";k.append(l)}h.removeClass("hide").show();h=c(a+"_L0__row1");h.length&&h.removeClass("hide").show()}h=b.L0;m=b.L1;k=b.L2;e=b.L3;f=b.L4;l=b.L5;h&&this._lxSelect(0,h,!0);(m||k)&&this._lxSelect(1,m||k,!0);(k||e)&&this._lxSelect(2,k||e,!0);(e||f)&&this._lxSelect(3,e||f,!0);(f||l)&&this._lxSelect(4,f||l,!0);l&&this._lxSelect(5,l,!0);this.lx=[h,m,k,e,f,l].join("|");c(a+"_address").val(b.address);c(a+"_address__row").removeClass("hide").show();c(a+"_address__row1").removeClass("hide").show();
c(a+"_postcode").val(b.postcode);c(a+"_postcode__row").removeClass("hide").show();c(a+"_postcode__row1").removeClass("hide").show();c(a+"_lat").val(b.lat).latloninput({type:"lat",mode:d.latlonMode});c(a+"_lat__row").removeClass("hide").show();c(a+"_lat__row1").removeClass("hide").show();c(a+"_lon").val(b.lon).latloninput({type:"lon",mode:d.latlonMode});c(a+"_lon__row").removeClass("hide").show();c(a+"_lon__row1").removeClass("hide").show();h=c(a+"_map_icon__row").removeClass("hide").show();b.lat||
b.lon||b.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):d.featureRequired?this._showMap():d.openMapOnLoad&&h.is(":visible")&&"#sub_"!=a.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var b=this.fieldname,a="#"+b,d=this.options.reverseLx,h=c(a+"_map_icon__row .map_wrapper");h.attr("id",this.fieldname+"_map_wrapper");var m=c(a+"__row"),g=this.input.next(".error_wrapper"),
k=c(a+"_map_icon__row"),e=c(a+"_L0__row"),f=c(a+"_postcode__row");if(m.is(".control-group, .form-row")){b=c(a+"_L1__row");var q=c(a+"_L2__row"),n=c(a+"_L3__row"),y=c(a+"_L4__row"),t=c(a+"_L5__row"),r=c(a+"_address__row"),p=c(a+"_lat__row"),u=c(a+"_lon__row");a=c(a+"_latlon_toggle__row");d?m.hide().after(h).after(k).after(a).after(u).after(p).after(e).after(b).after(q).after(n).after(y).after(t).after(f).after(r).after(g):m.hide().after(h).after(k).after(a).after(u).after(p).after(f).after(r).after(t).after(y).after(n).after(q).after(b).after(e).after(g)}else m.parent().is(".inline-form")?
m.show():(c(a+"__row1").hide(),m.hide().after(g),k.detach(),m.siblings('[id^="'+b+'"][id$="__row"]').last().after(h).after(k));if(g.length)g.one("click"+this.eventNamespace,function(){var a=c(this);a.fadeOut("slow",function(){a.remove()})})},_lxSelectFinal:function(b){b?this._serialize():this._collectData();this._zoomMap()},_lxSelect:function(b,a,d){var h="#"+this.fieldname,m=this.options,l=c(h+"_L"+b),k;a?(l.val(a).trigger("change","implicit"),l.hasClass("multiselect")&&l.multiselect("instance")&&
l.multiselect("refresh")):a=parseInt(l.val(),10);if(0===b){var f=this._readLabels(a),n=e.d,q=["1","2","3","4","5"],p,y,t;f.then(function(a){for(t=0;5>t;t++)k=q[t],p=a[k]||n[k],r=h+"_L"+k,l=c(r),y=m.showLabels?l.hasClass("required")?"<div>"+p+':<span class="req"> *</span></div>':p+":":"",c(r+"__row label").html(y),c(r+"__row1 label").html(y),c(r+' option[value=""]').html(i18n.select+" "+p),l.hasClass("multiselect")&&l.multiselect("instance")&&l.multiselect("refresh")})}f=m.hideLx;for(k=b+1;6>k;k++){var r=
h+"_L"+k;f?(c(r+"__row").hide(),c(r+"__row1").hide()):c(r+" option").remove('[value != ""]');c(r).val("").trigger("change","implicit")}if(a){var A=!1,u=b+1,B=c(h+"_L"+u+"__row");B.length||(A=!0,u++,B=c(h+"_L"+u+"__row"));if(B.length){var v;f=!1;var C=this;if(c(h+"_L"+b+' option[value="'+a+'"]').hasClass("missing")){var w=g[a];w.i=a;var x=[w]}else for(v in x=[],f=!0,g)if(g[v].f==a){f=!1;break}this._readHierarchy(f,a,u,A).then(function(){if(0==x.length)for(v in g)w=g[v],w.f==a&&(w.i=v,x.push(w));var b=
x.length;if(b){x.sort(function(a,b){return a.n.localeCompare(b.n)});var k=h+"_L"+u;var m=c(k),f=c(k+' option[value=""]').html();c(k+" option").remove('[value != ""]');v=null;for(t=0;t<b;t++)w=x[t],v=w.i,k=a==v?' selected="selected"':"",A=w.l==u?"":' class="missing"',k='<option value="'+v+'"'+k+A+">"+w.n+"</option>",m.append(k);B.removeClass("hide").show();c(h+"_L"+u+"__row1").removeClass("hide").show();m.hasClass("multiselect")&&(f={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:f,
multiple:!1},m.hasClass("search")?(m.multiselect(f).multiselectfilter({label:"",placeholder:i18n.search}),c(".ui-multiselect-header").show()):(f.header=!1,m.multiselect(f)));m=C.data["L"+u];f=x.map(function(a){return a.i});m&&-1!=f.indexOf(""+m)?C._lxSelect(u,m,d):1==b&&v&&C._lxSelect(u,v,d)}C._lxSelectFinal(d)})}else this.useGeocoder&&!d&&this._geocodeDecision(),this._lxSelectFinal(d)}else this._lxSelectFinal(d)},_collectData:function(b){var a=this.data,d="#"+this.fieldname,h=this._lookupParent(),
m=c(d+"_address").val(),g=c(d+"_postcode").val();a.address=m;a.postcode=g;if(a.specific)a.id=a.specific,a.parent=h;else{var k=a.lat,f=a.lon,e=a.wkt;m||g||k||f||e?(a.id=null,a.parent=h):(a.id=h,a.parent=null)}this._serialize();c(d+"_lat").val(a.lat).trigger("setvalue");c(d+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.trigger("change",b&&"user"||"implicit")},_collectLx:function(){var b=this.data,a="#"+this.fieldname,d;
for(d=0;6>d;d++){var h=c(a+"_L"+d);h.length&&(h=h.val(),b["L"+d]=h?parseInt(h,10):null)}this._serialize()},_hasData:function(){var b=this.data,a=!1;b.specific||b.address||b.postcode||b.lat||b.lon||b.wkt?a=!0:[b.L0,b.L1,b.L2,b.L3,b.L4,b.L5].join("|")!=this.lx&&(a=!0);return a},_lookupParent:function(){this._collectLx();for(var b=this.data,a,c=5;-1<c;c--)if(a=b["L"+c])return a;return(b=g.d)?b.i:null},_readLabels:function(b){b||(b="d");var a=c.Deferred(),d=e[b];if(d==p){var h=S3.Ap.concat("/gis/hdata/"+
b);c.ajaxS3({url:h,dataType:"json",success:function(c){d={};try{for(var h in c)d[h]=c[h];e[b]=d}catch(k){}a.resolve(d)},error:function(b,c,d){(b="UNAUTHORIZED"==d?i18n.gis_requires_login:b.responseText)&&s3_debug(b);a.reject()}})}else a.resolve(d);return a.promise()},_readHierarchy:function(b,a,d,h){var m=""+a+";"+d+";"+h,e=f[m];if(e!==p)return e;var k=c.Deferred();if(b){b="#"+this.fieldname;var z=c(b+"_L"+d),n=!1;z.hide();if(z.hasClass("multiselect")){n=!0;var q=c(b+"_L"+d+"__row button").hide()}var D=
c(b+"_L"+d+"__throbber").removeClass("hide").show();a=h?S3.Ap.concat("/gis/ldata/"+a+"/"+d):S3.Ap.concat("/gis/ldata/"+a);c.ajaxS3({url:a,dataType:"json",success:function(a){for(var b in a)g[b]=a[b];D.hide();n?q.removeClass("hide").show():z.removeClass("hide").show();k.resolve()},error:function(a,b,c){if(a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)s3_debug(a),S3.showAlert(a,"error");D.hide();n?q.removeClass("hide").show():z.removeClass("hide").show();k.reject()}})}else k.resolve();
return e=f[m]=k.promise()},_geocodeDecision:function(){var b="#"+this.fieldname,a=this.data;this._collectData();if(a.address){a=["1","2","3","4","5"];for(var d=0,h;5>d;d++)if(h=c(b+"_L"+a[d]),h.length&&!h.val()&&1<h[0].options.length)return;c(b+"_geocode .geocode_success,"+b+"_geocode .geocode_fail").hide();var g=this;a=this.eventNamespace;this.input.data("manually_geocoded")?c(b+"_geocode button").removeClass("hide").show().unbind(a).bind("click"+a,function(){c(this).hide();g._geocode()}):this._geocode()}},
_geocode:function(){var b=this.fieldname,a=this,d="#"+b,h=c(d+"_geocode .geocode_fail").hide(),g=c(d+"_geocode .geocode_success").hide(),f=c(d+"_geocode .throbber").removeClass("hide").show(),k=this.data;d={address:k.address};for(var e="postcode L0 L1 L2 L3 L4 L5".split(" "),n=0,q,p;7>n;n++)q=e[n],(p=k[q])&&(d[q]=p);e=S3.Ap.concat("/gis/geocode");c.ajaxS3({url:e,type:"POST",data:d,dataType:"json",success:function(c){var d=c.lat,m=c.lon;if(d||m){k.lat=parseFloat(d);k.lon=parseFloat(m);a._collectData();
d=S3.gis;if(d.maps&&(m=d.maps["location_selector_"+b])){c=m.s3.draftLayer;c.removeAllFeatures();var e=new OpenLayers.Geometry.Point(k.lon,k.lat);e.transform(d.proj4326,m.getProjectionObject());d=new OpenLayers.Feature.Vector(e);c.addFeatures([d]);a._zoomMap()}f.hide();g.html(i18n.address_mapped).removeClass("hide").show()}else f.hide(),h.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(c)},error:function(a,b,c){a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;f.hide();h.html(i18n.address_not_mapped).removeClass("hide").show();
s3_debug(a)}})},_geocodeReverse:function(){var b=this,a="#"+this.fieldname,d=c(a+"_geocode .geocode_fail").hide(),h=c(a+"_geocode .geocode_success").hide(),g=c(a+"_geocode .throbber").removeClass("hide").show();a=this.data;a={lat:a.lat,lon:a.lon};var f=S3.Ap.concat("/gis/geocode_r");c.ajaxS3({async:!1,url:f,type:"POST",data:a,dataType:"json",success:function(a){a.L0?(b.useGeocoder=!1,b._lxSelect(0,a.L0),a.L1&&b._lxSelect(1,a.L1),a.L2&&b._lxSelect(2,a.L2),a.L3&&b._lxSelect(3,a.L3),a.L4&&b._lxSelect(4,
a.L4),a.L5&&b._lxSelect(5,a.L5),b.useGeocoder=!0,g.hide(),h.html(i18n.location_found).removeClass("hide").show()):(g.hide(),d.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,b,c){a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;g.hide();d.html(i18n.location_not_found).removeClass("hide").show();s3_debug(a)}})},_latlonInput:function(){var b=this.fieldname,a=this.data,d="#"+b,h=c(d+"_lat").val();d=c(d+"_lon").val();h||d?(h=h?parseFloat(h):0,d=d?parseFloat(d):0,
a.lat=h,a.lon=d,a.wkt=null,this.input.data("manually_geocoded",!0)):(a.lat=null,a.lon=null,a.wkt||this.input.data("manually_geocoded",!1));this._serialize();h=S3.gis;h.maps&&(b=h.maps["location_selector_"+b])&&(d=b.s3.draftLayer,d.removeAllFeatures(),null!==a.lat&&null!==a.lon&&(a=new OpenLayers.Geometry.Point(a.lon,a.lat),a.transform(h.proj4326,b.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),d.addFeatures([a]),b.s3.lastDraftFeature=a),this._zoomMap())},_showMap:function(b){var a=this.fieldname,
d=this.eventNamespace,h=this,g="#"+a;c(g+"_map_icon").unbind(d).bind("click"+d,function(){h._hideMap()});c(g+"_map_icon span").html(i18n.hide_map);d=c(g+"_map_wrapper").hide().removeClass("hide").slideDown("medium");d.length&&b&&c("html,body").animate({scrollTop:d.offset().top},250);var f=this.input;c.when(this._jsLoaded()).then(function(){var b=S3.gis,d="location_selector_"+a;var e=b.maps[d]?b.maps[d]:b.show_map(d);h._zoomMap();var m=h.data;d=m.lat;var l=m.lon,n=m.wkt;if(d||l||n)e.s3.draftLayer.removeAllFeatures(),
n!=p&&n?(d={internalProjection:e.getProjectionObject(),externalProjection:b.proj4326},d=(new OpenLayers.Format.WKT(d)).read(n)):(d=new OpenLayers.Geometry.Point(parseFloat(l),parseFloat(d)),d.transform(b.proj4326,e.getProjectionObject()),d=new OpenLayers.Feature.Vector(d)),e.s3.draftLayer.addFeatures([d]),e.s3.lastDraftFeature=d;d=e.controls;l=0;for(var t=d.length;l<t;l++)if("OpenLayers.Control.DrawFeature"==d[l].CLASS_NAME){var r=d[l];break}r&&(e.s3.pointPlaced=function(d){c(g+"_geocode .geocode_fail").hide();
c(g+"_geocode .geocode_success").hide();var k=d.geometry;if("OpenLayers.Geometry.Point"==k.CLASS_NAME)d=k.getBounds().getCenterLonLat(),d.transform(e.getProjectionObject(),b.proj4326),m.wkt=null,m.lat=d.lat,m.lon=d.lon,!m.address&&h.useGeocoder&&h._geocodeReverse();else{k={internalProjection:e.getProjectionObject(),externalProjection:b.proj4326};m.radius=null;var l=new OpenLayers.Geometry.LinearRing(d.geometry.components[0].components);l=new OpenLayers.Geometry.Polygon([l]);if(1E3==l.getVertices().length){var p=
(new OpenLayers.Feature.Vector(l,null)).geometry.getBounds();l=p.right;var q=(p.bottom+p.top)/2;p=new OpenLayers.Geometry.Point((p.left+l)/2,q);l=new OpenLayers.Geometry.Point(l,q);l=new OpenLayers.Geometry.LineString([p,l]);l=parseFloat(l.getLength());m.radius=l}n=(new OpenLayers.Format.WKT(k)).write(d);m.wkt=n;m.lat=null;m.lon=null}f.data("manually_geocoded",!0);h._collectData(!0);h._removeErrors();"sub_"==a.substring(0,4)&&f.parent().find("div.map_wrapper").trigger("change")})},function(a){s3_debug(a)},
function(a){s3_debug(a)})},_hideMap:function(){var b=this.fieldname,a=this.eventNamespace,d="#"+b,h=this;c(d+"_map_icon").unbind(a).bind("click"+a,function(a){h._showMap(a)});c(d+"_map_wrapper").slideUp("medium");a=this.data;if(a.specific)var g=i18n.show_map_view;else if(g=i18n.show_map_add,S3.gis.maps&&(b=S3.gis.maps["location_selector_"+b]))b.s3.draftLayer.removeAllFeatures(),a.lat=null,a.lon=null,a.wkt=null,this.input.data("manually_geocoded",!1),this._collectData();c(d+"_map_icon span").html(g)},
_zoomMap:function(b){var a=this.fieldname,d=S3.gis;if(d.maps&&(a=d.maps["location_selector_"+a])){var c=this.data;d=c.lat;var e=c.lon;c=c.wkt;if(d&&e)d=OpenLayers.Bounds.fromArray([e,d,e,d]);else if(c)d=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(c))).geometry.getBounds();else{b||(b=this._lookupParent()||"d");d=g[b].b;if(!d||!d.length)for(e=g[b].f,b=4;e&&b&&(b--,e=g[e],!(d=e.b)&&0!==e.l);)e=e.f;d&&(d=OpenLayers.Bounds.fromArray(d))}d&&S3.gis.zoomBounds(a,d,this.options.minBBOX)}},_validate:function(){var b=
this.fieldname;this._removeErrors();b="#"+b;var a=this.data,d=this.options.featureRequired;if(d){var e=!1;switch(d){case "latlon":e=a.lat||a.lon;break;case "wkt":e=a.wkt;break;default:e=a.lat||a.lon||a.wkt}if(!e)return S3.fieldError(b+"_map_icon",i18n.map_feature_required),!1}var f=a.id;d="address L5 L4 L3 L2 L1 L0".split(" ");e=function(a){return a.hasClass("multiselect")?a.next("button.ui-multiselect").is(":visible"):a.is(":visible")};if(f){if(!g[f])return!0;var l=g[f].l;for(a=0;a<6-l;a++){f=b+
"_"+d[a];var k=c(f);if(k.length&&k.hasClass("required")&&e(k))return S3.fieldError(f,i18n.enter_value),!1}}else{if(a.lat||a.lon||a.wkt||a.address||a.postcode)return!0;for(a=0;7>a;a++)if(f=b+"_"+d[a],k=c(f),k.length&&k.hasClass("required")&&e(k))return S3.fieldError(f,i18n.enter_value),!1}return!0},_serialize:function(){var b=JSON.stringify(this.data);this.input.val(b);return b},_deserialize:function(){var b=this.input.val();return this.data=JSON.parse(b)},_storeHierarchyData:function(b,a){var d;if(a)for(d in a)g[d]=
a[d];if(b)for(d in b)e[d]=b[d]},_jsLoaded:function(){var b=new jQuery.Deferred;setTimeout(function d(){S3.gis.maps!=p?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(d,500))},1);return b.promise()},_removeErrors:function(b){b||(b="#"+this.fieldname,b=b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon");c(b).siblings(".error").remove()},_bindEvents:function(){var b=this.fieldname,a=this.eventNamespace,d=this,
e="#"+b;c(e+"_L0").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(0)});c(e+"_L1").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(1)});c(e+"_L2").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(2)});c(e+"_L3").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(3)});c(e+"_L4").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(4)});c(e+"_L5").bind("change"+a,function(){d._removeErrors(this);d._lxSelect(5)});c(e+"_address,"+e+"_postcode").bind("change"+
a,function(){d._removeErrors(this);d.useGeocoder?d._geocodeDecision():d._collectData()});c(e+"_lat,"+e+"_lon").bind("change"+a,function(){d._latlonInput()});c(e+"_latlon_toggle").bind("click"+a,function(){var a=c(this).data("mode")||d.options.latlonMode;if("dms"==a){a="decimal";var b=i18n.latlon_mode.dms}else a="dms",b=i18n.latlon_mode.decimal;c(e+"_lat").latloninput("option",{mode:a});c(e+"_lon").latloninput("option",{mode:a});c(this).html(b).data("mode",a)});if("sub_"==b.substring(0,4))this.input.closest(".inline-form").bind("validate"+
a+this.id,function(a){d._validate()||a.preventDefault()});else{var g=this.input.closest("form");g.bind("submit"+a+this.id,function(b){b.preventDefault();d._validate()&&g.unbind(a+d.id).submit()})}return!0},_unbindEvents:function(){var b="#"+this.fieldname,a=this.eventNamespace;c(b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon,"+b+"_latlon_toggle").unbind(a);this.input.next(".error_wrapper").unbind(a);this.input.closest("form").unbind(a+this.id);return!0}})})(jQuery);
(function(c,p){var n=0;c.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){this.id=n;n+=1;this.eventNamespace=".latloninput"},_init:function(){c(this.element).hide();this.refresh()},_destroy:function(){c(this.element).show();c.Widget.prototype.destroy.call(this)},_setOption:function(c,e){this._super(c,e);"mode"==c&&this.refresh()},refresh:function(){this._unbindEvents();var g=c(this.element),e=this.options;this.defaultValue=g.val();
if(!this.input){var f=c("<div>").hide().insertAfter(g),b=c('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=b;var a=e.labels,d=c('<input type="text" class="integer dms-input" size="5">'),h=c('<span class="dms-label">'+a.deg+"</span>"),m=c('<input type="text" class="integer dms-input" size="5">'),l=c('<span class="dms-label">'+a.min+"</span>"),k=c('<input type="text" class="double dms-input" size="8">');a=c('<span class="dms-label">'+a.sec+"</span>");this.degInput=d;this.minInput=
m;this.secInput=k;this.dmsInput=d=c("<span>").append(d).append(h).append(m).append(l).append(k).append(a).hide();this.input=f.append(b).append(d).show()}this._removeErrors();"dms"==e.mode?(g=this._getDMS(),this.degInput.val(g.d),this.minInput.val(g.m),this.secInput.val(g.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(g.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var g=c(this.element).val();if(isNaN(parseFloat(g))||!isFinite(g))return{d:"",
m:"",s:""};var e=Math.abs(g);e=60*(e-parseInt(e,10));if(1E-10>Math.abs(e-Math.round(e))){e=Math.round(e);var f=0}else f=60*(e-parseInt(e,10)),1E-10>Math.abs(f-Math.round(f))&&(f=Math.round(f));return{d:parseInt(g,10),m:parseInt(e,10),s:f}},_showError:function(c,e){"all"==c?this.input.find("input").addClass("invalidinput"):c&&c.addClass("invalidinput");e&&this.input.append('<div class="error">'+e+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");this.input.find(".error").remove()},
_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var c=90;var e=i18n.latlon_error.lat}else c=180,e=i18n.latlon_error.lon;var f=this.degInput.val(),b=this.minInput.val(),a=this.secInput.val(),d=[];if(""===f&&""===b&&""===a)return"";f=parseInt(f,10)||0;b=parseInt(b,10)||0;a=parseFloat(a)||0;60<=Math.abs(b)&&(this._showError(this.minInput),d.push(i18n.latlon_error.min));60<=Math.abs(a)&&(this._showError(this.secInput),d.push(i18n.latlon_error.sec));b=Math.abs(f)+b/60+a/3600;
if(!d.length&&b>c||f>c)this._showError("all"),d.push(e);return d.length?(this._showError(null,d.join(", ")),null):(0>f?-1:1)*b},_validateDecimal:function(){this._removeErrors();var c=this.options.type,e=i18n.latlon_error.format;if("lat"==c){var f=90;var b=i18n.latlon_error.lat}else f=180,b=i18n.latlon_error.lon;var a=this.decimalInput.val();if(""===a)return"";a=this._parse(a,c);null===a?this._showError(this.decimalInput,e):Math.abs(a)>f&&(this._showError(this.decimalInput,b),a=null);return a},_parse:function(c,
e){var f="lat"==e?{N:1,S:-1}:{E:1,W:-1};var b=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,a=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,d=e=0,h=0;if(c.match(b))return a=c.replace(b,"$1|$2|$3").split("|"),(c=a[0]||a[2])&&(c=f[c]),e=parseFloat(a[1]),c&&Math.abs(e)!=e&&(c=null),c&&(e*=c),e;if(c.match(a)){a=c.replace(a,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");(c=a[0]||a[7])&&
(c=f[c]);f=[];b=[];var g,l;for(l=1;6>l;l+=2){var k=a[l];(g=a[l+1])?(f.push(parseFloat(k)||0),b.push(g)):k&&(f.push(parseFloat(k)),b.push(null))}if(a=f.length){for(l=1;l<a;l++)f[l]=Math.abs(f[l]);k=f[0];Math.abs(k)!=k&&(c=1);if(1==a)g=b[0],'"'==g?h=f[0]:"'"==g?d=f[0]:g&&"\u00b0"!=g||(e=f[0]);else if(2==a)if(a=b[0],b=b[1],"\u00b0"==a)e=f[0],'"'==b?h=f[1]:"'"!=b&&b||(d=f[1]);else if(a){if("'"!=a||b&&'"'!=b)return null;d=f[0];h=f[1]}else'"'==b?(d=f[0],h=f[1]):"'"!=b&&b||(e=f[0],d=f[1]);else{if(b[0]&&
"\u00b0"!=b[0]||b[1]&&"'"!=b[1]||b[2]&&'"'!=b[2])return null;e=f[0];d=f[1];h=f[2]}e=e+d/60+h/3600;c&&(e*=c);return e}}return null},_bindEvents:function(){var g=this,e=this.eventNamespace;this.dmsInput.find("input").bind("change"+e,function(){var e=g._validateDMS();null!==e?c(g.element).val(e).change():c(g.element).val(g.defaultValue).change()});this.decimalInput.bind("change"+e,function(){var e=g._validateDecimal();null!==e?(c(g.element).val(e).change(),g.decimalInput.val(e)):c(g.element).val(g.defaultValue).change()});
c(this.element).bind("setvalue"+e,function(){g.refresh()});return!0},_unbindEvents:function(){var g=this.eventNamespace;this.input&&this.input.find("input").unbind(g);c(this.element).unbind(g);return!0}})})(jQuery);
