/*
 2015-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(d,p,l){d instanceof String&&(d=String(d));for(var f=d.length,g=0;g<f;g++){var b=d[g];if(p.call(l,b,g,d))return{i:g,v:b}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,p,l){d!=Array.prototype&&d!=Object.prototype&&(d[p]=l.value)};$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(d,p,l,f){if(p){l=$jscomp.global;d=d.split(".");for(f=0;f<d.length-1;f++){var g=d[f];g in l||(l[g]={});l=l[g]}d=d[d.length-1];f=l[d];p=p(f);p!=f&&null!=p&&$jscomp.defineProperty(l,d,{configurable:!0,writable:!0,value:p})}};$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(d,l){return $jscomp.findInternal(this,d,l).v}},"es6","es3");
(function(d,p){var l=0,f={},g={};d.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0,featureRequired:null,latlonMode:"decimal",latlonModeToggle:!0,openMapOnLoad:!1},_create:function(){this.id=l;l+=1;this.eventNamespace=".locationselector"},_init:function(){var b=d(this.element),a=this.options,c=b.attr("id");if(!c)throw"Location selector widget: real input field without id";this.fieldname=c;this.input=b;this.data=null;this._storeHierarchyData(a.labels,
a.locations);this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},refresh:function(){this._unbindEvents();var b=this._deserialize();this._renderWidget();var a="#"+this.fieldname,c=this.options;d(a+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var e=d(a+"_L0__row");if(e.length){var h=[];for(r in f){var m=f[r];0===m.l&&(m.i=r,h.push(m))}h.sort(function(a,b){return a.n.localeCompare(b.n)});for(var k=d(a+"_L0"),n=0,g=h.length;n<g;n++){m=h[n];var r=m.i;m='<option value="'+
r+'">'+m.n+"</option>";k.append(m)}e.removeClass("hide").show();e=d(a+"_L0__row1");e.length&&e.removeClass("hide").show()}e=b.L0;h=b.L1;k=b.L2;n=b.L3;g=b.L4;m=b.L5;e&&this._lxSelect(0,e,!0);(h||k)&&this._lxSelect(1,h||k,!0);(k||n)&&this._lxSelect(2,k||n,!0);(n||g)&&this._lxSelect(3,n||g,!0);(g||m)&&this._lxSelect(4,g||m,!0);m&&this._lxSelect(5,m,!0);this.lx=[e,h,k,n,g,m].join("|");d(a+"_address").val(b.address);d(a+"_address__row").removeClass("hide").show();d(a+"_address__row1").removeClass("hide").show();
d(a+"_postcode").val(b.postcode);d(a+"_postcode__row").removeClass("hide").show();d(a+"_postcode__row1").removeClass("hide").show();d(a+"_lat").val(b.lat).latloninput({type:"lat",mode:c.latlonMode});d(a+"_lat__row").removeClass("hide").show();d(a+"_lat__row1").removeClass("hide").show();d(a+"_lon").val(b.lon).latloninput({type:"lon",mode:c.latlonMode});d(a+"_lon__row").removeClass("hide").show();d(a+"_lon__row1").removeClass("hide").show();e=d(a+"_map_icon__row").removeClass("hide").show();b.lat||
b.lon||b.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):c.featureRequired?this._showMap():c.openMapOnLoad&&e.is(":visible")&&"#sub_"!=a.substring(0,5)?this._showMap():this._hideMap();this.input.data("input",this._hasData());this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var b=this.fieldname,a="#"+b,c=this.options.reverseLx,e=d(a+"_map_icon__row .map_wrapper");e.attr("id",this.fieldname+"_map_wrapper");var h=d(a+"__row"),f=this.input.next(".error_wrapper"),
k=d(a+"_map_icon__row"),g=d(a+"_L0__row"),z=d(a+"_postcode__row");if(h.is(".control-group, .form-row")){b=d(a+"_L1__row");var r=d(a+"_L2__row"),C=d(a+"_L3__row"),t=d(a+"_L4__row"),u=d(a+"_L5__row"),q=d(a+"_address__row"),l=d(a+"_lat__row"),v=d(a+"_lon__row");a=d(a+"_latlon_toggle__row");c?h.hide().after(e).after(k).after(a).after(v).after(l).after(g).after(b).after(r).after(C).after(t).after(u).after(z).after(q).after(f):h.hide().after(e).after(k).after(a).after(v).after(l).after(z).after(q).after(u).after(t).after(C).after(r).after(b).after(g).after(f)}else h.parent().is(".inline-form")?
h.show():(d(a+"__row1").hide(),h.hide().after(f),k.detach(),h.siblings('[id^="'+b+'"][id$="__row"]').last().after(e).after(k));if(f.length)f.one("click"+this.eventNamespace,function(){var a=d(this);a.fadeOut("slow",function(){a.remove()})})},_lxSelectFinal:function(b){b?this._serialize():this._collectData();this._zoomMap()},_lxSelect:function(b,a,c){var e="#"+this.fieldname,h=this.options,m=d(e+"_L"+b),k;a?(m.val(a).trigger("change","implicit"),m.hasClass("multiselect")&&m.multiselect("instance")&&
m.multiselect("refresh")):a=parseInt(m.val(),10);if(0===b){var n=this._readLabels(a),z=g.d,r=["1","2","3","4","5"],l,t,u;n.then(function(a){for(u=0;5>u;u++)k=r[u],l=a[k]||z[k],q=e+"_L"+k,m=d(q),t=h.showLabels?m.hasClass("required")?"<div>"+l+':<span class="req"> *</span></div>':l+":":"",d(q+"__row label").html(t),d(q+"__row1 label").html(t),d(q+' option[value=""]').html(i18n.select+" "+l),m.hasClass("multiselect")&&m.multiselect("instance")&&m.multiselect("refresh")})}n=h.hideLx;for(k=b+1;6>k;k++){var q=
e+"_L"+k;n?(d(q+"__row").hide(),d(q+"__row1").hide()):d(q+" option").remove('[value != ""]');d(q).val("").trigger("change","implicit")}if(a){var p=!1,v=b+1,A=d(e+"_L"+v+"__row");A.length||(p=!0,v++,A=d(e+"_L"+v+"__row"));if(A.length){var w;n=!1;var B=this;if(d(e+"_L"+b+' option[value="'+a+'"]').hasClass("missing")){var x=f[a];x.i=a;var y=[x]}else for(w in y=[],n=!0,f)if(f[w].f==a){n=!1;break}this._readHierarchy(n,a,v,p).then(function(){if(0==y.length)for(w in f)x=f[w],x.f==a&&(x.i=w,y.push(x));var b=
y.length;if(b){y.sort(function(a,b){return a.n.localeCompare(b.n)});var k=e+"_L"+v;var h=d(k),m=d(k+' option[value=""]').html();d(k+" option").remove('[value != ""]');w=null;for(u=0;u<b;u++)x=y[u],w=x.i,k=a==w?' selected="selected"':"",p=x.l==v?"":' class="missing"',k='<option value="'+w+'"'+k+p+">"+x.n+"</option>",h.append(k);A.removeClass("hide").show();d(e+"_L"+v+"__row1").removeClass("hide").show();h.hasClass("multiselect")&&(m={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:m,
multiple:!1},h.hasClass("search")?(h.multiselect(m).multiselectfilter({label:"",placeholder:i18n.search}),d(".ui-multiselect-header").show()):(m.header=!1,h.multiselect(m)));h=B.data["L"+v];m=y.map(function(a){return a.i});h&&-1!=m.indexOf(""+h)?B._lxSelect(v,h,c):1==b&&w&&B._lxSelect(v,w,c)}B._lxSelectFinal(c)})}else this.useGeocoder&&!c&&this._geocodeDecision(),this._lxSelectFinal(c)}else this._lxSelectFinal(c)},_collectData:function(b){var a=this.data,c="#"+this.fieldname,e=this._lookupParent(),
h=d(c+"_address").val(),f=d(c+"_postcode").val();a.address=h;a.postcode=f;if(a.specific)a.id=a.specific,a.parent=e;else{var k=a.lat,g=a.lon,l=a.wkt;h||f||k||g||l?(a.id=null,a.parent=e):(a.id=e,a.parent=null)}this._serialize();d(c+"_lat").val(a.lat).trigger("setvalue");d(c+"_lon").val(a.lon).trigger("setvalue");this.input.data("input",this._hasData());"sub_"==this.fieldname.slice(0,4)&&this.input.trigger("change",b&&"user"||"implicit")},_collectLx:function(){var b=this.data,a="#"+this.fieldname,c;
for(c=0;6>c;c++){var e=d(a+"_L"+c);e.length&&(e=e.val(),b["L"+c]=e?parseInt(e,10):null)}this._serialize()},_hasData:function(){var b=this.data,a=!1;b.specific||b.address||b.postcode||b.lat||b.lon||b.wkt?a=!0:[b.L0,b.L1,b.L2,b.L3,b.L4,b.L5].join("|")!=this.lx&&(a=!0);return a},_lookupParent:function(){this._collectLx();for(var b=this.data,a,c=5;-1<c;c--)if(a=b["L"+c])return a;return(b=f.d)?b.i:null},_readLabels:function(b){b||(b="d");var a=d.Deferred(),c=g[b];if(c==p){var e=S3.Ap.concat("/gis/hdata/"+
b);d.ajaxS3({url:e,dataType:"json",success:function(d){c={};try{for(var e in d)c[e]=d[e];g[b]=c}catch(k){}a.resolve(c)},error:function(b,c,d){(b="UNAUTHORIZED"==d?i18n.gis_requires_login:b.responseText)&&s3_debug(b);a.reject()}})}else a.resolve(c);return a.promise()},_readHierarchy:function(b,a,c,e){var h=d.Deferred();if(b){b="#"+this.fieldname;var m=d(b+"_L"+c),k=!1;m.hide();if(m.hasClass("multiselect")){k=!0;var g=d(b+"_L"+c+"__row button").hide()}var l=d(b+"_L"+c+"__throbber").removeClass("hide").show();
a=e?S3.Ap.concat("/gis/ldata/"+a+"/"+c):S3.Ap.concat("/gis/ldata/"+a);d.ajaxS3({url:a,dataType:"json",success:function(a){for(var b in a)f[b]=a[b];l.hide();k?g.removeClass("hide").show():m.removeClass("hide").show();h.resolve()},error:function(a,b,c){if(a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)s3_debug(a),S3.showAlert(a,"error");l.hide();k?g.removeClass("hide").show():m.removeClass("hide").show();h.reject()}})}else h.resolve();return h.promise()},_geocodeDecision:function(){var b=
"#"+this.fieldname,a=this.data;this._collectData();if(a.address){a=["1","2","3","4","5"];for(var c=0,e;5>c;c++)if(e=d(b+"_L"+a[c]),e.length&&!e.val()&&1<e[0].options.length)return;d(b+"_geocode .geocode_success,"+b+"_geocode .geocode_fail").hide();var f=this;a=this.eventNamespace;this.input.data("manually_geocoded")?d(b+"_geocode button").removeClass("hide").show().unbind(a).bind("click"+a,function(){d(this).hide();f._geocode()}):this._geocode()}},_geocode:function(){var b=this.fieldname,a=this,c=
"#"+b,e=d(c+"_geocode .geocode_fail").hide(),f=d(c+"_geocode .geocode_success").hide(),g=d(c+"_geocode .throbber").removeClass("hide").show(),k=this.data;c={address:k.address};for(var n="postcode L0 L1 L2 L3 L4 L5".split(" "),l=0,r,p;7>l;l++)r=n[l],(p=k[r])&&(c[r]=p);n=S3.Ap.concat("/gis/geocode");d.ajaxS3({url:n,type:"POST",data:c,dataType:"json",success:function(c){var d=c.lat,h=c.lon;if(d||h){k.lat=parseFloat(d);k.lon=parseFloat(h);a._collectData();d=S3.gis;if(d.maps&&(h=d.maps["location_selector_"+
b])){c=h.s3.draftLayer;c.removeAllFeatures();var m=new OpenLayers.Geometry.Point(k.lon,k.lat);m.transform(d.proj4326,h.getProjectionObject());d=new OpenLayers.Feature.Vector(m);c.addFeatures([d]);a._zoomMap()}g.hide();f.html(i18n.address_mapped).removeClass("hide").show()}else g.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(c)},error:function(a,b,c){a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;g.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();
s3_debug(a)}})},_geocodeReverse:function(){var b=this,a="#"+this.fieldname,c=d(a+"_geocode .geocode_fail").hide(),e=d(a+"_geocode .geocode_success").hide(),f=d(a+"_geocode .throbber").removeClass("hide").show();a=this.data;a={lat:a.lat,lon:a.lon};var g=S3.Ap.concat("/gis/geocode_r");d.ajaxS3({async:!1,url:g,type:"POST",data:a,dataType:"json",success:function(a){a.L0?(b.useGeocoder=!1,b._lxSelect(0,a.L0),a.L1&&b._lxSelect(1,a.L1),a.L2&&b._lxSelect(2,a.L2),a.L3&&b._lxSelect(3,a.L3),a.L4&&b._lxSelect(4,
a.L4),a.L5&&b._lxSelect(5,a.L5),b.useGeocoder=!0,f.hide(),e.html(i18n.location_found).removeClass("hide").show()):(f.hide(),c.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,b,d){a="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;f.hide();c.html(i18n.location_not_found).removeClass("hide").show();s3_debug(a)}})},_latlonInput:function(){var b=this.fieldname,a=this.data,c="#"+b,e=d(c+"_lat").val();c=d(c+"_lon").val();e||c?(e=e?parseFloat(e):0,c=c?parseFloat(c):0,
a.lat=e,a.lon=c,a.wkt=null,this.input.data("manually_geocoded",!0)):(a.lat=null,a.lon=null,a.wkt||this.input.data("manually_geocoded",!1));this._serialize();e=S3.gis;e.maps&&(b=e.maps["location_selector_"+b])&&(c=b.s3.draftLayer,c.removeAllFeatures(),null!==a.lat&&null!==a.lon&&(a=new OpenLayers.Geometry.Point(a.lon,a.lat),a.transform(e.proj4326,b.getProjectionObject()),a=new OpenLayers.Feature.Vector(a),c.addFeatures([a]),b.s3.lastDraftFeature=a),this._zoomMap())},_showMap:function(b){var a=this.fieldname,
c=this.eventNamespace,e=this,f="#"+a;d(f+"_map_icon").unbind(c).bind("click"+c,function(){e._hideMap()});d(f+"_map_icon span").html(i18n.hide_map);c=d(f+"_map_wrapper").hide().removeClass("hide").slideDown("medium");c.length&&b&&d("html,body").animate({scrollTop:c.offset().top},250);var g=this.input;d.when(this._jsLoaded()).then(function(){var b=S3.gis,c="location_selector_"+a;var h=b.maps[c]?b.maps[c]:b.show_map(c);e._zoomMap();var m=e.data;c=m.lat;var l=m.lon,t=m.wkt;if(c||l||t)h.s3.draftLayer.removeAllFeatures(),
t!=p&&t?(c={internalProjection:h.getProjectionObject(),externalProjection:b.proj4326},c=(new OpenLayers.Format.WKT(c)).read(t)):(c=new OpenLayers.Geometry.Point(parseFloat(l),parseFloat(c)),c.transform(b.proj4326,h.getProjectionObject()),c=new OpenLayers.Feature.Vector(c)),h.s3.draftLayer.addFeatures([c]),h.s3.lastDraftFeature=c;c=h.controls;l=0;for(var u=c.length;l<u;l++)if("OpenLayers.Control.DrawFeature"==c[l].CLASS_NAME){var q=c[l];break}q&&(h.s3.pointPlaced=function(c){d(f+"_geocode .geocode_fail").hide();
d(f+"_geocode .geocode_success").hide();var k=c.geometry;if("OpenLayers.Geometry.Point"==k.CLASS_NAME)c=k.getBounds().getCenterLonLat(),c.transform(h.getProjectionObject(),b.proj4326),m.wkt=null,m.lat=c.lat,m.lon=c.lon,!m.address&&e.useGeocoder&&e._geocodeReverse();else{k={internalProjection:h.getProjectionObject(),externalProjection:b.proj4326};m.radius=null;var l=new OpenLayers.Geometry.LinearRing(c.geometry.components[0].components);l=new OpenLayers.Geometry.Polygon([l]);if(1E3==l.getVertices().length){var n=
(new OpenLayers.Feature.Vector(l,null)).geometry.getBounds();l=n.right;var p=(n.bottom+n.top)/2;n=new OpenLayers.Geometry.Point((n.left+l)/2,p);l=new OpenLayers.Geometry.Point(l,p);l=new OpenLayers.Geometry.LineString([n,l]);l=parseFloat(l.getLength());m.radius=l}t=(new OpenLayers.Format.WKT(k)).write(c);m.wkt=t;m.lat=null;m.lon=null}g.data("manually_geocoded",!0);e._collectData(!0);e._removeErrors();"sub_"==a.substring(0,4)&&g.parent().find("div.map_wrapper").trigger("change")})},function(a){s3_debug(a)},
function(a){s3_debug(a)})},_hideMap:function(){var b=this.fieldname,a=this.eventNamespace,c="#"+b,e=this;d(c+"_map_icon").unbind(a).bind("click"+a,function(a){e._showMap(a)});d(c+"_map_wrapper").slideUp("medium");a=this.data;if(a.specific)var f=i18n.show_map_view;else if(f=i18n.show_map_add,S3.gis.maps&&(b=S3.gis.maps["location_selector_"+b]))b.s3.draftLayer.removeAllFeatures(),a.lat=null,a.lon=null,a.wkt=null,this.input.data("manually_geocoded",!1),this._collectData();d(c+"_map_icon span").html(f)},
_zoomMap:function(b){var a=this.fieldname,c=S3.gis;if(c.maps&&(a=c.maps["location_selector_"+a])){var d=this.data;c=d.lat;var h=d.lon;d=d.wkt;if(c&&h)c=OpenLayers.Bounds.fromArray([h,c,h,c]);else if(d)c=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(d))).geometry.getBounds();else{b||(b=this._lookupParent()||"d");c=f[b].b;if(!c||!c.length)for(h=f[b].f,b=4;h&&b&&(b--,h=f[h],!(c=h.b)&&0!==h.l);)h=h.f;c&&(c=OpenLayers.Bounds.fromArray(c))}c&&S3.gis.zoomBounds(a,c,this.options.minBBOX)}},_validate:function(){var b=
this.fieldname;this._removeErrors();b="#"+b;var a=this.data,c=this.options.featureRequired;if(c){var e=!1;switch(c){case "latlon":e=a.lat||a.lon;break;case "wkt":e=a.wkt;break;default:e=a.lat||a.lon||a.wkt}if(!e)return S3.fieldError(b+"_map_icon",i18n.map_feature_required),!1}var h=a.id;c="address L5 L4 L3 L2 L1 L0".split(" ");e=function(a){return a.hasClass("multiselect")?a.next("button.ui-multiselect").is(":visible"):a.is(":visible")};if(h){if(!f[h])return!0;var g=f[h].l;for(a=0;a<6-g;a++){h=b+
"_"+c[a];var k=d(h);if(k.length&&k.hasClass("required")&&e(k))return S3.fieldError(h,i18n.enter_value),!1}}else{if(a.lat||a.lon||a.wkt||a.address||a.postcode)return!0;for(a=0;7>a;a++)if(h=b+"_"+c[a],k=d(h),k.length&&k.hasClass("required")&&e(k))return S3.fieldError(h,i18n.enter_value),!1}return!0},_serialize:function(){var b=JSON.stringify(this.data);this.input.val(b);return b},_deserialize:function(){var b=this.input.val();return this.data=JSON.parse(b)},_storeHierarchyData:function(b,a){var c;if(a)for(c in a)f[c]=
a[c];if(b)for(c in b)g[c]=b[c]},_jsLoaded:function(){var b=new jQuery.Deferred;setTimeout(function c(){S3.gis.maps!=p?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(c,500))},1);return b.promise()},_removeErrors:function(b){b||(b="#"+this.fieldname,b=b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon");d(b).siblings(".error").remove()},_bindEvents:function(){var b=this.fieldname,a=this.eventNamespace,c=this,
e="#"+b;d(e+"_L0").bind("change"+a,function(){c._removeErrors(this);c._lxSelect(0)});d(e+"_L1").bind("change"+a,function(){c._removeErrors(this);c._lxSelect(1)});d(e+"_L2").bind("change"+a,function(){c._removeErrors(this);c._lxSelect(2)});d(e+"_L3").bind("change"+a,function(){c._removeErrors(this);c._lxSelect(3)});d(e+"_L4").bind("change"+a,function(){c._removeErrors(this);c._lxSelect(4)});d(e+"_L5").bind("change"+a,function(){c._removeErrors(this);c._lxSelect(5)});d(e+"_address,"+e+"_postcode").bind("change"+
a,function(){c._removeErrors(this);c.useGeocoder?c._geocodeDecision():c._collectData()});d(e+"_lat,"+e+"_lon").bind("change"+a,function(){c._latlonInput()});d(e+"_latlon_toggle").bind("click"+a,function(){var a=d(this).data("mode")||c.options.latlonMode;if("dms"==a){a="decimal";var b=i18n.latlon_mode.dms}else a="dms",b=i18n.latlon_mode.decimal;d(e+"_lat").latloninput("option",{mode:a});d(e+"_lon").latloninput("option",{mode:a});d(this).html(b).data("mode",a)});if("sub_"==b.substring(0,4))this.input.closest(".inline-form").bind("validate"+
a+this.id,function(a){c._validate()||a.preventDefault()});else{var f=this.input.closest("form");f.bind("submit"+a+this.id,function(b){b.preventDefault();c._validate()&&f.unbind(a+c.id).submit()})}return!0},_unbindEvents:function(){var b="#"+this.fieldname,a=this.eventNamespace;d(b+"_L0,"+b+"_L1,"+b+"_L2,"+b+"_L3,"+b+"_L4,"+b+"_L5,"+b+"_address,"+b+"_postcode,"+b+"_map_icon,"+b+"_latlon_toggle").unbind(a);this.input.next(".error_wrapper").unbind(a);this.input.closest("form").unbind(a+this.id);return!0}})})(jQuery);
(function(d,p){var l=0;d.widget("s3.latloninput",{options:{type:"lat",mode:"decimal",labels:{deg:"\u00b0",min:"'",sec:'"'}},_create:function(){this.id=l;l+=1;this.eventNamespace=".latloninput"},_init:function(){d(this.element).hide();this.refresh()},_destroy:function(){d(this.element).show();d.Widget.prototype.destroy.call(this)},_setOption:function(d,g){this._super(d,g);"mode"==d&&this.refresh()},refresh:function(){this._unbindEvents();var f=d(this.element),g=this.options;this.defaultValue=f.val();
if(!this.input){var b=d("<div>").hide().insertAfter(f),a=d('<input type="text" class="dms-input" size="18">').hide();this.decimalInput=a;var c=g.labels,e=d('<input type="text" class="integer dms-input" size="5">'),h=d('<span class="dms-label">'+c.deg+"</span>"),m=d('<input type="text" class="integer dms-input" size="5">'),k=d('<span class="dms-label">'+c.min+"</span>"),l=d('<input type="text" class="double dms-input" size="8">');c=d('<span class="dms-label">'+c.sec+"</span>");this.degInput=e;this.minInput=
m;this.secInput=l;this.dmsInput=e=d("<span>").append(e).append(h).append(m).append(k).append(l).append(c).hide();this.input=b.append(a).append(e).show()}this._removeErrors();"dms"==g.mode?(f=this._getDMS(),this.degInput.val(f.d),this.minInput.val(f.m),this.secInput.val(f.s),this.decimalInput.hide(),this.dmsInput.show()):(this.decimalInput.val(f.val()),this.dmsInput.hide(),this.decimalInput.show());this._bindEvents()},_getDMS:function(){var f=d(this.element).val();if(isNaN(parseFloat(f))||!isFinite(f))return{d:"",
m:"",s:""};var g=Math.abs(f);g=60*(g-parseInt(g,10));if(1E-10>Math.abs(g-Math.round(g))){g=Math.round(g);var b=0}else b=60*(g-parseInt(g,10)),1E-10>Math.abs(b-Math.round(b))&&(b=Math.round(b));return{d:parseInt(f,10),m:parseInt(g,10),s:b}},_showError:function(d,g){"all"==d?this.input.find("input").addClass("invalidinput"):d&&d.addClass("invalidinput");g&&this.input.append('<div class="error">'+g+"</div>")},_removeErrors:function(){this.input.find("input").removeClass("invalidinput");this.input.find(".error").remove()},
_validateDMS:function(){this._removeErrors();if("lat"==this.options.type){var d=90;var g=i18n.latlon_error.lat}else d=180,g=i18n.latlon_error.lon;var b=this.degInput.val(),a=this.minInput.val(),c=this.secInput.val(),e=[];if(""===b&&""===a&&""===c)return"";b=parseInt(b,10)||0;a=parseInt(a,10)||0;c=parseFloat(c)||0;60<=Math.abs(a)&&(this._showError(this.minInput),e.push(i18n.latlon_error.min));60<=Math.abs(c)&&(this._showError(this.secInput),e.push(i18n.latlon_error.sec));a=Math.abs(b)+a/60+c/3600;
if(!e.length&&a>d||b>d)this._showError("all"),e.push(g);return e.length?(this._showError(null,e.join(", ")),null):(0>b?-1:1)*a},_validateDecimal:function(){this._removeErrors();var d=this.options.type,g=i18n.latlon_error.format;if("lat"==d){var b=90;var a=i18n.latlon_error.lat}else b=180,a=i18n.latlon_error.lon;var c=this.decimalInput.val();if(""===c)return"";c=this._parse(c,d);null===c?this._showError(this.decimalInput,g):Math.abs(c)>b&&(this._showError(this.decimalInput,a),c=null);return c},_parse:function(d,
g){var b="lat"==g?{N:1,S:-1}:{E:1,W:-1};var a=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)\s*\u00b0?\s*([NSEW])?\s*$/,c=/^([NSEW]{0,1})\s*([-+]?\d+[.,]?\d*)?\s*([\u00b0'"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*:?\s*([-+]?\d+[.,]?\d*)?\s*(['"]{0,1})\s*([NSEW])?\s*$/,e=g=0,h=0;if(d.match(a))return c=d.replace(a,"$1|$2|$3").split("|"),(d=c[0]||c[2])&&(d=b[d]),g=parseFloat(c[1]),d&&Math.abs(g)!=g&&(d=null),d&&(g*=d),g;if(d.match(c)){c=d.replace(c,"$1|$2|$3|$4|$5|$6|$7|$8").split("|");(d=c[0]||c[7])&&
(d=b[d]);b=[];a=[];var f,k;for(k=1;6>k;k+=2){var l=c[k];(f=c[k+1])?(b.push(parseFloat(l)||0),a.push(f)):l&&(b.push(parseFloat(l)),a.push(null))}if(c=b.length){for(k=1;k<c;k++)b[k]=Math.abs(b[k]);l=b[0];Math.abs(l)!=l&&(d=1);if(1==c)f=a[0],'"'==f?h=b[0]:"'"==f?e=b[0]:f&&"\u00b0"!=f||(g=b[0]);else if(2==c)if(c=a[0],a=a[1],"\u00b0"==c)g=b[0],'"'==a?h=b[1]:"'"!=a&&a||(e=b[1]);else if(c){if("'"!=c||a&&'"'!=a)return null;e=b[0];h=b[1]}else'"'==a?(e=b[0],h=b[1]):"'"!=a&&a||(g=b[0],e=b[1]);else{if(a[0]&&
"\u00b0"!=a[0]||a[1]&&"'"!=a[1]||a[2]&&'"'!=a[2])return null;g=b[0];e=b[1];h=b[2]}g=g+e/60+h/3600;d&&(g*=d);return g}}return null},_bindEvents:function(){var f=this,g=this.eventNamespace;this.dmsInput.find("input").bind("change"+g,function(){var b=f._validateDMS();null!==b?d(f.element).val(b).change():d(f.element).val(f.defaultValue).change()});this.decimalInput.bind("change"+g,function(){var b=f._validateDecimal();null!==b?(d(f.element).val(b).change(),f.decimalInput.val(b)):d(f.element).val(f.defaultValue).change()});
d(this.element).bind("setvalue"+g,function(){f.refresh()});return!0},_unbindEvents:function(){var f=this.eventNamespace;this.input&&this.input.find("input").unbind(f);d(this.element).unbind(f);return!0}})})(jQuery);
