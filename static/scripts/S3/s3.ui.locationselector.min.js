/*
 2014 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
 requires jQuery jstree 3.0.3
*/
(function(d,v){var w=0,t={},u={};d.widget("s3.locationselector",{options:{hideLx:!0,reverseLx:!1,locations:null,labels:null,minBBOX:.05,showLabels:!0},_create:function(){d(this.element);this.id=w;w+=1;this.namespace=".locationselector"},_init:function(){var a=d(this.element),b=this.options,c=a.attr("id");if(!c)throw"Location selector widget: real input field without id";this.fieldname=c;this.input=a;this.data=null;this._storeHierarchyData(b.labels,b.locations);this.refresh()},_destroy:function(){d.Widget.prototype.destroy.call(this)},
refresh:function(){this._unbindEvents();var a=this._deserialize();this._renderWidget();var b="#"+this.fieldname;d(b+"_geocode button").length?this.useGeocoder=!0:this.useGeocoder=!1;var c=d(b+"_L0__row");if(c.length){var f=[],e,g;for(g in t)e=t[g],0===e.l&&(e.i=g,f.push(e));f.sort(function(a,b){return a.n.localeCompare(b.n)});for(var k=d(b+"_L0"),l=0,m=f.length;l<m;l++)e=f[l],g=e.i,e='<option value="'+g+'">'+e.n+"</option>",k.append(e);c.removeClass("hide").show();c=d(b+"_L0__row1");c.length&&c.removeClass("hide").show()}c=
a.L0;f=a.L1;k=a.L2;l=a.L3;m=a.L4;e=a.L5;c&&this._lxSelect(0,c,!0);(f||k)&&this._lxSelect(1,f||k,!0);(k||l)&&this._lxSelect(2,k||l,!0);(l||m)&&this._lxSelect(3,l||m,!0);(m||e)&&this._lxSelect(4,m||e,!0);e&&this._lxSelect(5,e,!0);d(b+"_address").val(a.address);d(b+"_address__row").removeClass("hide").show();d(b+"_address__row1").removeClass("hide").show();d(b+"_postcode").val(a.postcode);d(b+"_postcode__row").removeClass("hide").show();d(b+"_postcode__row1").removeClass("hide").show();d(b+"_map_icon__row").removeClass("hide").show();
a.lat||a.lon||a.wkt?(this.input.data("manually_geocoded",!0),this._showMap()):this._hideMap();this.input.prevAll(".throbber").remove();this._bindEvents()},_renderWidget:function(){var a="#"+this.fieldname,b=this.options.reverseLx,c=d(a+"_map_icon__row .map_wrapper");c.attr("id",this.fieldname+"_map_wrapper");var f=d(a+"__row"),e=this.input.next(".error_wrapper"),g=d(a+"_map_icon__row"),k=d(a+"_L0__row"),l=d(a+"_postcode__row");if(f.is(".control-group, .form-row")){var m=d(a+"_L1__row"),h=d(a+"_L2__row"),
r=d(a+"_L3__row"),p=d(a+"_L4__row"),q=d(a+"_L5__row"),a=d(a+"_address__row");b?f.hide().after(c).after(g).after(k).after(m).after(h).after(r).after(p).after(q).after(l).after(a).after(e):f.hide().after(c).after(g).after(l).after(a).after(q).after(p).after(r).after(h).after(m).after(k).after(e)}else f.parent().is(".inline-form")?f.show():(d(a+"__row1").hide(),f.hide().after(e),b?k.after(c).after(g):l.after(c).after(g));if(e.length)e.one("click"+this.namespace,function(){var a=d(this);a.fadeOut("slow",
function(){a.remove()})})},_lxSelect:function(a,b,c){var f="#"+this.fieldname,e=this.options,g=d(f+"_L"+a);b?(g.val(b),g.hasClass("multiselect")&&g.multiselect("instance")&&g.multiselect("refresh")):b=parseInt(g.val());if(0===a){var k=this._readLabels(b),l=u.d,m=["1","2","3","4","5"],h,r,p,q;for(p=0;5>p;p++)g=m[p],h=k[g]||l[g],q=f+"_L"+g,g=d(q),r=e.showLabels?g.hasClass("required")?"<div>"+h+':<span class="req"> *</span></div>':h+":":"",d(q+"__row label").html(r),d(q+"__row1 label").html(r),d(q+' option[value=""]').html(i18n.select+
" "+h),g.hasClass("multiselect")&&g.multiselect("instance")&&g.multiselect("refresh")}p=e.hideLx;for(g=a+1;6>g;g++)q=f+"_L"+g,p?(d(q+"__row").hide(),d(q+"__row1").hide()):d(q+" option").remove('[value != ""]'),d(q).val("");if(b)if(q=a+1,e=d(f+"_L"+q+"__row"),e.length){var s;if(d(f+"_L"+a+' option[value="'+b+'"]').hasClass("missing"))h=t[b],h.i=b,l=[h];else{p=!0;for(s in t)if(t[s].f==b){p=!1;break}p&&this._readHierarchy(b,q);l=[];for(s in t)h=t[s],h.f==b&&(h.i=s,l.push(h))}if(a=l.length){l.sort(function(a,
b){return a.n.localeCompare(b.n)});s=f+"_L"+q;k=d(s);m=d(s+' option[value=""]').html();d(s+" option").remove('[value != ""]');s=null;for(p=0;p<a;p++)h=l[p],s=h.i,g=b==s?' selected="selected"':"",r=h.l==q?"":' class="missing"',h='<option value="'+s+'"'+g+r+">"+h.n+"</option>",k.append(h);e.removeClass("hide").show();d(f+"_L"+q+"__row1").removeClass("hide").show();k.hasClass("multiselect")&&(b={header:"",height:300,minWidth:0,selectedList:1,noneSelectedText:m,multiple:!1},k.hasClass("search")?(k.multiselect(b).multiselectfilter({label:"",
placeholder:i18n.search}),d(".ui-multiselect-header").show()):(b.header=!1,k.multiselect(b)));1==a&&s&&this._lxSelect(q,s,c)}}else this.useGeocoder&&!c&&this._geocodeDecision();c?this._serialize():this._collectData();this._zoomMap()},_collectData:function(){var a=this.data,b="#"+this.fieldname,c=this._lookupParent(),f=d(b+"_address").val(),b=d(b+"_postcode").val();a.address=f;a.postcode=b;if(a.specific)a.id=a.specific,a.parent=c;else{var e=a.lat,g=a.lon,k=a.wkt;f||b||e||g||k?(a.id=null,a.parent=c):
(a.id=c,a.parent=null)}this._serialize();"sub_"==this.fieldname.slice(0,4)&&this.input.change()},_collectLx:function(){var a=this.data,b="#"+this.fieldname,c,f;for(f=0;6>f;f++)c=d(b+"_L"+f),c.length&&(c=c.val(),a["L"+f]=c?parseInt(c):null);this._serialize()},_lookupParent:function(){this._collectLx();var a=this.data;parent;for(var b=5;-1<b;b--)if(parent=a["L"+b])return parent;return(a=t.d)?a.i:null},_readLabels:function(a){a||(a="d");var b=u[a];if(b==v){var c=S3.Ap.concat("/gis/hdata/"+a);d.ajaxS3({async:!1,
url:c,dataType:"script",success:function(c){b={};try{for(var d in n)b[d]=n[d];u[a]=b;n=null}catch(g){}},error:function(a,b,c){s3_debug("UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText)}})}return b},_readHierarchy:function(a,b){var c="#"+this.fieldname,f=d(c+"_L"+b),e=!1;f.hide();if(f.hasClass("multiselect"))var e=!0,g=d(c+"_L"+b+"__row button").hide();var k=d(c+"_L"+b+"__throbber").removeClass("hide").show(),c=S3.Ap.concat("/gis/ldata/"+a);d.ajaxS3({async:!1,url:c,dataType:"script",success:function(a){for(var b in n)t[b]=
n[b];n=null;k.hide();e?g.removeClass("hide").show():f.removeClass("hide").show()},error:function(a,b,c){a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;s3_debug(a);S3.showAlert(a,"error");k.hide();e?g.removeClass("hide").show():f.removeClass("hide").show()}})},_geocodeDecision:function(){var a="#"+this.fieldname,b=this.data;this._collectData();if(b.address){for(var b=["1","2","3","4","5"],c=0,f;5>c;c++)if(f=d(a+"_L"+b[c]),f.length&&!f.val()&&1<f[0].options.length)return;d(a+"_geocode .geocode_success,"+
a+"_geocode .geocode_fail").hide();var e=this,b=this.namespace;this.input.data("manually_geocoded")?d(a+"_geocode button").removeClass("hide").show().unbind(b).bind("click"+b,function(){d(this).hide();e._geocode()}):this._geocode()}},_geocode:function(){for(var a=this.fieldname,b=this,c="#"+a,f=d(c+"_geocode .geocode_fail").hide(),e=d(c+"_geocode .geocode_success").hide(),g=d(c+"_geocode .throbber").removeClass("hide").show(),k=this.data,c={address:k.address},l="postcode L0 L1 L2 L3 L4 L5".split(" "),
m=0,h,r;7>m;m++)h=l[m],(r=k[h])&&(c[h]=r);l=S3.Ap.concat("/gis/geocode");d.ajaxS3({url:l,type:"POST",data:c,dataType:"json",success:function(c){var d=c.lat,h=c.lon;if(d||h){k.lat=parseFloat(d);k.lon=parseFloat(h);b._serialize();d=S3.gis;if(d.maps&&(h=d.maps["location_selector_"+a])){c=h.s3.draftLayer;c.removeAllFeatures();var l=new OpenLayers.Geometry.Point(k.lon,k.lat);l.transform(d.proj4326,h.getProjectionObject());d=new OpenLayers.Feature.Vector(l);c.addFeatures([d]);b._zoomMap()}g.hide();e.html(i18n.address_mapped).removeClass("hide").show()}else g.hide(),
f.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(c)},error:function(a,b,c){a="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;g.hide();f.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(a)}})},_geocodeReverse:function(){var a=this,b="#"+this.fieldname,c=d(b+"_geocode .geocode_fail").hide(),f=d(b+"_geocode .geocode_success").hide(),e=d(b+"_geocode .throbber").removeClass("hide").show(),b=this.data,b={lat:b.lat,lon:b.lon},g=S3.Ap.concat("/gis/geocode_r");
d.ajaxS3({async:!1,url:g,type:"POST",data:b,dataType:"json",success:function(b){b.L0?(a.useGeocoder=!1,a._lxSelect(0,b.L0),b.L1&&a._lxSelect(1,b.L1),b.L2&&a._lxSelect(2,b.L2),b.L3&&a._lxSelect(3,b.L3),b.L4&&a._lxSelect(4,b.L4),b.L5&&a._lxSelect(5,b.L5),a.useGeocoder=!0,e.hide(),f.html(i18n.location_found).removeClass("hide").show()):(e.hide(),c.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,b,d){a="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;e.hide();c.html(i18n.location_not_found).removeClass("hide").show();
s3_debug(a)}})},_showMap:function(a){var b=this.fieldname,c=this.namespace,f=this,e="#"+b;d(e+"_map_icon").unbind(c).bind("click"+c,function(){f._hideMap()});d(e+"_map_icon span").html(i18n.hide_map);c=d(e+"_map_wrapper").hide().removeClass("hide").slideDown("medium");c.length&&a&&d("html,body").animate({scrollTop:c.offset().top},250);var g=this.input;d.when(this._jsLoaded()).then(function(a){var c=S3.gis;a="location_selector_"+b;var m;m=c.maps[a]?c.maps[a]:c.show_map(a);f._zoomMap();var h=f.data;
a=h.lat;var r=h.lon,p=h.wkt;if(a||r||p)m.s3.draftLayer.removeAllFeatures(),p!=v&&p?(a={internalProjection:m.getProjectionObject(),externalProjection:c.proj4326},a=(new OpenLayers.Format.WKT(a)).read(p)):(a=new OpenLayers.Geometry.Point(parseFloat(r),parseFloat(a)),a.transform(c.proj4326,m.getProjectionObject()),a=new OpenLayers.Feature.Vector(a)),m.s3.draftLayer.addFeatures([a]);a=m.controls;for(var q,r=0,s=a.length;r<s;r++)if("OpenLayers.Control.DrawFeature"==a[r].CLASS_NAME){q=a[r];break}q&&(m.s3.pointPlaced=
function(a){d(e+"_geocode .geocode_fail").hide();d(e+"_geocode .geocode_success").hide();var b=a.geometry;"OpenLayers.Geometry.Point"==b.CLASS_NAME?(a=b.getBounds().getCenterLonLat(),a.transform(m.getProjectionObject(),c.proj4326),h.wkt=null,h.lat=a.lat,h.lon=a.lon,!h.address&&this.useGeocoder&&f._geocodeReverse()):(b={internalProjection:m.getProjectionObject(),externalProjection:c.proj4326},p=(new OpenLayers.Format.WKT(b)).write(a),h.wkt=p,h.lat=null,h.lon=null);g.data("manually_geocoded",!0);f._collectData();
f._removeErrors()})},function(a){s3_debug(a)},function(a){s3_debug(a)})},_hideMap:function(){var a=this.fieldname,b=this.namespace,c="#"+a,f=this;d(c+"_map_icon").unbind(b).bind("click"+b,function(a){f._showMap(a)});d(c+"_map_wrapper").slideUp("medium");var b=this.data,e;if(b.specific)e=i18n.show_map_view;else if(e=i18n.show_map_add,S3.gis.maps&&(a=S3.gis.maps["location_selector_"+a]))a.s3.draftLayer.removeAllFeatures(),b.lat=null,b.lon=null,b.wkt=null,this.input.data("manually_geocoded",!1),this._collectData();
d(c+"_map_icon span").html(e)},_zoomMap:function(a){var b=this.fieldname,c=S3.gis;if(c.maps&&(b=c.maps["location_selector_"+b])){var d=this.data,c=d.lat,e=d.lon,d=d.wkt;if(c&&e)c=[e,c,e,c];else if(d)c=(new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(d))).geometry.getBounds();else if(a||(a=this._lookupParent()||"d"),c=t[a].b,!c||!c.length)for(e=t[a].f,a=4;e&&a&&(a--,e=t[e],!(c=e.b)&&0!==e.l);)e=e.f;c&&(c=OpenLayers.Bounds.fromArray(c),S3.gis.zoomBounds(b,c,this.options.minBBOX))}},_submitForm:function(){var a=
this.fieldname;this._removeErrors();var a="#"+a,b=this.data.id,c="address L5 L4 L3 L2 L1 L0".split(" "),f,e;if(b){if(!t[b])return!0;for(var g=t[b].l,b=0;b<6-g;b++)if(f=a+"_"+c[b],e=d(f),e.length&&e.hasClass("required")&&e.is(":visible"))return S3.fieldError(f,i18n.enter_value),!1}else{b=this.data;if(b.lat||b.lon||b.wkt||b.address||b.postcode)return!0;for(b=0;7>b;b++)if(f=a+"_"+c[b],e=d(f),e.length&&e.hasClass("required")&&e.is(":visible"))return S3.fieldError(f,i18n.enter_value),!1}return!0},_serialize:function(){var a=
JSON.stringify(this.data);this.input.val(a);return a},_deserialize:function(){var a=this.input.val();return this.data=JSON.parse(a)},_storeHierarchyData:function(a,b){var c;if(b)for(c in b)t[c]=b[c];if(a)for(c in a)u[c]=a[c]},_jsLoaded:function(){var a=new jQuery.Deferred;setTimeout(function c(){S3.gis.maps!=v?a.resolve("loaded"):"pending"===a.state()&&(a.notify("waiting for JS to load..."),setTimeout(c,500))},1);return a.promise()},_removeErrors:function(a){a||(a="#"+this.fieldname,a=a+"_L0,"+a+
"_L1,"+a+"_L2,"+a+"_L3,"+a+"_L4,"+a+"_L5,"+a+"_address,"+a+"_postcode");d(a).siblings(".error").remove()},_bindEvents:function(){var a="#"+this.fieldname,b=this.namespace,c=this;d(a+"_L0").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(0)});d(a+"_L1").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(1)});d(a+"_L2").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(2)});d(a+"_L3").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(3)});d(a+"_L4").bind("change"+
b,function(){c._removeErrors(this);c._lxSelect(4)});d(a+"_L5").bind("change"+b,function(){c._removeErrors(this);c._lxSelect(5)});d(a+"_address,"+a+"_postcode").bind("change"+b,function(){c._removeErrors(this);c.useGeocoder?c._geocodeDecision():c._collectData()});this.input.closest("form").bind("submit"+b+this.id,function(a){a.preventDefault();c._submitForm()&&c.input.closest("form").unbind(b+c.id).submit()});return!0},_unbindEvents:function(){var a="#"+this.fieldname,b=this.namespace;d(a+"_L0,"+a+
"_L1,"+a+"_L2,"+a+"_L3,"+a+"_L4,"+a+"_L5,"+a+"_address,"+a+"_postcode,"+a+"_map_icon").unbind(b);this.input.next(".error_wrapper").unbind(b);this.input.closest("form").unbind(b+self.id);return!0}})})(jQuery);
