(function(){S3.gis.locationselector=function(b,a,e,d,f,g,k,q,s,p){var c="#"+b,m=$(c),r=$(c+"__row"),C=m.next(".error_wrapper"),D=$(c+"_L0__row"),E=$(c+"_map_icon__row"),w=$(c+"_map_icon__row .map_wrapper").attr("id",b+"_map_wrapper"),u=r.hasClass("control-group")||r.hasClass("form-row");if(u){var F=$(c+"_L1__row"),B=$(c+"_L2__row"),H=$(c+"_L3__row"),I=$(c+"_L4__row"),N=$(c+"_L5__row"),O=$(c+"_address__row"),P=$(c+"_postcode__row");e?r.hide().after(w).after(E).after(D).after(F).after(B).after(H).after(I).after(N).after(P).after(O).after(C):
r.hide().after(w).after(E).after(P).after(O).after(N).after(I).after(H).after(B).after(F).after(D).after(C)}else $(c+"__row1").hide(),r.hide().after(C),e?D.after(w).after(E):$(c+"_postcode__row").after(w).after(E);p&&m.data("specific",p);m.data("hide_lx",a);a=$(c+"_lat").val();e=$(c+"_lon").val();p=$(c+"_wkt").val();(a||e||p)&&m.data("manually_geocoded",!0);var K=$(c+"_L0");if(D.length){var r=[],y;for(y in l)v=l[y],0==v.l&&(v.i=y,r.push(v));r.sort(Q);y=0;for(C=r.length;y<C;y++)F=r[y],w=F.i,w='<option value="'+
w+'">'+F.n+"</option>",K.append(w);D.removeClass("hide").show();u||$(c+"_L0__row1").removeClass("hide").show()}d&&t(b,0,d);(f||g)&&t(b,1,f||g);(g||k)&&t(b,2,g||k);(k||q)&&t(b,3,k||q);(q||s)&&t(b,4,q||s);s&&t(b,5,s);R(b);E.removeClass("hide").show();a||e||p?L(b):$(c+"_map_icon").click(function(){L(b);return!1});K.change(function(){t(b,0)});var M=$(c+"_L1");M.change(function(){t(b,1)});var J=$(c+"_L2");J.change(function(){t(b,2)});var G=$(c+"_L3");G.change(function(){t(b,3)});var A=$(c+"_L4");A.change(function(){t(b,
4)});var z=$(c+"_L5");z.change(function(){t(b,5)});$(c+"_address,"+c+"_postcode").change(function(){x(b)});m.closest("form").submit(function(){if("sub_"==b.slice(0,4)&&m.parent().parent().is(":hidden"))return $(c+"_L0,"+c+"_L1,"+c+"_L2,"+c+"_L3,"+c+"_L4,"+c+"_L5,"+c+"_address,"+c+"_lat,"+c+"_lon,"+c+"_parent,"+c+"_postcode,"+c+"_wkt").prop("disabled",!0),!0;var a=m.val();if(a){if(!l[a])return!0;switch(l[a].l){case 0:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),
!1;if(z.hasClass("required"))return S3.fieldError(c+"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(c+"_L4",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(c+"_L3",i18n.enter_value),!1;if(J.hasClass("required"))return S3.fieldError(c+"_L2",i18n.enter_value),!1;if(M.hasClass("required"))return S3.fieldError(c+"_L1",i18n.enter_value),!1;a=$("input#"+b+"_L0");a.length&&!a.hasClass("required")&&m.val("");return!0;case 1:if($(c+"_address").hasClass("required"))return S3.fieldError(c+
"_address",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(c+"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(c+"_L4",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(c+"_L3",i18n.enter_value),!1;if(J.hasClass("required"))return S3.fieldError(c+"_L2",i18n.enter_value),!1;a=$("input#"+b+"_L1");a.length&&!a.hasClass("required")&&m.val("");return!0;case 2:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),
!1;if(z.hasClass("required"))return S3.fieldError(c+"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(c+"_L4",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(c+"_L3",i18n.enter_value),!1;a=$("input#"+b+"_L2");a.length&&!a.hasClass("required")&&m.val("");return!0;case 3:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(c+"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(c+
"_L4",i18n.enter_value),!1;a=$("input#"+b+"_L3");a.length&&!a.hasClass("required")&&m.val("");return!0;case 4:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),!1;if(z.hasClass("required"))return S3.fieldError(c+"_L5",i18n.enter_value),!1;a=$("input#"+b+"_L4");a.length&&!a.hasClass("required")&&m.val("");return!0;case 5:if($(c+"_address").hasClass("required"))return S3.fieldError(c+"_address",i18n.enter_value),!1;a=$("input#"+b+"_L5");a.length&&!a.hasClass("required")&&
m.val("");return!0;default:return S3.showAlert("LocationSelector cannot validate!","error"),!1}}else return $(c+"_address").hasClass("required")?(S3.fieldError(c+"_address",i18n.enter_value),!1):z.hasClass("required")?(S3.fieldError(c+"_L5",i18n.enter_value),!1):A.hasClass("required")?(S3.fieldError(c+"_L4",i18n.enter_value),!1):G.hasClass("required")?(S3.fieldError(c+"_L3",i18n.enter_value),!1):J.hasClass("required")?(S3.fieldError(c+"_L2",i18n.enter_value),!1):M.hasClass("required")?(S3.fieldError(c+
"_L1",i18n.enter_value),!1):K.hasClass("required")?(S3.fieldError(c+"_L0",i18n.enter_value),!1):!0})};var t=function(b,a,e){var d="#"+b,f=$(d).data("hide_lx");if(e){var g=$(d+"_L"+a);g.val(e);g.hasClass("multiselect")&&g.multiselect("refresh")}else e=parseInt($(d+"_L"+a).val());if(0===a){var k=h[e];if(void 0==k){var q=S3.Ap.concat("/gis/hdata/"+e);$.ajaxS3({async:!1,url:q,dataType:"script",success:function(a){k={};try{for(var b in n)k[b]=n[b];h[e]=k;n=null}catch(c){}},error:function(a,b,c){msg="UNAUTHORIZED"==
c?i18n.gis_requires_login:a.responseText;s3_debug(msg)}})}for(var s=h.d,p,c=["1","2","3","4","5"],m,q=0;5>q;q++)g=c[q],p=k[g]||s[g],m=d+"_L"+g,$(m).hasClass("required")?($(m+"__row label").html("<div>"+p+':<span class="req"> *</span></div>'),$(m+"__row1 label").html("<div>"+p+':<span class="req"> *</span></div>')):($(m+"__row label").html(p+":"),$(m+"__row1 label").html(p+":")),$(m+' option[value=""]').html(i18n.select+" "+p)}if(e){for(g=a+1;6>g;g++)m=d+"_L"+g,f?($(m+"__row").hide(),$(m+"__row1").hide()):
$(m+" option").remove('[value != ""]'),$(m).val("");x(b);a+=1;g=$(d+"_L"+a+"__row");if(g.length){if($(d+"_L"+(a-1)+' option[value="'+e+'"]').hasClass("missing"))s=l[e],s.i=e,f=[s];else{f=!0;for(q in l)if(l[q].f==e){f=!1;break}f&&S(b,a,e);f=[];for(q in l)s=l[q],s.f==e&&(s.i=q,f.push(s))}if(s=f.length){g.removeClass("hide").show();$(d+"_L"+a+"__row1").removeClass("hide").show();f.sort(Q);var r,g=$(d+"_L"+a);$(d+"_L"+a+" option").remove('[value != ""]');for(q=0;q<s;q++)p=f[q],r=p.i,m=e==r?' selected="selected"':
"",c=l[r].l==a?"":' class="missing"',p='<option value="'+r+'"'+m+c+">"+p.n+"</option>",g.append(p);g.hasClass("multiselect")&&g.multiselect({header:!1,height:300,minWidth:0,selectedList:3,noneSelectedText:$(d+"_L"+a+' option[value=""]').html(),multiple:!1});if(1==s){t(b,a,r);return}}}else $(d+"_geocode button").length&&H(b)}else for(x(b),g=a+1;6>g;g++)m=d+"_L"+g,f?($(m+"__row").hide(),$(m+"__row1").hide()):$(m+" option").remove('[value != ""]'),$(m).val("");B(b)},Q=function(b,a){b=b.n;var e=[b,a.n];
e.sort();return e[0]==b?-1:1},S=function(b,a,e){b="#"+b;var d=$(b+"_L"+a);d.hide();var f=$(b+"_L"+a+"__throbber");f.removeClass("hide").show();a=S3.Ap.concat("/gis/ldata/"+e);$.ajaxS3({async:!1,url:a,dataType:"script",success:function(a){for(var b in n)l[b]=n[b];n=null;f.hide();d.removeClass("hide").show()},error:function(a,b,e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:a.responseText;s3_debug(msg);S3.showAlert(msg,"error");f.hide();d.removeClass("hide").show()}})},u=function(b){b="#"+b+"_L";
for(var a,e=5;-1<e;e--)if(a=$(b+e).val())return a;return l.d.id},x=function(b){var a="#"+b,e=$(a+"_parent"),d=$(a);if(d.data("specific")){var f=u(b);e.val(f)}else{var f=$(a+"_address").val(),g=$(a+"_postcode").val(),k=$(a+"_lat").val(),q=$(a+"_lon").val(),a=$(a+"_wkt").val();f||g||k||q||a?(d.val("dummy"),f=u(b),e.val(f)):(f=u(b),d.val(f),e.val(""));"sub_"==b.slice(0,4)&&d.change()}},R=function(b){var a="#"+b;$(a+"_address__row").removeClass("hide").show();$(a+"_address__row1").removeClass("hide").show();
$(a+"_postcode__row").removeClass("hide").show();$(a+"_postcode__row1").removeClass("hide").show();$(a+"_geocode button").length&&$(a+"_address,"+a+"_postcode").change(function(){H(b)})},H=function(b){var a="#"+b;if($(a+"_address").val()){var e,d,f=["1","2","3","4","5"];for(e=0;5>e;e++)if(d=f[e],d=$(a+"_L"+d),d.length&&!d.val()&&1<d[0].options.length)return;$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),$(a+"_geocode button").removeClass("hide").show().click(function(){$(this).hide();
I(b);x(b)})):I(b);x(b)}},I=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),d=$(a+"_geocode .geocode_success");e.hide();d.hide();var f=$(a+"_geocode .throbber");f.removeClass("hide").show();var g={address:$(a+"_address").val()},k=$(a+"_postcode").val();k&&(g.postcode=k);if(k=$(a+"_L0").val())g.L0=k;if(k=$(a+"_L1").val())g.L1=k;if(k=$(a+"_L2").val())g.L2=k;if(k=$(a+"_L3").val())g.L3=k;if(k=$(a+"_L4").val())g.L4=k;if(k=$(a+"_L5").val())g.L5=k;k=S3.Ap.concat("/gis/geocode");$.ajaxS3({url:k,type:"POST",
data:g,dataType:"json",success:function(g){var k=g.lat,p=g.lon;if(k||p){$(a+"_lat").val(k);$(a+"_lon").val(p);gis=S3.gis;if(gis.maps){var c=gis.maps["location_selector_"+b];c&&(g=c.s3.draftLayer,g.removeAllFeatures(),k=new OpenLayers.Geometry.Point(parseFloat(p),parseFloat(k)),k.transform(gis.proj4326,c.getProjectionObject()),k=new OpenLayers.Feature.Vector(k),g.addFeatures([k]),B(b))}f.hide();d.html(i18n.address_mapped).removeClass("hide").show()}else f.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),
s3_debug(g)},error:function(a,b,g){msg="UNAUTHORIZED"==g?i18n.gis_requires_login:a.responseText;f.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(msg)}})},T=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),d=$(a+"_geocode .geocode_success");e.hide();d.hide();var f=$(a+"_geocode .throbber");f.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajaxS3({async:!1,url:b,type:"POST",data:post_data,dataType:"json",
success:function(b){b.L0?($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),$(a+"_L2").val(b.L2)),b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),f.hide(),d.html(i18n.location_found).removeClass("hide").show()):(f.hide(),e.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,
b,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;f.hide();e.html(i18n.location_not_found).removeClass("hide").show();s3_debug(msg)}})},U=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){L(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");$(a+"_wkt").val("");$(a+"_map_icon span").html(i18n.show_map);x(b)},V=function(){var b=new jQuery.Deferred;setTimeout(function e(){void 0!=
S3.gis.maps?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(e,500))},1);return b.promise()},L=function(b,a){var e="#"+b;$(e+"_map_icon").unbind("click").click(function(){U(b)});var d=$(e+"_map_icon span");i18n.show_map=d.html();d.html(i18n.hide_map);d=$(e+"_map_wrapper");d.removeClass("hide").show();$("html,body").animate({scrollTop:d.offset().top},250);$.when(V()).then(function(a){a="location_selector_"+b;var d=S3.gis;if(!d.maps[a]){var k=d.show_map(a),
q=$(e);$(e+"_parent");B(b);var s=$(e+"_lat"),p=$(e+"_lon"),c=$(e+"_wkt");a=s.val();var m=p.val(),r=c.val();if(a||m||r)void 0!=r&&r?(a={internalProjection:k.getProjectionObject(),externalProjection:d.proj4326},a=(new OpenLayers.Format.WKT(a)).read(r)):(a=new OpenLayers.Geometry.Point(parseFloat(m),parseFloat(a)),a.transform(d.proj4326,k.getProjectionObject()),a=new OpenLayers.Feature.Vector(a)),k.s3.draftLayer.addFeatures([a]),x(b);var t;a=k.controls;for(var m=0,u=a.length;m<u;m++)if("OpenLayers.Control.DrawFeature"==
a[m].CLASS_NAME){t=a[m];break}t&&(k.s3.pointPlaced=function(a){$(e+"_geocode .geocode_fail").hide();$(e+"_geocode .geocode_success").hide();var f=a.geometry;"OpenLayers.Geometry.Point"==f.CLASS_NAME?(a=f.getBounds().getCenterLonLat(),a.transform(k.getProjectionObject(),d.proj4326),c.val(""),s.val(a.lat),p.val(a.lon),q.data("manually_geocoded",!0),T(b)):(f={internalProjection:k.getProjectionObject(),externalProjection:d.proj4326},r=(new OpenLayers.Format.WKT(f)).write(a),c.val(r),s.val(""),p.val(""),
q.data("manually_geocoded",!0));x(b)})}},function(a){s3_debug(a)},function(a){s3_debug(a)})},B=function(b,a){var e=S3.gis;if(e.maps&&(e=e.maps["location_selector_"+b])){var d="#"+b,f=$(d+"_lat").val(),d=$(d+"_lon").val();if(f&&d)f=[d-.032,f-.032,d+.032,f+.032];else if(a||(a=u(b)||"d"),f=l[a].b,!f&&(d=l[a].f,d=l[d]))if(f=d.b,!f&&(d=d.f,d=l[d]))if(f=d.b,!f&&(d=d.f,d=l[d]))f=d.b;f&&(f=OpenLayers.Bounds.fromArray(f),S3.gis.zoomBounds(e,f))}}})();
