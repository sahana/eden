(function(){S3.gis.locationselector=function(b,a,e,c,f,m,g,s,q,p){var d="#"+b,k=$(d),r=$(d+"__row"),C=k.next(".error_wrapper"),D=$(d+"_L0__row"),E=$(d+"_map_icon__row"),w=$(d+"_map_icon__row .map_wrapper").attr("id",b+"_map_wrapper"),u=r.hasClass("control-group")||r.hasClass("form-row");if(u){var F=$(d+"_L1__row"),z=$(d+"_L2__row"),B=$(d+"_L3__row"),H=$(d+"_L4__row"),I=$(d+"_L5__row"),N=$(d+"_address__row"),O=$(d+"_postcode__row");e?r.hide().after(w).after(E).after(D).after(F).after(z).after(B).after(H).after(I).after(O).after(N).after(C):
r.hide().after(w).after(E).after(O).after(N).after(I).after(H).after(B).after(z).after(F).after(D).after(C)}else $(d+"__row1").hide(),r.hide().after(C),e?D.after(w).after(E):$(d+"_postcode__row").after(w).after(E);p&&k.data("specific",p);k.data("hide_lx",a);a=$(d+"_lat").val();e=$(d+"_lon").val();p=$(d+"_wkt").val();(a||e||p)&&k.data("manually_geocoded",!0);var K=$(d+"_L0");if(D.length){var r=[],x;for(x in l)v=l[x],0==v.l&&(v.i=x,r.push(v));r.sort(P);x=0;for(C=r.length;x<C;x++)F=r[x],w=F.i,w='<option value="'+
w+'">'+F.n+"</option>",K.append(w);D.removeClass("hide").show();u||$(d+"_L0__row1").removeClass("hide").show()}c&&t(b,0,c);f&&t(b,1,f);m&&t(b,2,m);g&&t(b,3,g);s&&t(b,4,s);q&&t(b,5,q);Q(b);E.removeClass("hide").show();a||e||p?L(b):$(d+"_map_icon").click(function(){L(b);return!1});K.change(function(){t(b,0)});var M=$(d+"_L1");M.change(function(){t(b,1)});var J=$(d+"_L2");J.change(function(){t(b,2)});var G=$(d+"_L3");G.change(function(){t(b,3)});var A=$(d+"_L4");A.change(function(){t(b,4)});var y=$(d+
"_L5");y.change(function(){t(b,5)});k.closest("form").submit(function(){var a=k.val();if(a){if(!l[a])return!0;switch(l[a].l){case 0:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;if(y.hasClass("required"))return S3.fieldError(d+"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(d+"_L4",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(d+"_L3",i18n.enter_value),!1;if(J.hasClass("required"))return S3.fieldError(d+
"_L2",i18n.enter_value),!1;if(M.hasClass("required"))return S3.fieldError(d+"_L1",i18n.enter_value),!1;a=$("input#"+b+"_L0");a.length&&!a.hasClass("required")&&k.val("");return!0;case 1:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;if(y.hasClass("required"))return S3.fieldError(d+"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(d+"_L4",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(d+"_L3",i18n.enter_value),
!1;if(J.hasClass("required"))return S3.fieldError(d+"_L2",i18n.enter_value),!1;a=$("input#"+b+"_L1");a.length&&!a.hasClass("required")&&k.val("");return!0;case 2:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;if(y.hasClass("required"))return S3.fieldError(d+"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(d+"_L4",i18n.enter_value),!1;if(G.hasClass("required"))return S3.fieldError(d+"_L3",i18n.enter_value),!1;a=$("input#"+b+"_L2");
a.length&&!a.hasClass("required")&&k.val("");return!0;case 3:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;if(y.hasClass("required"))return S3.fieldError(d+"_L5",i18n.enter_value),!1;if(A.hasClass("required"))return S3.fieldError(d+"_L4",i18n.enter_value),!1;a=$("input#"+b+"_L3");a.length&&!a.hasClass("required")&&k.val("");return!0;case 4:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;if(y.hasClass("required"))return S3.fieldError(d+
"_L5",i18n.enter_value),!1;a=$("input#"+b+"_L4");a.length&&!a.hasClass("required")&&k.val("");return!0;case 5:if($(d+"_address").hasClass("required"))return S3.fieldError(d+"_address",i18n.enter_value),!1;a=$("input#"+b+"_L5");a.length&&!a.hasClass("required")&&k.val("");return!0;default:return S3.showAlert("LocationSelector cannot validate!","error"),!1}}else return $(d+"_address").hasClass("required")?(S3.fieldError(d+"_address",i18n.enter_value),!1):y.hasClass("required")?(S3.fieldError(d+"_L5",
i18n.enter_value),!1):A.hasClass("required")?(S3.fieldError(d+"_L4",i18n.enter_value),!1):G.hasClass("required")?(S3.fieldError(d+"_L3",i18n.enter_value),!1):J.hasClass("required")?(S3.fieldError(d+"_L2",i18n.enter_value),!1):M.hasClass("required")?(S3.fieldError(d+"_L1",i18n.enter_value),!1):K.hasClass("required")?(S3.fieldError(d+"_L0",i18n.enter_value),!1):!0})};var t=function(b,a,e){var c="#"+b,f=$(c).data("hide_lx");e?$(c+"_L"+a).val(e):e=parseInt($(c+"_L"+a).val());if(0===a){var m=h[e];if(void 0==
m){var g=S3.Ap.concat("/gis/hdata/"+e);$.ajaxS3({async:!1,url:g,dataType:"script",success:function(a){m={};try{for(var b in n)m[b]=n[b];h[e]=m;n=null}catch(c){}},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;s3_debug(msg)}})}for(var s=h.d,q,p,d=["1","2","3","4","5"],k,g=0;5>g;g++)q=d[g],p=m[q]||s[q],k=c+"_L"+q,$(k).hasClass("required")?($(k+"__row label").html("<div>"+p+':<span class="req"> *</span></div>'),$(k+"__row1 label").html("<div>"+p+':<span class="req"> *</span></div>')):
($(k+"__row label").html(p+":"),$(k+"__row1 label").html(p+":")),$(k+' option[value=""]').html(i18n.select+" "+p)}if(e){for(q=a+1;6>q;q++)k=c+"_L"+q,f?($(k+"__row").hide(),$(k+"__row1").hide()):$(k+" option").remove('[value != ""]'),$(k).val("");u(b);a+=1;f=$(c+"_L"+a+"__row");if(f.length){f.removeClass("hide").show();$(c+"_L"+a+"__row1").removeClass("hide").show();f=!0;for(g in l)if(l[g].f==e){f=!1;break}f&&R(b,a,e);f=[];for(g in l)s=l[g],s.l==a&&s.f==e&&(s.i=g,f.push(s));f.sort(P);var s=f.length,
r;q=$(c+"_L"+a);$(c+"_L"+a+" option").remove('[value != ""]');for(g=0;g<s;g++)c=f[g],r=c.i,p=e==r?' selected="selected"':"",c='<option value="'+r+'"'+p+">"+c.n+"</option>",q.append(c);if(1==s){t(b,a,r);return}}else $(c+"_geocode button").length&&H(b)}else for(u(b),q=a+1;6>q;q++)k=c+"_L"+q,f?($(k+"__row").hide(),$(k+"__row1").hide()):$(k+" option").remove('[value != ""]'),$(k).val("");B(b)},P=function(b,a){b=b.n;var e=[b,a.n];e.sort();return e[0]==b?-1:1},R=function(b,a,e){b="#"+b;var c=$(b+"_L"+a);
c.hide();var f=$(b+"_L"+a+"__throbber");f.removeClass("hide").show();a=S3.Ap.concat("/gis/ldata/"+e);$.ajaxS3({async:!1,url:a,dataType:"script",success:function(a){for(var b in n)l[b]=n[b];n=null;f.hide();c.removeClass("hide").show()},error:function(a,b,e){msg="UNAUTHORIZED"==e?i18n.gis_requires_login:a.responseText;s3_debug(msg);S3.showAlert(msg,"error");f.hide();c.removeClass("hide").show()}})},z=function(b){b="#"+b+"_L";for(var a,e=5;-1<e;e--)if(a=$(b+e).val())return a;return l.d.id},u=function(b){var a=
"#"+b,e=$(a+"_parent"),c=$(a);if(c.data("specific"))c=z(b),e.val(c);else{var f=$(a+"_address").val(),m=$(a+"_postcode").val(),g=$(a+"_lat").val(),s=$(a+"_lon").val(),a=$(a+"_wkt").val();f||m||g||s||a?(c.val("dummy"),c=z(b),e.val(c)):(b=z(b),c.val(b),e.val(""))}},Q=function(b){var a="#"+b;$(a+"_address__row").removeClass("hide").show();$(a+"_address__row1").removeClass("hide").show();$(a+"_postcode__row").removeClass("hide").show();$(a+"_postcode__row1").removeClass("hide").show();$(a+"_geocode button").length&&
$(a+"_address,"+a+"_postcode").change(function(){H(b)})},H=function(b){var a="#"+b;if($(a+"_address").val()){var e,c,f=["1","2","3","4","5"];for(e=0;5>e;e++)if(c=f[e],c=$(a+"_L"+c),c.length&&!c.val())return;$(a).data("manually_geocoded")?($(a+"_geocode .geocode_success").hide(),$(a+"_geocode .geocode_fail").hide(),$(a+"_geocode button").removeClass("hide").show().click(function(){$(this).hide();I(b);u(b)})):I(b);u(b)}},I=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");
e.hide();c.hide();var f=$(a+"_geocode .throbber");f.removeClass("hide").show();var m={address:$(a+"_address").val()},g=$(a+"_postcode").val();g&&(m.postcode=g);if(g=$(a+"_L0").val())m.L0=g;if(g=$(a+"_L1").val())m.L1=g;if(g=$(a+"_L2").val())m.L2=g;if(g=$(a+"_L3").val())m.L3=g;if(g=$(a+"_L4").val())m.L4=g;if(g=$(a+"_L5").val())m.L5=g;g=S3.Ap.concat("/gis/geocode");$.ajaxS3({url:g,type:"POST",data:m,dataType:"json",success:function(m){var g=m.lat,p=m.lon;if(g||p){$(a+"_lat").val(g);$(a+"_lon").val(p);
gis=S3.gis;if(gis.maps){var d=gis.maps["location_selector_"+b];d&&(m=d.s3.draftLayer,m.removeAllFeatures(),g=new OpenLayers.Geometry.Point(parseFloat(p),parseFloat(g)),g.transform(gis.proj4326,d.getProjectionObject()),g=new OpenLayers.Feature.Vector(g),m.addFeatures([g]),B(b))}f.hide();c.html(i18n.address_mapped).removeClass("hide").show()}else f.hide(),e.html(i18n.address_not_mapped).removeClass("hide").show(),s3_debug(m)},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;
f.hide();e.html(i18n.address_not_mapped).removeClass("hide").show();s3_debug(msg)}})},S=function(b){var a="#"+b,e=$(a+"_geocode .geocode_fail"),c=$(a+"_geocode .geocode_success");e.hide();c.hide();var f=$(a+"_geocode .throbber");f.removeClass("hide").show();post_data={lat:$(a+"_lat").val(),lon:$(a+"_lon").val()};b=S3.Ap.concat("/gis/geocode_r");$.ajaxS3({async:!1,url:b,type:"POST",data:post_data,dataType:"json",success:function(b){b.L0?($(a+"_L0_input").val(b.L0),$(a+"_L0").val(b.L0),b.L1&&($(a+"_L1_input").val(b.L1),
$(a+"_L1").val(b.L1)),b.L2&&($(a+"_L2_input").val(b.L2),$(a+"_L2").val(b.L2)),b.L3&&($(a+"_L3_input").val(b.L3),$(a+"_L3").val(b.L3)),b.L4&&($(a+"_L4_input").val(b.L4),$(a+"_L4").val(b.L4)),b.L5&&($(a+"_L5_input").val(b.L5),$(a+"_L5").val(b.L5)),f.hide(),c.html(i18n.location_found).removeClass("hide").show()):(f.hide(),e.html(i18n.location_not_found).removeClass("hide").show())},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;f.hide();e.html(i18n.location_not_found).removeClass("hide").show();
s3_debug(msg)}})},T=function(b){var a="#"+b;$(a+"_map_icon").unbind("click").click(function(){L(b)});$(a+"_map_wrapper").hide();S3.gis.maps["location_selector_"+b].s3.draftLayer.removeAllFeatures();$(a+"_lat").val("");$(a+"_lon").val("");u(b)},U=function(){var b=new jQuery.Deferred;setTimeout(function e(){void 0!=S3.gis.maps?b.resolve("loaded"):"pending"===b.state()&&(b.notify("waiting for JS to load..."),setTimeout(e,500))},1);return b.promise()},L=function(b,a){var e="#"+b;$(e+"_map_icon").unbind("click").click(function(){T(b)});
$(e+"_map_wrapper").removeClass("hide").show();$.when(U()).then(function(a){a="location_selector_"+b;var f=S3.gis;if(!f.maps[a]){var m=f.show_map(a),g=$(e);$(e+"_parent");B(b);var s=$(e+"_lat"),q=$(e+"_lon"),p=$(e+"_wkt");a=s.val();var d=q.val(),k=p.val();if(a||d||k)void 0!=k?(a={internalProjection:m.getProjectionObject(),externalProjection:f.proj4326},a=(new OpenLayers.Format.WKT(a)).read(k)):(a=new OpenLayers.Geometry.Point(parseFloat(d),parseFloat(a)),a.transform(f.proj4326,m.getProjectionObject()),
a=new OpenLayers.Feature.Vector(a)),m.s3.draftLayer.addFeatures([a]),u(b);var r;a=m.controls;for(var d=0,t=a.length;d<t;d++)if("OpenLayers.Control.DrawFeature"==a[d].CLASS_NAME){r=a[d];break}r&&(m.s3.pointPlaced=function(a){$(e+"_geocode .geocode_fail").hide();$(e+"_geocode .geocode_success").hide();var c=a.geometry;"OpenLayers.Geometry.Point"==c.CLASS_NAME?(a=c.getBounds().getCenterLonLat(),a.transform(m.getProjectionObject(),f.proj4326),s.val(a.lat),q.val(a.lon),g.data("manually_geocoded",!0),S(b)):
(c={internalProjection:m.getProjectionObject(),externalProjection:f.proj4326},k=(new OpenLayers.Format.WKT(c)).write(a),p.val(k));u(b)})}},function(a){s3_debug(a)},function(a){s3_debug(a)})},B=function(b,a){var e=S3.gis;if(e.maps&&(e=e.maps["location_selector_"+b])){var c="#"+b,f=$(c+"_lat").val(),c=$(c+"_lon").val();if(f&&c)f=[c-0.032,f-0.032,c+0.032,f+0.032];else if(a||(a=z(b)||"d"),f=l[a].b,!f&&(c=l[a].f,c=l[c]))if(f=c.b,!f&&(c=c.f,c=l[c]))if(f=c.b,!f&&(c=c.f,c=l[c]))f=c.b;f&&(f=OpenLayers.Bounds.fromArray(f),
S3.gis.zoomBounds(e,f))}}})();
