(function(m){m(window.jQuery,window._,window.ol)})(function(m,z,h){var D=0;m.widget("s3.showMap",{options:{id:"default_map",i18n:{loading:"Loading",requires_login:"Requires Login"},lat:0,lon:0,zoom:0,layers_osm:[]},_create:function(){this.id=D;D+=1;this.eventNamespace=".s3Map";this.proxyHost=S3.Ap.concat("/gis/proxy?url=")},_init:function(b){this.refresh()},_destroy:function(){m.Widget.prototype.destroy.call(this)},refresh:function(){var b=this.options,a=this.addLayers();this.map=b=new h.Map({layers:a,
target:b.id,view:new h.View({center:h.proj.fromLonLat([b.lon,b.lat]),zoom:b.zoom})});this.tooltip=a=m("#"+this.options.id+" .s3-gis-tooltip");a=new h.Overlay({element:a[0],positioning:"bottom-center",stopEvent:!1,offset:[0,-15]});b.addOverlay(a);this.tooltip_ol=a;this._bindEvents(b)},addLayers:function(){var b=[];this.addLayersOSM(b);this.addLayersGeoJSON(b);return b},addLayersOSM:function(b){for(var a,d,k=this.options.layers_osm||[],l,f,g=0;g<k.length;g++)d=k[g],a=void 0!=d.attribution?[d.attribution]:
[h.source.OSM.ATTRIBUTION],l=void 0!=d.maxZoom?d.maxZoom:19,f=void 0!=d.base?d.base:!0,d=void 0!=d.url?d.url:"https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png",a={attributions:a,maxZoom:l,opaque:f,url:d},b.push(new h.layer.Tile({source:new h.source.OSM(a)}))},addLayersGeoJSON:function(b){var a=this.options,d=a.layers_feature||[],k=a.layers_geojson||[];var l=a.layers_georss||[];var f=a.layers_shapefile||[];var g=a.layers_theme||[];d=(a.feature_queries||[]).concat(a.feature_resources||[]).concat(d).concat(k).concat(l).concat(f).concat(g);
for(k=0;k<d.length;k++)a=d[k],f=void 0!=a.projection?new h.format.GeoJSON({dataProjection:"EPSG:"+a.projection}):new h.format.GeoJSON({dataProjection:"EPSG:4326"}),l=this.layerStyle(a),g=a.url,f=new h.source.Vector({url:g,format:f}),f=new h.layer.Vector({source:f,style:l}),void 0!=a.dir&&(f.dir=a.dir),void 0!=a.popup_format&&(f.s3_popup_format=a.popup_format),l=void 0!=a.type?a.type:"feature",f.s3_layer_type=l,void 0!=a.visibility&&f.setVisible(a.visibility),b.push(f)},layerStyle:function(b){if(void 0!==
b.marker)b=new h.style.Style({image:new h.style.Icon({src:S3.Ap.concat("/static/img/markers/"+b.marker.i)})});else if(void 0!==b.marker)b=b.style;else{b=new h.style.Fill({color:"rgba(255,255,255,0.4)"});var a=new h.style.Stroke({color:"#3399CC",width:1.25}),d=new h.style.Icon({src:S3.Ap.concat("/static/img/markers/"+this.options.marker)}),k={Point:new h.style.Style({image:d}),LineString:new h.style.Style({stroke:a}),MultiLineString:new h.style.Style({stroke:a}),MultiPoint:new h.style.Style({image:d}),
MultiPolygon:new h.style.Style({stroke:a,fill:b}),Polygon:new h.style.Style({stroke:a,fill:b}),GeometryCollection:new h.style.Style({stroke:a,fill:b,image:d}),Circle:new h.style.Style({stroke:a,fill:b})};b=function(l){return k[l.getGeometry().getType()]}}return b},addPopup:function(b,a,d,k,l){var f=this.map;a=this.id+"_"+a.ol_uid+"_"+b.get("id")+"_popup";l&&d?(0===d.indexOf("http://")&&(d=this.proxyHost+encodeURIComponent(d)),k='<iframe src="'+d+'" onload="S3.gis.popupLoaded(\''+a+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>'):
void 0==k&&(k=this.options.i18n.loading+'...<div class="throbber"></div>');m("#"+this.options.id).append('<div id="'+a+'" class="s3-gis-popup"><div class="s3-gis-popup-close"></div><div class="s3-gis-popup-content"></div></div>');var g=m("#"+a),v=new h.Overlay({element:g[0],positioning:"bottom-center",offset:[0,-12]});f.addOverlay(v);b=b.getGeometry().getCoordinates();v.setPosition(b);m("#"+a+" .s3-gis-popup-content").html(k);g.show();m("#"+a+" .s3-gis-popup-close").on("click",{id:a,map:f,overlay:v},
this.removePopup);l||void 0==d||this._loadDetails(d,a,g)},removePopup:function(b){b.data.map.removeOverlay(b.data.overlay);m("#"+b.data.id).remove();b.preventDefault()},_loadDetails:function(b,a,d){var k=this;0===b.indexOf("http://")&&(b=this.proxyHost+encodeURIComponent(b));m.ajaxS3({url:b,dataType:"html",success:function(l){try{m("#"+a+" .s3-gis-popup-content").html(l),m("#"+a+" a.btn.iframe").click(function(){var f=m(this).attr("href");0===f.indexOf("http://")&&(f=k.proxyHost+encodeURIComponent(f));
f='<iframe src="'+f+'" onload="S3.gis.popupLoaded(\''+a+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>';m("#"+a+" .s3-gis-popup-content").html(f);return!1})}catch(f){}},error:function(l,f,g){msg="UNAUTHORIZED"==g?k.options.i18n.requires_login:l.responseText;m("#"+a+" .s3-gis-popup-content").html(msg)}})},_deserialize:function(){},_bindEvents:function(b){var a=this,d,k,l,f,g,v,B,n,C,x,E;b.on("pointermove",function(c){if(c.dragging)a.tooltip.hide();else if(x=b.forEachFeatureAtPixel(c.pixel,
function(e,p){return{feature:e,layer:p}})){g=x.feature;n=x.layer;l=g.getGeometry().getCoordinates();a.tooltip_ol.setPosition(l);if(void 0!=n.s3_popup_format){z.templateSettings={interpolate:/\{(.+?)\}/g};C=n.s3_popup_format;E=z.template(C);d={};f={};B=C.split("{");for(c=0;c<B.length;c++)v=B[c].split("}")[0],d[v]=g.get(v),f[v]="";z.defaults(d,f);k=E(d)}else void 0!=d.popup?k=g.get("popup"):void 0!=g.get("name")?k=g.get("name"):void 0!=n.title&&(c=g.get(n.title),k="object"==typeof c?c.value:c);a.tooltip.html(k).show()}else a.tooltip.hide()});
b.on("click",function(c){if(x=b.forEachFeatureAtPixel(c.pixel,function(u,q){return{feature:u,layer:q}})){a.tooltip.hide();g=x.feature;n=x.layer;var e=g.getProperties();c=n.s3_layer_type;if("kml"==c){c=void 0!=n.title?n.title:"name";if(void 0!=g.style.balloonStyle)var p=g.style.balloonStyle.replace(/{([^{}]*)}/g,function(u,q){q=e[q];return"string"===typeof q||"number"===typeof q?q:u});else{var r=typeof e[c];c="object"==r?e[c].value:e[c];p="<h3>"+c+"</h3>";c=n.body.split(" ");for(var w,A,t=0;t<c.length;t++)r=
typeof e[c[t]],"object"==r?(r=e[c[t]].displayName,""===r&&(r=c[t]),A=e[c[t]].value,w='<div class="gis_popup_row"><div class="gis_popup_label">'+r+':</div><div class="gis_popup_cell">'+A+"</div></div>"):w=void 0!=e[c[t]]?'<div class="gis_popup_row">'+e[c[t]]+"</div>":"",p+=w}-1!=p.search("<script")&&(p="Content contained Javascript! Escaped content below.<br />"+p.replace(/</g,"<"))}else if("gpx"!=c)if("shapefile"==c||"geojson"==c)p="<div>",m.each(e,function(u,q){"id_orig"==u&&(u="id");w='<div class="gis_popup_row"><div class="gis_popup_label">'+
u+':</div><div class="gis_popup_cell">'+q+"</div></div>";p+=w}),p+="</div>";else if("wfs"==c)c=void 0!=n.title?n.title:"name",c=e[c],p="<h3>"+c+"</h3>",m.each(e,function(u,q){w='<div class="gis_popup_row"><div class="gis_popup_label">'+u+':</div><div class="gis_popup_val">'+q+"</div></div>";p+=w});else if(void 0!=e.url)var y=e.url;else if(void 0!=n.s3_url_format)z.templateSettings={interpolate:/\{(.+?)\}/g},y=z.template(n.s3_url_format),e.id.constructor===Array&&(e.id=e.id[0]),y=y(e);else{name=void 0==
e.name?"":"<h3>"+e.name+"</h3>";c=void 0==e.description?"":"<p>"+e.description+"</p>";t=void 0==e.link?"":'<a href="'+e.link+'" target="_blank">'+e.link+"</a>";if(void 0==e.data)r="";else if(0===e.data.indexOf("http://")){var G=!0;var F=S3.uid();r='<div id="'+F+'">'+a.options.i18n.loading+"...<div class='throbber'></div></div>"}else r="<p>"+e.data+"</p>";A=void 0==e.image?"":0===e.image.indexOf("http://")?'<img src="'+e.image+'" height=300 width=300>':"";p=name+c+t+r+A}y=a.addPopup(g,n,y,p);G&&a._loadDetails(e.data,
F,y)}})},_unbindEvents:function(){return!0}})});
