import{googleInteractions,GoogleLayer,OLGoogleMaps,LayerSwitcher,LayerGroup}from"../gis/ol6.min.js";!function(factory){"use strict";!function($,_,ol,googleInteractions,GoogleLayer,OLGoogleMaps,LayerSwitcher,LayerGroup){var mapID=0;$.widget("s3.showMap",{options:{id:"default_map",i18n:{loading:"Loading",requires_login:"Requires Login"},lat:0,lon:0,zoom:0},_create:function(){this.id=mapID,mapID+=1,this.eventNamespace=".s3Map",this.proxyHost=S3.Ap.concat("/gis/proxy?url=")},_init:function(options){this.refresh()},_destroy:function(){$.Widget.prototype.destroy.call(this)},refresh:function(){var options=this.options,map_options={layers:this.addLayers(options),target:options.id,view:new ol.View({center:ol.proj.fromLonLat([options.lon,options.lat]),zoom:options.zoom})},Google=options.Google;null!=Google&&(map_options.interactions=googleInteractions());var map=new ol.Map(map_options);this.map=map;var layerSwitcher=new LayerSwitcher({activationMode:"click",startActive:!0,tipLabel:"Layers",groupSelectStyle:"none"});map.addControl(layerSwitcher);var tooltip=$("#"+options.id+" .s3-gis-tooltip");this.tooltip=tooltip;var tooltip_ol=new ol.Overlay({element:tooltip[0],positioning:"bottom-center",stopEvent:!1,offset:[0,-15]});(map.addOverlay(tooltip_ol),this.tooltip_ol=tooltip_ol,this._bindEvents(map),null!=Google)&&new OLGoogleMaps({map:map}).activate()},addLayers:function(options){var baseLayers=[],layers_osm=options.layers_osm;null!=layers_osm&&this.addLayersOSM(baseLayers,layers_osm);var Bing=options.Bing;null!=Bing&&this.addLayersBing(baseLayers,Bing);var Google=options.Google;null!=Google&&this.addLayersGoogle(baseLayers,Google);var overlayLayers=[];return this.addLayersGeoJSON(overlayLayers,options),[new LayerGroup({title:"Overlays",fold:"open",layers:overlayLayers}),new LayerGroup({title:"Base Layers",fold:"open",layers:baseLayers})]},addLayersOSM:function(baseLayers,layers_osm){for(var layer,options,osmLayer,i=0;i<layers_osm.length;i++)options={attributions:null!=(layer=layers_osm[i]).attribution?[layer.attribution]:[ol.source.OSM.ATTRIBUTION],maxZoom:null!=layer.maxZoom?layer.maxZoom:19,opaque:null==layer.base||layer.base,url:null!=layer.url?layer.url:"https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png"},osmLayer=new ol.layer.Tile({source:new ol.source.OSM(options),s3_layer_id:layer.i,s3_layer_type:"osm",title:layer.n,type:"base"}),null!=layer._base?osmLayer.setVisible(layer._base):osmLayer.setVisible(!1),baseLayers.push(osmLayer)},addLayersBing:function(baseLayers,Bing){for(var bingLayer,layer,apiKey=Bing.a,layers_bing=Bing.l,i=0;i<layers_bing.length;i++)layer=layers_bing[i],bingLayer=new ol.layer.Tile({source:new ol.source.BingMaps({key:apiKey,imagerySet:layer.t}),s3_layer_id:layer.i,s3_layer_type:"bing",title:layer.n,type:"base"}),null!=layer.b?bingLayer.setVisible(!0):bingLayer.setVisible(!1),baseLayers.push(bingLayer)},addLayersGoogle:function(baseLayers,Google){for(var googleLayer,layer,layers_google=Google.l,i=0;i<layers_google.length;i++)layer=layers_google[i],googleLayer=new GoogleLayer({mapTypeId:layer.t,s3_layer_id:layer.i,s3_layer_type:"google",title:layer.n,type:"base"}),null!=layer.b?googleLayer.setVisible(!0):googleLayer.setVisible(!1),baseLayers.push(googleLayer)},addLayersGeoJSON:function(overlayLayers,options){var currentExtent,format,layer,layerType,layerUrl,style,vectorLayer,vectorSource,$this=this,feature_queries=options.feature_queries||[],feature_resources=options.feature_resources||[],layers_feature=options.layers_feature||[],layers_geojson=options.layers_geojson||[],layers_georss=options.layers_georss||[],layers_shapefile=options.layers_shapefile||[],layers_theme=options.layers_theme||[],proxyHost=this.proxyHost,vectorLayers=[];vectorLayers=feature_queries.concat(feature_resources).concat(layers_feature).concat(layers_geojson).concat(layers_georss).concat(layers_shapefile).concat(layers_theme);for(var i=0;i<vectorLayers.length;i++){format=null!=(layer=vectorLayers[i]).projection?new ol.format.GeoJSON({dataProjection:"EPSG:"+layer.projection}):new ol.format.GeoJSON({dataProjection:"EPSG:4326"}),style=this.layerStyle(layer),layerType=null!=layer.type?layer.type:"feature";let url=layer.url;url.startsWith("http")&&(url=proxyHost.concat(url)),layerUrl="feature"==layerType?function(extent,resolution,projection){var map=$this.map;return currentExtent=map.getView().calculateExtent(map.getSize()),currentExtent=ol.proj.transformExtent(currentExtent,projection,"EPSG:4326"),url+"&bbox="+currentExtent.join(",")}:url,vectorSource=new ol.source.Vector({format:format,url:layerUrl}),"feature"==layerType&&vectorSource.set("strategy",ol.loadingstrategy.bbox),vectorLayer=new ol.layer.Vector({source:vectorSource,style:style,title:layer.name}),null!=layer.popup_format&&vectorLayer.set("s3_popup_format",layer.popup_format),vectorLayer.set("s3_layer_type",layerType),null!=layer.visibility&&vectorLayer.setVisible(layer.visibility),overlayLayers.push(vectorLayer)}},layerStyle:function(layer){var style;if(void 0!==layer.marker)style=new ol.style.Style({image:new ol.style.Icon({src:S3.Ap.concat("/static/img/markers/"+layer.marker.i)})});else if(void 0!==layer.marker)style=layer.style;else{var fill=new ol.style.Fill({color:"rgba(255,255,255,0.4)"}),stroke=new ol.style.Stroke({color:"#3399CC",width:1.25}),image=new ol.style.Icon({src:S3.Ap.concat("/static/img/markers/"+this.options.marker)}),styles={Point:new ol.style.Style({image:image}),LineString:new ol.style.Style({stroke:stroke}),MultiLineString:new ol.style.Style({stroke:stroke}),MultiPoint:new ol.style.Style({image:image}),MultiPolygon:new ol.style.Style({stroke:stroke,fill:fill}),Polygon:new ol.style.Style({stroke:stroke,fill:fill}),GeometryCollection:new ol.style.Style({stroke:stroke,fill:fill,image:image}),Circle:new ol.style.Style({stroke:stroke,fill:fill})};style=function(feature){return styles[feature.getGeometry().getType()]}}return style},addPopup:function(feature,layer,url,content,iframe){var map=this.map,id=this.id+"_"+layer.ol_uid+"_"+feature.get("id")+"_popup";iframe&&url?(0===url.indexOf("http")&&(url=this.proxyHost+encodeURIComponent(url)),content='<iframe src="'+url+'" onload="S3.gis.popupLoaded(\''+id+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>'):null==content&&(content=this.options.i18n.loading+'...<div class="throbber"></div>'),$("#"+this.options.id).append('<div id="'+id+'" class="s3-gis-popup"><div class="s3-gis-popup-close"></div><div class="s3-gis-popup-content"></div></div>');var popup=$("#"+id),popup_ol=new ol.Overlay({element:popup[0],positioning:"bottom-center",offset:[0,-12]});map.addOverlay(popup_ol);var coordinates=feature.getGeometry().getCoordinates();popup_ol.setPosition(coordinates),$("#"+id+" .s3-gis-popup-content").html(content),popup.show(),$("#"+id+" .s3-gis-popup-close").on("click",{id:id,map:map,overlay:popup_ol},this.removePopup),iframe||null==url||this._loadDetails(url,id,popup)},removePopup:function(e){e.data.map.removeOverlay(e.data.overlay),$("#"+e.data.id).remove(),e.preventDefault()},_loadDetails:function(url,id,popup){var self=this;0===url.indexOf("http")&&(url=this.proxyHost+encodeURIComponent(url)),$.ajaxS3({url:url,dataType:"html",success:function(data){try{$("#"+id+" .s3-gis-popup-content").html(data),$("#"+id+" a.btn.iframe").click((function(){var url=$(this).attr("href");0===url.indexOf("http://")&&(url=self.proxyHost+encodeURIComponent(url));var content='<iframe src="'+url+'" onload="S3.gis.popupLoaded(\''+id+'\')" class="loading" marginWidth="0" marginHeight="0" frameBorder="0"></iframe>';return $("#"+id+" .s3-gis-popup-content").html(content),!1}))}catch(e){}},error:function(jqXHR,textStatus,errorThrown){msg="UNAUTHORIZED"==errorThrown?self.options.i18n.requires_login:jqXHR.responseText,$("#"+id+" .s3-gis-popup-content").html(msg)}})},_deserialize:function(){},_bindEvents:function(map){var attributes,content,coordinates,defaults,feature,geometry,geometryType,key,keys,layer,popupFormat,results,template,self=this;map.on("pointermove",(function(e){if(e.dragging)self.tooltip.hide();else if(results=map.forEachFeatureAtPixel(e.pixel,(function(feature,layer){return{feature:feature,layer:layer}})),results){if(feature=results.feature,layer=results.layer,geometry=feature.getGeometry(),"Point"==(geometryType=geometry.getType()))coordinates=geometry.getCoordinates();else{if("Polygon"!=geometryType)throw"No support yet for Popups other than for Points or Polygons!";coordinates=geometry.getInteriorPoint().getCoordinates()}if(self.tooltip_ol.setPosition(coordinates),null!=layer.s3_popup_format){_.templateSettings={interpolate:/\{(.+?)\}/g},popupFormat=layer.s3_popup_format,template=_.template(popupFormat),attributes={},defaults={},keys=popupFormat.split("{");for(var i=0;i<keys.length;i++)key=keys[i].split("}")[0],attributes[key]=feature.get(key),defaults[key]="";_.defaults(attributes,defaults),content=template(attributes)}else if(null!=feature.get("popup"))content=feature.get("popup");else if(null!=feature.get("name"))content=feature.get("name");else if(null!=layer.title){var a=feature.get(layer.title);content="object"==typeof a?a.value:a}self.tooltip.html(content).show()}else self.tooltip.hide()})),map.on("click",(function(e){if(results=map.forEachFeatureAtPixel(e.pixel,(function(feature,layer){return{feature:feature,layer:layer}})),results){self.tooltip.hide(),feature=results.feature,layer=results.layer;var content,data_link,popup_url,attributes=feature.getProperties(),layerType=layer.s3_layer_type;if("kml"==layerType){if(titleField=null!=layer.title?layer.title:"name",null!=feature.style.balloonStyle){var balloonStyle=feature.style.balloonStyle;content=balloonStyle.replace(/{([^{}]*)}/g,(function(a,b){var r=attributes[b];return"string"==typeof r||"number"==typeof r?r:a}))}else{var type=typeof attributes[titleField];title="object"==type?attributes[titleField].value:attributes[titleField],content="<h3>"+title+"</h3>";for(var body=layer.body.split(" "),j=0;j<body.length;j++)"object"==(type=typeof attributes[body[j]])?(""===(label=attributes[body[j]].displayName)&&(label=body[j]),value=attributes[body[j]].value,row='<div class="gis_popup_row"><div class="gis_popup_label">'+label+':</div><div class="gis_popup_cell">'+value+"</div></div>"):row=null!=attributes[body[j]]?'<div class="gis_popup_row">'+attributes[body[j]]+"</div>":"",content+=row}-1!=content.search("<script")&&(content="Content contained Javascript! Escaped content below.<br />"+content.replace(/</g,"<"))}else if("gpx"==layerType);else if("shapefile"==layerType||"geojson"==layerType){var label,value;content="<div>",$.each(attributes,(function(label,value){"id_orig"==label&&(label="id"),content+=row='<div class="gis_popup_row"><div class="gis_popup_label">'+label+':</div><div class="gis_popup_cell">'+value+"</div></div>"})),content+="</div>"}else if("wfs"==layerType){var titleField;titleField=null!=layer.title?layer.title:"name";var row,title=attributes[titleField];content="<h3>"+title+"</h3>",$.each(attributes,(function(label,value){content+=row='<div class="gis_popup_row"><div class="gis_popup_label">'+label+':</div><div class="gis_popup_val">'+value+"</div></div>"}))}else if(null!=attributes.url)popup_url=attributes.url;else if(null!=layer.s3_url_format){_.templateSettings={interpolate:/\{(.+?)\}/g};var template=_.template(layer.s3_url_format);attributes.id.constructor===Array&&(attributes.id=attributes.id[0]),popup_url=template(attributes)}else{var description,link,data,image;if(null==attributes.name?name="":name="<h3>"+attributes.name+"</h3>",description=null==attributes.description?"":"<p>"+attributes.description+"</p>",link=null==attributes.link?"":'<a href="'+attributes.link+'" target="_blank">'+attributes.link+"</a>",null==attributes.data)data="";else if(0===attributes.data.indexOf("http://")){data_link=!0;var data_id=S3.uid();data='<div id="'+data_id+'">'+self.options.i18n.loading+"...<div class='throbber'></div></div>"}else data="<p>"+attributes.data+"</p>";image=null==attributes.image?"":0===attributes.image.indexOf("http://")?'<img src="'+attributes.image+'" height=300 width=300>':"",content=name+description+link+data+image}var popup=self.addPopup(feature,layer,popup_url,content);data_link&&self._loadDetails(attributes.data,data_id,popup)}}))},_unbindEvents:function(){return!0}})}(window.jQuery,window._,window.ol,googleInteractions,GoogleLayer,OLGoogleMaps,LayerSwitcher,LayerGroup)}();