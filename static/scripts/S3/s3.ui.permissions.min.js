/*
 2018-2019 (c) Sahana Software Foundation
 @license MIT

 requires jQuery 1.9.1+
 requires jQuery UI 1.10 widget factory
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var l=0;return function(){return l<b.length?{done:!1,value:b[l++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,l,g){b!=Array.prototype&&b!=Object.prototype&&(b[l]=g.value)};$jscomp.getGlobal=function(b){b=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,b];for(var l=0;l<b.length;++l){var g=b[l];if(g&&g.Math==Math)return g}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(b,l){this.$jscomp$symbol$id_=b;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:l})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function b(g){if(this instanceof b)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(g||"")+"_"+l++,g)}var l=0;return b}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.iterator;b||(b=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[b]&&$jscomp.defineProperty(Array.prototype,b,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var b=$jscomp.global.Symbol.asyncIterator;b||(b=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();b={next:b};b[$jscomp.global.Symbol.iterator]=function(){return this};return b};
$jscomp.iteratorFromArray=function(b,l){$jscomp.initSymbolIterator();b instanceof String&&(b+="");var g=0,m={next:function(){if(g<b.length){var n=g++;return{value:l(n,b[n]),done:!1}}m.next=function(){return{done:!0,value:void 0}};return m.next()}};m[Symbol.iterator]=function(){return m};return m};
$jscomp.polyfill=function(b,l,g,m){if(l){g=$jscomp.global;b=b.split(".");for(m=0;m<b.length-1;m++){var n=b[m];n in g||(g[n]={});g=g[n]}b=b[b.length-1];m=g[b];l=l(m);l!=m&&null!=l&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:l})}};$jscomp.polyfill("Array.prototype.keys",function(b){return b?b:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");
(function(b,l){var g={rm_Add:"Add",rm_AddRule:"Add Rule",rm_AllEntities:"All Entities",rm_AllRecords:"All Records",rm_AssignedEntities:"Assigned Entities",rm_Cancel:"Cancel",rm_CollapseAll:"Collapse All",rm_ConfirmDeleteRule:"Do you want to delete this rule?",rm_Default:"default",rm_DeleteRule:"Delete",rm_ExpandAll:"Expand All",rm_NoAccess:"No access",rm_NoRestrictions:"No restrictions",rm_Others:"Others",rm_OwnedRecords:"Owned Records",rm_Page:"Page",rm_RestrictedTables:"Restricted Tables",rm_Scope:"Scope",
rm_SystemTables:"System Tables",rm_Table:"Table",rm_UnrestrictedTables:"Unrestricted Tables"},m=function(a){var b,d=a[3];d?!0!==d&&(b=d):!0!==a[2]&&(b=a[1]+"/"+(a[2]||"*"));return b},n=0;b.widget("s3.permissionEdit",{options:{fRules:!1,tRules:!1,useRealms:!1,permissions:[{l:"CREATE",b:1,o:!1},{l:"READ",b:2,o:!0},{l:"UPDATE",b:4,o:!0},{l:"DELETE",b:8,o:!0}],modules:{},models:{},defaultPermissions:{},icons:{expanded:"fa fa-caret-down",collapsed:"fa fa-caret-right"}},_create:function(){this.id=n;n+=
1;this.eventNamespace=".permissionEdit"},_init:function(){var a=b(this.element).attr("id");this.input=b("#"+a+"-input");this.tableWidth=this.options.useRealms?5:4;for(var c in g)g[c]=i18n[c]||g[c];this.refresh()},_destroy:function(){b.Widget.prototype.destroy.call(this)},refresh:function(){var a=b(this.element),c=this.options;this._unbindEvents();this._deserialize();var d=this._ruleSets(),e=b(".rm-rules",a).first(),f=this,g=d.pages,h=b(".rm-page-rules",a);this._renderExpandCollapseAll().appendTo(h);
Object.keys(c.modules).sort().forEach(function(a){c.modules[a][1]&&f._ruleTable("p",a,g[a]).appendTo(h)});g._other.length&&this._ruleTable("p","_other",g._other).appendTo(h);c.tRules&&(g=d.tables,h=b(".rm-table-rules",a),this._renderExpandCollapseAll().appendTo(h),Object.keys(c.models).sort().forEach(function(a){"_system"!=a&&f._ruleTable("t",a,g[a]).appendTo(h)}),this._ruleTable("t","_system",g._system).appendTo(h),g._other.length&&this._ruleTable("t","_other",g._other).appendTo(h));e.tabs().removeClass("hide").show();
this._bindEvents()},_deserialize:function(){try{this.rules=JSON.parse(this.input.val())}catch(a){this.rules=[],this._serialize()}},_serialize:function(){var a=this.rules.filter(function(a){return null!==a[0]&&(0!==a[0]||!a[7])});this.input.val(JSON.stringify(a)).change()},_ruleSets:function(){var a={_other:[]},b={_other:[]},d=this.options;this.rules.forEach(function(c){var f;if(f=c[3]){var e=b;var g=d.models;f=f.split("_")[0]}else{e=a;g=d.modules;f=c[1];var k=c[2];f="default"!=f||"table"!=k&&"tables"!=
k?f:"default/dt"}g.hasOwnProperty(f)?e[f]===l&&(e[f]=[]):f="_other";e[f].push(c)});return{pages:a,tables:b}},_renderExpandCollapseAll:function(){var a=b('<span class="action-lnk rm-expand-all">'),c=b('<span class="action-lnk rm-collapse-all">');a.text(g.rm_ExpandAll);c.text(g.rm_CollapseAll);return b('<div class="rm-toggle-all">').append(a).append(c)},_ruleTable:function(a,c,d){d||(d=[]);var e=b('<table class="rm-module-rules">').data({module:c});e.append(this._ruleTableHeader(c)).append(this._ruleTableBody(a,
c,d)).append(this._ruleTableFooter(a,c,d));this._indicateNumRules(e,d.length);return e},_ruleTableHeader:function(a){var c=b('<thead class="rm-module-header">'),d=b("<th>").attr("colspan",this.tableWidth),e=this.options.icons;if(e){var f=b('<i class="'+e.expanded+'">').hide();e=b('<i class="'+e.collapsed+'">');b('<div class="rm-module-toggle">').append(f).append(e).appendTo(d)}switch(a){case "_system":f="SYSTEM";a=g.rm_SystemTables;break;case "_other":f="*";a=g.rm_Others;break;case "s3dt":f="S3DT";
a=g.rm_DynamicTables;break;default:f="default/dt"==a?"DEFAULT":a.toLocaleUpperCase(),a=this.options.modules.hasOwnProperty(a)?this.options.modules[a][0]:""}b('<div class="rm-module-prefix">').text(f).appendTo(d);b('<div class="rm-module-title">').text(a).appendTo(d);b('<div class="rm-module-numrules">').appendTo(d);b("<tr>").append(d).appendTo(c);return c},_ruleTableBody:function(a,c,d){var e=this.options,f=b("<tbody>").hide(),r=!0,h=d.map(m);if("t"==a){if(c=e.models[c])for(var k in c)c[k]&&-1==h.indexOf(k)&&
d.push([null,null,null,k,null,null,null,!1]);h=g.rm_Table;0===d.length&&(r=!1,f.append(this._defaultRule(!1)))}else{k="default/dt"==c;var l;for(l in e.defaultPermissions)if((a=k?"default/tables"==l||"default/table"==l:l.slice(0,c.length+1)==c+"/")&&-1==h.indexOf(l)){a=l.split("/");var q=a[1];if("*"==q)q=null;else if(!e.fRules)continue;d.push([null,a[0],q,null,null,null,null,!1])}h=g.rm_Page;0===d.length&&(r=!1,f.append(this._defaultRule(!0)))}c=b('<tr class="rm-rule-labels">').hide().appendTo(f);
c.append("<th>"+h+"</th>").append("<th>"+g.rm_AllRecords+"</th>").append("<th>"+g.rm_OwnedRecords+"</th>");e.useRealms&&b("<th>").text(g.rm_Scope).appendTo(c);c.append("<th></th>");if(r){c.show();d=d.sort(function(a,b){a=a.slice(1,4).join(" ");b=b.slice(1,4).join(" ");return a===b?0:a>b&&1||-1});var p=this;d.forEach(function(a){p._ruleTableRow(a).appendTo(f)})}return f},_ruleTableFooter:function(a,c,d){var e=b("<tfoot>").hide();if("_other"!=c){c=b('<tr class="rm-module-add">');var f=b("<td>").attr("colspan",
this.tableWidth);b('<span class="action-lnk rm-add-rule">').text(g.rm_AddRule).appendTo(f);"t"!=a&&!this.options.fRules&&d.length&&c.hide();c.append(f).appendTo(e)}return e},_ruleTableRow:function(a){var c=b('<tr class="rm-rule">').data({rule:a}),d=this.options,e=m(a);if(e)b('<td class="rm-rule-target">').text(e).appendTo(c);else{var f=this._targetSelector(a);b('<td class="rm-rule-target">').append(f).appendTo(c)}e&&null===a[0]?(c.addClass("rm-default-permissions"),a=this._defaultPermissions(e),a.oACL?
(b("<td>").text(a.uACL).appendTo(c),b("<td>").text(a.oACL).appendTo(c)):b("<td>").attr("colspan",2).text(a.uACL).appendTo(c),d.useRealms&&b("<td>").appendTo(c),d=b('<a class="rm-add-rule action-lnk">'),b("<td>").append(d.text(g.rm_AddRule)).appendTo(c)):(f=this._permissionSelector(a),c.append(f.uACL).append(f.oACL),d.useRealms&&b("<td>").append(this._scopeSelector(a)).appendTo(c),e?(d=b('<a class="rm-delete-rule delete-btn-ajax">'),b("<td>").append(d.text(g.rm_DeleteRule)).appendTo(c)):(d=b('<a class="rm-submit-rule action-btn">'),
a=b('<span class="rm-cancel-add action-lnk">'),b("<td>").append(d.text(g.rm_Add)).append(a.text(g.rm_Cancel)).appendTo(c)));return c},_targetSelector:function(a){var c=this.options,d=b("<div>"),e=a[1],f=function(a,c){c===l&&(c=a);return b('<option value="'+a+'">').text(c)},r=function(){return b('<option value="">').prop("selected",!0).prop("disabled",!0).hide()};if(a[3]){var h=c.models[e],k=b("<optgroup>").attr("label",g.rm_RestrictedTables),m=b("<optgroup>").attr("label",g.rm_UnrestrictedTables),
q=0,p=0;Object.keys(h).sort().forEach(function(a){h[a]?(q+=1,k.append(f(a))):(p+=1,m.append(f(a)))});a=b("<select>").append(r());q&&a.append(k);p&&a.append(m)}else"_other"==e?(a=b('<input type="text" size="20">'),a.data("pattern",/^(\w+)(\/(\*|[\w]+))?$/)):"default/dt"==e?(a=b("<select>"),a.append(r()).append(f("default/table")).append(f("default/tables"))):(d.append("<span>"+e+" / </span>"),a=b('<input type="text" size="10">'),a.data("pattern",/^(\w+|\*)$/));a.addClass("rm-target-select").appendTo(d);
return d},_validateTarget:function(a){var b=a.val(),d=a.data("pattern");d.lastIndex=0;if(b&&d&&!d.exec(b))return a.addClass("rm-invalid"),!1;a.removeClass("rm-invalid");return!0},_defaultPermissions:function(a){var b=this.options,d=b.defaultPermissions[a];a={};var e=" ("+g.rm_Default+")";if(d!==l){var f=d[0];d=d[1]&~f;var r=function(a){var c=[];b.permissions.forEach(function(b){a&b.b&&c.push(b.l)});return c.join(", ")};f&&(a.uACL=r(f)+e);d&&(a.oACL=r(d)+e)}a.uACL||(a.uACL=g.rm_NoAccess+e);return a},
_defaultRule:function(a){a=a?g.rm_NoAccess:g.rm_NoRestrictions;a=b("<td>").attr("colspan",this.tableWidth).text(a);return b('<tr class="rm-default-rule">').append(a)},_permissionSelector:function(a){var c=b('<td class="rm-permission-all">'),d=b('<td class="rm-permission-own">');this.options.permissions.forEach(function(e){var f=b('<input class="rm-permission" type="checkbox">'),g=b('<input class="rm-permission" type="checkbox">');b("<label>").append(f).append(e.l).appendTo(c);b("<label>").append(g).append(e.l).css({visibility:e.o&&
"visible"||"hidden"}).appendTo(d);var h=a[5]&e.b;g.prop("checked",h);g.data({bit:e.b,selected:h,implied:!1});h=a[4]&e.b;f.prop("checked",h);f.data({bit:e.b,selected:h,implied:!1});g.data("implied",h);h&&g.prop({checked:!0,disabled:!0});f.data("imply",g)});return{uACL:c,oACL:d}},_scopeSelector:function(a){var c=b('<select class="rm-scope-select">'),d=b('<option value="">').text(g.rm_AssignedEntities),e=b('<option value="any">').text(g.rm_AllEntities);if(a)switch(a[6]){case "any":e.prop("selected",
!0);break;default:d.prop("selected",!0),a[6]=null}c.append(d).append(e);return b("<div>").append(c)},_addRule:function(a){var c=this.options,d=a.closest(".rm-module-rules"),e=d.data("module"),f=c.models[e],g=this;b("tfoot .rm-rule",b(this.element)).each(function(){g._cancelAdd(b(this))});var h=a.closest(".rm-rule");if(h.length){var k=h.data("rule");k=(a=k[3])?[0,null,null,a,0,0,null,!1]:[0,k[1],k[2],null,0,0,null,!1];if(c=c.defaultPermissions[m(k)])k[4]=c[0],k[5]=c[1];this.rules.push(k);k=this._ruleTableRow(k);
h.after(k).remove();a&&(f[a]+=1);this._serialize()}else f=!0,a.closest(".rm-table-rules").length?k=[0,e,null,!0,0,0,null,!1]:c.fRules?k=[0,e,!0,null,0,0,null,!1]:b("tbody .rm-rule",d).length||(k=[0,e,null,null,0,0,null,!1],f=!1),k&&(k=this._ruleTableRow(k),f?a.closest(".rm-module-add").hide().after(k):(b("tbody",d).append(k),a.closest(".rm-module-add").hide())),b(".rm-default-rule",d).hide(),b(".rm-rule-labels",d).show()},_submitAdd:function(a){var c=a.closest(".rm-module-rules"),d=a.data("rule"),
e=null,f=null,g=null,h=b(".rm-target-select",a).val().replace(/\s/,"");if(d[3]){if(g=h,!g)return}else{e=d[1];f=h;var k="_other"==e;if("default/dt"==e||k){if(h=/^(\w+)(\/(\*|[\w]+))?$/.exec(h))e=h[1],f=h[3];else return;if(k)for(k=b(".rm-module-rules",a.closest(".rm-page-rules")),h=k.length;h--;){var m=b(k[h]);if(m.data("module")==e){c=m;break}}}if(!f||"*"==f)f=null;else if(!/^\w+$/.exec(f))return}d[1]=e&&e.toLowerCase();d[2]=f&&f.toLowerCase();d[3]=g&&g.toLowerCase();var q,p,n;b("tbody .rm-rule",c).each(function(){var a=
b(this),c=a.data("rule");if(!q){a:{var e=null===d[0]||null===c[0]?[1,2,3]:[1,2,3,6];for(var k=e.length,h;k--;)if(h=e[k],d[h]!==c[h]){e=!1;break a}e=!0}e?(p=c,n=q=a):n||(g?c[3]>g&&(n=a):c[2]&&(f&&c[2]>f||!f)&&(n=a))}});if(p&&null!==p[0])p.splice(1,d.length-1),p.push.apply(p,d.slice(1)),d=p;else if(this.rules.push(d),e=d[3])k=this.options.models[c.data("module")],k[e]=k[e]!==l?k[e]+1:1;this._serialize();e=this._ruleTableRow(d);n?e.insertBefore(n):e.appendTo(b("tbody",c));q&&q.remove();this._indicateNumRules(c,
b("tbody .rm-rule",c).length);a.siblings(".rm-module-add").show();a.remove()},_cancelAdd:function(a){var c=a.closest(".rm-module-rules");0===b("tbody .rm-rule",c).length&&(b(".rm-rule-labels",c).hide(),b(".rm-default-rule",c).show());a.siblings(".rm-module-add").show();a.remove()},_updateRule:function(a,b){if(a=a.data("rule")){for(var c in b){var e=b[c];if(e!==l)switch(c){case "c":a[1]=e;break;case "f":a[2]=e;break;case "t":a[3]=e;break;case "uACL":a[4]=e;break;case "oACL":a[5]=e;break;case "scope":a[6]=
e;break;case "deleted":a[7]=!!e}}this._serialize()}},_deleteRule:function(a){if(confirm(g.rm_ConfirmDeleteRule)){var c=this.options,d=a.closest(".rm-module-rules"),e=!1,f=a.data("rule");f[7]=!0;this._serialize();var l=f[3];if(l){var h=this.rules.filter(function(a){return a[3]==l&&!a[7]});h.length||(h=d.data("module"),c=c.models[h],--c[l],0<c[l]&&(c=[null,null,null,l,null,null,null,!1],this._ruleTableRow(c).insertBefore(a)))}else h=this.rules.filter(function(a){return a[1]==f[1]&&a[2]==f[2]&&!a[7]}),
!h.length&&c.defaultPermissions[m(f)]&&(c=[null,f[1],f[2],null,null,null,null,!1],this._ruleTableRow(c).insertBefore(a)),e=!0;c=b(".rm-rule",d).length-1;c||(this._defaultRule(e).insertBefore(a),b(".rm-rule-labels",d).hide(),b(".rm-module-add",d).show());this._indicateNumRules(d,c);a.remove()}},_updatePermissions:function(a){this._updateRule(a,{uACL:this._getPermissions(b(".rm-permission-all",a)),oACL:this._getPermissions(b(".rm-permission-own",a))})},_getPermissions:function(a){var c=0;b(".rm-permission",
a).each(function(){var a=b(this);!a.data("implied")&&a.data("selected")&&(a=a.data("bit"))&&(c|=a)});return c},_indicateNumRules:function(a,c){var d=b(".rm-module-numrules",a);c?(d.text("["+c+"]"),a.addClass("hasrules")):(d.empty(),a.removeClass("hasrules"))},_toggleRuleTable:function(a){a.hasClass("rm-expanded")?(b("tbody, tfoot",a).hide(),a.removeClass("rm-expanded")):(b("tbody, tfoot",a).show(),a.addClass("rm-expanded"));b(".rm-module-toggle i",a).toggle()},_toggleAll:function(a,c){var d=this;
c?b(".rm-module-rules:not(.rm-expanded)",a).each(function(a,c){d._toggleRuleTable(b(c))}):b(".rm-module-rules.rm-expanded",a).each(function(a,c){d._toggleRuleTable(b(c))})},_permissionChanged:function(a){if(a.data("implied"))a.prop({checked:!0,disabled:!0});else if(a.prop("disabled"))a.prop({disabled:!1,checked:a.data("selected")});else{var b=a.prop("checked"),d=a.data("imply");a.data({selected:b});d&&d.length&&d.data("implied",b).change()}this._updatePermissions(a.closest(".rm-rule"))},_scopeChanged:function(a){var b=
a.closest(".rm-rule").data("rule");switch(a.val()){case "any":b[6]="any";break;default:b[6]=null}this._serialize()},_bindEvents:function(){var a=b(this.element),c=this.eventNamespace,d=this;b(".rm-table-rules, .rm-page-rules",a).on("click"+c,".rm-expand-all",function(){d._toggleAll(b(this).closest(".rm-table-rules, .rm-page-rules"),!0);return!1}).on("click"+c,".rm-collapse-all",function(){d._toggleAll(b(this).closest(".rm-table-rules, .rm-page-rules"),!1);return!1});b(".rm-module-rules",a).on("click"+
c,".rm-module-header",function(){d._toggleRuleTable(b(this).closest(".rm-module-rules"));return!1}).on("change"+c,".rm-permission",function(){d._permissionChanged(b(this));return!1}).on("change"+c,".rm-scope-select",function(){d._scopeChanged(b(this));return!1}).on("click"+c,".rm-delete-rule",function(){d._deleteRule(b(this).closest(".rm-rule"));return!1}).on("click"+c,".rm-add-rule",function(){d._addRule(b(this))}).on("click"+c,".rm-cancel-add",function(){d._cancelAdd(b(this).closest(".rm-rule"))}).on("click"+
c,".rm-submit-rule",function(){d._submitAdd(b(this).closest(".rm-rule"))}).on("input"+c,"input.rm-target-select",function(){d._validateTarget(b(this))});return!0},_unbindEvents:function(){var a=b(this.element),c=this.eventNamespace;b(".rm-module-rules, .rm-table-rules, .rm-page-rules",a).off(c);return!0}})})(jQuery);
