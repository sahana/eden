(function(a){a.widget("ui.selectmenu",{options:{appendTo:"body",typeAhead:1E3,style:"dropdown",positionOptions:null,width:null,menuWidth:null,handleWidth:26,maxHeight:null,icons:null,format:null,escapeHtml:!1,bgImage:function(){}},_create:function(){var b=this,c=this.options,d=this.element.uniqueId().attr("id");this.ids=[d,d+"-button",d+"-menu"];this._safemouseup=!0;this.isOpen=!1;this.newelement=a("<a />",{"class":"ui-selectmenu ui-widget ui-state-default ui-corner-all",id:this.ids[1],role:"button",
href:"#nogo",tabindex:this.element.attr("disabled")?1:0,"aria-haspopup":!0,"aria-owns":this.ids[2]});this.newelementWrap=a("<span />").append(this.newelement).insertAfter(this.element);(d=this.element.attr("tabindex"))&&this.newelement.attr("tabindex",d);this.newelement.data("selectelement",this.element);this.selectmenuIcon=a('<span class="ui-selectmenu-icon ui-icon"></span>').prependTo(this.newelement);this.newelement.prepend('<span class="ui-selectmenu-status" />');this.element.bind({"click.selectmenu":function(a){b.newelement.focus();
a.preventDefault()}});this.newelement.bind("mousedown.selectmenu",function(a){b._toggle(a,!0);"popup"==c.style&&(b._safemouseup=!1,setTimeout(function(){b._safemouseup=!0},300));a.preventDefault()}).bind("click.selectmenu",function(a){a.preventDefault()}).bind("keydown.selectmenu",function(c){var d=!1;switch(c.keyCode){case a.ui.keyCode.ENTER:d=!0;break;case a.ui.keyCode.SPACE:b._toggle(c);break;case a.ui.keyCode.UP:c.altKey?b.open(c):b._moveSelection(-1);break;case a.ui.keyCode.DOWN:c.altKey?b.open(c):
b._moveSelection(1);break;case a.ui.keyCode.LEFT:b._moveSelection(-1);break;case a.ui.keyCode.RIGHT:b._moveSelection(1);break;case a.ui.keyCode.TAB:d=!0;break;case a.ui.keyCode.PAGE_UP:case a.ui.keyCode.HOME:b.index(0);break;case a.ui.keyCode.PAGE_DOWN:case a.ui.keyCode.END:b.index(b._optionLis.length);break;default:d=!0}return d}).bind("keypress.selectmenu",function(a){0<a.which&&b._typeAhead(a.which,"mouseup");return!0}).bind("mouseover.selectmenu",function(){c.disabled||a(this).addClass("ui-state-hover")}).bind("mouseout.selectmenu",
function(){c.disabled||a(this).removeClass("ui-state-hover")}).bind("focus.selectmenu",function(){c.disabled||a(this).addClass("ui-state-focus")}).bind("blur.selectmenu",function(){c.disabled||a(this).removeClass("ui-state-focus")});a(document).bind("mousedown.selectmenu-"+this.ids[0],function(a){b.isOpen&&b.ids[1]!=a.target.offsetParent.id&&b.close(a)});this.element.bind("click.selectmenu",function(){b._refreshValue()}).bind("focus.selectmenu",function(){b.newelement&&b.newelement[0].focus()});c.width||
(c.width=this.element.outerWidth());this.newelement.width(c.width);this.element.hide();this.list=a("<ul />",{"class":"ui-widget ui-widget-content","aria-hidden":!0,role:"listbox","aria-labelledby":this.ids[1],id:this.ids[2]});this.listWrap=a("<div />",{"class":"ui-selectmenu-menu"}).append(this.list).appendTo(c.appendTo);this.list.bind("keydown.selectmenu",function(c){var d=!1;switch(c.keyCode){case a.ui.keyCode.UP:c.altKey?b.close(c,!0):b._moveFocus(-1);break;case a.ui.keyCode.DOWN:c.altKey?b.close(c,
!0):b._moveFocus(1);break;case a.ui.keyCode.LEFT:b._moveFocus(-1);break;case a.ui.keyCode.RIGHT:b._moveFocus(1);break;case a.ui.keyCode.HOME:b._moveFocus(":first");break;case a.ui.keyCode.PAGE_UP:b._scrollPage("up");break;case a.ui.keyCode.PAGE_DOWN:b._scrollPage("down");break;case a.ui.keyCode.END:b._moveFocus(":last");break;case a.ui.keyCode.ENTER:case a.ui.keyCode.SPACE:b.close(c,!0);a(c.target).parents("li:eq(0)").trigger("mouseup");break;case a.ui.keyCode.TAB:d=!0;b.close(c,!0);a(c.target).parents("li:eq(0)").trigger("mouseup");
break;case a.ui.keyCode.ESCAPE:b.close(c,!0);break;default:d=!0}return d}).bind("keypress.selectmenu",function(a){0<a.which&&b._typeAhead(a.which,"focus");return!0}).bind("mousedown.selectmenu mouseup.selectmenu",function(){return!1});a(window).bind("resize.selectmenu-"+this.ids[0],a.proxy(b.close,this))},_init:function(){var b=this,c=this.options,d=[];this.element.find("option").each(function(){var e=a(this);d.push({value:e.attr("value"),text:b._formatText(e.text(),e),selected:e.prop("selected"),
disabled:e.prop("disabled"),classes:e.attr("class"),typeahead:e.attr("typeahead"),parentOptGroup:e.parent("optgroup"),bgImage:c.bgImage.call(e)})});var e="popup"==b.options.style?" ui-state-active":"";this.list.html("");if(d.length)for(var f=0;f<d.length;f++){var g={role:"presentation"};d[f].disabled&&(g["class"]="ui-state-disabled");var h={html:d[f].text||"&nbsp;",href:"#nogo",tabindex:-1,role:"option","aria-selected":!1};d[f].disabled&&(h["aria-disabled"]=d[f].disabled);d[f].typeahead&&(h.typeahead=
d[f].typeahead);h=a("<a/>",h).bind("focus.selectmenu",function(){a(this).parent().mouseover()}).bind("blur.selectmenu",function(){a(this).parent().mouseout()});g=a("<li/>",g).append(h).data("index",f).addClass(d[f].classes).data("optionClasses",d[f].classes||"").bind("mouseup.selectmenu",function(c){!b._safemouseup||(b._disabled(c.currentTarget)||b._disabled(a(c.currentTarget).parents("ul > li.ui-selectmenu-group ")))||(b.index(a(this).data("index")),b.select(c),b.close(c,!0));return!1}).bind("click.selectmenu",
function(){return!1}).bind("mouseover.selectmenu",function(c){a(this).hasClass("ui-state-disabled")||a(this).parent("ul").parent("li").hasClass("ui-state-disabled")||(c.optionValue=b.element[0].options[a(this).data("index")].value,b._trigger("hover",c,b._uiHash()),b._selectedOptionLi().addClass(e),b._focusedOptionLi().removeClass("ui-selectmenu-item-focus ui-state-hover"),a(this).removeClass("ui-state-active").addClass("ui-selectmenu-item-focus ui-state-hover"))}).bind("mouseout.selectmenu",function(c){a(this).is(b._selectedOptionLi())&&
a(this).addClass(e);c.optionValue=b.element[0].options[a(this).data("index")].value;b._trigger("blur",c,b._uiHash());a(this).removeClass("ui-selectmenu-item-focus ui-state-hover")});d[f].parentOptGroup.length?(h="ui-selectmenu-group-"+this.element.find("optgroup").index(d[f].parentOptGroup),this.list.find("li."+h).length?this.list.find("li."+h+":last ul").append(g):a('<li role="presentation" class="ui-selectmenu-group '+h+(d[f].parentOptGroup.attr("disabled")?' ui-state-disabled" aria-disabled="true"':
'"')+'><span class="ui-selectmenu-group-label">'+d[f].parentOptGroup.attr("label")+"</span><ul></ul></li>").appendTo(this.list).find("ul").append(g)):g.appendTo(this.list);if(c.icons)for(var m in c.icons)g.is(c.icons[m].find)&&(g.data("optionClasses",d[f].classes+" ui-selectmenu-hasIcon").addClass("ui-selectmenu-hasIcon"),h=c.icons[m].icon||"",g.find("a:eq(0)").prepend('<span class="ui-selectmenu-item-icon ui-icon '+h+'"></span>'),d[f].bgImage&&g.find("span").css("background-image",d[f].bgImage))}else a('<li role="presentation"><a href="#nogo" tabindex="-1" role="option"></a></li>').appendTo(this.list);
f="dropdown"==c.style;this.newelement.toggleClass("ui-selectmenu-dropdown",f).toggleClass("ui-selectmenu-popup",!f);this.list.toggleClass("ui-selectmenu-menu-dropdown ui-corner-bottom",f).toggleClass("ui-selectmenu-menu-popup ui-corner-all",!f).find("li:first").toggleClass("ui-corner-top",!f).end().find("li:last").addClass("ui-corner-bottom");this.selectmenuIcon.toggleClass("ui-icon-triangle-1-s",f).toggleClass("ui-icon-triangle-2-n-s",!f);"dropdown"==c.style?this.list.width(c.menuWidth?c.menuWidth:
c.width):this.list.width(c.menuWidth?c.menuWidth:c.width-c.handleWidth);this.list.css("height","auto");f=this.listWrap.height();m=a(window).height();m=c.maxHeight?Math.min(c.maxHeight,m):m/3;f>m&&this.list.height(m);this._optionLis=this.list.find("li:not(.ui-selectmenu-group)");this.element.attr("disabled")?this.disable():this.enable();this._refreshValue();this._selectedOptionLi().addClass("ui-selectmenu-item-focus");clearTimeout(this.refreshTimeout);this.refreshTimeout=window.setTimeout(function(){b._refreshPosition()},
200)},destroy:function(){this.element.removeData(this.widgetName).removeClass("ui-selectmenu-disabled ui-state-disabled").removeAttr("aria-disabled").unbind(".selectmenu");a(window).unbind(".selectmenu-"+this.ids[0]);a(document).unbind(".selectmenu-"+this.ids[0]);this.newelementWrap.remove();this.listWrap.remove();this.element.unbind(".selectmenu").show();a.Widget.prototype.destroy.apply(this,arguments)},_typeAhead:function(a,c){var d=this,e=String.fromCharCode(a).toLowerCase(),f=null,g=null;d._typeAhead_timer&&
(window.clearTimeout(d._typeAhead_timer),d._typeAhead_timer=void 0);d._typeAhead_chars=(void 0===d._typeAhead_chars?"":d._typeAhead_chars).concat(e);2>d._typeAhead_chars.length||d._typeAhead_chars.substr(-2,1)===e&&d._typeAhead_cycling?(d._typeAhead_cycling=!0,f=e):(d._typeAhead_cycling=!1,f=d._typeAhead_chars);for(var e=("focus"!==c?this._selectedOptionLi().data("index"):this._focusedOptionLi().data("index"))||0,h=0;h<this._optionLis.length;h++)if(this._optionLis.eq(h).text().substr(0,f.length).toLowerCase()===
f)if(d._typeAhead_cycling){if(null===g&&(g=h),h>e){g=h;break}}else g=h;null!==g&&this._optionLis.eq(g).find("a").trigger(c);d._typeAhead_timer=window.setTimeout(function(){d._typeAhead_timer=void 0;d._typeAhead_chars=void 0;d._typeAhead_cycling=void 0},d.options.typeAhead)},_uiHash:function(){var b=this.index();return{index:b,option:a("option",this.element).get(b),value:this.element[0].value}},open:function(a){if("true"!=this.newelement.attr("aria-disabled")){var c=this.options,d=this._selectedOptionLi(),
e=d.find("a");this._closeOthers(a);this.newelement.addClass("ui-state-active");this.list.attr("aria-hidden",!1);this.listWrap.addClass("ui-selectmenu-open");"dropdown"==c.style?this.newelement.removeClass("ui-corner-all").addClass("ui-corner-top"):this.list.css("left",-5E3).scrollTop(this.list.scrollTop()+d.position().top-this.list.outerHeight()/2+d.outerHeight()/2).css("left","auto");this._refreshPosition();e.length&&e[0].focus();this.isOpen=!0;this._trigger("open",a,this._uiHash())}},close:function(a,
c){this.newelement.is(".ui-state-active")&&(this.newelement.removeClass("ui-state-active"),this.listWrap.removeClass("ui-selectmenu-open"),this.list.attr("aria-hidden",!0),"dropdown"==this.options.style&&this.newelement.removeClass("ui-corner-top").addClass("ui-corner-all"),c&&this.newelement.focus(),this.isOpen=!1,this._trigger("close",a,this._uiHash()))},change:function(a){this.element.trigger("change");this._trigger("change",a,this._uiHash())},select:function(a){if(this._disabled(a.currentTarget))return!1;
this._trigger("select",a,this._uiHash())},widget:function(){return this.listWrap.add(this.newelementWrap)},_closeOthers:function(b){a(".ui-selectmenu.ui-state-active").not(this.newelement).each(function(){a(this).data("selectelement").selectmenu("close",b)});a(".ui-selectmenu.ui-state-hover").trigger("mouseout")},_toggle:function(a,c){this.isOpen?this.close(a,c):this.open(a)},_formatText:function(b,c){this.options.format?b=this.options.format(b,c):this.options.escapeHtml&&(b=a("<div />").text(b).html());
return b},_selectedIndex:function(){return this.element[0].selectedIndex},_selectedOptionLi:function(){return this._optionLis.eq(this._selectedIndex())},_focusedOptionLi:function(){return this.list.find(".ui-selectmenu-item-focus")},_moveSelection:function(a,c){if(!this.options.disabled){var d=parseInt(this._selectedOptionLi().data("index")||0,10)+a;0>d&&(d=0);d>this._optionLis.size()-1&&(d=this._optionLis.size()-1);if(d===c)return!1;this._optionLis.eq(d).hasClass("ui-state-disabled")?(0<a?++a:--a,
this._moveSelection(a,d)):this._optionLis.eq(d).trigger("mouseover").trigger("mouseup")}},_moveFocus:function(a,c){var d=isNaN(a)?parseInt(this._optionLis.filter(a).data("index"),10):parseInt(this._focusedOptionLi().data("index")||0,10)+a;0>d&&(d=0);d>this._optionLis.size()-1&&(d=this._optionLis.size()-1);if(d===c)return!1;var e="ui-selectmenu-item-"+Math.round(1E3*Math.random());this._focusedOptionLi().find("a:eq(0)").attr("id","");this._optionLis.eq(d).hasClass("ui-state-disabled")?(0<a?++a:--a,
this._moveFocus(a,d)):this._optionLis.eq(d).find("a:eq(0)").attr("id",e).focus();this.list.attr("aria-activedescendant",e)},_scrollPage:function(a){var c=Math.floor(this.list.outerHeight()/this._optionLis.first().outerHeight());this._moveFocus("up"==a?-c:c)},_setOption:function(a,c){this.options[a]=c;"disabled"==a&&(c&&this.close(),this.element.add(this.newelement).add(this.list)[c?"addClass":"removeClass"]("ui-selectmenu-disabled ui-state-disabled").attr("aria-disabled",c))},disable:function(a,c){"undefined"==
typeof a?this._setOption("disabled",!0):"optgroup"==c?this._toggleOptgroup(a,!1):this._toggleOption(a,!1)},enable:function(a,c){"undefined"==typeof a?this._setOption("disabled",!1):"optgroup"==c?this._toggleOptgroup(a,!0):this._toggleOption(a,!0)},_disabled:function(b){return a(b).hasClass("ui-state-disabled")},_toggleOption:function(a,c){var d=this._optionLis.eq(a);d&&(d.toggleClass("ui-state-disabled",c).find("a").attr("aria-disabled",!c),c?this.element.find("option").eq(a).attr("disabled","disabled"):
this.element.find("option").eq(a).removeAttr("disabled"))},_toggleOptgroup:function(a,c){var d=this.list.find("li.ui-selectmenu-group-"+a);d&&(d.toggleClass("ui-state-disabled",c).attr("aria-disabled",!c),c?this.element.find("optgroup").eq(a).attr("disabled","disabled"):this.element.find("optgroup").eq(a).removeAttr("disabled"))},index:function(b){if(arguments.length){if(this._disabled(a(this._optionLis[b]))||b==this._selectedIndex())return!1;this.element[0].selectedIndex=b;this._refreshValue();this.change()}else return this._selectedIndex()},
value:function(a){if(arguments.length&&a!=this.element[0].value)this.element[0].value=a,this._refreshValue(),this.change();else return this.element[0].value},_refreshValue:function(){var a="popup"==this.options.style?" ui-state-active":"",c="ui-selectmenu-item-"+Math.round(1E3*Math.random());this.list.find(".ui-selectmenu-item-selected").removeClass("ui-selectmenu-item-selected"+a).find("a").attr("aria-selected","false").attr("id","");this._selectedOptionLi().addClass("ui-selectmenu-item-selected"+
a).find("a").attr("aria-selected","true").attr("id",c);var a=this.newelement.data("optionClasses")?this.newelement.data("optionClasses"):"",d=this._selectedOptionLi().data("optionClasses")?this._selectedOptionLi().data("optionClasses"):"";this.newelement.removeClass(a).data("optionClasses",d).addClass(d).find(".ui-selectmenu-status").html(this._selectedOptionLi().find("a:eq(0)").html());this.list.attr("aria-activedescendant",c)},_refreshPosition:function(){var b=this.options,c={of:this.newelement,
my:"left top",at:"left bottom",collision:"flip"};if("popup"==b.style){var d=this._selectedOptionLi();c.my="left top"+(this.list.offset().top-d.offset().top-(this.newelement.outerHeight()+d.outerHeight())/2);c.collision="fit"}this.listWrap.removeAttr("style").zIndex(this.element.zIndex()+1).position(a.extend(c,b.positionOptions))}})})(jQuery);
var TypeHelpers=new function(){var a=this;a.hasSmoothing=function(){if("undefined"!=typeof screen.fontSmoothingEnabled)return screen.fontSmoothingEnabled;try{var a=document.createElement("canvas");a.width="35";a.height="35";a.style.display="none";document.body.appendChild(a);var c=a.getContext("2d");c.textBaseline="top";c.font="32px Arial";c.fillStyle="black";c.strokeStyle="black";c.fillText("O",0,0);for(a=8;32>=a;a++)for(var d=1;32>=d;d++){var e=c.getImageData(d,a,1,1).data[3];if(255!=e&&0!=e)return!0}return!1}catch(f){return null}};
a.insertClasses=function(){var b=a.hasSmoothing(),c=document.getElementsByTagName("html")[0];c.className=!0==b?c.className+" hasFontSmoothing-true":!1==b?c.className+" hasFontSmoothing-false":c.className+" hasFontSmoothing-unknown"}},activeWindow,drawerOpen=!1,colors={0:"#999999",1:"#ff5121",2:"#f4961c",3:"#d6b317",4:"#77b826",5:"#059346"},map,parser,proj4326,resilienceLayer,populationLayer,volunteerLayer,popupControl,current_l0,current_l1,current_l2,current_l3,analysisLocation={0:null,1:null,2:null,
3:null},analysisDataCache={};S3.dataTables=[];S3.dataTables.id=["report"];var shownReport=-1,submittedData="",submittedDataPage=0,submitDataJobID=0,submitNextAction="",submitDataItemIDs="",mapjs,mapjscustom;
S3.debug?(mapjs=[S3.Ap.concat("/static/scripts/gis/openlayers/lib/OpenLayers.js")],mapjscustom=[S3.Ap.concat("/static/themes/Vulnerability/js/FeatureDoubleClick.js"),S3.Ap.concat("/static/themes/Vulnerability/js/SelectFeatureDouble.js"),S3.Ap.concat("/static/themes/Vulnerability/js/PanZoomBar.js"),S3.Ap.concat("/static/themes/Vulnerability/js/FramedCloudLocation.js"),S3.Ap.concat("/static/themes/Vulnerability/js/FramedCloudVolunteer.js")]):(mapjs=[S3.Ap.concat("/static/scripts/gis/OpenLayers.js")],
mapjscustom=[S3.Ap.concat("/static/themes/Vulnerability/js/OpenLayers.js")]);yepnope({load:mapjs,complete:function(){yepnope({load:mapjscustom,complete:function(){showMap()}})}});function nameSort(a,b){a=a.n;var c=[a,b.n];c.sort();return c[0]==a?-1:1}function resilienceClass(a){switch(a){case 1:return"one";case 2:return"two";case 3:return"three";case 4:return"four";case 5:return"five";default:return"none"}}
$(document).ready(function(){var a=$("#dummy_location_search"),b=a.val(),c=!1,d=function(a){switch(a.level){case "L0":return a.name;case "L1":return a.name+","+a.L0;case "L2":return a.name+","+a.L1+","+a.L0;case "L3":return a.name+","+a.L2+","+a.L1+","+a.L0;case "None":return a.label}return""},e=$("#location_search"),f=$("#dummy_location_search_throbber"),g=S3.Ap.concat("/gis/location/search.json?location.level__ne=None&filter=~&field=name&simple=1");a.autocomplete({delay:450,minLength:2,source:function(a,
b){$.ajax({url:g,data:{term:a.term},success:function(a){0==a.length&&a.push({id:0,value:0,level:"None",label:i18n.no_matching_records});b(a)}})},position:{my:"left bottom",at:"left top"},search:function(a,b){f.removeClass("hidden").show();return!0},response:function(a,b,c){f.hide();return c},focus:function(b,c){a.val(c.item.name);return!1},select:function(b,d){var f=d.item.id;f?(a.val(d.item.name),e.val(f).change(),$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+f),dataType:"script"}).done(function(a){for(var b in n)vdata[b]=
n[b];n=null;v_select_region(parseInt(d.item.level[1],10),f)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)})):(a.val(""),e.val("").change());c=!0;return!1}}).data("ui-autocomplete")._renderItem=function(a,b){var c=b.label?b.label:d(b);return $("<li>").data("item.autocomplete",b).append("<a>"+c+"</a>").appendTo(a)};a.blur(function(){e.val()||(e.val(""),c=!0);c?b=e.val():e.val(b);c=!1});var h=[],m=[],k,q=0,t;for(t in idata){var s=idata[t],q=q+1;
k="        <li>            <div class='indicatorRatingLabel'>                <div class='listText'>"+s.n+"</div>                <div class='popup'>                    <div class='popupContent'>                        <h3>"+s.n+"</h3>                        <p>"+s.d+"</p>                    </div>                    <div class='popupBottom'></div>                </div>            </div>            <div class='visRange'>                <div class='indicatorRange' id='visRange"+s.i+"'>                    <div class='leftBox'></div>                    <div class='medianDot'></div>                    <div class='rightBox'></div>                </div>            </div>        </li>";
m.push(k);k="        <li>            <div class='indicatorRatingLabel'>                <input name='analysisIndicators' type='radio' value='"+s.i+"' checked>                <div class='listText'>"+s.n+"</div>                <div class='popup'>                    <div class='popupContent'>                        <h3>"+s.n+"</h3>                        <p>"+s.d+"</p>                    </div>                    <div class='popupBottom'></div>                </div>            </div>            <div class='indicatorRating' id='indicatorRating"+
q+"'></div>        </li>";h.push(k)}$("#indicatorRatingChart ul").html(m.join(""));$("#regionIndicators ul").html(h.join(""));$("#indicatorSelector ul").html(h.join(""));var m=[],u;for(u in vdata)h=vdata[u],h.id=u,m.push(h);m.sort(nameSort);for(t=0;t<m.length;t++)h=m[t],u=resilienceClass(h.r),q=h.id,k=q==start?' selected="selected"':"",0===h.l?($("#l0_select, #l0_reports, #l0_datas, #l0_analysis1s").append('<option value="'+q+'" class="'+u+'"'+k+">"+h.n+"</option>"),$("#l0_analysis2s, #l0_analysis3s").append('<option value="'+
q+'" class="'+u+'">'+h.n+"</option>")):1==h.l&&$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").append('<option value="'+q+'" class="'+u+'">'+h.n+"</option>");start?$("#l1_analysis2, #l1_analysis3").hide():$("#l1, #l1_report, #l1_data, #l1_analysis1, #l1_analysis2, #l1_analysis3").hide();$("#l2, #l2_report, #l2_data, #l2_analysis1, #l2_analysis2, #l2_analysis3").hide();$("#l3, #l3_report, #l3_data, #l3_analysis1, #l3_analysis2, #l3_analysis3").hide();$("#l0_select, #l0_reports, #l0_datas").change(function(){for(var a=
1;3>=a;a++)$("#l"+a+", #l"+a+"_report, #l"+a+"_data, #l"+a+"_analysis1").hide(),$("#l"+a+"_select, #l"+a+"_reports, #l"+a+"_datas, #l"+a+"_analysis1s").val("");if(a=this.value){$("#lx_select_throbber, #lx_report_throbber, #lx_data_throbber").removeClass("hidden").show();var b=hdata[a];$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").html('<option value="" selected="selected" class="none">Choose '+b.l1+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,0,!1):lx_select(a,0,!1)}indicatorsCheckCommune()});
$("#l1_select, #l1_reports, #l1_datas").change(function(){for(var a=2;3>=a;a++)$("#l"+a+", #l"+a+"_report, #l"+a+"_data, #l"+a+"_analysis1").hide(),$("#l"+a+"_select, #l"+a+"_reports, #l"+a+"_datas, #l"+a+"_analysis1s").val("");if(a=this.value){$("#lx_select_throbber, #lx_report_throbber, #lx_data_throbber").removeClass("hidden").show();var b=hdata[$("#"+this.id.replace("1","0")).val()];$("#l2_select, #l2_reports, #l2_datas, #l2_analysis1s").html('<option value="" selected="selected" class="none">Choose '+
b.l2+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,1,!1):lx_select(a,1,!1)}indicatorsCheckCommune()});$("#l2_select, #l2_reports, #l2_datas").change(function(){for(var a=3;3>=a;a++)$("#l"+a+", #l"+a+"_report, #l"+a+"_data, #l"+a+"_analysis1").hide(),$("#l"+a+"_select, #l"+a+"_reports, #l"+a+"_datas, #l"+a+"_analysis1s").val("");if(a=this.value){$("#lx_select_throbber, #lx_report_throbber, #lx_data_throbber").removeClass("hidden").show();var b=hdata[$("#"+this.id.replace("2","0")).val()];
$("#l3_select, #l3_reports, #l3_datas, #l3_analysis1s").html('<option value="" selected="selected" class="none">Choose '+b.l3+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,2,!1):lx_select(a,2,!1)}indicatorsCheckCommune()});$("#l3_select, #l3_reports, #l3_datas").change(function(){indicatorsCheckCommune()});$("#l0_analysis1s").change(function(){for(var a=1;3>=a;a++)$("#l"+a+"_analysis1").hide().val("");if(a=this.value){$("#lx_analysis1_throbber").removeClass("hidden").show();var b=hdata[a];
$("#l1_analysis1s").html('<option value="" selected="selected" class="none">Choose '+b.l1+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,0,1):lx_select(a,0,1)}else analysisSelectLocation(null,1)});$("#l0_analysis2s").change(function(){for(var a=1;3>=a;a++)$("#l"+a+"_analysis2").hide().val("");if(a=this.value){$("#lx_analysis2_throbber").removeClass("hidden").show();var b=hdata[a];$("#l1_analysis2s").html('<option value="" selected="selected" class="none">Choose '+b.l1+"</option>");"undefined"===
typeof vdata[a].i?readHierarchy(a,0,2):lx_select(a,0,2)}else analysisSelectLocation(null,2)});$("#l0_analysis3s").change(function(){for(var a=1;3>=a;a++)$("#l"+a+"_analysis3").hide().val("");if(a=this.value){$("#lx_analysis3_throbber").removeClass("hidden").show();var b=hdata[a];$("#l1_analysis3s").html('<option value="" selected="selected" class="none">Choose '+b.l1+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,0,3):lx_select(a,0,3)}else analysisSelectLocation(null,3)});$("#l1_analysis1s").change(function(){for(var a=
2;3>=a;a++)$("#l"+a+"_analysis1").hide().val("");if(a=this.value){$("#lx_analysis1_throbber").removeClass("hidden").show();var b=hdata[$("#l0_analysis1s").val()];$("#l2_analysis1s").html('<option value="" selected="selected" class="none">Choose '+b.l2+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,1,1):lx_select(a,1,1)}else analysisSelectLocation($("#l0_analysis1s").val(),1)});$("#l1_analysis2s").change(function(){for(var a=2;3>=a;a++)$("#l"+a+"_analysis2").hide().val("");if(a=this.value){$("#lx_analysis2_throbber").removeClass("hidden").show();
var b=hdata[$("#l0_analysis2s").val()];$("#l2_analysis2s").html('<option value="" selected="selected" class="none">Choose '+b.l2+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,1,2):lx_select(a,1,2)}else analysisSelectLocation($("#l0_analysis2s").val(),2)});$("#l1_analysis3s").change(function(){for(var a=2;3>=a;a++)$("#l"+a+"_analysis3").hide().val("");if(a=this.value){$("#lx_analysis3_throbber").removeClass("hidden").show();var b=hdata[$("#l0_analysis3s").val()];$("#l2_analysis3s").html('<option value="" selected="selected" class="none">Choose '+
b.l2+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,1,3):lx_select(a,1,3)}else analysisSelectLocation($("#l0_analysis3s").val(),3)});$("#l2_analysis1s").change(function(){for(var a=3;3>=a;a++)$("#l"+a+"_analysis1").hide().val("");if(a=this.value){$("#lx_analysis1_throbber").removeClass("hidden").show();var b=hdata[$("#l0_analysis1s").val()];$("#l3_analysis1s").html('<option value="" selected="selected" class="none">Choose '+b.l3+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,
2,1):lx_select(a,2,1)}else analysisSelectLocation($("#l1_analysis1s").val(),1)});$("#l2_analysis2s").change(function(){for(var a=3;3>=a;a++)$("#l"+a+"_analysis2").hide().val("");if(a=this.value){$("#lx_analysis2_throbber").removeClass("hidden").show();var b=hdata[$("#l0_analysis2s").val()];$("#l3_analysis2s").html('<option value="" selected="selected" class="none">Choose '+b.l3+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,2,2):lx_select(a,2,2)}else analysisSelectLocation($("#l1_analysis2s").val(),
2)});$("#l2_analysis3s").change(function(){for(var a=3;3>=a;a++)$("#l"+a+"_analysis3").hide().val("");if(a=this.value){$("#lx_analysis3_throbber").removeClass("hidden").show();var b=hdata[$("#l0_analysis3s").val()];$("#l3_analysis3s").html('<option value="" selected="selected" class="none">Choose '+b.l3+"</option>");"undefined"===typeof vdata[a].i?readHierarchy(a,2,3):lx_select(a,2,3)}else analysisSelectLocation($("#l1_analysis3s").val(),3)});$("#l3_analysis1s").change(function(){analysisSelectLocation(this.value,
1)});$("#l3_analysis2s").change(function(){analysisSelectLocation(this.value,2)});$("#l3_analysis3s").change(function(){analysisSelectLocation(this.value,3)});updateSelectMenus(!1);k=$("#analysisControl2 select, #analysisControl3 select");try{k.selectmenu("destroy")}catch(v){}k.selectmenu({style:"popup",maxHeight:280,width:165,menuWidth:165});k=$("#analysisIndicator");try{k.selectmenu("destroy")}catch(w){}k.selectmenu({style:"popup",maxHeight:120,width:145,menuWidth:145});$(window).resize(function(){$("#reportsSection").is(":visible")?
resizeReports():$("#submitDataSection").is(":visible")&&resizeSubmitData()});$("#dateFromReports").datepicker({dateFormat:"yy-mm-dd",changeYear:!0,changeMonth:!0,maxDate:"+0d",minDate:"-20y"});$("#dateToReports").datepicker({dateFormat:"yy-mm-dd",changeYear:!0,changeMonth:!0,maxDate:"+0d",minDate:"-20y"});resizeSubmitData();resizeReports();TypeHelpers.insertClasses();$(".closechromeframe").click(function(){$(".chromeframe").hide()});$("#globalBreadCrumb").click(function(){globalView()});$("#show-hide").click(function(){drawerSlide()});
$("#risingTab").click(function(){drawerSlide()});$("#newRegion").click(function(){goToRegion()});$("#analysisLink").click(function(){analysisView()});$("#analysisIndicator").change(function(){toggleAnalysis()});$("#backToMap").click(function(){hideAnalysis()});$("#analysisReset1").click(function(){analysisReset(1)});$("#analysisReset2").click(function(){analysisReset(2)});$("#analysisReset3").click(function(){analysisReset(3)});$(".calculationLink").click(function(){$("#lightbox, #calculationView").fadeIn(300)});
$("#calculationView .closePanel").click(function(){$("#lightbox, #calculationView").fadeOut(300)});$(".headerRow").click(function(){$(".rowForApproval").hide();$(".rowForApproval").prev().find(".closeReviewButton").hide();$(".rowForApproval").prev().find(".reviewButton").show();$(".headerRow.activeSection td.arrowCell .arrow").html("&rarr;");$(".headerRow.activeSection").removeClass("activeSection");$(this).addClass("activeSection");$(".headerRow.activeSection .arrow").html("&darr;");$(".activeContent").hide("slow");
$(".activeContent").removeClass("activeContent");$(this).next().addClass("activeContent");$(this).parent().next().addClass("activeContent");$(".activeContent").fadeIn(200);resizeReports()});$("#filterSubmit, .panelSearchSubmit").click(filterReport);$("#l3_datas").change(indicatorsCheckCommune);$("#submitIndicators").click(function(){showSubmitData("indicators")});$("#submitReports").click(function(){showSubmitData("reports")});$("#uploadIndicatorsButton").click(uploadSubmitDataIndicators);$("#submitDataFooter .reviewNextButton").click(nextSubmitDataReview);
$("#submitDataFooter .backButton").click(backSubmitDataReview);$("#submitDataFooter .cancelButton").click(cancelSubmitDataTypeSelection);$("#submitDataFooter .submitAllButton").click(submitImportSubmitData);$("#submitDataFooter .submitMoreButton").click(moreSubmitData);$("#uploadDemographicsButton").click(demographicsLoader);$("#submitOnlineButton").click(function(){$(this).hasClass("disabled")||displaySubmitOnline()});$("#submitDataFooter .reviewSubmissionButton").click(function(){reviewSubmitData()});
$("#submitDataFooter .submitButton").click(function(){$(this).hasClass("disabled")||($(".submitIndicatorsForm").is(":visible")?submitSubmitData():uploadSubmitDataReport(this))});$(".submitIndicatorsForm input").change(function(){10==$(".submitIndicatorsForm input:radio:checked").length&&$("#submitDataFooter .reviewSubmissionButton").removeClass("disabled")});$(".dataSubmissionRegion input:radio").change(selectOptionSubmitData);$("#lightbox").click(function(){$("#lightbox, #reportsSection, #calculationView, #photoPanel, #submitDataSection").fadeOut(300)});
$("#reportsSection .closePanel").click(function(){$("#lightbox, #reportsSection").fadeOut(300)});$("#submitDataSection .closePanel").click(function(){$("#submitDataContent").animate({scrollTop:0},100);$("#lightbox, #submitDataSection").fadeOut(300)});$("#dataTopBar").hover(function(){$("#dataTopBar img").css("background-color","#f7941d");$("#dataTopBar img").attr("src",S3.Ap.concat("/static/themes/Vulnerability/img/dropdownArrowOverPng8.png"));$("#dataOptions").fadeIn(150);$("#defaultDataLink").css("color",
"#c47a21")},function(){$("#dataTopBar img").css("background-color","transparent");$("#dataTopBar img").attr("src",S3.Ap.concat("/static/themes/Vulnerability/img/dropdownArrowPng8.png"));$("#dataOptions").fadeOut(150);$("#defaultDataLink").css("color","#f7941d")});$("#reportsTopBar").hover(function(){$("#reportsTopBar img").css("background-color","#f7941d");$("#reportsTopBar img").attr("src",S3.Ap.concat("/static/themes/Vulnerability/img/dropdownArrowOverPng8.png"));$("#reportsOptions").fadeIn(150);
$("#defaultReportsLink").css("color","#c47a21")},function(){$("#reportsTopBar img").css("background-color","transparent");$("#reportsTopBar img").attr("src",S3.Ap.concat("/static/themes/Vulnerability/img/dropdownArrowPng8.png"));$("#reportsOptions").fadeOut(150);$("#defaultReportsLink").css("color","#f7941d")});$(".listText").hover(function(){$(this).siblings(".popup").show()},function(){$(this).siblings(".popup").hide()});$("#subGeo, .currentQuality").hover(function(){var a=$(this).find(".popup");
$(a).data("timeout",setTimeout(function(){showSubGeo(a,200)},200))},function(){var a=$(this).find(".popup");hideSubGeo(a,200);clearTimeout($(a).data("timeout"))})});function showSubGeo(a,b){"undefined"!==typeof activeWindow&&(clearTimeout(activeWindow.data("timeout")),activeWindow.fadeOut(b));a.fadeIn(b);activeWindow=a}function hideSubGeo(a,b){a.fadeOut(b)}
function readHierarchy(a,b,c){$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+a),dataType:"script"}).done(function(d){for(var e in n)vdata[e]=n[e];n=null;lx_select(a,b,c)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText})}
function lx_select(a,b,c){if(0===b)if(c)$("#l"+b+"_analysis"+c+"s").val(a);else{$("#l0_select, #l0_reports, #l0_datas, #l0_analysis1s").val(a);var d=hdata[a];$("#l1 label, #l1_report label, #l1_data label").html(d.l1.toUpperCase()+":");$("#l2 label, #l2_report label, #l2_data label").html(d.l2.toUpperCase()+":");$("#l3 label, #l3_report label, #l3_data label").html(d.l3.toUpperCase()+":")}b+=1;if(c)for($("#lx_analysis"+c+"_throbber").hide(),$("#l"+b+"_analysis"+c).show(),d=b+1;4>d;d++)$("#l"+d+"_analysis"+
c).hide().val("");else for($("#lx_select_throbber, #lx_report_throbber, #lx_data_throbber").hide(),$("#l"+b+", #l"+b+"_report, #l"+b+"_data, #l"+b+"_analysis1").show(),d=b+1;4>d;d++)$("#l"+d+", #l"+d+"_report, #l"+d+"_data, #l"+d+"_analysis1").hide(),$("#l"+d+"_select, #l"+d+"_reports, #l"+d+"_datas, #l"+d+"_analysis1s").val("");var d=[],e,f;for(f in vdata)e=vdata[f],e.f==a&&(e.id=f,d.push(e));d.sort(nameSort);var g;for(f=0;f<d.length;f++)e=d[f],g=resilienceClass(e.r),e='<option value="'+e.id+'" class="'+
g+'">'+e.n+"</option>",c?$("#l"+b+"_analysis"+c+"s").append(e):$("#l"+b+"_select, #l"+b+"_reports, #l"+b+"_datas, #l"+b+"_analysis1s").append(e);updateSelectMenus(c);c&&analysisSelectLocation(a,c)}
function updateL1Menus(){$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+current_l0),async:!0,dataType:"script"}).done(function(a){var b,c;for(b in n)vdata.hasOwnProperty(b)||(vdata[b]=n[b]);n=null;a=[];for(b in vdata)c=vdata[b],c.f==current_l0&&(c.id=b,a.push(c));a.sort(nameSort);var d;$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").html("");for(b=0;b<a.length;b++)c=a[b],d=resilienceClass(c.r),c='<option value="'+c.id+'" class="'+d+'">'+c.n+"</option>",$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").append(c);
$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").val(current_l1);updateSelectMenus(!1)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)})}
function updateSelectMenus(a){if(a){a=$("#analysisControl"+a+" select");try{a.selectmenu("destroy")}catch(b){}}else{a=$("#browseOtherRegions select");try{a.selectmenu("destroy")}catch(c){}a.selectmenu({style:"popup",maxHeight:280,width:160,menuWidth:160,icons:[{find:".one"},{find:".two"},{find:".three"},{find:".four"},{find:".five"}]});a=$(".locationFilters select");try{a.selectmenu("destroy")}catch(d){}a.selectmenu({style:"popup",maxHeight:280,width:160,menuWidth:160,icons:[{find:".one"},{find:".two"},
{find:".three"},{find:".four"},{find:".five"}]});a=$("#chartSwitcher");try{a.selectmenu("destroy")}catch(e){}a.selectmenu({style:"popup",maxHeight:280,width:125,menuWidth:125});a=$("#analysisControl1 select");try{a.selectmenu("destroy")}catch(f){}}a.selectmenu({style:"popup",maxHeight:280,width:165,menuWidth:165})}
function showMap(){OpenLayers.ImgPath=S3.Ap.concat("/static/img/gis/openlayers/");proj4326=new OpenLayers.Projection("EPSG:4326");map=new OpenLayers.Map("map",{theme:null});var a=new OpenLayers.Layer.WMS("VMap0","http://vmap0.tiles.osgeo.org/wms/vmap0",{layers:"basic"},{wrapDateLine:!0});map.addLayer(a);OpenLayers.Control.PanZoom.X=25;OpenLayers.Control.PanZoom.Y=65;a=new OpenLayers.Control.PanZoomBar;map.addControl(a);parser=new OpenLayers.Format.GeoJSON({});var a=new OpenLayers.Style({fillColor:"${fill}",
fillOpacity:"${fillOpacity}",strokeColor:"#ffffff",strokeWidth:"${strokeWidth}",strokeOpacity:1,graphicWidth:14,graphicHeight:14,graphicXOffset:-7,graphicYOffset:-14,graphicZIndex:"${zIndex}",graphicOpacity:1,externalGraphic:"${externalGraphic}"},{context:{fill:function(a){return colors[a.attributes.r]},fillOpacity:function(a){return a.attributes.outline?0.1:0.5},strokeWidth:function(a){return a.attributes.outline?2:1},zIndex:function(a){var b=a.attributes.l;0===a.geometry.getArea()?b+=10:a.attributes.outline&&
(b-=1);return b},externalGraphic:function(a){if(0===a.geometry.getArea()){a=a.attributes.r;if(5==a)a="/static/themes/Vulnerability/img/rating5.png";else if(4==a)a="/static/themes/Vulnerability/img/rating4.png";else if(3==a)a="/static/themes/Vulnerability/img/rating3.png";else if(2==a)a="/static/themes/Vulnerability/img/rating2.png";else if(1==a)a="/static/themes/Vulnerability/img/rating1.png";else return"";return S3.Ap.concat(a)}return""}}}),a=new OpenLayers.StyleMap({"default":a,select:{fillOpacity:1}}),
b=new OpenLayers.Strategy.Fixed,c=new OpenLayers.Protocol({});resilienceLayer=new OpenLayers.Layer.Vector("Resilience",{strategies:[b],protocol:c,styleMap:a,rendererOptions:{zIndexing:!0}});populationLayer=new OpenLayers.Layer.WMS("Population Density","http://rmsgeo.aidiq.com/geoserver/gwc/service/wms",{layers:"ifrc:populationDensity"},{wrapDateLine:!0,isBaseLayer:!1});populationLayer.params.STYLES="populationDensityGrey";populationLayer.opacity=0.8;a=new OpenLayers.Style({graphicWidth:"${graphicWidth}",
graphicHeight:"${graphicHeight}",graphicXOffset:"${graphicXOffset}",graphicYOffset:"${graphicYOffset}",externalGraphic:"${externalGraphic}"},{context:{graphicWidth:function(a){return a.cluster?26:15},graphicHeight:function(a){return a.cluster?44:32},graphicXOffset:function(a){return a.cluster?-13:-7},graphicYOffset:function(a){return a.cluster?-58:-46},externalGraphic:function(a){return S3.Ap.concat(a.cluster?"/static/themes/Vulnerability/img/volunteer.png":"/static/themes/Vulnerability/img/volunteerIconOnPng8.png")}}});
a=new OpenLayers.StyleMap({"default":a});volunteerLayer=new OpenLayers.Layer.Vector("Volunteers",{strategies:[new OpenLayers.Strategy.BBOX({ratio:1.5}),new OpenLayers.Strategy.Cluster({distance:20,threshold:2})],styleMap:a,protocol:new OpenLayers.Protocol.HTTP({url:S3.Ap.concat("/vol/volunteer.geojson?components=None&maxdepth=0&references=location_id&fields=name&attr=person_id,phone,email&human_resource.status=1"),format:new OpenLayers.Format.GeoJSON})});a=new OpenLayers.Style({graphicWidth:"${graphicWidth}",
graphicHeight:"${graphicHeight}",graphicXOffset:"${graphicXOffset}",graphicYOffset:"${graphicYOffset}",graphicZIndex:20,externalGraphic:"${externalGraphic}"},{context:{graphicWidth:function(a){return a.cluster?46:18},graphicHeight:function(a){return a.cluster?61:31},graphicXOffset:function(a){return a.cluster?-23:-9},graphicYOffset:function(a){return a.cluster?-75:-45},externalGraphic:function(a){return S3.Ap.concat(a.cluster?"/static/themes/Vulnerability/img/map.png":"/static/themes/Vulnerability/img/mapIconOnPng8.png")}}});
a=new OpenLayers.StyleMap({"default":a});mapLayer=new OpenLayers.Layer.Vector("Maps",{strategies:[new OpenLayers.Strategy.BBOX({ratio:1.5}),new OpenLayers.Strategy.Cluster({distance:20,threshold:2})],styleMap:a,protocol:new OpenLayers.Protocol.HTTP({url:S3.Ap.concat("/vulnerability/handdrawn.geojson?components=None&maxdepth=0&references=location_id&fields=name"),format:new OpenLayers.Format.GeoJSON}),rendererOptions:{zIndexing:!0}});popupControl=new OpenLayers.Control.SelectFeatureDouble([resilienceLayer,
volunteerLayer],{toggle:!0});popupControl.handlers.feature.callbacks.dblclick=function(a){if("Resilience"==a.layer.name){this.handlers.feature.stopDouble=!0;var b=a.attributes.id;void 0==vdata[b].q?$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+b),async:!1,dataType:"script"}).done(function(c){for(var g in n)vdata[g]=n[g];n=null;v_select_region(a.attributes.l,b)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)}):v_select_region(a.attributes.l,b)}else this.handlers.feature.stopDouble=
!1};map.addLayer(resilienceLayer);resilienceLayer.events.on({beforefeatureadded:addAttributes,featureselected:onResilienceFeatureSelect,featureunselected:onFeatureUnselect});enableResilienceLayer();""===start?globalView():v_select_region(0,start);map.addControl(popupControl);popupControl.activate();$("#resilienceCheck").change(function(){$("#resilienceCheck").is(":checked")?enableResilienceLayer():disableResilienceLayer()});$("#populationCheck").change(function(){$("#populationCheck").is(":checked")?
map.addLayer(populationLayer):map.removeLayer(populationLayer)});$("#iconsCheck").change(function(){$("#iconsCheck").is(":checked")?(enableVolunteerLayer(),enableMapLayer()):(disableVolunteerLayer(),map.removeLayer(mapLayer))});map.events.on({zoomend:function(a){a=map.getZoom();var b=map.getLayersByName("Population Density").length;9<a?($("#populationKey label").css("color","#ccc"),$("#populationCheck").hide(),b&&map.removeLayer(populationLayer)):($("#populationKey label").css("color",""),$("#populationCheck").show(),
$("#populationCheck").is(":checked")&&!b&&map.addLayer(populationLayer))}})}
function enableResilienceLayer(){$.ajax({url:S3.Ap.concat("/static/cache/countries.geojson"),async:!1,dataType:"json"}).done(function(a){a=parser.read(a);var b=[],c=map.getProjectionObject(),d;for(d in a)try{a[d].geometry.transform(proj4326,c),b.push(a[d])}catch(e){}resilienceLayer.addFeatures(b)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});current_l0&&$.ajax({url:S3.Ap.concat("/static/cache/1_"+current_l0+".geojson"),async:!1,dataType:"json"}).done(function(a){a=
parser.read(a);var b=[],c=map.getProjectionObject(),d;for(d in a)try{a[d].geometry.transform(proj4326,c),b.push(a[d])}catch(e){}resilienceLayer.addFeatures(b)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});current_l1&&$.ajax({url:S3.Ap.concat("/static/cache/2_"+current_l1+".geojson"),async:!1,dataType:"json"}).done(function(a){a=parser.read(a);var b=[],c=map.getProjectionObject(),d;for(d in a)try{a[d].geometry.transform(proj4326,c),b.push(a[d])}catch(e){}resilienceLayer.addFeatures(b)}).fail(function(a,
b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});current_l2&&$.ajax({url:S3.Ap.concat("/static/cache/3_"+current_l2+".geojson"),async:!1,dataType:"json"}).done(function(a){a=parser.read(a);var b=[],c=map.getProjectionObject(),d;for(d in a)try{a[d].geometry.transform(proj4326,c),b.push(a[d])}catch(e){}resilienceLayer.addFeatures(b)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});popupControl.unselectAll()}
function disableResilienceLayer(){resilienceLayer.removeAllFeatures()}function enableVolunteerLayer(){map.addLayer(volunteerLayer);volunteerLayer.events.on({featureselected:onVolunteerFeatureSelect,featureunselected:onFeatureUnselect});map.raiseLayer(volunteerLayer,2)}function disableVolunteerLayer(){volunteerLayer.removeAllFeatures();map.removeLayer(volunteerLayer)}function enableMapLayer(){map.addLayer(mapLayer)}
function addAttributes(a){var b=a.feature,c=b.attributes;a=c.id;"undefined"===typeof vdata[a]&&$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+a),async:!1,dataType:"script"}).done(function(a){for(var b in n)vdata[b]=n[b];n=null}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});var d=vdata[a],e=d.l,d=d.r;c.l=e;c.r=d;if(1<e&&(b=b.geometry,0!==b.getArea()))try{var f=new OpenLayers.Feature.Vector(b.getCentroid(!0),{id:parseInt(a,10),l:e,r:d});resilienceLayer.addFeatures([f])}catch(g){}}
function onFeatureUnselect(a){a=a.feature;a.popup&&($(".ui-selectmenu-menu").removeClass("ui-selectmenu-open"),map.removePopup(a.popup),a.popup.destroy(),delete a.popup)}
function onResilienceFeatureSelect(a){drawerOpen&&drawerSlide();a=a.feature;var b=a.geometry.getBounds().getCenterLonLat();map.setCenter(b);var c=a.attributes.id,d=a.attributes.l,e="    <h3>"+i18n.data_quality.toUpperCase()+":</h3>     <div class='windowQualityRatings'>        <div class='poor'>"+i18n.poor.toUpperCase()+"            <div class='popup'>                <div class='popupContent'>                    <h3>"+i18n.poor.toUpperCase()+"</h3>                    <p>0&ndash;25% "+i18n.of_total_data_reported+
".</p>                </div>                <div class='popupBottom'></div>            </div>        </div> |         <div class='fair'>"+i18n.fair.toUpperCase()+"            <div class='popup'>                <div class='popupContent'>                    <h3>"+i18n.fair.toUpperCase()+"</h3>                    <p>25&ndash;50% "+i18n.of_total_data_reported+".</p>                </div>                <div class='popupBottom'></div>            </div>        </div> |         <div class='moderate'>"+i18n.moderate.toUpperCase()+
"            <div class='popup'>                <div class='popupContent'>                    <h3>"+i18n.moderate.toUpperCase()+"</h3>                    <p>50&ndash;75% "+i18n.of_total_data_reported+".</p>                </div>                <div class='popupBottom'></div>            </div>        </div> |         <div class='strong'>"+i18n.strong.toUpperCase()+"            <div class='popup'>                <div class='popupContent'>                    <h3>"+i18n.strong.toUpperCase()+"</h3>                    <p>75&ndash;100% "+
i18n.of_total_data_reported+".</p>                </div>                <div class='popupBottom'></div>            </div>        </div>    </div>",f=vdata[c],g,h,m,k,q;switch(d){case 0:g=hdata[c];h=i18n.country;m=i18n.country.toUpperCase();k=g.l1.toUpperCase();q=g.l3;g="            <h3>"+k+"S "+i18n.in_this.toUpperCase()+" "+m+":</h3>            <select class='subGeoSelect hidden'></select>            <span id='subGeo_throbber' class='throbber'></span>\t\t\t<a id='goToSubRegion' class='goToSubRegion'>"+
i18n.go_to_the.toUpperCase()+" "+k+" <span class='arrow'>&rarr;</span></a>";break;case 1:g=hdata[current_l0];h=g.l1;m=h.toUpperCase();k=g.l2.toUpperCase();q=g.l3;g="            <h3>"+k+"S "+i18n.in_this.toUpperCase()+" "+m+":</h3>            <select class='subGeoSelect hidden'></select>            <span id='subGeo_throbber' class='throbber'></span>\t\t\t<a id='goToSubRegion' class='goToSubRegion'>"+i18n.go_to_the.toUpperCase()+" "+k+" <span class='arrow'>&rarr;</span></a>";break;case 2:g=hdata[current_l0];
h=g.l2;m=h.toUpperCase();k=g.l3.toUpperCase();q=g.l3;g="            <h3>"+k+"S "+i18n.in_this.toUpperCase()+" "+m+":</h3>            <select class='subGeoSelect hidden'></select>            <span id='subGeo_throbber' class='throbber'></span>\t\t\t<a id='goToSubRegion' class='goToSubRegion'>"+i18n.go_to_the.toUpperCase()+" "+k+" <span class='arrow'>&rarr;</span></a>";break;case 3:g=hdata[current_l0],h=g.l3,m=h.toUpperCase(),g="",e="<div class='lastCollected'></div>"}var t=f.n;k=f.r;0===k&&(k="");q&&
(e+="<div class='subGeoCommunesReported'></div>");h="    <section class='infoWindow'>\t\t<div class='infoWindowMain unselectable'>\t\t\t<div id='subGeoIndicator'>"+k+"</div>\t\t\t<h2 class='subGeoName'>"+t+"</h2>\t\t\t<h2 class='subGeoType'>"+h+"</h2>\t\t\t<a id='goToRegion' class='goToSubRegion'>"+i18n.go_to_the.toUpperCase()+" "+m+" <span class='arrow'>&rarr;</span></a>\t\t\t"+e+"\t\t\t<h3 id='population'>"+i18n.population.toUpperCase()+": </h3>\t\t\t"+g+"\t\t\t<div class='infoWindowButtons'>\t\t\t\t<div class='subGeoSubmitDataButton'>"+
i18n.submit_data+"</div>\t\t\t\t<div class='subGeoAnalysisButton'>"+i18n.analysis+"</div>\t\t\t\t<div class='subGeoReportsButton'>"+i18n.reports+"</div>\t\t\t</div>\t\t</div>\t</section>";var s=new OpenLayers.Popup.FramedCloudLocation(c.toString(),b,new OpenLayers.Size(200,200),h,null,!0,closePopups);a.popup=s;map.addPopup(s);"p"in f?fillPopup(f,d,c,s,q):$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+c),dataType:"script"}).done(function(a){for(var b in n)vdata[b]=n[b];n=null;f=vdata[c];fillPopup(f,
d,c,s,q)}).fail(function(a,b,d){msg="UNAUTHORIZED"==d?i18n.gis_requires_login:a.responseText;$("#"+c+"_contentDiv").html(msg);s.updateSize()});""===k?$("#subGeoIndicator").css("background-color",colors[0]):$("#subGeoIndicator").css("background-color",colors[k]);$(".subGeoSubmitDataButton").click(function(){$("#l"+d+"_datas").val(c);$("#l"+d+"_datas").change();showSubmitData("indicators")});$(".subGeoAnalysisButton").click(function(){$("#l"+d+"_analysis1s").val(c);$("#l"+d+"_analysis1s").change();
analysisView()});$(".subGeoReportsButton").click(function(){v_select_region(d,c);$("#l"+d+"_reports").val(c);$("#lightbox, #reportsSection").fadeIn(300);filterReport()});$(".olPopup").css("overflow","visible");$(".olPopup > div").css("overflow","visible")}
function fillPopup(a,b,c,d,e){$("#subGeo_throbber").hide();$(".subGeoSelect").removeClass("hidden").show();e?$(".subGeoCommunesReported").html(a.c+" "+i18n.out_of+" "+a.t+" "+e+"s "+i18n.reported):$(".windowQualityRatings").html(i18n.last_data_collected_on+" "+a.d+" "+i18n.by+" "+a.w);(e=a.p)&&$("#population").html(i18n.population.toUpperCase()+": "+e);$("#goToRegion").click(function(){$("#subGeo_throbber").show();v_select_region(b,c)});if(3==b){var f=a.m,g=f.length;if(g){var h=f[0],m=S3.Ap.concat("/default/download/"),
k=m.concat(h[0]),q;if(1<g){var t=f[1],s=m.concat(t[0]);q="<img class='secondImage' src='"+s+"'/>"}else q="";infoWindowImages="            <div class='infoWindowImages'>                <img class='firstImage' src='"+k+"'/>                "+q+"            </div>";$("#population").after(infoWindowImages);$(".firstImage").click(function(){var a=h[2],b=m.concat(h[1]);$(".leftBar").append("<img class='activeImage' src='"+k+"' alt='"+a+"' index=0 />");$(".photoCaption a").attr("href",b).attr("alt",a);$(".photoDescription").html(a+
" "+i18n.submitted_by+" "+h[3]);$(".photoPane > img").attr("src",b).attr("alt",a);for(a=1;a<g;a++)b=f[a],$(".leftBar").append("<img src='"+m.concat(b[0])+"' alt='"+b[2]+"' index='"+a+"' />");$(".leftBar img").click(function(){$(".activeImage").removeClass("activeImage");var a=this.attributes,b;for(b in a)if("index"==a[b].nodeName){var c=a[b].nodeValue;$('.leftBar img[index="'+c+'"]').addClass("activeImage")}a=f[c];b=a[2];var d=m.concat(a[1]);$(".photoCaption a").attr("href",d).attr("alt",b);$(".photoDescription").html(b+
" "+i18n.submitted_by+" "+a[3]);$(".photoPane > img").attr("src",d).attr("alt",b);c++;$(".photoNumber").html(c+" "+i18n.of+" "+g)});$("#lightbox, #photoPanel").fadeIn(300);$(".photoNumber").html("1 "+i18n.of+" "+g);$("#photoPanel .closePanel").click(function(){$("#lightbox, #photoPanel").fadeOut(300);$(".leftBar").html("")})});$(".secondImage").click(function(){var a=t[2],b=m.concat(t[1]);$(".leftBar").append("<img src='"+k+"' alt='"+f[0][2]+"' index=0 />");$(".leftBar").append("<img class='activeImage' src='"+
s+"' alt='"+a+"' index=1 />");$(".photoCaption a").attr("href",b).attr("alt",a);$(".photoDescription").html(a+" "+i18n.submitted_by+" "+t[3]);$(".photoPane > img").attr("src",b).attr("alt",a);for(a=2;a<g;a++)b=f[a],$(".leftBar").append("<img src='"+m.concat(b[0])+"' alt='"+b[2]+"' index='"+a+"' />");$(".leftBar img").click(function(){$(".activeImage").removeClass("activeImage");var a=this.attributes,b;for(b in a)if("index"==a[b].nodeName){var c=a[b].nodeValue;$('.leftBar img[index="'+c+'"]').addClass("activeImage")}a=
f[c];b=a[2];var d=m.concat(a[1]);$(".photoCaption a").attr("href",d).attr("alt",b);$(".photoDescription").html(b+" "+i18n.submitted_by+" "+a[3]);$(".photoPane > img").attr("src",d).attr("alt",b);c++;$(".photoNumber").html(c+" "+i18n.of+" "+g)});$("#lightbox, #photoPanel").fadeIn(300);$(".photoNumber").html("2 "+i18n.of+" "+g);$("#photoPanel .closePanel").click(function(){$("#lightbox, #photoPanel").fadeOut(300);$(".leftBar").html("")})})}}else{switch(a.q){case "p":$(".poor").addClass("currentQuality").hover(function(){$(this).find(".popup").show()},
function(){$(this).find(".popup").hide()});break;case "f":$(".fair").addClass("currentQuality").hover(function(){$(this).find(".popup").show()},function(){$(this).find(".popup").hide()});break;case "m":$(".moderate").addClass("currentQuality").hover(function(){$(this).find(".popup").show()},function(){$(this).find(".popup").hide()});break;case "s":$(".strong").addClass("currentQuality").hover(function(){$(this).find(".popup").show()},function(){$(this).find(".popup").hide()})}a=[];for(q in vdata)e=
vdata[q],e.l==b+1&&e.f==c&&(e.id=q,a.push(e));a.sort(nameSort);for(var u=0;u<a.length;u++)e=a[u],q=resilienceClass(e.r),$(".subGeoSelect").append('<option value="'+e.id+'" class="'+q+'">'+e.n+"</option>");$(".subGeoSelect").selectmenu({style:"popup",maxHeight:280,width:165,menuWidth:165,icons:[{find:".one"},{find:".two"},{find:".three"},{find:".four"},{find:".five"}]});$("#goToSubRegion").click(function(){$("#subGeo_throbber").show();var a=$(".subGeoSelect").val();void 0==vdata[a].q?$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+
a),async:!1,dataType:"script"}).done(function(c){for(var d in n)vdata[d]=n[d];n=null;v_select_region(b+1,a)}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)}):v_select_region(b+1,a)})}d.updateSize()}
function onVolunteerFeatureSelect(a){a=a.feature;var b=a.geometry.getBounds().getCenterLonLat(),c;if(a.cluster){c="";for(var d=0;d<a.cluster.length;d++)c+=a.attributes.person_id+"<br/>"}else d=a.attributes,c="<strong>"+d.person_id+"</strong>",d.phone&&(c+="<br/>"+d.phone),d.email&&(c+='<br/><a href="mailto:'+d.email+'">'+d.email+"</a>");c="<section id='volPopup'>               "+c+"                </section>";b=new OpenLayers.Popup.FramedCloudVolunteer(S3.uid(),b,new OpenLayers.Size(200,200),c,null,
!0,closePopups);a.popup=b;map.addPopup(b)}function closePopups(a){for(;map.popups.length;)map.removePopup(map.popups[0]);$(".ui-selectmenu-menu").removeClass("ui-selectmenu-open")}function hideFeature(a){a=resilienceLayer.getFeaturesByAttribute("id",parseInt(a,10));for(var b in a)try{var c=a[b];0===c.geometry.getArea()?c.destroy():(c.attributes.outline=1,resilienceLayer.drawFeature(c))}catch(d){}}
function showFeature(a){if(null!==a){var b=resilienceLayer.getFeaturesByAttribute("id",parseInt(a,10)),c;for(c in b)try{var d=b[c];d.attributes.outline=0;resilienceLayer.drawFeature(d);var e=f.l;if(1<e){var f=d.attributes,g=new OpenLayers.Feature.Vector(d.geometry.getCentroid(!0),{id:parseInt(a,10),l:e,r:f.r});resilienceLayer.addFeatures([g])}}catch(h){}}}
function removeFeatures(a){var b,c=[],d;for(d in resilienceLayer.features){b=resilienceLayer.features[d];try{b.attributes.l>=a&&c.push(b)}catch(e){}}resilienceLayer.destroyFeatures(c)}
function globalView(){closePopups();drawerOpen&&drawerSlide();removeFeatures(1);map.zoomToMaxExtent();showFeature(current_l0);$("#l0_breadcrumb, #l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb").hide();$("#show-hide, #divider, #analysisLink, #indicator, #risingTab").hide();$("#indicator").hide();$(".geoName").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+i18n.select_country);$(".geoType").html("");$(".year").html("");$("#l0_select, #l0_reports, #l0_datas, #l0_analysis1s").val("");$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").val("");
$("#l2_select, #l2_reports, #l2_datas, #l2_analysis1s").val("");$("#l3_select, #l3_reports, #l3_datas, #l3_analysis1s").val("");$("#l1, #l1_report, #l1_data, #l1_analysis1").hide();$("#l2, #l2_report, #l2_data, #l2_analysis1").hide();$("#l3, #l3_report, #l3_data, #l3_analysis1").hide();markersOff();current_l3=current_l2=current_l1=current_l0=null}
function v_select_region(a,b){closePopups();var c=vdata[b],d,e,f,g,h;switch(a){case 0:current_l0!=b&&(showFeature(current_l0),current_l0=b);current_l3=current_l2=current_l1="";d=hdata[b];e=c.n;$("#l1_breadcrumb, #l2_breadcrumb, #l3_breadcrumb").hide();$("#l0_breadcrumb").show().attr("href","javascript:v_select_region(0,"+b+");");$("#l0_breadcrumb span").html(" &raquo; "+e);$(".geoName").html(e);$(".geoType").html(i18n.country_in);$("#l0_select, #l0_reports, #l0_datas, #l0_analysis1s").val(b);$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").val("");
$("#l2_select, #l2_reports, #l2_datas, #l2_analysis1s").val("");$("#l3_select, #l3_reports, #l3_datas, #l3_analysis1s").val("");$("#l1, #l1_report, #l1_data, #l1_analysis1").show();$("#l2, #l2_report, #l2_data, #l2_analysis1").hide();$("#l3, #l3_report, #l3_data, #l3_analysis1").hide();markersOff();removeFeatures(1);hideFeature(b);$.ajax({url:S3.Ap.concat("/static/cache/1_"+b+".geojson"),dataType:"json"}).done(function(a){a=parser.read(a);var b=map.getProjectionObject(),c;for(c in a)try{a[c].geometry&&
a[c].geometry.transform(proj4326,b)}catch(d){}resilienceLayer.addFeatures(a);popupControl.unselectAll()}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});break;case 1:current_l1!=b&&(showFeature(current_l1),current_l1=b);current_l0!=c.f&&(showFeature(current_l0),current_l0=c.f,vdata[current_l0].hasOwnProperty("p")||updateL1Menus());current_l3=current_l2="";d=hdata[current_l0];e=vdata[current_l0].n;f=c.n;$("#l2_breadcrumb, #l3_breadcrumb").hide();
$("#l0_breadcrumb").show().attr("href","javascript:v_select_region(0,"+current_l0+");");$("#l0_breadcrumb span").html(" &raquo; "+e);$("#l1_breadcrumb").show().attr("href","javascript:v_select_region(1,"+b+");");$("#l1_breadcrumb span").html(" &raquo; "+f);$(".geoName").html(f);e=d.l1;$(".geoType").html(e+" "+i18n.in_);$("#l0_select, #l0_reports, #l0_datas, #l0_analysis1s").val(current_l0);$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").val(b);$("#l2_select, #l2_reports, #l2_datas, #l2_analysis1s").val("");
$("#l3_select, #l3_reports, #l3_datas, #l3_analysis1s").val("");$("#l1, #l1_report, #l1_data, #l1_analysis1").show();$("#l2, #l2_report, #l2_data, #l2_analysis1").show();$("#l3, #l3_report, #l3_data, #l3_analysis1").hide();markersOff();removeFeatures(2);e=resilienceLayer.getFeaturesByAttribute("id",parseInt(b,10));0==e.length&&$.ajax({url:S3.Ap.concat("/static/cache/1_"+current_l0+".geojson"),async:!1,dataType:"json"}).done(function(a){a=parser.read(a);var c=[],d=map.getProjectionObject(),e;for(e in a)try{a[e].attributes.id==
b&&(a[e].geometry.transform(proj4326,d),c.push(a[e]))}catch(f){}resilienceLayer.addFeatures(c);popupControl.unselectAll()}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});hideFeature(b);$.ajax({url:S3.Ap.concat("/static/cache/2_"+b+".geojson"),dataType:"json"}).done(function(a){a=parser.read(a);var b=map.getProjectionObject(),c;for(c in a)try{a[c].geometry&&a[c].geometry.transform(proj4326,b)}catch(d){}resilienceLayer.addFeatures(a);popupControl.unselectAll()}).fail(function(a,
b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});break;case 2:current_l2!=b&&(showFeature(current_l2),current_l2=b);current_l1!=c.f&&(showFeature(current_l1),current_l1=c.f,vdata.hasOwnProperty(current_l1)||$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+current_l1),async:!1,dataType:"script"}).done(function(a){for(var b in n)vdata.hasOwnProperty(b)||(vdata[b]=n[b]);n=null}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)}));
current_l0!=vdata[current_l1].f&&(showFeature(current_l0),current_l0=vdata[current_l1].f,vdata[current_l0].hasOwnProperty("p")||updateL1Menus());current_l3="";d=hdata[current_l0];e=vdata[current_l0].n;f=vdata[current_l1].n;g=c.n;$("#l3_breadcrumb").hide();$("#l0_breadcrumb").show().attr("href","javascript:v_select_region(0,"+current_l0+");");$("#l0_breadcrumb span").html(" &raquo; "+e);$("#l1_breadcrumb").show().attr("href","javascript:v_select_region(1,"+current_l1+");");$("#l1_breadcrumb span").html(" &raquo; "+
f);$("#l2_breadcrumb").show().attr("href","javascript:v_select_region(2,"+b+");");$("#l2_breadcrumb span").html(" &raquo; "+g);$(".geoName").html(g);e=d.l2;$(".geoType").html(e+" "+i18n.in_);$("#l0_select, #l0_reports, #l0_datas, #l0_analysis1s").val(current_l0);$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").val(current_l1);$("#l2_select, #l2_reports, #l2_datas, #l2_analysis1s").val(b);$("#l3_select, #l3_reports, #l3_datas, #l3_analysis1s").val("");$("#l1, #l1_report, #l1_data, #l1_analysis1").show();
$("#l2, #l2_report, #l2_data, #l2_analysis1").show();$("#l3, #l3_report, #l3_data, #l3_analysis1").show();removeFeatures(3);e=resilienceLayer.getFeaturesByAttribute("id",parseInt(b,10));0==e.length&&$.ajax({url:S3.Ap.concat("/static/cache/2_"+current_l1+".geojson"),async:!1,dataType:"json"}).done(function(a){a=parser.read(a);var c=[],d=map.getProjectionObject(),e;for(e in a)try{a[e].attributes.id==b&&(a[e].geometry.transform(proj4326,d),c.push(a[e]))}catch(f){}resilienceLayer.addFeatures(c);popupControl.unselectAll()}).fail(function(a,
b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});hideFeature(b);$.ajax({url:S3.Ap.concat("/static/cache/3_"+b+".geojson"),dataType:"json"}).done(function(a){a=parser.read(a);var b=map.getProjectionObject(),c;for(c in a)try{a[c].geometry&&a[c].geometry.transform(proj4326,b)}catch(d){}resilienceLayer.addFeatures(a);popupControl.unselectAll()}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)});break;case 3:current_l3!=
b&&(showFeature(current_l3),current_l3=b),current_l2!=c.f&&(showFeature(current_l2),current_l2=c.f,vdata.hasOwnProperty(current_l2)||$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+current_l2),async:!1,dataType:"script"}).done(function(a){for(var b in n)vdata.hasOwnProperty(b)||(vdata[b]=n[b]);n=null}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)})),current_l1!=vdata[current_l2].f&&(showFeature(current_l1),current_l1=vdata[current_l2].f,vdata.hasOwnProperty(current_l1)||
$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+current_l1),async:!1,dataType:"script"}).done(function(a){for(var b in n)vdata.hasOwnProperty(b)||(vdata[b]=n[b]);n=null}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)})),current_l0!=vdata[current_l1].f&&(showFeature(current_l0),current_l0=vdata[current_l1].f,vdata[current_l0].hasOwnProperty("p")||updateL1Menus()),d=hdata[current_l0],e=vdata[current_l0].n,f=vdata[current_l1].n,g=vdata[current_l2].n,
h=c.n,$("#l0_breadcrumb").show().attr("href","javascript:v_select_region(0,"+current_l0+");"),$("#l0_breadcrumb span").html(" &raquo; "+e),$("#l1_breadcrumb").show().attr("href","javascript:v_select_region(1,"+current_l1+");"),$("#l1_breadcrumb span").html(" &raquo; "+f),$("#l2_breadcrumb").show().attr("href","javascript:v_select_region(2,"+current_l2+");"),$("#l2_breadcrumb span").html(" &raquo; "+g),$("#l3_breadcrumb").show().attr("href","javascript:v_select_region(3,"+b+");"),$("#l3_breadcrumb span").html(" &raquo; "+
h),$(".geoName").html(h),e=d.l3,$(".geoType").html(e+" "+i18n.in_),$("#l0_select, #l0_reports, #l0_datas, #l0_analysis1s").val(current_l0),$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").val(current_l1),$("#l2_select, #l2_reports, #l2_datas, #l2_analysis1s").val(current_l2),$("#l3_select, #l3_reports, #l3_datas, #l3_analysis1s").val(b),$("#l1, #l1_report, #l1_data, #l1_analysis1").show(),$("#l2, #l2_report, #l2_data, #l2_analysis1").show(),$("#l3, #l3_report, #l3_data, #l3_analysis1").show(),
e=resilienceLayer.getFeaturesByAttribute("id",parseInt(b,10)),0==e.length&&$.ajax({url:S3.Ap.concat("/static/cache/3_"+current_l2+".geojson"),async:!1,dataType:"json"}).done(function(a){a=parser.read(a);var c=[],d=map.getProjectionObject(),e;for(e in a)try{a[e].attributes.id==b&&(a[e].geometry.transform(proj4326,d),c.push(a[e]))}catch(f){}resilienceLayer.addFeatures(c);popupControl.unselectAll()}).fail(function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)})}e=
resilienceLayer.getFeaturesByAttribute("id",parseInt(b,10));var m,k;for(m in e)try{var q=e[m];0!==q.geometry.getArea()&&(k=q.geometry.getBounds(),map.zoomToExtent(k))}catch(t){}switch(a){case 2:case 3:markersOn()}$(".year").html("2012");if(3==a)$("#subGeoDivider").html(""),$("#subGeoReported").html(""),$("#subGeoPopup").html("");else{$("#subGeoDivider").html("|");q=0;k=[];for(m in vdata)vdata[m].f==b&&(e=vdata[m].r)&&(e="<li><div class='ratingBox"+e+"'>"+e+"</div><p>"+vdata[m].n+"</p></li>",k.push(e),
q++);1==q?$("#subGeoReported").html("1 "+d["l"+(a+1)]+" "+i18n.reported):$("#subGeoReported").html(q+" "+d["l"+(a+1)]+"s "+i18n.reported);q="            <div class='popupContent'>            <ul>"+k.join("")+"</ul>          </div>          <div class='popupBottom'></div>";$("#subGeoPopup").html(q)}q=c.r;null===q?($("#indicator").css("background-color",colors[0]).show(),$("#mainRating").css("background-color",colors[0])):($("#indicator").html(q),$("#mainRating").html(q),$("#indicator").css("background-color",
colors[q]).show(),$("#mainRating").css("background-color",colors[q]));q=c.i;k=!1;for(m in q)k=!0,g=q[m],e=g.min,f=g.max,g=g.med,h="#visRange"+m,$(h).css("left",58*(e-1)+"px"),$(h).css("width",58*(f-e)+"px"),$(h+" .medianDot").css("left",58*(g-e)+"px"),g==e?$(h+" .leftBox").hide():$(h+" .leftBox").show(),g==f?$(h+" .rightBox").hide():$(h+" .rightBox").show();k?$(".visRange").show():$(".visRange").hide();$("#populationCount .listText").html(c.p);if(3==a){$("#populationCount .popupContent p").html(c.s);
$("#dataBreakdown li.breakdown").remove();for(m in c.b)q=c.b[m],$("#dataBreakdown ul").append("            <li class='breakdown'>                <p>"+q.n+":</p>                <div class='statistic'>                    <div class='listText'>"+q.v+"</div>                    <div class='popup'>                        <div class='popupContent'>                            <p>Source: "+q.s+"</p>                        </div>                        <div class='popupBottom'></div>                    </div>                </div>            </li>            ");
$("#qualityDescription").hide();$("#qualityCommunes").html(i18n.last_data_collected_on+": "+c.d)}else{$("#dataBreakdown li.breakdown").remove();$("#qualityDescription").show();$("#qualityCommunes").html(c.c+" "+i18n.out_of+" "+c.t+" "+d.l3+"s "+i18n.reported);switch(c.q){case "p":$("#poor").addClass("currentQuality");$("#fair").removeClass("currentQuality");$("#moderate").removeClass("currentQuality");$("#strong").removeClass("currentQuality");break;case "f":$("#poor").removeClass("currentQuality");
$("#fair").addClass("currentQuality");$("#moderate").removeClass("currentQuality");$("#strong").removeClass("currentQuality");break;case "m":$("#poor").removeClass("currentQuality");$("#fair").removeClass("currentQuality");$("#moderate").addClass("currentQuality");$("#strong").removeClass("currentQuality");break;case "s":$("#poor").removeClass("currentQuality"),$("#fair").removeClass("currentQuality"),$("#moderate").removeClass("currentQuality"),$("#strong").addClass("currentQuality")}$("#qualityDescription .currentQuality").hover(function(){$(this).find(".popup").show()},
function(){$(this).find(".popup").hide()})}current_l1?$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").html('<option value="" class="none">'+i18n.choose+" "+d.l1+"</option>"):$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").html('<option value="" selected="selected" class="none">'+i18n.choose+" "+d.l1+"</option>");current_l2?$("#l2_select, #l2_reports, #l2_datas, #l2_analysis1s").html('<option value="" class="none">'+i18n.choose+" "+ +d.l2+"</option>"):$("#l2_select, #l2_reports, #l2_datas, #l2_analysis1s").html('<option value="" selected="selected" class="none">'+
i18n.choose+" "+d.l2+"</option>");current_l3?$("#l3_select, #l3_reports, #l3_datas, #l3_analysis1s").html('<option value="" class="none">'+i18n.choose+" "+d.l3+"</option>"):$("#l3_select, #l3_reports, #l3_datas, #l3_analysis1s").html('<option value="" selected="selected" class="none">'+i18n.choose+" "+d.l3+"</option>");q=[];for(m in vdata)if(c=vdata[m],k=c.f,k==current_l0||k==current_l1||k==current_l2||k==current_l3)c.id=m,q.push(c);q.sort(nameSort);for(m=0;m<q.length;m++)c=q[m],e=resilienceClass(c.r),
k=c.f,f=c.id,k==current_l0?(k=f==current_l1?' selected="selected"':"",$("#l1_select, #l1_reports, #l1_datas, #l1_analysis1s").append('<option value="'+f+'" class="'+e+'"'+k+">"+c.n+"</option>")):k==current_l1?(k=f==current_l2?' selected="selected"':"",$("#l2_select, #l2_reports, #l2_datas, #l2_analysis1s").append('<option value="'+f+'" class="'+e+'"'+k+">"+c.n+"</option>")):k==current_l2&&(k=f==current_l3?' selected="selected"':"",$("#l3_select, #l3_reports, #l3_datas, #l3_analysis1s").append('<option value="'+
f+'" class="'+e+'"'+k+">"+c.n+"</option>"));$("#l1 label, #l1_report label, #l1_data label").html(d.l1.toUpperCase()+":");$("#l2 label, #l2_report label, #l2_data label").html(d.l2.toUpperCase()+":");$("#l3 label, #l3_report label, #l3_data label").html(d.l3.toUpperCase()+":");updateSelectMenus(!1);drawerOpen||($("#show-hide").html('<span class="arrow">&uarr;</span> '+i18n.show_more.toUpperCase()).show(),$("#divider").show(),$("#analysisLink").show(),d=S3.Ap.concat("/static/themes/Vulnerability/img/openTabPng8.png"),
$("#risingTab").css("background-image","url("+d+")").show())}
function drawerSlide(){var a;switch(drawerOpen){case !0:$("#drawerInside").hide("slow");$("#show-hide").html('<span class="arrow">&uarr;</span> '+i18n.show_more.toUpperCase());a=S3.Ap.concat("/static/themes/Vulnerability/img/openTabPng8.png");$("#risingTab").css("background-image","url("+a+")");$(".olPopup").fadeIn(300);$("#dummy_location_search").autocomplete("option","position",{my:"left bottom",at:"left top"});drawerOpen=!1;break;case !1:$("#drawerInside").show("slow"),$("#show-hide").html('<span class="arrow">&darr;</span> '+
i18n.show_less.toUpperCase()),a=S3.Ap.concat("/static/themes/Vulnerability/img/closeTabPng8.png"),$("#risingTab").css("background-image","url("+a+")"),$(".olPopup").fadeOut(300),$("#dummy_location_search").autocomplete("option","position",{my:"left top",at:"left bottom"}),drawerOpen=!0}}
function goToRegion(){var a;(a=$("#l3_select").val())?v_select_region(3,a):(a=$("#l2_select").val())?v_select_region(2,a):(a=$("#l1_select").val())?v_select_region(1,a):(a=$("#l0_select").val())?v_select_region(0,a):globalView()}
function markersOn(){enableVolunteerLayer();enableMapLayer();var a=S3.Ap.concat("/static/themes/Vulnerability/img/mapIconOnPng8.png");$("#mapSection").css("background","url("+a+") no-repeat center top transparent");a=S3.Ap.concat("/static/themes/Vulnerability/img/volunteerIconOnPng8.png");$("#volunteerSection").css("background","url("+a+") no-repeat center top transparent");$("#iconsCheck").show();$("#iconsKey label").css("color","#565656")}
function markersOff(){try{disableVolunteerLayer(),map.removeLayer(mapLayer)}catch(a){}var b=S3.Ap.concat("/static/themes/Vulnerability/img/mapIconOffPng8.png");$("#mapSection").css("background","url("+b+") no-repeat center top transparent");b=S3.Ap.concat("/static/themes/Vulnerability/img/volunteerIconOffPng8.png");$("#volunteerSection").css("background","url("+b+") no-repeat center top transparent");$("#iconsCheck").hide();$("#iconsKey label").css("color","#ccc")}
function resizeReports(){reportsHeight=window.innerHeight-111;activeContentHeight=0;$(".activeContent.contentTable .content").children("tr:visible").each(function(){activeContentHeight+=$(this).innerHeight()});507>reportsHeight&&(reportsHeight=507);activeContentHeight>reportsHeight-180&&(activeContentHeight=reportsHeight-180);$("#lightbox").css("height",$("#vulnerability").innerHeight()+"px");$("#reportsContent, #reportFilters").css("height",reportsHeight+"px");$(".activeContent.contentTable").css("height",
activeContentHeight+"px").css("display","block")}
function showReports(a){$("#table-container").empty();displayThanks("#reportsContent",i18n.loading_report_details,null);$("#lightbox, #reportsSection").fadeIn(300);var b=getFilteredReport();$.ajax({type:"POST",url:S3.Ap.concat("/vulnerability/report/filter"),data:b}).done(function(b){$(".approvalScreen").hide();displayReport(b);"pending"==a?openReportRow("group_011"):"VCA"==a?openReportRow("group_012"):openReportRow("group_013")}).fail(function(){$(".approvalScreen").hide();alert("error")})}
function toggleReports(a){switch(a){case "myReports":$(".allReports").removeClass("active").html("<a href=\"javascript:toggleReports('allReports')\" title='All Reports'>"+i18n.all_reports.toUpperCase()+"</a>");$(".myReports").addClass("active").html(i18n.my_reports.toUpperCase());break;case "allReports":$(".myReports").removeClass("active").html("<a href=\"javascript:toggleReports('myReports')\" title='My Reports'>"+i18n.my_reports.toUpperCase()+"</a>"),$(".allReports").addClass("active").html(i18n.all_reports.toUpperCase())}filterReport()}
function filterReport(){displayThanks("#reportsContent",i18n.loading_report_details,null);$("#table-container").empty();var a=getFilteredReport();$.ajax({type:"POST",url:S3.Ap.concat("/vulnerability/report/filter"),data:a}).done(function(a){$(".approvalScreen").hide();displayReport(a)}).fail(function(){alert("error");$(".approvalScreen").hide()})}
function getFilteredReport(){var a={};$("#l3_reports").val()?a.location_id=$("#l3_reports").val():$("#l2_reports").val()?a.location_id=$("#l2_reports").val():$("#l1_reports").val()?a.location_id=$("#l1_reports").val():$("#l0_reports").val()?a.location_id=$("#l0_reports").val():a.location_id=-1;a.from_date=$("#dateFromReports").val();a.to_date=$("#dateToReports").val();$("#indicatorsCheckbox").is(":checked")&&(a.indicator=!0);$("#mapCheckbox").is(":checked")&&(a.map=!0);$("#imagesCheckbox").is(":checked")&&
(a.images=!0);$("#reportsCheckbox").is(":checked")&&(a.reports=!0);$("#demographicsCheckbox").is(":checked")&&(a.demographics=!0);a.text=$("#reportTextSearch").val();$("#reportsToggle .active").hasClass("myReports")&&(a.myReports=!0);return a}
function displayReport(a){$("#table-container").empty();a?($("#table-container").append(a),S3.dataTables.fnInitDataTable($("#report"),0,!0),formatTable(a),openReportRow("group_011"),$("#numberReports").html($("#reportCount").val())):$("#numberReports").html(i18n.no_entries_found);resizeReports()}
function openReportRow(a){-1!=shownReport&&hideReportDetails(shownReport);var b=$("."+a);b.length&&(-1==b.html().indexOf("(0)")?S3.dataTables.accordionRow(0,"level_1",a):-1==$(".group_011").html().indexOf("(0)")?S3.dataTables.accordionRow(0,"level_1","group_011"):-1==$(".group_012").html().indexOf("(0)")?S3.dataTables.accordionRow(0,"level_1","group_012"):S3.dataTables.accordionRow(0,"level_1","group_013"))}
function formatTable(){$("#report").addClass("reportsTable").addClass("headerTable");$(".group").addClass("headerLabel");$("#report tr").each(function(){var a=$(this).find("td:first");0===a.length&&(a=$(this).find("th:first"));a.addClass("date").next().addClass("communeName").next().addClass("type").next().addClass("submittedBy").next().addClass("status").next().addClass("action")})}
function showReportDetails(a){$.getJSON(S3.Ap.concat("/vulnerability/report/review"),{id:a}).done(function(b){displayReportDetails(a,b)}).fail(function(){alert("error")})}function viewReportDetails(a){$.getJSON(S3.Ap.concat("/vulnerability/report/view"),{id:a}).done(function(b){displayReportDetails(a,b)}).fail(function(){alert("error")})}
function hideReportDetails(a){$("#show"+a).remove();a=$("#"+a).parent().parent();$(a).find(".reviewButton").show();$(a).find(".viewButton").show();$(a).find(".closeReviewButton").hide()}
function displayReportDetails(a,b){var c=$("#"+a).parent().parent(),d=document.createElement("tr"),e=document.createElement("td");-1!=shownReport&&hideReportDetails(shownReport);shownReport=a;e.colSpan=6;e.innerHTML=b;d.appendChild(e);$(d).addClass("showReport");$(d).attr("id","show"+a);$(d).insertAfter(c);$(c).find(".reviewButton").hide();$(c).find(".viewButton").hide();$(c).find(".closeReviewButton").show();$(".approveButton, .declineButton").click(processReportDetails)}
function displayThanks(a,b,c){$(a+" .approvalScreen .thanks").html(b);$(a+" .approvalScreen .thanks").show();$(a+" .approvalScreen").fadeIn(300);$(a+" .approvalScreen .return2reports").hide();c&&($(a+" .approvalScreen").data("approvalTimeout",setTimeout(function(){$(a+" .approvalScreen").fadeOut(300)},c)),$(a+" .approvalScreen .return2reports").show())}
function processReportDetails(){var a=this.name.substr(7);$("#table-container").empty();hideReportDetails(a);var b=$("#form"+a).serialize(),c=getFilteredReport();c.id=a;c.report=b;$("#"+a).parent().parent();$(this).hasClass("approveButton")?(displayThanks("#reportsContent",i18n.approval_request_submitted,null),$.ajax({type:"POST",url:S3.Ap.concat("/vulnerability/report/approve"),data:c}).done(function(a){$(".approvalScreen").hide();displayThanks("#reportsContent",i18n.thankyou_for_your_approval,5E3);
var b=this.data.split("location_id=")[1].split("&")[0];-1!=b&&$.ajax({url:S3.Ap.concat("/vulnerability/vdata/"+b),success:function(a){for(var b in n)vdata[b]=n[b];n=null},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"script"});displayReport(a)}).fail(function(){alert("error");$(".approvalScreen").hide()})):(displayThanks("#reportsContent",i18n.reject_request_submitted,null),$.ajax({type:"POST",url:S3.Ap.concat("/vulnerability/report/decline"),
data:c}).done(function(a){$(".approvalScreen").hide();displayThanks("#reportsContent",i18n.submission_has_been_declined,5E3);displayReport(a)}).fail(function(){alert("error");$(".approvalScreen").hide()}))}
function uploadSubmitDataIndicators(){$(".loadingErrorView").fadeOut(300);var a=new FormData($("#uploadIndicatorsForm")[0]);a.append("action","vulnerability_part1");a.append("approach","ajax");$.ajax({url:S3.Ap.concat("/vulnerability/submitData/import.aadata"),type:"POST",data:a,cache:!1,contentType:!1,processData:!1}).done(function(a){a.Error?($("#errormsg").html(a.Error),$(".loadingErrorView").fadeIn(300)):(submitDataJobID=a.upload_id,submitDataItemIDs=a.items,submitNextAction="vulnerability_part2",
submittedData=a.data,submittedDataPage=0,$(".indicatorsStart").fadeOut(300),displaySubmitDataIndicators())}).fail(function(){alert("error")})}
function displaySubmitDataIndicators(){submittedData&&(total_pages=submittedData.length,page_data=submittedData[submittedDataPage],page=submittedDataPage+1);$("#submitDataUpload").html($("#submitDataUpload").html());$("#submitDataContent .reviewIndicatorsView h3").html(i18n.review+" <span class='currentPage'>"+page+"</span> "+i18n.of+" <span class='totalPages'>"+total_pages+"<span>");$(".reviewIndicatorsView h4 mark").html(page_data.location);$(".reviewIndicatorsView h4 date").html(page_data.date);
$(".reviewIndicatorsView .indicatorReviewTable tbody tr").each(function(){var a=$(this).find("td.indicatorLabels").html().substr(14),a=page_data.data[a];$(this).find("input[value='"+a+"']").prop("checked",!0)});$(".reviewIndicatorsView.firstPage").fadeIn(300);$("#submitDataFilters").animate({"background-color":"#f7941d"},500);$("#submitDataFilters h3").hide(300);$("#submissionToggle").hide(300);1==page&&($("#submitDataFooter mark, #submitDataFooter .reviewNextButton").fadeIn(300),$(".backButton").hide());
1<page&&!$(".backButton").is(":visible")&&$(".backButton").fadeIn(300);page==total_pages?($(".reviewNextButton").hide(),$(".submitAllButton").show()):($(".reviewNextButton").show(),$(".submitAllButton").hide())}function nextSubmitDataReview(){submittedDataPage+=1;total_pages=submittedData.length;submittedDataPage>=total_pages&&(submittedDataPage=total_pages-1);displaySubmitDataIndicators()}
function backSubmitDataReview(){submittedDataPage-=1;0>submittedDataPage&&(submittedDataPage=0);displaySubmitDataIndicators()}
function submitImportSubmitData(){details={approach:"ajax",action:submitNextAction,job:submitDataJobID,mode:"Inclusive",selected:JSON.stringify(submitDataItemIDs)};$.ajax({url:S3.Ap.concat("/vulnerability/submitData/import"),type:"POST",data:details}).done(function(a){$(".reviewIndicatorsView").fadeOut(300);$(".reviewDemographicsView").hide();"vulnerability_part2"==submitNextAction?displayThanks("#indicatorsSubmissionViews",i18n.upload_successful,null):displayThanks("#dataAndReportsSubmissionViews",
i18n.upload_successful,null);$("#submitDataFooter div, #submitDataFooter mark").fadeOut(300);$("#submitDataFooter .submitMoreButton").fadeIn(300)}).fail(function(){alert("error")})}
function moreSubmitData(){$("#indicatorsSubmissionViews .approvalScreen").hide();$("#dataAndReportsSubmissionViews .approvalScreen").hide();$("#submitDataFooter .submitMoreButton").fadeOut(300);$("#submitDataFilters").animate({"background-color":"#c6c6c6"},500);$("#submitDataFilters h3").fadeIn(300);$("#submissionToggle").fadeIn(300);$("#dataUploadTitle h4").html(i18n.select_data_type);$("#dataUploadTitle h3, .delete, .reviewTitling").hide();$("#indicatorsSubmissionViews").is(":visible")?($("#submitDataUpload").html($("#submitDataUpload").html()),
$("#submitDataContent .indicatorsStart").fadeIn(300),$("#submitDataContent .indicatorsStart p").filter(":first").show()):($("#newSubmissionRegions, #dataSubmissionRegion .submissionContent").empty(),$("#dataSubmissionRegion").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style"),$("#dataSubmissionRegion input").prop("disabled",!1).prop("checked",!1),$("#dataAndReportsSubmissionViews .dataUploadContainer").fadeIn(300),$(".fileType, .labelFile, .remove, .imgDesc, .labelHangRight, .checkHangRight").fadeIn(300),
$(".dataSubmissionRegion input:radio").each(function(){$(this).parent().removeAttr("style")}))}function selectedLevel(){var a=$("#l0_datas").val(),b=$("#l1_datas").val(),c=$("#l2_datas").val();return $("#l3_datas").val()&&c&&b&&a?"l3":c&&b&&a?"l2":b&&a?"l1":a?"l0":null}
function indicatorsCheckCommune(){switch(selectedLevel()){case null:$("#submitOnlineButton").addClass("disabled");disableOptionSubmitDataPanel("#dataSubmissionRegion");break;case "l0":case "l1":$("#submitOnlineButton").addClass("disabled");enableOptionSubmitDataPanel("#dataSubmissionRegion");$("#dataSubmissionRegion .mapOption input:radio").prop("disabled",!0);$("#dataSubmissionRegion .imageOption input:radio").prop("disabled",!0);$("#dataSubmissionRegion .mapOption, #dataSubmissionRegion .imageOption").css("color",
"#999");$("#mapImage").addClass("disabled");$("#image").addClass("disabled");break;case "l2":$("#submitOnlineButton").addClass("disabled");enableOptionSubmitDataPanel("#dataSubmissionRegion");break;default:$("#submitOnlineButton").removeClass("disabled"),enableOptionSubmitDataPanel("#dataSubmissionRegion")}}
function displaySubmitOnline(){$("#submitDataContent .submitIndicatorsForm input").prop("checked",!1);$("#submitDataContent .submitIndicatorsForm, #submitDataFooter mark").fadeIn(300);$("#submitDataContent .indicatorsStart").fadeOut(300);$("#submitDataFooter .reviewSubmissionButton").addClass("disabled").fadeIn(300)}
function reviewSubmitData(){var a=hdata[$("#l0_datas").val()],b;$("#l3_datas").val()?b=$("#l3_datas option:selected").html()+" "+a.l3+".":$("#l2_datas").val()?b=$("#l2_datas option:selected").html()+" "+a.l2+".":$("#l1_datas").val()?b=$("#l1_datas option:selected").html()+" "+a.l1+".":$("#l0_datas").val()&&(b=$("#l0_datas option:selected").html()+" "+i18n.country+".");$("#submitDataContent .submitIndicatorsForm").is(":visible")&&($("#submitDataContent .submitIndicatorsForm h3").html(i18n.review),
$("#submitDataContent .submitIndicatorsForm h4").filter(":first").html(i18n.about_to_submit_indicator_ratings+" <mark>"+b+"</mark>"),$(".submitIndicatorsForm h3, .submitIndicatorsForm h4").fadeIn(300),$("#submitDataFooter .reviewSubmissionButton, .submitIndicatorsForm .indicatorLabels div").fadeOut(300),$("#submitDataFooter .submitButton").removeClass("disabled"),$("#submitDataFilters").animate({"background-color":"#f7941d"},500),$("#submitDataFilters h3").hide(300),$("#submissionToggle").fadeOut(200),
setTimeout(function(){$("#submitDataFooter .submitButton").fadeIn(300)},300))}
function submitSubmitData(){var a=new FormData;$(".submitIndicatorsForm input:radio:checked").each(function(b){a.append(b+1,$(this).attr("value"))});a.append("location",$("#l3_datas").val());a.append("action","vulnerability");a.append("approach","ajax");$.ajax({url:S3.Ap.concat("/vulnerability/submitData/create"),type:"POST",data:a,cache:!1,contentType:!1,processData:!1}).done(function(a){$(".indicatorsStart").fadeOut(300);displaySubmitDataIndicators()}).fail(function(){alert("error")});$("#submitDataContent .submitIndicatorsForm").is(":visible")?
($("#submitDataContent .submitIndicatorsForm").fadeOut(300),$("#indicatorsSubmissionViews .thankyou").fadeIn(300),$("#submitDataFooter div, #submitDataFooter mark").fadeOut(300),setTimeout(function(){$("#submitDataFooter .submitMoreButton").fadeIn(300);$("#submitDataFooter .reviewSubmissionButton").addClass("disabled");$(".submitIndicatorsForm h3, .submitIndicatorsForm h4").hide();$(".submitIndicatorsForm .indicatorLabels div").show()},300)):$("#submitDataContent .dataUploadContainer").is(":visible")&&
($("#submitDataContent .dataUploadContainer").fadeOut(300),$("#dataAndReportsSubmissionViews .thankyou").fadeIn(300),$("#submitDataFooter div, #submitDataFooter mark").fadeOut(300),setTimeout(function(){$("#submitDataFooter .submitMoreButton").fadeIn(300)},300))}function resizeSubmitData(){var a=$(window).innerHeight()-186;432>a&&(a=432);$("#submitDataContent").css("height",a+"px");$("#submitDataFilters").css("height",a+75+"px");$("#submitDataSection").css("height",a+136+"px")}
function showSubmitData(a){$("#submitDataContent .dataUploadContainer h3, .delete, .reviewTitling, #submitDataContent .thankyou, .loadingErrorView").hide();$("#submitDataFooter div, #submitDataFooter mark").hide();$("#submitDataFilters #submissionToggle, #submitDataFilters h3").show();$("#dataAndReportsSubmissionViews .dataUploadContainer").show();$(".fileType, .labelFile, .remove, .imgDesc, .labelHangRight, .checkHangRight").show();$("#submitIndicators, #submitReports").removeClass("active");$("#submitDataFilters").css("background-color",
"#c6c6c6");$("#dataSubmissionRegion").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");$("#dataSubmissionRegion").removeClass("mapSubmission imageSubmission otherSubmission demographicsSubmission vcaSubmission loaded").removeAttr("style");$("#dataSubmissionRegion input").prop("checked",!1);$(".dataSubmissionRegion input:radio").each(function(){$(this).parent().removeAttr("style");$(this).prop("disabled",!1)});$("#newSubmissionRegions, #dataSubmissionRegion .submissionContent").empty();
$("#dataUploadTitle h4").html(i18n.select_data_type);switch(a){case "indicators":$(".loadingErrorView").fadeOut(300);$("#submitDataUpload").html($("#submitDataUpload").html());$("#submitIndicators").addClass("active");$("#indicatorsSubmissionViews").show();$("#dataAndReportsSubmissionViews").hide();$("#indicatorsSubmissionViews").children("div").hide();$("#submitDataFooter, #submitDataFooter mark").removeAttr("style");$("#submitDataFooter .reviewSubmissionButton").removeClass("disabled");$("#submitDataContent .indicatorsStart").show();
break;case "reports":$("#submitReports").addClass("active"),$("#dataAndReportsSubmissionViews").show(),$("#indicatorsSubmissionViews").hide(),$("#demoContent").hide(),$("#uploadDemographicsForm").hide(),$(".reviewDemographicsView").hide(),$("#uploadReportsForm").hide(),$(".uploadReportsForm").hide(),$(".dataSubmissionRegion").height(46)}$("#submitDataFooter").show();indicatorsCheckCommune();$("#lightbox, #submitDataSection").fadeIn(300)}
function disableOptionSubmitDataPanel(a){$(a+" input:radio").prop("disabled",!0);$(a+" .mapOption, "+a+" .imageOption, "+a+" .otherOption, "+a+" .demoOption, "+a+" .VCAOption").css("color","#999")}function enableOptionSubmitDataPanel(a){$(a+" input:radio").prop("disabled",!1);$(a+" input:radio").prop("checked",!1);$(a+" .mapOption, "+a+" .imageOption, "+a+" .otherOption, "+a+" .demoOption, "+a+" .VCAOption").css("color","#000")}
function selectOptionSubmitData(){var a="#"+$(this).parent().parent().attr("id"),b=$(this).val();disableOptionSubmitDataPanel(a);$("#demoContent").hide();$("#uploadDemographicsForm").hide();$(".reviewDemographicsView").hide();$("#uploadReportsForm").hide();switch(b){case "map":case "image":$("#uploadReportsForm").show();$(a).height(116);$("#descFordataSubmissionRegion").keyup(function(){""!==$("#descFordataSubmissionRegion").val()&&""!==$("#submitDataReportsUpload").val()?$("#submitDataFooter .submitButton").removeClass("disabled"):
$("#submitDataFooter .submitButton").addClass("disabled")});$("#submitDataReportsUpload").change(function(){""!==$("#descFordataSubmissionRegion").val()&&""!==$("#submitDataReportsUpload").val()?$("#submitDataFooter .submitButton").removeClass("disabled"):$("#submitDataFooter .submitButton").addClass("disabled")});$("#submitDataFooter .submitButton").addClass("disabled");$("#submitDataFooter .submitButton, #submitDataFooter .cancelButton, #submitDataFooter mark").fadeIn(300);break;case "other":case "vca":$("#uploadReportsForm").show();
$(a).height(86);$("#descFordataSubmissionRegion").hide();$("#fakeFordataSubmissionRegion").hide();$("#submitDataReportsUpload").change(function(){""!==$("#submitDataReportsUpload").val()&&$("#submitDataFooter .submitButton").removeClass("disabled")});$("#submitDataFooter .submitButton").addClass("disabled");$("#submitDataFooter .submitButton, #submitDataFooter .cancelButton").fadeIn(300);break;case "demographics":yr=(new Date).getFullYear();for(b=0;6>=b;b++)$("#reportDate"+b).datepicker({dateFormat:"yy-mm-dd",
defaultDate:yr+"-01-01",changeYear:!0,changeMonth:!0,maxDate:"+0d",minDate:"-20y"});$("#demoContent").show();$("#uploadDemographicsForm").hide();$(".reviewDemographicsView").hide();$(a).height(330);$("#submitDataFooter .submitButton").addClass("disabled");$("#submitDataFooter .submitButton, #submitDataFooter .cancelButton").fadeIn(300);$(".sourceLabel").children("mark").hide();$("#demoContent input").each(function(){$(this).val("");$(this).change(onChangeData)})}$(a+" .submissionContent").is(":visible")&&
$(a+" .submissionContent").fadeOut(300)}function demographicsUploadDisplay(a){a="#"+$(this).parent().parent().attr("id");$("#demoContent").hide();$(".reviewDemographicsView").hide();$("#uploadDemographicsForm").show();$(a).height(120);$("#submitDataFooter .submitButton").fadeOut(300)}
function demographicsLoader(a){$(".loadingErrorView").fadeIn(300);a=new FormData($("#uploadDemographicsForm")[0]);a.append("action","demographics_part1");a.append("approach","ajax");$.ajax({url:S3.Ap.concat("/vulnerability/submitData/import.aadata"),type:"POST",data:a,cache:!1,contentType:!1,processData:!1}).done(function(a){a.Error?($("#errormsg").html(a.Error),$(".loadingErrorView").fadeIn(300)):(submitDataJobID=a.upload_id,submitDataItemIDs=a.items,submitNextAction="demographics_part2",submittedData=
a.data,submittedDataPage=0,$(".indicatorsStart").fadeOut(300),displayDemoData())}).fail(function(){alert("error")})}
function displayDemoData(){submittedData&&(total_pages=submittedData.length,page_data=submittedData[submittedDataPage],page=submittedDataPage+1);disableOptionSubmitDataPanel("#dataSubmissionRegion");$("#submitDemoUpload").html($("#submitDemoUpload").html());$(".reviewDemographicsView h3").html(i18n.review+" <span class='currentPage'>"+page+"</span> "+i18n.of+" <span class='totalPages'>"+total_pages+"<span>");$(".reviewDemographicsView h4 mark").html(page_data.location);$("#reportViewDate").html(page_data.date);
$("#demoViewField0").html(page_data.data.Population);$("#sourceViewField0").html(page_data.source);$("#demoViewField1").html(page_data.data.Male);$("#sourceViewField1").html(page_data.source);$("#demoViewField2").html(page_data.data.Female);$("#sourceViewField2").html(page_data.source);$("#demoViewField3").html(page_data.data["Over 60"]);$("#sourceViewField3").html(page_data.source);$("#demoViewField4").html(page_data.data["Under 5"]);$("#sourceViewField4").html(page_data.source);$("#demoViewField5").html(page_data.data.Households);
$("#sourceViewField5").html(page_data.source);$("#demoViewField6").html(page_data.data["Households below poverty line"]);$("#sourceViewField6").html(page_data.source);$("#uploadDemographicsForm").hide();$(".reviewDemographicsView.firstPage").show();$(".reviewDemographicsView h3").show();$("#submissionToggle").hide(300);1==page&&($("#submitDataFooter mark, #submitDataFooter .reviewNextButton").fadeIn(300),$(".backButton").hide());1<page&&!$(".backButton").is(":visible")&&$(".backButton").fadeIn(300);
page==total_pages?($(".reviewNextButton").hide(),$(".submitAllButton").show()):($(".reviewNextButton").show(),$(".submitAllButton").hide())}function nextSubmitDataReview(){submittedDataPage+=1;total_pages=submittedData.length;submittedDataPage>=total_pages&&(submittedDataPage=total_pages-1);displayDemoData()}function backSubmitDataReview(){submittedDataPage-=1;0>submittedDataPage&&(submittedDataPage=0);displayDemoData()}
function onChangeData(){$(this).hasClass("demoField")&&(""===$(this).val()?($(this).siblings(".sourceLabel").children("mark").hide(),$(this).siblings(".dateLabel").children("mark").hide()):($(this).siblings(".sourceLabel").children("mark").show(),$(this).siblings(".dateLabel").children("mark").show()));var a=!1;$("#demoContent .demoField").each(function(){""!==$(this).val()&&(a=!0)});$("#demoContent .sourceLabel mark").each(function(){$(this).is(":visible")&&""===$(this).parent().siblings(".sourceField").val()&&
(a=!1,$("#submitDataFooter .submitButton").addClass("disabled"))});$("#demoContent .dateLabel mark").each(function(){$(this).is(":visible")&&""===$(this).parent().siblings(".dateField").val()&&(a=!1,$("#submitDataFooter .submitButton").addClass("disabled"))});a?$("#submitDataFooter .submitButton").removeClass("disabled"):$("#submitDataFooter .submitButton").addClass("disabled")}
function cancelSubmitDataTypeSelection(){$("#uploadReportsForm").html($("#uploadReportsForm").html());indicatorsCheckCommune();$("#demoContent").hide();$("#uploadDemographicsForm").hide();$(".reviewDemographicsView").hide();$("#uploadReportsForm").hide();$("#dataSubmissionRegion").height(46);$("#submitDataFooter div, #submitDataFooter mark").fadeOut(300)}
function uploadSubmitDataReport(a){a=$("#dataSubmissionRegion input[type=radio]:checked").val();var b;"demographics"==a?(b=new FormData,jQuery.each($("#dataSubmissionRegion .demographicsForm input"),function(a,d){b.append(d.id,d.value)})):b=new FormData($("#dataSubmissionRegion .uploadReportsForm")[0]);$(".dataUploadContainer").fadeOut(300);b.append("action",a);a=selectedLevel();a=$("#"+a+"_datas").val();b.append("location",a);displayThanks("#dataAndReportsSubmissionViews",i18n.uploading_report_details,
null);$.ajax({url:S3.Ap.concat("/vulnerability/submitData"),type:"POST",data:b,cache:!1,contentType:!1,processData:!1}).done(function(a){cancelSubmitDataTypeSelection();displayThanks("#dataAndReportsSubmissionViews",i18n.upload_successful,5E3);$(".dataUploadContainer").fadeIn(300)}).fail(function(){alert("error")})}
function analysisView(){closePopups();drawerOpen&&drawerSlide();$("#drawer").hide();$("#dataTopBar").hide();$("#reportsTopBar").hide();analysisUpdateSelectedLocations();toggleAnalysis();$("#analysis").show()}function hideAnalysis(){analysisResetGraph();$("#analysis").hide();$("#dataTopBar").show();$("#reportsTopBar").show();$("#drawer").show()}
function toggleAnalysis(){"overall"==$("#analysisIndicator").val()?(analysisResetGraph(),analysisUpdateGraph(),$("#treeMapDescription").hide(),$(".treeMapContainer").hide(),$("#lineGraphDescription").show(),$("#analysisControl1, #analysisControl2, #analysisControl3").show(),$(".lineGraphContainer").show(),$("#analysisTimeline").show(),$(".eventMarkers").show(),$("#analysisTimelineContainer").show()):(analysisResetGraph(),$("#lineGraphDescription").hide(),$("#analysisControl1, #analysisControl2, #analysisControl3").hide(),
$(".lineGraphContainer").hide(),$("#analysisTimeline").hide(),$(".eventMarkers").hide(),$("#analysisTimelineContainer").hide(),$("#treeMapDescription").show(),$(".treeMapContainer").show(),tmGoToLocation(analysisLocation[1].id))}
function analysisReset(a){$("#l0_analysis"+a+"s").val("");$("#l1_analysis"+a).hide();$("#l2_analysis"+a).hide();$("#l3_analysis"+a).hide();var b=$("#analysisControl"+a+" select");try{b.selectmenu("destroy")}catch(c){}b.selectmenu({style:"popup",maxHeight:280,width:125,menuWidth:125});analysisSelectLocation(null,a)}var analysisLineGraph=null,analysisGraphHoverable=!0,analysisColors=["#949494","#df09b7","#1384ae"],analysisTooltipPreviousSeries=null,analysisTooltipPreviousPoint=null;
function analysisResetGraph(){$("#analysisTooltip").remove();$("#regionIndicators").hide();analysisGraphHoverable=!0;analysisTooltipPreviousPoint=analysisTooltipPreviousSeries=null;$("h5.analysisSeriesLabel").unbind("hover");$("#analysisLineGraph").unbind("plothover");$("#analysisLineGraph").unbind("plotclick")}
function analysisUpdateSelectedLocations(){for(var a=1;3>=a;a++){analysisLocation[a]=null;for(var b=4;0<=b;b--){var c=$("#l"+b+"_analysis"+a+"s").val();if("undefined"!=typeof c&&""!==c&&null!==c&&null!==c&&vdata.hasOwnProperty(c)){var b=hdata[$("#l0_analysis"+a+"s").val()],d=vdata[c].l;analysisLocation[a]={id:c,name:vdata[c].n,level:0===d?i18n.country:b["l"+d]};break}}}analysisGetData()}
function analysisSelectLocation(a,b){var c=analysisLocation[b];if(null===c||c.id!=a){if(null!==a&&vdata.hasOwnProperty(a)){var c=hdata[$("#l0_analysis"+b+"s").val()],d=vdata[a].l;analysisLocation[b]={id:a,name:vdata[a].n,level:0===d?i18n.country:c["l"+d]}}else analysisLocation[b]=null;analysisGetData()}}
function analysisGetData(){analysisResetGraph();var a=S3.Ap.concat("/vulnerability/rdata");null===analysisLocation[1]&&(analysisLocation[1]=analysisLocation[0]);var b=!1;for(n=1;3>=n;n++){var c=analysisLocation[n];null!==c&&(c=c.id,"undefined"==typeof analysisDataCache[c]&&(a+="/"+c,b=!0))}b?$.ajax({url:a,success:function(a){for(var b in r)analysisDataCache[b]=r[b];analysisUpdateGraph()},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"script"}):
analysisUpdateGraph()}
function analysisUpdateGraph(){for(var a={1:null,2:null,3:null},b=1;3>=b;b++){var c=analysisLocation[b];if(null!==c){var d=c.id;a[b]={label:c.name};var e=analysisDataCache[d],f=[],g=[],h=[],m;for(m in e){var k=e[m][0];if("undefined"==typeof k){len=sum=0;for(k=1;10>=k;k++)p=e[m][k],"undefined"!=typeof p&&(sum+=Number(p[0]),len+=1);if(0!==len)k=[sum/len,0],analysisDataCache[d][m]["0"]=k;else continue}f.push([m,k[0]]);h.push([m,k[0]-k[1]/5]);g.push([m,k[0]+k[1]/5])}a[b].name=c.name;a[b].value=f;a[b].lower=
h;a[b].upper=g}}b=[];c=a[1];null!==c&&(b.push({label:c.name,id:"d1",data:c.value,lines:{show:!0},color:analysisColors[0],highlightColor:"#fff"}),b.push({id:"l1",data:c.lower,lines:{show:!0,lineWidth:0,fill:!1},color:analysisColors[0],hoverable:!1}),b.push({id:"u1",data:c.upper,lines:{show:!0,lineWidth:0,fill:0.3},color:analysisColors[0],fillBetween:"l1",hoverable:!1}));c=a[2];null!==c&&(b.push({label:c.name,id:"d2",data:c.value,lines:{show:!0},color:analysisColors[1],highlightColor:"#fff"}),b.push({id:"l2",
data:c.lower,lines:{show:!0,lineWidth:0,fill:!1},color:analysisColors[1],hoverable:!1}),b.push({id:"u2",data:c.upper,lines:{show:!0,lineWidth:0,fill:0.3},color:analysisColors[1],fillBetween:"l2",hoverable:!1}));a=a[3];null!==a&&(b.push({label:a.name,id:"d3",data:a.value,lines:{show:!0},color:analysisColors[2],highlightColor:"#fff"}),b.push({id:"l3",data:a.lower,lines:{show:!0,lineWidth:0,fill:!1},color:analysisColors[2],hoverable:!1}),b.push({id:"u3",data:a.upper,lines:{show:!0,lineWidth:0,fill:0.3},
color:analysisColors[2],fillBetween:"l3",hoverable:!1}));analysisLineGraph=$.plot($("#lineGraph"),b,{grid:{backgroundColor:{colors:["#363636","#363636"]},hoverable:analysisGraphHoverable,clickable:analysisGraphHoverable},crosshair:{mode:"x",color:"#F7941D"},xaxis:{minTickSize:1,maxTickSize:1,color:"#fff",min:2005,max:2015,tickDecimals:0,tickFormatter:function(a,b){var c=a%100;return 10>c?"'0"+c:"'"+c},font:{weight:"bold"}},yaxis:{color:"#fff",min:1,max:5,tickDecimals:0,tickFormatter:function(a,b){var c=
{1:"red",2:"orange",3:"yellow",4:"green",5:"darkgreen"};return c.hasOwnProperty(a)?'<div class="'+c[a]+'label">'+a+"</div>":a.toString()},labelWidth:20,labelHeight:20},legend:{show:!1},colors:analysisColors});analysisGraphHoverable&&($("#lineGraph").bind("plothover",function(a,b,c){analysisTooltip(b,c,0,!1)}),$("#lineGraph").bind("plotclick",function(a,b,c){$("#lineGraph").unbind("click");c&&analysisTooltip(b,c,0,!0);$("#lineGraph").click(function(){analysisGraphHoverable||($("#lineGraph").unbind("click"),
analysisGraphHoverable=!0,$("#lineGraph").click(function(){$("#lineGraph").unbind("click");analysisResetGraph();analysisUpdateGraph()}))})}))}
function analysisTooltip(a,b,c,d){if(d)if(analysisGraphHoverable)analysisGraphHoverable=!1,analysisUpdateGraph(),analysisLineGraph.highlight(b.series,b.datapoint),$("#analysisTooltip").click(function(){analysisResetGraph();analysisUpdateGraph()});else return;else if(!analysisGraphHoverable)return;if(b){if(analysisTooltipPreviousPoint!=b.dataIndex){analysisTooltipPreviousPoint=b.dataIndex;$("#analysisTooltip").remove();var e=b.datapoint[0].toFixed(0);d=b.datapoint[1];a='<div class="analysisTooltip"><h4>'+
e+"</h4>";for(var f=1;3>=f;f++){var g=analysisLocation[f];if(null!==g){var h=g.id;try{var m=analysisDataCache[h][e][c][0],k=analysisDataCache[h][e][c][1]}catch(q){continue}"undefined"!=typeof m&&1E-4>Math.abs(d-m)&&(name=g.name.toLocaleUpperCase()+" "+g.level.toLocaleUpperCase(),a+='<h5 id="analysisSeries'+f+'" class="analysisSeriesLabel">'+name+"</h5>",a+="<table>",a+='<tr><td class="ttleft">Overall Resilience:</td><td class="ttright">'+m.toFixed(0)+"</td></tr>",a+='<tr><td class="ttleft">Absolute Deviation:</td><td class="ttright">'+
k.toFixed(1)+"</td></tr>",a+="</table>")}}a+="</div>";c=$("#lineGraphOuter").offset();analysisShowTooltip(b.pageX-c.left,b.pageY-c.top,a);$("#analysisSeries1").css({color:analysisColors[0]});$("#analysisSeries2").css({color:analysisColors[1]});$("#analysisSeries3").css({color:analysisColors[2]});$("h5.analysisSeriesLabel").hover(function(){var a=this.id;series=a.substring(a.length-1);if(analysisTooltipPreviousSeries!=series){analysisTooltipPreviousSeries=series;var b=analysisLocation[series],a=b.id;
name=b.name.toLocaleUpperCase()+" "+b.level.toLocaleUpperCase();for(b=1;10>=b;b++)try{var c=analysisDataCache[a][e][b][0];$("#indicatorRating"+b).text(c)}catch(d){$("#indicatorRating"+b).text("?")}$("#regionIndicators h3").text(name).css({color:analysisColors[series-1]});$("#regionIndicators").show()}})}}else $("#analysisTooltip").remove(),analysisTooltipPreviousPoint=null}
function analysisShowTooltip(a,b,c){$('<div id="analysisTooltip">'+c+"</div>").css({position:"absolute",display:"none",top:b-50,left:a+10,border:"0",padding:"10px","padding-left":"28px","min-height":"100px","z-index":"501",background:"transparent url("+S3.Ap.concat("/static/img/whitearrow.png")+") repeat scroll 0 0",color:"#000",opacity:0.9}).appendTo("#lineGraphOuter").fadeIn(200)}var analysisTreeMap=null,labelType,useGradients,nativeTextSupport,animate;
(function(){var a=navigator.userAgent,a=a.match(/iPhone/i)||a.match(/iPad/i),b=typeof HTMLCanvasElement,c=(b="object"==b||"function"==b)&&"function"==typeof document.createElement("canvas").getContext("2d").fillText;labelType=!b||c&&!a?"Native":"HTML";nativeTextSupport="Native"==labelType;useGradients=b;animate=!(a||!b)})();
var Log={elem:!1,write:function(a){this.elem||(this.elem=document.getElementById("log"));this.elem.innerHTML=a;this.elem.style.left=500-this.elem.offsetWidth/2+"px"}},tmData={},tmCurrentLevel=0,tmMaxLevel=3,tmCurrentNode=null,tmHColors="#999 #ff5121 #f4961c #d6b317 #77b82e #059346".split(" "),tmLColors="#141414 #36150C #33210B #2E270A #212E14 #19260C".split(" "),tmLevels=null;function tmAddLocation(a,b){var c=tmData[a];"undefined"==typeof c?tmData[a]=b:b.x||(c.x=!1)}
function tmLevelName(a){if(0===a)return i18n.country;lname="l"+a;return tmLevels.hasOwnProperty(lname)?tmLevels[lname]:""}function tmUpdateHierarchy(){for(var a in tmData)tmData[a].c=[];for(var b in tmData)if(a=tmData[b].f,null!==a)try{tmData[a].c.push(b)}catch(c){}}function tmBuildGraph(a,b){tmLevels=hdata[$("#l0_analysis1s").val()];var c=tmData[a];return null!==c.f?tmBuildGraph(c.f,b):tmAddNode(a,b)}
function tmPopulation(a){var b=a.p;if(0!==b){var c=a.t;a=a.r;c&&(a&&c!=a)&&(b+=b/(c-a)*a)}return b}
function tmAddNode(a,b){var c=tmData[a];if("undefined"==typeof c)return null;for(var d=[],e=0;e<c.c.length;e++)child=tmAddNode(c.c[e],b),null!==child&&d.push(child);var e=c.i[b],f=0;"undefined"!=typeof e&&(f=e.toFixed(0),1>f||5<f)&&(f=0);var g=tmLColors[f],h=100,h=tmPopulation(c),h=0!==h?h:Math.pow(10,6-c.l);return{id:a,name:c.n,data:{level:c.l,population:c.p,indicator:b,color_index:f,value:e,$color:g,$area:h.toFixed(0)},children:d}}
function tmUpdate(){var a=$(".indicatorRatingLabel input[type=radio]:checked").val();analysisTreeMap.graph.eachNode(function(b){var c=tmData[b.id];if(c){var c=c.i[a],d=0;"undefined"!=typeof c&&c&&(d=c.toFixed(0),1>d||5<d)&&(d=0);b.data.value=c;b.data.indicator=a;b.data.color_index=d;b.data.$color=tmLColors[d]}});tmRenderHeaders(tmCurrentNode);analysisTreeMap.plot()}
function tmGoToLocation(a){var b=$(".indicatorRatingLabel input[type=radio]:checked").val();$(".indicatorRatingLabel input[type=radio]").change(function(){tmUpdate()});null===analysisTreeMap&&tmInit();var c=tmData[a];if("undefined"==typeof c||c.x)$.ajax({url:S3.Ap.concat("/vulnerability/tmdata/")+a,success:function(c){for(var e in sdata)tmAddLocation(e,sdata[e]);tmUpdateHierarchy();c=tmBuildGraph(a,b);analysisTreeMap.loadJSON(c);tmRenderHeaders(a);(c=analysisTreeMap.graph.getNode(a))&&analysisTreeMap.enter(c);
c.data.level<tmMaxLevel-1?$("#treeMapChart .node").css({cursor:"pointer"}):$("#treeMapChart .node").css({cursor:"default"})},error:function(a,b,c){msg="UNAUTHORIZED"==c?i18n.gis_requires_login:a.responseText;console.log(msg)},dataType:"script"});else if(c=tmBuildGraph(a,b),analysisTreeMap.loadJSON(c),tmRenderHeaders(a),c=analysisTreeMap.graph.getNode(a))analysisTreeMap.enter(c),c.data.level<tmMaxLevel-1?$("#treeMapChart .node").css({cursor:"pointer"}):$("#treeMapChart .node").css({cursor:"default"})}
function tmRenderHeaders(a){$(".treeMapHeader").unbind("click");var b=tmData[a];tmCurrentNode=a;tmCurrentLevel=b.l;for(var c=[];b;){var d=analysisTreeMap.graph.getNode(a);level=tmLevelName(d.data.level);d=d.data.color_index;header='<div id="treeMapGoTo_'+a+'" class="treeMapHeader treeMapHBGColor'+d+'"><div><span class="treeMapValue treeMapHFGColor'+d+'">'+d+'</span><span class="treeMapLocation">'+b.n+'</span><span class="treeMapLevel">'+level+"</span></div></div>";c.push(header);if(b.f)a=b.f,b=tmData[b.f];
else break}c.reverse();$("#treeMapHeaders").html(c.join(""));for(b=0;5>=b;b++)$(".treeMapHBGColor"+b).css({"background-color":tmHColors[b]}),$(".treeMapHFGColor"+b).css({color:tmHColors[b]});$(".treeMapHeader").click(function(){var a=this.id,a=a.substring(a.indexOf("_")+1);analysisTreeMap.graph.getNode(a);tmGoToLocation(a);return!1})}
function tmInit(){null===analysisTreeMap&&(analysisTreeMap=new $jit.TM.Squarified({injectInto:"treeMapChart",titleHeight:0,animate:!1,offset:1,levelsToShow:1,Events:{enable:!0,onClick:function(a){a&&tmData[a.id].l<tmMaxLevel&&tmGoToLocation(a.id)},onRightClick:function(){var a=tmData[tmCurrentNode].f;a&&(a=analysisTreeMap.graph.getNode(a))&&tmGoToLocation(a.id)}},Tips:{enable:!0,offsetX:20,offsetY:20,onShow:function(a,b,c,d){c=b.data;d=c.color_index;level=tmLevelName(c.level);b='<div class="tipTitle"><div class="tipIndicator">'+
d+'</div><h5 class="tipLocation">'+b.name+'</h5><h5 class="tipLevel">'+level+"</h5></div>";b+='<div class="tip-text"><div class="tipPopulation">'+i18n.population.toUpperCase()+": ";c.population?(b+=c.population,c.population!=c.$area&&(b+=" ("+i18n.extrapolated.toUpperCase()+": "+c.$area+")")):b+=i18n.no_data.toUpperCase();a.innerHTML=b+"</div></div>";$(".tipIndicator").css({"background-color":tmHColors[d]})}},onCreateLabel:function(a,b){l=b.data.level;level=tmLevelName(l);l==tmCurrentLevel+1&&(a.innerHTML=
'<div class="treeMapLabel"><div class="treeMapLabelName">'+b.name+'</div><div class="treeMapLabelLevel">'+level+"</div></div>");a.onmouseover=function(){b.data.$color=tmHColors[b.data.color_index];analysisTreeMap.fx.plotNode(b,analysisTreeMap.canvas)};a.onmouseout=function(){b.data.$color=tmLColors[b.data.color_index];analysisTreeMap.fx.plotNode(b,analysisTreeMap.canvas)}}}))};
