# -*- coding: utf-8 -*-
#
# Stats Unit Tests
#
# To run this script use:
# python web2py.py -S eden -M -R applications/eden/modules/unit_tests/s3db/vulnerability.py
#
import unittest
import datetime

from gluon import *
from gluon.storage import Storage

from unit_tests import run_suite

# =============================================================================
# Aggregation takes a long time to test on a populated database
@unittest.skip("Comment or remove this line in modules/unit_tests/s3db/vulnerability.py to activate this test")
@unittest.skipIf(not current.deployment_settings.has_module("vulnerability"),
                 "Vulnerability module deactivated")
class VulnerabilityTests(unittest.TestCase):
    """ Stats Tests """

    # -------------------------------------------------------------------------
    def setUp(self):
        """ Set up location records """

        auth = current.auth
        auth.s3_impersonate("admin@example.com")

        # Add Test location data: code, name, level, parent
        s3db = current.s3db
        gtable = s3db.gis_location
        gis0 = Storage(name="Test Country",
                       level="L0",
                       )
        gis0_id = gtable.insert(**gis0)

        location_code = Storage()
        location_ids = Storage()
        location_code[gis0_id] = "gis0"
        location_ids["gis0"] = gis0_id

        gis_test_data = [("gis1", "Test Region 1", "L1", "gis0"),
                         ("gis2_1", "Test Province 1", "L2", "gis1"),
                         ("gis2_2", "Test Province 2", "L2", "gis1"),
                         ("gis3_1", "Test District 1", "L3", "gis2_1"),
                         ("gis3_2", "Test District 2", "L3", "gis2_1"),
                         ("gis3_3", "Test District 3", "L3", "gis2_1"),
                         ("gis3_4", "Test District 4", "L3", "gis2_2"),
                         ("gis3_5", "Test District 5", "L3", "gis2_2"),
                         ("gis4_1", "Test Commune 1", "L4", "gis3_1"),
                         ("gis4_2", "Test Commune 2", "L4", "gis3_1"),
                         ("gis4_3", "Test Commune 3", "L4", "gis3_1"),
                         ("gis4_4", "Test Commune 4", "L4", "gis3_2"),
                         ("gis4_5", "Test Commune 5", "L4", "gis3_2"),
                         ("gis4_6", "Test Commune 6", "L4", "gis3_3"),
                         ("gis4_7", "Test Commune 7", "L4", "gis3_3"),
                         ("gis4_8", "Test Commune 8", "L4", "gis3_3"),
                         ("gis4_9", "Test Commune 9", "L4", "gis3_4"),
                         ("gis4_10", "Test Commune 10", "L4", "gis3_4"),
                         ("gis4_11", "Test Commune 11", "L4", "gis3_5"),
                         ("gis4_12", "Test Commune 12", "L4", "gis3_5"),
                         ]
        update_location_tree = current.gis.update_location_tree
        for location in gis_test_data:
            gis_code = location[0]
            gis_data = Storage(name=location[1],
                               level=location[2],
                               parent=location_ids[location[3]],
                               )
            gis_id = gtable.insert(**gis_data)
            update_location_tree(dict(id=gis_id, level=location[2]))
            location_code[gis_id] = gis_code
            location_ids[gis_code] = gis_id

        self.location_code = location_code
        self.location_ids = location_ids

        # Configure the Vulnerability aspects
        self.indicators = s3db.vulnerability_pids()
        self.resilience_id = s3db.vulnerability_resilience_id()
        self.statisticList = ["max",
                              "min",
                              "mean",
                              "median",
                              "reported_count",
                              "ward_count"
                              ]

    # -------------------------------------------------------------------------
    @staticmethod
    def approve_record(record_id):
        """
            Helper function to approve the vulnerability_data record that has
            been inserted and then rebuild the relevant aggregates

            @param record_id: the id of the vulnerability_data record created
        """

        s3db = current.s3db
        resource = s3db.resource("vulnerability_data", id=record_id,
                                 unapproved=True)
        resource.approve()
        rows = resource.select(fields=["data_id",
                                       "parameter_id",
                                       "date",
                                       "location_id",
                                       "value"],
                               as_rows=True)
        s3db.vulnerability_update_aggregates(rows)

    # -------------------------------------------------------------------------
    def testVulnerability_aggregate(self):
        """
            Test that the vulnerability_aggregate records are being generated correctly.
            Because the vulnerability_aggregate records depend on earlier results it is
            important that all these test are in the same test so that the
            interdependence of the indicators can be checked.

            Summary of test data:
            1) Indicator 1 for gis4_1 in 2006 = 3
            2) Indicator 2 for gis4_1 in 2006 = 4
            3) Indicator 1 for gis4_1 in 2009 = 5
            4) Indicator 1 for gis4_2 in 2010 = 2
            5) Indicator 1 for gis4_2 in 2008 = 3
            6) Indicator 1 for gis4_2 in 2009 = 1
        """

        from datetime import date

        db = current.db
        s3db = current.s3db
        vtable = s3db.vulnerability_data

        approve_record = self.approve_record
        indicators = self.indicators
        location_ids = self.location_ids
        update_super = s3db.update_super
        validateAggregateData = self.validateAggregateData

        #---------------------------------------------------------------------
        # Add a vulnerability record for indicator 1 with date in 2006 for gis4_1
        step = 1
        indicator_id = indicators[0]
        location_id = location_ids["gis4_1"]
        actual_date = date(2006,05,12)

        id = vtable.insert(parameter_id = indicator_id,
                           location_id = location_id,
                           value = 3,
                           date = actual_date,
                           )
        update_super(vtable, dict(id=id))
        approve_record(id)

        expected = Storage(
            rule1 = Storage(
                type = {date(2006,01,1): 1,
                        date(2007,01,1): 3
                        },
                data = {date(2006,01,1): {"max" : 3,
                                          "min" : 3,
                                          "mean": 3,
                                          "median":3,
                                          "reported_count": 1,
                                          "ward_count": 1
                                          },
                        }
                ),
            rule2 = Storage(
                data = {location_ids["gis3_1"]: {
                            date(2006,01,1): {"max" : 3,
                                              "min" : 3,
                                              "mean": 3,
                                              "median":3,
                                              "reported_count": 1,
                                              "ward_count": 3
                                              },
                            },
                        location_ids["gis2_1"]: {
                            date(2006,01,1): {"max" : 3,
                                              "min" : 3,
                                              "mean": 3,
                                              "median":3,
                                              "reported_count": 1,
                                              "ward_count": 8
                                              },
                            },
                        location_ids["gis1"]: {
                            date(2006,01,1): {"max" : 3,
                                              "min" : 3,
                                              "mean": 3,
                                              "median":3,
                                              "reported_count": 1,
                                              "ward_count": 12
                                              },
                            },
                        location_ids["gis0"]: {
                            date(2006,01,1): {"max" : 3,
                                              "min" : 3,
                                              "mean": 3,
                                              "median":3,
                                              "reported_count": 1,
                                              "ward_count": 12
                                              },
                           },
                        },
                ),
            rule3 = Storage(
                data = {location_ids["gis4_1"]: {
                            date(2006,01,1): {"max" : 3,
                                              "min" : 3,
                                              "mean": 3,
                                              "median":3,
                                              "reported_count": 1,
                                              "ward_count": 1
                                              },
                            },
                        location_ids["gis3_1"]: {
                            date(2006,01,1): {"max" : 3,
                                              "min" : 3,
                                              "mean": 3,
                                              "median":3,
                                              "reported_count": 1,
                                              "ward_count": 3
                                              },
                            },
                        location_ids["gis2_1"]: {
                            date(2006,01,1): {"max" : 3,
                                              "min" : 3,
                                              "mean": 3,
                                              "median":3,
                                              "reported_count": 1,
                                              "ward_count": 8
                                              },
                            },
                        location_ids["gis1"]: {
                            date(2006,01,1): {"max" : 3,
                                              "min" : 3,
                                              "mean": 3,
                                              "median":3,
                                              "reported_count": 1,
                                              "ward_count": 12
                                              },
                            },
                        location_ids["gis0"]: {
                            date(2006,01,1): {"max" : 3,
                                              "min" : 3,
                                              "mean": 3,
                                              "median":3,
                                              "reported_count": 1,
                                              "ward_count": 12
                                              },
                            },
                        },
                ),
            )

        validateAggregateData(step,
                              actual_date,
                              indicator_id,
                              location_id,
                              expected,
                              )

        #---------------------------------------------------------------------
        # Add a vulnerability record for indicator 2 with date in 2006 for gis4_1
        step = 2
        indicator_id = indicators[1]
        location_id = location_ids["gis4_1"]
        actual_date = date(2006,05,12)

        id = vtable.insert(parameter_id = indicator_id,
                           location_id = location_id,
                           value = 4,
                           date = actual_date,
                           )
        update_super(vtable, dict(id=id))
        approve_record(id)

        expected = Storage(
            rule1 = Storage(
                type = {date(2006,01,1): 1,
                        date(2007,01,1): 3
                        },
                data = {date(2006,01,1): {"max" : 4,
                                          "min" : 4,
                                          "mean": 4,
                                          "median":4,
                                          "reported_count": 1,
                                          "ward_count": 1
                                          },
                        date(2007,01,1): {"max" : 4,
                                          "min" : 4,
                                          "mean": 4,
                                          "median":4,
                                          "reported_count": 1,
                                          "ward_count": 1
                                          },
                        }
                ),
            rule2 = Storage(
                data = {location_ids["gis3_1"]: {
                            date(2006,01,1): {"max" : 4,
                                              "min" : 4,
                                              "mean": 4,
                                              "median":4,
                                              "reported_count": 1,
                                              "ward_count": 3
                                              },
                            },
                        location_ids["gis2_1"]: {
                            date(2006,01,1): {"max" : 4,
                                              "min" : 4,
                                              "mean": 4,
                                              "median":4,
                                              "reported_count": 1,
                                              "ward_count": 8
                                              },
                            },
                        location_ids["gis1"]: {
                            date(2006,01,1): {"max" : 4,
                                              "min" : 4,
                                              "mean": 4,
                                              "median":4,
                                              "reported_count": 1,
                                              "ward_count": 12
                                              },
                            },
                        location_ids["gis0"]: {
                            date(2006,01,1): {"max" : 4,
                                              "min" : 4,
                                              "mean": 4,
                                              "median":4,
                                              "reported_count": 1,
                                              "ward_count": 12
                                              },
                            },
                        },
                    ),
            rule3 = Storage(
                data = {location_ids["gis4_1"]: {
                            date(2006,01,1): {"max" : 4,
                                              "min" : 3,
                                              "mean": 3.5,
                                              "median":3.5,
                                              "reported_count": 1,
                                              "ward_count": 1
                                              },
                            },
                        location_ids["gis3_1"]: {
                            date(2006,01,1): {"max" : 4,
                                              "min" : 3,
                                              "mean": 3.5,
                                              "median":3.5,
                                              "reported_count": 1,
                                              "ward_count": 3
                                              },
                            },
                        location_ids["gis2_1"]: {
                            date(2006,01,1): {"max" : 4,
                                              "min" : 3,
                                              "mean": 3.5,
                                              "median":3.5,
                                              "reported_count": 1,
                                              "ward_count": 8
                                              },
                            },
                        location_ids["gis1"]: {
                            date(2006,01,1): {"max" : 4,
                                              "min" : 3,
                                              "mean": 3.5,
                                              "median":3.5,
                                              "reported_count": 1,
                                              "ward_count": 12
                                              },
                            },
                       location_ids["gis0"]: {
                            date(2006,01,1): {"max" : 4,
                                              "min" : 3,
                                              "mean": 3.5,
                                              "median":3.5,
                                              "reported_count": 1,
                                              "ward_count": 12
                                              },
                            },
                        },
                ),
            )

        validateAggregateData(step,
                              actual_date,
                              indicator_id,
                              location_id,
                              expected,
                              )

        #---------------------------------------------------------------------
        # Add a vulnerability record for indicator 1 with date in 2009 for gis4_1
        step = 3
        indicator_id = indicators[0]
        location_id = location_ids["gis4_1"]
        actual_date = date(2009,07,23)

        id = vtable.insert(parameter_id = indicator_id,
                           location_id = location_id,
                           value = 5,
                           date = actual_date,
                           )
        update_super(vtable, dict(id=id))
        approve_record(id)

        expected = Storage()
        expected["rule1"] = Storage(type={date(2006,01,1): 1,
                                          date(2007,01,1): 3,
                                          date(2009,01,1): 1,
                                          date(2010,01,1): 3,
                                          },
                                    data={date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 5,
                                                           "mean": 5,
                                                           "median":5,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          }
                                    )
        expected["rule2"] = Storage(data={location_ids["gis3_1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 5,
                                                           "mean": 5,
                                                           "median":5,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                                                       },
                                          location_ids["gis2_1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 5,
                                                           "mean": 5,
                                                           "median":5,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                                                       },
                                          location_ids["gis1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 5,
                                                           "mean": 5,
                                                           "median":5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          location_ids["gis0"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 5,
                                                           "mean": 5,
                                                           "median":5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          },
                                    )
        expected["rule3"] = Storage(data={location_ids["gis4_1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 4,
                                                           "mean": 4.5,
                                                           "median":4.5,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                                                       },
                                          location_ids["gis3_1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 4,
                                                           "mean": 4.5,
                                                           "median":4.5,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                                                       },
                                          location_ids["gis2_1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 4,
                                                           "mean": 4.5,
                                                           "median":4.5,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                                                       },
                                          location_ids["gis1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 4,
                                                           "mean": 4.5,
                                                           "median":4.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          location_ids["gis0"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 4,
                                                           "mean": 4.5,
                                                           "median":4.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          },
                                    )
        validateAggregateData(step,
                              actual_date,
                              indicator_id,
                              location_id,
                              expected,
                              )

        #---------------------------------------------------------------------
        # Add a vulnerability record for indicator 1 with date in 2010 for gis4_2
        step = 4
        indicator_id = indicators[0]
        location_id = location_ids["gis4_2"]
        actual_date = date(2010,03,13)

        id = vtable.insert(parameter_id = indicator_id,
                           location_id = location_id,
                           value = 2,
                           date = actual_date,
                           )
        update_super(vtable, dict(id=id))
        approve_record(id)

        expected = Storage()
        expected["rule1"] = Storage(type={date(2010,01,1):1,
                                          date(2011,01,1):3,
                                          },
                                    data={date(2010,01,1):{"max" : 2,
                                                           "min" : 2,
                                                           "mean": 2,
                                                           "median":2,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          }
                                    )
        expected["rule2"] = Storage(data={location_ids["gis3_1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 5,
                                                           "mean": 5,
                                                           "median":5,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                                                       },
                                          location_ids["gis2_1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 5,
                                                           "mean": 5,
                                                           "median":5,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                                                       },
                                          location_ids["gis1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 5,
                                                           "mean": 5,
                                                           "median":5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          location_ids["gis0"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 5,
                                                           "mean": 5,
                                                           "median":5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          },
                                    )
        expected["rule3"] = Storage(data={location_ids["gis4_2"]:{
                                          date(2010,01,1):{"max" : 2,
                                                           "min" : 2,
                                                           "mean": 2,
                                                           "median":2,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                                                       },
                                          location_ids["gis3_1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 4,
                                                           "mean": 4.5,
                                                           "median":4.5,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                                                       },
                                          location_ids["gis2_1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 4,
                                                           "mean": 4.5,
                                                           "median":4.5,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                                                       },
                                          location_ids["gis1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 4,
                                                           "mean": 4.5,
                                                           "median":4.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          location_ids["gis0"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 4,
                                                           "mean": 4.5,
                                                           "median":4.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          },
                                    )

        validateAggregateData(step,
                              actual_date,
                              indicator_id,
                              location_id,
                              expected,
                              )

        #---------------------------------------------------------------------
        # Add a vulnerability record for indicator 1 with date in 2008 for gis4_2
        step = 5
        indicator_id = indicators[0]
        location_id = location_ids["gis4_2"]
        actual_date = date(2008,02,05)

        id = vtable.insert(parameter_id = indicator_id,
                           location_id = location_id,
                           value = 3,
                           date = actual_date,
                           )
        update_super(vtable, dict(id=id))
        approve_record(id)

        expected = Storage()
        expected["rule1"] = Storage(type={date(2008,01,1):1,
                                          date(2009,01,1):3,
                                          date(2010,01,1):1,
                                          date(2011,01,1):3,
                                          },
                                    data={date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          date(2010,01,1):{"max" : 2,
                                                           "min" : 2,
                                                           "mean": 2,
                                                           "median":2,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          }
                                    )
        expected["rule2"] = Storage(data={location_ids["gis3_1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 3,
                                                           "mean": 4,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                                                       },
                                          location_ids["gis2_1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 3,
                                                           "mean": 4,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                                                       },
                                          location_ids["gis1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 3,
                                                           "mean": 4,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          location_ids["gis0"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 3,
                                                           "mean": 4,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          },
                                    )
        expected["rule3"] = Storage(data={location_ids["gis4_2"]:{
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          date(2010,01,1):{"max" : 2,
                                                           "min" : 2,
                                                           "mean": 2,
                                                           "median":2,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                                                       },
                                          location_ids["gis3_1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2008,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 10.0/3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 3,
                                                           "mean": 4,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                                                       },
                                          location_ids["gis2_1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2008,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 10.0/3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 3,
                                                           "mean": 4,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                                                       },
                                          location_ids["gis1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2008,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 10.0/3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 3,
                                                           "mean": 4,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          location_ids["gis0"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2008,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 10.0/3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 3,
                                                           "mean": 4,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          },
                                    )

        validateAggregateData(step,
                              actual_date,
                              indicator_id,
                              location_id,
                              expected,
                              )

        #---------------------------------------------------------------------
        # Add a vulnerability record for indicator 1 with date in 2009 for gis4_2
        step = 6
        indicator_id = indicators[0]
        location_id = location_ids["gis4_2"]
        actual_date = date(2009,12,05)

        id = vtable.insert(parameter_id = indicator_id,
                           location_id = location_id,
                           value = 1,
                           date = actual_date,
                           )
        update_super(vtable, dict(id=id))
        approve_record(id)

        expected = Storage()
        expected["rule1"] = Storage(type={date(2008,01,1):1,
                                          date(2009,01,1):1,
                                          date(2010,01,1):1,
                                          date(2011,01,1):3,
                                          },
                                    data={date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          date(2009,01,1):{"max" : 1,
                                                           "min" : 1,
                                                           "mean": 1,
                                                           "median":1,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          date(2010,01,1):{"max" : 2,
                                                           "min" : 2,
                                                           "mean": 2,
                                                           "median":2,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          }
                                    )
        expected["rule2"] = Storage(data={location_ids["gis3_1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 1,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                                                       },
                                          location_ids["gis2_1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 1,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                                                       },
                                          location_ids["gis1"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 1,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          location_ids["gis0"]:{
                                          date(2006,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 1,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          },
                                    )
        expected["rule3"] = Storage(data={location_ids["gis4_2"]:{
                                          date(2008,01,1):{"max" : 3,
                                                           "min" : 3,
                                                           "mean": 3,
                                                           "median":3,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          date(2009,01,1):{"max" : 1,
                                                           "min" : 1,
                                                           "mean": 1,
                                                           "median":1,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                          date(2010,01,1):{"max" : 2,
                                                           "min" : 2,
                                                           "mean": 2,
                                                           "median":2,
                                                           "reported_count": 1,
                                                           "ward_count": 1
                                                           },
                                                                       },
                                          location_ids["gis3_1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 3
                                                           },
                                          date(2008,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 10.0/3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 1,
                                                           "mean": 10.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 3
                                                           },
                                                                       },
                                          location_ids["gis2_1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 8
                                                           },
                                          date(2008,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 10.0/3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 1,
                                                           "mean": 10.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 8
                                                           },
                                                                       },
                                          location_ids["gis1"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2008,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 10.0/3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 1,
                                                           "mean": 10.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          location_ids["gis0"]:{
                                          date(2006,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 3.5,
                                                           "median":3.5,
                                                           "reported_count": 1,
                                                           "ward_count": 12
                                                           },
                                          date(2008,01,1):{"max" : 4,
                                                           "min" : 3,
                                                           "mean": 10.0/3,
                                                           "median":3,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2009,01,1):{"max" : 5,
                                                           "min" : 1,
                                                           "mean": 10.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                          date(2010,01,1):{"max" : 5,
                                                           "min" : 2,
                                                           "mean": 11.0/3,
                                                           "median":4,
                                                           "reported_count": 2,
                                                           "ward_count": 12
                                                           },
                                                                       },
                                          },
                                    )

        validateAggregateData(step,
                              actual_date,
                              indicator_id,
                              location_id,
                              expected,
                              )

    # -------------------------------------------------------------------------
    def validateAggregateData(self,
                              step,
                              actual_date,
                              indicator_id,
                              location_id,
                              expected):
        """
            We check against three rules:
            1) The aggregate record that matches the newly inserted record
               * Use indicator and location to find the record. It should
                 have a type of 1 for the actual period other periods will
                 have types of 1 or 3, and the data may vary
            2) The records aggregate for each parent location
               * The type will be 2 but the data may vary
            3) The records for the indicator for each location and time period
               * The type will be 4 but the data may vary
        """

        from dateutil.rrule import rrule, YEARLY

        db = current.db
        s3db = current.s3db

        # Get the start dates for each time period
        aggregated_period = s3db.vulnerability_aggregated_period
        (first_period, dummy) = aggregated_period(actual_date)
        (last_period, dummy) = aggregated_period()

        atable = db.vulnerability_aggregate
        fields = [atable.agg_type,
                  atable.reported_count,
                  atable.ward_count,
                  atable.date,
                  atable.location_id,
                  atable.max,
                  atable.min,
                  atable.mean,
                  atable.median,
                  ]

        #-------
        # RULE 1
        # Get the data collected from the field
        query = (atable.parameter_id == indicator_id) & \
                (atable.location_id == location_id) & \
                (atable.deleted == False)
        rows = db(query).select(*fields)
        aggr_data = {}
        for row in rows:
            aggr_data[row.date] = row

        # Check the records exist
        for dt in rrule(YEARLY, dtstart=first_period, until=last_period):
            dt = dt.date()
            msg = "Step %s, Rule 1: Failed to find an aggregate record starting with date %s" % (step, dt)
            self.assertTrue(dt in aggr_data, msg)
            record = aggr_data[dt]
            if dt in expected.rule1.type:
                exp_type = expected.rule1.type[dt]
                last_exp_type = exp_type
            else:
                exp_type = last_exp_type
            if dt in expected.rule1.data:
                exp_data = expected.rule1.data[dt]
                last_exp_data = exp_data
            else:
                exp_data = last_exp_data
            # Check that the type is correct
            msg = "Step %s, Rule 1: Expecting a type of %s in record %s" % \
                (step, exp_type, record)
            self.assertTrue(record.agg_type == exp_type, msg)
            # Check each statistic
            for statistic in self.statisticList:
                exp_stat = exp_data[statistic]
                msg = "Step %s, Rule 1: Expecting a %s of %s in record %s" % \
                    (step, statistic, exp_stat, record)
                self.assertTrue(record[statistic] == exp_stat, msg)

        #-------
        # RULE 2
        # Get the data aggregated over location (and time)
        rows = current.gis.get_parents(location_id)
        location_list = [i.id for i in rows]
        self.assertTrue(len(location_list) == len(expected.rule2.data))
        query = (atable.parameter_id == indicator_id) & \
                (atable.location_id.belongs(location_list)) & \
                (atable.deleted == False)
        rows = db(query).select(*fields)
        aggr_data = {}
        for row in rows:
            if row.date in aggr_data:
                aggr_data[row.date][row.location_id] = row
            else:
                aggr_data[row.date] = {row.location_id : row}

        # Check the records exist
        last_exp_data = {}
        for dt in rrule(YEARLY, dtstart=first_period, until=last_period):
            dt = dt.date()
            for location in location_list:
                msg = "Step %s, Rule 2: Failed to find an aggregate record starting with date %s" % (step, dt)
                self.assertTrue(dt in aggr_data, msg)
                msg = "Step %s, Rule 2: Failed to find an aggregate record starting with date %s for location %s" % \
                    (step, dt, self.location_code[location])
                self.assertTrue(location in aggr_data[dt], msg)
                record = aggr_data[dt][location]
                msg = "Step %s, Rule 2: Expecting a type of 2 in record %s" % (step, record)
                self.assertTrue(record.agg_type == 2, msg)
                if dt in expected.rule2.data[location]:
                    exp_data = expected.rule2.data[location][dt]
                    last_exp_data[location] = exp_data
                else:
                    exp_data = last_exp_data[location]
                # Check each statistic
                for statistic in self.statisticList:
                    exp_stat = exp_data[statistic]
                    msg = "Step %s, Rule 2: Expecting a %s of %s for location %s in record %s" % \
                        (step, statistic, exp_stat, self.location_code[location], record)
                    self.assertTrue(record[statistic] == exp_stat, msg)

        #-------
        # RULE 3
        # Get the data: overall resilience
        location_list.append(location_id)
        self.assertTrue(len(location_list) == len(expected.rule3.data))
        query = (atable.parameter_id == self.resilience_id) & \
                (atable.location_id.belongs(location_list)) & \
                (atable.deleted == False)
        rows = db(query).select(*fields)
        aggr_data = {}
        for row in rows:
            if row.date in aggr_data:
                aggr_data[row.date][row.location_id] = row
            else:
                aggr_data[row.date] = {row.location_id : row}
        # Check the records exist
        for location in location_list:
            last_exp_data = None
            for dt in rrule(YEARLY, dtstart=first_period, until=last_period):
                dt = dt.date()
                msg = "Step %s, Rule 3: Failed to find a resilience record starting with date %s" % (step, dt)
                self.assertTrue(dt in aggr_data, msg)
                msg = "Step %s, Rule 3: Failed to find a resilience record starting with date %s for location %s" % \
                    (step, dt, self.location_code[location])
                self.assertTrue(location in aggr_data[dt], msg)
                record = aggr_data[dt][location]
                msg = "Step %s, Rule 3: Expecting a type of 4 in record %s" % (step, record)
                self.assertTrue(record.agg_type == 4, msg)
                if dt in expected.rule3.data[location]:
                    exp_data = expected.rule3.data[location][dt]
                    last_exp_data = exp_data
                else:
                    exp_data = last_exp_data
                # Check each statistic
                for statistic in self.statisticList:
                    exp_stat = exp_data[statistic]
                    msg = "Step %s, Rule 3: Expecting a %s of %s  for location %s in record %s" % \
                        (step, statistic, exp_stat, self.location_code[location], record)
                    self.assertTrue(record[statistic] - exp_stat < 1e-7, msg)

    # -------------------------------------------------------------------------
    def tearDown(self):

        current.db.rollback()
        current.auth.s3_impersonate(None)

# =============================================================================
if __name__ == "__main__":

    run_suite(
        VulnerabilityTests,
    )

# END ========================================================================
